<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="AFL源码分析（二）, starrysky">
    <meta name="description" content="Love rises from the east and descends to the west,romance makes no changes until death.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>AFL源码分析（二） | starrysky</title>
    <link rel="icon" type="image/jpeg" href="/favicon.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="starrysky" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">starrysky</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>文章</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>个人简介</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">starrysky</div>
        <div class="logo-desc">
            
            Love rises from the east and descends to the west,romance makes no changes until death.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			文章
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			个人简介
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/Steel%20Gray.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">AFL源码分析（二）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/fuzz/">
                                <span class="chip bg-color">fuzz</span>
                            </a>
                        
                            <a href="/tags/AFL/">
                                <span class="chip bg-color">AFL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/fuzz/" class="post-category">
                                fuzz
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-03-10
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    49 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h3><p>执行所有的测试用例，以检查是否按预期工作(dry run：试运行）</p>
<ul>
<li>从环境变量获取是否跳过崩溃测试用例的设置</li>
<li>循环遍历队列<ul>
<li>获取文件名，不包含路径</li>
<li>打开遍历到的测试用例，打开失败则报错</li>
<li>为测试用例数据创建空间，读取测试用例内容，失败则报错退出，成功则关闭文件</li>
<li>调用 <a href="##calibrate_case">calibrate_case</a> 校准该测试用例，评估 input 文件夹下的 case，之后释放测试用例内容空间</li>
<li>如果 stop_soon 为真，即用户退出测试，则返回</li>
<li>如果 res 的结果为 crash_mode 或者为 FAULT_NOBITS，打印相关的信息</li>
<li>根据返回结果对应不同选项<ul>
<li>FAULT_NONE：如果是第一个测试用例则调用 check_map_coverage 函数，评估覆盖率；如果设置了 crash mode 则报错退出，因为该例不产生 crash</li>
<li>FAULT_TMOUT：超时，如果设置了超时时间并且大于 1，则标记为校准失败并增加失败计数，否则报错退出</li>
<li>FAULT_CRASH：崩溃，设置了 crash mode 就跳过，设置了 skip_crashes 则标记为校准失败并增加失败计数，否则报错退出</li>
<li>FAULT_ERROR：程序执行错误，报错退出</li>
<li>FAULT_NOINST：未检测到插桩，没有出现任何路径信息，报错退出</li>
<li>FAULT_NOBITS：有路径信息但没新路径，认为这是无用路径，useless_at_start计数器加一</li>
</ul>
</li>
<li>var_behavior 为真说明多次运行同一个测试用例有不同的表现，抛出警告</li>
<li>指向下一个测试用例继续循环</li>
</ul>
</li>
<li>失败次数不为 0 时<ul>
<li>所有测试用例均失败则报错退出</li>
<li>测试用例数量大于失败样例五倍的时候抛出警告</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">perform_dry_run</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> queue<span class="token punctuation">;</span>
  u32 cal_failures <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 用于记录校准失败的次数</span>
  u8<span class="token operator">*</span> skip_crashes <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_SKIP_CRASHES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 从环境变量获取是否跳过崩溃测试用例的设置</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//循环遍历队列</span>
    u8<span class="token operator">*</span> use_mem<span class="token punctuation">;</span>
    u8  res<span class="token punctuation">;</span>
    s32 fd<span class="token punctuation">;</span>

    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//获取文件名，不包含路径</span>

    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Attempting dry run with '%s'..."</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开测试用例文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开失败则报错</span>

    use_mem <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为测试用例创建空间</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> use_mem<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token operator">!=</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span>	<span class="token comment">//读取测试用例的值，失败则报错退出</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Short read from '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//关闭文件</span>

    res <span class="token operator">=</span> <span class="token function">calibrate_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> q<span class="token punctuation">,</span> use_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//校准该测试用例，评估 input 文件夹下的 case</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>use_mem<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//释放测试用例空间</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//如果用户中断就返回</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> crash_mode <span class="token operator">||</span> res <span class="token operator">==</span> FAULT_NOBITS<span class="token punctuation">)</span>	<span class="token comment">//如果 res 的结果为 crash_mode 或者为 FAULT_NOBITS，打印相关的信息</span>
      <span class="token function">SAYF</span><span class="token punctuation">(</span>cGRA <span class="token string">"    len = %u, map size = %u, exec speed = %llu us\n"</span> cRST<span class="token punctuation">,</span> 
           q<span class="token operator">-></span>len<span class="token punctuation">,</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">,</span> q<span class="token operator">-></span>exec_us<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//输出  len = 4, map size = 2, exec speed = 379251877 us</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> FAULT_NONE<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> queue<span class="token punctuation">)</span> <span class="token function">check_map_coverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//如果是第一个测试用例，调用 check_map_coverage 评估覆盖率</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' does *NOT* crash"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置了 crash mode 则报错退出</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_TMOUT<span class="token operator">:</span>	<span class="token comment">//超时</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//设置了超时时间</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//超时时间大于 1</span>
            <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Test case results in a timeout (skipping)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 超时但设置为跳过</span>
            q<span class="token operator">-></span>cal_failed <span class="token operator">=</span> CAL_CHANCES<span class="token punctuation">;</span>	<span class="token comment">// 标记为校准失败</span>
            cal_failures<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">// 增加失败计数</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
               exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a timeout"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 超时且未设置跳过，报错</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
               <span class="token string">"    altogether, and find one that is less of a CPU hog.\n"</span><span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a timeout"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

      <span class="token keyword">case</span> FAULT_CRASH<span class="token operator">:</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>	<span class="token comment">//设置了 crash mode 则跳过</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_crashes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//设置了跳过 crash，提示 crash 但是跳过，标记为校准失败并增加失败计数</span>
          <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Test case results in a crash (skipping)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          q<span class="token operator">-></span>cal_failed <span class="token operator">=</span> CAL_CHANCES<span class="token punctuation">;</span>
          cal_failures<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>	

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//设置了 mem_limit 则程序崩溃了，给出可能的原因包括内存限制问题</span>
          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
               <span class="token function">DMS</span><span class="token punctuation">(</span>mem_limit <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mem_limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a crash"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_ERROR<span class="token operator">:</span>	<span class="token comment">// 执行错误</span>
        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application ('%s')"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_NOINST<span class="token operator">:</span>	<span class="token comment">// 未检测到插桩，没有出现任何路径信息</span>
        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No instrumentation detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> FAULT_NOBITS<span class="token operator">:</span> 	<span class="token comment">// 有路径信息但没新路径</span>
        useless_at_start<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//认为这是无用路径，useless_at_start计数器加一</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_bitmap <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shuffle_queue<span class="token punctuation">)</span>
          <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"No new instrumentation output, test case may be useless."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>var_behavior<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Instrumentation output varies across runs."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// var_behavior 为真说明多次运行同一个测试用例有不同的表现，抛出警告</span>

    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>	<span class="token comment">//遍历下一个</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//失败次数不为0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures <span class="token operator">==</span> queued_paths<span class="token punctuation">)</span>	<span class="token comment">//所有测试用例均失败则报错退出</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"All test cases time out%s, giving up!"</span><span class="token punctuation">,</span>
            skip_crashes <span class="token operator">?</span> <span class="token string">" or crash"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Skipped %u test cases (%0.02f%%) due to timeouts%s."</span><span class="token punctuation">,</span> cal_failures<span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>cal_failures<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">/</span> queued_paths<span class="token punctuation">,</span>
          skip_crashes <span class="token operator">?</span> <span class="token string">" or crashes"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">></span> queued_paths<span class="token punctuation">)</span>	<span class="token comment">//测试用例数量大于失败样例五倍的时候抛出警告</span>
      <span class="token function">WARNF</span><span class="token punctuation">(</span>cLRD <span class="token string">"High percentage of rejected test cases, check settings!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"All test cases processed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="calibrate-case"><a href="#calibrate-case" class="headerlink" title="calibrate_case"></a>calibrate_case</h3><p>这里调试的时候需要设置：<code>set follow-fork-mode parent</code> <code>set detach-on-fork on</code> 调试父进程</p>
<p>进了 queue 的用例，都要被运行一遍 calibrate_case 函数，判断该用例是否异常，发现新路径时评估新发现的 testcase 行为是否可变（即多次执行发现不同的路径）</p>
<ul>
<li><p>不来自于 queue 中或者在 resuming sessions 的时候，使用的超时时间设置为更大的数值，避免因间歇性延迟带来的问题</p>
</li>
<li><p>增加校准失败次数</p>
</li>
<li><p>设置当前阶段名称为校准，设置校准循环次数，如果设置了快速校准则为 3 次，否则 CAL_CYCLES 为 8 次</p>
</li>
<li><p>非 dumb 模式、未开启 no_forkserver、forksrv_pid &#x3D; 0，调用 <a href="##init_forkserver">init_forkserver</a> 初始化 forkserver 确保 forkserver 已启动</p>
</li>
<li><p>如果已有执行校验和，即当前测试用例不是来自输入文件夹，复制第一次执行的覆盖痕迹</p>
</li>
<li><p>获取当前时间作为开始时间</p>
</li>
<li><p>循环执行校准</p>
<ul>
<li><p>测试用例不是来自输入文件夹，第一轮循环结束后调用 show_stats 显示一次状态，后面不再显示</p>
</li>
<li><p><a href="##write_to_testcase">write_to_testcase</a> 将从 q-&gt;fname 中读取的内容写入到 .cur_input 中</p>
</li>
<li><p><a href="##run_target">run_target</a> 运行测试用例，结果保存在 fault 中</p>
</li>
<li><p>用户手动停止或非崩溃模式的报错跳转到 abort_calibration</p>
</li>
<li><p>不是简单模式、是第一轮运行且未检测到插桩输出，标记为无插桩错误，跳转到 abort_calibration</p>
</li>
<li><p>计算当前覆盖痕迹的哈希值</p>
</li>
<li><p>如果当前覆盖痕迹 cksum 的哈希值与之前 q-&gt;exec_cksum 的哈希值不同，可能是发现新路径或是第一次运行</p>
<ul>
<li><p><a href="##has_new_bits">has_new_bits</a> 检测是否有新的覆盖位，返回值给 hnb，hnb 大于 new_bits 时更新 new_bits 为更高优先级的状态</p>
</li>
<li><p>q-&gt;exec_cksum 不为 0，说明有新路径</p>
<p>遍历每一个覆盖字节，检查是否有变化，该边未标记变异且当前边的统计结果发生变化则标记该边变异并设置校准次数为 40、var_detected &#x3D; 1（标记为检测到变异）</p>
</li>
<li><p>q-&gt;exec_cksum 为 0，说明是第一次运行，更新覆盖痕迹哈希值和覆盖痕迹</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>获取当前时间作为结束时间，更新运行时间、执行次数、每次执行时间、覆盖边的数量、记录障碍、总覆盖边的数量、产生的 bitmap 数量，调用 <a href="##update_bitmap_score">update_bitmap_score</a> 计算位图得分，标记此次校准未失败</p>
</li>
<li><p>abort_calibration</p>
<ul>
<li>如果发现新路径且之前未记录，更新 q-&gt;has_new_cov &#x3D; 1 表示有新路径，增加 queued_with_cov 表示发现新路径的 queue 增加</li>
<li>如果 queue 是可变路径，调用 <a href="##count_bytes">count_bytes</a> 变异边的数量，代表这些 tuple 具有可变的行为，如果该测试用例变异，标记为变异测试用例并增加变异测试用例数量</li>
<li>恢复之前的阶段信息</li>
<li>如果不是第一次运行，显示统计信息</li>
<li>返回 fault 值</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">calibrate_case</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">,</span> u8<span class="token operator">*</span> use_mem<span class="token punctuation">,</span>
                         u32 handicap<span class="token punctuation">,</span> u8 from_queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> u8 first_trace<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 用于存储第一次执行的覆盖痕迹</span>

  u8  fault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> new_bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> var_detected <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      first_run <span class="token operator">=</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//exec_cksum 为 0 代表这个 case 第一次运行，即来自输入文件夹下，设置 first_run 为 1</span>

  u64 start_us<span class="token punctuation">,</span> stop_us<span class="token punctuation">;</span>

  s32 old_sc <span class="token operator">=</span> stage_cur<span class="token punctuation">,</span> old_sm <span class="token operator">=</span> stage_max<span class="token punctuation">;</span>	<span class="token comment">// 保存当前阶段信息</span>
  u32 use_tmout <span class="token operator">=</span> exec_tmout<span class="token punctuation">;</span>	<span class="token comment">// 使用的超时时间</span>
  u8<span class="token operator">*</span> old_sn <span class="token operator">=</span> stage_name<span class="token punctuation">;</span>	<span class="token comment">// 保存当前阶段名称</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from_queue <span class="token operator">||</span> resuming_fuzz<span class="token punctuation">)</span>	<span class="token comment">//不来自于 queue 中或者在 resuming sessions 的时候</span>
    use_tmout <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">+</span> CAL_TMOUT_ADD<span class="token punctuation">,</span> exec_tmout <span class="token operator">*</span> CAL_TMOUT_PERC <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//使用的超时时间设置为更大的数值，避免因间歇性延迟带来的问题</span>

  q<span class="token operator">-></span>cal_failed<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">// 增加校准失败次数</span>

  stage_name <span class="token operator">=</span> <span class="token string">"calibration"</span><span class="token punctuation">;</span>	<span class="token comment">// 设置当前阶段名称为校准</span>
  stage_max  <span class="token operator">=</span> fast_cal <span class="token operator">?</span> <span class="token number">3</span> <span class="token operator">:</span> CAL_CYCLES<span class="token punctuation">;</span>	<span class="token comment">// 设置校准循环次数，快速校准为 3 次，CAL_CYCLES 为 8 次</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>no_forkserver <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>forksrv_pid<span class="token punctuation">)</span>	<span class="token comment">//非 dumb 模式、未开启 no_forkserver、forksrv_pid = 0</span>
    <span class="token function">init_forkserver</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//初始化 forkserver 确保 forkserver 已启动</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token function">memcpy</span><span class="token punctuation">(</span>first_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果已有执行校验和，即当前测试用例不是来自输入文件夹，复制第一次执行的覆盖痕迹</span>

  start_us <span class="token operator">=</span> <span class="token function">get_cur_time_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取当前时间作为开始时间</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//循环执行校准</span>
    u32 cksum<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first_run <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>stage_cur <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//第一轮循环结束后显示一次状态，后面不再显示</span>

    <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>use_mem<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将从 q->fname 中读取的内容写入到 .cur_input 中</span>

    fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> use_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//运行测试用例，结果保存在 fault 中</span>
	<span class="token comment">//执行后 trace_bit:</span>
    <span class="token comment">//0x7ffff7fb9000：  0x0000000000000000  0x0000000000000000</span>
    <span class="token comment">//	...</span>
    <span class="token comment">//0x7ffff7fba410:	0x0001000000000000	0x0000000000000000</span>
    <span class="token comment">//	...</span>
    <span class="token comment">//0x7ffff7fbac30:	0x0000000001000000	0x0000000000000000</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> fault <span class="token operator">!=</span> crash_mode<span class="token punctuation">)</span> <span class="token keyword">goto</span> abort_calibration<span class="token punctuation">;</span>	<span class="token comment">//用户手动停止或非崩溃模式的报错跳转到 abort_calibration</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stage_cur <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">count_bytes</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 不是简单模式、是第一轮运行且未检测到插桩输出</span>
      fault <span class="token operator">=</span> FAULT_NOINST<span class="token punctuation">;</span>	<span class="token comment">//标记为无插桩错误</span>
      <span class="token keyword">goto</span> abort_calibration<span class="token punctuation">;</span>	<span class="token comment">//跳转到 abort_calibration</span>
    <span class="token punctuation">&#125;</span>

    cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 计算当前覆盖痕迹的哈希值</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum <span class="token operator">!=</span> cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//当前覆盖痕迹的哈希值与之前的哈希值不同或是第一次运行</span>
      u8 hnb <span class="token operator">=</span> <span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//检测是否有新的覆盖位</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hnb <span class="token operator">></span> new_bits<span class="token punctuation">)</span> new_bits <span class="token operator">=</span> hnb<span class="token punctuation">;</span>	<span class="token comment">// 更新为更高优先级的状态</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//原 exec_cksum 不为 0，说明有新路径</span>
        u32 i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 遍历每一个覆盖字节，检查是否有变化</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>var_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> first_trace<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> trace_bits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//该边未标记变异且当前边的统计结果发生变化</span>
            var_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//标记变异</span>
            stage_max    <span class="token operator">=</span> CAL_CYCLES_LONG<span class="token punctuation">;</span>	<span class="token comment">//设置校准次数为 40</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        var_detected <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">// 标记检测到变异</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//第一次运行</span>
        q<span class="token operator">-></span>exec_cksum <span class="token operator">=</span> cksum<span class="token punctuation">;</span>	<span class="token comment">//更新覆盖痕迹哈希值</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>first_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新覆盖痕迹</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  stop_us <span class="token operator">=</span> <span class="token function">get_cur_time_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取当前时间作为结束时间</span>

  total_cal_us     <span class="token operator">+=</span> stop_us <span class="token operator">-</span> start_us<span class="token punctuation">;</span>	<span class="token comment">//相减得到运行时间</span>
  total_cal_cycles <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span>	<span class="token comment">//执行次数</span>

  q<span class="token operator">-></span>exec_us     <span class="token operator">=</span> <span class="token punctuation">(</span>stop_us <span class="token operator">-</span> start_us<span class="token punctuation">)</span> <span class="token operator">/</span> stage_max<span class="token punctuation">;</span>	<span class="token comment">//每次执行时间</span>
  q<span class="token operator">-></span>bitmap_size <span class="token operator">=</span> <span class="token function">count_bytes</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//覆盖边的数量</span>
  q<span class="token operator">-></span>handicap    <span class="token operator">=</span> handicap<span class="token punctuation">;</span>	<span class="token comment">//记录障碍</span>
  q<span class="token operator">-></span>cal_failed  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 标记此次校准未失败</span>

  total_bitmap_size <span class="token operator">+=</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">;</span>	<span class="token comment">//更新总覆盖边的数量</span>
  total_bitmap_entries<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//更新产生的 bitmap 数量</span>

  <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新位图得分</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> first_run <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fault <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>new_bits<span class="token punctuation">)</span> fault <span class="token operator">=</span> FAULT_NOBITS<span class="token punctuation">;</span>	<span class="token comment">// 如果不是简单模式且是第一次运行且未失败且这个用例没有从插桩中得到新的输出则标记为无插桩错误</span>

abort_calibration<span class="token operator">:</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_bits <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>q<span class="token operator">-></span>has_new_cov<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果发现新路径且之前未记录，更新状态</span>
    q<span class="token operator">-></span>has_new_cov <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//标记为有新路径</span>
    queued_with_cov<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//发现新路径的 queue 增加</span>
  <span class="token punctuation">&#125;</span>
    
  <span class="token keyword">if</span> <span class="token punctuation">(</span>var_detected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果 queue 是可变路径</span>
    var_byte_count <span class="token operator">=</span> <span class="token function">count_bytes</span><span class="token punctuation">(</span>var_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 计算变异边的数量，代表这些tuple具有可变的行为</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token operator">-></span>var_behavior<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果该测试用例变异</span>
      <span class="token function">mark_as_variable</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 标记为变异测试用例</span>
      queued_variable<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//变异测试用例数量增加</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
	
  <span class="token comment">// 恢复之前的阶段信息</span>
  stage_name <span class="token operator">=</span> old_sn<span class="token punctuation">;</span>
  stage_cur  <span class="token operator">=</span> old_sc<span class="token punctuation">;</span>
  stage_max  <span class="token operator">=</span> old_sm<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first_run<span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果不是第一次运行，显示统计信息</span>
  <span class="token keyword">return</span> fault<span class="token punctuation">;</span>	<span class="token comment">//返回 fault 值</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init_forkserver"></a>init_forkserver</h3><ul>
<li>创建 st_pipe 和 ctl_pipe 管道，fork 获取进程号（父进程的 fork() 返回值是子进程的 PID，子进程的 fork() 返回值是 0）</li>
<li>在子进程中<ul>
<li>设置资源限制、地址空间大小限制（设置了 mem_limit 时）、禁用核心转储以加快速度</li>
<li>起一个新的进程组</li>
<li>重定向文件描述符 1 &#x2F; 2 到 dev_null_fd，设置了 out_file 则将输入重定向到 dev_null_fd，否则重定向到 out_fd，即把 stdin 重定向到 .cur_input 文件</li>
<li>将 fd 198 重定向到 ctl_pipe[0] 以接收 supervisor 指令，将 fd 199 重定向到 st_pipe[1] 以向 supervisor 发送回复，子进程只能读取命令和发送写出状态</li>
<li>关闭子进程里的一些文件描述符</li>
<li>execve 执行 target_path，程序结束子进程结束，第一个入口点 afl_maybe_log 停下来，给 supervisor 发送 4 字节表示已就绪并等待指令<ul>
<li>第一个 target 会进入 __afl_maybe_log 里的 __afl_fork_wait_loop，并充当 fork server，在整个 Fuzz 的过程中，它都不会结束，每次要Fuzz 一次 target，都会从这个 fork server fork 出来一个子进程去 fuzz</li>
</ul>
</li>
<li>执行失败则标记失败 EXEC_FAIL_SIG</li>
</ul>
</li>
<li>父进程<ul>
<li>关闭不需要的管道端点</li>
<li>获取控制管道，发送控制信号给子进程,只能发送(“写出”)命令；获取状态管道，从子进程接收状态信息,只能读状态</li>
<li>设置实时计时器，等待 fork server 启动，但限制等待时间</li>
<li>读取 fork 服务器的状态，停止计时器</li>
<li>读取到 4 字节说明 fork server 正常</li>
<li>超时等错误报错退出</li>
</ul>
</li>
</ul>
<p><img src="/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/cde5344bac4d8a91f7c107e86e8ff1e1.png" alt="在这里插入图片描述"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">init_forkserver</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> it<span class="token punctuation">;</span>
  <span class="token keyword">int</span> st_pipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctl_pipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> status<span class="token punctuation">;</span>
  s32 rlen<span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Spinning up the fork server..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 启动 fork server</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">pipe</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"pipe() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建 st_pipe 和 ctl_pipe 管道</span>

  forksrv_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//fork 子进程获取进程号，父进程的 fork() 返回值是子进程的 PID，子进程的 fork() 返回值是 0</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>forksrv_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forksrv_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//pid = 0，在子进程</span>
    <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> r<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">&lt;</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> 	<span class="token comment">// 尝试设置资源限制，忽略错误</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果有内存限制</span>
      r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span>mem_limit<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>
      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">// 设置地址空间大小限制，忽略错误</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>
    <span class="token punctuation">&#125;</span>

    r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CORE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 禁用核心转储以加快速度</span>

    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 起一个新的进程组</span>

    <span class="token comment">//重定向文件描述符 1 / 2 到 dev_null_fd</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//设置了 out_file 则将输入重定向到 dev_null_fd</span>
      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//否则重定向到 out_fd，即把 stdin 重定向到 .cur_input 文件</span>
      <span class="token function">dup2</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 将 fd 198 重定向到 ctl_pipe[0] 以接收 supervisor 指令</span>
    <span class="token comment">// 将 fd 199 重定向到 st_pipe[1] 以向 supervisor 发送回复</span>
    <span class="token comment">//子进程只能读取命令和发送写出状态</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FORKSRV_FD<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"dup2() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"dup2() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//关闭子进程里的一些文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>dev_urandom_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LD_BIND_LAZY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"LD_BIND_NOW"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"abort_on_error=1:detect_leaks=0:symbolize=0:allocator_may_return_null=1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">":symbolize=0:"</span>
                           <span class="token string">"abort_on_error=1:allocator_may_return_null=1:msan_track_origins=0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">execv</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//执行 target_path 程序结束子进程结束，在第一个入口点停下来，给 supervisor 发送 4 字节并等待指令</span>
    <span class="token comment">//第一个 target 会进入 __afl_maybe_log 里的 __afl_fork_wait_loop，并充当 fork server，在整个 Fuzz 的过程中，它都不会结束，每次要Fuzz 一次 target，都会从这个 fork server fork 出来一个子进程去 fuzz</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span>	<span class="token comment">//执行失败才会执行到这里，标记失败</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>
	
  <span class="token comment">//父进程，关闭不需要的管道端点</span>
  <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  fsrv_ctl_fd <span class="token operator">=</span> ctl_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 控制管道，发送控制信号给子进程,只能发送(“写出”)命令</span>
  fsrv_st_fd  <span class="token operator">=</span> st_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// 状态管道，从子进程接收状态信息,只能读状态</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">*</span> FORK_WAIT_MULT<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">*</span> FORK_WAIT_MULT<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>

  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 设置实时计时器，等待 fork server 启动，但限制等待时间</span>

  rlen <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 读取 fork 服务器的状态</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 停止计时器</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rlen <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//读取到 4 字节说明 fork server 正常，本例中会读到 \x00\x00\x00\x00 后返回</span>
    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"All right - fork server is up."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">//超时等错误报错退出</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_timed_out<span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Timeout while initializing fork server (adjusting -t may help)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>forksrv_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">&lt;</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> uses_asan<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server crashed with signal %d"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">==</span> EXEC_FAIL_SIG<span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application ('%s')"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">&lt;</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> uses_asan<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token punctuation">.</span><span class="token punctuation">.</span>z
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server handshake failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="has-new-bits"><a href="#has-new-bits" class="headerlink" title="has_new_bits"></a>has_new_bits</h3><p>检查有没有新路径或者某个路径的执行次数有所不同：0 表示无成果；1 表示 hit count 变动；2 表示发现了新的边</p>
<h3 id="run-target"><a href="#run-target" class="headerlink" title="run_target"></a>run_target</h3><p>通过子进程的方式执行目标应用并返回执行结果</p>
<ul>
<li>清空 trace_bits，设置内存屏障，防止编译器优化</li>
<li>检查是否是 dumb 模式 或开启 forkserver<ul>
<li>dumb 模式或无 forkserver<ul>
<li>创建子进程并获取进程号，失败则报错退出</li>
<li>如果存在内存限制则设置地址空间限制</li>
<li>禁止生成 core dump 文件</li>
<li>新建会话，使得子进程完全独立</li>
<li>重定向标准输入输出后关闭不需要的文件描述符，不存在输出文件则重定向输入到 &#x2F;dev&#x2F;null，存在就重定向到输出文件</li>
<li>设置 AddressSanitizer 和 MemorySanitizer 的默认环境变量</li>
<li>执行目标程序，如果 execv 执行失败，使用特定的位图值 0xfee1dead 通知父进程</li>
</ul>
</li>
<li>非 dumb 模式且有 forkserver<ul>
<li>要求 fork server 启动 child</li>
<li>从 fork server 读 child pid</li>
</ul>
</li>
</ul>
</li>
<li>设置超时时间，启动真实时间定时器</li>
<li>检查是否是 dumb 模式 或开启 forkserver<ul>
<li>dumb 模式或无 forkserver<ul>
<li>通过waitpid等待子进程结束</li>
</ul>
</li>
<li>非 dumb 模式且有 forkserver<ul>
<li>通过读取状态管道来获取子进程的退出状态</li>
</ul>
</li>
</ul>
</li>
<li>检查子进程是否已停止，如果是，清空child_pid</li>
<li>清空定时器，更新总执行次数统计，设置内存屏障</li>
<li>读取 trace_bits 的前四个字节，用于后续逻辑判断，和错误信号相关</li>
<li><a href="##classify_counts">classify_counts</a> 对 trace_bits 中的计数进行分类</li>
<li>更新超时记录</li>
<li>判断并返回运行情况<ul>
<li>如果子进程因为信号退出且不是即将停止，获取退出信号，如果因超时被杀，则返回超时故障 FAULT_TMOUT，否则返回崩溃故障 FAULT_CRASH</li>
<li>如果 execv 调用失败（trace_bits 的前四个字节为 EXEC_FAIL_SIG），返回错误故障 FAULT_ERROR</li>
<li>如果一切正常，则返回无错误 FAULT_NONE</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">run_target</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> u32 timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> it<span class="token punctuation">;</span>	<span class="token comment">// 定时器结构，用于设置超时</span>
  <span class="token keyword">static</span> u32 prev_timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 子进程的退出状态</span>
  u32 tb4<span class="token punctuation">;</span>

  child_timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清空 trace_bits</span>
  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 内存屏障，防止编译器优化</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//dumb 模式或无 forkserver</span>
    child_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建子进程并获取进程号</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> r<span class="token punctuation">;</span>
        
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//存在内存限制</span>
        r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span>mem_limit<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>
        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置地址空间限制</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>
      <span class="token punctuation">&#125;</span>

      r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CORE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 禁止生成 core dump 文件</span>

      <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 新建会话，使得子进程完全独立</span>
	
      <span class="token comment">//重定向标准输入输出后关闭不需要的文件描述符</span>
      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//不存在输出文件则重定向输入到 /dev/null</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">dup2</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//存在就重定向到输出文件</span>
        <span class="token function">close</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token function">close</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>dev_urandom_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//设置 AddressSanitizer 和 MemorySanitizer 的默认环境变量</span>
      <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"abort_on_error=1:detect_leaks=0:symbolize=0:allocator_may_return_null=1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">":symbolize=0:msan_track_origins=0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">execv</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 执行目标程序</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span>	<span class="token comment">//如果 execv 执行失败，使用特定的位图值 0xfee1dead 通知父进程</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//非dumb 模式且启用 forkserver，直接发送控制命令并获取结果</span>
    s32 res<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fsrv_ctl_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_timed_out<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 要求 fork server 启动 child</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to request new process from fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>child_pid<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 从 fork server 读 child pid</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to request new process from fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server is misbehaving (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span>timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span>timeout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>

  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置超时时间，启动真实时间定时器</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//dumb 模式或无 forkserver</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//通过waitpid等待子进程结束</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    s32 res<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//有 fork_server 通过读取状态管道来获取子进程的退出状态</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to communicate with fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WIFSTOPPED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> child_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 检查子进程是否已停止，如果是，清空child_pid</span>

  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清空定时器</span>

  total_execs<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">// 更新总执行次数统计</span>

  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  tb4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">;</span>	<span class="token comment">// 读取trace_bits的前四个字节，用于后续逻辑判断</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__x86_64__</span></span>
  <span class="token function">classify_counts</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 对trace_bits中的计数进行分类</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token function">classify_counts</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__x86_64__ */</span></span>

  prev_timed_out <span class="token operator">=</span> child_timed_out<span class="token punctuation">;</span>	<span class="token comment">//更新超时记录</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stop_soon<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果子进程因为信号退出且不是即将停止</span>
    kill_signal <span class="token operator">=</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取退出信号</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_timed_out <span class="token operator">&amp;&amp;</span> kill_signal <span class="token operator">==</span> SIGKILL<span class="token punctuation">)</span> <span class="token keyword">return</span> FAULT_TMOUT<span class="token punctuation">;</span>	<span class="token comment">// 如果因超时被杀，则返回超时故障</span>
    <span class="token keyword">return</span> FAULT_CRASH<span class="token punctuation">;</span>	<span class="token comment">// 否则返回崩溃故障</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>uses_asan <span class="token operator">&amp;&amp;</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> MSAN_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    kill_signal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> FAULT_CRASH<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> tb4 <span class="token operator">==</span> EXEC_FAIL_SIG<span class="token punctuation">)</span>	<span class="token comment">// 如果execv调用失败，返回错误故障</span>
    <span class="token keyword">return</span> FAULT_ERROR<span class="token punctuation">;</span>

  <span class="token keyword">return</span> FAULT_NONE<span class="token punctuation">;</span>	<span class="token comment">// 如果一切正常，则返回无错误</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="classify-counts"><a href="#classify-counts" class="headerlink" title="classify_counts"></a>classify_counts</h3><p>对内存中的计数值进行分类处理以优化位图的存储，一次处理两字节，还会对连续 8 字节做循环展开，进一步提升效率</p>
<p>循环每次处理 64 位，每 64 位再分成 4 部分分别处理，count_class_lookup16 通过 <a href="##init_count_class16">init_count_class16 </a>初始化</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">classify_counts</span><span class="token punctuation">(</span>u64<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">// 计算需要处理的64位块的数量，MAP_SIZE 通常是位图的总大小</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 对每个64位块执行循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果当前64位块不为零</span>
      u16<span class="token operator">*</span> mem16 <span class="token operator">=</span> <span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span>	<span class="token comment">// 将64位块视为16位的四个部分</span>

      <span class="token comment">// 对每个16位的部分应用查找表转换，优化存储和访问效率</span>
      mem16<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem16<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem16<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem16<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    mem<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">// 移动到下一个64位块</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="count-bytes"><a href="#count-bytes" class="headerlink" title="count_bytes"></a>count_bytes</h3><p>FF(0) &#x3D; 0x000000ff	FF(1) &#x3D; 0x0000ff00	FF(2) &#x3D; 0x00ff0000	FF(3) &#x3D; 0xff000000</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FF</span><span class="token expression"><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0xff</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>循环读取 mem 里的值，每次读取 4 个字节到 u32 变量 v 中<ul>
<li>v 是 0，则代表这四个字节都是 0，则继续</li>
<li>v 不是 0，则依次计算 <code>v &amp; FF(0),v &amp; FF(1),v &amp; FF(2),v&amp;FF(3)</code> 的结果，如果不为 0，则计数器 ret 加一</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u32 <span class="token function">count_bytes</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span>
  u32  i   <span class="token operator">=</span> <span class="token punctuation">(</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  u32  ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    u32 v <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>v<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="update-bitmap-score"><a href="#update-bitmap-score" class="headerlink" title="update_bitmap_score"></a>update_bitmap_score</h3><p>遇到一个新路径时，调用此函数来判断这个路径是否比已有的路径更“有利”，目的是保持一个最小的路径集合，这些路径触发了到目前为止在位图中看到的所有位，并且专注于对它们进行模糊测试，而不是其他路径</p>
<ul>
<li>计算当前有利因子，计算方式为执行时间 * 长度，越小越好</li>
<li>遍历 trace_bits，不为 0 说明是已经被覆盖到的路径<ul>
<li>如果该位已经有设置过的最优解，比较当前解与最优解，如果当前更大则跳过当前项</li>
<li>当前解更优，减少先前最优解的引用次数，减少到 0 则释放内存清空指针</li>
<li>将当前项设置为最有解，并增加引用次数</li>
<li>如果还没有最小化的位图则分配内存后调用 <a href="##minimize_bits">minimize_bits</a> 最小化位图</li>
<li>标记 score_changed 得分已改变</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i<span class="token punctuation">;</span>
  u64 fav_factor <span class="token operator">=</span> q<span class="token operator">-></span>exec_us <span class="token operator">*</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span>	<span class="token comment">//计算当前测试用例的“有利因子”（执行时间乘以长度，越小越好）</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//遍历 trace_bits</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trace_bits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//不为 0 说明是已经被覆盖到的路径</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果这个位已经有获胜者</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>fav_factor <span class="token operator">></span> top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>exec_us <span class="token operator">*</span> top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//原来的更优则跳过</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">--</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>tc_ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//当前更优，减少引用计数</span>
           <span class="token function">ck_free</span><span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//引用计数为 0 则释放内存清空指针</span>
           top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>
        
       <span class="token comment">//将当前用例插入 top_rated 作为新的获胜者</span>
       top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>
       q<span class="token operator">-></span>tc_ref<span class="token operator">++</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token operator">-></span>trace_mini<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果还没有最小化的位图</span>
         q<span class="token operator">-></span>trace_mini <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 分配内存</span>
         <span class="token function">minimize_bits</span><span class="token punctuation">(</span>q<span class="token operator">-></span>trace_mini<span class="token punctuation">,</span> trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 最小化位图</span>
       <span class="token punctuation">&#125;</span>
       score_changed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	 <span class="token comment">// 标记得分已改变</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="minimize-bits"><a href="#minimize-bits" class="headerlink" title="minimize_bits"></a>minimize_bits</h3><p>压缩数据大小，将数据本身转换成位置记录下来（是否覆盖到和覆盖了多少次的byte，压缩成是否覆盖到的bit）</p>
<p>原本表示 15 有值需要 n[14] &#x3D; 1，数据量大会消耗大量内存，这里的计算方式改成用 bitmap 二进制数值表示该位是否有值，例如 15 有值则表示为 0000000000000001</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">minimize_bits</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> dst<span class="token punctuation">,</span> u8<span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>src<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span> dst<span class="token punctuation">[</span>i <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h3><p>精简队列，<a href="##update_bitmap_score">update_bitmap_score</a> 过程中找到每条边的最佳测试用例，但是合在一起就存在冗余，所以还需要在这组测试用例中选择一个子集使得不会冗余</p>
<p>贪心算法：获取第一个的最佳测试用例，将其涉及的边标记，遍历剩余边未被标记就加入其最佳测试用例</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">;</span>
  <span class="token keyword">static</span> u8 temp_v<span class="token punctuation">[</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  u32 i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">||</span> <span class="token operator">!</span>score_changed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//如果设置了 dumb_mode 或没有设置 scor_changed，直接返回</span>

  score_changed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>temp_v<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//初始化 temp_v 全1，代表未覆盖，后续覆盖到则设置为0</span>

  queued_favored  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  pending_favored <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  q <span class="token operator">=</span> queue<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//遍历 queue 队列，设置其 favored 的值都为 0</span>
    q<span class="token operator">-></span>favored <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>temp_v<span class="token punctuation">[</span>i <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//该 path 有最优解且 temp_v 标记未覆盖</span>
      u32 j <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">// 获取 temp_v 的大小</span>
        
      <span class="token keyword">while</span> <span class="token punctuation">(</span>j<span class="token operator">--</span><span class="token punctuation">)</span>	<span class="token comment">//遍历覆盖到的 path 并将遍历到的位置在 temp_v 中标记为覆盖</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
          temp_v<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

      top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>favored <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//该边标记 favored</span>
      queued_favored<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//favored 数 +1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>was_fuzzed<span class="token punctuation">)</span> pending_favored<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//还没有 fuzz 过，pending 计数器 +1</span>
    <span class="token punctuation">&#125;</span>
  q <span class="token operator">=</span> queue<span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">mark_as_redundant</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">!</span>q<span class="token operator">-></span>favored<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 不是 favored 的 case，标记冗余的条目</span>
    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="show-init-stats"><a href="#show-init-stats" class="headerlink" title="show_init_stats"></a>show_init_stats</h3><p>在处理输入目录的末尾显示统计信息，以及一堆警告,以及几个硬编码的常量，ui 展示一些信息</p>
<p>输出内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">[+] Here are some useful stats:

    Test case count : 1 favored, 0 variable, 1 total
       Bitmap range : 2 to 2 bits (average: 2.00 bits)
        Exec timing : 682 to 682 us (average: 682 us)

[*] No -t option specified, so I&#39;ll use exec timeout of 20 ms.
[+] All set and ready to roll!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="find-start-position"><a href="#find-start-position" class="headerlink" title="find_start_position"></a>find_start_position</h3><p>resume （恢复之前的 fuzz）时，尝试查找要开始的队列的位置</p>
<ul>
<li>如果是 in_place_resume,就打开 out_dir&#x2F;fuzzer_stats 文件，否则打开 in_dir&#x2F;..&#x2F;fuzzer_stats 文件</li>
<li>读文件内容到 tmp 中，找到 cur_path，并设置为 ret 的值，如果大于 queued_paths 就设置 ret 为 0，返回 ret</li>
</ul>
<h3 id="write-stats-file"><a href="#write-stats-file" class="headerlink" title="write_stats_file"></a>write_stats_file</h3><p>更新 fuzzer_stats 文件，创建 out_dir&#x2F;fuzzer_stats 文件并写入统计信息</p>
<ul>
<li>start_time：fuzz运行的开始时间，start_time &#x2F; 1000</li>
<li>last_update：当前时间</li>
<li>fuzzer_pid：获取当前pid</li>
<li>cycles_done：queue_cycle 在 queue_cur 为空，即执行到当前队列尾的时候才增加 1，所以这代表 queue 队列被完全变异一次的次数</li>
<li>execs_done：total_execs，target的总的执行次数，每次 run_target 的时候会增加 1</li>
<li>execs_per_sec：每秒执行的次数</li>
<li>paths_total：queued_paths 在每次 add_to_queue 的时候会增加 1，代表 queue 里的样例总数</li>
<li>paths_favored：queued_favored，有价值的路径总数</li>
<li>paths_found：queued_discovered 在每次 common_fuzz_stuff 去执行一次fuzz时，发现新的 interesting case 的时候会增加 1，代表在 fuzz 运行期间发现的新 queue entry</li>
<li>paths_imported：queued_imported 是 master-slave 模式下，如果 sync 过来的 case 是 interesting 的，就增加 1</li>
<li>max_depth：最大路径深度</li>
<li>cur_path：current_entry 一般情况下代表的是正在执行的 queue entry 的整数 ID, queue 首节点的 ID 是 0</li>
<li>pending_favs：pending_favored 等待 fuzz 的 favored paths数</li>
<li>pending_total：pending_not_fuzzed 在 queue 中等待 fuzz 的 case 数</li>
<li>variable_paths：queued_variable 在 calibrate_case 去评估一个新的 test case 的时候，如果发现这个 case 的路径是可变的，则将这个计数器加一，代表发现了一个可变 case</li>
<li>stability</li>
<li>bitmap_cvg</li>
<li>unique_crashes：在 save_if_interesting 时，如果 fault 是 FAULT_CRASH，就将 unique_crashes 计数器加一</li>
<li>unique_hangs：在 save_if_interesting 时，如果 fault 是 FAULT_TMOUT，且 exec_tmout 小于 hang_tmout，就以 hang_tmout 为超时时间再执行一次，如果还超时，就让 hang 计数器加一</li>
<li>last_path：在 add_to_queue 里将一个新 case 加入 queue 时，就设置一次 last_path_time 为当前时间，last_path_time &#x2F; 1000</li>
<li>last_crash：在 unique_crashes 加一的时候，last_crash 也更新时间，last_crash_time &#x2F; 1000</li>
<li>last_hang：在unique_hangs加一的时候，last_hang也更新时间，last_hang_time &#x2F; 1000</li>
<li>execs_since_crash：total_execs - last_crash_execs，这里 last_crash_execs 是在上一次 crash 的时候的总计执行了多少次</li>
<li>exec_tmout：配置好的超时时间</li>
</ul>
<p>最终在 out&#x2F;fuzzer1&#x2F;fuzzer_stats 中输出了</p>
<pre class="line-numbers language-none"><code class="language-none">start_time        : 1741245280
last_update       : 1741259061
fuzzer_pid        : 3829
cycles_done       : 0
execs_done        : 8
execs_per_sec     : 0.00
paths_total       : 1
paths_favored     : 1
paths_found       : 0
paths_imported    : 0
max_depth         : 1
cur_path          : 0
pending_favs      : 1
pending_total     : 1
variable_paths    : 0
stability         : 0.00%
bitmap_cvg        : 0.00%
unique_crashes    : 0
unique_hangs      : 0
last_path         : 0
last_crash        : 0
last_hang         : 0
execs_since_crash : 8
exec_timeout      : 1000
afl_banner        : fuzzer1
afl_version       : 2.57b
target_mode       : default
command_line      : &#x2F;home&#x2F;starrysky&#x2F;AFL&#x2F;afl-fuzz -i in -o out -M fuzzer1 .&#x2F;test
slowest_exec_ms   : 1000
peak_rss_mb       : not available while afl is running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="save-auto"><a href="#save-auto" class="headerlink" title="save_auto"></a>save_auto</h3><p>保存自动生成的 extras，遍历 a_extras 写到 out_dir&#x2F;queue&#x2F;.state&#x2F;auto_extras&#x2F;（auto_%06u）i</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_auto</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>auto_changed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  auto_changed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">MIN</span><span class="token punctuation">(</span>USE_AUTO_EXTRAS<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/auto_extras/auto_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s32 fd<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="sync-fuzzers"><a href="#sync-fuzzers" class="headerlink" title="sync_fuzzers"></a>sync_fuzzers</h3><p>同步各个 fuzz 之间的状态，将其他 fuzz 下的 queue 保存到自己的 queue 中</p>
<ul>
<li>打开 sync_dir 同步目录</li>
<li>遍历同步文件夹下其他 fuzz 的文件夹<ul>
<li>跳过 . &#x2F; .. &#x2F; 当前 fuzz 文件夹</li>
<li>获取同步目录下其他 fuzz 文件夹中的 queue，存在说明这个文件夹是其他 fuzz 的 out_dir</li>
<li>在本 fuzz 的输出文件夹 out_dir 的 .synced 文件夹下创建&#x2F;打开以其他 fuzz 命名的文件</li>
<li>如果是打开，即文件已存在，则获取前 4 位为 min_accept 并且更新 next_min_accept &#x3D; min_accept</li>
<li>更新阶段信息、同步计数器</li>
<li>从其他 fuzz 的 queue 里遍历测试用例<ul>
<li>从文件名中获取id，跳过文件名是 . &#x2F; .. 和 id &lt; min_accept（已遍历过）的用例</li>
<li>更新下一次的 min_accept 为第一个满足条件的测试用例的 id + 1</li>
<li>将测试用例内容映射到内存并调用 <a href="##write_to_testcase">write_to_testcase</a> 写入当前的测试用例</li>
<li>调用 <a href="##run_target">run_target</a> 执行测试用例，如果用户手动中断则返回，调用 <a href="##save_if_interesting">save_if_interesting</a> 判断如果是 interesting case 保存并增加导入计数</li>
<li>设置当前同步的 fuzzer 的名称，解除内存映射，增加 cur 计数器，达到 stats_update_freq  的倍数就刷新 ui 界面</li>
</ul>
</li>
<li>关闭文件，释放内存</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  DIR<span class="token operator">*</span> sd<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> sd_ent<span class="token punctuation">;</span>
  u32 sync_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  sd <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开 sync 文件夹（同步目录）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sd<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  stage_max <span class="token operator">=</span> stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  cur_depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sd_ent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//遍历同步文件夹下其他 fuzz 的文件夹</span>
    <span class="token keyword">static</span> u8 stage_tmp<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    DIR<span class="token operator">*</span> qd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> qd_ent<span class="token punctuation">;</span>
    u8 <span class="token operator">*</span>qd_path<span class="token punctuation">,</span> <span class="token operator">*</span>qd_synced_path<span class="token punctuation">;</span>
    u32 min_accept <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> next_min_accept<span class="token punctuation">;</span>

    s32 id_fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//跳过 . / .. 和当前 fuzz 生成的文件夹</span>

    qd_path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s/queue"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取同步目录下其他 fuzz 文件夹里的 queue 文件夹</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>qd <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>	<span class="token comment">//打开失败就释放空间跳过</span>

    qd_synced_path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.synced/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//在本 fuzz 输出目录的同步文件夹下创建其他 fuzz 命名的文件</span>

    id_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>qd_synced_path<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>id_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_accept<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> 	<span class="token comment">// 若这个文件已经存在，则它的首 4 字节表示 min_accept</span>
      <span class="token function">lseek</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    next_min_accept <span class="token operator">=</span> min_accept<span class="token punctuation">;</span>

    <span class="token comment">//更新阶段信息、同步计数器</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>stage_tmp<span class="token punctuation">,</span> <span class="token string">"sync %u"</span><span class="token punctuation">,</span> <span class="token operator">++</span>sync_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stage_name <span class="token operator">=</span> stage_tmp<span class="token punctuation">;</span>
    stage_cur  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    stage_max  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>qd_ent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>qd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//从其他 fuzz 的 queue 里遍历</span>
      u8<span class="token operator">*</span> path<span class="token punctuation">;</span>
      s32 fd<span class="token punctuation">;</span>
      <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span>
          <span class="token function">sscanf</span><span class="token punctuation">(</span>qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">,</span> CASE_PREFIX <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>syncing_case<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> 
          syncing_case <span class="token operator">&lt;</span> min_accept<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//从文件名中获取id，跳过文件名是 . / .. 和 id &lt; min_accept（已遍历过）的用例</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>syncing_case <span class="token operator">>=</span> next_min_accept<span class="token punctuation">)</span>	<span class="token comment">//更新下一次的 min_accept 为下一个 id</span>
        next_min_accept <span class="token operator">=</span> syncing_case <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

      path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> qd_path<span class="token punctuation">,</span> qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取循环到的测试用例</span>

      fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token function">ck_free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fstat() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取与文件描述符相关的文件状态信息</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size <span class="token operator">&amp;&amp;</span> st<span class="token punctuation">.</span>st_size <span class="token operator">&lt;=</span> MAX_FILE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//文件大小合法</span>
        u8  fault<span class="token punctuation">;</span>
        u8<span class="token operator">*</span> mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为测试用例开辟空间</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to mmap '%s'"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 将内存映射的文件内容写入当前的测试用例</span>

        fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//执行测试用例</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//如果用户手动中断则返回</span>

        syncing_party <span class="token operator">=</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">;</span>	<span class="token comment">// 设置当前同步的fuzzer的名称</span>
        queued_imported <span class="token operator">+=</span> <span class="token function">save_if_interesting</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> fault<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果是 interesting case，保存并增加导入计数</span>
        syncing_party <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">munmap</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 解除内存映射</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>stage_cur<span class="token operator">++</span> <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//增加 cur 计数器，达到 stats_update_freq  的倍数就刷新 ui 界面</span>
      <span class="token punctuation">&#125;</span>

      <span class="token function">ck_free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">ck_write</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>next_min_accept<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">,</span> qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//向遍历到的其他 fuzz 的文件夹中写入 next_min_accept</span>

    <span class="token comment">//关闭文件释放空间</span>
    <span class="token function">close</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">closedir</span><span class="token punctuation">(</span>qd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">&#125;</span>  
  <span class="token function">closedir</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="save-if-interesting"><a href="#save-if-interesting" class="headerlink" title="save_if_interesting"></a>save_if_interesting</h3><ul>
<li>崩溃模式且崩溃或普通模式且没有崩溃<ul>
<li>如果 hit count没有变动且没有出现新的边就返回 0，如果是 crash 模式就增加总 crash 数</li>
<li>设置文件名 out_dir&#x2F;queue&#x2F;id_paths，将测试用例文件保存到队列中</li>
<li>如果 <a href="##has_new_bits">has_new_bits</a> 发现了新的边则标记为有新覆盖，增加有覆盖的队列数</li>
<li>计算 trace_bits 哈希值保存到 exec_cksum，调用 <a href="##calibrate_case">calibrate_case</a> 评估测试用例</li>
<li>如果报错信息是 error 则报错退出，否则根据设置的文件名创建测试用例文件并且将测试用例写入文件，设置 keeping &#x3D; 1</li>
</ul>
</li>
<li>根据报错信息做出不同行为<ul>
<li>FAULT_TMOUT<ul>
<li>超时计数器 total_tmouts++</li>
<li>unique_hangs 的个数超过能保存的最大数量 KEEP_UNIQUE_HANG 返回 keeping 值</li>
<li>非 dumb 模式调用 <a href="##simplify_trace">simplify_trace</a> 规整 trace_bits，没有发现新的超时路径则返回 keeping</li>
<li>存在新路径的超时计数器 unique_tmouts++</li>
<li>执行时间小于 hang_tmout 则重新执行，结果是 crash 跳转到 keep_as_crash，不是超时返回 keeping，中途用户中断则 return</li>
<li><u>设置文件名为 out_dir&#x2F;hangs&#x2F;id_unique_hangs</u></li>
<li>存在新路径的挂起计数器unique_hangs++</li>
<li>设置最后一次挂起时间</li>
</ul>
</li>
<li>FAULT_CRASH &#x2F; keep_as_crash<ul>
<li>总 crash 数 total_crashes++</li>
<li>崩溃数量超过最大值则返回 keeping</li>
<li>非 dumb 模式调用 <a href="##simplify_trace">simplify_trace</a> 规整 trace_bits，没有发现新的超时路径则返回 keeping</li>
<li>如果是第一次崩溃，生成 README 文件</li>
<li><u>设置文件名为 out_dir&#x2F;crashes&#x2F;id_unique_crashes_kill_signal</u></li>
<li>存在新边的 crash 数 unique_crashes++</li>
<li>获取当前时间作为最后一次 crash 时间，记录最后一次崩溃执行次数</li>
</ul>
</li>
<li>FAULT_ERROR<ul>
<li>报错退出</li>
</ul>
</li>
<li>default<ul>
<li>返回 keeping</li>
</ul>
</li>
</ul>
</li>
<li>将测试利用写入设置的路径后关闭文件释放内存</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">save_if_interesting</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> mem<span class="token punctuation">,</span> u32 len<span class="token punctuation">,</span> u8 fault<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8  <span class="token operator">*</span>fn <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  u8  hnb<span class="token punctuation">;</span>
  s32 fd<span class="token punctuation">;</span>
  u8  keeping <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> res<span class="token punctuation">;</span>

  <span class="token comment">// 若 fault = crash_mode = 2，则处于 crash exploration 模式且崩溃了</span>
  <span class="token comment">// 若 fault = crash_mode = 0，则处于普通模式且没有崩溃或超时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fault <span class="token operator">==</span> crash_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// has_new_bits 返回值：0 表示无成果；1 表示 hit count 变动；2 表示发现了新的边</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>hnb <span class="token operator">=</span> <span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//hit count没有变动且没有新的边</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> total_crashes<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//crash 模式，则增加总 crash 数</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//返回 0</span>
    <span class="token punctuation">&#125;</span>    

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>
    fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id:%06u,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> queued_paths<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span>hnb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> queued_paths<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置文件名 out_dir/queue/id_paths</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

    <span class="token function">add_to_queue</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将测试用例文件保存到队列中</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>hnb <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//发现了新的边</span>
      queue_top<span class="token operator">-></span>has_new_cov <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//标记为有新覆盖</span>
      queued_with_cov<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//增加有覆盖的队列数</span>
    <span class="token punctuation">&#125;</span>

    queue_top<span class="token operator">-></span>exec_cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 计算 trace_bits 哈希值保存到 exec_cksum</span>

    res <span class="token operator">=</span> <span class="token function">calibrate_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> queue_top<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> queue_cycle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//评估测试用例</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建测试用例文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将测试用例写入文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    keeping <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">// 标记为保持</span>

  <span class="token punctuation">&#125;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>fault<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">case</span> FAULT_TMOUT<span class="token operator">:</span>
      total_tmouts<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//超时计数器 +1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>unique_hangs <span class="token operator">>=</span> KEEP_UNIQUE_HANG<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>	<span class="token comment">//unique_hangs 的个数超过能保存的最大数量 KEEP_UNIQUE_HANG 返回 keeping 值</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//非简单模式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__x86_64__</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//规整 trace_bits</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__x86_64__ */</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_tmout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>	<span class="token comment">//没有发现新的超时路径则返回 keeping</span>
      <span class="token punctuation">&#125;</span>

      unique_tmouts<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//存在新路径的超时计数器 +1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">&lt;</span> hang_tmout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//执行时间小于 hang_tmout 则重新执行，结果是 crash 跳转到 keep_as_crash，不是超时返回 keeping</span>
        u8 new_fault<span class="token punctuation">;</span>
        <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        new_fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> hang_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> new_fault <span class="token operator">==</span> FAULT_CRASH<span class="token punctuation">)</span> <span class="token keyword">goto</span> keep_as_crash<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> new_fault <span class="token operator">!=</span> FAULT_TMOUT<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>
      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs/id:%06llu,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_hangs<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs/id_%06llu"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_hangs<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置文件名为 out_dir/hangs/id_unique_hangs</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

      unique_hangs<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//增加 unique_hangs</span>

      last_hang_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取最后一次挂起时间</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> FAULT_CRASH<span class="token operator">:</span>

keep_as_crash<span class="token operator">:</span>
      total_crashes<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//增加总 crash 数</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>unique_crashes <span class="token operator">>=</span> KEEP_UNIQUE_CRASH<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>	<span class="token comment">//崩溃数量超过最大值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//同上</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__x86_64__</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__x86_64__ */</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_crash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unique_crashes<span class="token punctuation">)</span> <span class="token function">write_crash_readme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果是第一次崩溃，生成 README 文件</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>
      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes/id:%06llu,sig:%02u,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_crashes<span class="token punctuation">,</span> kill_signal<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes/id_%06llu_%02u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_crashes<span class="token punctuation">,</span> kill_signal<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置文件名为 out_dir/crashes/id_unique_crashes_kill_signal</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

      unique_crashes<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//存在新边的 crash 数 +1</span>

      last_crash_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取当前时间作为最后一次 crash 时间</span>
      last_crash_execs <span class="token operator">=</span> total_execs<span class="token punctuation">;</span>	<span class="token comment">// 记录最后一次崩溃执行次数</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> FAULT_ERROR<span class="token operator">:</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//error 错误则报错退出</span>

    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>

  <span class="token punctuation">&#125;</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将测试利用写入设置的路径</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="simplify-trace"><a href="#simplify-trace" class="headerlink" title="simplify_trace"></a>simplify_trace</h3><p>简化跟踪位，保留「是否命中」而不保留 count</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> u8 simplify_lookup<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> 
  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">1</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">128</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>循环 8 字节读 mem</li>
<li>mem 不为空则将其每一位规整到 1（未命中） &#x2F; 128（命中）</li>
<li>mem 为空则设置 mem &#x3D; 0x0101010101010101</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simplify_trace</span><span class="token punctuation">(</span>u64<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      u8<span class="token operator">*</span> mem8 <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span>

      mem8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem8<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem8<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem8<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      mem8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token number">0x0101010101010101ULL</span><span class="token punctuation">;</span>

    mem<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one"></a>fuzz_one</h3><p>三种变异方式： 确定性变异 deterministic、随机变异 havoc、拼接变异 splicing，源码太长，就不放了（</p>
<ul>
<li>从 queue 取出一个测试用例<ul>
<li>pending_favored !&#x3D; 0 &amp; 测试用例已经完成 fuzz &#x2F; 非favored ：99% 概率跳过</li>
<li>pending_favored &#x3D;&#x3D; 0 &amp; ！dumb_mode &amp; 非 favored &amp; 测试用例数量大于 10<ul>
<li>queue_cycle &gt; 1 &amp; 测试用例未被 fuzz ：75% 概率跳过</li>
<li>测试用例已经完成 fuzz ：95% 概率跳过</li>
</ul>
</li>
</ul>
</li>
<li>测试用例有校准错误且小于三次，调用 <a href="##calibrate_case">calibrate_case</a> 再次校准</li>
<li>调用 <a href="##trim_case">trim_case</a> 对测试用例进行修剪</li>
<li>已经经历过确定性变异则直接跳转至 havoc 阶段，否则调用 <a href="##calculate_score">calculate_score</a> 函数计算当前 case 的可取性得分后进行确定性变异</li>
<li>确定性变异 deterministic：<ul>
<li>字节翻转：bitflip a&#x2F;b：每次翻转 a 位，按 b 位步长从头开始，例如 bitflip 1&#x2F;1 就是将每一位都翻转，在 bitflip8&#x2F;8 之后会自动检测 token，获取翻转后对路径有影响的值</li>
<li>算数变异：arithmetic a&#x2F;b：每次 a bit 进行加减运算，b bit步长从头开始，存在大端序和小端序两种形式对模板整数 +1 … +35 … -1 … -35</li>
<li>INTERESTING VALUES：interest a&#x2F;b，每次 a bit 进行加减运算，b bit 步长从头开始，替换为预设的 interesting 值</li>
<li>DICTIONARY STUFF：替换成用户 -x 指定的字典中的 token，存在 user extras(over) 替换、user extras(insert) 插入、auto extras(over) 自动检测替换 三种模式</li>
</ul>
</li>
<li>随机变异 havoc：随机加减替换插入已知 token 或随即值</li>
<li>拼接 splicing：havoc 没什么效果就会进入 splicing，拼接两个测试用例再重复上述变异</li>
</ul>
<h3 id="trim-case"><a href="#trim-case" class="headerlink" title="trim_case"></a>trim_case</h3><p>裁剪测试用例，节约在进行确定性检查时的循环次数</p>
<ul>
<li>测试用例长度小于 5 直接返回，更新 stage_name 和 累计裁剪输入的字节数 bytes_trim_in，选择初始块长度 len_p2（第一个大于等于 q-&gt;len 的 2 的次幂），计算前进步长</li>
<li>循环直至剩余大小小于 max{len_p2 &#x2F; 1024, 4}<ul>
<li>获取剩余大小，输出提示信息，更新当前阶段信息</li>
<li>循环每次前进 remove_len 直到整个文件被遍历完<ul>
<li>获取实际可裁剪长度，裁剪指定块</li>
<li>执行测试用例得到报错信息，增加执行裁剪次数计数器，如果用户中断或执行错误则跳转到 abort_trimming</li>
<li>计算裁剪后的校验和，和原来的校验和比较<ul>
<li>校验和相同，更新长度，计算下一个长度，更新内容，删除 remove_pos 向后的 remove_len 个字节，标记为需要修改，保存更新后的 trace_bits</li>
<li>校验和不同，说明裁剪后有影响则不裁剪，更新位置</li>
</ul>
</li>
<li>执行固定次数显示一次状态，更新 stage_cur</li>
</ul>
</li>
<li>块长度减半，继续下一轮裁剪</li>
</ul>
</li>
<li>如果标记为需要修改，删除原文件并且重新创建该文件，写入裁剪后的数据到新文件，更新 trace_bits 和位图分数</li>
<li>abort_trimming：记录裁剪后的总字节数，返回裁剪过程中发生的任何错误</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">trim_case</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">,</span> u8<span class="token operator">*</span> in_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">static</span> u8 tmp<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">static</span> u8 clean_trace<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

  u8  needs_write <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> fault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u32 trim_exec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u32 remove_len<span class="token punctuation">;</span>
  u32 len_p2<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>len <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//长度小于 5 直接返回</span>

  stage_name <span class="token operator">=</span> tmp<span class="token punctuation">;</span>	<span class="token comment">// 更新全局变量</span>
  bytes_trim_in <span class="token operator">+=</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span>	<span class="token comment">// 累计裁剪输入的字节数</span>

  len_p2 <span class="token operator">=</span> <span class="token function">next_p2</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//while (val > ret) ret &lt;&lt;= 1; 第一个大于等于 q->len 的 2 的次幂</span>

  <span class="token comment">//TRIM_MIN_BYTES = 4		TRIM_START_STEPS = 16 		TRIM_END_STEPS = 1024</span>
  remove_len <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>len_p2 <span class="token operator">/</span> TRIM_START_STEPS<span class="token punctuation">,</span> TRIM_MIN_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//前进步长 max&#123;len_p2 / 16, 4&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>remove_len <span class="token operator">>=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>len_p2 <span class="token operator">/</span> TRIM_END_STEPS<span class="token punctuation">,</span> TRIM_MIN_BYTES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//剩余大小大于等于 max&#123;len_p2 / 1024 ,4&#125;</span>
    u32 remove_pos <span class="token operator">=</span> remove_len<span class="token punctuation">;</span>

    <span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"trim %s/%s"</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    stage_max <span class="token operator">=</span> q<span class="token operator">-></span>len <span class="token operator">/</span> remove_len<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>remove_pos <span class="token operator">&lt;</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//每次前进remove_len个步长，直到整个文件都被遍历完为止</span>
      u32 trim_avail <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">,</span> q<span class="token operator">-></span>len <span class="token operator">-</span> remove_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 实际可裁剪长度</span>
      u32 cksum<span class="token punctuation">;</span>

      <span class="token function">write_with_gap</span><span class="token punctuation">(</span>in_buf<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">,</span> remove_pos<span class="token punctuation">,</span> trim_avail<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 裁剪指定块</span>

      fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//执行测试用例得到报错信息</span>
      trim_execs<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//增加执行裁剪次数</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> fault <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span> <span class="token keyword">goto</span> abort_trimming<span class="token punctuation">;</span>	<span class="token comment">//用户中断或执行错误则跳转到中断裁剪</span>

      cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//// 计算裁剪后的校验和</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>cksum <span class="token operator">==</span> q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//和裁剪前的校验和相同则保留</span>
        u32 move_tail <span class="token operator">=</span> q<span class="token operator">-></span>len <span class="token operator">-</span> remove_pos <span class="token operator">-</span> trim_avail<span class="token punctuation">;</span>

        q<span class="token operator">-></span>len <span class="token operator">-=</span> trim_avail<span class="token punctuation">;</span>	<span class="token comment">//更新长度</span>
        len_p2  <span class="token operator">=</span> <span class="token function">next_p2</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//计算下一个长度</span>

        <span class="token function">memmove</span><span class="token punctuation">(</span>in_buf <span class="token operator">+</span> remove_pos<span class="token punctuation">,</span> in_buf <span class="token operator">+</span> remove_pos <span class="token operator">+</span> trim_avail<span class="token punctuation">,</span> move_tail<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新内容，删除remove_pos向后的remove_len个字节</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needs_write<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	
          needs_write <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//标记为需要修改</span>
          <span class="token function">memcpy</span><span class="token punctuation">(</span>clean_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//保存更新后的 trace_bits</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> remove_pos <span class="token operator">+=</span> remove_len<span class="token punctuation">;</span>	<span class="token comment">//裁剪后有影响则不裁剪，更新位置</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>trim_exec<span class="token operator">++</span> <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//执行固定次数显示一次状态</span>
      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    remove_len <span class="token operator">>>=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">// 块长度减半，继续下一轮裁剪。</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>needs_write<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果需要修改</span>
    s32 fd<span class="token punctuation">;</span>

    <span class="token function">unlink</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 删除原文件，忽略错误</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//重新创建文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//写入裁剪后的数据到新文件</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> clean_trace<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新 trace_bits</span>
    <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新位图分数</span>
  <span class="token punctuation">&#125;</span>

abort_trimming<span class="token operator">:</span>
  bytes_trim_out <span class="token operator">+=</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span>	<span class="token comment">// 记录裁剪后的总字节数</span>
  <span class="token keyword">return</span> fault<span class="token punctuation">;</span>	<span class="token comment">// 返回裁剪过程中发生的任何错误</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="calculate-score"><a href="#calculate-score" class="headerlink" title="calculate_score"></a>calculate_score</h3><p>计算测试用例的性能得分，以调整 havoc 模糊测试的长度，跑得越快、覆盖度越高、深度越大，分数就会越高，在 havoc 阶段就会有更多资源来尝试变异</p>
<ul>
<li><p>计算平均时间、bitmap大小、设置初始 perf_score 为 100</p>
</li>
<li><p>read_testcases 时会调用 add_to_queue，此时所有的 input case 的 queue depth 都会被设置为 1</p>
</li>
<li><p>fuzz_one 时，会先设置 cur_depth 为当前 queue 的 depth，然后这个 queue 经过 mutate 之后调用 save_if_interesting,如果是 interesting case，就会被 add_to_queue，此时就建立起了 queue 之间的关联关系，所以由当前 queue 变异加入的新 queue，深度都在当前 queue 的基础上再增加</p>
</li>
</ul>
<h3 id="common-fuzz-stuff"><a href="#common-fuzz-stuff" class="headerlink" title="common_fuzz_stuff"></a>common_fuzz_stuff</h3><p>将变异出的用例写入 out_file 文件、调用 run_target  执行实验、调用 save_if_interesting() 以考虑将这个用例保存下来，如果连续超时就放弃这个测试用例</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST u8 <span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> u8<span class="token operator">*</span> out_buf<span class="token punctuation">,</span> u32 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 fault<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>post_handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    out_buf <span class="token operator">=</span> <span class="token function">post_handler</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果存在后处理函数，则调用该函数处理输出缓冲区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_buf <span class="token operator">||</span> <span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 如果处理后没有输出或长度为0，则直接返回0</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">// 将测试用例写入文件，准备运行</span>

  fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 运行被测程序，并记录运行结果（如崩溃、超时等）</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fault <span class="token operator">==</span> FAULT_TMOUT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subseq_tmouts<span class="token operator">++</span> <span class="token operator">></span> TMOUT_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">// 记录连续超时的次数。如果连续超时次数过多，放弃这个测试用例</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> subseq_tmouts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 如果不是超时，重置连续超时计数器</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_requested<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果收到跳过当前测试用例的请求，则重置请求标志，增加跳过路径计数，返回 1</span>
     skip_requested <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
    
  queued_discovered <span class="token operator">+=</span> <span class="token function">save_if_interesting</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fault<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 调用 save_if_interesting 函数判断当前测试用例是否有趣（比如是否触发了新的代码路径或崩溃）</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>stage_cur <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span> <span class="token operator">||</span> stage_cur <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> stage_max<span class="token punctuation">)</span>
    <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 每隔一定次数更新统计信息，或者在阶段结束时更新</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/fuzz/">
                                    <span class="chip bg-color">fuzz</span>
                                </a>
                            
                                <a href="/tags/AFL/">
                                    <span class="chip bg-color">AFL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/04/06/awdp-sai-zhi-liu-cheng-yu-ji-qiao/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="AWDP赛制流程与技巧">
                        
                        <span class="card-title">AWDP赛制流程与技巧</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            AWDP赛制流程与技巧
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-04-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/AWDP/" class="post-category">
                                    AWDP
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/AWDP/">
                        <span class="chip bg-color">AWDP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/02/24/afl-yuan-ma-fen-xi-yi/afl-yuan-ma-fen-xi-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="AFL源码分析（一）">
                        
                        <span class="card-title">AFL源码分析（一）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            AFL源码分析
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-02-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/fuzz/" class="post-category">
                                    fuzz
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/fuzz/">
                        <span class="chip bg-color">fuzz</span>
                    </a>
                    
                    <a href="/tags/AFL/">
                        <span class="chip bg-color">AFL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">starrysky</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">219.8k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/starrysky1004" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:starrysky20041005@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2726736810" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2726736810" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>









    <a href="https://space.bilibili.com/85923475" class="tooltipped" target="_blank" data-tooltip="关注我的bilibili" data-position="top" data-delay="50">
        <i class="fas fa-video"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":260,"height":300},"mobile":{"show":true},"log":false});</script></body>

</html>
