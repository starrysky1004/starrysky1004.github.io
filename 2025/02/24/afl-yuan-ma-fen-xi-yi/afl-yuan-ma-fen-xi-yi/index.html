<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="AFL源码分析（一）, starrysky">
    <meta name="description" content="Love rises from the east and descends to the west,romance makes no changes until death.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>AFL源码分析（一） | starrysky</title>
    <link rel="icon" type="image/jpeg" href="/favicon.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="starrysky" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">starrysky</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>文章</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>个人简介</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">starrysky</div>
        <div class="logo-desc">
            
            Love rises from the east and descends to the west,romance makes no changes until death.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			文章
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			个人简介
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/Steel%20Gray.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">AFL源码分析（一）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/fuzz/">
                                <span class="chip bg-color">fuzz</span>
                            </a>
                        
                            <a href="/tags/AFL/">
                                <span class="chip bg-color">AFL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/fuzz/" class="post-category">
                                fuzz
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-02-24
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.3k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    40 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="afl-gcc"><a href="#afl-gcc" class="headerlink" title="afl-gcc"></a>afl-gcc</h2><h3 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>test.c源码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>gdb载入源码调试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$gdb</span> <span class="token punctuation">..</span>/AFL/afl-gcc
pwndbg<span class="token operator">></span> <span class="token builtin class-name">set</span> args test.c <span class="token parameter variable">-o</span> <span class="token builtin class-name">test</span>
pwndbg<span class="token operator">></span> <span class="token function">dir</span> <span class="token punctuation">..</span>/AFL
pwndbg<span class="token operator">></span> b main
pwndbg<span class="token operator">></span> r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><ul>
<li>输出版本信息</li>
<li>判断没有参数就退出</li>
<li>获取 afl-as 路径</li>
<li>调用 edit_params 解析参数</li>
<li>根据解析出的参数使用 execvp 执行 gcc</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//标准错误输出 stderr 定向到终端且 AFL_QUIET 环境变量不存在</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-cc "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//输出 AFL 的版本信息</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果标准错误输出 stderr 重定向到其他位置，或者 AFL_QUIET 环境变量存在，则设置 be_quiet = 1</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果 afl-gcc 后面没有参数则输出报错后退出</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> BIN_PATH<span class="token punctuation">,</span> BIN_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">find_as</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//寻找 afl-as 的位置</span>
  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解析参数</span>
  <span class="token function">execvp</span><span class="token punctuation">(</span>cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>cc_params<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//执行参数列表中的指令,通过 -B 指定使用 afl-as 进行汇编来编译插桩</span>
  <span class="token comment">//最终执行参数: gcc test.c -o test -B /home/starrysky/AFL -g -O3 -funroll-loops -D__AFL_COMPILER=1 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</span>
  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解析失败报错</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h3><ul>
<li>通过环境变量中的 AFL_PATH 找 afl-as</li>
<li>如果没有就在 afl-gcc 所在目录里找 afl-as</li>
<li>再次去 AFL_PATH 中找 afl-as 找到就改成 AFL_PATH 中的 afl-as</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">find_as</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> argv0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 <span class="token operator">*</span>afl_path <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取环境变量中的 AFL_PATH</span>
  u8 <span class="token operator">*</span>slash<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>afl_path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//环境变量中存在 AFL_PATH</span>
    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/as"</span><span class="token punctuation">,</span> afl_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// AFL_PATH / as 可访问</span>
      as_path <span class="token operator">=</span> afl_path<span class="token punctuation">;</span>	<span class="token comment">// as_path 设置为环境变量中的 AFL_PATH</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  slash <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv0<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取当前执行的 afl-gcc 程序路径字符串中“/”字符最后一次出现的位置,本例中"../AFL/afl-gcc"则指向"AFL/"后的"/"</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>slash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    u8 <span class="token operator">*</span>dir<span class="token punctuation">;</span>
    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    dir <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>argv0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token char">'/'</span><span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/afl-as"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// ../AFL/afl-as 可访问</span>
      as_path <span class="token operator">=</span> dir<span class="token punctuation">;</span>	<span class="token comment">// as_path 设置为 ../AFL/afl-as</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>AFL_PATH <span class="token string">"/as"</span><span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//第一次检查的时候可能是 NULL,再检查一遍 AFL_PATH / as 是否可访问</span>
    as_path <span class="token operator">=</span> AFL_PATH<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to find AFL wrapper binary for 'as'. Please set AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h3><p>处理 afl-fuzz 的参数，将参数存放到 cc_params[]</p>
<ul>
<li><p>根据 afl 指令选择对应的编译器存放到 cc_params[0]：afl-gcc &#x2F; afl-g++ &#x2F; afl-clang &#x2F; afl-clang++ &#x2F; afl-gcj &#x3D;&gt; gcc &#x2F; g++ &#x2F; clang &#x2F; clang++ &#x2F; gcj</p>
</li>
<li><p>循环解析参数并添加到参数列表数组中并设置相应的环境变量</p>
<ul>
<li><blockquote>
<ul>
<li>跳过 -B 后面的参数</li>
<li>跳过 -integrated-as 和 -pipe</li>
<li>-m32：设置 m32_set &#x3D; 1</li>
<li>存在 -fsanitize&#x3D;address  或 -fsanitize&#x3D;memory 设置 asan_set &#x3D; 1</li>
<li>存在 FORTIFY_SOURCE 设置 fortify_set &#x3D; 1</li>
</ul>
</blockquote>
</li>
<li><p>将当前参数存放到 cc_params 参数数组中</p>
</li>
</ul>
</li>
<li><p>附加参数：</p>
<ul>
<li>-B as_path</li>
<li>-O3：启用一系列优化措施，以提高程序的运行速度和效率</li>
<li>-funroll-loops：启用循环展开优化减少循环控制的开销</li>
<li>-D__AFL_COMPILER&#x3D;1：指示编译器正在使用 AFL</li>
<li>-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION&#x3D;1：指示当前的编译模式是为模糊测试准备的，而不是用于生产环境</li>
</ul>
</li>
<li><p>在一定条件下附加参数：</p>
<ul>
<li><p>是 clang 模式：加上参数 -no-integrated-as，禁用 Clang 的内置汇编器</p>
</li>
<li><p>存在全局变量 AFL_HARDEN ：加上参数 -fstack-protector-all，启用堆栈保护，即canary</p>
</li>
<li><p>fortify_set &#x3D; 1：加上参数 -D_FORTIFY_SOURCE&#x3D;2，增强标准库函数的安全性，检查标准库函数（如 memcpy、strcpy 等）的参数是否可能导致缓冲区溢出</p>
</li>
<li><p>存在参数 -fsanitize&#x3D;address  或 -fsanitize&#x3D;memory：设置环境变量 AFL_USE_ASAN 为 1</p>
</li>
<li><p>存在环境变量 AFL_USE_ASAN &#x2F; AFL_USE_MSAN</p>
<ul>
<li>同时存在环境变量 AFL_USE_MSAN &#x2F; AFL_HARDEN 则报错</li>
<li>参数加上 -U_FORTIFY_SOURCE 和 -fsanitize&#x3D;address</li>
</ul>
</li>
<li><p>不是 FreeBSD 系统：加 -g 在编译时生成调试信息</p>
</li>
<li><p>存在环境变量 AFL_NO_BUILTIN ：附加一系列参数禁用编译器对一系列 str 和 cmp 类函数的内置优化，确保使用标准库中定义的strcmp函数</p>
</li>
</ul>
</li>
<li><p>在参数列表末尾加上 NULL 表示结束</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span>u32 argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 fortify_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> asan_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u8 <span class="token operator">*</span>name<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>
  u8 m32_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  cc_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为 cc_params 开辟空间,本例中 argc = 4</span>

  name <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//找到最后一个"/"的位置,也就是"../AFL/afl-gcc"中的第二个"/"位置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">else</span> name<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//如果存在"/",则 name 为"/"下一个位置即"afl-gcc",如果不存在也就是直接使用了 AFL_PATH 中的 afl-gcc 则 name 直接等于 argv[0]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//判断是否为 afl-clang</span>
    clang_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//是 afl-clang 则设置 clang_mode = 1 且设置环境变量 CLANG_ENV_VAR 为 1</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//进一步判断是否是 afl-clang++</span>
      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang++"</span><span class="token punctuation">;</span>	<span class="token comment">//是 afl-clang++ 则设置 cc_params[0] 为环境变量里的 AFL_CXX 或者 clang++</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang"</span><span class="token punctuation">;</span>	<span class="token comment">//是 afl-clang 则设置 cc_params[0] 为环境变量里的 AFL_CC 或者 clang</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__	</span><span class="token comment">//如果是苹果平台</span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>	<span class="token comment">//本例是在linux, 最终 cc_params[0] = gcc</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-g++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果是 afl-g++ 则设置 cc_params[0] 为环境变量中 AFL_CXX 的值或 g++</span>
      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"g++"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-gcj"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果是 afl-gcj 则设置 cc_params[0] 为环境变量中 "AFL_GCJ 的值或 gcj,用于编译 java</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_GCJ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcj"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果是其他指令, 设置 cc_params[0] 为环境变量中 "AFL_CC 的值或 gcc</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcc"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>argc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//第一个参数处理完参数数量减1,遍历其他参数</span>
    u8<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">++</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取下一个参数的位置</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-B"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>		<span class="token comment">//处理参数 -B,用于指定工具链或库文件的参数,这里会跳过 -B 和它的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"-B is already set, overriding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//be_quiet 为 0 则提示已经设置过</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cur<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> argc <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> argc<span class="token operator">--</span><span class="token punctuation">;</span> argv<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>	<span class="token comment">//跳过 -B 后面的参数</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-integrated-as"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//跳过参数 -integrated-as</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-pipe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//跳过参数 -pipe</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span>	</span><span class="token comment">//如果是 FreeBSD 系统并且是 x86-64架构,本例中不是</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-m32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m32_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> asan_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//存在 -fsanitize=address  或 -fsanitize=memory 则设置 asan_set = 1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"FORTIFY_SOURCE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> fortify_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//存在 FORTIFY_SOURCE 则设置 fortify_set = 1</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span>	<span class="token comment">//将当前参数存到 cc_params 数组中</span>
  <span class="token punctuation">&#125;</span>

  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-B"</span><span class="token punctuation">;</span>
  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> as_path<span class="token punctuation">;</span>	<span class="token comment">//参数数组增加 -B as_path 指定 afl-as 位置</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>clang_mode<span class="token punctuation">)</span>	<span class="token comment">//如果是 clang 模式则加上参数 -no-integrated-as,禁用 Clang 的内置汇编器</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-no-integrated-as"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果存在全局变量 AFL_HARDEN 则加上参数 -fstack-protector-all,启用堆栈保护,即canary</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fstack-protector-all"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fortify_set<span class="token punctuation">)</span>	<span class="token comment">//如果 fortify_set = 1 再加上参数 -D_FORTIFY_SOURCE=2,增强标准库函数的安全性,检查标准库函数（如 memcpy、strcpy 等）的参数是否可能导致缓冲区溢出</span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D_FORTIFY_SOURCE=2"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>asan_set<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//存在参数 -fsanitize=address  或 -fsanitize=memory </span>
    <span class="token comment">/* Pass this on to afl-as to adjust map density.将其传递给 afl-as 来调整 map density */</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置环境变量 AFL_USE_ASAN 为 1</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果存在环境变量 AFL_USE_ASAN</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//同时存在环境变量 AFL_USE_MSAN 则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//同时存在环境变量 AFL_HARDEN 则报错</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span>	<span class="token comment">//参数加上 -U_FORTIFY_SOURCE</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">;</span>	<span class="token comment">//参数加上 -fsanitize=address</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//同上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"MSAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_DONT_OPTIMIZE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>

    <span class="token comment">//源码注释翻译：在 64 位 FreeBSD 系统上，clang -g -m32 出现故障，但 -m32 本身可以正常工作</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">||</span> <span class="token operator">!</span>m32_set<span class="token punctuation">)</span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>	<span class="token comment">//因为不是 FreeBSD 系统所以直接在参数后面加 -g,用于在编译时生成调试信息</span></span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-O3"</span><span class="token punctuation">;</span>	<span class="token comment">//加上参数 -O3,启用一系列优化措施，以提高程序的运行速度和效率</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-funroll-loops"</span><span class="token punctuation">;</span>	<span class="token comment">//加上参数 -funroll-loops,启用循环展开优化减少循环控制的开销</span>

    <span class="token comment">//源码注释翻译：您正在为模糊测试构建两个指标；其中一个是 AFL 专用的，另一个与 libfuzzer 共享</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D__AFL_COMPILER=1"</span><span class="token punctuation">;</span>	<span class="token comment">//指示编译器正在使用 AFL</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1"</span><span class="token punctuation">;</span>	<span class="token comment">//指示当前的编译模式是为模糊测试准备的，而不是用于生产环境</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_BUILTIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//存在环境变量 AFL_NO_BUILTIN</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcmp"</span><span class="token punctuation">;</span>	<span class="token comment">//禁用编译器对 strcmp 函数的内置优化,确保代码使用标准库中定义的 strcmp 函数</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncmp"</span><span class="token punctuation">;</span>	
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasecmp"</span><span class="token punctuation">;</span>	
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncasecmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-memcmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strstr"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasestr"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>	<span class="token comment">//参数列表末尾加上 NULL 表示结束</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="afl-as"><a href="#afl-as" class="headerlink" title="afl-as"></a>afl-as</h2><h3 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h3><p>大致和 afl-gcc 的 main 差不多</p>
<ul>
<li>获取环境变量 AFL_INST_RATIO 赋值到 inst_ratio_str</li>
<li>输出 afl-as 版本信息</li>
<li>判断没有参数就退出</li>
<li>获取时间根据时间和进程号生成随机数种子</li>
<li>调用 edit_params 解析参数</li>
<li>inst_ratio_str 不在 0-100 则退出</li>
<li>获取环境变量 AS_LOOP_ENV_VAR 为 1 则退出，为 0 则设置为 1</li>
<li>如果存在环境变量 AFL_USE_ASAN &#x2F; AFL_USE_MSAN 则降低 inst_ratio_str 以降低 AFL 的覆盖率检测频率减少对程序性能的影响</li>
<li>调用 add_instrumentation 函数对程序进行插桩</li>
<li>fork 新进程使用 execvp 执行 afl_as &#x2F; as</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  u8<span class="token operator">*</span> inst_ratio_str <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_INST_RATIO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//AFL 的指令覆盖率,用于指定 AFL 在代码中插入覆盖率检测代码的比例</span>
  <span class="token comment">//值的范围是 0 到 100，表示百分比</span>
  <span class="token comment">//如果值为 100，表示 AFL 会在所有可能的指令位置插入覆盖率检测代码，这会提供最全面的覆盖率，但可能会显著降低程序的运行速度</span>
  <span class="token comment">//如果值为 0，则表示不插入任何覆盖率检测代码，这通常用于非模糊测试场景</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  clang_mode <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-as "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rand_seed <span class="token operator">=</span> tv<span class="token punctuation">.</span>tv_sec <span class="token operator">^</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">^</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">srandom</span><span class="token punctuation">(</span>rand_seed<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取时间生成随机数种子</span>

  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//处理参数</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">,</span> <span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>inst_ratio<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> inst_ratio <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad value of AFL_INST_RATIO (must be between 0 and 100)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>	<span class="token comment">//指令覆盖率不在 0-100 之间则报错</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//防止在调用 as（汇编器）时出现无限循环调用as</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Endless loop when calling 'as' (remove '.' from your PATH)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token function">setenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置为1表示已经被调用过</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    sanitizer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    inst_ratio <span class="token operator">/=</span> <span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">//降低 AFL 的覆盖率检测频率，以减少对程序性能的影响，同时让内存检测工具能够更有效地运行</span>
  <span class="token punctuation">&#125;</span>
    <span class="token comment">//AFL_USE_ASAN：启用 AddressSanitizer（ASan），一种内存错误检测工具,以检测堆栈和堆缓冲区上溢/下溢 释放之后的堆使用情况</span>
    <span class="token comment">//AFL_USE_MSAN：启用 MemorySanitizer（MSan），一种未初始化内存检测工具</span>
    <span class="token comment">//源码注释：使用 ASAN 进行编译时，我们没有特别优雅的方法来跳过特定于 ASAN 的分支。但我们可以通过概率来弥补这一点</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>just_version<span class="token punctuation">)</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//程序不是只需要输出版本信息的时候，对程序进行插桩</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">execvp</span><span class="token punctuation">(</span>as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>as_params<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//fork新建进程之后执行参数列表</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_KEEP_ASSEMBLY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">unlink</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="edit-params-1"><a href="#edit-params-1" class="headerlink" title="edit_params"></a>edit_params</h3><p>处理参数、获取环境变量</p>
<ul>
<li>获取环境变量 AFL_AS 给 afl_as</li>
<li>依次获取环境变量TMPDIR &#x2F; 环境变量 TEMP &#x2F; 环境变量 TMP &#x2F; &#x2F;tmp，最先获取到的赋值给 tmp_dir</li>
<li>给 as_params 数组开辟空间，如果 afl_as 存在则将第一个参数设置为 afl_as，否则设置为 as</li>
<li>循环遍历参数函数参数，存在 –64 就设置 use_64bit 为 1，存在 –32 就设置 use_64bit 为 0，并且将参数添加到 as_params</li>
<li>从 as_params 中获取 input_file<ul>
<li>如果是 –version 则表示只需要输出版本信息，just_version 设置为 1</li>
<li>如果是 - 开头但不是 –version 则报错</li>
<li>如果只有 - 则输入文件为空</li>
</ul>
</li>
<li>如果 input_file 不以 tmp_dir &#x2F; &#x2F;var&#x2F;tmp&#x2F; &#x2F; &#x2F;tmp&#x2F; 开头，则设置 pass_thru 为 1，表示输入文件不是一个标准的编译过程中的临时文件</li>
<li>生成修改后的文件路径：tmp_dir&#x2F;.afl-getpid()-time(NULL).s</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 <span class="token operator">*</span>tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMPDIR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>afl_as <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_AS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从环境变量中获取临时目录和 afl_as 的路径</span>
  u32 i<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  <span class="token comment">//源码注释翻译：虽然没有记录，但当未设置 TMPDIR 时，GCC 也会使用 TEMP 和 TMP。我们需要检查这些非标准变量，以便稍后正确处理 pass_thru 逻辑。</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TEMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token string">"/tmp"</span><span class="token punctuation">;</span>
  <span class="token comment">//设置 tmp_dir 为 环境变量 TMPDIE / TEMP / 环境变量TMP / /tmp（按优先级顺序获取，不存在则获取下一个）</span>

  as_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为 as 参数开辟空间</span>

  as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> afl_as <span class="token operator">?</span> afl_as <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"as"</span><span class="token punctuation">;</span>	<span class="token comment">//存在 afl_as 就将第一个参数设置为 afl_as,不存在就设置为 as</span>

  as_params<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//将数组最后一位设置为 0 表示结束</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//循环遍历参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//参数存在 --64 就设置 use_64bit 为 1</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//参数存在 --32 就设置 use_64bit 为 0</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

    as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//将参数赋值到参数列表数组中</span>
  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  input_file <span class="token operator">=</span> argv<span class="token punctuation">[</span>argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//获取 input_file</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_file <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"-version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//input_file = --version表示只需要显示版本信息</span>
      just_version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      modified_file <span class="token operator">=</span> input_file<span class="token punctuation">;</span>
      <span class="token keyword">goto</span> wrap_things_up<span class="token punctuation">;</span>	<span class="token comment">//设置 just_version 为 1，输出文件为输入文件</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Incorrect use (not called through afl-gcc?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//输入文件是 - 开头但不是 --version 则输出报错信息</span>
      <span class="token keyword">else</span> input_file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>	<span class="token comment">//输入文件是 - 则输入文件为空</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>tmp_dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/var/tmp/"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/tmp/"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> pass_thru <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果 input_file 不以 tmp_dir / /var/tmp/ / /tmp/ 开头，则设置 pass_thru 为 1,用于判断输入文件是否是一个标准的编译过程中的临时文件，还是一个用户手动指定的 .s 文件（汇编文件）。如果是非标准路径，pass_thru 被设置为 1，表示需要特殊处理。</span>
  <span class="token punctuation">&#125;</span>

  modified_file <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.afl-%u-%u.s"</span><span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//生成修改后的文件路径：tmp_dir/.afl-getpid()-time(NULL).s</span>

wrap_things_up<span class="token operator">:</span>
  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> modified_file<span class="token punctuation">;</span>
  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>	<span class="token comment">//将 modified_file 添加到参数列表 as_params 中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h3><ul>
<li>打开输入函数和输出函数</li>
<li>逐行读取汇编代码，根据条件插入插桩程序<ul>
<li>如果当前行满足插桩条件则进行插桩并且增加插桩计数器</li>
<li>存入当前行汇编代码</li>
<li>在 text 段<ul>
<li>处理位数（32 &#x2F; 64），检测是 intel &#x2F; att 语法模式，检测是 APP &#x2F; NO_APP，根据检测结果设置 </li>
<li>skip_intel 和 skip_app 都是 0 且是条件跳转分支（存在：且开头是.?n） &#x2F; 函数入口标签(存在：)时设置 instrument_next 为 1，表示在下一条指令插入插桩代码</li>
</ul>
</li>
</ul>
</li>
<li>根据程序位数插入 main_payload_64 &#x2F; main_payload_32</li>
</ul>
<p>一个汇编程序的例子：</p>
<p>test.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> a <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//gcc -S test.c -o test.s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>test.s</p>
<blockquote>
<p>LC：gcc 非分支标签	L0：gcc 分支标签</p>
<p>.Ltmp0：clang非分支标签	.LBB0_0：clang 分支标签</p>
<p>jnz foo：条件分支	jmp foo：非条件跳转</p>
</blockquote>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">	.file	&quot;test.c&quot;
	.text
	.section	.rodata
.LC0:
	.string	&quot;Y&quot;
.LC1:
	.string	&quot;N&quot;
	.text
	.globl	test
	.type	test, @function
test:
.LFB0:
	.cfi_startproc
	endbr64
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	subq	$16, %rsp
	movl	$1, -4(%rbp)
	cmpl	$0, -4(%rbp)
	jg	.L2
	leaq	.LC0(%rip), %rdi
	call	puts@PLT
	jmp	.L1
.L2:
	leaq	.LC1(%rip), %rdi
	call	puts@PLT
	nop
.L1:
	leave
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE0:
	.size	test, .-test
	.globl	main
	.type	main, @function
main:
.LFB1:
	.cfi_startproc
	endbr64
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	movl	$0, %eax
	call	test
	movl	$0, %eax
	popq	%rbp
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE1:
	.size	main, .-main
	.ident	&quot;GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.2) 9.4.0&quot;
	.section	.note.GNU-stack,&quot;&quot;,@progbits
	.section	.note.gnu.property,&quot;a&quot;
	.align 8
	.long	 1f - 0f
	.long	 4f - 1f
	.long	 5
0:
	.string	 &quot;GNU&quot;
1:
	.align 8
	.long	 0xc0000002
	.long	 3f - 2f
2:
	.long	 0x3
3:
	.align 8
4:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>^</code> 是一个特殊字符，表示行的开头，用于匹配字符串或行的起始位置</p>
<p><code>\t</code>开头且第二个是字母的是 指令行</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    inf <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to read '%s'"</span><span class="token punctuation">,</span> input_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> inf <span class="token operator">=</span> <span class="token constant">stdin</span><span class="token punctuation">;</span>	<span class="token comment">//打开 input_file,文件为空则 fd 为 stdin 标准输入</span>

  outfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_EXCL <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开 modified_file</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>outfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to write to '%s'"</span><span class="token punctuation">,</span> modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开失败报错</span>

  outf <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>outfd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//得到 outf 这个 FILE* 指针，fdopen 函数将参数 fd 的文件描述符转化为文件指针</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取失败则报错</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> MAX_LINE<span class="token punctuation">,</span> inf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//逐行从输入文件中读取</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pass_thru <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_intel <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_app <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_csect <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span>
        instrument_next <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isalpha</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果当前是指令行且满足插桩条件</span>

      <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//插入插桩代码</span>

      instrument_next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//instrument_next 标志清零，表示当前行已经插入插桩代码</span>
      ins_lines<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//插桩计数器增加</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">fputs</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//插入插桩代码后将当前行插入</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pass_thru<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//当前行以 \t.开头</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"p2align "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> skip_next_label <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"text\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t.text"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t__TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section __TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        instr_ok <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span> 
      <span class="token punctuation">&#125;</span>	<span class="token comment">//在 \t.text\n, \t.section\t.text, \t.section\t__TEXT,__text, \t.section __TEXT, __text 中则设置 instr_ok 为 1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"bss\n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"data\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        instr_ok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>	<span class="token comment">//在 \t.section\t, \t.section, \t.bss\n, \t.data\n 中则设置 instr_ok 为 0</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> use_64bit<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> <span class="token operator">!</span>use_64bit<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>	<span class="token comment">//根据程序是 32 位还是 64 位设置 skip_csect</span>
      
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".intel_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//检测到 .intel_syntax，表示进入 Intel 语法模式，跳过插桩</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".att_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//检测到 .att_syntax，表示回到 AT&amp;T 语法模式，恢复插桩</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#NO_APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>	<span class="token comment">//检测到 #APP 则跳过插桩，检测到 #NO_APP 则恢复插桩</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_intel <span class="token operator">||</span> skip_app <span class="token operator">||</span> skip_csect <span class="token operator">||</span> <span class="token operator">!</span>instr_ok <span class="token operator">||</span>
        line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//存在需要跳过的条件则跳过该行</span>

    <span class="token comment">//条件分支指令（jnz 等）。我们将检测附加到分支之后（用于检测未采用的路径）和分支目标标签（稍后处理）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'j'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'m'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//条件跳转指令且满足插桩概率则插桩，非条件跳转例如 jmp 不会插桩</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ins_lines<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">/* Everybody else: .L&lt;whatever>: */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//检测分支目标标签，例如 .L0:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>
        <span class="token comment">/* .L0: or LBB0_0: style jump destination */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token comment">/* Apple: .L&lt;num> / .LBB&lt;num> */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>clang_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"LBB"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//.?n: 或 clang 模式下 .LBB 且满足插桩概率</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip_next_label<span class="token punctuation">)</span> instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果未设置 skip_next_label ，标签符合插桩条件，则设置 instrument_next = 1，表示在下一条指令插入插桩代码</span>
          <span class="token keyword">else</span> skip_next_label <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//否则设置 skip_next_label 为 0</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* Function label (always instrumented, deferred mode). */</span>
        instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//有冒号，不是分支目标标签，则是函数入口点标签，在下一条进行插桩</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ins_lines<span class="token punctuation">)</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>use_64bit <span class="token operator">?</span> main_payload_64 <span class="token operator">:</span> main_payload_32<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//根据程序位数插入 main_payload_64 / main_payload_32</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token function">fclose</span><span class="token punctuation">(</span>inf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>outf<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ins_lines<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"No instrumentation targets found%s."</span><span class="token punctuation">,</span> pass_thru <span class="token operator">?</span> <span class="token string">" (pass-thru mode)"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Instrumented %u locations (%s-bit, %s mode, ratio %u%%)."</span><span class="token punctuation">,</span>
             ins_lines<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> <span class="token string">"64"</span> <span class="token operator">:</span> <span class="token string">"32"</span><span class="token punctuation">,</span>
             <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"hardened"</span> <span class="token operator">:</span> 
             <span class="token punctuation">(</span>sanitizer <span class="token operator">?</span> <span class="token string">"ASAN/MSAN"</span> <span class="token operator">:</span> <span class="token string">"non-hardened"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             inst_ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="插桩汇编代码"><a href="#插桩汇编代码" class="headerlink" title="插桩汇编代码"></a>插桩汇编代码</h3><p>trampoline_fmt_32 和 main_payload_32 见源码</p>
<p>trampoline_fmt_64：</p>
<ul>
<li>保存寄存器的值</li>
<li>将当前的代码位置加载到 rcx 寄存器</li>
<li>调用 __afl_maybe_log</li>
<li>恢复寄存器的值</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">static const u8* trampoline_fmt_64 &#x3D;

  &quot;\n&quot;
  &quot;&#x2F;* --- AFL TRAMPOLINE (64-BIT) --- *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;.align 4\n&quot;
  &quot;\n&quot;
  &quot;leaq -(128+24)(%%rsp), %%rsp\n&quot;
  &quot;movq %%rdx,  0(%%rsp)\n&quot;
  &quot;movq %%rcx,  8(%%rsp)\n&quot;
  &quot;movq %%rax, 16(%%rsp)\n&quot;	;保存寄存器的值
  &quot;movq $0x%08x, %%rcx\n&quot;	;将当前的代码位置加载到 rcx 寄存器，%08x 是一个格式化占位符，表示一个 8 位的十六进制数
  &quot;call __afl_maybe_log\n&quot;	;调用 __afl_maybe_log 将当前的执行路径信息记录到共享内存中
  &quot;movq 16(%%rsp), %%rax\n&quot;
  &quot;movq  8(%%rsp), %%rcx\n&quot;
  &quot;movq  0(%%rsp), %%rdx\n&quot;	
  &quot;leaq (128+24)(%%rsp), %%rsp\n&quot;	;恢复寄存器的值
  &quot;\n&quot;
  &quot;&#x2F;* --- END --- *&#x2F;\n&quot;
  &quot;\n&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>main_payload_64：</p>
<ul>
<li>入口点：__afl_maybe_log<ul>
<li>获取共享内存指针，未初始化则跳转到 __afl_setup 进行初始化</li>
<li>跳转到 __afl_store</li>
</ul>
</li>
<li>初始化共享内存：__afl_setup<ul>
<li>获取 __afl_setup_failure 判断是否已经进行过初始化并且失败，已经失败过就跳转到 __afl_return 进行返回避免重复初始化</li>
<li>如果全局共享内存指针已设置，直接跳转到 __afl_store</li>
<li>如果未设置，跳转到 __afl_setup_first 进行第一次初始化，调用后从 rdx 寄存器获取 __afl_setup_abort</li>
</ul>
</li>
<li>第一次初始化共享内存：__afl_setup_first<ul>
<li>将寄存器的值保存到栈上</li>
<li>获取环境变量中的共享内存 ID 并且转换成整数</li>
<li>使用 shmat 将共享内存映射到当前进程，如果失败跳转到 __afl_setup_abort</li>
<li>将全局共享内存地址存储到 __afl_global_area_ptr，将共享内存地址存储到  __afl_global_area_ptr 地址中，并且存放到 rdx 中</li>
</ul>
</li>
<li>初始化失败处理：__afl_setup_abort<ul>
<li>增加 __afl_setup_failure 的值</li>
<li>从栈上恢复所有寄存器</li>
<li>跳转到 __afl_return：返回主逻辑</li>
</ul>
</li>
<li>处理异常情况：__afl_die 退出程序</li>
<li>恢复标志寄存器状态并返回：__afl_return</li>
<li>Fork Server 模式：__afl_forkserver，通过 Fork Server 模式避免频繁调用 <code>execve</code>，提升 fuzz 效率<ul>
<li>通知父进程：向父进程发送一个信号，表示当前进程已准备好。</li>
<li>等待父进程指令：通过管道从父进程读取指令。如果读取失败，跳转到 <code>__afl_die</code>。</li>
<li>创建子进程：<ul>
<li>使用 <code>fork</code> 创建子进程。如果失败，跳转到 <code>__afl_die</code>。</li>
<li>子进程跳转到 <code>__afl_fork_resume</code>，父进程继续执行。</li>
</ul>
</li>
<li><strong>父进程逻辑</strong>：<ul>
<li>父进程将子进程的 PID 写入管道。</li>
<li>父进程调用 <code>waitpid</code> 等待子进程执行完毕。</li>
<li>父进程将子进程的退出状态写入管道，然后回到 <code>__afl_fork_wait_loop</code>。</li>
</ul>
</li>
</ul>
</li>
<li>子进程恢复执行：__afl_fork_resume</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">static const u8* main_payload_64 &#x3D; 

  &quot;\n&quot;
  &quot;&#x2F;* --- AFL MAIN PAYLOAD (64-BIT) --- *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;.text\n&quot;
  &quot;.att_syntax\n&quot;
  &quot;.code64\n&quot;
  &quot;.align 8\n&quot;
  &quot;\n&quot;
  &quot;__afl_maybe_log:\n&quot;
  &quot;\n&quot;
#if defined(__OpenBSD__)  || (defined(__FreeBSD__) &amp;&amp; (__FreeBSD__ &lt; 9))
  &quot;  .byte 0x9f &#x2F;* lahf *&#x2F;\n&quot;
#else
  &quot;  lahf\n&quot;
#endif &#x2F;* ^__OpenBSD__, etc *&#x2F;
  &quot;  seto  %al\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Check if SHM region is already mapped. *&#x2F;\n&quot;	;检查共享内存区域是否已经映射
  &quot;\n&quot;
  &quot;  movq  __afl_area_ptr(%rip), %rdx\n&quot;	;获取共享内存区域 __afl_area_ptr 地址
  &quot;  testq %rdx, %rdx\n&quot;
  &quot;  je    __afl_setup\n&quot;	;如果__afl_area_ptr 为零即尚未映射，则调用 __afl_setup 函数进行初始化
  &quot;\n&quot;
  &quot;__afl_store:\n&quot;	;路径记录逻辑
  &quot;\n&quot;
  &quot;  &#x2F;* Calculate and store hit for the code location specified in rcx. *&#x2F;\n&quot;	;计算并存储 rcx 中指定的代码位置的命中率
  &quot;\n&quot;
#ifndef COVERAGE_ONLY
  &quot;  xorq __afl_prev_loc(%rip), %rcx\n&quot;	;rcx &#x3D; rcx ^ __afl_prev_loc
  &quot;  xorq %rcx, __afl_prev_loc(%rip)\n&quot;	;__afl_prev_loc &#x3D; 原 rcx 值
  &quot;  shrq $1, __afl_prev_loc(%rip)\n&quot;	;将上一个代码位置右移一位（优化存储）
#endif &#x2F;* ^!COVERAGE_ONLY *&#x2F;
  &quot;\n&quot;
#ifdef SKIP_COUNTS	;定义了是否仅记录命中次数（orb）还是累加命中次数（incb）
  &quot;  orb  $1, (%rdx, %rcx, 1)\n&quot;	;将计算结果存储到共享内存中，rdx &#x3D; __afl_area_ptr
#else
  &quot;  incb (%rdx, %rcx, 1)\n&quot;	;将计算结果存储到共享内存中
#endif &#x2F;* ^SKIP_COUNTS *&#x2F;
  &quot;\n&quot;
  &quot;__afl_return:\n&quot;	;恢复标志寄存器的状态并返回
  &quot;\n&quot;
  &quot;  addb $127, %al\n&quot;	;调整标志寄存器的状态
#if defined(__OpenBSD__)  || (defined(__FreeBSD__) &amp;&amp; (__FreeBSD__ &lt; 9))
  &quot;  .byte 0x9e &#x2F;* sahf *&#x2F;\n&quot;	;将 ah 寄存器的内容加载到标志寄存器中（恢复标志寄存器的状态）
#else
  &quot;  sahf\n&quot;	;将 ah 寄存器的内容加载到标志寄存器中（恢复标志寄存器的状态）
#endif &#x2F;* ^__OpenBSD__, etc *&#x2F;
  &quot;  ret\n&quot;	;返回
  &quot;\n&quot;
  &quot;.align 8\n&quot;
  &quot;\n&quot;
  &quot;__afl_setup:\n&quot;	;初始化共享内存
  &quot;\n&quot;
  &quot;  &#x2F;* Do not retry setup if we had previous failures. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  cmpb $0, __afl_setup_failure(%rip)\n&quot;
  &quot;  jne __afl_return\n&quot;	;获取 __afl_setup_failure，如果上次 setup 失败则不再进行 setup，直接跳转到 __afl_return 返回
  &quot;\n&quot;
  &quot;  &#x2F;* Check out if we have a global pointer on file. *&#x2F;\n&quot;
  &quot;\n&quot;
#ifndef __APPLE__
  ...
#else
  &quot;  movq  __afl_global_area_ptr(%rip), %rdx\n&quot;	;加载全局共享内存指针
#endif &#x2F;* !^__APPLE__ *&#x2F;
  &quot;  testq %rdx, %rdx\n&quot;
  &quot;  je    __afl_setup_first\n&quot;·;没有映射过全局共享内存指针就调用 __afl_setup_first 初始化
  &quot;\n&quot;
  &quot;  movq %rdx, __afl_area_ptr(%rip)\n&quot;	;将 __afl_setup_first 得到的共享内存区域传递给 __afl_area_ptr
  &quot;  jmp  __afl_store\n&quot; 	;跳转回 __afl_store
  &quot;\n&quot;
  &quot;__afl_setup_first:\n&quot;	;第一次初始化共享内存
  &quot;\n&quot;
  &quot;  &#x2F;* Save everything that is not yet saved and that may be touched by getenv() and several other libcalls we&#39;ll be relying on. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  leaq -352(%rsp), %rsp\n&quot;
  &quot;\n&quot;
  &quot;  movq %rax,   0(%rsp)\n&quot;
  &quot;  movq %rcx,   8(%rsp)\n&quot;
  &quot;  movq %rdi,  16(%rsp)\n&quot;
  &quot;  movq %rsi,  32(%rsp)\n&quot;
  &quot;  movq %r8,   40(%rsp)\n&quot;
  &quot;  movq %r9,   48(%rsp)\n&quot;
  &quot;  movq %r10,  56(%rsp)\n&quot;
  &quot;  movq %r11,  64(%rsp)\n&quot;
  &quot;\n&quot;
  &quot;  movq %xmm0,  96(%rsp)\n&quot;
  &quot;  movq %xmm1,  112(%rsp)\n&quot;
  &quot;  movq %xmm2,  128(%rsp)\n&quot;
  &quot;  movq %xmm3,  144(%rsp)\n&quot;
  &quot;  movq %xmm4,  160(%rsp)\n&quot;
  &quot;  movq %xmm5,  176(%rsp)\n&quot;
  &quot;  movq %xmm6,  192(%rsp)\n&quot;
  &quot;  movq %xmm7,  208(%rsp)\n&quot;
  &quot;  movq %xmm8,  224(%rsp)\n&quot;
  &quot;  movq %xmm9,  240(%rsp)\n&quot;
  &quot;  movq %xmm10, 256(%rsp)\n&quot;
  &quot;  movq %xmm11, 272(%rsp)\n&quot;
  &quot;  movq %xmm12, 288(%rsp)\n&quot;
  &quot;  movq %xmm13, 304(%rsp)\n&quot;
  &quot;  movq %xmm14, 320(%rsp)\n&quot;
  &quot;  movq %xmm15, 336(%rsp)\n&quot;	;保存寄存器到栈上
  &quot;\n&quot;
  &quot;  &#x2F;* Map SHM, jumping to __afl_setup_abort if something goes wrong. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* The 64-bit ABI requires 16-byte stack alignment. We&#39;ll keep the\n&quot;
  &quot;     original stack ptr in the callee-saved r12. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  pushq %r12\n&quot;
  &quot;  movq  %rsp, %r12\n&quot;
  &quot;  subq  $16, %rsp\n&quot;
  &quot;  andq  $0xfffffffffffffff0, %rsp\n&quot;
  &quot;\n&quot;
  &quot;  leaq .AFL_SHM_ENV(%rip), %rdi\n&quot;
  CALL_L64(&quot;getenv&quot;)	;获取共享内存的 ID
  &quot;\n&quot;
  &quot;  testq %rax, %rax\n&quot;
  &quot;  je    __afl_setup_abort\n&quot;
  &quot;\n&quot;
  &quot;  movq  %rax, %rdi\n&quot;
  CALL_L64(&quot;atoi&quot;)	;ID转换成整数
  &quot;\n&quot;
  &quot;  xorq %rdx, %rdx   &#x2F;* shmat flags    *&#x2F;\n&quot;
  &quot;  xorq %rsi, %rsi   &#x2F;* requested addr *&#x2F;\n&quot;
  &quot;  movq %rax, %rdi   &#x2F;* SHM ID         *&#x2F;\n&quot;
  CALL_L64(&quot;shmat&quot;)	;将共享内存映射到当前进程的地址空间
  &quot;\n&quot;
  &quot;  cmpq $-1, %rax\n&quot;
  &quot;  je   __afl_setup_abort\n&quot;	;如果失败，跳转到 __afl_setup_abort
  &quot;\n&quot;
  &quot;  &#x2F;* Store the address of the SHM region. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq %rax, %rdx\n&quot;
  &quot;  movq %rax, __afl_area_ptr(%rip)\n&quot;	;将共享内存的地址存储到 __afl_area_ptr 中
  &quot;\n&quot;
#ifdef __APPLE__
  ...
#else
  &quot;  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx\n&quot;	;全局共享内存指针赋值给 rdx
  &quot;  movq %rax, (%rdx)\n&quot;	;共享内存的地址存放到全局共享内存指针中
#endif &#x2F;* ^__APPLE__ *&#x2F;
  &quot;  movq %rax, %rdx\n&quot;	;共享内存的地址给 rdx
  &quot;\n&quot;
  &quot;__afl_forkserver:\n&quot;	;Fork Server 模式，避免重复调用 execve
  &quot;\n&quot;
  &quot;  &#x2F;* Enter the fork server mode to avoid the overhead of execve() calls. We\n&quot;
  &quot;     push rdx (area ptr) twice to keep stack alignment neat. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  pushq %rdx\n&quot;
  &quot;  pushq %rdx\n&quot;	;保持栈平衡
  &quot;\n&quot;
  &quot;  &#x2F;* Phone home and tell the parent that we&#39;re OK. (Note that signals with\n&quot;
  &quot;     no SA_RESTART will mess it up). If this fails, assume that the fd is\n&quot;
  &quot;     closed because we were execve()d from an instrumented binary, or because\n&quot;
  &quot;     the parent doesn&#39;t want to use the fork server. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi       &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;write&quot;)
  &quot;\n&quot;
  &quot;  cmpq $4, %rax\n&quot;
  &quot;  jne  __afl_fork_resume\n&quot;
  &quot;\n&quot;
  &quot;__afl_fork_wait_loop:\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Wait for parent by reading from the pipe. Abort if read fails. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY(FORKSRV_FD) &quot;, %rdi             &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;read&quot;)
  &quot;  cmpq $4, %rax\n&quot;
  &quot;  jne  __afl_die\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Once woken up, create a clone of our process. This is an excellent use\n&quot;
  &quot;     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly\n&quot;
  &quot;     caches getpid() results and offers no way to update the value, breaking\n&quot;
  &quot;     abort(), raise(), and a bunch of other things :-( *&#x2F;\n&quot;
  &quot;\n&quot;
  CALL_L64(&quot;fork&quot;)	;父进程通过管道与子进程通信
  &quot;  cmpq $0, %rax\n&quot;
  &quot;  jl   __afl_die\n&quot;
  &quot;  je   __afl_fork_resume\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* In parent process: write PID to pipe, then wait for child. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movl %eax, __afl_fork_pid(%rip)\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx                   &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_fork_pid(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi             &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;write&quot;)
  &quot;\n&quot;
  &quot;  movq $0, %rdx                   &#x2F;* no flags  *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi     &#x2F;* status    *&#x2F;\n&quot;
  &quot;  movq __afl_fork_pid(%rip), %rdi &#x2F;* PID       *&#x2F;\n&quot;
  CALL_L64(&quot;waitpid&quot;)
  &quot;  cmpq $0, %rax\n&quot;
  &quot;  jle  __afl_die\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Relay wait status to pipe, then loop back. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi         &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;write&quot;)	;父进程等待子进程执行完毕后，将状态信息传递回子进程
  &quot;\n&quot;
  &quot;  jmp  __afl_fork_wait_loop\n&quot;	;子进程关闭管道文件描述符后继续执行
  &quot;\n&quot;
  &quot;__afl_fork_resume:\n&quot;	;子进程恢复执行
  &quot;\n&quot;
  &quot;  &#x2F;* In child process: close fds, resume execution. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $&quot; STRINGIFY(FORKSRV_FD) &quot;, %rdi\n&quot;
  CALL_L64(&quot;close&quot;)
  &quot;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi\n&quot;
  CALL_L64(&quot;close&quot;)	;关闭管道文件描述符
  &quot;\n&quot;
  &quot;  popq %rdx\n&quot;
  &quot;  popq %rdx\n&quot;
  &quot;\n&quot;
  &quot;  movq %r12, %rsp\n&quot;
  &quot;  popq %r12\n&quot;
  &quot;\n&quot;
  &quot;  movq  0(%rsp), %rax\n&quot;
  &quot;  movq  8(%rsp), %rcx\n&quot;
  &quot;  movq 16(%rsp), %rdi\n&quot;
  &quot;  movq 32(%rsp), %rsi\n&quot;
  &quot;  movq 40(%rsp), %r8\n&quot;
  &quot;  movq 48(%rsp), %r9\n&quot;
  &quot;  movq 56(%rsp), %r10\n&quot;
  &quot;  movq 64(%rsp), %r11\n&quot;
  &quot;\n&quot;
  &quot;  movq  96(%rsp), %xmm0\n&quot;
  &quot;  movq 112(%rsp), %xmm1\n&quot;
  &quot;  movq 128(%rsp), %xmm2\n&quot;
  &quot;  movq 144(%rsp), %xmm3\n&quot;
  &quot;  movq 160(%rsp), %xmm4\n&quot;
  &quot;  movq 176(%rsp), %xmm5\n&quot;
  &quot;  movq 192(%rsp), %xmm6\n&quot;
  &quot;  movq 208(%rsp), %xmm7\n&quot;
  &quot;  movq 224(%rsp), %xmm8\n&quot;
  &quot;  movq 240(%rsp), %xmm9\n&quot;
  &quot;  movq 256(%rsp), %xmm10\n&quot;
  &quot;  movq 272(%rsp), %xmm11\n&quot;
  &quot;  movq 288(%rsp), %xmm12\n&quot;
  &quot;  movq 304(%rsp), %xmm13\n&quot;
  &quot;  movq 320(%rsp), %xmm14\n&quot;
  &quot;  movq 336(%rsp), %xmm15\n&quot;
  &quot;\n&quot;
  &quot;  leaq 352(%rsp), %rsp\n&quot;	;恢复寄存器的值
  &quot;\n&quot;
  &quot;  jmp  __afl_store\n&quot;	;跳转回路径记录逻辑
  &quot;\n&quot;
  &quot;__afl_die:\n&quot;
  &quot;\n&quot;
  &quot;  xorq %rax, %rax\n&quot;
  CALL_L64(&quot;_exit&quot;)	;退出程序
  &quot;\n&quot;
  &quot;__afl_setup_abort:\n&quot;	;初始化失败处理
  &quot;\n&quot;
  &quot;  &#x2F;* Record setup failure so that we don&#39;t keep calling\n&quot;
  &quot;     shmget() &#x2F; shmat() over and over again. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  incb __afl_setup_failure(%rip)\n&quot;	;增加 __afl_setup_failure 的值，避免重复初始化
  &quot;\n&quot;
  &quot;  movq %r12, %rsp\n&quot;
  &quot;  popq %r12\n&quot;
  &quot;\n&quot;
  &quot;  movq  0(%rsp), %rax\n&quot;
  &quot;  movq  8(%rsp), %rcx\n&quot;
  &quot;  movq 16(%rsp), %rdi\n&quot;
  &quot;  movq 32(%rsp), %rsi\n&quot;
  &quot;  movq 40(%rsp), %r8\n&quot;
  &quot;  movq 48(%rsp), %r9\n&quot;
  &quot;  movq 56(%rsp), %r10\n&quot;
  &quot;  movq 64(%rsp), %r11\n&quot;
  &quot;\n&quot;
  &quot;  movq  96(%rsp), %xmm0\n&quot;
  &quot;  movq 112(%rsp), %xmm1\n&quot;
  &quot;  movq 128(%rsp), %xmm2\n&quot;
  &quot;  movq 144(%rsp), %xmm3\n&quot;
  &quot;  movq 160(%rsp), %xmm4\n&quot;
  &quot;  movq 176(%rsp), %xmm5\n&quot;
  &quot;  movq 192(%rsp), %xmm6\n&quot;
  &quot;  movq 208(%rsp), %xmm7\n&quot;
  &quot;  movq 224(%rsp), %xmm8\n&quot;
  &quot;  movq 240(%rsp), %xmm9\n&quot;
  &quot;  movq 256(%rsp), %xmm10\n&quot;
  &quot;  movq 272(%rsp), %xmm11\n&quot;
  &quot;  movq 288(%rsp), %xmm12\n&quot;
  &quot;  movq 304(%rsp), %xmm13\n&quot;
  &quot;  movq 320(%rsp), %xmm14\n&quot;
  &quot;  movq 336(%rsp), %xmm15\n&quot;
  &quot;\n&quot;
  &quot;  leaq 352(%rsp), %rsp\n&quot;	;恢复寄存器
  &quot;\n&quot;
  &quot;  jmp __afl_return\n&quot;	;跳转回返回逻辑
  &quot;\n&quot;
  &quot;.AFL_VARS:\n&quot;
  &quot;\n&quot;

;以下为其他变量定义，定义共享内存指针、Fork Server PID、临时变量和全局共享内存指针
#ifdef __APPLE__
...
#ifndef COVERAGE_ONLY
  &quot;  .comm   __afl_prev_loc, 8\n&quot;
#endif &#x2F;* !COVERAGE_ONLY *&#x2F;
  &quot;  .comm   __afl_fork_pid, 4\n&quot;
  &quot;  .comm   __afl_temp, 4\n&quot;
  &quot;  .comm   __afl_setup_failure, 1\n&quot;

#else

  &quot;  .lcomm   __afl_area_ptr, 8\n&quot;
#ifndef COVERAGE_ONLY
  &quot;  .lcomm   __afl_prev_loc, 8\n&quot;
#endif &#x2F;* !COVERAGE_ONLY *&#x2F;
  &quot;  .lcomm   __afl_fork_pid, 4\n&quot;
  &quot;  .lcomm   __afl_temp, 4\n&quot;
  &quot;  .lcomm   __afl_setup_failure, 1\n&quot;

#endif &#x2F;* ^__APPLE__ *&#x2F;

  &quot;  .comm    __afl_global_area_ptr, 8, 8\n&quot;
  &quot;\n&quot;
  &quot;.AFL_SHM_ENV:\n&quot;
  &quot;  .asciz \&quot;&quot; SHM_ENV_VAR &quot;\&quot;\n&quot;	;环境变量定义
  &quot;\n&quot;
  &quot;&#x2F;* --- END --- *&#x2F;\n&quot;
  &quot;\n&quot;;

#endif &#x2F;* !_HAVE_AFL_AS_H *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/fuzz/">
                                    <span class="chip bg-color">fuzz</span>
                                </a>
                            
                                <a href="/tags/AFL/">
                                    <span class="chip bg-color">AFL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2025/02/24/afl-yuan-ma-fen-xi-yi/afl-yuan-ma-fen-xi-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="AFL源码分析（一）">
                        
                        <span class="card-title">AFL源码分析（一）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            AFL源码分析
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-02-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/fuzz/" class="post-category">
                                    fuzz
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/fuzz/">
                        <span class="chip bg-color">fuzz</span>
                    </a>
                    
                    <a href="/tags/AFL/">
                        <span class="chip bg-color">AFL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/02/10/yi-gou-pwn-yun-xing-yu-diao-shi/yi-gou-pwn-yun-xing-yu-diao-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="异构pwn运行与调试">
                        
                        <span class="card-title">异构pwn运行与调试</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            异构pwn运行于调试
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-02-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/pwn/" class="post-category">
                                    pwn
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/pwn/">
                        <span class="chip bg-color">pwn</span>
                    </a>
                    
                    <a href="/tags/%E5%BC%82%E6%9E%84/">
                        <span class="chip bg-color">异构</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">starrysky</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">181.9k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/starrysky1004" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:starrysky20041005@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2726736810" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2726736810" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>









    <a href="https://space.bilibili.com/85923475" class="tooltipped" target="_blank" data-tooltip="关注我的bilibili" data-position="top" data-delay="50">
        <i class="fas fa-video"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":260,"height":300},"mobile":{"show":true},"log":false});</script></body>

</html>
