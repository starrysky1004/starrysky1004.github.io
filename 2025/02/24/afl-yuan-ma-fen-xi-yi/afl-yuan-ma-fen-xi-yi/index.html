<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="AFL源码分析（一）, starrysky">
    <meta name="description" content="Love rises from the east and descends to the west,romance makes no changes until death.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>AFL源码分析（一） | starrysky</title>
    <link rel="icon" type="image/jpeg" href="/favicon.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="starrysky" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">starrysky</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>文章</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>个人简介</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">starrysky</div>
        <div class="logo-desc">
            
            Love rises from the east and descends to the west,romance makes no changes until death.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			文章
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			个人简介
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/Steel%20Gray.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">AFL源码分析（一）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/fuzz/">
                                <span class="chip bg-color">fuzz</span>
                            </a>
                        
                            <a href="/tags/AFL/">
                                <span class="chip bg-color">AFL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/fuzz/" class="post-category">
                                fuzz
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-02-24
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    21.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    100 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="afl-gcc"><a href="#afl-gcc" class="headerlink" title="afl-gcc"></a>afl-gcc</h2><h3 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>test.c源码</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">gets</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>gdb载入源码调试</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$gdb</span> <span class="token punctuation">..</span>/AFL/afl-gcc
pwndbg<span class="token operator">></span> <span class="token builtin class-name">set</span> args test.c <span class="token parameter variable">-o</span> <span class="token builtin class-name">test</span>
pwndbg<span class="token operator">></span> <span class="token function">dir</span> <span class="token punctuation">..</span>/AFL
pwndbg<span class="token operator">></span> b main
pwndbg<span class="token operator">></span> r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><ul>
<li>输出版本信息</li>
<li>判断没有参数就退出</li>
<li>获取 afl-as 路径</li>
<li>调用 edit_params 解析参数</li>
<li>根据解析出的参数使用 execvp 执行 gcc</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//标准错误输出 stderr 定向到终端且 AFL_QUIET 环境变量不存在</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-cc "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//输出 AFL 的版本信息</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果标准错误输出 stderr 重定向到其他位置，或者 AFL_QUIET 环境变量存在，则设置 be_quiet = 1</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果 afl-gcc 后面没有参数则输出报错后退出</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> BIN_PATH<span class="token punctuation">,</span> BIN_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">find_as</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//寻找 afl-as 的位置</span>
  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解析参数</span>
  <span class="token function">execvp</span><span class="token punctuation">(</span>cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>cc_params<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//执行参数列表中的指令,通过 -B 指定使用 afl-as 进行汇编来编译插桩</span>
  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解析失败报错</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h3><ul>
<li>通过环境变量中的 AFL_PATH 找 afl-as</li>
<li>如果没有就在 afl-gcc 所在目录里找 afl-as</li>
<li>再次去 AFL_PATH 中找 afl-as 找到就改成 AFL_PATH 中的 afl-as</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">find_as</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> argv0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 <span class="token operator">*</span>afl_path <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取环境变量中的 AFL_PATH</span>
  u8 <span class="token operator">*</span>slash<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>afl_path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//环境变量中存在 AFL_PATH</span>
    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/as"</span><span class="token punctuation">,</span> afl_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// AFL_PATH / as 可访问</span>
      as_path <span class="token operator">=</span> afl_path<span class="token punctuation">;</span>	<span class="token comment">// as_path 设置为环境变量中的 AFL_PATH</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  slash <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv0<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取当前执行的 afl-gcc 程序路径字符串中“/”字符最后一次出现的位置,本例中"../AFL/afl-gcc"则指向"AFL/"后的"/"</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>slash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    u8 <span class="token operator">*</span>dir<span class="token punctuation">;</span>
    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    dir <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>argv0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token char">'/'</span><span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/afl-as"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//拼接成 ../AFL/afl-as</span>
      
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// ../AFL/afl-as 可访问</span>
      as_path <span class="token operator">=</span> dir<span class="token punctuation">;</span>	<span class="token comment">// as_path 设置为 ../AFL/afl-as</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//找到就返回</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>AFL_PATH <span class="token string">"/as"</span><span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//第一次检查的时候可能是 NULL,再检查一遍 AFL_PATH / as 是否可访问</span>
    as_path <span class="token operator">=</span> AFL_PATH<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to find AFL wrapper binary for 'as'. Please set AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h3><p>处理 afl-fuzz 的参数，将参数存放到 cc_params[]</p>
<ul>
<li><p>根据 afl 指令选择对应的编译器存放到 cc_params[0]：afl-gcc &#x2F; afl-g++ &#x2F; afl-clang &#x2F; afl-clang++ &#x2F; afl-gcj &#x3D;&gt; gcc &#x2F; g++ &#x2F; clang &#x2F; clang++ &#x2F; gcj</p>
</li>
<li><p>循环解析参数并添加到参数列表数组中并设置相应的环境变量</p>
<ul>
<li><blockquote>
<ul>
<li>跳过 -B 后面的参数</li>
<li>跳过 -integrated-as 和 -pipe</li>
<li>-m32：设置 m32_set &#x3D; 1</li>
<li>存在 -fsanitize&#x3D;address  或 -fsanitize&#x3D;memory 设置 asan_set &#x3D; 1</li>
<li>存在 FORTIFY_SOURCE 设置 fortify_set &#x3D; 1</li>
</ul>
</blockquote>
</li>
<li><p>将当前参数存放到 cc_params 参数数组中</p>
</li>
</ul>
</li>
<li><p>附加参数：</p>
<ul>
<li>-B as_path</li>
<li>-O3：启用一系列优化措施，以提高程序的运行速度和效率</li>
<li>-funroll-loops：启用循环展开优化减少循环控制的开销</li>
<li>-D__AFL_COMPILER&#x3D;1：指示编译器正在使用 AFL</li>
<li>-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION&#x3D;1：指示当前的编译模式是为模糊测试准备的，而不是用于生产环境</li>
</ul>
</li>
<li><p>在一定条件下附加参数：</p>
<ul>
<li><p>是 clang 模式：加上参数 -no-integrated-as，禁用 Clang 的内置汇编器</p>
</li>
<li><p>存在全局变量 AFL_HARDEN ：加上参数 -fstack-protector-all，启用堆栈保护，即canary</p>
</li>
<li><p>fortify_set &#x3D; 1：加上参数 -D_FORTIFY_SOURCE&#x3D;2，增强标准库函数的安全性，检查标准库函数（如 memcpy、strcpy 等）的参数是否可能导致缓冲区溢出</p>
</li>
<li><p>存在参数 -fsanitize&#x3D;address  或 -fsanitize&#x3D;memory：设置环境变量 AFL_USE_ASAN 为 1</p>
</li>
<li><p>存在环境变量 AFL_USE_ASAN &#x2F; AFL_USE_MSAN</p>
<ul>
<li>同时存在环境变量 AFL_USE_MSAN &#x2F; AFL_HARDEN 则报错</li>
<li>参数加上 -U_FORTIFY_SOURCE 和 -fsanitize&#x3D;address</li>
</ul>
</li>
<li><p>不是 FreeBSD 系统：加 -g 在编译时生成调试信息</p>
</li>
<li><p>存在环境变量 AFL_NO_BUILTIN ：附加一系列参数禁用编译器对一系列 str 和 cmp 类函数的内置优化，确保使用标准库中定义的strcmp函数</p>
</li>
</ul>
</li>
<li><p>在参数列表末尾加上 NULL 表示结束</p>
</li>
</ul>
<p>最后得到</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">pwndbg<span class="token operator">></span> tele <span class="token number">0x55555555a308</span>
<span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsi r15 <span class="token number">0x55555555a308</span> —▸ <span class="token number">0x5555555576ac</span> ◂— <span class="token number">0x5f4c464100636367</span> <span class="token comment">/* 'gcc' */</span>
<span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│         <span class="token number">0x55555555a310</span> —▸ <span class="token number">0x7fffffffe247</span> ◂— <span class="token number">0x2d00632e74736574</span> <span class="token comment">/* 'test.c' */</span>
<span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│         <span class="token number">0x55555555a318</span> —▸ <span class="token number">0x7fffffffe24e</span> ◂— <span class="token number">0x74736574006f2d</span> <span class="token comment">/* '-o' */</span>
<span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│         <span class="token number">0x55555555a320</span> —▸ <span class="token number">0x7fffffffe251</span> ◂— <span class="token number">0x534a470074736574</span> <span class="token comment">/* 'test' */</span>
<span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│         <span class="token number">0x55555555a328</span> —▸ <span class="token number">0x555555557794</span> ◂— <span class="token number">0x692d6f6e2d00422d</span> <span class="token comment">/* '-B' */</span>
<span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│         <span class="token number">0x55555555a330</span> —▸ <span class="token number">0x55555555a2a8</span> ◂— <span class="token char">'/home/starrysky/AFL'</span>
<span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│         <span class="token number">0x55555555a338</span> —▸ <span class="token number">0x55555555781c</span> ◂— <span class="token number">0x2d00334f2d00672d</span> <span class="token comment">/* '-g' */</span>
<span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│         <span class="token number">0x55555555a340</span> —▸ <span class="token number">0x55555555781f</span> ◂— <span class="token number">0x6e75662d00334f2d</span> <span class="token comment">/* '-O3' */</span>
pwndbg<span class="token operator">></span> 
<span class="token number">08</span><span class="token operator">:</span><span class="token number">0040</span>│  <span class="token number">0x55555555a348</span> —▸ <span class="token number">0x555555557823</span> ◂— <span class="token char">'-funroll-loops'</span>
<span class="token number">09</span><span class="token operator">:</span><span class="token number">0048</span>│  <span class="token number">0x55555555a350</span> —▸ <span class="token number">0x555555557832</span> ◂— <span class="token char">'-D__AFL_COMPILER=1'</span>
<span class="token number">0</span>a<span class="token operator">:</span><span class="token number">0050</span>│  <span class="token number">0x55555555a358</span> —▸ <span class="token number">0x555555557610</span> ◂— '<span class="token operator">-</span>DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION<span class="token operator">=</span><span class="token number">1</span>'
<span class="token number">0</span>b<span class="token operator">:</span><span class="token number">0058</span>│  <span class="token number">0x55555555a360</span> ◂— <span class="token number">0x0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span>u32 argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 fortify_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> asan_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  u8 <span class="token operator">*</span>name<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>
  u8 m32_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  cc_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为 cc_params 开辟空间,本例中 argc = 4</span>

  name <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//找到最后一个"/"的位置,也就是"../AFL/afl-gcc"中的第二个"/"位置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">else</span> name<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//如果存在"/",则 name 为"/"下一个位置即"afl-gcc",如果不存在也就是直接使用了 AFL_PATH 中的 afl-gcc 则 name 直接等于 argv[0]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//判断是否为 afl-clang</span>
    clang_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//是 afl-clang 则设置 clang_mode = 1 且设置环境变量 CLANG_ENV_VAR 为 1</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//进一步判断是否是 afl-clang++</span>
      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang++"</span><span class="token punctuation">;</span>	<span class="token comment">//是 afl-clang++ 则设置 cc_params[0] 为环境变量里的 AFL_CXX 或者 clang++</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang"</span><span class="token punctuation">;</span>	<span class="token comment">//是 afl-clang 则设置 cc_params[0] 为环境变量里的 AFL_CC 或者 clang</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__	</span><span class="token comment">//如果是苹果平台</span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>	<span class="token comment">//本例是在linux, 最终 cc_params[0] = gcc</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-g++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果是 afl-g++ 则设置 cc_params[0] 为环境变量中 AFL_CXX 的值或 g++</span>
      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"g++"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-gcj"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果是 afl-gcj 则设置 cc_params[0] 为环境变量中 "AFL_GCJ 的值或 gcj,用于编译 java</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_GCJ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcj"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果是其他指令, 设置 cc_params[0] 为环境变量中 "AFL_CC 的值或 gcc</span>
      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcc"</span><span class="token punctuation">;</span>	<span class="token comment">//本例中未获取到环境变量所以直接设置为 gcc</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>argc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//第一个参数处理完参数数量减1,遍历其他参数</span>
    u8<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">++</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取下一个参数的位置</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-B"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>		<span class="token comment">//处理参数 -B,用于指定工具链或库文件的参数,这里会跳过 -B 和它的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"-B is already set, overriding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//be_quiet 为 0 则提示已经设置过</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cur<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> argc <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> argc<span class="token operator">--</span><span class="token punctuation">;</span> argv<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>	<span class="token comment">//跳过 -B 后面的参数</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-integrated-as"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//跳过参数 -integrated-as</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-pipe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//跳过参数 -pipe</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span>	</span><span class="token comment">//如果是 FreeBSD 系统并且是 x86-64架构,本例中不是</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-m32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m32_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> asan_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//存在 -fsanitize=address  或 -fsanitize=memory 则设置 asan_set = 1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"FORTIFY_SOURCE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> fortify_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//存在 FORTIFY_SOURCE 则设置 fortify_set = 1</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span>	<span class="token comment">//将当前参数存到 cc_params 数组中</span>
  <span class="token punctuation">&#125;</span>

  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-B"</span><span class="token punctuation">;</span>
  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> as_path<span class="token punctuation">;</span>	<span class="token comment">//参数数组增加 -B as_path 指定 afl-as 位置</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>clang_mode<span class="token punctuation">)</span>	<span class="token comment">//如果是 clang 模式则加上参数 -no-integrated-as,禁用 Clang 的内置汇编器</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-no-integrated-as"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果存在全局变量 AFL_HARDEN 则加上参数 -fstack-protector-all,启用堆栈保护,即canary</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fstack-protector-all"</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fortify_set<span class="token punctuation">)</span>	<span class="token comment">//如果 fortify_set = 1 再加上参数 -D_FORTIFY_SOURCE=2,增强标准库函数的安全性,检查标准库函数（如 memcpy、strcpy 等）的参数是否可能导致缓冲区溢出</span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D_FORTIFY_SOURCE=2"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>asan_set<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//存在参数 -fsanitize=address  或 -fsanitize=memory </span>
    <span class="token comment">/* Pass this on to afl-as to adjust map density.将其传递给 afl-as 来调整 map density */</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置环境变量 AFL_USE_ASAN 为 1</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果存在环境变量 AFL_USE_ASAN</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//同时存在环境变量 AFL_USE_MSAN 则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//同时存在环境变量 AFL_HARDEN 则报错</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span>	<span class="token comment">//参数加上 -U_FORTIFY_SOURCE</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">;</span>	<span class="token comment">//参数加上 -fsanitize=address</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//同上</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"MSAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_DONT_OPTIMIZE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>

    <span class="token comment">//源码注释翻译：在 64 位 FreeBSD 系统上，clang -g -m32 出现故障，但 -m32 本身可以正常工作</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">||</span> <span class="token operator">!</span>m32_set<span class="token punctuation">)</span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>	<span class="token comment">//因为不是 FreeBSD 系统所以直接在参数后面加 -g,用于在编译时生成调试信息</span></span>
      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-O3"</span><span class="token punctuation">;</span>	<span class="token comment">//加上参数 -O3,启用一系列优化措施，以提高程序的运行速度和效率</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-funroll-loops"</span><span class="token punctuation">;</span>	<span class="token comment">//加上参数 -funroll-loops,启用循环展开优化减少循环控制的开销</span>

    <span class="token comment">//源码注释翻译：您正在为模糊测试构建两个指标；其中一个是 AFL 专用的，另一个与 libfuzzer 共享</span>

    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D__AFL_COMPILER=1"</span><span class="token punctuation">;</span>	<span class="token comment">//指示编译器正在使用 AFL</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1"</span><span class="token punctuation">;</span>	<span class="token comment">//指示当前的编译模式是为模糊测试准备的，而不是用于生产环境</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_BUILTIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//存在环境变量 AFL_NO_BUILTIN</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcmp"</span><span class="token punctuation">;</span>	<span class="token comment">//禁用编译器对 strcmp 函数的内置优化,确保代码使用标准库中定义的 strcmp 函数</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncmp"</span><span class="token punctuation">;</span>	
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasecmp"</span><span class="token punctuation">;</span>	
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncasecmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-memcmp"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strstr"</span><span class="token punctuation">;</span>
    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasestr"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>	<span class="token comment">//参数列表末尾加上 NULL 表示结束</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="afl-as"><a href="#afl-as" class="headerlink" title="afl-as"></a>afl-as</h2><h3 id="gdb调试-1"><a href="#gdb调试-1" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>在 gcc 里找不到在哪跟进到 afl-as，直接曲线救国…把 test.s 放到 &#x2F;tmp 模拟 afl-gcc 生成的临时文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-S</span> test.c <span class="token parameter variable">-o</span> test.s
<span class="token function">sudo</span> <span class="token function">cp</span> test.s /tmp
gdb ~/AFL/afl-as
<span class="token builtin class-name">set</span> args /tmp/test.s
<span class="token function">dir</span> <span class="token punctuation">..</span>/AFL
b main
r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h3><p>大致和 afl-gcc 的 main 差不多</p>
<ul>
<li>获取环境变量 AFL_INST_RATIO 赋值到 inst_ratio_str</li>
<li>输出 afl-as 版本信息</li>
<li>判断没有参数就退出</li>
<li>获取时间根据时间和进程号生成随机数种子</li>
<li>调用 edit_params 解析参数</li>
<li>inst_ratio_str 不在 0-100 则退出</li>
<li>获取环境变量 AS_LOOP_ENV_VAR 为 1 则退出，为 0 则设置为 1</li>
<li>如果存在环境变量 AFL_USE_ASAN &#x2F; AFL_USE_MSAN 则降低 inst_ratio_str 以降低 AFL 的覆盖率检测频率减少对程序性能的影响</li>
<li>调用 add_instrumentation 函数对程序进行插桩</li>
<li>fork 新进程使用 execvp 执行 afl_as &#x2F; as</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  u8<span class="token operator">*</span> inst_ratio_str <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_INST_RATIO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//AFL 的指令覆盖率,用于指定 AFL 在代码中插入覆盖率检测代码的比例</span>
  <span class="token comment">//值的范围是 0 到 100，表示百分比</span>
  <span class="token comment">//如果值为 100，表示 AFL 会在所有可能的指令位置插入覆盖率检测代码，这会提供最全面的覆盖率，但可能会显著降低程序的运行速度</span>
  <span class="token comment">//如果值为 0，则表示不插入任何覆盖率检测代码，这通常用于非模糊测试场景</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  clang_mode <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-as "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rand_seed <span class="token operator">=</span> tv<span class="token punctuation">.</span>tv_sec <span class="token operator">^</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">^</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">srandom</span><span class="token punctuation">(</span>rand_seed<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取时间生成随机数种子</span>

  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//处理参数</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">,</span> <span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>inst_ratio<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> inst_ratio <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad value of AFL_INST_RATIO (must be between 0 and 100)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>	<span class="token comment">//指令覆盖率不在 0-100 之间则报错</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//防止在调用 as（汇编器）时出现无限循环调用as</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Endless loop when calling 'as' (remove '.' from your PATH)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token function">setenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置为1表示已经被调用过</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    sanitizer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    inst_ratio <span class="token operator">/=</span> <span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">//降低 AFL 的覆盖率检测频率，以减少对程序性能的影响，同时让内存检测工具能够更有效地运行</span>
  <span class="token punctuation">&#125;</span>
    <span class="token comment">//AFL_USE_ASAN：启用 AddressSanitizer（ASan），一种内存错误检测工具,以检测堆栈和堆缓冲区上溢/下溢 释放之后的堆使用情况</span>
    <span class="token comment">//AFL_USE_MSAN：启用 MemorySanitizer（MSan），一种未初始化内存检测工具</span>
    <span class="token comment">//源码注释：使用 ASAN 进行编译时，我们没有特别优雅的方法来跳过特定于 ASAN 的分支。但我们可以通过概率来弥补这一点</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>just_version<span class="token punctuation">)</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//程序不是只需要输出版本信息的时候，对程序进行插桩</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">execvp</span><span class="token punctuation">(</span>as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>as_params<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//fork新建进程之后执行参数列表</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_KEEP_ASSEMBLY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">unlink</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="edit-params-1"><a href="#edit-params-1" class="headerlink" title="edit_params"></a>edit_params</h3><p>处理参数、获取环境变量</p>
<ul>
<li>获取环境变量 AFL_AS 给 afl_as</li>
<li>依次获取环境变量TMPDIR &#x2F; 环境变量 TEMP &#x2F; 环境变量 TMP &#x2F; &#x2F;tmp，最先获取到的赋值给 tmp_dir</li>
<li>给 as_params 数组开辟空间，如果 afl_as 存在则将第一个参数设置为 afl_as，否则设置为 as</li>
<li>循环遍历参数函数参数，存在 –64 就设置 use_64bit 为 1，存在 –32 就设置 use_64bit 为 0，并且将参数添加到 as_params</li>
<li>从 as_params 中获取 input_file<ul>
<li>如果是 –version 则表示只需要输出版本信息，just_version 设置为 1</li>
<li>如果是 - 开头但不是 –version 则报错</li>
<li>如果只有 - 则输入文件为空</li>
</ul>
</li>
<li>如果 input_file 不以 tmp_dir &#x2F; &#x2F;var&#x2F;tmp&#x2F; &#x2F; &#x2F;tmp&#x2F; 开头，则设置 pass_thru 为 1，表示输入文件不是一个标准的编译过程中的临时文件，后续也不会进行插桩</li>
<li>生成修改后的文件路径：tmp_dir&#x2F;.afl-getpid()-time(NULL).s</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8 <span class="token operator">*</span>tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMPDIR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>afl_as <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_AS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从环境变量中获取临时目录和 afl_as 的路径</span>
  u32 i<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  <span class="token comment">//源码注释翻译：虽然没有记录，但当未设置 TMPDIR 时，GCC 也会使用 TEMP 和 TMP。我们需要检查这些非标准变量，以便稍后正确处理 pass_thru 逻辑。</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TEMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token string">"/tmp"</span><span class="token punctuation">;</span>
  <span class="token comment">//设置 tmp_dir 为 环境变量 TMPDIE / TEMP / 环境变量TMP / /tmp（按优先级顺序获取，不存在则获取下一个）</span>

  as_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//为 as 参数开辟空间</span>

  as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> afl_as <span class="token operator">?</span> afl_as <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"as"</span><span class="token punctuation">;</span>	<span class="token comment">//存在 afl_as 就将第一个参数设置为 afl_as,不存在就设置为 as</span>

  as_params<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//将数组最后一位设置为 0 表示结束</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//循环遍历参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//参数存在 --64 就设置 use_64bit 为 1</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//参数存在 --32 就设置 use_64bit 为 0</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

    as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//将参数赋值到参数列表数组中</span>
  <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  input_file <span class="token operator">=</span> argv<span class="token punctuation">[</span>argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">//获取 input_file</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_file <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"-version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//input_file = --version表示只需要显示版本信息</span>
      just_version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      modified_file <span class="token operator">=</span> input_file<span class="token punctuation">;</span>
      <span class="token keyword">goto</span> wrap_things_up<span class="token punctuation">;</span>	<span class="token comment">//设置 just_version 为 1，输出文件为输入文件</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Incorrect use (not called through afl-gcc?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//输入文件是 - 开头但不是 --version 则输出报错信息</span>
      <span class="token keyword">else</span> input_file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>	<span class="token comment">//输入文件是 - 则输入文件为空</span>

  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>tmp_dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/var/tmp/"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/tmp/"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> pass_thru <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果 input_file 不以 tmp_dir / /var/tmp/ / /tmp/ 开头，则设置 pass_thru 为 1,用于判断输入文件是否是一个标准的编译过程中的临时文件，还是一个用户手动指定的 .s 文件（汇编文件）。如果是非标准路径，pass_thru 被设置为 1，表示需要特殊处理。</span>
  <span class="token punctuation">&#125;</span>

  modified_file <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.afl-%u-%u.s"</span><span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//生成修改后的文件路径：tmp_dir/.afl-getpid()-time(NULL).s，例如 /tmp/.afl-12842-1741114189.s</span>

wrap_things_up<span class="token operator">:</span>
  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> modified_file<span class="token punctuation">;</span>
  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>	<span class="token comment">//将 modified_file 添加到参数列表 as_params 中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h3><ul>
<li>打开输入函数 &#x2F;tmp&#x2F;test.s 和输出函数 &#x2F;tmp&#x2F;.afl-12842-1741114189.s</li>
<li>逐行读取汇编代码，根据条件插入插桩程序<ul>
<li>如果当前行满足插桩条件则进行插桩并且增加插桩计数器</li>
<li>存入当前行汇编代码</li>
<li>在 text 段<ul>
<li>处理位数（32 &#x2F; 64），检测是 intel &#x2F; att 语法模式，检测是 APP &#x2F; NO_APP，根据检测结果设置 </li>
<li>skip_intel 和 skip_app 都是 0 且是条件跳转分支（存在：且开头是.?n） &#x2F; 函数入口标签(存在：)时设置 instrument_next 为 1，表示在下一条指令插入插桩代码</li>
</ul>
</li>
</ul>
</li>
<li>根据程序位数插入 main_payload_64 &#x2F; main_payload_32</li>
</ul>
<p>一个汇编程序的例子：</p>
<p>test.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> a <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		<span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//gcc -S test.c -o test.s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>test.s</p>
<blockquote>
<p>LC：gcc 非分支标签	L0：gcc 分支标签</p>
<p>.Ltmp0：clang非分支标签	.LBB0_0：clang 分支标签</p>
<p>jnz foo：条件分支	jmp foo：非条件跳转</p>
</blockquote>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">	.file	&quot;test.c&quot;
	.text
	.section	.rodata
.LC0:
	.string	&quot;Y&quot;
.LC1:
	.string	&quot;N&quot;
	.text
	.globl	test
	.type	test, @function
test:
.LFB0:
	.cfi_startproc
	endbr64
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	subq	$16, %rsp
	movl	$1, -4(%rbp)
	cmpl	$0, -4(%rbp)
	jg	.L2
	leaq	.LC0(%rip), %rdi
	call	puts@PLT
	jmp	.L1
.L2:
	leaq	.LC1(%rip), %rdi
	call	puts@PLT
	nop
.L1:
	leave
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE0:
	.size	test, .-test
	.globl	main
	.type	main, @function
main:
.LFB1:
	.cfi_startproc
	endbr64
	pushq	%rbp
	.cfi_def_cfa_offset 16
	.cfi_offset 6, -16
	movq	%rsp, %rbp
	.cfi_def_cfa_register 6
	movl	$0, %eax
	call	test
	movl	$0, %eax
	popq	%rbp
	.cfi_def_cfa 7, 8
	ret
	.cfi_endproc
.LFE1:
	.size	main, .-main
	.ident	&quot;GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.2) 9.4.0&quot;
	.section	.note.GNU-stack,&quot;&quot;,@progbits
	.section	.note.gnu.property,&quot;a&quot;
	.align 8
	.long	 1f - 0f
	.long	 4f - 1f
	.long	 5
0:
	.string	 &quot;GNU&quot;
1:
	.align 8
	.long	 0xc0000002
	.long	 3f - 2f
2:
	.long	 0x3
3:
	.align 8
4:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>^</code> 是一个特殊字符，表示行的开头，用于匹配字符串或行的起始位置</p>
<p><code>\t</code>开头且第二个是字母的是 指令行</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    inf <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to read '%s'"</span><span class="token punctuation">,</span> input_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> inf <span class="token operator">=</span> <span class="token constant">stdin</span><span class="token punctuation">;</span>	<span class="token comment">//打开 input_file,文件为空则 fd 为 stdin 标准输入</span>

  outfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_EXCL <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开 modified_file，即/tmp/test.s</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>outfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to write to '%s'"</span><span class="token punctuation">,</span> modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开失败报错</span>

  outf <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>outfd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//得到 outf 这个 FILE* 指针，fdopen 函数将参数 fd 的文件描述符转化为文件指针，这里打开的是刚生成的文件 /tmp/.afl-12842-1741114189.s</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取失败则报错</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> MAX_LINE<span class="token punctuation">,</span> inf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//逐行从输入文件中读取</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pass_thru <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_intel <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_app <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_csect <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span>
        instrument_next <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isalpha</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果当前是指令行且满足插桩条件</span>

      <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//插入插桩代码</span>

      instrument_next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//instrument_next 标志清零，表示当前行已经插入插桩代码</span>
      ins_lines<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//插桩计数器增加</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">fputs</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//插入插桩代码后将当前行插入</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pass_thru<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//当前行以 \t.开头</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"p2align "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> skip_next_label <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"text\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t.text"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t__TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section __TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        instr_ok <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span> 
      <span class="token punctuation">&#125;</span>	<span class="token comment">//在 \t.text\n, \t.section\t.text, \t.section\t__TEXT,__text, \t.section __TEXT, __text 中则设置 instr_ok 为 1</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"bss\n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"data\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        instr_ok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>	<span class="token comment">//在 \t.section\t, \t.section, \t.bss\n, \t.data\n 中则设置 instr_ok 为 0</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> use_64bit<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> <span class="token operator">!</span>use_64bit<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>	<span class="token comment">//根据程序是 32 位还是 64 位设置 skip_csect</span>
      
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".intel_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//检测到 .intel_syntax，表示进入 Intel 语法模式，跳过插桩</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".att_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//检测到 .att_syntax，表示回到 AT&amp;T 语法模式，恢复插桩</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#NO_APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>	<span class="token comment">//检测到 #APP 则跳过插桩，检测到 #NO_APP 则恢复插桩</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_intel <span class="token operator">||</span> skip_app <span class="token operator">||</span> skip_csect <span class="token operator">||</span> <span class="token operator">!</span>instr_ok <span class="token operator">||</span>
        line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>	<span class="token comment">//存在需要跳过的条件则跳过该行</span>

    <span class="token comment">//条件分支指令（jnz 等）。我们将检测附加到分支之后（用于检测未采用的路径）和分支目标标签（稍后处理）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'j'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'m'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//条件跳转指令且满足插桩概率则插桩，非条件跳转例如 jmp 不会插桩</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ins_lines<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">/* Everybody else: .L&lt;whatever>: */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//检测分支目标标签，例如 .L0:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>
        <span class="token comment">/* .L0: or LBB0_0: style jump destination */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token comment">/* Apple: .L&lt;num> / .LBB&lt;num> */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>clang_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"LBB"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//.?n: 或 clang 模式下 .LBB 且满足插桩概率</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip_next_label<span class="token punctuation">)</span> instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果未设置 skip_next_label ，标签符合插桩条件，则设置 instrument_next = 1，表示在下一条指令插入插桩代码</span>
          <span class="token keyword">else</span> skip_next_label <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//否则设置 skip_next_label 为 0</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* Function label (always instrumented, deferred mode). */</span>
        instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//有冒号，不是分支目标标签，则是函数入口点标签，在下一条进行插桩</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ins_lines<span class="token punctuation">)</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span>use_64bit <span class="token operator">?</span> main_payload_64 <span class="token operator">:</span> main_payload_32<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//根据程序位数插入 main_payload_64 / main_payload_32</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token function">fclose</span><span class="token punctuation">(</span>inf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>outf<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ins_lines<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"No instrumentation targets found%s."</span><span class="token punctuation">,</span> pass_thru <span class="token operator">?</span> <span class="token string">" (pass-thru mode)"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Instrumented %u locations (%s-bit, %s mode, ratio %u%%)."</span><span class="token punctuation">,</span>
             ins_lines<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> <span class="token string">"64"</span> <span class="token operator">:</span> <span class="token string">"32"</span><span class="token punctuation">,</span>
             <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"hardened"</span> <span class="token operator">:</span> 
             <span class="token punctuation">(</span>sanitizer <span class="token operator">?</span> <span class="token string">"ASAN/MSAN"</span> <span class="token operator">:</span> <span class="token string">"non-hardened"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             inst_ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="插桩汇编代码"><a href="#插桩汇编代码" class="headerlink" title="插桩汇编代码"></a>插桩汇编代码</h3><p>trampoline_fmt_32 和 main_payload_32 见源码</p>
<p>trampoline_fmt_64：</p>
<ul>
<li>保存寄存器的值</li>
<li>将当前的代码位置加载到 rcx 寄存器</li>
<li>调用 __afl_maybe_log</li>
<li>恢复寄存器的值</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">static const u8* trampoline_fmt_64 &#x3D;

  &quot;\n&quot;
  &quot;&#x2F;* --- AFL TRAMPOLINE (64-BIT) --- *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;.align 4\n&quot;
  &quot;\n&quot;
  &quot;leaq -(128+24)(%%rsp), %%rsp\n&quot;
  &quot;movq %%rdx,  0(%%rsp)\n&quot;
  &quot;movq %%rcx,  8(%%rsp)\n&quot;
  &quot;movq %%rax, 16(%%rsp)\n&quot;	;保存寄存器的值
  &quot;movq $0x%08x, %%rcx\n&quot;	;将当前的代码位置加载到 rcx 寄存器，%08x 是一个格式化占位符，表示一个 8 位的十六进制数
  &quot;call __afl_maybe_log\n&quot;	;调用 __afl_maybe_log 将当前的执行路径信息记录到共享内存中
  &quot;movq 16(%%rsp), %%rax\n&quot;
  &quot;movq  8(%%rsp), %%rcx\n&quot;
  &quot;movq  0(%%rsp), %%rdx\n&quot;	
  &quot;leaq (128+24)(%%rsp), %%rsp\n&quot;	;恢复寄存器的值
  &quot;\n&quot;
  &quot;&#x2F;* --- END --- *&#x2F;\n&quot;
  &quot;\n&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>main_payload_64：</p>
<ul>
<li><p>入口点：__afl_maybe_log</p>
<ul>
<li>获取共享内存指针，未初始化则跳转到 __afl_setup 进行初始化</li>
<li>跳转到 __afl_store</li>
</ul>
</li>
<li><p>路径记录逻辑：__afl_store - 计算前一个基本块（pre_location）到当前基本块（cur_location）这条边的ID，然后统计其出现次数</p>
<ul>
<li>计算并存储 rcx 中指定的代码位置的命中率</li>
<li>将上一个代码位置右移一位（优化存储）</li>
<li>将计算结果存储到共享内存中</li>
</ul>
</li>
<li><p>初始化共享内存：__afl_setup - 获取AFL进程设置的共享内存标识符，并在target进程内attach到共享内存</p>
<ul>
<li>获取 __afl_setup_failure 判断是否已经进行过初始化并且失败，已经失败过就跳转到 __afl_return 进行返回避免重复初始化</li>
<li>如果全局共享内存指针已设置，直接跳转到 __afl_store</li>
<li>如果未设置，跳转到 __afl_setup_first 进行第一次初始化，调用后从 rdx 寄存器获取 __afl_setup_abort</li>
</ul>
</li>
<li><p>第一次初始化共享内存：__afl_setup_first</p>
<ul>
<li>将寄存器的值保存到栈上</li>
<li>获取环境变量中的共享内存 ID 并且转换成整数</li>
<li>使用 shmat 将共享内存映射到当前进程，如果失败跳转到 __afl_setup_abort</li>
<li>将全局共享内存地址存储到 __afl_global_area_ptr，将共享内存地址存储到  __afl_global_area_ptr 地址中，并且存放到 rdx 中</li>
</ul>
</li>
<li><p>初始化失败处理：__afl_setup_abort</p>
<ul>
<li>增加 __afl_setup_failure 的值</li>
<li>从栈上恢复所有寄存器</li>
<li>跳转到 __afl_return：返回主逻辑</li>
</ul>
</li>
<li><p>处理异常情况：__afl_die 退出程序</p>
</li>
<li><p>恢复标志寄存器状态并返回：__afl_return</p>
</li>
<li><p>Fork Server 模式：__afl_forkserver，通过 Fork Server 模式避免频繁调用 execve，提升 fuzz 效率</p>
<ul>
<li>通知父进程：向父进程发送一个信号，表示当前进程已准备好</li>
<li>等待父进程指令：通过管道从父进程读取指令。如果读取失败，跳转到 __afl_die</li>
<li>创建子进程：<ul>
<li>使用 fork 创建子进程。如果失败，跳转到 __afl_die</li>
<li>子进程跳转到 __afl_fork_resume，父进程继续执行</li>
</ul>
</li>
<li>父进程逻辑：<ul>
<li>父进程将子进程的 PID 写入管道</li>
<li>父进程调用 waitpid 等待子进程执行完毕</li>
<li>父进程将子进程的退出状态写入管道，然后回到 __afl_fork_wait_loop</li>
</ul>
</li>
</ul>
</li>
<li><p>通过读取管道等待父进程：__afl_fork_wait_loop</p>
<ul>
<li>父进程通过管道（文件描述符 FORKSRV_FD）接收 AFL Fuzzer 的指令</li>
<li>父进程调用 fork 创建子进程</li>
<li>父进程将子进程的 PID 写入管道，并等待子进程执行完</li>
<li>父进程将子进程的退出状态写入管道，然后返回到等待 AFL Fuzzer 的指令</li>
<li>子进程关闭管道文件描述符后，继续执行目标程序</li>
</ul>
</li>
<li><p>子进程恢复执行：__afl_fork_resume</p>
<ul>
<li>关闭管道文件描述符</li>
<li>恢复寄存器的值</li>
<li>跳转到 __afl_store</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">static const u8* main_payload_64 &#x3D; 

  &quot;\n&quot;
  &quot;&#x2F;* --- AFL MAIN PAYLOAD (64-BIT) --- *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;.text\n&quot;
  &quot;.att_syntax\n&quot;
  &quot;.code64\n&quot;
  &quot;.align 8\n&quot;
  &quot;\n&quot;
  &quot;__afl_maybe_log:\n&quot;
  &quot;\n&quot;
#if defined(__OpenBSD__)  || (defined(__FreeBSD__) &amp;&amp; (__FreeBSD__ &lt; 9))
  &quot;  .byte 0x9f &#x2F;* lahf *&#x2F;\n&quot;
#else
  &quot;  lahf\n&quot;
#endif &#x2F;* ^__OpenBSD__, etc *&#x2F;
  &quot;  seto  %al\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Check if SHM region is already mapped. *&#x2F;\n&quot;	;检查共享内存区域是否已经映射
  &quot;\n&quot;
  &quot;  movq  __afl_area_ptr(%rip), %rdx\n&quot;	;获取共享内存区域 __afl_area_ptr 地址
  &quot;  testq %rdx, %rdx\n&quot;
  &quot;  je    __afl_setup\n&quot;	;如果__afl_area_ptr 为零即尚未映射，则调用 __afl_setup 函数进行初始化
  &quot;\n&quot;
  &quot;__afl_store:\n&quot;	;路径记录逻辑
  &quot;\n&quot;
  &quot;  &#x2F;* Calculate and store hit for the code location specified in rcx. *&#x2F;\n&quot;	;计算并存储 rcx 中指定的代码位置的命中率
  &quot;\n&quot;
#ifndef COVERAGE_ONLY
  &quot;  xorq __afl_prev_loc(%rip), %rcx\n&quot;	;rcx &#x3D; rcx ^ __afl_prev_loc
  &quot;  xorq %rcx, __afl_prev_loc(%rip)\n&quot;	;__afl_prev_loc &#x3D; 原 rcx 值
  &quot;  shrq $1, __afl_prev_loc(%rip)\n&quot;	;将上一个代码位置右移一位（优化存储）
#endif &#x2F;* ^!COVERAGE_ONLY *&#x2F;
  &quot;\n&quot;
#ifdef SKIP_COUNTS	;定义了是否仅记录命中次数（orb）还是累加命中次数（incb）
  &quot;  orb  $1, (%rdx, %rcx, 1)\n&quot;	;将计算结果存储到共享内存中，rdx &#x3D; __afl_area_ptr
#else
  &quot;  incb (%rdx, %rcx, 1)\n&quot;	;将计算结果存储到共享内存中
#endif &#x2F;* ^SKIP_COUNTS *&#x2F;
  &quot;\n&quot;
  &quot;__afl_return:\n&quot;	;恢复标志寄存器的状态并返回
  &quot;\n&quot;
  &quot;  addb $127, %al\n&quot;	;调整标志寄存器的状态
#if defined(__OpenBSD__)  || (defined(__FreeBSD__) &amp;&amp; (__FreeBSD__ &lt; 9))
  &quot;  .byte 0x9e &#x2F;* sahf *&#x2F;\n&quot;	;将 ah 寄存器的内容加载到标志寄存器中（恢复标志寄存器的状态）
#else
  &quot;  sahf\n&quot;	;将 ah 寄存器的内容加载到标志寄存器中（恢复标志寄存器的状态）
#endif &#x2F;* ^__OpenBSD__, etc *&#x2F;
  &quot;  ret\n&quot;	;返回
  &quot;\n&quot;
  &quot;.align 8\n&quot;
  &quot;\n&quot;
  &quot;__afl_setup:\n&quot;	;初始化共享内存
  &quot;\n&quot;
  &quot;  &#x2F;* Do not retry setup if we had previous failures. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  cmpb $0, __afl_setup_failure(%rip)\n&quot;
  &quot;  jne __afl_return\n&quot;	;获取 __afl_setup_failure，如果上次 setup 失败则不再进行 setup，直接跳转到 __afl_return 返回
  &quot;\n&quot;
  &quot;  &#x2F;* Check out if we have a global pointer on file. *&#x2F;\n&quot;
  &quot;\n&quot;
#ifndef __APPLE__
  ...
#else
  &quot;  movq  __afl_global_area_ptr(%rip), %rdx\n&quot;	;加载全局共享内存指针
#endif &#x2F;* !^__APPLE__ *&#x2F;
  &quot;  testq %rdx, %rdx\n&quot;
  &quot;  je    __afl_setup_first\n&quot;·;没有映射过全局共享内存指针就调用 __afl_setup_first 初始化
  &quot;\n&quot;
  &quot;  movq %rdx, __afl_area_ptr(%rip)\n&quot;	;将 __afl_setup_first 得到的共享内存区域传递给 __afl_area_ptr
  &quot;  jmp  __afl_store\n&quot; 	;跳转回 __afl_store
  &quot;\n&quot;
  &quot;__afl_setup_first:\n&quot;	;第一次初始化共享内存
  &quot;\n&quot;
  &quot;  &#x2F;* Save everything that is not yet saved and that may be touched by getenv() and several other libcalls we&#39;ll be relying on. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  leaq -352(%rsp), %rsp\n&quot;
  &quot;\n&quot;
  &quot;  movq %rax,   0(%rsp)\n&quot;
  &quot;  movq %rcx,   8(%rsp)\n&quot;
  &quot;  movq %rdi,  16(%rsp)\n&quot;
  &quot;  movq %rsi,  32(%rsp)\n&quot;
  &quot;  movq %r8,   40(%rsp)\n&quot;
  &quot;  movq %r9,   48(%rsp)\n&quot;
  &quot;  movq %r10,  56(%rsp)\n&quot;
  &quot;  movq %r11,  64(%rsp)\n&quot;
  &quot;\n&quot;
  &quot;  movq %xmm0,  96(%rsp)\n&quot;
  &quot;  movq %xmm1,  112(%rsp)\n&quot;
  &quot;  movq %xmm2,  128(%rsp)\n&quot;
  &quot;  movq %xmm3,  144(%rsp)\n&quot;
  &quot;  movq %xmm4,  160(%rsp)\n&quot;
  &quot;  movq %xmm5,  176(%rsp)\n&quot;
  &quot;  movq %xmm6,  192(%rsp)\n&quot;
  &quot;  movq %xmm7,  208(%rsp)\n&quot;
  &quot;  movq %xmm8,  224(%rsp)\n&quot;
  &quot;  movq %xmm9,  240(%rsp)\n&quot;
  &quot;  movq %xmm10, 256(%rsp)\n&quot;
  &quot;  movq %xmm11, 272(%rsp)\n&quot;
  &quot;  movq %xmm12, 288(%rsp)\n&quot;
  &quot;  movq %xmm13, 304(%rsp)\n&quot;
  &quot;  movq %xmm14, 320(%rsp)\n&quot;
  &quot;  movq %xmm15, 336(%rsp)\n&quot;	;保存寄存器到栈上
  &quot;\n&quot;
  &quot;  &#x2F;* Map SHM, jumping to __afl_setup_abort if something goes wrong. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* The 64-bit ABI requires 16-byte stack alignment. We&#39;ll keep the\n&quot;
  &quot;     original stack ptr in the callee-saved r12. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  pushq %r12\n&quot;
  &quot;  movq  %rsp, %r12\n&quot;
  &quot;  subq  $16, %rsp\n&quot;
  &quot;  andq  $0xfffffffffffffff0, %rsp\n&quot;
  &quot;\n&quot;
  &quot;  leaq .AFL_SHM_ENV(%rip), %rdi\n&quot;
  CALL_L64(&quot;getenv&quot;)	;获取共享内存的 ID
  &quot;\n&quot;
  &quot;  testq %rax, %rax\n&quot;
  &quot;  je    __afl_setup_abort\n&quot;
  &quot;\n&quot;
  &quot;  movq  %rax, %rdi\n&quot;
  CALL_L64(&quot;atoi&quot;)	;ID转换成整数
  &quot;\n&quot;
  &quot;  xorq %rdx, %rdx   &#x2F;* shmat flags    *&#x2F;\n&quot;
  &quot;  xorq %rsi, %rsi   &#x2F;* requested addr *&#x2F;\n&quot;
  &quot;  movq %rax, %rdi   &#x2F;* SHM ID         *&#x2F;\n&quot;
  CALL_L64(&quot;shmat&quot;)	;将共享内存映射到当前进程的地址空间
  &quot;\n&quot;
  &quot;  cmpq $-1, %rax\n&quot;
  &quot;  je   __afl_setup_abort\n&quot;	;如果失败，跳转到 __afl_setup_abort
  &quot;\n&quot;
  &quot;  &#x2F;* Store the address of the SHM region. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq %rax, %rdx\n&quot;
  &quot;  movq %rax, __afl_area_ptr(%rip)\n&quot;	;将共享内存的地址存储到 __afl_area_ptr 中
  &quot;\n&quot;
#ifdef __APPLE__
  ...
#else
  &quot;  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx\n&quot;	;全局共享内存指针赋值给 rdx
  &quot;  movq %rax, (%rdx)\n&quot;	;共享内存的地址存放到全局共享内存指针中
#endif &#x2F;* ^__APPLE__ *&#x2F;
  &quot;  movq %rax, %rdx\n&quot;	;共享内存的地址给 rdx
  &quot;\n&quot;
  &quot;__afl_forkserver:\n&quot;	;Fork Server 模式，避免重复调用 execve
  &quot;\n&quot;
  &quot;  &#x2F;* Enter the fork server mode to avoid the overhead of execve() calls. We\n&quot;
  &quot;     push rdx (area ptr) twice to keep stack alignment neat. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  pushq %rdx\n&quot;
  &quot;  pushq %rdx\n&quot;	;保持栈平衡
  &quot;\n&quot;
  &quot;  &#x2F;* Phone home and tell the parent that we&#39;re OK. (Note that signals with\n&quot;
  &quot;     no SA_RESTART will mess it up). If this fails, assume that the fd is\n&quot;
  &quot;     closed because we were execve()d from an instrumented binary, or because\n&quot;
  &quot;     the parent doesn&#39;t want to use the fork server. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi       &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;write&quot;)
  &quot;\n&quot;
  &quot;  cmpq $4, %rax\n&quot;
  &quot;  jne  __afl_fork_resume\n&quot;
  &quot;\n&quot;
  &quot;__afl_fork_wait_loop:\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Wait for parent by reading from the pipe. Abort if read fails. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY(FORKSRV_FD) &quot;, %rdi             &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;read&quot;)
  &quot;  cmpq $4, %rax\n&quot;
  &quot;  jne  __afl_die\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Once woken up, create a clone of our process. This is an excellent use\n&quot;
  &quot;     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly\n&quot;
  &quot;     caches getpid() results and offers no way to update the value, breaking\n&quot;
  &quot;     abort(), raise(), and a bunch of other things :-( *&#x2F;\n&quot;
  &quot;\n&quot;
  CALL_L64(&quot;fork&quot;)	;父进程通过管道与子进程通信
  &quot;  cmpq $0, %rax\n&quot;
  &quot;  jl   __afl_die\n&quot;
  &quot;  je   __afl_fork_resume\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* In parent process: write PID to pipe, then wait for child. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movl %eax, __afl_fork_pid(%rip)\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx                   &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_fork_pid(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi             &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;write&quot;)
  &quot;\n&quot;
  &quot;  movq $0, %rdx                   &#x2F;* no flags  *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi     &#x2F;* status    *&#x2F;\n&quot;
  &quot;  movq __afl_fork_pid(%rip), %rdi &#x2F;* PID       *&#x2F;\n&quot;
  CALL_L64(&quot;waitpid&quot;)
  &quot;  cmpq $0, %rax\n&quot;
  &quot;  jle  __afl_die\n&quot;
  &quot;\n&quot;
  &quot;  &#x2F;* Relay wait status to pipe, then loop back. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;
  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi         &#x2F;* file desc *&#x2F;\n&quot;
  CALL_L64(&quot;write&quot;)	;父进程等待子进程执行完毕后，将状态信息传递回子进程
  &quot;\n&quot;
  &quot;  jmp  __afl_fork_wait_loop\n&quot;	;子进程关闭管道文件描述符后继续执行
  &quot;\n&quot;
  &quot;__afl_fork_resume:\n&quot;	;子进程恢复执行
  &quot;\n&quot;
  &quot;  &#x2F;* In child process: close fds, resume execution. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  movq $&quot; STRINGIFY(FORKSRV_FD) &quot;, %rdi\n&quot;
  CALL_L64(&quot;close&quot;)
  &quot;\n&quot;
  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi\n&quot;
  CALL_L64(&quot;close&quot;)	;关闭管道文件描述符
  &quot;\n&quot;
  &quot;  popq %rdx\n&quot;
  &quot;  popq %rdx\n&quot;
  &quot;\n&quot;
  &quot;  movq %r12, %rsp\n&quot;
  &quot;  popq %r12\n&quot;
  &quot;\n&quot;
  &quot;  movq  0(%rsp), %rax\n&quot;
  &quot;  movq  8(%rsp), %rcx\n&quot;
  &quot;  movq 16(%rsp), %rdi\n&quot;
  &quot;  movq 32(%rsp), %rsi\n&quot;
  &quot;  movq 40(%rsp), %r8\n&quot;
  &quot;  movq 48(%rsp), %r9\n&quot;
  &quot;  movq 56(%rsp), %r10\n&quot;
  &quot;  movq 64(%rsp), %r11\n&quot;
  &quot;\n&quot;
  &quot;  movq  96(%rsp), %xmm0\n&quot;
  &quot;  movq 112(%rsp), %xmm1\n&quot;
  &quot;  movq 128(%rsp), %xmm2\n&quot;
  &quot;  movq 144(%rsp), %xmm3\n&quot;
  &quot;  movq 160(%rsp), %xmm4\n&quot;
  &quot;  movq 176(%rsp), %xmm5\n&quot;
  &quot;  movq 192(%rsp), %xmm6\n&quot;
  &quot;  movq 208(%rsp), %xmm7\n&quot;
  &quot;  movq 224(%rsp), %xmm8\n&quot;
  &quot;  movq 240(%rsp), %xmm9\n&quot;
  &quot;  movq 256(%rsp), %xmm10\n&quot;
  &quot;  movq 272(%rsp), %xmm11\n&quot;
  &quot;  movq 288(%rsp), %xmm12\n&quot;
  &quot;  movq 304(%rsp), %xmm13\n&quot;
  &quot;  movq 320(%rsp), %xmm14\n&quot;
  &quot;  movq 336(%rsp), %xmm15\n&quot;
  &quot;\n&quot;
  &quot;  leaq 352(%rsp), %rsp\n&quot;	;恢复寄存器的值
  &quot;\n&quot;
  &quot;  jmp  __afl_store\n&quot;	;跳转回路径记录逻辑
  &quot;\n&quot;
  &quot;__afl_die:\n&quot;
  &quot;\n&quot;
  &quot;  xorq %rax, %rax\n&quot;
  CALL_L64(&quot;_exit&quot;)	;退出程序
  &quot;\n&quot;
  &quot;__afl_setup_abort:\n&quot;	;初始化失败处理
  &quot;\n&quot;
  &quot;  &#x2F;* Record setup failure so that we don&#39;t keep calling\n&quot;
  &quot;     shmget() &#x2F; shmat() over and over again. *&#x2F;\n&quot;
  &quot;\n&quot;
  &quot;  incb __afl_setup_failure(%rip)\n&quot;	;增加 __afl_setup_failure 的值，避免重复初始化
  &quot;\n&quot;
  &quot;  movq %r12, %rsp\n&quot;
  &quot;  popq %r12\n&quot;
  &quot;\n&quot;
  &quot;  movq  0(%rsp), %rax\n&quot;
  &quot;  movq  8(%rsp), %rcx\n&quot;
  &quot;  movq 16(%rsp), %rdi\n&quot;
  &quot;  movq 32(%rsp), %rsi\n&quot;
  &quot;  movq 40(%rsp), %r8\n&quot;
  &quot;  movq 48(%rsp), %r9\n&quot;
  &quot;  movq 56(%rsp), %r10\n&quot;
  &quot;  movq 64(%rsp), %r11\n&quot;
  &quot;\n&quot;
  &quot;  movq  96(%rsp), %xmm0\n&quot;
  &quot;  movq 112(%rsp), %xmm1\n&quot;
  &quot;  movq 128(%rsp), %xmm2\n&quot;
  &quot;  movq 144(%rsp), %xmm3\n&quot;
  &quot;  movq 160(%rsp), %xmm4\n&quot;
  &quot;  movq 176(%rsp), %xmm5\n&quot;
  &quot;  movq 192(%rsp), %xmm6\n&quot;
  &quot;  movq 208(%rsp), %xmm7\n&quot;
  &quot;  movq 224(%rsp), %xmm8\n&quot;
  &quot;  movq 240(%rsp), %xmm9\n&quot;
  &quot;  movq 256(%rsp), %xmm10\n&quot;
  &quot;  movq 272(%rsp), %xmm11\n&quot;
  &quot;  movq 288(%rsp), %xmm12\n&quot;
  &quot;  movq 304(%rsp), %xmm13\n&quot;
  &quot;  movq 320(%rsp), %xmm14\n&quot;
  &quot;  movq 336(%rsp), %xmm15\n&quot;
  &quot;\n&quot;
  &quot;  leaq 352(%rsp), %rsp\n&quot;	;恢复寄存器
  &quot;\n&quot;
  &quot;  jmp __afl_return\n&quot;	;跳转回返回逻辑
  &quot;\n&quot;
  &quot;.AFL_VARS:\n&quot;
  &quot;\n&quot;

;以下为其他变量定义，定义共享内存指针、Fork Server PID、临时变量和全局共享内存指针
#ifdef __APPLE__
...
#ifndef COVERAGE_ONLY
  &quot;  .comm   __afl_prev_loc, 8\n&quot;
#endif &#x2F;* !COVERAGE_ONLY *&#x2F;
  &quot;  .comm   __afl_fork_pid, 4\n&quot;
  &quot;  .comm   __afl_temp, 4\n&quot;
  &quot;  .comm   __afl_setup_failure, 1\n&quot;

#else

  &quot;  .lcomm   __afl_area_ptr, 8\n&quot;
#ifndef COVERAGE_ONLY
  &quot;  .lcomm   __afl_prev_loc, 8\n&quot;
#endif &#x2F;* !COVERAGE_ONLY *&#x2F;
  &quot;  .lcomm   __afl_fork_pid, 4\n&quot;
  &quot;  .lcomm   __afl_temp, 4\n&quot;
  &quot;  .lcomm   __afl_setup_failure, 1\n&quot;

#endif &#x2F;* ^__APPLE__ *&#x2F;

  &quot;  .comm    __afl_global_area_ptr, 8, 8\n&quot;
  &quot;\n&quot;
  &quot;.AFL_SHM_ENV:\n&quot;
  &quot;  .asciz \&quot;&quot; SHM_ENV_VAR &quot;\&quot;\n&quot;	;环境变量定义
  &quot;\n&quot;
  &quot;&#x2F;* --- END --- *&#x2F;\n&quot;
  &quot;\n&quot;;

#endif &#x2F;* !_HAVE_AFL_AS_H *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="afl-fuzz"><a href="#afl-fuzz" class="headerlink" title="afl-fuzz"></a>afl-fuzz</h2><h3 id="gdb调试-2"><a href="#gdb调试-2" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>gcc 生成 test 可执行文件后，在 test 所在目录创建文件夹 in 和 out，在文件夹 in 中创建文本文件 testcase，内容 abc</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span>
<span class="token builtin class-name">echo</span> core <span class="token operator">></span>/proc/sys/kernel/core_pattern
gdb <span class="token punctuation">..</span>/AFL/afl-fuzz
pwndbg<span class="token operator">></span> <span class="token builtin class-name">set</span> args <span class="token parameter variable">-i</span> <span class="token keyword">in</span> <span class="token parameter variable">-o</span> out <span class="token parameter variable">-M</span> fuzzer1 ./test 
pwndbg<span class="token operator">></span> <span class="token function">dir</span> <span class="token punctuation">..</span>/AFL
pwndbg<span class="token operator">></span> b main
pwndbg<span class="token operator">></span> r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><iframe src="https://www.processon.com/editor/view/flow?fromnew=1&amp;isTemp=true&amp;template=true&amp;chartId=6410452f3e892476c12dcb28" frameborder="0" style="width: 2000px; height: 1001px; border: none; position: relative; z-index: 4;"></iframe>

<h3 id="main-2"><a href="#main-2" class="headerlink" title="main"></a>main</h3><ul>
<li><p>如果设置了环境变量 AFL_BENCH_JUST_ONE，则设置 exit_1 为 1，设置单次执行标志</p>
</li>
<li><p>输出 afl-fuzz 版本信息，从 DOC_PATH 获取文档路径，如果不存在就设置为 docs（文档路径为 &#x2F;usr&#x2F;local&#x2F;share&#x2F;doc&#x2F;afl，存在一些 tips 和 README）</p>
</li>
<li><p>获取时间根据时间和进程号生成随机数种子</p>
</li>
<li><p>解析参数（调试的参数为：<code>-i in -o out ./test -M fuzzer1</code>）</p>
<ul>
<li>-i：指定输入目录，输入目录是 “-“ 表示从当前目录恢复测试，不能重复指定</li>
<li>-o：指定输出目录，不能重复指定</li>
<li>-M：主节点同步 ID</li>
<li>-S：指定从属模块的同步 ID</li>
<li>-f：指定目标程序的输入文件</li>
<li>-x：指定字典文件</li>
<li>-t：设置目标程序的超时时间，不小于 5ms，可以带后缀 “+” 表示动态超时</li>
<li>-m：内存限制，存在该参数则设置 mem_limit_given &#x3D; 1，参数值可以有 T &#x2F; G &#x2F; k &#x2F; M，不小于 5m，32位系统不大于 2000m</li>
<li>-d：跳过 AFL 的确定性变异阶段，直接进入随机变异阶段</li>
<li>-B：加载之前生成的位图文件，用于跳过已发现的路径，参数值为之前二进制文件生成的 fuzz_bitmap</li>
<li>-C：启用 crash 模式，只记录导致 crash 的测试用例</li>
<li>-n：dumb 模式，AFL 不使用复杂的变异策略</li>
<li>-T：设置 AFL 的 banner 信息</li>
<li>-Q：qemu 模式，用于测试非原生二进制文件，如果未设置内存限制，则默认使用 qemu_mode 的内存限制</li>
<li>default：使用了其他参数，则调用 usage 显示帮助信息并退出</li>
</ul>
</li>
<li><p>检查是否指定了 -i 和 -o，没有就调用 usage 显示帮助信息并退出</p>
</li>
<li><p><a href="##setup_signal_handlers">setup_signal_handlers</a> 注册信号处理函数</p>
</li>
<li><p><a href="##check_asan_opts">check_asan_opts</a> 读取 ASAN_OPTIONS 和 MSAN_OPTIONS 并进行一些检查</p>
</li>
<li><p>如果通过 -M 或 -S 指定了 sync_id 就调用 <a href="##fix_up_sync">fix_up_sync</a> 进行一些设置</p>
</li>
<li><p>限制输入文件夹和输出文件夹不能是同一个文件夹，如果是就显示报错信息后退出</p>
</li>
<li><p>如果开启了 dumb 模式，不能同时开启 crash 模式 或 qemu 模式，同时开启了就显示报错信息后退出</p>
</li>
<li><p>获取一系列相关环境变量</p>
</li>
<li><p><a href="##save_cmdline">save_cmdline</a> 保存命令行参数，在保存 crash 信息的时候使用</p>
</li>
<li><p><a href="##fix_up_banner">fix_up_banner</a> 更新 use_banner</p>
</li>
<li><p><a href="##check_if_tty">check_if_tty</a> 根据环境变量 AFL_NO_UI 设置 not_on_tty 进而确定是界面显示还是逐行输出</p>
</li>
<li><p>进行一些 cpu 操作</p>
<ul>
<li><a href="##get_core_count">get_core_count</a> 获取核心数量</li>
<li><a href="##bind_to_free_cpu">bind_to_free_cpu</a> 绑定到一个空闲的 CPU，有助于提升多线程或多进程的性能</li>
<li><a href="##check_crash_handling">check_crash_handling</a> 避免 crash 被误判为超时的情况</li>
<li><a href="##check_cpu_governor">check_cpu_governor</a> 检查 cpu 是否可调，如果可调则建议用户把 cpu 定在最高频率</li>
</ul>
</li>
<li><p><a href="##setup_post">setup_post</a> 设置 post_handler</p>
</li>
<li><p><a href="##setup_shm">setup_shm</a> 初始化共享内存</p>
</li>
<li><p><a href="##init_count_class16">init_count_class16</a> 初始化 16bit 查找表</p>
</li>
<li><p>进行一些文件操作</p>
<ul>
<li><p><a href="##setup_dirs_fds">setup_dirs_fds</a> 在工作目录下创建一些文件夹（hangs，queue，crash），并打开一些 fd 备用，例如 &#x2F;dev&#x2F;urandom</p>
</li>
<li><p><a href="##read_testcases">read_testcases</a> 把初始 corpus（语料库） 读入 queue</p>
</li>
<li><p><a href="##load_auto">load_auto</a> 读入自动生成的 extra（extras 是指用户提供的或自动生成的特殊字符串（称为 tokens），用于在 fuzzing 过程中对测试用例进行变异，通过插入或替换这些 tokens 来生成更有针对性的测试用例，从而提高 fuzzing 的效率和覆盖率）</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">extra_data</span> <span class="token punctuation">&#123;</span>
  u8<span class="token operator">*</span> data<span class="token punctuation">;</span>                           <span class="token comment">/* Dictionary token data  字典标记数据               */</span>
  u32 len<span class="token punctuation">;</span>                            <span class="token comment">/* Dictionary token length 字典标记长度              */</span>
  u32 hit_cnt<span class="token punctuation">;</span>                        <span class="token comment">/* Use count in the corpus 使用语料库中的计数         */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token operator">*</span> extras<span class="token punctuation">;</span>     <span class="token comment">/* Extra tokens to fuzz with 用于模糊测试的额外标记    */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p><a href="##pivot_inputs">pivot_inputs</a> 把初始 corpus 复制到工作目录的 queue 文件夹下</p>
</li>
<li><p>用户通过 -x 指定了 dictionary，则调用 <a href="##load_extras">load_extras</a> 从 dictionary 导入 extra</p>
</li>
<li><p>未设置 timeout_given 则调用 <a href="##find_timeout">find_timeout</a> 防止不停调整超时时间</p>
</li>
<li><p><a href="##detect_file_args">detect_file_args</a> 判断目标程序，对文件名为 @@ 的情况进行特判</p>
</li>
<li><p>未使用 -f 指定目标程序，则调用 <a href="##setup_stdio_file">setup_stdio_file</a> 创建 .cur_input 文件并打开，设为 out_fd</p>
</li>
<li><p><a href="##check_binary">check_binary</a> 检查目标程序</p>
</li>
</ul>
</li>
<li><p>获取当前时间为开始时间 start_time</p>
</li>
<li><p>如果是 qemu 模式则调用 get_qemu_argv 获取命令行参数，并将结果赋值给 use_argv，否则 use_argv 存储可执行文件名 test</p>
</li>
<li><p><a href="##perform_dry_run">perform_dry_run</a> 执行输入文件夹中预先准备的所有测试用例，以确认目标程序是否按预期工作，只在初始输入时执行一次</p>
</li>
<li><p><a href="##cull_queue">cull_queue</a> 精简队列</p>
</li>
<li><p><a href="##show_init_stats">show_init_stats</a> 更新 ui 信息，使用 ui 界面展示</p>
</li>
<li><p><a href="##find_start_position">find_start_position</a> 获取 seek_to 从上次中断的地方继续进行模糊测试</p>
</li>
<li><p><a href="##write_stats_file">write_stats_file</a> 更新 fuzzer_stats 文件，记录 fuzzer 的当前状态</p>
</li>
<li><p><a href="##save_auto">save_auto</a> 保存 AFL 自动生成的测试用例片段 auto extras</p>
</li>
<li><p>接收到用户中断指令则跳转到 stop_fuzzing 停止 fuzz</p>
</li>
<li><p>暂停 4s 让用户看到 ui 信息，如果收到用户的取消指令则跳转到 stop_fuzzing 停止 fuzz</p>
</li>
<li><p>进入 fuzz 主循环</p>
<ul>
<li><p><a href="##cull_queue">cull_queue</a> 精简队列</p>
</li>
<li><p>如果 queue_cur 为空，即所有 queue 被执行了一遍</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> fname<span class="token punctuation">;</span>                          <span class="token comment">/* File name for the test case 测试用例的文件名      */</span>
  u32 len<span class="token punctuation">;</span>                            <span class="token comment">/* Input length 输入长度                            */</span>

  u8  cal_failed<span class="token punctuation">,</span>                     <span class="token comment">/* Calibration failed? 校准失败？                    */</span>
      trim_done<span class="token punctuation">,</span>                      <span class="token comment">/* Trimmed? 修剪？                                  */</span>
      was_fuzzed<span class="token punctuation">,</span>                     <span class="token comment">/* Had any fuzzing done yet? 模糊测试已经完成？       */</span>
      passed_det<span class="token punctuation">,</span>                     <span class="token comment">/* Deterministic stages passed? 确定性阶段通过？      */</span>
      has_new_cov<span class="token punctuation">,</span>                    <span class="token comment">/* Triggers new coverage? 触发新覆盖？               */</span>
      var_behavior<span class="token punctuation">,</span>                   <span class="token comment">/* Variable behavior? 变量行为？                     */</span>
      favored<span class="token punctuation">,</span>                        <span class="token comment">/* Currently favored? 在fs中标记为冗余？              */</span>
      fs_redundant<span class="token punctuation">;</span>                   <span class="token comment">/* Marked as redundant in the fs?                  */</span>

  u32 bitmap_size<span class="token punctuation">,</span>                    <span class="token comment">/* Number of bits set in bitmap 位图中设置的位数      */</span>
      exec_cksum<span class="token punctuation">;</span>                     <span class="token comment">/* Checksum of the execution trace 执行跟踪的校验和   */</span>

  u64 exec_us<span class="token punctuation">,</span>                        <span class="token comment">/* Execution time (us) 执行时间 (us)                 */</span>
      handicap<span class="token punctuation">,</span>                       <span class="token comment">/* Number of queue cycles behind 后面的队列周期数     */</span>
      depth<span class="token punctuation">;</span>                          <span class="token comment">/* Path depth 路径深度                               */</span>

  u8<span class="token operator">*</span> trace_mini<span class="token punctuation">;</span>                     <span class="token comment">/* Trace bytes, if kept 跟踪字节（如果保留）           */</span>
  u32 tc_ref<span class="token punctuation">;</span>                         <span class="token comment">/* Trace bytes ref count 跟踪字节引用计数             */</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token operator">*</span>next<span class="token punctuation">,</span>           <span class="token comment">/* Next element, if any 下一个元素（如果有）           */</span>
                     <span class="token operator">*</span>next_100<span class="token punctuation">;</span>       <span class="token comment">/* 100 elements ahead  前面 100 个元素               */</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token operator">*</span>queue<span class="token punctuation">,</span>     <span class="token comment">/* Fuzzing queue (linked list) 模糊测试队列（链接列表）     */</span>
                          <span class="token operator">*</span>queue_cur<span class="token punctuation">,</span> <span class="token comment">/* Current offset within the queue 队列中的当前偏移量      */</span>
                          <span class="token operator">*</span>queue_top<span class="token punctuation">,</span> <span class="token comment">/* Top of the list 列表顶部                              */</span>
                          <span class="token operator">*</span>q_prev100<span class="token punctuation">;</span> <span class="token comment">/* Previous 100 marker  前100个标记                      */</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>queue_cycle + 1 记录完整执行次数</p>
</li>
<li><p>初始化 current_entry、cur_skipped_paths、queue_cur</p>
</li>
<li><p>检查 seek_to 是否为空，不为空就找到 seek_to 位置</p>
</li>
<li><p>show_stats 刷新 ui 信息</p>
<pre class="line-numbers language-none"><code class="language-none">                       american fuzzy lop 2.57b (fuzzer1)

┌─ process timing ─────────────────────────────────────┬─ overall results ─────┐
│        run time : 0 days, 3 hrs, 57 min, 6 sec       │  cycles done : 0      │
│   last new path : none seen yet                      │  total paths : 1      │
│ last uniq crash : none seen yet                      │ uniq crashes : 0      │
│  last uniq hang : none seen yet                      │   uniq hangs : 0      │
├─ cycle progress ────────────────────┬─ map coverage ─┴───────────────────────┤
│  now processing : 0 (0.00%)         │    map density : 0.00% &#x2F; 0.00%         │
│ paths timed out : 0 (0.00%)         │ count coverage : 1.00 bits&#x2F;tuple       │
├─ stage progress ────────────────────┼─ findings in depth ────────────────────┤
│  now trying : init                  │ favored paths : 1 (100.00%)            │
│ stage execs : 0&#x2F;-                   │  new edges on : 1 (100.00%)            │
│ total execs : 8                     │ total crashes : 0 (0 unique)           │
│  exec speed : 0.00&#x2F;sec (zzzz...)    │  total tmouts : 0 (0 unique)           │
├─ fuzzing strategy yields ───────────┴───────────────┬─ path geometry ────────┤
│   bit flips : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │    levels : 1          │
│  byte flips : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │   pending : 1          │
│ arithmetics : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │  pend fav : 1          │
│  known ints : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │ own finds : 0          │
│  dictionary : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │  imported : 0          │
│       havoc : 0&#x2F;0, 0&#x2F;0                              │ stability : 100.00%    │
│        trim : n&#x2F;a, n&#x2F;a                              ├────────────────────────┘
────────      if (not_on_tty) &#123;───────────────────────┘          [cpu000: 12%]
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>如果不是在终端环境下运行就输出当前循环周期并且刷新输出，确保立即显示</p>
</li>
<li><p>执行一次完整的扫描之后，新发现的路径数与执行之前的一样（没有发现任何新的路径），如果使用剪接，则增加无发现循环计数，否则启用剪接，如果不一样就将无发现循环计数置零</p>
</li>
<li><p>更新 prev_queued 路径数</p>
</li>
<li><p>如果设置了同步ID，并且是第一次循环，且设置了环境变量 AFL_IMPORT_FIRST，就调用 <a href="##sync_fuzzers">sync_fuzzers</a> 同步 fuzzer 状态</p>
</li>
</ul>
</li>
<li><p><a href="##fuzz_one">fuzz_one</a> 对 queue_cur 执行一次模糊测试，返回是否跳过</p>
</li>
<li><p>如果没有停止信号，有同步ID，没有跳过当前模糊测试，达到同步间隔（默认为5），就调用 sync_fuzzers 同步 fuzzer 状态</p>
</li>
<li><p>如果设置了单次执行标志（exit_1），设置即将停止标志</p>
</li>
<li><p>如果接收到停止信号，退出循环</p>
</li>
<li><p>移动到队列中的下一个条目，当前条目索引递增</p>
</li>
</ul>
</li>
<li><p>当前 queue 不为空，即未全部测试完，则显示当前状态</p>
</li>
<li><p><a href="##write_bitmap">write_bitmap</a> 保存当前trace_bits，用于记录目标程序的执行路径覆盖率</p>
</li>
<li><p><a href="##write_stats_file">write_stats_file</a> 更新 AFL 的统计信息文件 fuzzer_stats</p>
</li>
<li><p><a href="##save_auto">save_auto</a> 保存 AFL 自动生成的测试用例片段 auto extras</p>
</li>
<li><p>最后一段 stop_fuzzing 标签用于在停止 fuzz 的时候 goto 到这里结束程序</p>
<ul>
<li>输出中断信息</li>
<li>如果在第一个周期提醒用户测试在第一个周期内被中断，结果可能不完整，并提供了恢复测试的建议</li>
<li>关闭文件释放资源</li>
<li>输出结束信息并退出程序</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  s32 opt<span class="token punctuation">;</span>
  u64 prev_queued <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 之前排队的路径数，用于统计和同步</span>
  u32 sync_interval_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> seek_to<span class="token punctuation">;</span>  <span class="token comment">// 同步计数器和用于存储 seek 位置的变量</span>
  u8 <span class="token operator">*</span>extras_dir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 额外字典目录</span>
  u8 mem_limit_given <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 内存限制标志，表示是否提供了内存限制</span>
  u8 exit_1 <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_BENCH_JUST_ONE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 如果设置了环境变量 AFL_BENCH_JUST_ONE，则设置 exit_1 为 1，设置单次执行标志</span>
  <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> use_argv<span class="token punctuation">;</span>  <span class="token comment">// 存储命令行参数的数组</span>
    
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      
  <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-fuzz "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  doc_path <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span>DOC_PATH<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"docs"</span> <span class="token operator">:</span> DOC_PATH<span class="token punctuation">;</span>	<span class="token comment">// 检查文档路径是否存在，如果不存在则使用 "docs"，该文件夹下有 README，路径为 /usr/local/share/doc/afl</span>

  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tz<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">srandom</span><span class="token punctuation">(</span>tv<span class="token punctuation">.</span>tv_sec <span class="token operator">^</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">^</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"+i:o:f:m:t:T:dnCB:S:M:x:Q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>	<span class="token comment">//使用 getopt 解析命令行参数，例如 afl-fuzz -i fuzz_in -o fuzz_out ./afl_test -M fuzzer1</span>
    <span class="token comment">//:表示该选项需要一个参数，getopt 会返回解析到的选项字符，如果没有更多选项，则返回 -1。</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token char">'i'</span><span class="token operator">:</span> <span class="token comment">/* input dir */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>in_dir<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -i options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//已经指定过输入目录则报错</span>
        in_dir <span class="token operator">=</span> optarg<span class="token punctuation">;</span>	<span class="token comment">//指定输入目录</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>in_dir<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> in_place_resume <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//输入目录为 "-"，表示从当前目录恢复测试（in_place_resume）</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
            
      <span class="token keyword">case</span> <span class="token char">'o'</span><span class="token operator">:</span> <span class="token comment">/* output dir */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>out_dir<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -o options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out_dir <span class="token operator">=</span> optarg<span class="token punctuation">;</span>	<span class="token comment">//设置输出目录</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'M'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">//主节点同步 ID</span>
          u8<span class="token operator">*</span> c<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -S or -M options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          sync_id <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Synchronization 同步</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">,</span> <span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//格式示例：sync1:1/3，master_id = 1,master_max=3（主节点同步 ID 的最大值）</span>
            <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%u/%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>master_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>master_max<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">||</span>
                <span class="token operator">!</span>master_id <span class="token operator">||</span> <span class="token operator">!</span>master_max <span class="token operator">||</span> master_id <span class="token operator">></span> master_max <span class="token operator">||</span>
                master_max <span class="token operator">></span> <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bogus master ID passed to -M"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          force_deterministic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'S'</span><span class="token operator">:</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -S or -M options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sync_id <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//指定从属模块的同步 ID</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'f'</span><span class="token operator">:</span> <span class="token comment">/* target file */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -f options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out_file <span class="token operator">=</span> optarg<span class="token punctuation">;</span>	<span class="token comment">//指定目标程序的输入文件</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'x'</span><span class="token operator">:</span> <span class="token comment">/* dictionary */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>extras_dir<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -x options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        extras_dir <span class="token operator">=</span> optarg<span class="token punctuation">;</span>	<span class="token comment">//指定字典文件，用于指导模糊测试</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'t'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* timeout */</span>
          u8 suffix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -t options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token string">"%u%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>exec_tmout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>suffix<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span>	<span class="token comment">//设置目标程序的超时时间（单位为毫秒），不小于5ms</span>
              optarg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad syntax used for -t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Dangerously low value of -t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix <span class="token operator">==</span> <span class="token char">'+'</span><span class="token punctuation">)</span> timeout_given <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">else</span> timeout_given <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//可以带后缀 +，表示动态超时</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">case</span> <span class="token char">'m'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* mem limit */</span>
          u8 suffix <span class="token operator">=</span> <span class="token char">'M'</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit_given<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -m options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          mem_limit_given <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//有内存限制则设置 mem_limit_given 为 1</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            mem_limit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token string">"%llu%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mem_limit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>suffix<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span>
              optarg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad syntax used for -m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">switch</span> <span class="token punctuation">(</span>suffix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//设置目标程序的内存限制，可以带后缀 T / G / k / M，不小于5m，32位系统不大于2000m</span>
            <span class="token keyword">case</span> <span class="token char">'T'</span><span class="token operator">:</span> mem_limit <span class="token operator">*=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token char">'G'</span><span class="token operator">:</span> mem_limit <span class="token operator">*=</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token char">'k'</span><span class="token operator">:</span> mem_limit <span class="token operator">/=</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token char">'M'</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unsupported suffix or bad syntax for -m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Dangerously low value of -m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">></span> <span class="token number">2000</span><span class="token punctuation">)</span>
            <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Value of -m out of range on 32-bit systems"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'d'</span><span class="token operator">:</span> <span class="token comment">/* skip deterministic */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_deterministic<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -d options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        skip_deterministic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//跳过 AFL 的确定性变异阶段，直接进入随机变异阶段</span>
        use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'B'</span><span class="token operator">:</span> <span class="token comment">/* load bitmap */</span>
        <span class="token comment">//源码注释翻译：</span>
        <span class="token comment">//这是一个秘密的未记录选项！如果您在正常模糊测试过程中发现一个有趣的测试用例，并且想要对其进行变异而不重新发现在之前运行中已经发现的任何测试用例，则它很有用。</span>
		<span class="token comment">//要使用此模式，您需要将 -B 指向之前运行为完全相同的二进制文件生成的 fuzz_bitmap...</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>in_bitmap<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -B options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        in_bitmap <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
        <span class="token function">read_bitmap</span><span class="token punctuation">(</span>in_bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//加载之前运行生成的位图文件，用于跳过已发现的路径</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'C'</span><span class="token operator">:</span> <span class="token comment">/* crash mode */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -C options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        crash_mode <span class="token operator">=</span> FAULT_CRASH<span class="token punctuation">;</span>	<span class="token comment">//启用崩溃模式，AFL 只记录导致崩溃的测试用例</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'n'</span><span class="token operator">:</span> <span class="token comment">/* dumb mode */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -n options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_DUMB_FORKSRV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> dumb_mode <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">else</span> dumb_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//启用简单模式，AFL 不使用复杂的变异策略</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'T'</span><span class="token operator">:</span> <span class="token comment">/* banner */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_banner<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -T options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        use_banner <span class="token operator">=</span> optarg<span class="token punctuation">;</span>	<span class="token comment">//设置 AFL 的 banner 信息</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token char">'Q'</span><span class="token operator">:</span> <span class="token comment">/* QEMU mode */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -Q options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        qemu_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//启用 QEMU 模式，用于测试非原生二进制文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit_given<span class="token punctuation">)</span> mem_limit <span class="token operator">=</span> MEM_LIMIT_QEMU<span class="token punctuation">;</span>	<span class="token comment">//如果未设置内存限制，则默认为 QEMU 模式的内存限制</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//调用 usage 函数显示帮助信息并退出</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>optind <span class="token operator">==</span> argc <span class="token operator">||</span> <span class="token operator">!</span>in_dir <span class="token operator">||</span> <span class="token operator">!</span>out_dir<span class="token punctuation">)</span> <span class="token function">usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//检查是否提供了必要的参数（输入目录和输出目录），没有就调用 usage 函数显示帮助信息并退出</span>

  <span class="token function">setup_signal_handlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//注册信号处理函数</span>
  <span class="token function">check_asan_opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//读取ASAN_OPTIONS和MSAN_OPTIONS，进行一些检查</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token function">fix_up_sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//指定了sync_id就进行一些设置</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>in_dir<span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//限制输入文件夹和输出文件夹不能是同一个文件夹</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Input and output directories can't be the same"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//开启了简单模式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-C and -n are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//同时开启崩溃模式就报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_mode<span class="token punctuation">)</span>  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-Q and -n are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//同时开启qemu模式就报错</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">//处理环境变量</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_FORKSRV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    no_forkserver    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_CPU_RED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    no_cpu_meter_red <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//关闭 CPU 使用率的红色显示</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_ARITH"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      no_arith         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//禁用算术运算变异</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_SHUFFLE_QUEUE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> shuffle_queue    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//启用队列洗牌功能</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_FAST_CAL"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      fast_cal         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//启用快速校准模式，calibrate_case 函数只运行 3 次程序而不是原来默认的 8 次</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HANG_TMOUT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//挂起超时时间</span>
    hang_tmout <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HANG_TMOUT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hang_tmout<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Invalid value of AFL_HANG_TMOUT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//是0就报错</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> no_forkserver<span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"AFL_DUMB_FORKSRV and AFL_NO_FORKSRV are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//在 Linux 和 macOS 下预加载用户指定的库</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"LD_PRELOAD"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"DYLD_INSERT_LIBRARIES"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_LD_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//如果使用了已废弃的环境变量 AFL_LD_PRELOAD，则提示用户改用 AFL_PRELOAD</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Use AFL_PRELOAD instead of AFL_LD_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">save_cmdline</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//保存命令行参数，在保存崩溃信息的时候使用</span>

  <span class="token function">fix_up_banner</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新 use_banner</span>

  <span class="token function">check_if_tty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//根据环境变量 AFL_NO_UI 设置 not_on_tty 进而确定是界面显示还是逐行输出</span>

  <span class="token comment">//cpu操作</span>
  <span class="token function">get_core_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取核心数量</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_AFFINITY</span></span>
  <span class="token function">bind_to_free_cpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//绑定到一个空闲的 CPU，有助于提升多线程或多进程的性能</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* HAVE_AFFINITY */</span></span>

  <span class="token function">check_crash_handling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//crash的进程报告被发送给某个程序会导致延迟，crash可能被认为是超时，函数用于检查这种情况并且提醒用户</span>
  <span class="token function">check_cpu_governor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 若发现 cpu 频率可调，则建议用户把 cpu 定在最高频率</span>

  <span class="token function">setup_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 若指定了环境变量 AFL_POST_LIBRARY，则设置 post_handler 为 lib 中的 afl_postprocess 函数</span>
  <span class="token function">setup_shm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//初始化共享内存</span>
  <span class="token function">init_count_class16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//初始化 16bit 查找表</span>

  <span class="token comment">//文件操作</span>
  <span class="token function">setup_dirs_fds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 在工作目录下创建一些文件夹，并打开一些 fd 备用，例如 /dev/urandom</span>
  <span class="token function">read_testcases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 把初始 corpus 读入 queue</span>
  <span class="token function">load_auto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 读入自动生成的 extra</span>

  <span class="token function">pivot_inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 把初始 corpus 复制到工作目录的 queue 文件夹下</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>extras_dir<span class="token punctuation">)</span> <span class="token function">load_extras</span><span class="token punctuation">(</span>extras_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//用户通过 -x 指定了 dictionary，则从那里导入 extra</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout_given<span class="token punctuation">)</span> <span class="token function">find_timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 若是 in-place resume（通过 "-i -" 选项指定），则继承上次 fuzz 的 exec_timeout</span>

  <span class="token function">detect_file_args</span><span class="token punctuation">(</span>argv <span class="token operator">+</span> optind <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//判断目标程序，对文件名为 @@ 的情况进行特判</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_file<span class="token punctuation">)</span> <span class="token function">setup_stdio_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 创建 .cur_input 文件并打开，设为 out_fd。接下来 fuzzer 要把变异出的 input 写进这里，由 child 读取</span>

  <span class="token function">check_binary</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//检查目标程序</span>

  start_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取开始时间</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_mode<span class="token punctuation">)</span>
    use_argv <span class="token operator">=</span> <span class="token function">get_qemu_argv</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv <span class="token operator">+</span> optind<span class="token punctuation">,</span> argc <span class="token operator">-</span> optind<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取 qemu 模式使用的参数</span>
  <span class="token keyword">else</span>
    use_argv <span class="token operator">=</span> argv <span class="token operator">+</span> optind<span class="token punctuation">;</span>

  <span class="token function">perform_dry_run</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//执行输入文件夹中预先准备的所有测试用例，以确认目标程序是否按预期工作，只在初始输入时执行一次</span>

  <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//精简队列</span>

  <span class="token function">show_init_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 更新ui信息，使用ui界面展示</span>

  seek_to <span class="token operator">=</span> <span class="token function">find_start_position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从上次中断的地方继续进行模糊测试</span>

  <span class="token function">write_stats_file</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新 fuzzer_stats 文件，记录了 fuzzer 的当前状态</span>
  <span class="token function">save_auto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//保存 AFL 自动生成的测试用例片段 auto extras</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">goto</span> stop_fuzzing<span class="token punctuation">;</span>	<span class="token comment">//接收到用户中断指令则停止 fuzz</span>

  <span class="token comment">/* Woop woop woop */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>not_on_tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//暂停4s让用户看到ui信息</span>
    start_time <span class="token operator">+=</span> <span class="token number">4000</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">goto</span> stop_fuzzing<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">//第一轮 fuzz 结束后进行 fuzz 主循环</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    u8 skipped_fuzz<span class="token punctuation">;</span>
    <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//精简队列</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue_cur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//queue_cur 为空代表所有 queue 被执行了一遍</span>
      queue_cycle<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//完整执行次数</span>
      current_entry     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//从头开始下一轮 fuzz</span>
      cur_skipped_paths <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      queue_cur         <span class="token operator">=</span> queue<span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>seek_to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//检查seek_to是否为空，如果不为空，就从seek_to指定的queue项即从上次中断的地方继续进行模糊测试</span>
        current_entry<span class="token operator">++</span><span class="token punctuation">;</span>
        seek_to<span class="token operator">--</span><span class="token punctuation">;</span>
        queue_cur <span class="token operator">=</span> queue_cur<span class="token operator">-></span>next<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//刷新ui</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>not_on_tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果不是在终端环境下运行</span>
        <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Entering queue cycle %llu."</span><span class="token punctuation">,</span> queue_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 输出当前循环周期</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 刷新输出，确保立即显示</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">//源码注释翻译：如果我们有一个完整的队列周期而没有新发现，请接下来尝试重组策略</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>queued_paths <span class="token operator">==</span> prev_queued<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//执行一次完整的扫描之后，新发现的路径数与执行之前的一样，这代表没有发现任何新的路径</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_splicing<span class="token punctuation">)</span> 
            cycles_wo_finds<span class="token operator">++</span><span class="token punctuation">;</span> 
        <span class="token keyword">else</span> 
            use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">// 如果使用剪接，则增加无发现循环计数，否则启用剪接</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> 
          cycles_wo_finds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// 重置无发现循环计数</span>

      prev_queued <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span>	<span class="token comment">//更新路径</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id <span class="token operator">&amp;&amp;</span> queue_cycle <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_IMPORT_FIRST"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//如果设置了同步ID，并且是第一次循环，且设置了环境变量AFL_IMPORT_FIRST</span>
        <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 同步fuzzer状态</span>
    <span class="token punctuation">&#125;</span>

    skipped_fuzz <span class="token operator">=</span> <span class="token function">fuzz_one</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 对queue_cur执行一次模糊测试，返回是否跳过</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> sync_id <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skipped_fuzz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sync_interval_cnt<span class="token operator">++</span> <span class="token operator">%</span> SYNC_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 如果没有停止信号，有同步ID，没有跳过当前模糊测试，达到同步间隔，就同步fuzzer状态（SYNC_INTERVAL默认为5）</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> exit_1<span class="token punctuation">)</span> stop_soon <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>	<span class="token comment">// 如果设置了单次执行标志，设置即将停止标志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>	<span class="token comment">// 如果接收到停止信号，退出循环</span>

    queue_cur <span class="token operator">=</span> queue_cur<span class="token operator">-></span>next<span class="token punctuation">;</span>	<span class="token comment">// 移动到队列中的下一个条目</span>
    current_entry<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">// 当前条目索引递增</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cur<span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//当前 queue 不为空，即未全部测试完，则显示当前状态</span>

  <span class="token function">write_bitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//保存当前trace_bits，用于记录目标程序的执行路径覆盖率</span>
  <span class="token function">write_stats_file</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//更新 AFL 的统计信息文件 fuzzer_stats</span>
  <span class="token function">save_auto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//保存 AFL 自动生成的测试用例片段 auto extras</span>

<span class="token comment">//终止fuzz，关闭文件释放资源后退出程序</span>
stop_fuzzing<span class="token operator">:</span>
  <span class="token function">SAYF</span><span class="token punctuation">(</span>CURSOR_SHOW cLRD <span class="token string">"\n\n+++ Testing aborted %s +++\n"</span> cRST<span class="token punctuation">,</span>
       stop_soon <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">"programmatically"</span> <span class="token operator">:</span> <span class="token string">"by user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//输出中断信息</span>

  <span class="token comment">/* Running for more than 30 minutes but still doing first cycle? */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cycle <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time <span class="token operator">></span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//检查是否在第一个周期内中断</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cYEL <span class="token string">"[!] "</span> cRST
           <span class="token string">"Stopped during the first cycle, results may be incomplete.\n"</span>
           <span class="token string">"    (For info on resuming, see %s/README.)\n"</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//提醒用户测试在第一个周期内被中断，结果可能不完整，并提供了恢复测试的建议</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">fclose</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">destroy_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">destroy_extras</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">alloc_report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"We're done here. Have a nice day!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* !AFL_LIB */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h3><p>注册必要的信号处理函数</p>
<ul>
<li>SIGHUP，由一个处于非连接状态的终端发送给控制进程，或者由控制进程在自身结束时发送给每个前台进程</li>
<li>SIGINT，一般由从终端敲入的 Crl+C 组合键或预先设置好的中断字符产生</li>
<li>SIGTERM，作为一个请求被发送，要求进程结束运行。UNIX在关机时用这个信号要求系统服务停止运行。它是kill命今默认发送的信号</li>
<li>SIGALRM，由alarm函数设置的定时器产生</li>
<li>SIGWINCH，处理窗口大小的变化信号</li>
<li>SIGPIPE，如果在向管道写数据时没有与之对应的读进程，就会产生这个信号</li>
<li>SIGUSR1，进程之问可以用这个信号进行通信，例如让进程报告状态信息等</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">setup_signal_handlers</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>

  sa<span class="token punctuation">.</span>sa_handler   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  sa<span class="token punctuation">.</span>sa_flags     <span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
  sa<span class="token punctuation">.</span>sa_sigaction <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Various ways of saying "stop". */</span>
  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_stop_sig<span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGHUP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Exec timeout notifications. */</span>
  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_timeout<span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Window resize */</span>
  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_resize<span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGWINCH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* SIGUSR1: skip entry */</span>
  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_skipreq<span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Things we don't care about. */</span>
  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_IGN<span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGTSTP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>相关信号处理函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Handle stop signal (Ctrl-C, etc). */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_stop_sig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  stop_soon <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">kill</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>forksrv_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">kill</span><span class="token punctuation">(</span>forksrv_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Handle skip request (SIGUSR1). */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_skipreq</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  skip_requested <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Handle timeout (SIGALRM). */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_timeout</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    child_timed_out <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
    <span class="token function">kill</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> forksrv_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    child_timed_out <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
    <span class="token function">kill</span><span class="token punctuation">(</span>forksrv_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Handle screen resize (SIGWINCH). */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_resize</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  clear_screen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h3><p>获取环境变量中的 ASAN_OPTIONS 和 MSAN_OPTIONS，如果选项中不包含要求项则输出报错信息并结束程序</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_asan_opts</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  u8<span class="token operator">*</span> x <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"abort_on_error=1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//告诉 ASAN 在检测到错误时应该终止程序，而不是继续执行。</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom ASAN_OPTIONS set without abort_on_error=1 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"symbolize=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//当 ASAN/MSAN 检测到错误时，会尝试使用符号化的堆栈跟踪来显示错误位置。设置为 0 表示禁用此行为，这通常用于自动化测试或当符号化工具不可用时</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom ASAN_OPTIONS set without symbolize=0 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  x <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//设置 MSAN 在检测到内存错误时应返回的退出代码</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom MSAN_OPTIONS set without exit_code="</span>
            <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">" - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"symbolize=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom MSAN_OPTIONS set without symbolize=0 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h3><p>如果通过 -M 或 -S 指定了 sync_id，验证并调整使用 -S 时的 out_dir 和 sync_dir</p>
<ul>
<li>指定了 dumb 模式则不能同时使用 -S 或 -M，使用了就报错退出</li>
<li>遍历 sync_id 限制其只能包含字母数字、下划线或连字符，且长度不大于 32</li>
<li>更新 out_dir 为 out_dir&#x2F;sync_id，原来的 out_dir 保存在 sync_dir</li>
<li>如果没有强制确定性模式，则自动跳过确定性变异，并启用拼接策略，增加随机性和覆盖范围</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fix_up_sync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> x <span class="token operator">=</span> sync_id<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode<span class="token punctuation">)</span>
    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-S / -M and -n are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_deterministic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//指定跳过确定性变异</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>force_deterministic<span class="token punctuation">)</span>	<span class="token comment">//强制要求确定性变异</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"use -S instead of -M -d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//提示使用 -S 替代 -M -d，因为 -M 模式首先执行确定性变异而 -d 模式会跳过确定性变异，因此会报错选项冲突</span>
    <span class="token keyword">else</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-S already implies -d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//如果同时开启 -S 和 -d，提示 -S 包含了 -d</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isalnum</span><span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char">'_'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span>	<span class="token comment">//遍历 sync_id，存在数字字母、-、_ 以外的字符就报错</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Non-alphanumeric fuzzer ID specified via -S or -M"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    x<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fuzzer ID too long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//限制长度不大于 32</span>

  x <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> sync_id<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将 out_dir 和 sync_id 组合成 out_dir/sync_id 的形式成为新的 out_dir</span>

  sync_dir <span class="token operator">=</span> out_dir<span class="token punctuation">;</span>	<span class="token comment">//sync_dir 设置为原来的 out_dir，同步目录为 out</span>
  out_dir  <span class="token operator">=</span> x<span class="token punctuation">;</span>	<span class="token comment">//当前 fuzz 的输出目录为 out/fuzzer1</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force_deterministic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 如果没有强制确定性模式</span>
    skip_deterministic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//自动跳过确定性变异</span>
    use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//启用拼接策略</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="save-cmdline"><a href="#save-cmdline" class="headerlink" title="save_cmdline"></a>save_cmdline</h3><p>将当前输入参数拷贝进 buf 空间中，并且在末尾加 \x00，最终堆中复制的内容为：<code>/home/starrysky/AFL/afl-fuzz -i in -o out -M fuzzer1 ./test\x00</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_cmdline</span><span class="token punctuation">(</span>u32 argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> buf<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    len <span class="token operator">+=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//遍历每个参数，加上参数长度 +1</span>
  
  buf <span class="token operator">=</span> orig_cmdline <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建对应长度大小的堆</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    u32 l <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将每个参数都拷贝进去</span>
    buf <span class="token operator">+=</span> l<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span>buf<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>	<span class="token comment">//如果不是最后一个参数就在参数后面加空格</span>
  <span class="token punctuation">&#125;</span>

  <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//末尾加上 \x00</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="fix-up-banner"><a href="#fix-up-banner" class="headerlink" title="fix_up_banner"></a>fix_up_banner</h3><p>未设置 use_banner 则设置为不含路径的测试程序名，如果程序名长度超过 40，则取前 40 位</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fix_up_banner</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>use_banner<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//未设置 use_banner</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//设置了 sync_id</span>
      use_banner <span class="token operator">=</span> sync_id<span class="token punctuation">;</span>	<span class="token comment">//use_banner 设置为 sync_id，即 fuzzer1</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      u8<span class="token operator">*</span> trim <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//trim 设置为 name 最后一个 / 的位置</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trim<span class="token punctuation">)</span> use_banner <span class="token operator">=</span> name<span class="token punctuation">;</span>	<span class="token comment">//没有 / 就将 use_banner 设置为 name 即测试文件名</span>
      	<span class="token keyword">else</span> use_banner <span class="token operator">=</span> trim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//有 / use_banner 就设置为 / 后一个开始的文件名</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>use_banner<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果长度超过 40，只保留前 40</span>
    u8<span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"%.40s..."</span><span class="token punctuation">,</span> use_banner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    use_banner <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="check-if-tty"><a href="#check-if-tty" class="headerlink" title="check_if_tty"></a>check_if_tty</h3><p>设置了环境变量 AFL_NO_UI 或者 ioctl 获取终端窗口大小错误码是 ENOTTY 则表示非 tty 终端运行，禁用 UI 设置 not_on_tty &#x3D; 1</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_if_tty</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">winsize</span> ws<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_UI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果设置了 AFL_NO_UI 则禁用 UI 并且设置 not_on_tty = 1</span>
    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Disabling the UI because AFL_NO_UI is set."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    not_on_tty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> TIOCGWINSZ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//获取终端窗口大小</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOTTY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//如果出错，检查错误码是否为 ENOTTY</span>
      <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Looks like we're not running on a tty, so I'll be a bit less verbose."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//提示不在终端环境中</span>
      not_on_tty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="get-core-count"><a href="#get-core-count" class="headerlink" title="get_core_count"></a>get_core_count</h3><p>获取 cpu 的核心数量</p>
<ul>
<li><p>如果定义了 HAVE_AFFINITY，通过 sysconf(_SC_NPROCESSORS_ONLN) 获取核心数</p>
</li>
<li><p>如果未定义 HAVE_AFFINITY，通过读取 &#x2F;proc&#x2F;stat 文件来统计 CPU 核心数量</p>
<ul>
<li><p>&#x2F;proc&#x2F;stat 文件包含了系统统计信息，其中以 cpu 开头的行表示 CPU 核心</p>
</li>
<li><p>每读取到一行以 cpu 开头且后面跟着数字的行，cpu_core_count 就加 1</p>
</li>
</ul>
</li>
<li><p>调用 get_runnable_processes 获取当前系统中可运行的任务数量</p>
</li>
<li><p>输出提示: [+] You have 16 CPU cores and 2 runnable tasks (utilization: 12%).</p>
</li>
<li><p>如果当前可运行任务数量超过 CPU 核心数量的 1.5 倍，提示系统负载过高，可能会影响性能</p>
</li>
<li><p>如果当前可运行任务数量加上当前进程仍然小于等于 CPU 核心数量，提示用户可以尝试并行任务以提高效率</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Try parallel <span class="token function">jobs</span> - see /usr/local/share/doc/afl/parallel_fuzzing.txt.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>如果 cpu_core_count 为 0，表示无法检测到 CPU 核心数量，输出警告信息</p>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">get_core_count</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 cur_runnable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__APPLE__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span> <span class="token punctuation">(</span>__OpenBSD__<span class="token punctuation">)</span></span></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_AFFINITY</span></span>
		cpu_core_count <span class="token operator">=</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_NPROCESSORS_ONLN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  		FILE<span class="token operator">*</span> f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/proc/stat"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开 /proc/stat</span>
  		u8 tmp<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//逐行读取</span>
    		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"cpu"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isdigit</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cpu_core_count<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//如果读到 cpu ,核心数 +1</span>

  		<span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^HAVE_AFFINITY */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^(__APPLE__ || __FreeBSD__ || __OpenBSD__) */</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu_core_count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    cur_runnable <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token function">get_runnable_processes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取当前系统中可运行的任务数量</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__APPLE__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span> <span class="token punctuation">(</span>__OpenBSD__<span class="token punctuation">)</span></span></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ || __FreeBSD__ || __OpenBSD__ */</span></span>

    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"You have %u CPU core%s and %u runnable tasks (utilization: %0.0f%%)."</span><span class="token punctuation">,</span>
        cpu_core_count<span class="token punctuation">,</span> cpu_core_count <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">"s"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        cur_runnable<span class="token punctuation">,</span> cur_runnable <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> cpu_core_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//本例输出：[+] You have 16 CPU cores and 1 runnable tasks (utilization: 6%).</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu_core_count <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_runnable <span class="token operator">></span> cpu_core_count <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"System under apparent load, performance may be spotty."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//如果当前可运行任务数量超过 CPU 核心数量的 1.5 倍，提示系统负载过高，可能会影响性能</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_runnable <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> cpu_core_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Try parallel jobs - see %s/parallel_fuzzing.txt."</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//如果当前可运行任务数量加上当前进程仍然小于等于 CPU 核心数量，提示用户可以尝试并行任务以提高效率</span>
        <span class="token comment">//本例会提示:[+] Try parallel jobs - see /usr/local/share/doc/afl/parallel_fuzzing.txt.</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    cpu_core_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Unable to figure out the number of CPU cores."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//如果 cpu_core_count 为 0，表示无法检测到 CPU 核心数量，输出警告信息</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="bind-to-free-cpu"><a href="#bind-to-free-cpu" class="headerlink" title="bind_to_free_cpu"></a>bind_to_free_cpu</h3><p>检查是否有空闲的核心，如果有的话就绑定到空闲 cpu，有助于提升多线程或多进程的性能</p>
<h3 id="check-crash-handling"><a href="#check-crash-handling" class="headerlink" title="check_crash_handling"></a>check_crash_handling</h3><p>确保核心转储不会进入程序</p>
<blockquote>
<p><code>/proc/sys/kernel/core_pattern</code> 是一个特殊的文件，用于控制 Linux 系统中核心转储文件的生成方式：</p>
<ul>
<li>如果文件内容是一个简单的字符串（如 <code>core</code>），系统会在程序崩溃时生成一个名为 <code>core</code> 或 <code>core.&lt;pid&gt;</code> 的文件</li>
<li>如果文件内容以 <code>|</code> 开头，系统会将核心转储信息发送到一个外部工具（例如 <code>coredumpctl</code> 或其他日志工具</li>
</ul>
</blockquote>
<p>如果<code>/proc/sys/kernel/core_pattern</code>中含有<code>|</code>说明会将核心转储通知发送到外部工具,导致的延迟可能被认为是超时,所以为了避免这种情况,如果存在<code>|</code>就会提示用户需要执行<code>echo core &gt;/proc/sys/kernel/core_pattern</code>，该文件每次重启后会变成 <code>|/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E</code></p>
<p>如果设置了环境变量 <code>AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES</code>会忽略<code>|</code>的问题</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_crash_handling</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>

  s32 fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/sys/kernel/core_pattern"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  u8  fchar<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Checking core_pattern..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fchar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> fchar <span class="token operator">==</span> <span class="token char">'|'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//检查是否有 |</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Hmm, your system is configured to send core dump notifications to an\n"</span>
         <span class="token string">"    external utility. This will cause issues: there will be an extended delay\n"</span>
         <span class="token string">"    between stumbling upon a crash and having this information relayed to the\n"</span>
         <span class="token string">"    fuzzer via the standard waitpid() API.\n\n"</span>

         <span class="token string">"    To avoid having crashes misinterpreted as timeouts, please log in as root\n"</span> 
         <span class="token string">"    and temporarily modify /proc/sys/kernel/core_pattern, like so:\n\n"</span>

         <span class="token string">"    echo core >/proc/sys/kernel/core_pattern\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//有则输出提示</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//如果设置了 AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES 就忽略这个问题</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Pipe at the beginning of 'core_pattern'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//未设置则强制退出要求用户设置</span>
  <span class="token punctuation">&#125;</span>
 
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__APPLE__ */</span></span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="check-cpu-governor"><a href="#check-cpu-governor" class="headerlink" title="check_cpu_governor"></a>check_cpu_governor</h3><p>若发现 cpu 频率可调，则建议用户把 cpu 定在最高频率</p>
<h3 id="setup-post"><a href="#setup-post" class="headerlink" title="setup_post"></a>setup_post</h3><p>如果没有设置 AFL_POST_LIBRARY 这个环境变量则直接返回，设置了就加载 afl_postprocess函数，用于处理由 AFL 生成的模糊测试数据</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setup_post</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">void</span><span class="token operator">*</span> dh<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_POST_LIBRARY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取环境变量中的 AFL_POST_LIBRARY</span>
  u32 tlen <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//不存在则直接返回</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Loading postprocessor from '%s'..."</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//提示从这个库中加载 postprocessor</span>

  dh <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开库</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dh<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//打开失败则报错</span>

  post_handler <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>dh<span class="token punctuation">,</span> <span class="token string">"afl_postprocess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//查找库中的函数 afl_postprocess</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>post_handler<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Symbol 'afl_postprocess' not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//没找到则报错</span>

  <span class="token function">post_handler</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tlen<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//测试函数是否正常运行</span>

  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Postprocessor installed successfully."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//提示加载成功</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="setup-shm"><a href="#setup-shm" class="headerlink" title="setup_shm"></a>setup_shm</h3><p>设置共享内存</p>
<ul>
<li>初始化 virgin_tmout、 virgin_crash 为 0xff，in_bitmap 为空则 virgin_bits 也初始化为 0xff</li>
<li>shmget 创建共享内存段，创建失败则报错退出</li>
<li>注册退出的回调函数 <a href="##remove_shm">remove_shm</a> 用于在程序退出时清理共享内存</li>
<li>将创建内存段得到的共享内存标识符转换成字符串保存到环境变量 SHM_ENV_VAR 中再释放字符串内存</li>
<li>shmat 将共享内存附加到当前进程的地址空间，失败则报错退出</li>
</ul>
<blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数</p>
<ul>
<li>key：标识共享内存段的键值	<ul>
<li>IPC_PRIVATE：创建一个新的共享内存段，不会与任何键值关联</li>
<li>大于 0 的整数：通过 fork函数生成，用于标识共享内存段</li>
</ul>
</li>
<li>size：指定共享内存段的大小，单位是字节</li>
<li>shmflg：指定共享内存段的权限和操作标志<ul>
<li>IPC_CREAT：如果键值对应的共享内存段不存在，则创建一个新的共享内存段</li>
<li>IPC_EXCL：如果共享内存段已存在，则返回错误</li>
<li>访问权限标志（eg. 0666 &#x2F; 0644 &#x2F; 0600）：设置共享内存段的访问权限</li>
<li>SHM_HUGETLB：使用大页面分配共享内存，提高性能</li>
<li>SHM_NORESERVE：不为共享内存段在交换分区中保留空间</li>
</ul>
</li>
</ul>
<p>返回值</p>
<ul>
<li>成功时返回共享内存段的标识符（<code>shmid</code>），用于后续操作</li>
<li>失败时返回 <code>-1</code>，并设置 <code>errno</code></li>
</ul>
</blockquote>
<blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数</p>
<ul>
<li>shmid：共享内存段的标识符</li>
<li>shmaddr：指定共享内存段映射到进程地址空间的地址<ul>
<li>NULL：系统自动选择合适地址</li>
<li>地址：要求 shmflg 设置 SHM_RND，地址会向下取整为 SHMLBA 的整数倍，地址必须是页对齐的</li>
</ul>
</li>
<li>shmflg：用于指定映射的标志<ul>
<li>0：默认方式可读写</li>
<li>SHM_RDONLY：只读</li>
<li>SHM_REMAP：重新映射共享内存，要求 shmaddr 不能为 NULL</li>
</ul>
</li>
</ul>
<p>返回值</p>
<ul>
<li>成功时返回指向共享内存段起始地址的指针</li>
<li>失败时返回 (void *)-1，并设置 errno</li>
</ul>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">setup_shm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> shm_str<span class="token punctuation">;</span>
    
  <span class="token comment">//初始化 virgin_bits、 virgin_tmout、 virgin_crash 为 0xff</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_bitmap<span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">memset</span><span class="token punctuation">(</span>virgin_tmout<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>virgin_crash<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  shm_id <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> IPC_EXCL <span class="token operator">|</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 创建共享内存段，大小为 MAP_SIZE，模式为只有创建者有访问权限，将返回的共享内存标识符保存到shm_id里</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shm_id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"shmget() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//共享内存标识符小于0，创建失败报错</span>

  <span class="token function">atexit</span><span class="token punctuation">(</span>remove_shm<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 注册退出时的回调函数，以确保在程序退出时清理共享内存</span>

  shm_str <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> shm_id<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//共享内存标识符数值转成字符串</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token function">setenv</span><span class="token punctuation">(</span>SHM_ENV_VAR<span class="token punctuation">,</span> shm_str<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//不是 dumb 模式就设置环境变量 SHM_ENV_VAR 为共享内存标识符数值转的字符串</span>

  <span class="token function">ck_free</span><span class="token punctuation">(</span>shm_str<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//释放字符串内存</span>

  trace_bits <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 将共享内存段附加到当前进程的地址空间，trace_bits 指向共享内存第一个字节的指针，此处得到内存地址为 0x7ffff7fb9000</span>
  <span class="token comment">//0x7ffff7fb9000     0x7ffff7fc9000 rw-p    10000      0 /SYSV00000000 (deleted)</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trace_bits<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">" () failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//附加失败则报错退出</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="remove-shm"><a href="#remove-shm" class="headerlink" title="remove_shm"></a>remove_shm</h3><p>对应 setup_shm 创建共享内存段，该函数用于删除共享内存段</p>
<blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数</p>
<ul>
<li>shmid：共享内存段的标识符</li>
<li>cmd：控制命令<ul>
<li>IPC_RMID：删除共享内存段。当所有进程都分离后，共享内存段会被销毁</li>
<li>IPC_STAT：获取共享内存段的当前状态信息，并将这些信息存储到 buf 指向的 struct shmid_ds 结构体中</li>
<li>IPC_SET：设置共享内存段的某些属性，这些属性通常存储在 buf 指向的 struct shmid_ds 结构体中</li>
<li>IPC_INFO：获取关于共享内存的系统限制值信息</li>
<li>SHM_INFO：获取系统为共享内存消耗的资源信息</li>
<li>SHM_LOCK：禁止系统将共享内存段交换至 swap 分区</li>
<li>SHM_UNLOCK：允许系统将共享内存段交换至 swap 分区</li>
</ul>
</li>
<li>buf：指向 <code>struct shmid_ds</code> 结构体的指针，用于存储或获取共享内存段的属性信息</li>
</ul>
<p>返回值</p>
<ul>
<li>成功时返回 <code>0</code></li>
<li>失败时返回 <code>-1</code>，并设置 <code>errno</code></li>
</ul>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">remove_shm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">shmctl</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//删除共享内存段，进程分离后销毁内存段</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="init-count-class16"><a href="#init-count-class16" class="headerlink" title="init_count_class16"></a>init_count_class16</h3><p>count_class_lookup8 将路径命中数进行规整，例如 4-7 次计数为 8</p>
<p>count_class_lookup16 因为 AFL 中对于一条分支径的表示是由一个二元组，例如 A-&gt;B-&gt;C：[A,B],[B,C],[C,D]</p>
<p>count_class_lookup16 初始化结果：遍历所有二元组的组合（0-255），组合成一个数值</p>
<ul>
<li>例如 [3,20] -&gt; count_class_lookup8：[4,32(0x20)] -&gt; count_class_lookup16：0x0420</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> u8 count_class_lookup8<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>

  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">4</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">7</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">8</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">15</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">16</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">31</span><span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">32</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">127</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">128</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">128</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> u16 count_class_lookup16<span class="token punctuation">[</span><span class="token number">65536</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


EXP_ST <span class="token keyword">void</span> <span class="token function">init_count_class16</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  u32 b1<span class="token punctuation">,</span> b2<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>b1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b1 <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> b1<span class="token operator">++</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> <span class="token punctuation">(</span>b2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b2 <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> b2<span class="token operator">++</span><span class="token punctuation">)</span>
      count_class_lookup16<span class="token punctuation">[</span><span class="token punctuation">(</span>b1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> b2<span class="token punctuation">]</span> <span class="token operator">=</span> 
        <span class="token punctuation">(</span>count_class_lookup8<span class="token punctuation">[</span>b1<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        count_class_lookup8<span class="token punctuation">[</span>b2<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="setup-dirs-fds"><a href="#setup-dirs-fds" class="headerlink" title="setup_dirs_fds"></a>setup_dirs_fds</h3><p>在工作目录创建一些文件夹，打开一些文件以获取 fd</p>
<ul>
<li>如果设置了 sync_id 就创建 sync_dir 权限 0700，失败就报错退出</li>
<li>创建 out_dir 文件夹权限 0700<ul>
<li>创建失败且文件不存在，报错创建失败</li>
<li>创建失败但文件存在，调用 maybe_delete_out_dir 删除 out_dir 里旧的东西</li>
<li>创建成功但是设置了 in_place_resume 则报错退出</li>
</ul>
</li>
<li>只读方式打开 out_dir 获得 out_dir_fd</li>
<li>没有定义宏 __sun 且 out_dir 打开失败或通过flock建立互斥锁定失败则报错退出</li>
<li>out_dir 目录下创建文件夹 queue、.synced（sync_id存在时）、crashes、hangs、plot_data，权限为 0700 创建失败则报错退出</li>
<li>queue 文件夹下创建 .state：保存用于 session resume 和 related tasks 的queue metadata，并以 0700 的权限在其中创建：<ul>
<li>deterministic_done：标记过去经历过deterministic fuzzing的queue entries</li>
<li>auto_extras：存储自动选择的字典条目</li>
<li>redundant_edges：存储当前被认为是冗余的路径</li>
<li>variable_behavior：存储显示可变行为的路径</li>
</ul>
</li>
<li>打开 &#x2F;dev&#x2F;null（读写）、&#x2F;dev&#x2F;urandom（只读）得到对应的 fd</li>
<li>打开或不存在时创建 plot_data（只写） 得到对应的 fd，获取句柄，根据句柄得到 FILE* plot_file，并向里写入 <code># unix_time, cycles_done, cur_path, paths_total, pending_total, pending_favs, map_size, unique_crashes, unique_hangs, max_depth, execs_per_sec</code></li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">setup_dirs_fds</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u8<span class="token operator">*</span> tmp<span class="token punctuation">;</span>
  s32 fd<span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Setting up output directories..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span><span class="token punctuation">(</span>sync_dir<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建失败且文件不存在，报错创建失败</span>
    <span class="token function">maybe_delete_out_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建失败但文件存在，调用 maybe_delete_out_dir 删除 out_dir 里旧的东西</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Resume attempted but old output directory not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建成功但是设置了 in_place_resume 则报错退出</span>
      
    out_dir_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//只读方式打开 out_dir 获得 out_dir_fd</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__sun</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>out_dir_fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">flock</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">,</span> LOCK_EX <span class="token operator">|</span> LOCK_NB<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to flock() output directory."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//没有定义宏 __sun 且 out_dir 打开失败或通过flock建立互斥锁定失败则报错退出</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* !__sun */</span></span>

  <span class="token punctuation">&#125;</span>

  <span class="token comment">//创建文件夹、打开文件</span>
  <span class="token comment">/* Queue directory for any starting &amp; discovered paths. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Top-level directory for queue metadata used for session
     resume and related tasks. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Directory for flagging queue entries that went through
     deterministic fuzzing in the past. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/deterministic_done/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Directory with the auto-selected dictionary entries. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/auto_extras/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* The set of paths currently deemed redundant. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/redundant_edges/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* The set of paths showing variable behavior. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/variable_behavior/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Sync directory for keeping track of cooperating fuzzers. */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.synced/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_place_resume <span class="token operator">||</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">/* All recorded crashes. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* All recorded hangs. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Generally useful file descriptors. */</span>
  dev_null_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_null_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open /dev/null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  dev_urandom_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_urandom_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open /dev/urandom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* Gnuplot output file. */</span>
  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/plot_data"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

  plot_file <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plot_file<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">fprintf</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">,</span> <span class="token string">"# unix_time, cycles_done, cur_path, paths_total, "</span>
                     <span class="token string">"pending_total, pending_favs, map_size, unique_crashes, "</span>
                     <span class="token string">"unique_hangs, max_depth, execs_per_sec\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token comment">/* ignore errors */</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read_testcases"></a>read_testcases</h3><ul>
<li>检查 in_dir 文件夹是否存在 queue 文件夹，存在则 in_dir &#x3D; in_dir&#x2F;queue</li>
<li>扫描 in_dir 将结果（包括 . ..）保存到 nl，数量保存到 nl_cnt<ul>
<li>扫描数量为 0 时报错打开失败，如果目录或文件不存在或路径不是目录时提示输入目录无效</li>
</ul>
</li>
<li>shuffle_queue 为真且扫描数量大于 1 则调用 shuffle_ptrs 重排nl里的指针的位置</li>
<li>循环检索扫描到的文件，获取 in_dir&#x2F;文件名 和 in_dir&#x2F;.state&#x2F;deterministic_done&#x2F;文件名 这两个字符串，并且释放对应 nl 空间</li>
<li>检查文件状态，异常则报错退出；检测并跳过目录、设备文件、空文件、README文件</li>
<li>文件大小大于 MAX_FILE 则报错退出</li>
<li>in_dir&#x2F;.state&#x2F;deterministic_done&#x2F;文件名 能打开则设置 passed_det &#x3D; 1，用来判断是否这个入口已经完成deterministic fuzzing，在恢复异常终止的扫描时不想重复进行deterministic fuzzing</li>
<li><a href="##add_to_queue">add_to_queue</a> 将测试用例加入 queue</li>
<li>queued_paths 为 0，提示需要一个或多个 1kb 以内的测试用例，输入目录中没有可用的测试用例</li>
<li>设置 last_path_time &#x3D; 0，queued_at_start &#x3D; queued_paths</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_testcases</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token operator">*</span>nl<span class="token punctuation">;</span>
  s32 nl_cnt<span class="token punctuation">;</span>
  u32 i<span class="token punctuation">;</span>
  u8<span class="token operator">*</span> fn<span class="token punctuation">;</span>
    
  fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> in_dir <span class="token operator">=</span> fn<span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//检查 in_dir 文件夹是否存在 queue 文件夹，存在则 in_dir = in_dir/queue</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Scanning '%s'..."</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

  nl_cnt <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span>in_dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nl<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> alphasort<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//扫描 in_dir 将结果保存到 nl，数量保存到 nl_cnt，本例中 nl_cnt = 3（. .. testcase)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>nl_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//扫描数量为 0 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOENT <span class="token operator">||</span> errno <span class="token operator">==</span> ENOTDIR<span class="token punctuation">)</span>	<span class="token comment">//目录或文件不存在或路径不是目录时提示输入目录无效</span>
      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
           <span class="token string">"The input directory does not seem to be valid - try again. The fuzzer needs\n"</span>
           <span class="token string">"    one or more test case to start with - ideally, a small file under 1 kB\n"</span>
           <span class="token string">"    or so. The cases must be stored as regular files directly in the input\n"</span>
           <span class="token string">"    directory.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shuffle_queue <span class="token operator">&amp;&amp;</span> nl_cnt <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Shuffling queue..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">shuffle_ptrs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>nl<span class="token punctuation">,</span> nl_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//shuffle_queue 为真且扫描数量大于 1 则调用 shuffle_ptrs 重排 nl 里的指针的位置</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>
	
    <span class="token comment">//获取 in_dir/文件名 和 in_dir/.state/deterministic_done/文件名 这两个字符串</span>
    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    u8<span class="token operator">*</span> dfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.state/deterministic_done/%s"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    u8  passed_det <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">free</span><span class="token punctuation">(</span>nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//释放对应 nl 空间</span>
 	
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lstat</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">////检查文件状态，异常则报错退出</span>
      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to access '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>st<span class="token punctuation">.</span>st_size <span class="token operator">||</span> <span class="token function">strstr</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"/README.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//检测并跳过目录、设备文件、空文件、README文件</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>dfn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size <span class="token operator">></span> MAX_FILE<span class="token punctuation">)</span> 	<span class="token comment">//文件大小大于 MAX_FILE 则报错退出</span>
      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' is too big (%s, limit is %s)"</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span>
            <span class="token function">DMS</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DMS</span><span class="token punctuation">(</span>MAX_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>dfn<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> passed_det <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//in_dir/.state/deterministic_done/文件名 能打开则设置 passed_det = 1</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>dfn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">add_to_queue</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> passed_det<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//将测试用例加入 queue</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">free</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queued_paths<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//queued_paths 为 0，提示需要一个或多个 1kb 以内的测试用例，输入目录中没有可用的测试用例</span>
    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST
         <span class="token string">"Looks like there are no valid test cases in the input directory! The fuzzer\n"</span>
         <span class="token string">"    needs one or more test case to start with - ideally, a small file under\n"</span>
         <span class="token string">"    1 kB or so. The cases must be stored as regular files directly in the\n"</span>
         <span class="token string">"    input directory.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No usable test cases in '%s'"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  last_path_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  queued_at_start <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span>	<span class="token comment">//queueed_at_start = 队列元素数量</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="add-to-queue"><a href="#add-to-queue" class="headerlink" title="add_to_queue"></a>add_to_queue</h3><p>queue_entry结构体如下</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token operator">*</span>queue<span class="token punctuation">,</span>     <span class="token comment">/* Fuzzing queue (linked list)      */</span>
                          <span class="token operator">*</span>queue_cur<span class="token punctuation">,</span> <span class="token comment">/* Current offset within the queue  */</span>
                          <span class="token operator">*</span>queue_top<span class="token punctuation">,</span> <span class="token comment">/* Top of the list                  */</span>
                          <span class="token operator">*</span>q_prev100<span class="token punctuation">;</span> <span class="token comment">/* Previous 100 marker              */</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span>
  top_rated<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token comment">/* Top entries for bitmap bytes     */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将用户测试用例读入 queue 队列</p>
<ul>
<li>为结构体开辟空间，设置 fname、len、passed_det，depth &#x3D; cur_depth + 1，depth 大于 max_depth 时更新 max_depth</li>
<li>如果 queue_top 不为空则将当前元素插入队尾，如果为空则设为队首</li>
<li>队列路径数和未 fuzz 的路径数分别 +1，cycles_wo_finds 置零</li>
<li>当已入队的路径数量 queued_paths 是100的倍数时，将每100个路径的前一个路径的 next_100 指针指向当前路径，将 <code>q_prev100</code> 更新为当前路径，为下一个100个路径做准备</li>
<li>获取当前时间为最后一个路径的时间</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_to_queue</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> fname<span class="token punctuation">,</span> u32 len<span class="token punctuation">,</span> u8 passed_det<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  q<span class="token operator">-></span>fname        <span class="token operator">=</span> fname<span class="token punctuation">;</span>
  q<span class="token operator">-></span>len          <span class="token operator">=</span> len<span class="token punctuation">;</span>
  q<span class="token operator">-></span>depth        <span class="token operator">=</span> cur_depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  q<span class="token operator">-></span>passed_det   <span class="token operator">=</span> passed_det<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>depth <span class="token operator">></span> max_depth<span class="token punctuation">)</span> max_depth <span class="token operator">=</span> q<span class="token operator">-></span>depth<span class="token punctuation">;</span>	<span class="token comment">//depth 大于 max_depth 时更新 max_depth</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_top<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//queue_top 不为空则将当前元素插入队尾</span>
    queue_top<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>
    queue_top <span class="token operator">=</span> q<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> q_prev100 <span class="token operator">=</span> queue <span class="token operator">=</span> queue_top <span class="token operator">=</span> q<span class="token punctuation">;</span>	<span class="token comment">//为空则设为队首</span>

  <span class="token comment">//队列路径数和为 fuzz 的路径数分别 +1，cycles_wo_finds 置零</span>
  queued_paths<span class="token operator">++</span><span class="token punctuation">;</span>
  pending_not_fuzzed<span class="token operator">++</span><span class="token punctuation">;</span>
  cycles_wo_finds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>queued_paths <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    q_prev100<span class="token operator">-></span>next_100 <span class="token operator">=</span> q<span class="token punctuation">;</span>
    q_prev100 <span class="token operator">=</span> q<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  last_path_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="load-auto"><a href="#load-auto" class="headerlink" title="load_auto"></a>load_auto</h3><p>读入自动生成的提取出来的词典 token</p>
<ul>
<li>遍历 50 次，以只读的方式打开 in_dir&#x2F;.state&#x2F;auto_extras&#x2F;auto_%06u<ul>
<li>失败则释放文件名字符串并 break</li>
<li>成功则读 MAX_AUTO_EXTRA + 1 长度到 tmp，实际读取长度保存到 len，读取失败则报错退出</li>
</ul>
</li>
<li>读取长度在最大值和最小值之间则调用 <a href="##maybe_add_auto">maybe_add_auto</a> 按规则自动添加有效的额外数据到字典</li>
<li>提示加载的 tokens 的数量，如果为 0 则提示没有自动生成的字典 token</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">load_auto</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> USE_AUTO_EXTRAS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    u8  tmp<span class="token punctuation">[</span>MAX_AUTO_EXTRA <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.state/auto_extras/auto_%06u"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    s32 fd<span class="token punctuation">,</span> len<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//以只读的方式打开 in_dir/.state/auto_extras/auto_%06u</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//失败则释放文件名字符串并 break</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ENOENT<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> MAX_AUTO_EXTRA <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//成功则读 MAX_AUTO_EXTRA + 1 长度到 tmp，实际读取长度保存到 len</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to read from '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//读取失败则报错退出</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> MIN_AUTO_EXTRA <span class="token operator">&amp;&amp;</span> len <span class="token operator">&lt;=</span> MAX_AUTO_EXTRA<span class="token punctuation">)</span>	<span class="token comment">//读取长度在最大值和最小值之间则调用 maybe_add_auto 按规则自动添加有效的额外数据到字典</span>
      <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Loaded %u auto-discovered dictionary tokens."</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"No auto-generated dictionary tokens to reuse."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="maybe-add-auto"><a href="#maybe-add-auto" class="headerlink" title="maybe_add_auto"></a>maybe_add_auto</h3><p>自动添加有效的额外数据（如潜在的重要字节序列）到一个动态字典中</p>
<p>afl-fuzz 中有两个词典：</p>
<ul>
<li>程序运行之初导入的用户词典，存放在 extras 数组</li>
<li>fuzzer 自动选择的 extra token 组成的词典，放在 a_extras 数组，最多 500 个，超过 500 个随机删除一个 250 往后的 token</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_8</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">128</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit when decremented  */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">1</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">16</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">32</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">64</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">100</span><span class="token punctuation">,</span>          </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">127</span>           </span><span class="token comment">/* Overflow signed 8-bit when incremented  */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_16</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">32768</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit when decremented */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">129</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit                   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">128</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit                   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">255</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow unsig 8-bit when incremented   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">256</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow unsig 8-bit                    */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">512</span><span class="token punctuation">,</span>          </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">1000</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">1024</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">4096</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">32767</span>         </span><span class="token comment">/* Overflow signed 16-bit when incremented */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_32</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">2147483648LL</span><span class="token punctuation">,</span> </span><span class="token comment">/* Overflow signed 32-bit when decremented */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">100663046</span><span class="token punctuation">,</span>    </span><span class="token comment">/* Large negative number (endian-agnostic) */</span> <span class="token punctuation">\</span>
  <span class="token expression"><span class="token operator">-</span><span class="token number">32769</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit                  */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">32768</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit                  */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">65535</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow unsig 16-bit when incremented  */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">65536</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow unsig 16 bit                   */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">100663045</span><span class="token punctuation">,</span>    </span><span class="token comment">/* Large positive number (endian-agnostic) */</span> <span class="token punctuation">\</span>
   <span class="token expression"><span class="token number">2147483647</span>    </span><span class="token comment">/* Overflow signed 32-bit when incremented */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">extra_data</span> <span class="token punctuation">&#123;</span>
  u8<span class="token operator">*</span> data<span class="token punctuation">;</span>                           <span class="token comment">/* Dictionary token data            */</span>
  u32 len<span class="token punctuation">;</span>                            <span class="token comment">/* Dictionary token length          */</span>
  u32 hit_cnt<span class="token punctuation">;</span>                        <span class="token comment">/* Use count in the corpus          */</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token operator">*</span> a_extras<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>用户指定了不使用 auto extras 即 USE_AUTO_EXTRAS &#x3D; 0 则返回</li>
<li>跳过连续相同字节，如果全部相同则返回</li>
<li>与内置的 interesting_16 和 interesting_32 比较，相同则返回</li>
<li>遍历 extras，与其中一项相同则返回</li>
<li>遍历 a_extras，与其中一项相同则增加该项命中率 hit_cnt 并跳转到 sort_a_extras<ul>
<li>sort_a_extras：按命中率对 a_extras 降序排序，按大小对前 USE_AUTO_EXTRAS 个条目排序</li>
</ul>
</li>
<li>未达到最大值就添加进 a_extras，达到最大值就从后半部分随机删除一项然后添加该项</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> mem<span class="token punctuation">,</span> u32 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  u32 i<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>MAX_AUTO_EXTRAS <span class="token operator">||</span> <span class="token operator">!</span>USE_AUTO_EXTRAS<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//指定不使用 auto extras 则直接返回</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> mem<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>	<span class="token comment">//跳过连续相同字节</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> len<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">// 如果所有字节都相同，返回</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	  <span class="token comment">//长度为2和 interesting_16 比较相同则返回</span>
    i <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> interesting_16<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span>
          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">////长度为2和 interesting_32 比较相同则返回</span>
    i <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> interesting_32<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span>
          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extras_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//extras 按从小到大，循环找到第一个长度大于等于 len 的 token</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">>=</span> len<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extras_cnt <span class="token operator">&amp;&amp;</span> extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">==</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">memcmp_nocase</span><span class="token punctuation">(</span>extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//不分大小写如果相同则返回</span>

  auto_changed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a_extras_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//和 a_extras 比较，a_extras 不按大小排序，遍历比较如果有相同的就增加该项的命中率 hit_cnt 并且跳转到 sort_a_extras</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">==</span> len <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">memcmp_nocase</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hit_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> sort_a_extras<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">&lt;</span> MAX_AUTO_EXTRAS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//未达到最大值就添加进 a_extras</span>
    a_extras <span class="token operator">=</span> <span class="token function">ck_realloc_block</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    a_extras<span class="token punctuation">[</span>a_extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">ck_memdup</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    a_extras<span class="token punctuation">[</span>a_extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>len  <span class="token operator">=</span> len<span class="token punctuation">;</span>
    a_extras_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//达到最大值就从后半部分随机删除一项然后添加该项</span>
    i <span class="token operator">=</span> MAX_AUTO_EXTRAS <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MAX_AUTO_EXTRAS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ck_free</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data    <span class="token operator">=</span> <span class="token function">ck_memdup</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len     <span class="token operator">=</span> len<span class="token punctuation">;</span>
    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hit_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

sort_a_extras<span class="token operator">:</span>
  <span class="token function">qsort</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        compare_extras_use_d<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//按命中率对 a_extras 降序排序</span>

  <span class="token function">qsort</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span>USE_AUTO_EXTRAS<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">//按大小对前 USE_AUTO_EXTRAS 个条目排序</span>
        <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compare_extras_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pivot-inputs"><a href="#pivot-inputs" class="headerlink" title="pivot_inputs"></a>pivot_inputs</h3><p>把初始 corpus（语料库） 复制到工作目录的 queue 文件夹下，在 out_put 目录中为 input 测试用例创建硬链接</p>
<p>循环遍历队列中的每一项</p>
<ul>
<li>获取文件名（不包含路径）</li>
<li>判断文件名是否为 id: 开头并解析 id 值判断是否匹配当前 id<ul>
<li>通过判断<ul>
<li>通过判断后设置 resuming_fuzz &#x3D; 1，生成新的文件路径 nfn &#x3D; out_dir&#x2F;queue&#x2F;rsl</li>
<li>获取 id，循环遍历队列，遍历到相同 id 的项则增加深度，超过最大深度则更新最大深度</li>
</ul>
</li>
<li>未通过判断<ul>
<li>在文件名中解析 ,orig: 后的字符串给 use_name，不存在则 use_name &#x3D; rsl</li>
<li>生成新文件路径 nfn &#x3D; out_dir&#x2F;queue&#x2F;id:id,orig:use_name，例如 out&#x2F;fuzzer1&#x2F;queue&#x2F;id:000000,orig:testcase</li>
</ul>
</li>
</ul>
</li>
<li>创建硬链接，q-&gt;fname 指向 nfn，更新 fname &#x3D; nfn</li>
<li>如果该项的 passed_det &#x3D; 1，则代表已经 fuzz 过，调用 mark_as_det_done</li>
<li>获取队列的下一项，并且增加 id</li>
<li>循环结束后如果设置了 in_place_resume 则调用 nuke_resume_dir 删除 out_dir&#x2F;_resume&#x2F;.stat&#x2F; 文件夹下的文件</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">pivot_inputs</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> queue<span class="token punctuation">;</span>
  u32 id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Creating hard links for all input files..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//队列不为空</span>
    u8  <span class="token operator">*</span>nfn<span class="token punctuation">,</span> <span class="token operator">*</span>rsl <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取最后一个 / 的位置，本例中fname = in/testcase，rsl 获取到 /testcase</span>
    u32 orig_id<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rsl<span class="token punctuation">)</span> rsl <span class="token operator">=</span> q<span class="token operator">-></span>fname<span class="token punctuation">;</span> <span class="token keyword">else</span> rsl<span class="token operator">++</span><span class="token punctuation">;</span>	<span class="token comment">//获取失败则 rsl 就是 fname，成功则下移一个位置去掉 /，得到 testcase</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">CASE_PREFIX</span> <span class="token string">"id:"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">CASE_PREFIX</span> <span class="token string">"id_"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>rsl<span class="token punctuation">,</span> CASE_PREFIX<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>	<span class="token comment">//判断文件名开头是否是 id:</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>rsl <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>orig_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> orig_id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//是的话解析 id 判断是否和当前 id 匹配，匹配则说明符合标准格式</span>

      u8<span class="token operator">*</span> src_str<span class="token punctuation">;</span>
      u32 src_id<span class="token punctuation">;</span>

      resuming_fuzz <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> rsl<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 生成新的文件路径</span>

      src_str <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>rsl <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//获取 ： 的位置，例如 id:id,orig:use_name，得到 :id,orig:use_name</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>src_str <span class="token operator">&amp;&amp;</span> <span class="token function">sscanf</span><span class="token punctuation">(</span>src_str <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>src_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	<span class="token comment">//存在 ：，获取后面的数字</span>
        <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> s <span class="token operator">=</span> queue<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>src_id<span class="token operator">--</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">)</span> s <span class="token operator">=</span> s<span class="token operator">-></span>next<span class="token punctuation">;</span>	<span class="token comment">//循环遍历到队列中 id 相同的项</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> q<span class="token operator">-></span>depth <span class="token operator">=</span> s<span class="token operator">-></span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//遍历成功则该项深度 +1，表示路径的复杂度或生成顺序</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>max_depth <span class="token operator">&lt;</span> q<span class="token operator">-></span>depth<span class="token punctuation">)</span> max_depth <span class="token operator">=</span> q<span class="token operator">-></span>depth<span class="token punctuation">;</span>	<span class="token comment">//超过最大深度则更新最大深度</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>
      u8<span class="token operator">*</span> use_name <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>rsl<span class="token punctuation">,</span> <span class="token string">",orig:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//在 rsl 中寻找 ,orig: 的位置给 use_name</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>use_name<span class="token punctuation">)</span> use_name <span class="token operator">+=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token keyword">else</span> use_name <span class="token operator">=</span> rsl<span class="token punctuation">;</span>	<span class="token comment">//找到则 use_name 为冒号后面的内容，没找到则 use_name = rsl</span>
      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id:%06u,orig:%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> id<span class="token punctuation">,</span> use_name<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//nfn = out_dir/queue/id:id,orig:use_name，本例是 out/fuzzer1/queue/id:000000,orig:testcase</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">link_or_copy</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> nfn<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//创建硬链接，q->fname指向nfn</span>
    <span class="token function">ck_free</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    q<span class="token operator">-></span>fname <span class="token operator">=</span> nfn<span class="token punctuation">;</span>	<span class="token comment">//更新 fname 为硬链接</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>passed_det<span class="token punctuation">)</span> <span class="token function">mark_as_det_done</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//passed_det = 1 代表已经 fuzz 过</span>
    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>
    id<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span> <span class="token function">nuke_resume_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//设置了 in_place_resume 则调用 nuke_resume_dir 删除 out_dir/_resume/.stat/ 文件夹下的文件</span>
<span class="token punctuation">&#125;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="load-extras"><a href="#load-extras" class="headerlink" title="load_extras"></a>load_extras</h3><p>如果通过 -x 选项指定了 dictionary，则从 dictionary 导入 extra</p>
<h3 id="find-timeout"><a href="#find-timeout" class="headerlink" title="find_timeout"></a>find_timeout</h3><ul>
<li>resuming_fuzz &#x3D; 0 直接返回</li>
<li>in_place_resume &#x3D; 1 打开 out_dir&#x2F;fuzzer_stats，否则打开 in_dir&#x2F;..&#x2F;fuzzer_stats，打开失败就返回</li>
<li>从文件中读取长度为 sizeof(tmp) - 1，从读取的内容中寻找 “exec_timeout   : “<ul>
<li>不存在就直接返回</li>
<li>存在就提取后面的数字，小于等于 4 直接返回，否则赋值给 exec_tmout 并设置 timeout_given &#x3D; 3</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">find_timeout</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resuming_fuzz<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/fuzzer_stats"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//in_place_resume = 1 打开 out_dir/fuzzer_stats</span>
  <span class="token keyword">else</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/../fuzzer_stats"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//否则打开 in_dir/../fuzzer_stats</span>

  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//打开失败则返回</span>

  i <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span>	<span class="token comment">//从文件中读取长度为 sizeof(tmp) - 1</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  off <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"exec_timeout   : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//从读取的内容中寻找 "exec_timeout   : "</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>off<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//不存在就直接返回</span>

  ret <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>off <span class="token operator">+</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//存在就提取后面的数字</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>	<span class="token comment">//小于等于 4 直接返回</span>

  exec_tmout <span class="token operator">=</span> ret<span class="token punctuation">;</span>
  timeout_given <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="detect-file-args"><a href="#detect-file-args" class="headerlink" title="detect_file_args"></a>detect_file_args</h3><p>检查输入 argv 中是否存在 @@ 指定输入文件，有的话创建并替换 out_file 成 out_dir&#x2F;.cur_input（也可以使用 -f 参数指定 out_file）</p>
<blockquote>
<p><code>@@</code> 是一个占位符，用于指定目标程序的输入文件位置。当 AFL 执行模糊测试时，它会将测试用例文件动态替换到命令行中的 <code>@@</code> 位置</p>
</blockquote>
<h3 id="setup-stdio-file"><a href="#setup-stdio-file" class="headerlink" title="setup_stdio_file"></a>setup_stdio_file</h3><p>如果 out_file 没有值（没有使用 -f），则调用此函数，会删除原本的 out_dir&#x2F;.cur_input，创建一个新的 out_dir&#x2F;.cur_input ，保存其文件描述符在 out_fd 中，后续 fuzzer 把变异出的 input 写进这里，由 child 读取</p>
<h3 id="check-binary"><a href="#check-binary" class="headerlink" title="check_binary"></a>check_binary</h3><p>指定路径处要执行的程序是否存在、是否在 &#x2F;tmp，且它不能是一个 shell script，同时检查 elf 文件头是否合法及程序是否被插桩参考文章</p>
<p><a target="_blank" rel="noopener" href="https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a target="_blank" rel="noopener" href="https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#fuzz-one">https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#fuzz-one</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45323960/article/details/138173267">https://blog.csdn.net/qq_45323960/article/details/138173267</a></p>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/fuzz/">
                                    <span class="chip bg-color">fuzz</span>
                                </a>
                            
                                <a href="/tags/AFL/">
                                    <span class="chip bg-color">AFL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/03/10/afl-yuan-ma-fen-xi-er/afl-yuan-ma-fen-xi-er/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="AFL源码分析（二）">
                        
                        <span class="card-title">AFL源码分析（二）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            AFL源码分析
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-03-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/fuzz/" class="post-category">
                                    fuzz
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/fuzz/">
                        <span class="chip bg-color">fuzz</span>
                    </a>
                    
                    <a href="/tags/AFL/">
                        <span class="chip bg-color">AFL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/02/10/yi-gou-pwn-yun-xing-yu-diao-shi/yi-gou-pwn-yun-xing-yu-diao-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="异构pwn运行与调试">
                        
                        <span class="card-title">异构pwn运行与调试</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            异构pwn运行于调试
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-02-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/pwn/" class="post-category">
                                    pwn
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/pwn/">
                        <span class="chip bg-color">pwn</span>
                    </a>
                    
                    <a href="/tags/%E5%BC%82%E6%9E%84/">
                        <span class="chip bg-color">异构</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">starrysky</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">207.6k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/starrysky1004" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:starrysky20041005@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2726736810" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2726736810" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>









    <a href="https://space.bilibili.com/85923475" class="tooltipped" target="_blank" data-tooltip="关注我的bilibili" data-position="top" data-delay="50">
        <i class="fas fa-video"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":260,"height":300},"mobile":{"show":true},"log":false});</script></body>

</html>
