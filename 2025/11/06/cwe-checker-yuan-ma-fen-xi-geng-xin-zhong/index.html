<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="cwe_checker源码分析（更新中）, starrysky">
    <meta name="description" content="Love rises from the east and descends to the west,romance makes no changes until death.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>cwe_checker源码分析（更新中） | starrysky</title>
    <link rel="icon" type="image/jpeg" href="/favicon.jpg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="starrysky" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">starrysky</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>文章</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>个人简介</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">starrysky</div>
        <div class="logo-desc">
            
            Love rises from the east and descends to the west,romance makes no changes until death.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			文章
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			个人简介
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/Steel%20Gray.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">cwe_checker源码分析（更新中）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/cwe-checker/">
                                <span class="chip bg-color">cwe_checker</span>
                            </a>
                        
                            <a href="/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/">
                                <span class="chip bg-color">静态分析</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/" class="post-category">
                                静态分析
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-11-06
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    51 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>实习的时候刚好接触到这个工具，想着学一下静态分析，网上也没搜到相关源码分析…只能自己看了orz，还特地学了一周 rust 哈哈哈</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="Pcode"><a href="#Pcode" class="headerlink" title="Pcode"></a>Pcode</h3><p><strong>IR</strong> （Intermediate Representation）是中间表示的缩写，指在编译器或二进制分析工具中，将原始的机器代码或汇编代码转换为一种中间抽象形式，以便于进行分析和优化</p>
<p><strong>Pcode</strong>（Program Code）是 Ghidra 反汇编器使用的中间表示（IR）。它是 Ghidra 将二进制代码分析后的低级表示形式，提供了一种独立于特定 CPU 架构的二进制代码表示，每条汇编指令被分解为一系列 Pcode 操作（一条汇编指令对应多个 Pcode 操作），常见 Pcode 操作码类型：</p>
<ul>
<li>算术运算：<code>INT_ADD</code>, <code>INT_SUB</code>, <code>INT_MULT</code>, <code>INT_DIV</code>, <code>INT_REM</code></li>
<li>逻辑运算：<code>INT_AND</code>, <code>INT_OR</code>, <code>INT_XOR</code>, <code>INT_NEGATE</code></li>
<li>移位操作：<code>INT_LEFT</code>, <code>INT_RIGHT</code>, <code>INT_SRIGHT</code></li>
<li>内存操作：<code>LOAD</code>, <code>STORE</code></li>
<li>数据转换：<code>INT_ZEXT</code>, <code>INT_SEXT</code>, <code>INT_CARRY</code>, <code>INT_SCARRY</code></li>
<li>控制流：<code>BRANCH</code>, <code>CBRANCH</code>, <code>CALL</code>, <code>CALLIND</code>, <code>RETURN</code></li>
<li>复制：<code>COPY</code></li>
</ul>
<p><strong>Varnode</strong> 是 Pcode 中的基本数据单位，用于在 Pcode Raw 的 inputs &#x2F; output 字段描述 输入 &#x2F; 输出变量信息，包含：</p>
<ul>
<li>**<code>size</code>**：数据大小（字节数）</li>
<li>**<code>address_space</code>**：地址空间类型（const &#x2F; register &#x2F; ram 内存地址 &#x2F; unique 临时变量 &#x2F; stack）</li>
<li>**<code>address_space_offset</code>**：在地址空间中的偏移（寄存器名 &#x2F; 数值）</li>
<li>**<code>pointer_size</code>**：指针大小（用于地址计算）</li>
</ul>
<p><strong>Pcode Raw</strong> 是 Ghidra 的 Pcode Extractor 插件输出的 json 格式文件，包含程序结构（函数、基本块）、Pcode 操作、寄存器信息、调用约定（函数调用和返回）、数据类型属性（数据类型的尺寸信息）</p>
<p>Pcode Raw 文件结构：</p>
<ul>
<li>**<code>program.functions</code>**：程序中的所有函数列表</li>
<li>**<code>register_properties</code>**：CPU 寄存器的层次结构和属性</li>
<li>**<code>calling_conventions</code>**：函数调用约定（参数传递、返回值等）</li>
<li>**<code>datatype_properties</code>**：C 数据类型的尺寸信息</li>
<li>**<code>image_base</code>**：程序在内存中的基址</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"program"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"functions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"函数名"</span><span class="token punctuation">,</span>
        <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"函数地址"</span><span class="token punctuation">,</span>
        <span class="token property">"blocks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"基本块地址"</span><span class="token punctuation">,</span>
            <span class="token property">"instructions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">&#123;</span>
                <span class="token property">"mnemonic"</span><span class="token operator">:</span> <span class="token string">"汇编指令助记符"</span><span class="token punctuation">,</span>
                <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"指令地址"</span><span class="token punctuation">,</span>
                <span class="token property">"size"</span><span class="token operator">:</span> 指令字节大小<span class="token punctuation">,</span>
                <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token punctuation">&#123;</span>
                    <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"操作地址"</span><span class="token punctuation">,</span>
                    <span class="token property">"index"</span><span class="token operator">:</span> 操作索引<span class="token punctuation">,</span>
                    <span class="token property">"operation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                      <span class="token property">"pcode_mnemonic"</span><span class="token operator">:</span> <span class="token string">"Pcode操作码"</span><span class="token punctuation">,</span>
                      <span class="token property">"output"</span><span class="token operator">:</span> 输出varnode<span class="token punctuation">,</span>
                      <span class="token property">"inputs"</span><span class="token operator">:</span> <span class="token punctuation">[</span>输入varnode列表<span class="token punctuation">]</span>
                    <span class="token punctuation">&#125;</span>
                  <span class="token punctuation">&#125;</span>
                  <span class="token property">"potential_targets"</span><span class="token operator">:</span> <span class="token string">"间接控制流转移的潜在目标地址列表（存在 jmp / call）"</span><span class="token punctuation">,</span>
                  <span class="token property">"fall_through"</span><span class="token operator">:</span> <span class="token string">"顺序执行的下一条指令地址"</span>
                <span class="token punctuation">]</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"register_properties"</span><span class="token operator">:</span> <span class="token punctuation">[</span>...<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"cpu_arch"</span><span class="token operator">:</span> <span class="token string">"CPU架构名称"</span><span class="token punctuation">,</span>
  <span class="token property">"external_functions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"entry_points"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"入口点地址列表"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"stack_pointer_register"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"calling_conventions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"datatype_properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"image_base"</span><span class="token operator">:</span> <span class="token string">"程序基址"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>汇编转 Pcode 示例</strong>：</p>
<p>汇编：</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">0x1000: push   %rbp        ; 保存基指针
0x1001: mov    %rsp,%rbp   ; 设置新的基指针
0x1004: add    %esi,%edi   ; EDI &#x3D; EDI + ESI
0x1007: pop    %rbp        ; 恢复基指针
0x1008: ret                ; 返回<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Pcode：</p>
<pre class="line-numbers language-peoplecode" data-language="peoplecode"><code class="language-peoplecode">INT_SUB RSP <span class="token operator">-</span> <span class="token number">8</span> → RSP
STORE RSP ← RBP			<span class="token operator">/</span><span class="token operator">/</span> push   <span class="token variable">%rbp</span> 
COPY RSP → RBP			<span class="token operator">/</span><span class="token operator">/</span> mov <span class="token variable">%rsp</span><span class="token punctuation">,</span><span class="token variable">%rbp</span>
INT_ADD EDI<span class="token punctuation">,</span> ESI → EAX	 <span class="token operator">/</span><span class="token operator">/</span> add <span class="token variable">%esi</span><span class="token punctuation">,</span><span class="token variable">%edi</span>
LOAD RSP → RBP
INT_ADD RSP <span class="token operator">+</span> <span class="token number">8</span> → RSP	 <span class="token operator">/</span><span class="token operator">/</span> pop <span class="token variable">%rbp</span>
<span class="token keyword">RETURN</span>				    <span class="token operator">/</span><span class="token operator">/</span> ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Pcode 在 Pcode Raw 的 instructions 字段中的表示：</strong>以 push 为例</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
             <span class="token property">"mnemonic"</span><span class="token operator">:</span> <span class="token string">"push"</span><span class="token punctuation">,</span>
             <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x1000"</span><span class="token punctuation">,</span>
             <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
             <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
             <span class="token comment">// Pcode 指令1：INT_SUB RSP - 8 → RSP</span>
               <span class="token punctuation">&#123;</span>
                 <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x1000"</span><span class="token punctuation">,</span>
                 <span class="token property">"index"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                 <span class="token property">"operation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                   <span class="token property">"pcode_mnemonic"</span><span class="token operator">:</span> <span class="token string">"INT_SUB"</span><span class="token punctuation">,</span>	<span class="token comment">// Pcode 操作码</span>
                   <span class="token property">"input0"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 输入1：RSP</span>
                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>
                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>
                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>
                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                   <span class="token property">"input1"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 输入2：8</span>
                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"const"</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span>
                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                   <span class="token property">"input2"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>	<span class="token comment">// 无第三个输入</span>
                   <span class="token property">"output"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 输出：RSP</span>
                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>
                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>
                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>
                   <span class="token punctuation">&#125;</span>
                 <span class="token punctuation">&#125;</span>
               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
               <span class="token comment">// Pcode 指令2：STORE RSP ← RBP</span>
               <span class="token punctuation">&#123;</span>
                 <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x1000"</span><span class="token punctuation">,</span>
                 <span class="token property">"index"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 <span class="token property">"operation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                   <span class="token property">"pcode_mnemonic"</span><span class="token operator">:</span> <span class="token string">"STORE"</span><span class="token punctuation">,</span>	<span class="token comment">// Pcode 操作码</span>
                   <span class="token property">"input0"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>				   <span class="token comment">// 输入1：RSP</span>
                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>
                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>
                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>
                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                   <span class="token property">"input1"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>				   <span class="token comment">// 输入2：RBP</span>
                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>
                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RBP"</span><span class="token punctuation">,</span>
                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RBP"</span><span class="token punctuation">,</span>
                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>
                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                   <span class="token property">"input2"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
                   <span class="token property">"output"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
                 <span class="token punctuation">&#125;</span>
               <span class="token punctuation">&#125;</span>
             <span class="token punctuation">]</span><span class="token punctuation">,</span>
             <span class="token property">"potential_targets"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>	<span class="token comment">// 没有可能跳转的地址</span>
             <span class="token property">"fall_through"</span><span class="token operator">:</span> <span class="token string">"0x1001"</span>	<span class="token comment">// 顺序执行的下一条指令地址</span>
           <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="cwe-checker-源码分析"><a href="#cwe-checker-源码分析" class="headerlink" title="cwe_checker 源码分析"></a>cwe_checker 源码分析</h2><h3 id="caller-x2F-src-x2F-main-rs"><a href="#caller-x2F-src-x2F-main-rs" class="headerlink" title="caller&#x2F;src&#x2F;main.rs"></a>caller&#x2F;src&#x2F;main.rs</h3><p>功能：CWE 检查器的命令行界面，主程序</p>
<h4 id="import-module-导入模块"><a href="#import-module-导入模块" class="headerlink" title="import module 导入模块"></a>import module 导入模块</h4><p>从 cwe_checker_lib 库导入的模块</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>analysis<span class="token punctuation">::</span></span>graph<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>checkers<span class="token punctuation">::</span></span><span class="token class-name">CweModule</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>pipeline<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>disassemble_binary<span class="token punctuation">,</span> <span class="token class-name">AnalysisResults</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span>binary<span class="token punctuation">::</span></span><span class="token class-name">BareMetalConfig</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span></span>debug<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span>log<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>print_all_messages<span class="token punctuation">,</span> <span class="token class-name">CweWarning</span><span class="token punctuation">,</span> <span class="token class-name">LogLevel</span><span class="token punctuation">,</span> <span class="token class-name">LogMessage</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span></span>read_config_file<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用本地的 caller&#x2F;src&#x2F;cfg_stats.rs 模块（控制流图统计）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">cfg_stats</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="main-入口点"><a href="#main-入口点" class="headerlink" title="main 入口点"></a>main 入口点</h4><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/// 主函数入口</span>
    <span class="token keyword">let</span> cmdline_args <span class="token operator">=</span> <span class="token class-name">CmdlineArgs</span><span class="token punctuation">::</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// clap::Parser 自动生成的 parse()</span>
    <span class="token function">run_with_ghidra</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmdline_args<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="CmdlineArgs-参数解析"><a href="#CmdlineArgs-参数解析" class="headerlink" title="CmdlineArgs 参数解析"></a>CmdlineArgs 参数解析</h4><p>参数示例： <code>cwe_checker binary --partial CWE476,CWE416 --json -o results.json</code></p>
<ul>
<li><p>binary：指定二进制文件路径，除非使用 module_versions 参数否则必填，并且会调用 check_file_existence 检查文件是否存在，返回文件路径字符串</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/// 仅当 file_path 指向现有文件时才返回 Ok(file_path)</span>
<span class="token keyword">fn</span> <span class="token function-definition function">check_file_existence</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">metadata</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>err<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"&#123;err&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>file_path<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"&#123;file_path&#125; is not a file."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>module_versions：打印所有已知模块的版本号，不需要参数</p>
</li>
<li><p>config：指定自定义配置文件路径，可以用缩写 -c，会调用 check_file_existence 检查文件是否存在，返回文件路径字符串</p>
</li>
<li><p>out：将结果写入指定文件，不输出到不准输出，可以使用缩写 -o</p>
</li>
<li><p>partial：指定要运行的特定检查集， 使用<code>,</code>分割，可以使用缩写 <code>-p</code>，例如<code>-p CWE332,CWE476,CWE782</code></p>
</li>
<li><p>json：生成 json 输出，不需要参数，可以使用缩写 -j</p>
</li>
<li><p>quiet：静默输出，不打印日志消息，不需要参数，可以使用缩写 -q</p>
</li>
<li><p>verbose：打印额外的调试日志消息，不需要参数，可以使用缩写 -v，与 quiet 不能同时使用</p>
</li>
<li><p>statistics：在日志消息中包含各种统计信息，不需要参数，与 quiet 不能同时使用</p>
</li>
<li><p>bare_metal_config：用于裸机二进制分析的配置文件路径，输入二进制文件都将被视为裸机二进制文件，会调用 check_file_existence 检查文件是否存在，返回文件路径字符串</p>
</li>
<li><p>debug：用于调试目的的输出，参数为 CliDebugMode 枚举类型成员</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(ValueEnum, Clone, Debug, Copy)]</span>
<span class="token comment">/// 选择要显示的调试输出类型</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">CliDebugMode</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Ghidra插件的原始输出</span>
    <span class="token class-name">PcodeRaw</span><span class="token punctuation">,</span> <span class="token comment">// Ghidra插件的输出反序列化到 Rust 类型</span>
    <span class="token class-name">PcodeParsed</span><span class="token punctuation">,</span> <span class="token comment">// 程序的第一个IR表示</span>
    <span class="token class-name">IrEarly</span><span class="token punctuation">,</span> <span class="token comment">// 在函数内基本块被正常排序之后</span>
    <span class="token class-name">IrFnBlksSorted</span><span class="token punctuation">,</span> <span class="token comment">// 在非返回外部函数被标记之后</span>
    <span class="token class-name">IrNonRetExtFunctionsMarked</span><span class="token punctuation">,</span> <span class="token comment">// 在外部函数存根调用被替换为外部函数调用之后</span>
    <span class="token class-name">IrExtCallsReplaced</span><span class="token punctuation">,</span> <span class="token comment">// 在现有引用块被内联到函数中之后</span>
    <span class="token class-name">IrInlined</span><span class="token punctuation">,</span> <span class="token comment">// 在子寄存器替换过程之后</span>
    <span class="token class-name">IrSubregistersSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 在所有控制流转换都有有效目标之后</span>
    <span class="token class-name">IrCfPatched</span><span class="token punctuation">,</span> <span class="token comment">// 在空函数被移除之后</span>
    <span class="token class-name">IrEmptyFnRemoved</span><span class="token punctuation">,</span> <span class="token comment">// 未优化的IR</span>
    <span class="token class-name">IrRaw</span><span class="token punctuation">,</span> <span class="token comment">// 在函数的不可达基本块被移除之后</span>
    <span class="token class-name">IrIntraproceduralDeadBlocksElimed</span><span class="token punctuation">,</span> <span class="token comment">// 在平凡表达式被替换为其结果之后</span>
    <span class="token class-name">IrTrivialExpressionsSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 在输入表达式沿着变量赋值传播之后</span>
    <span class="token class-name">IrInputExpressionsPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 在死变量赋值被移除之后</span>
    <span class="token class-name">IrDeadVariablesElimed</span><span class="token punctuation">,</span> <span class="token comment">// 在具有相同条件的条件语句的控制流被简化之后</span>
    <span class="token class-name">IrControlFlowPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 在栈指针通过逻辑AND对齐被替换为减法操作之后</span>
    <span class="token class-name">IrStackPointerAlignmentSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 最终的IR</span>
    <span class="token class-name">IrOptimized</span><span class="token punctuation">,</span> <span class="token comment">// 整个程序的调用图</span>
    <span class="token class-name">Cg</span><span class="token punctuation">,</span> <span class="token comment">// 整个程序的控制流图</span>
    <span class="token class-name">Cfg</span><span class="token punctuation">,</span> <span class="token comment">// 指针推理计算结果</span>
    <span class="token class-name">Pi</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>pcode_raw：从文件读取保存的 Pcode 提取器插件输出，而不是调用 Ghidra</p>
</li>
<li><p>cfg_stats：打印 IR 程序CFG的统计信息和指标并退出，不需要参数（如函数内圈复杂度、基本块数、指令数、外部函数被调用次数等）</p>
</li>
</ul>
<h4 id="run-with-ghidra-主要函数"><a href="#run-with-ghidra-主要函数" class="headerlink" title="run_with_ghidra 主要函数"></a>run_with_ghidra 主要函数</h4><p>功能：以 Ghidra 作为后端运行 cwe_checker</p>
<ul>
<li><p>调用 <code>impl From&lt;&amp;CmdlineArgs&gt; for debug::Settings</code> 将 args 程序参数转换为目标类型</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> debug_settings <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>处理 debug：获取指定的 debug 模式（全部模式见 CliDebugMode 类型），未指定则使用默认值，即不调试</p>
</li>
<li><p>处理 verbose：指定日志详细程度，包括指定 –verbose 详细模式；–quiet 静默模式；未指定 默认模式</p>
</li>
<li><p>构建 Settings 对象，设置默认值</p>
</li>
<li><p>处理 –pcode-raw：选择保存 Pcode 的文件路径</p>
</li>
<li><p>构建最终的 Settings 对象，返回 debug::Settings 结构体</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">CmdlineArgs</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/// 将命令行参数转换为调试设置</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">from</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">CmdlineArgs</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理 debug 参数</span>
        <span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token operator">&amp;</span>args<span class="token punctuation">.</span>debug <span class="token punctuation">&#123;</span> 		<span class="token comment">// debug mode 值见 CliDebugMode</span>
            <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 没有指定 --debug 参数则使用默认值（不调试）</span>
            <span class="token comment">// 如果用户指定了 --debug 参数，则将 CliDebugMode 转换为 debug::Stage</span>
            <span class="token comment">// mode.into() 会调用 impl From&lt;&amp;CliDebugMode> for debug::Stage 的 from 方法</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token operator">=></span> mode<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 处理 verbose 参数：确定日志详细程度，检查用户是否指定了 --verbose 或 --quiet 参数</span>
        <span class="token keyword">let</span> verbosity <span class="token operator">=</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>verbose <span class="token punctuation">&#123;</span>
            <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token class-name">Verbose</span>	<span class="token comment">// 如果指定了 --verbose，使用详细模式（打印所有调试信息）</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>quiet <span class="token punctuation">&#123;</span>
            <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token class-name">Quiet</span>		<span class="token comment">// 如果指定了 --quiet，使用静默模式（不打印日志）</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// 如果两个都没指定，使用默认模式（正常日志）</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">// 构建 Settings 对象：调用 SettingsBuilder::default() 创建建造者，设置默认值</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> builder <span class="token operator">=</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">SettingsBuilder</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">set_stage</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span>           <span class="token comment">// 设置调试阶段（调用图、IR 等）</span>
            <span class="token punctuation">.</span><span class="token function">set_verbosity</span><span class="token punctuation">(</span>verbosity<span class="token punctuation">)</span>	<span class="token comment">// 设置日志详细程度（verbose/quiet/normal）</span>
            <span class="token punctuation">.</span><span class="token function">set_termination_policy</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">TerminationPolicy</span><span class="token punctuation">::</span><span class="token class-name">EarlyExit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置调试后退出</span>

        <span class="token comment">// 处理 --pcode-raw 参数：可选地设置保存的 Pcode 文件路径</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>pcode_raw<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>args<span class="token punctuation">.</span>pcode_raw <span class="token punctuation">&#123;</span>
            <span class="token comment">// 将字符串路径转换为 PathBuf，并设置到建造者中</span>
            <span class="token comment">// 这样可以从保存的文件读取 Pcode，而不需要调用 Ghidra</span>
            builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">set_saved_pcode_raw</span><span class="token punctuation">(</span><span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>pcode_raw<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 调用 build() 方法构建最终的 Settings 对象，返回一个完整的 debug::Settings 结构体</span>
        builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>示例：</p>
<p>转换前：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">CmdlineArgs</span> <span class="token punctuation">&#123;</span>
	binary<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"binary"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	config<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
	out<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
	partial<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
	json<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	quiet<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	verbose<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	statistics<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	bare_metal_config<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
	module_versions<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	debug<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>           		<span class="token comment">// ← 没有指定 --debug</span>
	pcode_raw<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
	cfg_stats<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>转换后：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span> <span class="token punctuation">&#123;</span>
	stage<span class="token punctuation">:</span> <span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">No</span><span class="token punctuation">,</span>                                     <span class="token comment">// 不调试</span>
	verbose<span class="token punctuation">:</span> <span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token class-name">Normal</span><span class="token punctuation">,</span>                           <span class="token comment">// 正常日志</span>
	terminate<span class="token punctuation">:</span> <span class="token class-name">TerminationPolicy</span><span class="token punctuation">::</span><span class="token class-name">EarlyExit</span><span class="token punctuation">,</span>              <span class="token comment">// 调试后退出</span>
	saved_pcode_raw<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>                                <span class="token comment">// 不使用保存的文件</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>debug 相关函数位于 src\cwe_checker_lib\src\utils\debug.rs</p>
<ul>
<li><p>Stage 类型：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug, Default)]</span>
<span class="token attribute attr-name">#[non_exhaustive]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Stage</span> <span class="token punctuation">&#123;</span>
    <span class="token attribute attr-name">#[default]</span>
    <span class="token class-name">No</span><span class="token punctuation">,</span>					<span class="token comment">// 默认值，无阶段</span>
    <span class="token class-name">All</span><span class="token punctuation">,</span>				<span class="token comment">// 全部阶段</span>
    <span class="token class-name">CallGraph</span><span class="token punctuation">,</span>		     <span class="token comment">// 构建调用图</span>
    <span class="token class-name">ControlFlowGraph</span><span class="token punctuation">,</span>	 <span class="token comment">// 构建控制流图</span>
    <span class="token class-name">Pi</span><span class="token punctuation">,</span>					<span class="token comment">// 指针推理</span>
    <span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token class-name">IrForm</span><span class="token punctuation">)</span><span class="token punctuation">,</span>		     <span class="token comment">// 生成中间表示</span>
    <span class="token class-name">Pcode</span><span class="token punctuation">(</span><span class="token class-name">PcodeForm</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	 <span class="token comment">// 解析 Pcode</span>
    <span class="token class-name">Cwe</span><span class="token punctuation">,</span>			    <span class="token comment">// CWE 检查阶段</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 IrForm 类型（生成中间表示的子阶段）：</p>
</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug)]</span>
<span class="token attribute attr-name">#[non_exhaustive]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">IrForm</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Early</span><span class="token punctuation">,</span> <span class="token comment">// 程序的第一个 IR 表示</span>
    <span class="token class-name">SingleTargetIndirectCallsReplaced</span><span class="token punctuation">,</span> <span class="token comment">// 单目标间接调用已被替换为直接调用</span>
    <span class="token class-name">FnBlksSorted</span><span class="token punctuation">,</span> <span class="token comment">// 函数内基本块已正常排序后</span>
    <span class="token class-name">NonRetExtFunctionsMarked</span><span class="token punctuation">,</span> <span class="token comment">// 非返回外部函数已标记后</span>
    <span class="token class-name">ExtCallsReplaced</span><span class="token punctuation">,</span> <span class="token comment">// 外部函数存根调用已替换为外部函数调用后</span>
    <span class="token class-name">Inlined</span><span class="token punctuation">,</span> <span class="token comment">// 现有引用块已内联到函数中后</span>
    <span class="token class-name">SubregistersSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 子寄存器替换过程后</span>
    <span class="token class-name">CfPatched</span><span class="token punctuation">,</span> <span class="token comment">// 所有控制流转换都有有效目标后</span>
    <span class="token class-name">EmptyFnRemoved</span><span class="token punctuation">,</span> <span class="token comment">// 空函数已被移除后</span>
    <span class="token class-name">EntryPointsExist</span><span class="token punctuation">,</span> <span class="token comment">// 不存在的入口点已被移除后</span>
    <span class="token class-name">Raw</span><span class="token punctuation">,</span> <span class="token comment">// 未优化的 IR</span>
    <span class="token class-name">IntraproceduralDeadBlocksElimed</span><span class="token punctuation">,</span> <span class="token comment">// 函数中不可达基本块已被移除后</span>
    <span class="token class-name">TrivialExpressionsSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 平凡表达式已替换为其结果后</span>
    <span class="token class-name">InputExpressionsPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 输入表达式已沿变量赋值传播后</span>
    <span class="token class-name">DeadVariablesElimed</span><span class="token punctuation">,</span> <span class="token comment">// 死变量赋值已被移除后</span>
    <span class="token class-name">ControlFlowPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 具有相同条件的条件语句的控制流已简化后</span>
    <span class="token class-name">StackPointerAlignmentSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 栈指针通过逻辑 AND 对齐已替换为减法操作后</span>
    <span class="token class-name">Optimized</span><span class="token punctuation">,</span> <span class="token comment">// 最终优化的 IR</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>PcodeForm：pcode 解析子阶段</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug)]</span>
<span class="token attribute attr-name">#[non_exhaustive]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">PcodeForm</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Raw</span><span class="token punctuation">,</span>	<span class="token comment">// 从 ghidra 获取的初始数据</span>
    <span class="token class-name">Parsed</span><span class="token punctuation">,</span>	<span class="token comment">// 转化成 rust 类型的数据</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Verbosity 类型：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug, Default)]</span>
<span class="token attribute attr-name">#[non_exhaustive]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Verbosity</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Quiet</span><span class="token punctuation">,</span>		<span class="token comment">// 静默模式</span>
    <span class="token attribute attr-name">#[default]</span>
    <span class="token class-name">Normal</span><span class="token punctuation">,</span>		<span class="token comment">// 默认的正常模式</span>
    <span class="token class-name">Verbose</span><span class="token punctuation">,</span>	<span class="token comment">// 打印额外日志信息</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>TerminationPolicy 类型：调试完成后的操作</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug, Default)]</span>
<span class="token attribute attr-name">#[non_exhaustive]</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">TerminationPolicy</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">KeepRunning</span><span class="token punctuation">,</span>	<span class="token comment">// 继续运行</span>
    <span class="token attribute attr-name">#[default]</span>
    <span class="token class-name">EarlyExit</span><span class="token punctuation">,</span>		<span class="token comment">// 默认提前退出</span>
    <span class="token class-name">Panic</span><span class="token punctuation">,</span>			<span class="token comment">// 异常终止</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
</li>
<li><p>获取每个模块的 CweModule 结构体</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> modules <span class="token operator">=</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>checkers<span class="token punctuation">::</span></span><span class="token function">get_modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>get_modules 位于 src\cwe_checker_lib\src\checkers.rs：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token class-name">CweModule</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token macro property">vec!</span><span class="token punctuation">[</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_78<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_119<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_134<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_190<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_215<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_243<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_252<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_332<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_337<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_367<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_416<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_426<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_467<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_476<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_560<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_676<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_782<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_789<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>analysis<span class="token punctuation">::</span>pointer_inference<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>同文件中定义了 CweModule 结构体，包括模块名、模块版本、函数名</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CweModule</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> version<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> run<span class="token punctuation">:</span> <span class="token class-name">CweModuleFn</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在每个 CWE 的 mod.rs 中都会设置该结构体，例如</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">cwe_module!</span><span class="token punctuation">(</span><span class="token string">"CWE119"</span><span class="token punctuation">,</span> <span class="token string">"0.3"</span><span class="token punctuation">,</span> check_cwe<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>打印每个模块的版本信息：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> args<span class="token punctuation">.</span>module_versions <span class="token punctuation">&#123;</span>                                                       
    <span class="token comment">// 仅打印模块版本然后退出</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"[cwe_checker] module_versions:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> module <span class="token keyword">in</span> modules<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;module&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>将 bare_metal_config 指定路径的 json 文件转化为 BareMetalConfig 结构体</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> bare_metal_config_opt<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span> <span class="token operator">=</span>
        args<span class="token punctuation">.</span>bare_metal_config<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>config_path<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>config_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_reader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Parsing of the bare metal configuration file failed"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>BareMetalConfig 结构体位于 src\cwe_checker_lib\src\utils\binary.rs</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">BareMetalConfig</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> processor_id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>		<span class="token comment">// 指定 CPU 类型</span>
    <span class="token keyword">pub</span> flash_base_address<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>  <span class="token comment">// Flash 起始地址（程序代码）</span>
    <span class="token keyword">pub</span> ram_base_address<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>	<span class="token comment">// RAM 起始地址（数据、堆栈）</span>
    <span class="token keyword">pub</span> ram_size<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>		   <span class="token comment">// RAM 大小</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>bare_metal_config 配置文件示例</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"_comment"</span><span class="token operator">:</span> <span class="token string">"The CPU architecture of the chip. Valid values are those that Ghidra accepts as processor IDs."</span><span class="token punctuation">,</span>
    <span class="token property">"processor_id"</span><span class="token operator">:</span> <span class="token string">"ARM:LE:32:v8"</span><span class="token punctuation">,</span>
    <span class="token property">"_comment_1"</span><span class="token operator">:</span> <span class="token string">"The base address, where the contents of the binary would be mapped on the chip, as a hexadecimal number."</span><span class="token punctuation">,</span>
    <span class="token property">"flash_base_address"</span><span class="token operator">:</span> <span class="token string">"0x08000000"</span><span class="token punctuation">,</span>
    <span class="token property">"_comment_2"</span><span class="token operator">:</span> <span class="token string">"The base address, of the RAM memory region as a hexadecimal number."</span><span class="token punctuation">,</span>
    <span class="token property">"ram_base_address"</span><span class="token operator">:</span> <span class="token string">"0x20000000"</span><span class="token punctuation">,</span>
    <span class="token property">"_comment_3"</span><span class="token operator">:</span> <span class="token string">"The size of the RAM memory region (in bytes) as a hexadecimal number."</span><span class="token punctuation">,</span>
    <span class="token property">"ram_size"</span><span class="token operator">:</span> <span class="token string">"0x00030000"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>区别：</p>
<pre class="line-numbers language-none"><code class="language-none">普通程序内存布局：							逻辑程序内存布局：
0x08048000 ──────┐							0x08000000 ──────┐
                 │ .text (代码段)			                    │ Flash (整个二进制)
0x0804A000 ──────┼							0x08020000 ──────┼
                 │ .data (数据段)  		                    │ RAM (数据区)		
0x0804B000 ──────┼							0x08022000 ──────┘
                 │ .bss (BSS段)
                 │
0x0804C000 ──────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>获取二进制文件路径</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> binary_file_path <span class="token operator">=</span> <span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>binary<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>反编译二进制文件：将二进制文件路径、配置文件路径、debug 设置传递给 disassemble_binary 函数（位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cmod.rs">src\cwe_checker_lib\src\pipeline\mod.rs</a>），返回二进制程序字节形式的文件内容（bianry）和 Project 结构体（project）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token punctuation">(</span>binary<span class="token punctuation">,</span> project<span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token function">disassemble_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary_file_path<span class="token punctuation">,</span> bare_metal_config_opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>debug_settings<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>其中 Project 结构体如下（位于 cwe_checker_lib\src\intermediate_representation\project.rs），该结构体是一个用于表示二进制文件的主要数据，包含反编译后的信息、执行环境等</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Project</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> program<span class="token punctuation">:</span> <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Program</span><span class="token operator">></span><span class="token punctuation">,</span>			    <span class="token comment">// 二进制文件中所有已知可执行代码（反汇编后的程序）</span>
    <span class="token keyword">pub</span> cpu_architecture<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>		    <span class="token comment">// 二进制文件的CPU 架构</span>
    <span class="token keyword">pub</span> stack_pointer_register<span class="token punctuation">:</span> <span class="token class-name">Variable</span><span class="token punctuation">,</span>	<span class="token comment">// 栈指针寄存器</span>
    <span class="token comment">// 可用于调用外部函数的已知调用约定集合</span>
    <span class="token keyword">pub</span> calling_conventions<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CallingConvention</span><span class="token operator">></span><span class="token punctuation">,</span>	
    <span class="token keyword">pub</span> register_set<span class="token punctuation">:</span> <span class="token class-name">BTreeSet</span><span class="token operator">&lt;</span><span class="token class-name">Variable</span><span class="token operator">></span><span class="token punctuation">,</span>		    <span class="token comment">// 已知基础物理寄存器</span>
    <span class="token keyword">pub</span> datatype_properties<span class="token punctuation">:</span> <span class="token class-name">DatatypeProperties</span><span class="token punctuation">,</span>	<span class="token comment">// 数据类型属性（例如大小）</span>
    <span class="token keyword">pub</span> runtime_memory_image<span class="token punctuation">:</span> <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">,</span>	<span class="token comment">// 加载到内存的内存映像</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在调试模式（指定参数 –debug cg）下生成并输出程序的调用图，构建调用图函数位于 <a href="###cwe_checker_lib/src/analysis/graph/call.rs">cwe_checker_lib&#x2F;src&#x2F;analysis&#x2F;graph&#x2F;call.rs</a></p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> debug_settings<span class="token punctuation">.</span><span class="token function">should_debug</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">CallGraph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>	
    <span class="token comment">// 从 project.program 构建调用图，以函数为节点、调用关系为边的有向图，用于展示函数间的调用关系</span>
    <span class="token keyword">let</span> cg <span class="token operator">=</span> <span class="token namespace">graph<span class="token punctuation">::</span>call<span class="token punctuation">::</span></span><span class="token class-name">CallGraph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 以紧凑 JSON 的格式打印调用图数据</span>
    debug_settings<span class="token punctuation">.</span><span class="token function">print_compact_json</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cg<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">CallGraph</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>处理 cfg_stats 参数：根据反编译后的程序构建一份控制流图（CFG）的统计信息对象（如函数内圈复杂度、基本块数、指令数、外部函数被调用次数等，函数位于 <a href="###src/caller/src/cfg_stats.rs">src&#x2F;caller&#x2F;src&#x2F;cfg_stats.rs</a> ）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> args<span class="token punctuation">.</span>cfg_stats <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> cfg_stats <span class="token operator">=</span> <span class="token namespace">cfg_stats<span class="token punctuation">::</span></span><span class="token class-name">CfgProperties</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:#&#125;"</span><span class="token punctuation">,</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">to_value</span><span class="token punctuation">(</span>cfg_stats<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>过滤要执行的模块：</p>
<ul>
<li>存在 partial 参数就从参数获取要执行的 CWE 检查</li>
<li>如果是内核模块，则仅启用内核模块的检查</li>
<li>否则只默认禁用 CWE78</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> partial_module_list<span class="token punctuation">)</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>partial <span class="token punctuation">&#123;</span>
       <span class="token comment">// 从 partial 参数获取检查的 cwe 编号</span>
       <span class="token function">filter_modules_for_partial_run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> modules<span class="token punctuation">,</span> partial_module_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> project<span class="token punctuation">.</span>runtime_memory_image<span class="token punctuation">.</span>is_lkm <span class="token punctuation">&#123;</span>
       <span class="token comment">// 是内核模块则选择相应的内置 cwe 序列</span>
       modules<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>checkers<span class="token punctuation">::</span></span><span class="token constant">MODULES_LKM</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// CWE78在当前标准运行中被禁用，因为它在某些二进制文件上消耗大量RAM和计算时间</span>
       modules<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> module<span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token string">"CWE78"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>MODULES_LKM 位于 src\cwe_checker_lib\src\checkers.rs</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">MODULES_LKM</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">;</span> <span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"CWE134"</span><span class="token punctuation">,</span> <span class="token string">"CWE190"</span><span class="token punctuation">,</span> <span class="token string">"CWE215"</span><span class="token punctuation">,</span> <span class="token string">"CWE252"</span><span class="token punctuation">,</span> <span class="token string">"CWE416"</span><span class="token punctuation">,</span> <span class="token string">"CWE457"</span><span class="token punctuation">,</span> <span class="token string">"CWE467"</span><span class="token punctuation">,</span> <span class="token string">"CWE476"</span><span class="token punctuation">,</span> <span class="token string">"CWE676"</span><span class="token punctuation">,</span>
    <span class="token string">"CWE789"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>读取配置文件：</p>
<ul>
<li>指定了 config 参数，从指定的 config 路径获取配置文件</li>
<li>是内核模块，读取 src\lkm_config.json</li>
<li>否则使用默认配置文件：src\config.json</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> config<span class="token punctuation">:</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token class-name">Value</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> config_path<span class="token punctuation">)</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>config <span class="token punctuation">&#123;</span>	
       <span class="token comment">// 从 config 获取</span>
       <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>config_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_reader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Parsing of the configuration file failed"</span><span class="token punctuation">)</span><span class="token operator">?</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> project<span class="token punctuation">.</span>runtime_memory_image<span class="token punctuation">.</span>is_lkm <span class="token punctuation">&#123;</span>
       <span class="token comment">// 内核模块</span>
       <span class="token function">read_config_file</span><span class="token punctuation">(</span><span class="token string">"lkm_config.json"</span><span class="token punctuation">)</span><span class="token operator">?</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// 默认</span>
       <span class="token function">read_config_file</span><span class="token punctuation">(</span><span class="token string">"config.json"</span><span class="token punctuation">)</span><span class="token operator">?</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>配置每个 CWE 检查模块使用的符号列表和参数，例如：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"CWE78"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token property">"system_symbols"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"system"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token property">"CWE190"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token property">"symbols"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"xmalloc"</span><span class="token punctuation">,</span>
    <span class="token string">"malloc"</span><span class="token punctuation">,</span>
    <span class="token string">"realloc"</span><span class="token punctuation">,</span>
    <span class="token string">"calloc"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>生成程序控制流图：生成控制流图函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Canalysis%5Cgraph.rs">src\cwe_checker_lib\src\analysis\graph.rs</a></p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 生成含日志的程序级控制流图</span>
<span class="token keyword">let</span> control_flow_graph <span class="token operator">=</span> <span class="token namespace">graph<span class="token punctuation">::</span></span><span class="token function">get_program_cfg_with_logs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 如需调试 CFG 则以紧凑 JSON 形式输出</span>
   debug_settings<span class="token punctuation">.</span><span class="token function">print_compact_json</span><span class="token punctuation">(</span>control_flow_graph<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">ControlFlowGraph</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 汇总分析结果，包括二进制文件内容、控制流图 CFG、project 指针到 AnalysisResults 结构体</span>
<span class="token keyword">let</span> analysis_results <span class="token operator">=</span> <span class="token class-name">AnalysisResults</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary<span class="token punctuation">,</span> <span class="token operator">&amp;</span>control_flow_graph<span class="token punctuation">,</span> <span class="token operator">&amp;</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 AnalysisResults 结构体如下</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Clone, Copy)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AnalysisResults</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>	<span class="token comment">// 二进制文件内容</span>
    <span class="token keyword">pub</span> control_flow_graph<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Graph</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">,</span>	<span class="token comment">// 程序控制流图</span>
    <span class="token keyword">pub</span> project<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Project</span><span class="token punctuation">,</span>	<span class="token comment">// 指向 project 结构体的指针</span>
    <span class="token comment">// 函数签名分析的结果</span>
    <span class="token keyword">pub</span> function_signatures<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">FunctionSignature</span><span class="token operator">>></span><span class="token punctuation">,</span>	
    <span class="token comment">// 指针推理分析的结果</span>
    <span class="token keyword">pub</span> pointer_inference<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">PointerInference</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">,</span>
    <span class="token comment">// 字符串抽象分析的结果</span>
    <span class="token keyword">pub</span> string_abstraction<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">StringAbstraction</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">BricksDomain</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其关联函数如下</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>
        binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        control_flow_graph<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Graph</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">,</span>
        project<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Project</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">AnalysisResults</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">AnalysisResults</span> <span class="token punctuation">&#123;</span>
            binary<span class="token punctuation">,</span>
            control_flow_graph<span class="token punctuation">,</span>
            project<span class="token punctuation">,</span>
            function_signatures<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            pointer_inference<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            string_abstraction<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>设置依赖字符串抽象分析、指针推理的模块集合，并且根据集合是否为空来设置 needed 标志</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token comment">// 依赖字符串抽象分析的模块集合</span>
   <span class="token keyword">let</span> modules_depending_on_string_abstraction <span class="token operator">=</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">::</span><span class="token function">from_iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"CWE78"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 依赖指针推理的模块集合</span>
   <span class="token keyword">let</span> modules_depending_on_pointer_inference <span class="token operator">=</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">::</span><span class="token function">from_iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span> 
       <span class="token string">"CWE119"</span><span class="token punctuation">,</span> <span class="token string">"CWE134"</span><span class="token punctuation">,</span> <span class="token string">"CWE190"</span><span class="token punctuation">,</span> <span class="token string">"CWE252"</span><span class="token punctuation">,</span> <span class="token string">"CWE337"</span><span class="token punctuation">,</span> <span class="token string">"CWE416"</span><span class="token punctuation">,</span> <span class="token string">"CWE476"</span><span class="token punctuation">,</span> <span class="token string">"CWE789"</span><span class="token punctuation">,</span> <span class="token string">"Memory"</span><span class="token punctuation">,</span>
   <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// 是否需要运行字符串抽象分析，即字符串抽象分析的模块集合是否为空</span>
   <span class="token keyword">let</span> string_abstraction_needed <span class="token operator">=</span> modules 
       <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> modules_depending_on_string_abstraction<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 是否需要运行指针推理，即指针推理集合是否为空</span>
   <span class="token keyword">let</span> pi_analysis_needed <span class="token operator">=</span> string_abstraction_needed
       <span class="token operator">||</span> modules
           <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> modules_depending_on_pointer_inference<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>设置指针推理标记时，计算函数签名，并且保存到 analysis_results 结构体，函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cresults.rs">src\cwe_checker_lib\src\pipeline\results.rs</a></p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token keyword">let</span> function_signatures <span class="token operator">=</span> <span class="token keyword">if</span> pi_analysis_needed <span class="token punctuation">&#123;</span> <span class="token comment">// 若需要指针推理，先计算函数签名</span>
       <span class="token comment">// 计算函数参数/返回等签名信息</span>
       <span class="token keyword">let</span> function_signatures <span class="token operator">=</span> analysis_results<span class="token punctuation">.</span><span class="token function">compute_function_signatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
       <span class="token class-name">Some</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">None</span> <span class="token comment">// 不需要则为空</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 将函数签名附加到 analysis_results 分析结果结构体中</span>
   <span class="token keyword">let</span> analysis_results <span class="token operator">=</span>
       analysis_results<span class="token punctuation">.</span><span class="token function">with_function_signatures</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>设置指针推理标记，计算完函数签名后，运行指针推理，并且保存到 analysis_results 结构体，函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cresults.rs">src\cwe_checker_lib\src\pipeline\results.rs</a></p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token keyword">let</span> pi_analysis_results <span class="token operator">=</span> <span class="token keyword">if</span> pi_analysis_needed <span class="token punctuation">&#123;</span> <span class="token comment">// 需要运行指针推理</span>
       <span class="token comment">// 传入内存配置与统计开关，如果启用 statistics 则在日志消息中包含各种统计信息</span>
       <span class="token class-name">Some</span><span class="token punctuation">(</span>analysis_results<span class="token punctuation">.</span><span class="token function">compute_pointer_inference</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">[</span><span class="token string">"Memory"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>statistics<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
       <span class="token class-name">None</span> <span class="token comment">// 否则不计算</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 将指针推理结果附加到分析结果</span>
   <span class="token keyword">let</span> analysis_results <span class="token operator">=</span> analysis_results<span class="token punctuation">.</span><span class="token function">with_pointer_inference</span><span class="token punctuation">(</span>pi_analysis_results<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>设置字符串抽象分析标记，计算字符串抽象分析，函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cresults.rs">src\cwe_checker_lib\src\pipeline\results.rs</a></p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token keyword">let</span> string_abstraction_results <span class="token operator">=</span> <span class="token comment">// 需要则运行字符串抽象分析</span>
       <span class="token keyword">if</span> string_abstraction_needed <span class="token punctuation">&#123;</span>
           <span class="token class-name">Some</span><span class="token punctuation">(</span>analysis_results<span class="token punctuation">.</span><span class="token function">compute_string_abstraction</span><span class="token punctuation">(</span>
               <span class="token operator">&amp;</span>config<span class="token punctuation">[</span><span class="token string">"StringAbstraction"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 字符串抽象相关配置</span>
               pi_analysis_results<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 可能依赖指针推理结果</span>
           <span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
           <span class="token class-name">None</span>
       <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  
<span class="token comment">// 将字符串抽象结果附加到分析结果</span>
   <span class="token keyword">let</span> analysis_results <span class="token operator">=</span>
       analysis_results<span class="token punctuation">.</span><span class="token function">with_string_abstraction</span><span class="token punctuation">(</span>string_abstraction_results<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>打印调试信息</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> debug_settings<span class="token punctuation">.</span><span class="token function">should_debug</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Pi</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 若仅调试指针推理阶段</span>
    <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>analysis<span class="token punctuation">::</span>pointer_inference<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>analysis_results<span class="token punctuation">,</span>
        <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_value</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"Memory"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调试输出后提前结束</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>执行所有选定的检测模块，位于 [src\cwe_checker_lib\src\checkers](###*src\cwe_checker_lib\src\checkers（cwe modules）)</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 执行模块并收集它们的日志和CWE警告</span>
   <span class="token keyword">let</span> <span class="token keyword">mut</span> all_cwe_warnings <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 收集所有模块的CWE警告（含日志包装）</span>
   <span class="token keyword">for</span> module <span class="token keyword">in</span> modules <span class="token punctuation">&#123;</span> <span class="token comment">// 逐个运行启用的CWE模块</span>
       <span class="token keyword">let</span> cwe_warnings <span class="token operator">=</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysis_results<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">[</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传入分析结果、该模块配置、调试设置</span>
       all_cwe_warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cwe_warnings<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 累加结果</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>打印模块结果，当参数指定了 –quiet 则抑制日志消息</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">       <span class="token comment">// 打印模块的结果</span>
       <span class="token keyword">let</span> all_logs<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">LogMessage</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>quiet <span class="token punctuation">&#123;</span> <span class="token comment">// 如开启安静模式则抑制日志</span>
           <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 由于设置了`--quiet`标志，抑制所有日志消息</span>
       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">let</span> <span class="token keyword">mut</span> all_logs <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 否则汇总所有来源的日志</span>
  
       <span class="token comment">// 聚合所有带有日志的对象的日志 </span>
       all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>project<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		  		   <span class="token comment">// 工程阶段日志</span>
       all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>control_flow_graph<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 		    <span class="token comment">// CFG 构建日志</span>
       <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>function_signatures <span class="token punctuation">&#123;</span> 	<span class="token comment">// 函数签名日志</span>
           all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
       <span class="token keyword">for</span> cwe_warnings <span class="token keyword">in</span> all_cwe_warnings<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 			   <span class="token comment">// 各CWE模块日志</span>
           all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>cwe_warnings<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
  
       <span class="token keyword">if</span> args<span class="token punctuation">.</span>statistics <span class="token punctuation">&#123;</span>
           <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#125;</span>
       <span class="token keyword">if</span> <span class="token operator">!</span>args<span class="token punctuation">.</span>verbose <span class="token punctuation">&#123;</span> <span class="token comment">// 非详细模式下，过滤掉 Debug 级别日志</span>
           all_logs<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>log_msg<span class="token closure-punctuation punctuation">|</span></span> log_msg<span class="token punctuation">.</span>level <span class="token operator">!=</span> <span class="token class-name">LogLevel</span><span class="token punctuation">::</span><span class="token class-name">Debug</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
  
       all_logs
   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// 展平成所有CWE告警列表</span>
   <span class="token keyword">let</span> all_cwes<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">CweWarning</span><span class="token operator">></span> <span class="token operator">=</span> all_cwe_warnings<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">// 根据参数选择输出到文件/控制台，支持JSON</span>
   <span class="token function">print_all_messages</span><span class="token punctuation">(</span>all_logs<span class="token punctuation">,</span> all_cwes<span class="token punctuation">,</span> args<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="src-cwe-checker-lib-src-pipeline-mod-rs"><a href="#src-cwe-checker-lib-src-pipeline-mod-rs" class="headerlink" title="src\cwe_checker_lib\src\pipeline\mod.rs"></a>src\cwe_checker_lib\src\pipeline\mod.rs</h3><h4 id="disassemble-binary-反编译程序"><a href="#disassemble-binary-反编译程序" class="headerlink" title="disassemble_binary 反编译程序"></a>disassemble_binary 反编译程序</h4><p>功能：反编译二进制程序</p>
<p>在 run_with_ghidra 中被调用，传入参数为二进制文件路径、bare_metal_config、调试设置，返回二进制程序内容和 project 结构体</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token punctuation">(</span>binary<span class="token punctuation">,</span> project<span class="token punctuation">)</span> <span class="token operator">=</span> 
	<span class="token function">disassemble_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary_file_path<span class="token punctuation">,</span> bare_metal_config_opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>debug_settings<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li><p>以字节形式获取二进制文件的内容到 binary 字节向量</p>
</li>
<li><p>将二进制程序、文件路径、bare_metal_config、debug_settings 传递给 ghidra 进行分析，得到 project 结构体和原始 IR，相关代码位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cutils%5Cghidra.rs">src\cwe_checker_lib\src\utils\ghidra.rs</a></p>
</li>
<li><p>调用 [project.optimize](####project.optimize 优化 IR) 对 IR 进行优化：cwe_checker 使用 Pcode 作为输入，将其转换为自己的中间表示（IR）进行漏洞检测</p>
</li>
<li><p>生成二进制文件的运行时内存映像表示，并全局调整一次内存地址，存放到 project.runtime_memory_image</p>
<blockquote>
<p>ghidra 为了分析方便可能会将整个程序移动到一个非零的地址，也就是加上了一个基址，所以在获取真实地址的时候需要减去基址，这里调整内存地址后续就无需再考虑基址问题</p>
</blockquote>
</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">disassemble_binary</span><span class="token punctuation">(</span>
    binary_file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span> 					  <span class="token comment">// 二进制文件路径</span>
    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 可选的裸机配置</span>
    debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">,</span> 			   <span class="token comment">// 调试设置</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 返回（二进制内容，带日志的项目）或错误</span>
    
    <span class="token keyword">let</span> binary<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token comment">// 读取二进制文件内容到字节向量，读取失败时添加上下文错误信息</span>
        <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">read</span><span class="token punctuation">(</span>binary_file_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Could not read from binary file path &#123;&#125;"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> <span class="token keyword">mut</span> project <span class="token operator">=</span> <span class="token function">get_project_from_ghidra</span><span class="token punctuation">(</span> <span class="token comment">// 从 Ghidra 获取项目信息</span>
        binary_file_path<span class="token punctuation">,</span> 					 <span class="token comment">// 文件路径</span>
        <span class="token operator">&amp;</span>binary<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 	 				     <span class="token comment">// 二进制内容字节向量</span>
        bare_metal_config_opt<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 	 	  <span class="token comment">// 裸机配置（克隆以避免所有权转移）</span>
        debug_settings<span class="token punctuation">,</span>   			         <span class="token comment">// 调试设置</span>
    <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// 规范化项目并收集其生成的日志消息，打印原始IR表示</span>
    debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">IrForm</span><span class="token punctuation">::</span><span class="token class-name">Raw</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    project<span class="token punctuation">.</span><span class="token function">optimize</span><span class="token punctuation">(</span>debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对项目进行优化（应用各种IR变换）</span>

    debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span> <span class="token comment">// 打印优化后的IR表示</span>
        <span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>
        <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">IrForm</span><span class="token punctuation">::</span><span class="token class-name">Optimized</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 生成二进制文件的运行时内存映像表示</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> runtime_memory_image <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>bare_metal_config<span class="token punctuation">)</span> <span class="token operator">=</span> bare_metal_config_opt<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 	   <span class="token punctuation">&#123;</span>
        <span class="token comment">// 如果提供了裸机配置，使用裸机模式生成内存映像</span>
        <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">new_from_bare_metal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary<span class="token punctuation">,</span> bare_metal_config<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Error while generating runtime memory image."</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 否则使用标准ELF/PE模式生成内存映像</span>
        <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Error while generating runtime memory image."</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 全局调整一次内存地址，这样其他分析就不需要调整它们的地址</span>
        runtime_memory_image<span class="token punctuation">.</span><span class="token function">add_global_memory_offset</span><span class="token punctuation">(</span>project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    project<span class="token punctuation">.</span>runtime_memory_image <span class="token operator">=</span> runtime_memory_image<span class="token punctuation">;</span> <span class="token comment">// 将内存映像赋值给项目</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>binary<span class="token punctuation">,</span> project<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 返回（二进制内容，项目）元组</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="project-optimize-优化-IR"><a href="#project-optimize-优化-IR" class="headerlink" title="project.optimize 优化 IR"></a>project.optimize 优化 IR</h4><p>位于 src\cwe_checker_lib\src\intermediate_representation\project.rs</p>
<ul>
<li>IntraproceduralDeadBlockElimPass：删除函数内部不可达的基本快并移除无效控制流边与语句，例如入口不可达、恒真&#x2F;恒假条件折叠后的残留块、无条件跳转后的冗余分支等</li>
<li>InputExpressionPropagationPass： 沿赋值链传播“输入”表达式（参数、全局读、调用返回、内存加载等），在等价且安全的场合用来源替换表达式，减少临时变量层级</li>
<li>TrivialExpressionSubstitutionPass：对简单&#x2F;可决表达式进行代数化简与常量折叠，即完成中间简单计算的过程，例如<code>t = y &amp; 0 =&gt; t = 0</code>       <code>t = x + 0; t1 = 3 * 4 + t =&gt; t1 = 12 + x</code> </li>
<li>DeadVariableElimPass：删除对未使用变量的赋值，例如写死&#x2F;死存储，或被写入但未读的值</li>
<li>ControlFlowPropagationPass：简化分支条件、等价分支，消除恒真&#x2F;恒假路径</li>
<li>StackPointerAlignmentSubstitutionPass：利用按位与的对齐操作对齐栈指针</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">optimize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> logs <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化日志收集器，用于收集优化过程中的日志信息</span>

        <span class="token comment">// 运行过程内死块消除优化：移除函数内不可达的基本块</span>
        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>  <span class="token comment">// 要优化的程序 IR</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">// 无额外参数</span>
            <span class="token class-name">IntraproceduralDeadBlockElimPass</span><span class="token punctuation">,</span> <span class="token comment">// 优化过程名称</span>
            logs<span class="token punctuation">,</span>             <span class="token comment">// 日志收集器</span>
            debug_settings<span class="token punctuation">,</span>   <span class="token comment">// 调试设置</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 运行输入表达式传播优化：将输入表达式沿着赋值传播</span>
        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">InputExpressionPropagationPass</span><span class="token punctuation">,</span>
            logs<span class="token punctuation">,</span>
            debug_settings<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 运行平凡表达式替换优化：用结果替换简单的算术表达式</span>
        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">TrivialExpressionSubstitutionPass</span><span class="token punctuation">,</span>
            logs<span class="token punctuation">,</span>
            debug_settings<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 运行死变量消除优化：移除对未使用变量的赋值</span>
        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>register_set<span class="token punctuation">,</span> <span class="token comment">// 需要寄存器集合信息</span>
            <span class="token class-name">DeadVariableElimPass</span><span class="token punctuation">,</span>
            logs<span class="token punctuation">,</span>
            debug_settings<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 运行控制流传播优化：简化具有相同条件的条件语句</span>
        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ControlFlowPropagationPass</span><span class="token punctuation">,</span>
            logs<span class="token punctuation">,</span>
            debug_settings<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 运行栈指针对齐替换优化：用减法替换逻辑AND对齐操作</span>
        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">,</span>             <span class="token comment">// 需要完整的项目信息</span>
            <span class="token class-name">StackPointerAlignmentSubstitutionPass</span><span class="token punctuation">,</span>
            logs<span class="token punctuation">,</span>
            debug_settings<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 验证各项优化的后置条件（仅在调试模式下）</span>
        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">IntraproceduralDeadBlockElimPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InputExpressionPropagationPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TrivialExpressionSubstitutionPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>register_set<span class="token punctuation">,</span> <span class="token class-name">DeadVariableElimPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ControlFlowPropagationPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">,</span>
            <span class="token class-name">StackPointerAlignmentSubstitutionPass</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">add_logs</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span> <span class="token comment">// 将收集的日志添加到项目中</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="src-cwe-checker-lib-src-utils-ghidra-rs"><a href="#src-cwe-checker-lib-src-utils-ghidra-rs" class="headerlink" title="src\cwe_checker_lib\src\utils\ghidra.rs"></a>src\cwe_checker_lib\src\utils\ghidra.rs</h3><p>功能：调用 ghidra 进行反编译，返回 Project 结构体指针</p>
<h4 id="get-project-from-ghidra-调用-ghidra-获取-Project-结构体信息"><a href="#get-project-from-ghidra-调用-ghidra-获取-Project-结构体信息" class="headerlink" title="get_project_from_ghidra 调用 ghidra 获取 Project 结构体信息"></a>get_project_from_ghidra 调用 ghidra 获取 Project 结构体信息</h4><ul>
<li><p>如果使用 –pcode-raw 参数，则获取指定文件中的 pcode，解析为 PcodeProject 结构体（与 PcodeRaw 结构一致，只是表现形式不同，将 json 转化成 rust 类型结构）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">PcodeProject</span> <span class="token punctuation">&#123;</span>
    program<span class="token punctuation">:</span> <span class="token class-name">Program</span><span class="token punctuation">,</span> <span class="token comment">// 程序代码</span>
    register_properties<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">RegisterProperties</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 所有 CPU 架构特定寄存器的信息</span>
    cpu_arch<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// CPU 架构</span>
    external_functions<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ExternFunction</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 导入的函数</span>
    entry_points<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 导出的函数（入口点）</span>
    stack_pointer_register<span class="token punctuation">:</span> <span class="token class-name">Varnode</span><span class="token punctuation">,</span> <span class="token comment">// CPU 架构的栈指针寄存器</span>
    calling_conventions<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CallingConvention</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 给定 CPU 架构的已知调用约定信息</span>
    datatype_properties<span class="token punctuation">:</span> <span class="token class-name">DatatypeProperties</span><span class="token punctuation">,</span> <span class="token comment">// 包含 C 数据类型的属性，例如它们的大小</span>
    image_base<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// 程序映像在内存中的基址</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>获取临时文件夹和时间戳，拼接得到唯一管道名称</p>
</li>
<li><p>调用 [generate_ghidra_call_command](####generate_ghidra_call_command 生成调用 ghidra 的命令) 函数生成调用 ghidra 的命令</p>
</li>
<li><p>调用 execute_ghidra 执行ghidra 并且获取 pcode，解析为 PcodeProject 结构体，执行失败将直接终止程序</p>
</li>
<li><p>调用 [parse_pcode_project_to_ir_project](####parse_pcode_project_to_ir_project 将 Pcode 项目解析为 IR 项目) 将 Pcode 项目解析为 IR 项目</p>
</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_project_from_ghidra</span><span class="token punctuation">(</span>
    file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span>								 <span class="token comment">// 二进制文件路径</span>
    binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 									 <span class="token comment">// 二进制文件内容</span>
    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> 	<span class="token comment">// 可选的裸机配置</span>
    debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">,</span> 				   <span class="token comment">// 调试设置</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// 如果通过 --pcode-raw 指定过 pcode 则从文件获取 pcode</span>
    <span class="token keyword">let</span> pcode_project <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>saved_pcode_raw<span class="token punctuation">)</span> <span class="token operator">=</span> debug_settings<span class="token punctuation">.</span><span class="token function">get_saved_pcode_raw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>saved_pcode_raw<span class="token punctuation">)</span>	<span class="token comment">// 打开指定的 pcode 文件</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to open saved output of Pcode Extractor plugin."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> saved_pcode_raw <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> saved_pcode_raw<span class="token punctuation">)</span>	<span class="token comment">// 从文件读取指定的 pcode</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to read saved Pcode Extractor plugin output"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>saved_pcode_raw<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Pcode</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">PcodeForm</span><span class="token punctuation">::</span><span class="token class-name">Raw</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>saved_pcode_raw<span class="token punctuation">)</span><span class="token operator">?</span>     <span class="token comment">// 解析 JSON 为 PcodeProject</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 没有指定 pcode 则调用 ghidra 生成</span>
        <span class="token keyword">let</span> tmp_folder <span class="token operator">=</span> <span class="token function">get_tmp_folder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// 获取临时文件夹</span>
        <span class="token comment">// 为文件名添加时间戳后缀，以便多个 cwe_checker 实例并行运行同一文件时互不干扰</span>
        <span class="token keyword">let</span> timestamp_suffix <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span>
            <span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span>
            <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">duration_since</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token constant">UNIX_EPOCH</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">as_millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为管道创建唯一名称</span>
        <span class="token keyword">let</span> fifo_path <span class="token operator">=</span> tmp_folder<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"pcode_&#123;timestamp_suffix&#125;.pipe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">let</span> ghidra_command <span class="token operator">=</span> <span class="token function">generate_ghidra_call_command</span><span class="token punctuation">(</span> <span class="token comment">// 生成调用 Ghidra 的命令</span>
            file_path<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>fifo_path<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>timestamp_suffix<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>bare_metal_config_opt<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token function">execute_ghidra</span><span class="token punctuation">(</span>ghidra_command<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fifo_path<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token comment">// 执行 Ghidra 并获取结果</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span> <span class="token comment">// 打印解析后的 Pcode</span>
        <span class="token operator">&amp;</span>pcode_project<span class="token punctuation">,</span>
        <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Pcode</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">PcodeForm</span><span class="token punctuation">::</span><span class="token class-name">Parsed</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">parse_pcode_project_to_ir_project</span><span class="token punctuation">(</span> <span class="token comment">// 将 Pcode 项目解析为 IR 项目</span>
        pcode_project<span class="token punctuation">,</span>
        binary<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>bare_metal_config_opt<span class="token punctuation">,</span>
        debug_settings<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="generate-ghidra-call-command-生成调用-ghidra-的命令"><a href="#generate-ghidra-call-command-生成调用-ghidra-的命令" class="headerlink" title="generate_ghidra_call_command 生成调用 ghidra 的命令"></a>generate_ghidra_call_command 生成调用 ghidra 的命令</h4><ul>
<li><p>从 ghidra.json 配置文件读取 ghidra 路径，获取 Pcode 插件路径</p>
</li>
<li><p>获取临时文件夹，优先使用系统运行时的 cwe_checker 目录，如果不存在则创建 &#x2F;tmp&#x2F;cwe_checker 目录</p>
</li>
<li><p>从二进制文件路径提取二进制文件的文件名</p>
</li>
<li><p>创建 ghidra 命令对象并设置命令参数，如果提供了 bare_metal_config 则进行额外设置</p>
<ul>
<li><p>无 bare_metal_config：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>ghidra_path<span class="token operator">></span>/support/analyzeHeadless <span class="token operator">&lt;</span>tmp_folder<span class="token operator">></span> <span class="token string">"PcodeExtractor_&lt;filename>_&lt;timestamp>"</span> <span class="token parameter variable">-import</span> <span class="token operator">&lt;</span>file_path<span class="token operator">></span> <span class="token parameter variable">-postScript</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span>/PcodeExtractor.java <span class="token operator">&lt;</span>fifo_path<span class="token operator">></span> <span class="token parameter variable">-scriptPath</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span> <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>示例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/opt/ghidra/support/analyzeHeadless /tmp/cwe_checker <span class="token string">"PcodeExtractor_test_program_1234567890"</span> <span class="token parameter variable">-import</span> /home/user/binary <span class="token parameter variable">-postScript</span> /usr/local/lib/cwe_checker/ghidra_plugin/PcodeExtractor.java /tmp/cwe_checker/pcode_1234567890.pipe <span class="token parameter variable">-scriptPath</span> /usr/local/lib/cwe_checker/ghidra_plugin <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>有 bare_metal_config：其中 -loader-baseAddr 地址不包含 0x，输入值含有 0x 的时候会自动去除</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>ghidra_path<span class="token operator">></span>/support/analyzeHeadless <span class="token operator">&lt;</span>tmp_folder<span class="token operator">></span> <span class="token string">"PcodeExtractor_&lt;filename>_&lt;timestamp>"</span> <span class="token parameter variable">-import</span> <span class="token operator">&lt;</span>file_path<span class="token operator">></span> <span class="token parameter variable">-postScript</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span>/PcodeExtractor.java <span class="token operator">&lt;</span>fifo_path<span class="token operator">></span> <span class="token parameter variable">-scriptPath</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span> <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span> <span class="token parameter variable">-loader</span> BinaryLoader -loader-baseAddr <span class="token operator">&lt;</span>base_address<span class="token operator">></span> <span class="token parameter variable">-processor</span> <span class="token operator">&lt;</span>processor_id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>示例：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/opt/ghidra/support/analyzeHeadless /tmp/cwe_checker <span class="token string">"PcodeExtractor_firmware.bin_1234567890"</span> <span class="token parameter variable">-import</span> /home/user/firmware.bin <span class="token parameter variable">-postScript</span> /usr/local/lib/cwe_checker/ghidra_plugin/PcodeExtractor.java /tmp/cwe_checker/pcode_1234567890.pipe <span class="token parameter variable">-scriptPath</span> /usr/local/lib/cwe_checker/ghidra_plugin <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span> <span class="token parameter variable">-loader</span> BinaryLoader -loader-baseAddr <span class="token number">8000000</span> <span class="token parameter variable">-processor</span> ARM:LE:32:Cortex<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
</li>
<li><p>返回 ghidra 命令对象</p>
</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 生成用于调用 Ghidra 并在其中执行 P-Code-Extractor 插件的命令</span>
<span class="token keyword">fn</span> <span class="token function-definition function">generate_ghidra_call_command</span><span class="token punctuation">(</span>
    file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span> <span class="token comment">// 二进制文件路径</span>
    fifo_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span> <span class="token comment">// FIFO 命名管道路径</span>
    timestamp_suffix<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token comment">// 时间戳后缀（用于创建唯一的项目名称）</span>
    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 可选的裸机配置</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Command</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// 从配置文件中读取 Ghidra 路径</span>
    <span class="token keyword">let</span> ghidra_path<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">PathBuf</span> <span class="token operator">=</span>
        <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_value</span><span class="token punctuation">(</span><span class="token function">read_config_file</span><span class="token punctuation">(</span><span class="token string">"ghidra.json"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">[</span><span class="token string">"ghidra_path"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Path to Ghidra not configured."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> headless_path <span class="token operator">=</span> ghidra_path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"support/analyzeHeadless"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Ghidra 无头模式可执行文件路径</span>
    <span class="token keyword">let</span> tmp_folder <span class="token operator">=</span> <span class="token function">get_tmp_folder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// 获取临时文件夹</span>
    <span class="token comment">// 从文件路径中提取文件名</span>
    <span class="token keyword">let</span> filename <span class="token operator">=</span> file_path
        <span class="token punctuation">.</span><span class="token function">file_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ok_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"Invalid file name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>
        <span class="token punctuation">.</span><span class="token function">to_string_lossy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> ghidra_plugin_path <span class="token operator">=</span> <span class="token function">get_ghidra_plugin_path</span><span class="token punctuation">(</span><span class="token string">"p_code_extractor"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// 获取 Pcode 提取器插件路径</span>

    <span class="token comment">// 创建 Ghidra 命令对象</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> ghidra_command <span class="token operator">=</span> <span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>headless_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ghidra_command
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp_folder<span class="token punctuation">)</span> <span class="token comment">// 存储临时文件的文件夹</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"PcodeExtractor_&#123;filename&#125;_&#123;timestamp_suffix&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 临时 Ghidra 项目的名称</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-import"</span><span class="token punctuation">)</span> <span class="token comment">// 将文件导入到 Ghidra 项目中</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token comment">// 文件导入路径</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-postScript"</span><span class="token punctuation">)</span> <span class="token comment">// 在 Ghidra 完成标准分析后执行脚本</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>ghidra_plugin_path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"PcodeExtractor.java"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// PcodeExtractor.java 的路径</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>fifo_path<span class="token punctuation">)</span> <span class="token comment">// 命名管道（fifo）的路径</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-scriptPath"</span><span class="token punctuation">)</span> <span class="token comment">// 将包含其他脚本文件的文件夹添加到 Ghidra 脚本文件搜索路径</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>ghidra_plugin_path<span class="token punctuation">)</span> <span class="token comment">// 包含 PcodeExtractor.java 的文件夹路径（以便找到其他 Java 文件）</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-deleteProject"</span><span class="token punctuation">)</span> <span class="token comment">// 脚本完成后删除临时项目</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-analysisTimeoutPerFile"</span><span class="token punctuation">)</span> <span class="token comment">// 设置标准分析在终止前可以运行多长时间的超时</span>
        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"3600"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 超时时间为一小时（=3600秒）// TODO: 后置脚本可以检测到超时触发并相应处理</span>
    <span class="token comment">// 如果提供了裸机配置，添加额外的命令参数</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>bare_metal_config<span class="token punctuation">)</span> <span class="token operator">=</span> bare_metal_config_opt <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> base_address<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>bare_metal_config<span class="token punctuation">.</span>flash_base_address<span class="token punctuation">;</span> <span class="token comment">// 获取基础地址字符串</span>
        <span class="token comment">// 如果地址以 "0x" 开头，去掉前缀</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>stripped_address<span class="token punctuation">)</span> <span class="token operator">=</span> base_address<span class="token punctuation">.</span><span class="token function">strip_prefix</span><span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            base_address <span class="token operator">=</span> stripped_address<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        ghidra_command
            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-loader"</span><span class="token punctuation">)</span> <span class="token comment">// 告诉 Ghidra 使用特定的加载器</span>
            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"BinaryLoader"</span><span class="token punctuation">)</span> <span class="token comment">// 对裸机二进制文件使用 BinaryLoader</span>
            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-loader-baseAddr"</span><span class="token punctuation">)</span> <span class="token comment">// 提供二进制文件应映射到内存中的基础地址</span>
            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>base_address<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-processor"</span><span class="token punctuation">)</span> <span class="token comment">// 提供处理器类型 ID，该二进制文件是为该处理器编译的</span>
            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>bare_metal_config<span class="token punctuation">.</span>processor_id<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span>ghidra_command<span class="token punctuation">)</span> <span class="token comment">// 返回配置好的命令</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/// 获取程序应存储临时文件的文件夹</span>
<span class="token keyword">fn</span> <span class="token function-definition function">get_tmp_folder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">PathBuf</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取 cwe_checker 的项目目录路径</span>
    <span class="token keyword">let</span> project_dirs <span class="token operator">=</span> <span class="token class-name">ProjectDirs</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"cwe_checker"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Could not determine path for temporary files"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// 优先使用运行时目录，如果不存在则使用默认的 /tmp/cwe_checker</span>
    <span class="token keyword">let</span> tmp_folder <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>folder<span class="token punctuation">)</span> <span class="token operator">=</span> project_dirs<span class="token punctuation">.</span><span class="token function">runtime_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        folder <span class="token comment">// 使用系统运行时目录（如 Linux 的 /run/user/xxx/cwe_checker）</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"/tmp/cwe_checker"</span><span class="token punctuation">)</span> <span class="token comment">// 回退到 /tmp/cwe_checker</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果临时文件夹不存在，创建它</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>tmp_folder<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">create_dir</span><span class="token punctuation">(</span>tmp_folder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Unable to create temporary folder"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>tmp_folder<span class="token punctuation">.</span><span class="token function">to_path_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 返回临时文件夹路径</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="parse-pcode-project-to-ir-project-将-Pcode-项目解析为-IR-项目"><a href="#parse-pcode-project-to-ir-project-将-Pcode-项目解析为-IR-项目" class="headerlink" title="parse_pcode_project_to_ir_project 将 Pcode 项目解析为 IR 项目"></a>parse_pcode_project_to_ir_project 将 Pcode 项目解析为 IR 项目</h4><ul>
<li>指定了 bare_metal_config 则获取其中的基址</li>
<li>从二进制文件中获取到基址后调用 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cghidra_pcode%5Cmod.rs">pcode_project.into_ir_project</a> 转换为 project 结构体</li>
<li>获取基址失败，则尝试从 bare_metal_config 获取基址，并且设置偏移量为 0</li>
<li>找不到基址，则设置 0 为默认值</li>
<li>返回 project 结构体</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">parse_pcode_project_to_ir_project</span><span class="token punctuation">(</span>
    pcode_project<span class="token punctuation">:</span> <span class="token class-name">PcodeProject</span><span class="token punctuation">,</span> <span class="token comment">// Ghidra 的 Pcode 项目</span>
    binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 二进制文件内容</span>
    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 可选的裸机配置</span>
    debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">,</span> <span class="token comment">// 调试设置</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 如果提供了裸机配置，解析其基础地址</span>
    <span class="token keyword">let</span> bare_metal_base_address_opt <span class="token operator">=</span> bare_metal_config_opt
        <span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>config<span class="token closure-punctuation punctuation">|</span></span> config<span class="token punctuation">.</span><span class="token function">parse_binary_base_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> project<span class="token punctuation">:</span> <span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">get_base_address</span><span class="token punctuation">(</span>binary<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 成功获取二进制文件基础地址，使用该地址转换项目</span>
            pcode_project<span class="token punctuation">.</span><span class="token function">into_ir_project</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>_err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 无法从二进制文件获取基础地址</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">)</span> <span class="token operator">=</span> bare_metal_base_address_opt <span class="token punctuation">&#123;</span>
                <span class="token comment">// 如果有裸机配置提供的基础地址，使用它</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> project <span class="token operator">=</span>
                    pcode_project<span class="token punctuation">.</span><span class="token function">into_ir_project</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 对于裸机二进制，将地址偏移量设为 0</span>
                project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                project
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 没有基础地址，使用 0 作为默认值</span>
                <span class="token keyword">let</span> <span class="token keyword">mut</span> project <span class="token operator">=</span> pcode_project<span class="token punctuation">.</span><span class="token function">into_ir_project</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 添加日志消息，说明使用了回退方案</span>
                project<span class="token punctuation">.</span><span class="token function">add_log_msg</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">::</span><span class="token function">new_info</span><span class="token punctuation">(</span><span class="token string">"Could not determine binary base address. Using base address of Ghidra output as fallback."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                project
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span> <span class="token comment">// 返回解析后的项目</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="src-cwe-checker-lib-src-ghidra-pcode-mod-rs"><a href="#src-cwe-checker-lib-src-ghidra-pcode-mod-rs" class="headerlink" title="src\cwe_checker_lib\src\ghidra_pcode\mod.rs"></a>src\cwe_checker_lib\src\ghidra_pcode\mod.rs</h3><h4 id="PcodeProject-into-ir-project-将-PcodeProject-转化成-IR"><a href="#PcodeProject-into-ir-project-将-PcodeProject-转化成-IR" class="headerlink" title="PcodeProject.into_ir_project 将 PcodeProject 转化成 IR"></a>PcodeProject.into_ir_project 将 PcodeProject 转化成 IR</h4><ul>
<li><p>初始化日志向量，创建寄存器映射表，将程序转化为 IR 函数项的映射表</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> logs <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 初始化日志向量，用于收集处理过程中的日志消息</span>
<span class="token keyword">let</span> register_map <span class="token operator">=</span> <span class="token class-name">RegisterMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>register_properties<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建寄存器映射表</span>
<span class="token comment">// 将程序转换为 IR 函数项的映射表（函数 TID -> 函数项）</span>
<span class="token keyword">let</span> ir_function_terms_map <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span><span class="token function">to_ir_function_terms_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 to_ir_function_terms_map 位于src\cwe_checker_lib\src\ghidra_pcode\program.rs，返回一个 BTreeMap，键是函数的 Tid（线程标识符），值是转换后的 IR 函数项，Program 结构体如下（参考 PcodeRaw 中的 Program）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Program</span> <span class="token punctuation">&#123;</span>
    functions<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Function</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Tid 结构体位于 src\cwe_checker_lib\src\intermediate_representation\term.rs</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone, PartialOrd, Ord)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Tid</span> <span class="token punctuation">&#123;</span>
    id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>			    <span class="token comment">// 唯一标识符</span>
    address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">,</span>	<span class="token comment">// 地址</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>to_ir_function_terms_map 函数如下：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">to_ir_function_terms_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// 创建一个空的 HashSet 来存储所有跳转目标（类型为 Tid）</span>
       <span class="token keyword">let</span> jump_targets<span class="token punctuation">:</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">self</span>
           <span class="token punctuation">.</span><span class="token function">blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">// 获取程序中所有基本块的迭代器</span>
           <span class="token comment">// 收集该块中的所有跳转目标，使用 flat_map 将多个 HashSet 展平为一个 HashSet</span>
           <span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>block<span class="token closure-punctuation punctuation">|</span></span> block<span class="token punctuation">.</span><span class="token function">collect_jmp_targets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 将所有跳转目标收集到一个 HashSet 中</span>
  
       <span class="token comment">// 创建一个空的 BTreeMap 来存储转换结果，键是函数 Tid，值是 IR 函数项</span>
       <span class="token keyword">let</span> ret<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">>></span> <span class="token operator">=</span> <span class="token keyword">self</span>
           <span class="token punctuation">.</span><span class="token function">functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	    <span class="token comment">// 获取程序中所有函数的引用</span>
           <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			   <span class="token comment">// 获取函数的迭代器</span>
           <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>function<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>	<span class="token comment">// 对每个函数进行转换操作，转换成 IR 函数项</span>
               <span class="token comment">// 传入之前收集的跳转目标集合，用于在转换过程中识别有效的跳转目标</span>
               <span class="token keyword">let</span> ir_function_term <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">to_ir_function_term</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jump_targets<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 返回一个元组：(函数的 Tid, IR 函数项)</span>
               <span class="token punctuation">(</span>ir_function_term<span class="token punctuation">.</span>tid<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ir_function_term<span class="token punctuation">)</span>
           <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 将迭代器中的所有元组收集到 BTreeMap 中</span>
  
       <span class="token comment">// 验证转换结果的完整性，断言原始函数数量应该等于转换后的函数数量</span>
       <span class="token comment">// 如果数量不相等，说明存在重复的函数 TID（这不应该发生）</span>
       <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Duplicate function TID."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
       <span class="token comment">// 返回转换后的函数映射表</span>
       ret
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>to_ir_function_term 位于 src\cwe_checker_lib\src\ghidra_pcode\function\mod.rs</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">to_ir_function_term</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> jump_targets<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
       <span class="token comment">// 创建 IrFunction (Sub) 结构体</span>
       <span class="token keyword">let</span> ir_function_term <span class="token operator">=</span> <span class="token class-name">IrFunction</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">::</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">></span><span class="token punctuation">(</span>
           <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>		<span class="token comment">// 函数名称</span>
           <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>block<span class="token closure-punctuation punctuation">|</span></span> block<span class="token punctuation">.</span><span class="token function">to_ir_blocks</span><span class="token punctuation">(</span>jump_targets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 将每个基本块转换为 IR 基本块列表</span>
           <span class="token class-name">None</span><span class="token punctuation">,</span>		   <span class="token comment">// 调用约定设为未知</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>
  
       <span class="token comment">// 使用函数地址创建 Tid，然后包装为 IrTerm</span>
       <span class="token class-name">IrTerm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">::</span><span class="token function">new_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">,</span> ir_function_term<span class="token punctuation">)</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IrTerm 结构体位于 src\cwe_checker_lib\src\ghidra_pcode\term.rs（mod.rs 中被重命名）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Term</span> <span class="token punctuation">&#123;</span>
    address<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    index<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    operation<span class="token punctuation">:</span> <span class="token class-name">PcodeOperation</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IrFunction 结构体位于 src\cwe_checker_lib\src\intermediate_representation\sub.rs（mod.rs 中被重命名）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/// 子程序可以有多个出口，这些出口由 `Jmp::Return` 指令标识。</span>
<span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Sub</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>	<span class="token comment">// 子程序的名称</span>
    <span class="token keyword">pub</span> blocks<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Blk</span><span class="token operator">>></span><span class="token punctuation">,</span>	<span class="token comment">// 属于该子程序的基本块，第一个块也是子程序的入口点</span>
    <span class="token keyword">pub</span> calling_convention<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span>	<span class="token comment">// 用于调用该函数的调用约定，如果已知</span>
    non_returning<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>	<span class="token comment">// 如果函数不返回则为 true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Blk 结构体位于 src\cwe_checker_lib\src\intermediate_representation\blk.rs</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Blk</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">pub</span> defs<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">>></span><span class="token punctuation">,</span>	<span class="token comment">// 按执行顺序的 Def 指令</span>
    <span class="token keyword">pub</span> jmps<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Jmp</span><span class="token operator">>></span><span class="token punctuation">,</span>	<span class="token comment">// 数量为 0-2 个，对应 无法确定下一个指令 / 无条件 / 有条件跳转</span>
    indirect_control_flow_targets<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">IndirectCfTargets</span><span class="token operator">>></span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 def 和 jmp 枚举类型如下：</p>
<p>Def：加载和存储表达式</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Def</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Load</span> <span class="token punctuation">&#123;</span>					   <span class="token comment">// 将内存加载到由 var 指定的寄存器中</span>
        var<span class="token punctuation">:</span> <span class="token class-name">Variable</span><span class="token punctuation">,</span>	        <span class="token comment">// 内存加载的目标寄存器，var 的大小决定了从内存中读取的字节数</span>
        address<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>    <span class="token comment">// 计算读取地址的表达式</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token class-name">Store</span> <span class="token punctuation">&#123;</span>					   <span class="token comment">// 一个内存存储操作</span>
        address<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>     <span class="token comment">// 计算写入地址的表达式</span>
        value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>       <span class="token comment">// 计算写入内存的值的表达式</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>				   <span class="token comment">// 寄存器分配，将表达式 value 的结果分配给寄存器 var </span>
        var<span class="token punctuation">:</span> <span class="token class-name">Variable</span><span class="token punctuation">,</span>		    <span class="token comment">// 被写入的寄存器</span>
        value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>		<span class="token comment">// 计算分配给寄存器的值的表达式</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Jmp：影响程序的执行流程</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Jmp</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Branch</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			    <span class="token comment">// 直接在过程内跳转到目标 Blk 术语标识符</span>
    <span class="token class-name">BranchInd</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token punctuation">,</span>		<span class="token comment">// 间接在过程内跳转到给定表达式求值后的地址</span>
    <span class="token class-name">CBranch</span> <span class="token punctuation">&#123;</span>				   <span class="token comment">// 符合条件时跳转</span>
        target<span class="token punctuation">:</span> <span class="token class-name">Tid</span><span class="token punctuation">,</span>			<span class="token comment">// 跳转目标块的术语 ID</span>
        condition<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>	 <span class="token comment">// 跳转条件</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token class-name">Call</span> <span class="token punctuation">&#123;</span>					   <span class="token comment">// 过程间跳转，表示子程序调用</span>
        target<span class="token punctuation">:</span> <span class="token class-name">Tid</span><span class="token punctuation">,</span>		    <span class="token comment">// 目标子程序（ Sub ）或调用外部符号的术语 ID</span>
        return_<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span>	 <span class="token comment">// 被调用函数返回的块的术语 ID，永不返回，则可能是 None</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token class-name">CallInd</span> <span class="token punctuation">&#123;</span>				   <span class="token comment">// 一个间接的跨过程跳转到 target 表达式求值后的地址，表示子程序调用</span>
        target<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>		<span class="token comment">// 计算调用目标地址的表达式</span>
        return_<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span>	<span class="token comment">// 被调用函数返回的块的术语 ID，永不返回，则可能是 None</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token class-name">Return</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token comment">// 从子程序返回的间接跨过程跳转</span>
    <span class="token class-name">CallOther</span> <span class="token punctuation">&#123;</span>				   <span class="token comment">// 其他指令无法表示或不被反汇编器支持的副作用</span>
        description<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>	<span class="token comment">// 对副作用的描述</span>
        return_<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span>	<span class="token comment">// 反汇编器假定在处理副作用后执行将继续的代码块的块术语标识符</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>将 pcode 操作转化为 IR Def 示例：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 原始 pcode 操作，参考 PcodeRaw 结构体</span>
<span class="token class-name">Term</span> <span class="token punctuation">&#123;</span>
    address<span class="token punctuation">:</span> <span class="token string">"0x00401000"</span><span class="token punctuation">,</span>
    index<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    operation<span class="token punctuation">:</span> <span class="token class-name">PcodeOperation</span> <span class="token punctuation">&#123;</span>	<span class="token comment">// rsp = rsp - 8</span>
        opcode<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">(</span><span class="token class-name">IntSub</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 操作：sub</span>
        output<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Varnode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"temp_RSP_new"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 输出：rsp</span>
        inputs<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token class-name">Varnode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"register_RSP_64"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 输入：rsp</span>
            <span class="token class-name">Varnode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"const_8_64"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>			<span class="token comment">// 8</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 转换为 IR Def</span>
<span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>
        id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_0"</span><span class="token punctuation">,</span>			   <span class="token comment">// tid</span>
        address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 程序地址</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>
        var<span class="token punctuation">:</span> <span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span> name<span class="token punctuation">:</span> <span class="token string">"temp_RSP_new"</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> is_temp<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">BinOp</span> <span class="token punctuation">&#123;</span>
            op<span class="token punctuation">:</span> <span class="token class-name">IntSub</span><span class="token punctuation">,</span>	<span class="token comment">// 操作：sub</span>
            lhs<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span> name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 左操作数，64 位寄存器 rsp，大小为 8，是临时寄存器</span>
            rhs<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Const</span><span class="token punctuation">(</span><span class="token class-name">Bitvector</span><span class="token punctuation">::</span><span class="token function">from_u64</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// 右操作数，常数 8</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IrFunction 示例：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>
        id<span class="token punctuation">:</span> <span class="token string">"fun_0x00401000"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 格式: "fun_&#123;地址&#125;"</span>
        address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    term<span class="token punctuation">:</span> <span class="token class-name">Sub</span> <span class="token punctuation">&#123;</span>
        name<span class="token punctuation">:</span> <span class="token string">"example_function"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        blocks<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
            <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Blk</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>
                    id<span class="token punctuation">:</span> <span class="token string">"blk_0x00401000"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                term<span class="token punctuation">:</span> <span class="token class-name">Blk</span> <span class="token punctuation">&#123;</span>
                    defs<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                        <span class="token comment">// 操作 1：计算 RSP - 8</span>
                        <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                            tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>
                                id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_0"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                            term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>
                                var<span class="token punctuation">:</span> <span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>
                                    name<span class="token punctuation">:</span> <span class="token string">"temp_RSP_new"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                                value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">BinOp</span> <span class="token punctuation">&#123;</span>
                                    op<span class="token punctuation">:</span> <span class="token class-name">BinOpType</span><span class="token punctuation">::</span><span class="token class-name">IntSub</span><span class="token punctuation">,</span>
                                    lhs<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>
                                        name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    rhs<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Const</span><span class="token punctuation">(</span><span class="token class-name">Bitvector</span><span class="token punctuation">::</span><span class="token function">from_u64</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                        <span class="token comment">// 操作 2：更新 RSP</span>
                        <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                            tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>
                                id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_1"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                            term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>
                                var<span class="token punctuation">:</span> <span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>
                                    name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                                value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>
                                    name<span class="token punctuation">:</span> <span class="token string">"temp_RSP_new"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                        <span class="token comment">// 操作 3：存储 RBP 到栈</span>
                        <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
                            tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>
                                id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_2"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                            term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Store</span> <span class="token punctuation">&#123;</span>
                                address<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>
                                    name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>
                                    name<span class="token punctuation">:</span> <span class="token string">"register_RBP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    jmps<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    indirect_control_flow_targets<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        calling_convention<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        non_returning<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>计算 ghidra 中的基址和实际基址的差值得到偏移 address_base_offset（仅在成功获取基址的情况下计算，否则 project 中的  address_base_offset &#x3D; 0）</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 计算地址基址偏移量（Ghidra 报告的基址与实际基址的差值）</span>
<span class="token keyword">let</span> address_base_offset <span class="token operator">=</span>
<span class="token comment">// 将 image_base 字符串（去掉 "0x" 前缀）解析为十六进制 u64</span>
<span class="token keyword">match</span> <span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token function">from_str_radix</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>image_base<span class="token punctuation">.</span><span class="token function">trim_start_matches</span><span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">checked_sub</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">)</span> <span class="token comment">// 安全地计算差值（防止下溢）</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">,</span> <span class="token comment">// 如果计算成功，使用差值</span>
    <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>     <span class="token comment">// 如果下溢（Ghidra 报告的基址小于实际基址）</span>
        logs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">::</span><span class="token function">new_info</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span> <span class="token comment">// 添加警告日志</span>
        <span class="token string">"Base address reported by Ghidra is smaller than actual base address: &#123;&#125; vs 0x&#123;:x&#125;"</span><span class="token punctuation">,</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>image_base<span class="token punctuation">,</span> binary_base_address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录 Ghidra 报告的基址和实际基址</span>

        <span class="token number">0</span> <span class="token comment">// 使用 0 作为偏移量</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建初始的 IR 程序结构</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 创建初始的 IR 程序结构 </span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> ir_program <span class="token operator">=</span> <span class="token class-name">IrProgram</span> <span class="token punctuation">&#123;</span>
    subs<span class="token punctuation">:</span> ir_function_terms_map<span class="token punctuation">,</span> <span class="token comment">// 函数项映射表（函数 TID -> 函数项）</span>
    extern_symbols<span class="token punctuation">:</span> <span class="token keyword">self</span>         <span class="token comment">// 外部符号（导入的函数）</span>
    <span class="token punctuation">.</span>external_functions      	<span class="token comment">// 从外部函数映射中</span>
    <span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                	<span class="token comment">// 获取所有值（ExternFunction）</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>ext_fn<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>          	<span class="token comment">// 将每个外部函数转换为 IR 外部符号</span>
        <span class="token keyword">let</span> ext_sym <span class="token operator">=</span> ext_fn<span class="token punctuation">.</span><span class="token function">to_ir_extern_symbol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 IR 外部符号</span>
        <span class="token punctuation">(</span>ext_sym<span class="token punctuation">.</span>tid<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ext_sym<span class="token punctuation">)</span> <span class="token comment">// 返回 (TID, 外部符号) 元组</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 	 <span class="token comment">// 收集为 HashMap</span>
    <span class="token comment">// 将入口点字符串转换为函数 TID 列表</span>
    entry_points<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>entry_points<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">::</span>new_function<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    address_base_offset<span class="token punctuation">,</span> <span class="token comment">// 地址基址偏移量</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 打印早期 IR 表示</span>
debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ir_program<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">IrForm</span><span class="token punctuation">::</span><span class="token class-name">Early</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用的 IrProgram 结构体如下（与self.program 不是同一个结构体，位于 src\cwe_checker_lib\src\intermediate_representation\program.rs）：</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Program</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 二进制文件中包含的已知函数，存放程序转化的 IR 函数映射表</span>
    <span class="token keyword">pub</span> subs<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Sub</span><span class="token operator">>></span><span class="token punctuation">,</span>			
    <span class="token comment">// 链接器链接到二进制文件的 extern 符号，从 PcodeProject 的 external_functions 获取所有外部符号</span>
    <span class="token keyword">pub</span> extern_symbols<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">ExternSymbol</span><span class="token operator">></span><span class="token punctuation">,</span> 
    <span class="token comment">// 二进制文件的入口点，从 PcodeProject 的 entry_points 获取</span>
    <span class="token keyword">pub</span> entry_points<span class="token punctuation">:</span> <span class="token class-name">BTreeSet</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span>	
    <span class="token comment">// ghidra 与程序实际基址的偏移量</span>
    <span class="token keyword">pub</span> address_base_offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>		
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>运行 IR Pass 顺序执行多个独立的处理单元，对 IR 进行转换和优化</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>
    ir_program<span class="token punctuation">,</span>        <span class="token comment">// 要转换的 IR 程序（可变的）</span>
    construction_input<span class="token punctuation">,</span> <span class="token comment">// 构造传递所需的输入（通常是寄存器映射等上下文信息）</span>
    <span class="token class-name">PassType</span><span class="token punctuation">,</span>          <span class="token comment">// 传递的类型</span>
    logs<span class="token punctuation">,</span>              <span class="token comment">// 日志向量，用于收集处理过程中的消息</span>
    debug_settings     <span class="token comment">// 调试设置，控制调试输出</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>SingleTargetIndirectCallsPass：只有单个可能的调用目标时，将间接调用替换为直接调用</li>
<li>ReorderFnBlocksPass：按执行顺序流重新将 ghidra 得到的基本块顺序进行排列</li>
<li>ReplaceCallsToExtFnsPass：将对外部函数存根（stub）的调用替换为对外部符号的实际调用</li>
<li>SubregisterSubstitutionPass：将子寄存器的引用替换为基寄存器</li>
<li>InliningPass：将简单或简短的函数内联到调用处，替换对函数的调用</li>
<li>NoreturnExtFunctionsPass：标记不会返回的外部函数，执行到这些函数会终止程序</li>
<li>RemoveEmptyFunctionsPass：移除空函数</li>
<li>PatchCfPass：修复控制流，移除无效的跳转，确保跳转目标都有效、控制流图完整</li>
<li>EntryPointsPass：移除不存在的入口点，确保入口点列表只包含实际存在的函数</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 运行 IR 优化传递（Passes），按顺序应用各种转换和优化</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span> <span class="token comment">// 运行 IR 传递：单目标间接调用替换</span>
        ir_program<span class="token punctuation">,</span> <span class="token comment">// 要转换的 IR 程序</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 传递的上下文参数（无）</span>
        <span class="token class-name">SingleTargetIndirectCallsPass</span><span class="token punctuation">,</span> <span class="token comment">// 将只有单个目标的间接调用替换为直接调用</span>
        logs<span class="token punctuation">,</span> <span class="token comment">// 日志向量</span>
        debug_settings <span class="token comment">// 调试设置</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 运行 IR 传递：重新排序函数内的基本块（按正常顺序）</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ReorderFnBlocksPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token comment">// 运行 IR 传递：将外部函数存根调用替换为外部函数调用</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">ReplaceCallsToExtFnsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span> <span class="token comment">// 运行 IR 传递：子寄存器替换</span>
        ir_program<span class="token punctuation">,</span> <span class="token comment">// 要转换的 IR 程序</span>
        register_map<span class="token punctuation">,</span> <span class="token comment">// 传递寄存器映射作为上下文</span>
        <span class="token class-name">SubregisterSubstitutionPass</span><span class="token punctuation">,</span> <span class="token comment">// 将子寄存器引用替换为基寄存器引用</span>
        logs<span class="token punctuation">,</span> <span class="token comment">// 日志向量</span>
        debug_settings <span class="token comment">// 调试设置</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 运行 IR 传递：内联现有引用的块到函数中</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">InliningPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 运行 IR 传递：标记非返回的外部函数</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">NoreturnExtFunctionsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 运行 IR 传递：移除空函数</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">RemoveEmptyFunctionsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 运行 IR 传递：修复控制流（确保所有控制流转换都有有效目标）</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">PatchCfPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 运行 IR 传递：移除不存在的入口点</span>
    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">EntryPointsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">]</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>调用 debug_assert_postconditions 断言各个传递的后置条件，验证传递的正确性</p>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token comment">// 在调试模式下断言各个传递的后置条件（验证传递的正确性）</span>
      <span class="token comment">// 断言单目标间接调用替换的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SingleTargetIndirectCallsPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">// 断言基本块重排序的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ReorderFnBlocksPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
      <span class="token comment">// 断言外部函数调用替换的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">ReplaceCallsToExtFnsPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// 断言子寄存器替换的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> register_map<span class="token punctuation">,</span> <span class="token class-name">SubregisterSubstitutionPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">// 断言内联传递的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">InliningPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// 断言非返回函数标记的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">NoreturnExtFunctionsPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token comment">// 断言空函数移除的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">RemoveEmptyFunctionsPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token comment">// 断言控制流修复的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">PatchCfPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	
   <span class="token comment">// 断言入口点处理的后置条件</span>
      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">EntryPointsPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
  
   <span class="token comment">// 断言 IR 程序的不变量，验证程序的完整性，确保所有基本快 TID 唯一，所有跳转目标存在，所有函数调用约定有效</span>
      ir_program<span class="token punctuation">.</span><span class="token function">debug_assert_invariants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>创建并返回 Project 结构体实例</p>
</li>
</ul>
<pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">        <span class="token comment">// 创建最终的 IR Project（项目）结构</span>
        <span class="token keyword">let</span> ir_project <span class="token operator">=</span> <span class="token class-name">IrProject</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 创建程序项，使用程序基址作为 TID</span>
            program<span class="token punctuation">:</span> <span class="token class-name">IrTerm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">::</span><span class="token function">new_program</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>image_base<span class="token punctuation">)</span><span class="token punctuation">,</span> ir_program<span class="token punctuation">)</span><span class="token punctuation">,</span> 
            cpu_architecture<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>cpu_arch<span class="token punctuation">,</span> <span class="token comment">// CPU 架构名称</span>
            <span class="token comment">// 将栈指针寄存器 Varnode 转换为 IR 变量</span>
            stack_pointer_register<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>stack_pointer_register<span class="token punctuation">.</span><span class="token function">to_ir_var</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            calling_conventions<span class="token punctuation">:</span> <span class="token keyword">self</span> <span class="token comment">// 调用约定</span>
                <span class="token punctuation">.</span>calling_conventions <span class="token comment">// 从调用约定映射中</span>
                <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 转换为迭代器（消耗所有权）</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>cconv_name<span class="token punctuation">,</span> cconv<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将每个调用约定转换为 IR 调用约定</span>
                    <span class="token punctuation">(</span>
                        cconv_name<span class="token punctuation">,</span> <span class="token comment">// 调用约定名称（键）</span>
                        cconv <span class="token comment">// 调用约定对象</span>
                            <span class="token punctuation">.</span><span class="token function">to_ir_calling_convention</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>register_map<span class="token punctuation">)</span> <span class="token comment">// 转换为 IR 调用约定</span>
                            <span class="token punctuation">.</span><span class="token function">move_logs_to</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> logs<span class="token punctuation">)</span> <span class="token comment">// 将日志移动到 logs 向量</span>
                            <span class="token punctuation">.</span><span class="token function">into_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 提取对象（从 WithLogs 中）</span>
                    <span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 收集为 HashMap</span>
            register_set<span class="token punctuation">:</span> register_map<span class="token punctuation">.</span><span class="token function">get_base_reg_ir_vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取基础寄存器的 IR 变量集合</span>
            <span class="token comment">// 将数据类型属性转换为 IR 数据类型属性</span>
            datatype_properties<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>datatype_properties<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token comment">// 创建空的运行时内存映像（小端序）</span>
            runtime_memory_image<span class="token punctuation">:</span> <span class="token class-name">IrRuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token class-name">WithLogs</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>ir_project<span class="token punctuation">,</span> logs<span class="token punctuation">)</span> <span class="token comment">// 返回带日志的 IR Project</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="cwe-checker-lib-x2F-src-x2F-analysis-x2F-graph-x2F-call-rs"><a href="#cwe-checker-lib-x2F-src-x2F-analysis-x2F-graph-x2F-call-rs" class="headerlink" title="cwe_checker_lib&#x2F;src&#x2F;analysis&#x2F;graph&#x2F;call.rs"></a>cwe_checker_lib&#x2F;src&#x2F;analysis&#x2F;graph&#x2F;call.rs</h3><h3 id="src-x2F-caller-x2F-src-x2F-cfg-stats-rs"><a href="#src-x2F-caller-x2F-src-x2F-cfg-stats-rs" class="headerlink" title="src&#x2F;caller&#x2F;src&#x2F;cfg_stats.rs"></a>src&#x2F;caller&#x2F;src&#x2F;cfg_stats.rs</h3><h3 id="src-cwe-checker-lib-src-analysis-graph-rs"><a href="#src-cwe-checker-lib-src-analysis-graph-rs" class="headerlink" title="src\cwe_checker_lib\src\analysis\graph.rs"></a>src\cwe_checker_lib\src\analysis\graph.rs</h3><h3 id="src-cwe-checker-lib-src-pipeline-results-rs"><a href="#src-cwe-checker-lib-src-pipeline-results-rs" class="headerlink" title="src\cwe_checker_lib\src\pipeline\results.rs"></a>src\cwe_checker_lib\src\pipeline\results.rs</h3><h3 id="src-cwe-checker-lib-src-checkers（cwe-modules）"><a href="#src-cwe-checker-lib-src-checkers（cwe-modules）" class="headerlink" title="*src\cwe_checker_lib\src\checkers（cwe modules）"></a>*src\cwe_checker_lib\src\checkers（cwe modules）</h3>
                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/cwe-checker/">
                                    <span class="chip bg-color">cwe_checker</span>
                                </a>
                            
                                <a href="/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/">
                                    <span class="chip bg-color">静态分析</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2025/11/06/cwe-checker-yuan-ma-fen-xi-geng-xin-zhong/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="cwe_checker源码分析（更新中）">
                        
                        <span class="card-title">cwe_checker源码分析（更新中）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            cwe_checker 源码分析
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-11-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/" class="post-category">
                                    静态分析
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/cwe-checker/">
                        <span class="chip bg-color">cwe_checker</span>
                    </a>
                    
                    <a href="/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/">
                        <span class="chip bg-color">静态分析</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/04/06/awdp-sai-zhi-liu-cheng-yu-ji-qiao/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/Steel%20Gray.jpg" class="responsive-img" alt="AWDP赛制流程与技巧">
                        
                        <span class="card-title">AWDP赛制流程与技巧</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            AWDP赛制流程与技巧
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-04-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/AWDP/" class="post-category">
                                    AWDP
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/AWDP/">
                        <span class="chip bg-color">AWDP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2025</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">starrysky</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">219.8k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/starrysky1004" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:starrysky20041005@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2726736810" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2726736810" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>









    <a href="https://space.bilibili.com/85923475" class="tooltipped" target="_blank" data-tooltip="关注我的bilibili" data-position="top" data-delay="50">
        <i class="fas fa-video"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":260,"height":300},"mobile":{"show":true},"log":false});</script></body>

</html>
